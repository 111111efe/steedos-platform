function(e,t,n){"use strict";var r=e("../../core/errors"),a=e("../../core/utils/extend").extend,i=e("../../core/utils/iterator").each,u=e("../../core/utils/array").inArray,o=e("../../core/utils/date"),s=o.dateToMilliseconds,f=4,c={secondly:"seconds",minutely:"minutes",hourly:"hours",daily:"days",weekly:"weeks",monthly:"months",yearly:"years"},y={bysecond:function(e,t){e.setSeconds(t)},byminute:function(e,t){e.setMinutes(t)},byhour:function(e,t){e.setHours(t)},bymonth:function(e,t){e.setMonth(t)},bymonthday:function(e,t){if(t<0){var n=new Date(e),r;l(n,1,-1),n.getDate()>=Math.abs(t)?l(e,1,t):l(e,2,t)}else e.setDate(t),N(e,t)},byday:function(e,t,n,r,a){var i=t;"DAILY"!==r&&"WEEKLY"!==r||!(a&&t>=a||!a&&0===t)||(i=7),t+=h[n]>i?7:0,e.setDate(e.getDate()-e.getDay()+t)},byweekno:function(e,t,n){var r=new Date(e),a=new Date(r.setMonth(0,1)),i=a.getDay()-h[n],u=a.getTime()-i*s("day"),o;i+1>4?e.setTime(u+7*t*s("day")):e.setTime(u+7*(t-1)*s("day"));var f=(e.getTimezoneOffset()-a.getTimezoneOffset())*s("minute");f&&e.setTime(e.getTime()+f)},byyearday:function(e,t){e.setMonth(0,1),e.setDate(t)}},l=function(e,t,n){var r=new Date(e);e.setMonth(e.getMonth()+t),e.getMonth()-r.getMonth()>t&&e.setDate(n+1),e.setDate(n+1)},g={bysecond:function(e){return e.getSeconds()},byminute:function(e){return e.getMinutes()},byhour:function(e){return e.getHours()},bymonth:function(e){return e.getMonth()},bymonthday:function(e){return e.getDate()},byday:function(e){return e.getDay()},byweekno:function(e,t){var n,r=new Date(e),a=4-r.getDay()+h[t]-1,i=s("day");e.getDay()<h[t]&&(a-=7),r.setHours(0,0,0),r.setDate(r.getDate()+a);var u=new Date(r.getFullYear(),0,1),o=(u.getTimezoneOffset()-r.getTimezoneOffset())*s("minute");return n=1+(r-u+o)/i,Math.ceil(n/7)},byyearday:function(e){var t=new Date(e.getFullYear(),0,0),n=e.getTimezoneOffset()-t.getTimezoneOffset(),r=e-t-n*s("minute"),a=s("day");return Math.floor(r/a)}},d=["freq","interval","byday","byweekno","byyearday","bymonth","bymonthday","count","until","byhour","byminute","bysecond","bysetpos","wkst"],v=["DAILY","WEEKLY","MONTHLY","YEARLY","SECONDLY","MINUTELY","HOURLY"],h={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6},m={0:"SU",1:"MO",2:"TU",3:"WE",4:"TH",5:"FR",6:"SA"},D,b=function(e){var t=[];return e.rule&&(t=O(e)),!!t.length},T=function(e){var t=e.interval,n=e.freq,r={},a=c[n.toLowerCase()];return"MONTHLY"===n&&e.byday&&(a=c.daily),r[a]=t,r},p=function(e,t){for(var n=[],r=0,a=e.length;r<a;r++)n[r]=C(e[r],t);return n},w=function(e,t){var n=!1;if(!t)return n;for(var r=t.split(","),a=p(r,e),i=/\d{8}$/,u=0,o=a.length;u<o;u++)if(r[u].match(i)){var s=L(e,a[u]);0===s.years&&0===s.months&&0===s.days&&(n=!0)}else e.getTime()===a[u].getTime()&&(n=!0);return n},M=function(e,t,n,r,a){var i,u=!0;return n=n.getTime(),r.until&&r.until.getTime()<n&&(n=r.until.getTime()),r.count&&a===r.count&&(u=!1),(i=e.getTime()<=n)&&u},O=function(e){var t,n=[],r=R(e.rule),a={},u=r.rule,o=e.start;if(!r.isValid||!u.freq)return n;u.interval=T(u),t=_(u,e.firstDayOfWeek);var f=e.end?e.end.getTime()-e.start.getTime():s("day"),c={exception:e.exception,min:e.min,dateRules:t,rule:u,recurrenceStartDate:o,recurrenceEndDate:e.end,duration:f};if(t.length&&u.count){var y=0;Q(t,new Date(o),new Date(o),u).forEach(function(t,n){t<e.max&&(a=Y(++y,a,t,n,c,!0))})}else G(t,new Date(o),u).forEach(function(t,n){for(var r=0;M(t,o,e.max,u,r);)a=Y(++r,a,t,n,c),t=S(t,o,u,n)});return u.bysetpos&&i(a,function(e,t){a[e]=E(t,u.bysetpos)}),i(a,function(e,t){n=n.concat(t)}),n.sort(function(e,t){return e-t}),n},Y=function(e,t,n,r,a,i){return t[e]||(t[e]=[]),k(n,r,a,i)&&t[e].push(n),t},k=function(e,t,n,r){if(!w(e,n.exception)){var a=o.sameDate(e,n.recurrenceEndDate)&&n.recurrenceEndDate.getTime()>e.getTime()?n.recurrenceEndDate.getTime()-e.getTime():n.duration;if(e.getTime()>=n.recurrenceStartDate.getTime()&&e.getTime()+a>n.min.getTime())return r||ee(e,[n.dateRules[t]],n.rule.wkst)}return!1},E=function(e,t){var n=[];return t.split(",").forEach(function(t){var r=(t=Number(t))>0?t-1:e.length+t;e[r]&&n.push(e[r])}),n},N=function(e,t){e.getDate()!==t&&e.setDate(t)},S=function(e,t,n,r){var a=new Date(e),i=!0;if(e=o.addInterval(e,n.interval),"MONTHLY"===n.freq&&!n.byday){var u=t.getDate();n.bymonthday&&(u=Number(n.bymonthday.split(",")[r]))<0&&(a.setMonth(a.getMonth()+1,1),y.bymonthday(a,u),e=a,i=!1),i&&N(e,u)}if("YEARLY"===n.freq){if(n.byyearday){var s=Number(n.byyearday.split(",")[r]);y.byyearday(e,s)}var f=_(n);for(var c in f[r])y[c]&&y[c](e,f[r][c],n.wkst)}return e},L=function(e,t){return{years:e.getFullYear()-t.getFullYear(),months:e.getMonth()-t.getMonth(),days:e.getDate()-t.getDate(),hours:e.getHours()-t.getHours(),minutes:e.getMinutes()-t.getMinutes(),seconds:e.getSeconds()-t.getSeconds()}},R=function(e){var t={rule:{},isValid:!1};return e&&(t.rule=B(e),t.isValid=H(t.rule,e)),t},A=[],H=function(e,t){return!(W(e)||-1===u(e.freq,v)||q(e)||z(e)||U(e)||F(e)||x(e)||I(e))||(Z(t),!1)},I=function(e){var t=!1,n=e.until;return void 0===n||n instanceof Date||(t=!0),t},q=function(e){var t=!1,n=e.count;return n&&"string"==typeof n&&(t=!0),t},F=function(e){var t=!1,n=e.bymonthday;return n&&isNaN(parseInt(n))&&(t=!0),t},x=function e(t){var e=!1,n=t.bymonth;return n&&isNaN(parseInt(n))&&(e=!0),e},z=function(e){var t=!1,n=e.interval;return n&&"string"==typeof n&&(t=!0),t},U=function(e){var t=V(e),n=!1;return i(t,function(e,t){if(!h.hasOwnProperty(t))return n=!0,!1}),n},W=function(e){var t=!1;return i(e,function(e){if(-1===u(e,d))return t=!0,!1}),t},Z=function(e){-1===u(e,A)&&(r.log("W0006",e),A.push(e))},B=function(e){for(var t={},n=e.split(";"),r=0,a=n.length;r<a;r++){var i=n[r].split("="),u=i[0].toLowerCase(),o=i[1];t[u]=o}var s=parseInt(t.count);if(isNaN(s)||(t.count=s),t.interval){var f=parseInt(t.interval);isNaN(f)||(t.interval=f)}else t.interval=1;return t.freq&&t.until&&(t.until=C(t.until)),t},C=function(e,t){if("string"!=typeof e)return e;var n=e.match(/(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2}))?(Z)?/);if(!n)return null;var r=void 0!==n[8],a=t?t.getTimezoneOffset():ne.getTimeZoneOffset(),i=new(Function.prototype.bind.apply(Date,j(n)));return a*=6e4,r&&(i=new Date(i.getTime()-a)),i},j=function(e){return e.shift(),void 0===e[3]?e.splice(3):(e.splice(3,1),e.splice(6)),e[1]--,e.unshift(null),e},V=function(e){var t=[];return e.byday&&(t=Array.isArray(e.byday)?e.byday:e.byday.split(",")),t},K=function(e){var t=6e4*ne.getTimeZoneOffset();return(e=new Date(e.getTime()+t)).getFullYear()+("0"+(e.getMonth()+1)).slice(-2)+("0"+e.getDate()).slice(-2)+"T"+("0"+e.getHours()).slice(-2)+("0"+e.getMinutes()).slice(-2)+("0"+e.getSeconds()).slice(-2)+"Z"},_=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=[];if(t&&(e.fdow=t),e.wkst||(e.wkst=t?m[t]:"MO"),e.byweekno&&!e.byday){for(var r=Object.keys(h),a=0;a<h[e.wkst];a++)r.push(r.shift());e.byday=r.join(",")}for(var i in y)if(e[i]){var u=e[i].split(","),o=J(i,u);n=n.length?$(o,n):o}return n},J=function(e,t){for(var n=[],r=0,a=t.length;r<a;r++){var i={};i[e]=P(e,t[r]),n.push(i)}return n},P=function(e,t){var n=parseInt(t);return"bymonth"===e&&(n-=1),"byday"===e&&(n=h[t]),n},$=function(e,t){for(var n=[],r=0,i=e.length;r<i;r++)for(var u=0,o=t.length;u<o;u++)n.push(a({},e[r],t[u]));return n},G=function(e,t,n){for(var r=[],a=0,i=e.length;a<i;a++){var u=e[a],o=new Date(t);for(var s in u)y[s]&&y[s](o,u[s],n.wkst,n.freq,n.fdow);Array.isArray(o)?r=r.concat(o):r.push(new Date(o))}return r.length||r.push(t),r},Q=function(e,t,n,r){for(var a=[],i=r.count,u=0,s=X(t,e);u<i;){for(var f=G(e,s,r),c=[],y=0;y<f.length;y++)f[y].getTime()>=n.getTime()&&c.push(f[y]);var l=c.length,g=(u+=l)-i;for(u>i&&c.splice(l-g,g),y=0;y<c.length;y++)a.push(c[y]);var d=r.interval;"days"===Object.keys(d)[0]&&(d={weeks:1}),s=o.addInterval(s,d)}return a},X=function(e,t){var n=new Date(e);return t.length&&t[0].byday?n.setDate(n.getDate()-n.getDay()+t[0].byday):n.setDate(1),n},ee=function(e,t,n){for(var r=!1,a=0;a<t.length;a++){var i=t[a],u=!0;for(var o in i){var s="bymonthday"===o&&i[o]<0;g[o]&&!s&&i[o]!==g[o](e,n)&&(u=!1)}r=r||u}return r||!t.length},te,ne={getRecurrenceString:function(e){if(e&&e.freq){var t="";for(var n in e){var r=e[n];"interval"===n&&r<2||("until"===n&&(r=K(r)),t+=n+"="+r+";")}return(t=t.substring(0,t.length-1)).toUpperCase()}},getRecurrenceRule:R,getAsciiStringByDate:K,getDatesByRecurrence:O,dateInRecurrenceRange:b,getDateByAsciiString:C,daysFromByDayRule:V,getTimeZoneOffset:function(){return(new Date).getTimezoneOffset()}};n.exports=ne}

