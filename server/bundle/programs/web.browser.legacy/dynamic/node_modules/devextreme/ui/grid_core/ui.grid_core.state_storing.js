function(e,t,i){"use strict";var o=e("../../core/utils/common"),n=e("../../core/utils/type"),a=e("../../core/utils/extend"),l,s=d(e("./ui.grid_core.state_storing_core")),r=e("../../core/utils/deferred");function d(e){return e&&e.__esModule?e:{default:e}}var c=function(e){var t=e.getController("columns"),i=e.getController("selection"),n=e.getController("export"),l=e.getController("data"),s=e.getView("pagerView");t&&t.columnsChanged.add(function(){var i=t.getUserState(),n=(0,o.getKeyHash)(i),l=(0,o.getKeyHash)(e._state.columns);(0,o.equalByValue)(l,n)||((0,a.extend)(e._state,{columns:i}),e.isEnabled()&&e.save())}),i&&i.selectionChanged.add(function(t){(0,a.extend)(e._state,{selectedRowKeys:t.selectedRowKeys,selectionFilter:t.selectionFilter}),e.isEnabled()&&e.save()}),l&&(e._initialPageSize=e.option("paging.pageSize"),l.changed.add(function(){var t=l.getUserState(),i=e.option("focusedRowEnabled");(0,a.extend)(e._state,t,{allowedPageSizes:s?s.getPageSizes():void 0,filterPanel:{filterEnabled:e.option("filterPanel.filterEnabled")},filterValue:e.option("filterValue"),focusedRowKey:i?e.option("focusedRowKey"):void 0}),e.isEnabled()&&e.save()})),n&&n.selectionOnlyChanged.add(function(){(0,a.extend)(e._state,{exportSelectionOnly:n.selectionOnly()}),e.isEnabled()&&e.save()})};i.exports={defaultOptions:function(){return{stateStoring:{enabled:!1,storageKey:null,type:"localStorage",customLoad:null,customSave:null,savingTimeout:2e3}}},controllers:{stateStoring:s.default.StateStoringController},extenders:{views:{rowsView:{init:function(){var e=this,t=e.getController("data");e.callBase(),t.stateLoaded.add(function(){if(t.isLoaded()&&!t.getDataSource()){e.setLoading(!1),e.renderNoDataText();var i=e.component.getView("columnHeadersView");i&&i.render(),e.component._fireContentReadyAction()}})}}},controllers:{stateStoring:{init:function(){this.callBase.apply(this,arguments),c(this)},isLoading:function(){return this.callBase()||this.getController("data").isStateLoading()},state:function(e){var t=this.callBase.apply(this,arguments);return void 0!==e&&this.applyState((0,a.extend)({},e)),t},applyState:function(e){var t=this,i=e.allowedPageSizes,o=e.searchText,a=e.selectedRowKeys,l=e.selectionFilter,s=this.getController("export"),r=this.getController("columns"),d=this.getController("data"),c=this.getController("filterSync"),u=this.option("scrolling.mode"),g="virtual"===u||"infinite"===u,p=!0===this.option("pager.visible")&&this.option("pager.showPageSizeSelector");this.component.beginUpdate(),r&&r.setUserState(e.columns),s&&s.selectionOnly(e.exportSelectionOnly),this.option("selectedRowKeys",a||[]),this.option("selectionFilter",l),i&&"auto"===this.option("pager.allowedPageSizes")&&(this.option("pager").allowedPageSizes=i),this.option("focusedRowEnabled")&&this.option("focusedRowKey",e.focusedRowKey),this.component.endUpdate(),this.option("searchPanel.text",o||""),this.option("filterValue",e.filterValue||(c?c.getFilterValueFromColumns(e.columns):null)),this.option("filterPanel.filterEnabled",!e.filterPanel||e.filterPanel.filterEnabled),this.option("paging.pageSize",g&&!p||!(0,n.isDefined)(e.pageSize)?this._initialPageSize:e.pageSize),this.option("paging.pageIndex",e.pageIndex||0),d&&d.reset()}},columns:{getVisibleColumns:function(){var e=this.callBase.apply(this,arguments),t=this.getController("stateStoring");return t.isEnabled()&&!t.isLoaded()?[]:e}},data:{callbackNames:function(){return this.callBase().concat(["stateLoaded"])},_refreshDataSource:function(){var e=this,t=e.callBase,i=e.getController("stateStoring");if(i.isEnabled()&&!i.isLoaded()){clearTimeout(e._restoreStateTimeoutID);var o=new r.Deferred;return e._restoreStateTimeoutID=setTimeout(function(){i.load().always(function(){e._restoreStateTimeoutID=null,t.call(e),e.stateLoaded.fire(),o.resolve()})}),o.promise()}e.isStateLoading()||t.call(e)},isLoading:function(){var e=this,t=this.getController("stateStoring");return this.callBase()||t.isLoading()},isStateLoading:function(){return(0,n.isDefined)(this._restoreStateTimeoutID)},isLoaded:function(){return this.callBase()&&!this.isStateLoading()},dispose:function(){clearTimeout(this._restoreStateTimeoutID),this.callBase()}}}}}}

