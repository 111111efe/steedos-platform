function(e,t,i){"use strict";var n=e("../../core/renderer"),s=e("../../events/core/events_engine"),o=e("../../core/component_registrator"),a=e("../../core/utils/common"),u=e("../../core/utils/dom").getPublicElement,r=e("../../core/utils/iterator").each,h=e("../../core/utils/type"),l=e("../../core/utils/extend").extend,d=e("../overlay/utils").getElementMaxHeightByWindow,m=e("../../events/utils"),c=e("../../events/pointer"),b=e("../../events/hover"),_=e("../context_menu/ui.menu_base"),v=e("../overlay"),p=e("./ui.submenu"),g=e("../button"),S=e("../tree_view"),f="dx-menu",x="dx-menu-vertical",y="dx-menu-horizontal",I="dx-menu-item",C="dx-menu-items-container",w="dx-menu-item-expanded",E="dx-context-menu",H="dx-context-menu-container-border",O="dx-context-menu-content-delimiter",M="dx-submenu",A="dx-state-disabled",k="dx-state-hover",T="dx-state-active",B="dx-menu-adaptive-mode",D="dx-menu-hamburger-button",$="dx-menu-adaptive-mode-overlay-wrapper",V="up",N="down",F="left",R="right",z="showSubmenu",L="nextItem",P="prevItem",W={show:50,hide:300},K=["onSubmenuShowing","onSubmenuShown","onSubmenuHiding","onSubmenuHidden","onItemContextMenu","onItemClick","onSelectionChanged"],j=_.inherit({_getDefaultOptions:function(){return l(this.callBase(),{orientation:"horizontal",submenuDirection:"auto",showFirstSubmenuMode:{name:"onClick",delay:{show:50,hide:300}},hideSubmenuOnMouseLeave:!1,onSubmenuShowing:null,onSubmenuShown:null,onSubmenuHiding:null,onSubmenuHidden:null,adaptivityEnabled:!1})},_setOptionsByReference:function(){this.callBase(),l(this._optionsByReference,{animation:!0,selectedItem:!0})},_itemElements:function(){var e=this.callBase(),t=this._submenuItemElements();return e.add(t)},_submenuItemElements:function(){var e=[],t=".dx-menu-item",i=this._submenus.length&&this._submenus[0];return i&&i.itemsContainer()&&(e=i.itemsContainer().find(t)),e},_focusTarget:function(){return this.$element()},_isMenuHorizontal:function(){return"horizontal"===this.option("orientation")},_moveFocus:function(e){var t,i,n,s,o=this._getAvailableItems(),a=this._isMenuHorizontal(),r=this._getActiveItem(!0);switch(e){case"up":i=a?"showSubmenu":this._getItemsNavigationOperation("prevItem"),t=a?r:o,s=(n=this._getKeyboardNavigationAction(i,t))();break;case"down":i=a?"showSubmenu":this._getItemsNavigationOperation("nextItem"),t=a?r:o,s=(n=this._getKeyboardNavigationAction(i,t))();break;case"right":i=a?this._getItemsNavigationOperation("nextItem"):"showSubmenu",t=a?o:r,s=(n=this._getKeyboardNavigationAction(i,t))();break;case"left":i=a?this._getItemsNavigationOperation("prevItem"):"showSubmenu",t=a?o:r,s=(n=this._getKeyboardNavigationAction(i,t))();break;default:return this.callBase(e)}s&&0!==s.length&&this.option("focusedElement",u(s))},_getItemsNavigationOperation:function(e){var t=e;return this.option("rtlEnabled")&&(t="prevItem"===e?"nextItem":"prevItem"),t},_getKeyboardNavigationAction:function(e,t){var i=a.noop;switch(e){case"showSubmenu":t.hasClass("dx-state-disabled")||(i=this._showSubmenu.bind(this,t));break;case"nextItem":i=this._nextItem.bind(this,t);break;case"prevItem":i=this._prevItem.bind(this,t)}return i},_clean:function(){this.callBase(),this.option("templatesRenderAsynchronously")&&clearTimeout(this._resizeEventTimer)},_visibilityChanged:function(e){e&&(this._menuItemsWidth||this._updateItemsWidthCache(),this._dimensionChanged())},_isAdaptivityEnabled:function(){return this.option("adaptivityEnabled")&&"horizontal"===this.option("orientation")},_updateItemsWidthCache:function(){var e=this.$element().find("ul").first().children("li").children(".dx-menu-item");this._menuItemsWidth=this._getSummaryItemsWidth(e,!0)},_dimensionChanged:function(){if(this._isAdaptivityEnabled()){var e=this.$element().outerWidth();this._toggleAdaptiveMode(this._menuItemsWidth>e)}},_init:function(){this.callBase(),this._submenus=[]},_initActions:function(){this._actions={},r(K,function(e,t){this._actions[t]=this._createActionByOption(t)}.bind(this))},_initMarkup:function(){this._visibleSubmenu=null,this.$element().addClass("dx-menu"),this.callBase(),this.setAria("role","menubar")},_render:function(){this.callBase(),this._initAdaptivity()},_renderHamburgerButton:function(){return this._hamburger=new g(n("<div>").addClass("dx-menu-hamburger-button"),{icon:"menu",activeStateEnabled:!1,onClick:this._toggleTreeView.bind(this)}),this._hamburger.$element()},_toggleTreeView:function(e){h.isPlainObject(e)&&(e=!this._overlay.option("visible")),this._overlay.option("visible",e),this._toggleHamburgerActiveState(e)},_toggleHamburgerActiveState:function(e){this._hamburger&&this._hamburger.$element().toggleClass("dx-state-active",e)},_toggleAdaptiveMode:function(e){var t=this.$element().find(".dx-menu-horizontal"),i=this.$element().find(".dx-menu-adaptive-mode");e?this._hideVisibleSubmenu():(this._treeView&&this._treeView.collapseAll(),this._overlay&&this._toggleTreeView(e)),t.toggle(!e),i.toggle(e)},_removeAdaptivity:function(){this._$adaptiveContainer&&(this._toggleAdaptiveMode(!1),this._$adaptiveContainer.remove(),this._$adaptiveContainer=null,this._treeView=null,this._hamburger=null,this._overlay=null)},_treeviewItemClickHandler:function(e){this._actions.onItemClick(e),e.node.children.length||this._toggleTreeView(!1)},_getAdaptiveOverlayOptions:function(){var e,t=this.option("rtlEnabled")?"right":"left";return{maxHeight:function(){return d(this.$element())}.bind(this),deferRendering:!1,shading:!1,animation:!1,closeOnTargetScroll:!0,onHidden:function(){this._toggleHamburgerActiveState(!1)}.bind(this),height:"auto",closeOnOutsideClick:function(e){return!n(e.target).closest(".dx-menu-hamburger-button").length},position:{collision:"flipfit",at:"bottom "+t,my:"top "+t,of:this._hamburger.$element()}}},_getTreeViewOptions:function(){var e={},t=this,i,n=["onItemContextMenu","onSelectionChanged"];return r(["rtlEnabled","width","accessKey","activeStateEnabled","animation","dataSource","disabled","displayExpr","displayExpr","focusStateEnabled","hint","hoverStateEnabled","itemsExpr","items","itemTemplate","selectedExpr","selectionMode","tabIndex","visible"],function(i,n){e[n]=t.option(n)}),r(n,function(i,n){e[n]=function(e){this._actions[n](e)}.bind(t)}),l(e,{dataSource:t.getDataSource(),animationEnabled:!!this.option("animation"),onItemClick:t._treeviewItemClickHandler.bind(t),onItemExpanded:function(e){this._overlay.repaint(),this._actions.onSubmenuShown(e)}.bind(t),onItemCollapsed:function(e){this._overlay.repaint(),this._actions.onSubmenuHidden(e)}.bind(t),selectNodesRecursive:!1,selectByClick:this.option("selectByClick"),expandEvent:"click"})},_initAdaptivity:function(){if(this._isAdaptivityEnabled()){this._$adaptiveContainer=n("<div>").addClass(B);var e=this._renderHamburgerButton();this._treeView=this._createComponent(n("<div>"),S,this._getTreeViewOptions()),this._overlay=this._createComponent(n("<div>"),v,this._getAdaptiveOverlayOptions()),this._overlay.$content().append(this._treeView.$element()).addClass(B).addClass(this.option("cssClass")),this._overlay._wrapper().addClass($),this._$adaptiveContainer.append(e),this._$adaptiveContainer.append(this._overlay.$element()),this.$element().append(this._$adaptiveContainer),this._updateItemsWidthCache(),this._dimensionChanged()}},_getDelay:function(e){var t=this.option("showFirstSubmenuMode").delay;return h.isDefined(t)?h.isObject(t)?t[e]:t:W[e]},_keyboardHandler:function(e){return!!this._visibleSubmenu||this.callBase(e)},_renderContainer:function(){var e=n("<div>");return e.appendTo(this.$element()).addClass(this._isMenuHorizontal()?"dx-menu-horizontal":"dx-menu-vertical"),this.callBase(e)},_renderSubmenuItems:function(e,t){var i=this._createSubmenu(e,t);return this._submenus.push(i),this._renderBorderElement(t),i},_createSubmenu:function(e,t){var i=n("<div>").addClass("dx-context-menu").appendTo(t),s=this._keyboardProcessor&&this._keyboardProcessor.attachChildProcessor(),o=this._getChildNodes(e),a=this._createComponent(i,p,l(this._getSubmenuOptions(),{_keyboardProcessor:s,_dataAdapter:this._dataAdapter,_parentKey:e.internalFields.key,items:o,onHoverStart:this._clearTimeouts.bind(this),position:this.getSubmenuPosition(t)}));return this._attachSubmenuHandlers(t,a),a},_getSubmenuOptions:function(){var e=n("<div>"),t=this._isMenuHorizontal();return{itemTemplate:this.option("itemTemplate"),target:e,orientation:this.option("orientation"),selectionMode:this.option("selectionMode"),cssClass:this.option("cssClass"),selectByClick:this.option("selectByClick"),hoverStateEnabled:this.option("hoverStateEnabled"),activeStateEnabled:this.option("activeStateEnabled"),focusStateEnabled:this.option("focusStateEnabled"),animation:this.option("animation"),showSubmenuMode:this.option("showSubmenuMode"),displayExpr:this.option("displayExpr"),disabledExpr:this.option("disabledExpr"),selectedExpr:this.option("selectedExpr"),itemsExpr:this.option("itemsExpr"),onFocusedItemChanged:function(e){e.component.option("visible")&&this.option("focusedElement",e.component.option("focusedElement"))}.bind(this),onSelectionChanged:this._nestedItemOnSelectionChangedHandler.bind(this),onItemClick:this._nestedItemOnItemClickHandler.bind(this),onItemRendered:this.option("onItemRendered"),onLeftFirstItem:t?null:this._moveMainMenuFocus.bind(this,"prevItem"),onLeftLastItem:t?null:this._moveMainMenuFocus.bind(this,"nextItem"),onCloseRootSubmenu:this._moveMainMenuFocus.bind(this,t?"prevItem":null),onExpandLastSubmenu:t?this._moveMainMenuFocus.bind(this,"nextItem"):null}},_getShowFirstSubmenuMode:function(){if(!this._isDesktopDevice())return"onClick";var e=this.option("showFirstSubmenuMode");return h.isObject(e)?e.name:e},_moveMainMenuFocus:function(e){var t=this._getAvailableItems(),i=t.length,n=t.filter(".dx-menu-item-expanded").eq(0),s=t.index(n);this._hideSubmenu(this._visibleSubmenu),(s+="prevItem"===e?-1:1)>=i?s=0:s<0&&(s=i-1);var o=t.eq(s);this.option("focusedElement",u(o))},_nestedItemOnSelectionChangedHandler:function(e){var t=e.addedItems.length&&e.addedItems[0],i=p.getInstance(e.element),n;(0,this._actions.onSelectionChanged)(e),t&&this._clearSelectionInSubmenus(t[0],i),this._clearRootSelection(),this._setOptionSilent("selectedItem",t)},_clearSelectionInSubmenus:function(e,t){var i=this,n=!arguments.length;r(this._submenus,function(e,s){var o=s._itemContainer(),a=!o.is(t&&t._itemContainer()),u=o.find("."+i._selectedItemClass()),r;(a&&u.length||n)&&(u.removeClass(i._selectedItemClass()),(r=i._getItemData(u))&&(r.selected=!1),s._clearSelectedItems())})},_clearRootSelection:function(){var e=this.$element().find(".dx-menu-items-container").first().children().children().filter("."+this._selectedItemClass()),t;e.length&&((t=this._getItemData(e)).selected=!1,e.removeClass(this._selectedItemClass()))},_nestedItemOnItemClickHandler:function(e){this._actions.onItemClick(e)},_attachSubmenuHandlers:function(e,t){var i=this,n,o=t.getOverlayContent().find(".dx-submenu"),a=m.addNamespace(b.end,this.NAME+"_submenu");t.option({onShowing:this._submenuOnShowingHandler.bind(this,e,t),onShown:this._submenuOnShownHandler.bind(this,e,t),onHiding:this._submenuOnHidingHandler.bind(this,e,t),onHidden:this._submenuOnHiddenHandler.bind(this,e,t)}),r(o,function(t,n){s.off(n,a),s.on(n,a,null,i._submenuMouseLeaveHandler.bind(i,e))})},_submenuOnShowingHandler:function(e,t){var i=e.children(".dx-context-menu-container-border");this._actions.onSubmenuShowing({rootItem:u(e),submenu:t}),i.show(),e.addClass("dx-menu-item-expanded")},_submenuOnShownHandler:function(e,t){this._actions.onSubmenuShown({rootItem:u(e),submenu:t})},_submenuOnHidingHandler:function(e,t,i){var n=e.children(".dx-context-menu-container-border"),s=i;s.rootItem=u(e),s.submenu=t,this._actions.onSubmenuHiding(s),(i=s).cancel||(this._visibleSubmenu===t&&(this._visibleSubmenu=null),n.hide(),e.removeClass("dx-menu-item-expanded"))},_submenuOnHiddenHandler:function(e,t){this._actions.onSubmenuHidden({rootItem:u(e),submenu:t})},_submenuMouseLeaveHandler:function(e,t){var i=this,s=n(t.relatedTarget).parents(".dx-context-menu")[0],o=this._getSubmenuByRootElement(e).getOverlayContent()[0];this.option("hideSubmenuOnMouseLeave")&&s!==o&&(this._clearTimeouts(),setTimeout(this._hideSubmenuAfterTimeout.bind(this),this._getDelay("hide")))},_hideSubmenuAfterTimeout:function(){if(this._visibleSubmenu){var e=n(this._visibleSubmenu.$element().context).hasClass("dx-state-hover"),t;this._visibleSubmenu.getOverlayContent().find(".dx-state-hover").length||e||this._visibleSubmenu.hide()}},_getSubmenuByRootElement:function(e){if(!e)return!1;var t=e.children(".dx-context-menu");return t.length&&p.getInstance(t)},getSubmenuPosition:function(e){var t=this._isMenuHorizontal(),i=this.option("submenuDirection").toLowerCase(),n=this.option("rtlEnabled"),s={collision:"flip",of:e};switch(i){case"leftortop":s.at="left top",s.my=t?"left bottom":"right top";break;case"rightorbottom":s.at=t?"left bottom":"right top",s.my="left top";break;default:t?(s.at=n?"right bottom":"left bottom",s.my=n?"right top":"left top"):(s.at=n?"left top":"right top",s.my=n?"right top":"left top")}return s},_renderBorderElement:function(e){n("<div>").appendTo(e).addClass("dx-context-menu-container-border").hide()},_itemPointerDownHandler:function(e){var t,i;n(e.target).closest(this._itemElements()).hasClass("dx-menu-item-has-submenu")?this.option("focusedElement",null):this.callBase(e)},_hoverStartHandler:function(e){var t=m.addNamespace(c.move,this.NAME),i=this._getItemElementByEventArgs(e),n=this._dataAdapter.getNodeByItem(this._getItemData(i)),o=h.isDefined(e.buttons)&&1===e.buttons||!h.isDefined(e.buttons)&&1===e.which;if(!this._isItemDisabled(i))if(s.off(i,t),this._hasChildren(n)){if("onHover"===this._getShowFirstSubmenuMode()&&!o){var a=this._getSubmenuByElement(i);this._clearTimeouts(),a.isOverlayVisible()||(s.on(i,t,this._itemMouseMoveHandler.bind(this)),this._showSubmenuTimer=this._getDelay("hide"))}}else this._showSubmenuTimer=setTimeout(this._hideSubmenuAfterTimeout.bind(this),this._getDelay("hide"))},_hoverEndHandler:function(e){var t=this,i=t._getItemElementByEventArgs(e),s=n(e.relatedTarget);t.callBase(e),t._clearTimeouts(),t._isItemDisabled(i)||s.hasClass("dx-context-menu-content-delimiter")||t.option("hideSubmenuOnMouseLeave")&&!s.hasClass("dx-menu-items-container")&&(t._hideSubmenuTimer=setTimeout(function(){t._hideSubmenuAfterTimeout()},t._getDelay("hide")))},_hideVisibleSubmenu:function(){return!!this._visibleSubmenu&&(this._hideSubmenu(this._visibleSubmenu),!0)},_showSubmenu:function(e){var t=this._getSubmenuByElement(e);this._visibleSubmenu!==t&&this._hideVisibleSubmenu(),t&&(t.show(),this.option("focusedElement",t.option("focusedElement"))),this._visibleSubmenu=t,this._hoveredRootItem=e},_hideSubmenu:function(e){e&&e.hide(),this._visibleSubmenu===e&&(this._visibleSubmenu=null),this._hoveredRootItem=null},_itemMouseMoveHandler:function(e){if(!e.pointers||!e.pointers.length){var t=this,i=n(e.currentTarget);h.isDefined(t._showSubmenuTimer)&&(t._clearTimeouts(),t._showSubmenuTimer=setTimeout(function(){var e=t._getSubmenuByElement(i);e&&!e.isOverlayVisible()&&t._showSubmenu(i)},t._getDelay("show")))}},_clearTimeouts:function(){clearTimeout(this._hideSubmenuTimer),clearTimeout(this._showSubmenuTimer)},_getSubmenuByElement:function(e,t){var i=this._getSubmenuByRootElement(e);if(i)return i;t=t||this._getItemData(e);var n=this._dataAdapter.getNodeByItem(t);return this._hasChildren(n)&&this._renderSubmenuItems(n,e)},_updateSubmenuVisibilityOnClick:function(e){var t,i=e.args.length&&e.args[0];if(i&&!this._disabledGetter(i.itemData)){var s=n(i.itemElement);if(t=this._getSubmenuByElement(s,i.itemData),this._updateSelectedItemOnClick(e),this._visibleSubmenu){if(this._visibleSubmenu===t)return void("onClick"===this.option("showFirstSubmenuMode")&&this._hideSubmenu(this._visibleSubmenu));this._hideSubmenu(this._visibleSubmenu)}t&&(t.isOverlayVisible()||this._showSubmenu(s))}},_optionChanged:function(e){switch(e.name){case"orientation":case"submenuDirection":this._invalidate();break;case"showFirstSubmenuMode":case"hideSubmenuOnMouseLeave":break;case"showSubmenuMode":this._changeSubmenusOption(e.name,e.value);break;case"onSubmenuShowing":case"onSubmenuShown":case"onSubmenuHiding":case"onSubmenuHidden":this._initActions();break;case"adaptivityEnabled":e.value?this._initAdaptivity():this._removeAdaptivity();break;case"width":this._isAdaptivityEnabled()&&(this._treeView.option(e.name,e.value),this._overlay.option(e.name,e.value)),this.callBase(e),this._dimensionChanged();break;case"animation":this._isAdaptivityEnabled()&&this._treeView.option("animationEnabled",!!e.value),this.callBase(e);break;default:this._isAdaptivityEnabled()&&this._treeView.option(e.name,e.value),this.callBase(e)}},_changeSubmenusOption:function(e,t){r(this._submenus,function(i,n){n.option(e,t)})},selectItem:function(e){this._hideSubmenu(this._visibleSubmenu),this.callBase(e)},unselectItem:function(e){this._hideSubmenu(this._visibleSubmenu),this.callBase(e)}});o("dxMenu",j),i.exports=j}

