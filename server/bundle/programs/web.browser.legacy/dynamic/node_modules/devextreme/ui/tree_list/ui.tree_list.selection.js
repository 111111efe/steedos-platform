function(e){"use strict";var t,n=h(e("../../core/renderer")),i,l=h(e("./ui.tree_list.core")),s=e("../../core/utils/common"),o=h(s),r,c=h(e("../grid_core/ui.grid_core.selection")),a,d=h(e("../widget/ui.errors")),u=e("../../core/utils/extend");function h(e){return e&&e.__esModule?e:{default:e}}var y="dx-treelist-select-all",f="dx-cell-focus-disabled",S="dx-select-checkbox",p=c.default.extenders.views.rowsView._rowClick,_=c.default.extenders.controllers.data._handleDataChanged,v=function(e,t){return!!e.filter(function(e){return e===t}).length};l.default.registerModule("selection",(0,u.extend)(!0,{},c.default,{defaultOptions:function(){return(0,u.extend)(!0,c.default.defaultOptions(),{selection:{showCheckBoxesMode:"always",recursive:!1}})},extenders:{controllers:{data:{_handleDataChanged:function(e){var t=this.getController("selection"),n;!t.isRecursiveSelection()||e&&"updateSelectionState"===e.changeType||t.updateSelectionState({selectedItemKeys:this.option("selectedRowKeys")}),_.apply(this,arguments)},loadDescendants:function(){var e=this,t=e.callBase.apply(e,arguments),n=e.getController("selection"),i;return n.isRecursiveSelection()&&t.done(function(){n.updateSelectionState({selectedItemKeys:e.option("selectedRowKeys")})}),t}},selection:{init:function(){this.callBase.apply(this,arguments),this._selectionStateByKey={}},_getSelectionConfig:function(){var e=this,t=arguments,n=this.callBase.apply(this,arguments),i=n.plainItems;return n.plainItems=function(n){return n?e._dataController.getCachedStoreData()||[]:i.apply(e,t).map(function(e){return e.data})},n.isItemSelected=function(t){var n=e._dataController.keyOf(t);return e.isRowSelected(n)},n.isSelectableItem=function(){return!0},n.getItemData=function(e){return e},n},renderSelectCheckBoxContainer:function(e,t){var n=this,i=this.component.getView("rowsView");e.addClass("dx-cell-focus-disabled");var l=i._renderSelectCheckBox(e,{value:t.row.isSelected,row:t.row,column:t.column});i._attachCheckBoxClickEvent(l)},_updateSelectColumn:s.noop,_getVisibleNodeKeys:function(e){var t=this.component,n=t.getRootNode(),i={},s=[];return n&&l.default.foreachNodes(n.children,function(n){return void 0!==n.key&&(n.visible||e)&&s.push(n.key),!e&&t.isRowExpanded(n.key,i)}),s},isSelectAll:function(){var e,t=this.component,n=this._getVisibleNodeKeys(),i=n.filter(function(e){return t.isRowSelected(e)});return i.length?i.length===n.length||void 0:!!(e=n.some(function(e){return void 0===t.isRowSelected(e)}))&&void 0},selectAll:function(){var e=this,t=e.isRecursiveSelection(),n=e._getVisibleNodeKeys(t).filter(function(t){return!e.isRowSelected(t)});return e.selectRows(n,!0)},deselectAll:function(){var e=this.isRecursiveSelection(),t=this._getVisibleNodeKeys(e);return this.deselectRows(t)},selectedItemKeys:function(e,t,n,i){var l=this,s=l.option("selectedRowKeys"),r,c=this.isRecursiveSelection()&&l._normalizeSelectionArgs({keys:e||[]},!n);return c&&!o.default.equalByValue(c.selectedRowKeys,s)?(l._isSelectionNormalizing=!0,this.callBase(c.selectedRowKeys,!1,!1,!1).always(function(){l._isSelectionNormalizing=!1}).done(function(e){c.selectedRowsData=e,l._fireSelectionChanged(c)})):this.callBase(e,t,n,i)},changeItemSelection:function(e,t){var n;if(this.isRecursiveSelection()&&!t.shift){var i=this._dataController.getKeyByRowIndex(e);return this.selectedItemKeys(i,!0,this.isRowSelected(i))}return this.callBase.apply(this,arguments)},_updateParentSelectionState:function(e,t){var n,i,l=this,s=t,o=e.parent;o&&(o.children.length>1&&(!1===t?s=!!(i=o.children.some(function(e,t,n){return l._selectionStateByKey[e.key]}))&&void 0:!0===t&&(s=!(n=o.children.some(function(e){return!l._selectionStateByKey[e.key]}))||void 0)),this._selectionStateByKey[o.key]=s,o.parent&&o.parent.level>=0&&this._updateParentSelectionState(o,s))},_updateChildrenSelectionState:function(e,t){var n=this,i=e.children;i&&i.forEach(function(e){n._selectionStateByKey[e.key]=t,e.children.length>0&&n._updateChildrenSelectionState(e,t)})},_updateSelectionStateCore:function(e,t){for(var n,i=this._dataController,l=0;l<e.length;l++)this._selectionStateByKey[e[l]]=t,(n=i.getNodeByKey(e[l]))&&(this._updateParentSelectionState(n,t),this._updateChildrenSelectionState(n,t))},_getSelectedParentKeys:function(e,t,n){for(var i,l,s=this._dataController.getNodeByKey(e),o=s&&s.parent,r=[];o&&o.level>=0;){if(r.unshift(o.key),i=n?!v(t,o.key)&&this.isRowSelected(o.key):t.indexOf(o.key)>=0){l=o,r=this._getSelectedParentKeys(l.key,t,n).concat(r);break}if(n)break;o=o.parent}return l&&r||[]},_getSelectedChildKeys:function(e,t){var n=this,i=[];return e&&l.default.foreachNodes(e.children,function(e){var l=t.indexOf(e.key);return l<0&&i.push(e.key),l>0||l<0&&void 0===n._selectionStateByKey[e.key]}),i},_normalizeParentKeys:function(e,t){var n,i,l,s=this,o=[e],r=this._getSelectedParentKeys(e,t.selectedRowKeys);r.length&&((o=o.concat(r)).forEach(function(e){(n=t.selectedRowKeys.indexOf(e))>=0&&t.selectedRowKeys.splice(n,1)}),l=this._dataController.getNodeByKey(r[0]),i=this._getSelectedChildKeys(l,o),t.selectedRowKeys=t.selectedRowKeys.concat(i))},_normalizeChildrenKeys:function(e,t){var n,i=this,l=i._dataController.getNodeByKey(e);l&&l.children.forEach(function(e){(n=t.selectedRowKeys.indexOf(e.key))>=0&&t.selectedRowKeys.splice(n,1),i._normalizeChildrenKeys(e.key,t)})},_normalizeSelectedRowKeysCore:function(e,t,n){var i,l=this;e.forEach(function(e){l.isRowSelected(e)!==n&&(l._normalizeChildrenKeys(e,t),i=t.selectedRowKeys.indexOf(e),n?(i<0&&t.selectedRowKeys.push(e),t.currentSelectedRowKeys.push(e)):(i>=0&&t.selectedRowKeys.splice(i,1),t.currentDeselectedRowKeys.push(e),l._normalizeParentKeys(e,t)))})},_normalizeSelectionArgs:function(e,t){var n,i=Array.isArray(e.keys)?e.keys:[e.keys],l=this.option("selectedRowKeys")||[];return i.length&&(n={currentSelectedRowKeys:[],currentDeselectedRowKeys:[],selectedRowKeys:l.slice(0)},this._normalizeSelectedRowKeysCore(i,n,t)),n},_updateSelectedItems:function(e){this.updateSelectionState(e),this.callBase(e)},_fireSelectionChanged:function(){this._isSelectionNormalizing||this.callBase.apply(this,arguments)},_isModeLeavesOnly:function(e){return"leavesOnly"===e||!0===e},_getAllSelectedRowKeys:function(e){var t=this,n=[];return e.forEach(function(e){var i=n.length,l=t._getSelectedParentKeys(e,n,!0),s=t._dataController.getChildNodeKeys(e);n.splice.apply(n,[i,0].concat(l)),n.push(e),n=n.concat(s)}),n},_getParentSelectedRowKeys:function(e){var t=this,n=[];return e.forEach(function(i){var l;!t._getSelectedParentKeys(i,e).length&&n.push(i)}),n},_getLeafSelectedRowKeys:function(e){var t=this,n=[],i=this._dataController;return e.forEach(function(e){var t=i.getNodeByKey(e);t&&!t.hasChildren&&n.push(e)}),n},isRecursiveSelection:function(){var e=this.option("selection.mode"),t=this.option("selection.recursive");return"multiple"===e&&t},updateSelectionState:function(e){var t=e.removedItemKeys||[],n=e.selectedItemKeys||[];this._updateSelectionStateCore(t,!1),this._updateSelectionStateCore(n,!0)},isRowSelected:function(e){var t=this.callBase.apply(this,arguments),n=this.isRecursiveSelection();return!t&&n?e in this._selectionStateByKey&&this._selectionStateByKey[e]:t},getSelectedRowKeys:function(e){var t=this;if(!this._dataController)return[];!0===e&&d.default.log("W0002","dxTreeList","getSelectedRowKeys(leavesOnly)","18.1","Use the 'getSelectedRowKeys(mode)' method with a string parameter instead");var n=this.callBase.apply(this,arguments);return e&&(this.isRecursiveSelection()&&(n=this._getAllSelectedRowKeys(n)),"all"!==e&&("excludeRecursive"===e?n=this._getParentSelectedRowKeys(n):this._isModeLeavesOnly(e)&&(n=this._getLeafSelectedRowKeys(n)))),n},getSelectedRowsData:function(e){var t=this,n=this._dataController,i=this.getSelectedRowKeys(e)||[],l=[];return i.forEach(function(e){var t=n.getNodeByKey(e);t&&l.push(t.data)}),l},refresh:function(){return this._selectionStateByKey={},this.callBase.apply(this,arguments)}}},views:{columnHeadersView:{_processTemplate:function(e,t){var n,i=this,l=this.callBase(e,t),s=i._columnsController.getFirstDataColumnIndex();return n=l&&"header"===t.rowType&&t.column.index===s?{render:function(e){"multiple"===i.option("selection.mode")&&i.renderSelectAll(e.container,e.model),l.render(e)}}:l},renderSelectAll:function(e,t){e.addClass("dx-treelist-select-all"),this._renderSelectAllCheckBox(e)},_isSortableElement:function(e){return this.callBase(e)&&!e.closest(".dx-select-checkbox").length}},rowsView:{_renderExpandIcon:function(e,t){var n=this.callBase(e,t);return"multiple"===this.option("selection.mode")&&this.getController("selection").renderSelectCheckBoxContainer(n,t),n},_rowClick:function(e){var t=(0,n.default)(e.event.target);this.isExpandIcon(t)?this.callBase.apply(this,arguments):p.apply(this,arguments)}}}}}))}

