function(e,t,s){const{defaults:l}=e("./defaults.js"),{block:n}=e("./rules.js"),{rtrim:i,splitCells:h,escape:r}=e("./helpers.js");s.exports=class e{constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||l,this.rules=n.normal,this.options.pedantic?this.rules=n.pedantic:this.options.gfm&&(this.rules=n.gfm)}static get rules(){return n}static lex(t,s){const l=new e(s);return l.lex(t)}lex(e){return e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    "),this.token(e,!0)}token(e,t){let s,l,g,o,a,p,c,u,k,d,f,x,b,y,m,$;for(e=e.replace(/^ +$/gm,"");e;)if((g=this.rules.newline.exec(e))&&(e=e.substring(g[0].length),g[0].length>1&&this.tokens.push({type:"space"})),g=this.rules.code.exec(e)){const t=this.tokens[this.tokens.length-1];e=e.substring(g[0].length),t&&"paragraph"===t.type?t.text+="\n"+g[0].trimRight():(g=g[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",codeBlockStyle:"indented",text:this.options.pedantic?g:i(g,"\n")}))}else if(g=this.rules.fences.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"code",lang:g[2]?g[2].trim():g[2],text:g[3]||""});else if(g=this.rules.heading.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"heading",depth:g[1].length,text:g[2]});else if((g=this.rules.nptable.exec(e))&&(p={type:"table",header:h(g[1].replace(/^ *| *\| *$/g,"")),align:g[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:g[3]?g[3].replace(/\n$/,"").split("\n"):[]}).header.length===p.align.length){for(e=e.substring(g[0].length),f=0;f<p.align.length;f++)/^ *-+: *$/.test(p.align[f])?p.align[f]="right":/^ *:-+: *$/.test(p.align[f])?p.align[f]="center":/^ *:-+ *$/.test(p.align[f])?p.align[f]="left":p.align[f]=null;for(f=0;f<p.cells.length;f++)p.cells[f]=h(p.cells[f],p.header.length);this.tokens.push(p)}else if(g=this.rules.hr.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"hr"});else if(g=this.rules.blockquote.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"blockquote_start"}),g=g[0].replace(/^ *> ?/gm,""),this.token(g,t),this.tokens.push({type:"blockquote_end"});else if(g=this.rules.list.exec(e)){for(e=e.substring(g[0].length),c={type:"list_start",ordered:y=(o=g[2]).length>1,start:y?+o:"",loose:!1},this.tokens.push(c),u=[],s=!1,b=(g=g[0].match(this.rules.item)).length,f=0;f<b;f++)d=(p=g[f]).length,~(p=p.replace(/^ *([*+-]|\d+\.) */,"")).indexOf("\n ")&&(d-=p.length,p=this.options.pedantic?p.replace(/^ {1,4}/gm,""):p.replace(new RegExp("^ {1,"+d+"}","gm"),"")),f!==b-1&&(a=n.bullet.exec(g[f+1])[0],(o.length>1?1===a.length:a.length>1||this.options.smartLists&&a!==o)&&(e=g.slice(f+1).join("\n")+e,f=b-1)),l=s||/\n\n(?!\s*$)/.test(p),f!==b-1&&(s="\n"===p.charAt(p.length-1),l||(l=s)),l&&(c.loose=!0),$=void 0,(m=/^\[[ xX]\] /.test(p))&&($=" "!==p[1],p=p.replace(/^\[[ xX]\] +/,"")),k={type:"list_item_start",task:m,checked:$,loose:l},u.push(k),this.tokens.push(k),this.token(p,!1),this.tokens.push({type:"list_item_end"});if(c.loose)for(b=u.length,f=0;f<b;f++)u[f].loose=!0;this.tokens.push({type:"list_end"})}else if(g=this.rules.html.exec(e))e=e.substring(g[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&("pre"===g[1]||"script"===g[1]||"style"===g[1]),text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(g[0]):r(g[0]):g[0]});else if(t&&(g=this.rules.def.exec(e)))e=e.substring(g[0].length),g[3]&&(g[3]=g[3].substring(1,g[3].length-1)),x=g[1].toLowerCase().replace(/\s+/g," "),this.tokens.links[x]||(this.tokens.links[x]={href:g[2],title:g[3]});else if((g=this.rules.table.exec(e))&&(p={type:"table",header:h(g[1].replace(/^ *| *\| *$/g,"")),align:g[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:g[3]?g[3].replace(/\n$/,"").split("\n"):[]}).header.length===p.align.length){for(e=e.substring(g[0].length),f=0;f<p.align.length;f++)/^ *-+: *$/.test(p.align[f])?p.align[f]="right":/^ *:-+: *$/.test(p.align[f])?p.align[f]="center":/^ *:-+ *$/.test(p.align[f])?p.align[f]="left":p.align[f]=null;for(f=0;f<p.cells.length;f++)p.cells[f]=h(p.cells[f].replace(/^ *\| *| *\| *$/g,""),p.header.length);this.tokens.push(p)}else if(g=this.rules.lheading.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"heading",depth:"="===g[2].charAt(0)?1:2,text:g[1]});else if(t&&(g=this.rules.paragraph.exec(e)))e=e.substring(g[0].length),this.tokens.push({type:"paragraph",text:"\n"===g[1].charAt(g[1].length-1)?g[1].slice(0,-1):g[1]});else if(g=this.rules.text.exec(e))e=e.substring(g[0].length),this.tokens.push({type:"text",text:g[0]});else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0));return this.tokens}}}

