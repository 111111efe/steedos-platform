function(e,t,s){const i=e("./Renderer.js"),{defaults:r}=e("./defaults.js"),{inline:n}=e("./rules.js"),{findClosingBracket:l,escape:h}=e("./helpers.js");s.exports=class e{constructor(e,t){if(this.options=t||r,this.links=e,this.rules=n.normal,this.options.renderer=this.options.renderer||new i,this.renderer=this.options.renderer,this.renderer.options=this.options,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.pedantic?this.rules=n.pedantic:this.options.gfm&&(this.options.breaks?this.rules=n.breaks:this.rules=n.gfm)}static get rules(){return n}static output(t,s,i){const r=new e(s,i);return r.output(t)}output(t){let s="",i,r,n,o,u,a;for(;t;)if(u=this.rules.escape.exec(t))t=t.substring(u[0].length),s+=h(u[1]);else if(u=this.rules.tag.exec(t))!this.inLink&&/^<a /i.test(u[0])?this.inLink=!0:this.inLink&&/^<\/a>/i.test(u[0])&&(this.inLink=!1),!this.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(u[0])?this.inRawBlock=!0:this.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(u[0])&&(this.inRawBlock=!1),t=t.substring(u[0].length),s+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(u[0]):h(u[0]):u[0];else if(u=this.rules.link.exec(t)){const r=l(u[2],"()");if(r>-1){const e=0===u[0].indexOf("!")?5:4,t=e+u[1].length+r;u[2]=u[2].substring(0,r),u[0]=u[0].substring(0,t).trim(),u[3]=""}t=t.substring(u[0].length),this.inLink=!0,n=u[2],this.options.pedantic?(i=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(n))?(n=i[1],o=i[3]):o="":o=u[3]?u[3].slice(1,-1):"",n=n.trim().replace(/^<([\s\S]*)>$/,"$1"),s+=this.outputLink(u,{href:e.escapes(n),title:e.escapes(o)}),this.inLink=!1}else if((u=this.rules.reflink.exec(t))||(u=this.rules.nolink.exec(t))){if(t=t.substring(u[0].length),i=(u[2]||u[1]).replace(/\s+/g," "),!(i=this.links[i.toLowerCase()])||!i.href){s+=u[0].charAt(0),t=u[0].substring(1)+t;continue}this.inLink=!0,s+=this.outputLink(u,i),this.inLink=!1}else if(u=this.rules.strong.exec(t))t=t.substring(u[0].length),s+=this.renderer.strong(this.output(u[4]||u[3]||u[2]||u[1]));else if(u=this.rules.em.exec(t))t=t.substring(u[0].length),s+=this.renderer.em(this.output(u[6]||u[5]||u[4]||u[3]||u[2]||u[1]));else if(u=this.rules.code.exec(t))t=t.substring(u[0].length),s+=this.renderer.codespan(h(u[2].trim(),!0));else if(u=this.rules.br.exec(t))t=t.substring(u[0].length),s+=this.renderer.br();else if(u=this.rules.del.exec(t))t=t.substring(u[0].length),s+=this.renderer.del(this.output(u[1]));else if(u=this.rules.autolink.exec(t))t=t.substring(u[0].length),n="@"===u[2]?"mailto:"+(r=h(this.mangle(u[1]))):r=h(u[1]),s+=this.renderer.link(n,null,r);else if(this.inLink||!(u=this.rules.url.exec(t))){if(u=this.rules.text.exec(t))t=t.substring(u[0].length),this.inRawBlock?s+=this.renderer.text(this.options.sanitize?this.options.sanitizer?this.options.sanitizer(u[0]):h(u[0]):u[0]):s+=this.renderer.text(h(this.smartypants(u[0])));else if(t)throw new Error("Infinite loop on byte: "+t.charCodeAt(0))}else{if("@"===u[2])n="mailto:"+(r=h(u[0]));else{do{a=u[0],u[0]=this.rules._backpedal.exec(u[0])[0]}while(a!==u[0]);r=h(u[0]),n="www."===u[1]?"http://"+r:r}t=t.substring(u[0].length),s+=this.renderer.link(n,null,r)}return s}static escapes(t){return t?t.replace(e.rules._escapes,"$1"):t}outputLink(e,t){const s=t.href,i=t.title?h(t.title):null;return"!"!==e[0].charAt(0)?this.renderer.link(s,i,this.output(e[1])):this.renderer.image(s,i,h(e[1]))}smartypants(e){return this.options.smartypants?e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014\/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014\/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…"):e}mangle(e){if(!this.options.mangle)return e;const t=e.length;let s="",i=0,r;for(;i<t;i++)r=e.charCodeAt(i),Math.random()>.5&&(r="x"+r.toString(16)),s+="&#"+r+";";return s}}}

