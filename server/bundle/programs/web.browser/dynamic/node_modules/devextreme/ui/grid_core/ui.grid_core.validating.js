function(t,e,i){"use strict";var a,o=A(t("../../core/renderer")),n,l=A(t("../../events/core/events_engine")),r,s=A(t("./ui.grid_core.modules")),d=t("./ui.grid_core.utils"),u=t("../../core/utils/common"),c=t("../../core/utils/iterator"),h=t("../../core/utils/type"),g=t("../../core/utils/extend"),f=t("../widget/selectors"),p,v=A(t("../../localization/message")),_,m=A(t("../button")),w,x=A(t("../../events/pointer")),V,y=A(t("../validation_engine")),C,b=A(t("../validator")),I,E=A(t("../tooltip")),R,D=A(t("../overlay")),k,P=A(t("../themes")),B,M=A(t("../widget/ui.errors"));function A(t){return t&&t.__esModule?t:{default:t}}var T="invalid",W="revert-tooltip",F="rowsview",H="dx-invalid-message",O="invalid-message",S="dx-invalid-message-always",G="dx-revert-button",K="dx-highlight-outline",$="validator",N="__DX_INSERT_INDEX__",j=2,z="row",q="form",X="batch",J="cell",U="popup",L="dx-group-cell",Q=["popup","form"],Y="transparent",Z=s.default.Controller.inherit({init:function(){this._editingController=this.getController("editing"),this.createAction("onRowValidating")},_rowValidating:function(t,e){var i=this,a=e?e.brokenRules||e.brokenRule&&[e.brokenRule]:[],o,n={brokenRules:a,isValid:e?e.isValid:t.isValid,key:t.key,newData:t.data,oldData:t.oldData,errorText:this.getHiddenValidatorsErrorText(a)};return this.executeAction("onRowValidating",n),t.isValid=n.isValid,t.errorText=n.errorText,n},getHiddenValidatorsErrorText:function(t){var e=[];return(0,c.each)(t,function(t,i){i.validator.$element().parent().length||e.push(i.message)}),e.join(", ")},validate:function(t){var e=this,i=!0,a=e._editingController;return t=t||"row"===a.getEditMode(),!e._isValidationInProgress&&(e._isValidationInProgress=!0,t?(0,c.each)(a._editData,function(t,o){var n;o.type&&"remove"!==o.type&&((n=e.validateGroup(o)).isValid||(0,c.each)(n.brokenRules,function(){var t=this.validator.option("adapter").getValue();void 0===t&&(t=null),this.column&&a.updateFieldValue({key:o.key,column:this.column},t,null,!0)}),i=i&&n.isValid)}):e._currentCellValidator&&(i=e.validateGroup(e._currentCellValidator._findGroup()).isValid),e._isValidationInProgress=!1,i)},validateGroup:function t(e){var i,a=this,t=y.default.getGroupConfig(e);return t&&t.validators.length&&(i=y.default.validateGroup(e)),this._rowValidating(e,i)},updateEditData:function(t){var e=this._editingController.getEditMode();-1===Q.indexOf(e)?(this.setDisableApplyValidationResults(!0),t.isValid=!y.default.getGroupConfig(t)||y.default.validateGroup(t).isValid,this.setDisableApplyValidationResults(!1)):t.isValid=!0},setValidator:function(t){this._currentCellValidator=t},getValidator:function(){return this._currentCellValidator},createValidator:function(t,e){var i,a,n,r,s=this,u=s._editingController,c=t.column,p=function(t){if(t.brokenRule&&(t.brokenRule.columnIndex=c.index,t.brokenRule.column=c),e&&!s.getDisableApplyValidationResults()){if(!t.isValid){var i=e.find(":focus");u.showHighlighting(e,!0),(0,f.focused)(i)||(l.default.trigger(i,"focus"),l.default.trigger(i,x.default.down))}e.toggleClass(s.addWidgetPrefix("invalid"),!t.isValid)}},v=function(){var e=c.calculateCellValue(i.data||{});return void 0!==e?e:t.value},_=c.showEditorAlways;if(c.validationRules&&Array.isArray(c.validationRules)&&c.validationRules.length&&!(0,h.isDefined)(c.command)&&((a=u.getIndexByKey(t.key,u._editData))<0&&(_||(_=(n=(r=s.getController("columns"))&&r.getVisibleColumns()||[]).some(function(t){return t.showEditorAlways})),_&&(a=u._addEditData({key:t.key,oldData:t.data}))),a>=0)){if(e&&!e.length)return void M.default.log("E1050");i=u._editData[a];var m=e&&e.hasClass("dx-widget");e&&e.addClass(s.addWidgetPrefix("validator"));var w=new b.default(e||(0,o.default)("<div>"),{name:c.caption,validationRules:(0,g.extend)(!0,[],c.validationRules),validationGroup:i,adapter:m?null:{getValue:v,applyValidationResults:p},dataGetter:function(){return(0,d.createObjectWithChanges)(i.oldData,i.data)}});if(m){var V=w.option("adapter");V&&(V.getValue=v)}return w}},setDisableApplyValidationResults:function(t){this._disableApplyValidationResults=t},getDisableApplyValidationResults:function(){return this._disableApplyValidationResults}}),tt,et;i.exports={defaultOptions:function(){return{editing:{texts:{validationCancelChanges:v.default.format("dxDataGrid-validationCancelChanges")}}}},controllers:{validating:Z},extenders:{controllers:{editing:{_addEditData:function(t,e){var i,a=this,o=this.getController("validating"),n=this.callBase(t,e);return n>=0&&(i=this._editData[n],o.updateEditData(i)),n},_updateRowAndPageIndices:function(){var t=this,e=t.getView("rowsView").getTopVisibleItemIndex(),i=e;(0,c.each)(t._editData,function(a,o){o.isValid||o.pageIndex===t._pageIndex||(o.pageIndex=t._pageIndex,"insert"===o.type?o.rowIndex=e:o.rowIndex=i,i++)})},_needInsertItem:function(t){var e=this.callBase.apply(this,arguments);return e&&!t.isValid&&(e=t.key.pageIndex===this._pageIndex),e},processItems:function(t,e){var i,a,o=this,n=this._editData,l=this.getController("data"),r=function(t,e){var i=-1,a="insert"===t.type,o=t.key;return(0,c.each)(e,function(t,e){if((0,u.equalByValue)(o,a?e:l.keyOf(e)))return i=t,!1}),i},s=function(e){var i,o={key:e.key},n;r(e,t)>=0||(e.rowIndex=e.rowIndex>a?e.rowIndex%a:e.rowIndex,i=e.rowIndex,o[N]=1,t.splice(i,0,o))};if(t=this.callBase(t,e),a=t.length,"batch"===this.getEditMode()&&"prepend"!==e&&"append"!==e)for(i=0;i<n.length;i++)n[i].type&&n[i].pageIndex===this._pageIndex&&n[i].key.pageIndex!==this._pageIndex&&s(n[i]);return t},processDataItem:function(t){var e,i,a=this,o=t.data[N],n=o?t.data.key:t.key,l;"batch"===this.getEditMode()&&o&&n&&(e=(0,d.getIndexByKey)(n,this._editData))>=0&&"insert"!==(i=this._editData[e]).type&&(t.data=(0,g.extend)(!0,{},i.oldData,i.data),t.key=n),this.callBase.apply(this,arguments)},_createInvisibleColumnValidators:function(t){var e=this.getController("validating"),i=(0,u.grep)(this.getController("columns").getInvisibleColumns(),function(t){return!t.isBand}),a=[];return-1===Q.indexOf(this.getEditMode())&&(0,c.each)(i,function(i,o){t.forEach(function(t){var i;if("insert"===t.type?i=t.data:"update"===t.type&&(i=(0,d.createObjectWithChanges)(t.oldData,t.data)),i){var n=e.createValidator({column:o,key:t.key,value:o.calculateCellValue(i)});n&&a.push(n)}})}),function(){a.forEach(function(t){t._dispose()})}},_beforeSaveEditData:function(t,e){var i,a,o=this,n=this.callBase.apply(this,arguments),l=this.getController("validating");if(t)i="remove"===t.type||t.isValid,n=n||!i;else{var r=this._createInvisibleColumnValidators(this._editData);switch(a=l.validate(!0),r(),this._updateRowAndPageIndices(),this.getEditMode()){case"cell":a||(this._focusEditingCell(),n=!0);break;case"batch":a||(this._editRowIndex=-1,this._editColumnIndex=-1,this.getController("data").updateItems(),n=!0);break;case"row":case"popup":n=!a}}return n},_beforeEditCell:function(t,e,i){var a=this.callBase(t,e,i),o=this._rowsView._getCellElement(t,e),n=o&&o.data("dxValidator"),l=n&&n.option("adapter").getValue();if("cell"===this.getEditMode(this)&&(!n||void 0!==l&&n.validate().isValid))return a},_afterSaveEditData:function(){var t,e=this;if((0,c.each)(e._editData,function(i,a){var o=e._showErrorRow(a);t=t||o}),t){var i=this._rowsView.getScrollable();i&&(i.update(),i.scrollToElement(t))}},_showErrorRow:function(t){var e,i=this.getController("errorHandling"),a=this.getController("data").items(),o=this.getIndexByKey(t.key,a);if(!t.isValid&&t.errorText&&o>=0)return e=this.getPopupContent(),i&&i.renderErrorRow(t.errorText,o,e)},updateFieldValue:function(t){var e=this,i=this.getEditMode();if(this.callBase.apply(this,arguments),"row"===i||"batch"===i&&t.column.showEditorAlways){var a=this.getController("validating").getValidator();a&&a.validate()}},showHighlighting:function(t,e){var i,a=!0;e||(i=t.data("dxValidator"))&&(a=i.validate().isValid),a&&this.callBase(t)},getEditDataByKey:function(t){return this._editData[(0,d.getIndexByKey)(t,this._editData)]}},editorFactory:(tt=function(t,e){var i=(0,o.default)(e).closest("tr").index(),a=(0,o.default)(t._rowsView.getRowElement(i)).first().children().filter(":not(.dx-hidden-cell)");return t._rowsView._getWidths(a).reduce(function(t,e){return t+e},0)},et=function(t){var e=void 0,i=void 0;return t.some(function(a,o){if("transparent"===a.command)return e=0===o?-1:o,i=o===t.length-1?-1:o+a.colspan-1,!0}),{startColumnIndex:e,endColumnIndex:i}},{_showRevertButton:function(t,e){var i=this;if(e&&e.length){var a=(0,o.default)("<div>").addClass(this.addWidgetPrefix("revert-tooltip")).appendTo(t),n={animation:null,visible:!0,target:e,container:t,closeOnOutsideClick:!1,closeOnTargetScroll:!1,contentTemplate:function(){var t=(0,o.default)("<div>").addClass("dx-revert-button"),e={icon:"revert",hint:i.option("editing.texts.validationCancelChanges"),onClick:function(){i._editingController.cancelEditData()}};return new m.default(t,e).$element()},position:{my:"left top",at:"right top",of:e,offset:"1 0",collision:"flip",boundary:this._rowsView.element()},onPositioned:this._positionedHandler.bind(this)};return new E.default(a,n)}},_hideFixedGroupCell:function(t,e){var i,a,n,l=this._rowsView.isFixedColumns(),r=this._editingController.isFormEditMode();l&&!r&&(i=t.closest(".dx-row").next().data("options"))&&"group"===i.rowType&&(a=(0,o.default)(this._rowsView.getRowElement(i.rowIndex)).last(),(n=a.find(".dx-group-cell")).length&&"hidden"!==n.get(0).style.visibility&&(n.css("visibility","hidden"),e.onDisposing=function(){n.css("visibility","")}))},_positionedHandler:function(t,e){if(!t.component.__skipPositionProcessing){var i=(0,o.default)(t.element).hasClass(this.addWidgetPrefix("revert-tooltip")),a=!i&&this._rowsView.updateFreeSpaceRowHeight(),n=this._normalizeValidationMessagePositionAndMaxWidth(t,i,e);t.component.__skipPositionProcessing=!(!a&&!n),n?t.component.option(n):a&&t.component.repaint()}},_showValidationMessage:function(t,e,i,a){var n=this,l=t.find(".dx-highlight-outline"),r=P.default.isMaterial(),s=l.length&&!r?l:t,d=t.find(".dx-dropdowneditor-overlay").data("dxPopup"),u=d&&d.option("visible"),c=u?"top right":"top "+i,h=u?"top left":"bottom "+i,g=(0,o.default)("<div>").addClass("dx-invalid-message").addClass("dx-invalid-message-always").addClass(this.addWidgetPrefix("invalid-message")).text(e).appendTo(t),f={target:s,container:t,shading:!1,width:"auto",height:"auto",visible:!0,animation:!1,propagateOutsideClick:!0,closeOnOutsideClick:!1,closeOnTargetScroll:!1,position:{collision:"flip",boundary:this._rowsView.element(),boundaryOffset:"0 0",my:c,at:h},onPositioned:function(e){n._positionedHandler(e,u),n._shiftValidationMessageIfNeed(e.component.$content(),a&&a.$content(),t)}};this._hideFixedGroupCell(t,f),new D.default(g,f)},_normalizeValidationMessagePositionAndMaxWidth:function(t,e,i){var a=this._columnsController.getFixedColumns();if(a&&a.length){var n=void 0,l=!e&&tt(this,t.element),r,s=(e?t.component.overlayContent():t.component.$content()).outerWidth(!0),d=!e&&s>l,u=this._rowsView.getCellIndex((0,o.default)(t.element).closest("td")),c=et(a);return e||u!==c.startColumnIndex&&!d?u===c.endColumnIndex&&(n={collision:"none flip",my:"top right",at:e||i?"top left":"bottom right"},e&&(n.offset="-1 0")):n={collision:"none flip",my:"top left",at:i?"top right":"bottom left"},n&&{position:n,maxWidth:d?l-2:void 0}}},_shiftValidationMessageIfNeed:function(t,e,i){if(e){var a=t.offset(),o=e.offset();if(a.top===o.top&&a.left+t.width()>o.left){var n=e.width()+2;t.css("left",o.left<i.offset().left?-n:n)}}},_getTooltipsSelector:function(){var t=this.addWidgetPrefix("invalid-message"),e;return".dx-editor-cell ."+this.addWidgetPrefix("revert-tooltip")+", .dx-editor-cell ."+t+", .dx-cell-modified ."+t},init:function(){this.callBase(),this._editingController=this.getController("editing"),this._columnsController=this.getController("columns"),this._rowsView=this.getView("rowsView")},loseFocus:function(t){t||this.getController("validating").setValidator(null),this.callBase()},focus:function(t,e){var i,a,o=this,n=t&&t.closest(this._getFocusCellSelector()),l=n&&(n.data("dxValidator")||t.find("."+this.addWidgetPrefix("validator")).eq(0).data("dxValidator")),r=n&&n.closest(".dx-row").data("options"),s=r?this.getController("editing").getEditDataByKey(r.key):null,d=n&&n.closest("."+this.addWidgetPrefix("rowsview")).find(this._getTooltipsSelector()),u=n&&n.is("td")?n:null,c=!1,h=u&&this.getController("columns").getVisibleColumns()[u.index()];return arguments.length?(d&&d.remove(),l&&(this.getController("validating").setValidator(l),void 0!==l.option("adapter").getValue()&&((i=l.validate()).isValid||(e=!0,c=!0))),(i&&!i.isValid||s&&"update"===s.type&&!this._editingController.isSaving())&&"cell"===this._editingController.getEditMode()&&(a=this._showRevertButton(n,u?n.find(".dx-highlight-outline").first():n)),c&&u&&h&&i.brokenRule.message&&this._showValidationMessage(n,i.brokenRule.message,h.alignment||"left",a),!e&&this._rowsView.element()&&this._rowsView.updateFreeSpaceRowHeight(),this.callBase(t,e)):this.callBase()}})},views:{rowsView:{updateFreeSpaceRowHeight:function(t){var e,i,a,o=this,n=this.element(),l=n&&n.find("."+this.addWidgetPrefix("invalid-message")+" .dx-overlay-content");if(this.callBase(t),l&&l.length&&(e=this._getRowElements(),(i=(a=this._getFreeSpaceRowElements(t)).first())&&1===e.length&&(!i.is(":visible")||l.outerHeight()>i.outerHeight())))return a.show(),a.height(l.outerHeight()),!0},_formItemPrepared:function(t,e){var i=this;this.callBase.apply(this,arguments),(0,u.deferUpdate)(function(){var a=e.find(".dx-widget").first(),o;a.length&&!a.children().length||i.getController("validating").createValidator(t,a)})},_cellPrepared:function(t,e){this.getController("editing").isFormEditMode()||this.getController("validating").createValidator(e,t),this.callBase.apply(this,arguments)}}}}}}

