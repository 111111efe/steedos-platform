function(t,e,n){"use strict";var a,i=k(t("../../core/renderer")),r=t("../../core/utils/array"),o=k(r),s,u=k(t("./utils.recurrence")),c,p=k(t("../../core/utils/type")),l,g=k(t("../../core/utils/date")),d=t("../../core/utils/iterator"),h,f=k(t("../../animation/translator")),m=t("../../core/utils/common"),D=t("../../core/utils/extend"),_,y=k(t("../../localization/date")),A,T=k(t("./timezones/ui.scheduler.timezones")),S=t("../../core/utils/deferred");function k(t){return t&&t.__esModule?t:{default:t}}var v=60,w=g.default.dateToMilliseconds,b={isCurrentViewAgenda:function(){return"agenda"===this.option("currentView")},currentViewUpdated:function(t){this.option("currentView",t)},currentDateUpdated:function(t){this.option("currentDate",t)},setCellDataCacheAlias:function(t,e){this._workSpace.setCellDataCacheAlias(t,e)},needCoordinates:function(t){var e=this,n=t.appointmentData,a=t.startDate,i=this._getEndDate(n),r=this.fire("getField","recurrenceRule",n),o=this._getRecurrenceException(n),s=this._workSpace.getDateRange(),c=this.appointmentTakesAllDay(n),p=this.appointmentTakesAllDay(n)?g.default.trimTime(new Date(s[0])):s[0],l=t.originalStartDate||a,d=this.getLayoutManager().getRenderingStrategyInstance(),h=this.option("firstDayOfWeek"),f={rule:r,exception:o,start:l,end:i,min:p,max:s[1],firstDayOfWeek:h},m=u.default.getDatesByRecurrence(f),D=void 0;if(m.length?(D=m,m=m.map(function(t){return g.default.roundDateByStartDayHour(t,e._getCurrentViewOption("startDayHour"))})):(m.push(a),D=m),d.needSeparateAppointment(c)){for(var _=m.length,y=[],A=[],T=0;T<_;T++){var S=d.endDate(n,{startDate:m[T]},!!r);y=g.default.getDatesOfInterval(m[T],S,{milliseconds:this.getWorkSpace().getIntervalDuration(c)}),A=A.concat(y)}m=A}var k=this._resourcesManager.getResourcesFromItem(n);c=this.appointmentTakesAllDay(n)&&this._workSpace.supportAllDayRow(),t.callback(this._getCoordinates(D,m,k,c))},isGroupedByDate:function(){return this.getWorkSpace().isGroupedByDate()},showAppointmentTooltip:function(t){t.skipDateCalculation=!0,t.$appointment=(0,i.default)(t.target);var e=t.data,n=this._getSingleAppointmentData(e,t);this.showAppointmentTooltip(e,t.target,n)},hideAppointmentTooltip:function(){this.hideAppointmentTooltip()},showAddAppointmentPopup:function(t){var e={};(0,d.each)(["startDate","endDate","allDay"],function(n,a){void 0!==t[a]&&(this.fire("setField",a,e,t[a]),delete t[a])}.bind(this)),this.showAppointmentPopup((0,D.extend)(e,t),!0)},showEditAppointmentPopup:function(t){var e=t.data;t.$appointment=(0,i.default)(t.target),t.skipHoursProcessing=!0;var n=this._getSingleAppointmentData(e,t),a=this.fire("getField","startDate",n);this.showAppointmentPopup(e,!1,n,a)},updateAppointmentAfterResize:function(t){var e=t.target,n=this._getSingleAppointmentData(e,t),a=this.fire("getField","startDate",n),i=(0,D.extend)(!0,{},t.data);this._convertDatesByTimezoneBack(!0,i),this._checkRecurringAppointment(e,n,a,function(){this._updateAppointment(e,i,function(){this._appointments.moveAppointmentBack()})}.bind(this))},updateAppointmentAfterDrag:function(t){var e=t.data,n=this._getUpdatedData(t),a=this._workSpace.getDroppableCellIndex(),i=this._workSpace.getCellIndexByCoordinates(t.coordinates),r=this.fire("getField","allDay",n),o=this.fire("getField","allDay",e),s=(0,D.extend)({},e,n),u=this._workSpace.supportAllDayRow()&&r,c=this._workSpace.getCellDataByCoordinates(t.coordinates,u),p=this._workSpace.supportAllDayRow()&&(o&&!r||!o&&r);a!==i||p?this._checkRecurringAppointment(e,s,c.startDate,function(){this._convertDatesByTimezoneBack(!0,n,s),this._updateAppointment(e,s,function(){this._appointments.moveAppointmentBack()})}.bind(this)):this._appointments.moveAppointmentBack()},deleteAppointment:function(t){t.$appointment=(0,i.default)(t.target);var e=t.data,n=this._getSingleAppointmentData(e,t),a=this.fire("getField","startDate",n);this._checkRecurringAppointment(e,n,a,function(){this.deleteAppointment(e)}.bind(this),!0)},getResourceForPainting:function(){return this._resourcesManager.getResourceForPainting(this._getCurrentViewOption("groups"))},getAppointmentColor:function(t){var e=this._resourcesManager,n=e.getResourceForPainting(this._getCurrentViewOption("groups")),a=(new S.Deferred).resolve().promise();if(n){for(var i=e.getField(n),r=t.groupIndex,s=this._workSpace._getCellGroups(r),u=o.default.wrapToArray(e.getDataAccessors(i,"getter")(t.itemData)),c=u.length?u[0]:void 0,p=0;p<s.length;p++)if(s[p].name===i){c=s[p].id;break}a=e.getResourceColor(i,c)}t.callback(a)},getHeaderHeight:function(){return this._header._$element&&parseInt(this._header._$element.outerHeight(),10)},getResourcesFromItem:function(t){t.callback(this._resourcesManager.getResourcesFromItem(t.itemData))},getBoundOffset:function(t){t.callback({top:-this.getWorkSpaceAllDayHeight()})},appointmentTakesAllDay:function(t){t.callback(this.appointmentTakesAllDay(t.appointment))},appointmentTakesSeveralDays:function(t){return this._appointmentModel.appointmentTakesSeveralDays(t)},appointmentFocused:function(){this._workSpace.restoreScrollTop()},getResizableAppointmentArea:function(t){var e=void 0,n=t.allDay,a=this._getCurrentViewOption("groups"),i;if(a&&a.length){if(n||this.getLayoutManager().getRenderingStrategyInstance()._needHorizontalGroupBounds()){var r=this._workSpace.getGroupBounds(t.coordinates);e={left:r.left,right:r.right,top:0,bottom:0}}if(this.getLayoutManager().getRenderingStrategyInstance()._needVerticalGroupBounds(n)&&this._workSpace._isVerticalGroupedWorkSpace()){var o=this._workSpace.getGroupBounds(t.coordinates);e={left:0,right:0,top:o.top,bottom:o.bottom}}}t.callback(e)},needRecalculateResizableArea:function(){return this.getWorkSpace().needRecalculateResizableArea()},getDraggableAppointmentArea:function(t){t.callback(this.getWorkSpaceScrollableContainer())},getAppointmentGeometry:function(t){return this.getLayoutManager().getRenderingStrategyInstance().getAppointmentGeometry(t)},isAllDay:function(t){return this.getLayoutManager().getRenderingStrategyInstance().isAllDay(t)},getDeltaTime:function(t,e,n){return this.getLayoutManager().getRenderingStrategyInstance().getDeltaTime(t,e,n)},getCompactAppointmentGroupMaxWidth:function(t){return this.getLayoutManager().getRenderingStrategyInstance().getCompactAppointmentGroupMaxWidth(this._getViewCountConfig().intervalCount,t)},getStartDate:function(t,e){return this._getStartDate(t,e)},getCellWidth:function(){return this._cellWidth},getCellHeight:function(){return this._cellHeight},getResizableStep:function(){var t=this._cellWidth,e=this.getWorkSpace();return e.isGroupedByDate()?e._getGroupCount()*t:t},getEndDate:function(t,e){return this._getEndDate(t,e)},getRenderingStrategy:function(){return this._getAppointmentsRenderingStrategy()},needCorrectAppointmentDates:function(){return this.getRenderingStrategyInstance().needCorrectAppointmentDates()},getRenderingStrategyDirection:function(){return this.getRenderingStrategyInstance().getDirection()},getWorkSpaceDateTableOffset:function(){return this.getWorkSpaceDateTableOffset()},getDateTableWidth:function(){return this._workSpace.getDateTableWidth()},getTimePanelWidth:function(){return this._workSpace.getTimePanelWidth()},correctAppointmentCoordinates:function(t){var e=t.allDay,n=t.isFixedContainer?-1:1,a,i,r,o,s,u=-this.getWorkSpaceScrollableScrollTop(e)+(e?0:this.getWorkSpaceAllDayOffset())+this.getWorkSpaceHeaderPanelHeight(),c=-this.getWorkSpaceScrollableScrollLeft()-this.getWorkSpaceDateTableOffset();t.callback({top:t.coordinates.top+n*u,left:t.coordinates.left+n*c})},allDayPanelToggled:function(){this._appointments.updateDraggablesBoundOffsets()},formatDates:function(t){var e=t.startDate,n=t.endDate,a=t.formatType,i={DATETIME:function(){var t="mediumdatemediumtime",a,i;return y.default.format(e,t)+" - "+(e.getDate()===n.getDate()?y.default.format(n,"shorttime"):y.default.format(n,t))},TIME:function(){return y.default.format(e,"shorttime")+" - "+y.default.format(n,"shorttime")},DATE:function(){var t="monthAndDay",a,i,r;return y.default.format(e,"monthAndDay")+(n.getTime()-e.getTime()>w("day")||n.getDate()!==e.getDate()?" - "+y.default.format(n,"monthAndDay"):"")}};t.callback(i[a]())},getFullWeekAppointmentWidth:function(t){var e=t.groupIndex,n=this._workSpace.getGroupWidth(e);t.callback(n)},getMaxAppointmentWidth:function(t){var e=this._workSpace.getCellCountToLastViewDate(t.date);t.callback(e*this._workSpace.getCellWidth())},updateAppointmentStartDate:function(t){var e=t.appointment,n=this._workSpace.getStartViewDate(),a=new Date(t.startDate),i=this._getCurrentViewOption("startDayHour"),r=void 0;this.appointmentTakesAllDay(e)?r=g.default.normalizeDate(a,n):(a<n&&(a=n),r=g.default.normalizeDate(t.startDate,new Date(a))),r=g.default.roundDateByStartDayHour(r,i),t.callback(r)},updateAppointmentEndDate:function(t){var e=new Date(t.endDate),n=this._getCurrentViewOption("endDayHour"),a=this._getCurrentViewOption("startDayHour"),i=e;e.getHours()>=n?i.setHours(n,0,0,0):a>0&&60*e.getHours()+e.getMinutes()<60*a&&(i=new Date(i.getTime()-w("day"))).setHours(n,0,0,0),t.callback(i)},renderDropDownAppointments:function(t){this._dropDownAppointments.render(t,this)},supportCompactDropDownAppointments:function(){return this._workSpace._supportCompactDropDownAppointments()},getGroupCount:function(){return this._workSpace._getGroupCount()},mapAppointmentFields:function(t){var e={appointmentData:t.itemData,appointmentElement:t.itemElement};return t.itemData&&(e.targetedAppointmentData=this.fire("getTargetedAppointmentData",t.itemData,t.itemElement,t.itemIndex)),e},getOffsetByAllDayPanel:function(t){return this._workSpace._getOffsetByAllDayPanel(t)},getGroupTop:function(t){return this._workSpace._getGroupTop(t)},updateResizableArea:function(){var t=this.$element().find(".dx-scheduler-appointment.dx-resizable"),e=(0,m.grep)(t,function(t){var e,n=(0,i.default)(t).dxResizable("instance"),a=n.option("area");return(0,r.inArray)(n.option("handles"),["right left","left right"])>-1&&p.default.isPlainObject(a)});(0,d.each)(e,function(t,e){var n=(0,i.default)(e),a=f.default.locate(n),r=this._appointments._getItemData(n),o=this._appointments._calculateResizableArea({left:a.left},r);n.dxResizable("instance").option("area",o)}.bind(this))},recurrenceEditorVisibilityChanged:function(t){this.recurrenceEditorVisibilityChanged(t)},getField:function(t,e){if(p.default.isDefined(this._dataAccessors.getter[t]))return this._dataAccessors.getter[t](e)},setField:function(t,e,n){if(p.default.isDefined(this._dataAccessors.setter[t])){var a=this.option(t+"Expr").split("."),i=a[0];if(void 0===e[i]&&a.length>1){var r=function(t){for(var e={},n=e,a=t.length-1,i=1;i<a;i++)n=n[t[i]]={};return e}(a);e[i]=r}return this._dataAccessors.setter[t](e,n),e}},prerenderFilter:function(){var t=this.getWorkSpace().getDateRange(),e=this._resourcesManager.getResourcesData(),n=void 0;return!this.option("showAllDayPanel")&&this._workSpace.supportAllDayRow()&&(n=!1),this._appointmentModel.filterLoadedAppointments({startDayHour:this._getCurrentViewOption("startDayHour"),endDayHour:this._getCurrentViewOption("endDayHour"),min:t[0],max:t[1],resources:e,allDay:n,firstDayOfWeek:this.option("firstDayOfWeek"),recurrenceException:this._getRecurrenceException.bind(this)},this._subscribes.convertDateByTimezone.bind(this))},dayHasAppointment:function(t,e,n){return this.dayHasAppointment(t,e,n)},createResourcesTree:function(){return this._resourcesManager.createResourcesTree(this._loadedResources)},getResourceTreeLeaves:function(t,e){return this._resourcesManager.getResourceTreeLeaves(t,e)},createReducedResourcesTree:function(){var t=this._resourcesManager.createResourcesTree(this._loadedResources);return this._resourcesManager.reduceResourcesTree(t,this.getFilteredItems())},groupAppointmentsByResources:function(t){var e={0:t},n=this._getCurrentViewOption("groups");n&&n.length&&this._resourcesManager.getResourcesData().length&&(e=this._resourcesManager.groupAppointmentsByResources(t,this._loadedResources));var a=0;(0,d.each)(this._loadedResources,function(t,e){t?a*=e.items.length:a=e.items.length});for(var i=0;i<a;i++){var r=i.toString();e[r]||(e[r]=[])}return e},getAgendaRows:function(t){var e=this._layoutManager.getRenderingStrategyInstance(),n=e.calculateRows.bind(e),a=new S.Deferred;function i(e){var r=n(e,t.agendaDuration,t.currentDate);this._dataSourceLoadedCallback.remove(i),a.resolve(r)}return this._dataSourceLoadedCallback.add(i),a.promise()},getAgendaVerticalStepHeight:function(){return this.getWorkSpace().getAgendaVerticalStepHeight()},getAgendaDuration:function(){return this._getCurrentViewOption("agendaDuration")},getStartViewDate:function(){return this.getStartViewDate()},getEndViewDate:function(){return this.getEndViewDate()},getMaxAppointmentsPerCell:function(){return this.getMaxAppointmentsPerCell()},forceMaxAppointmentPerCell:function(){return this.forceMaxAppointmentPerCell()},agendaIsReady:function(t,e,n){var a=this.getAppointmentsInstance()._itemElements(),i=0;a.css("marginBottom",e);for(var r=function(t,e){var r=e+i-1;a.eq(r).css("marginBottom",n),i+=e},o=0;o<t.length;o++)(0,d.each)(t[o],r)},getTimezone:function(){return this._getTimezoneOffsetByOption()},getClientTimezoneOffset:function(t){return t=t||new Date,T.default.getClientTimezoneOffset(t)},convertDateByTimezone:function(t,e){t=new Date(t);var n=this._subscribes.getComplexOffsets(this,t,e);return t=this._subscribes.translateDateToAppointmentTimeZone(t,n),t=this._subscribes.translateDateToCommonTimeZone(t,n)},convertDateByTimezoneBack:function(t,e){t=new Date(t);var n=this._subscribes.getComplexOffsets(this,t,e);return t=this._subscribes.translateDateToAppointmentTimeZone(t,n,!0),t=this._subscribes.translateDateToCommonTimeZone(t,n,!0)},translateDateToAppointmentTimeZone:function(t,e,n){var a=n?-1:1,i=t.getTime()-a*e.client*w("hour");return new Date(i+a*e.appointment*w("hour"))},translateDateToCommonTimeZone:function(t,e,n){var a=n?-1:1;if("number"==typeof e.common){var i=e.common-e.appointment,r=(i<0?-1:1)*Math.floor(Math.abs(i)),o=i%1;t.setHours(t.getHours()+a*r),t.setMinutes(t.getMinutes()+a*o*60)}return t},getComplexOffsets:function(t,e,n){var a=-this.getClientTimezoneOffset(e)/w("hour"),i=t._getTimezoneOffsetByOption(e),r=t._calculateTimezoneByValue(n,e);return"number"!=typeof r&&(r=a),{client:a,common:i,appointment:r}},getDaylightOffset:function(t,e){return t.getTimezoneOffset()-e.getTimezoneOffset()},getTimezonesDisplayName:function(){return T.default.getTimezonesDisplayName()},getTimezoneDisplayNameById:function(t){return T.default.getTimezoneDisplayNameById(t)},getSimilarTimezones:function(t){return T.default.getSimilarTimezones(t)},getTimezonesIdsByDisplayName:function(t){return T.default.getTimezonesIdsByDisplayName(t)},getTargetedAppointmentData:function(t,e,n,a){var r=(0,i.default)(e),o=this._getSingleAppointmentData(t,{skipDateCalculation:!0,$appointment:r,skipHoursProcessing:!0,startDate:a}),s={};return(0,D.extend)(!0,s,t,o),this._convertDatesByTimezoneBack(!1,s),p.default.isDefined(n)||(n=r.data(this._appointments._itemIndexKey())),e&&this.setTargetedAppointmentResources(s,e,n),s},getAppointmentDurationInMs:function(t){var e=t.startDate,n=t.endDate,a=t.allDay,i=n.getTime()-e.getTime(),r=w("day"),o=this._workSpace.getVisibleDayDuration(),s=0;if(a){var u;s=Math.ceil(i/r)*o}else{var c=!g.default.sameDate(e,new Date(n.getTime()-1)),p=Math.floor(i/r),l=void 0;if(c){var d=r-o;l=i-(p?p*r:d);var h=this.option("startDayHour")*w("hour"),f=n-g.default.trimTime(n);f<h&&(p&&(l-=d),l+=h-f)}else l=i%r;l>o&&(l=o),s=p*o+l}t.callback(s)},fixWrongEndDate:function(t,e,n){return this._appointmentModel.fixWrongEndDate(t,e,n)},getEndDayHour:function(){return this.option("endDayHour")},getStartDayHour:function(){return this.option("startDayHour")}};n.exports=b}

