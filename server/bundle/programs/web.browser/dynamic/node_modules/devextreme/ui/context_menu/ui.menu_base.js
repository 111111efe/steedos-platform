function(e,t,i){"use strict";var n=e("../../core/renderer"),s=e("../../core/utils/common"),a=e("../../core/utils/type"),l=e("../../core/utils/iterator").each,o=e("../../core/utils/extend").extend,r=e("../widget/utils.ink_ripple"),d=e("../hierarchical_collection/ui.hierarchical_collection_widget"),c=e("./ui.menu_base.edit.strategy"),u=e("../../core/devices"),m=e("../themes"),h="dx-menu",_="dx-menu-no-icons",p="dx-menu-base",g="dx-menu-item",f=g+"-content",I=g+"-selected",S=g+"-wrapper",y="dx-menu-items-container",v=g+"-expanded",C="dx-menu-separator",b="dx-menu-last-group-item",x=g+"-has-text",k=g+"-has-icon",A=g+"-has-submenu",B=g+"-popout",E="dx-menu-item-popout-container",w=g+"-text",D="single",O={show:50,hide:300},N=d.inherit({_getDefaultOptions:function(){return o(this.callBase(),{items:[],cssClass:"",activeStateEnabled:!0,showSubmenuMode:{name:"onHover",delay:{show:50,hide:300}},animation:{show:{type:"fade",from:0,to:1,duration:100},hide:{type:"fade",from:1,to:0,duration:100}},selectByClick:!1,focusOnSelectedItem:!1,keyExpr:null,_itemAttributes:{role:"menuitem"},useInkRipple:!1})},_defaultOptionsRules:function(){return this.callBase().concat([{device:function(){return m.isAndroid5()},options:{useInkRipple:!0}}])},_activeStateUnit:"."+g,_itemDataKey:function(){return"dxMenuItemDataKey"},_itemClass:function(){return g},_setAriaSelected:s.noop,_selectedItemClass:function(){return"dx-menu-item-selected"},_widgetClass:function(){return"dx-menu-base"},_focusTarget:function(){return this._itemContainer()},_clean:function(){this.option("focusedElement",null),this.callBase()},_supportedKeys:function(){var e=function(){var e=n(this.option("focusedElement"));e.length&&this._isSelectionEnabled()&&this.selectItem(e[0])};return o(this.callBase(),{space:e,pageUp:s.noop,pageDown:s.noop})},_isSelectionEnabled:function(){return"single"===this.option("selectionMode")},_init:function(){this.callBase(),this._renderSelectedItem(),this._initActions()},_getTextContainer:function(e){var t=e.text,i=n("<span>").addClass("dx-menu-item-text"),s=a.isPlainObject(e)?t:String(e);return t&&i.text(s)},_getPopoutContainer:function(e){var t,i=e.items;if(i&&i.length){var s=n("<div>").addClass("dx-menu-item-popout");t=n("<span>").addClass("dx-menu-item-popout-container").append(s)}return t},_getDataAdapterOptions:function(){return{rootValue:0,multipleSelection:!1,recursiveSelection:!1,recursiveExpansion:!1,searchValue:""}},_selectByItem:function(e){if(e){var t=this._dataAdapter.getNodeByItem(e);this._dataAdapter.toggleSelection(t.internalFields.key,!0)}},_renderSelectedItem:function(){var e=this._dataAdapter.getSelectedNodesKeys(),t=e.length&&e[0],i=this.option("selectedItem");if(t){var n=this._dataAdapter.getNodeByKey(t);!1!==n.selectable&&(i?i!==n.internalFields.item&&(this._dataAdapter.toggleSelection(t,!1),this._selectByItem(i)):this.option("selectedItem",n.internalFields.item))}else this._selectByItem(i)},_initActions:s.noop,_initMarkup:function(){this.callBase(),this._addCustomCssClass(this.$element()),this.option("useInkRipple")&&this._renderInkRipple()},_renderInkRipple:function(){this._inkRipple=r.render()},_toggleActiveState:function(e,t,i){if(this.callBase.apply(this,arguments),this._inkRipple){var n={element:e,event:i};t?this._inkRipple.showWave(n):this._inkRipple.hideWave(n)}},_getShowSubmenuMode:function(){var e="onClick",t=this.option("showSubmenuMode");return t=a.isObject(t)?t.name:t,this._isDesktopDevice()?t:"onClick"},_initSelectedItems:s.noop,_isDesktopDevice:function(){return"desktop"===u.real().deviceType},_initEditStrategy:function(){var e=c;this._editStrategy=new e(this)},_addCustomCssClass:function(e){e.addClass(this.option("cssClass"))},_itemWrapperSelector:function(){return".dx-menu-item-wrapper"},_hoverStartHandler:function(e){var t=this,i=this._getItemElementByEventArgs(e);i&&!this._isItemDisabled(i)&&(e.stopPropagation(),"onHover"===this._getShowSubmenuMode()&&(clearTimeout(this._showSubmenusTimeout),this._showSubmenusTimeout=setTimeout(this._showSubmenu.bind(this,i),this._getSubmenuDelay("show"))))},_getAvailableItems:function(e){return this.callBase(e).filter(function(){return"hidden"!==n(this).css("visibility")})},_isItemDisabled:function(e){return this._disabledGetter(e.data(this._itemDataKey()))},_showSubmenu:function(e){this._addExpandedClass(e)},_addExpandedClass:function(e){n(e).addClass("dx-menu-item-expanded")},_getSubmenuDelay:function(e){var t=this.option("showSubmenuMode").delay;return a.isDefined(t)?a.isObject(t)?t[e]:t:O[e]},_getItemElementByEventArgs:function(e){var t=n(e.target);if(t.hasClass(this._itemClass())||t.get(0)===e.currentTarget)return t;for(;!t.hasClass(this._itemClass());)if((t=t.parent()).hasClass("dx-submenu"))return null;return t},_hoverEndHandler:function(){clearTimeout(this._showSubmenusTimeout)},_hasSubmenu:function(e){return e.internalFields.childrenKeys.length},_renderContentImpl:function(){this._renderItems(this._dataAdapter.getRootNodes())},_renderItems:function(e,t){var i,n=this;if(e.length){this.hasIcons=!1,i=this._renderContainer(this.$element(),t);var s=-1,a=-1;l(e,function(e,t){var l=!1!==t.visible,o;l&&s<0&&(s=e),s<e&&(t.beginGroup||e===a)&&(a=l?e:e+1),e===a&&s<e&&n._renderSeparator(i),n._renderItem(e,t,i)}),this.hasIcons||i.addClass("dx-menu-no-icons")}},_renderContainer:function(e){return n("<ul>").appendTo(e).addClass("dx-menu-items-container")},_createDOMElement:function(e){var t;return n("<li>").appendTo(e).addClass("dx-menu-item-wrapper")},_renderItem:function(e,t,i,n){var s,a=this.option("items");if(!1!==t.internalFields.item.visible){var l=n||this._createDOMElement(i);a[e+1]&&a[e+1].beginGroup&&l.addClass("dx-menu-last-group-item"),s=this.callBase(e,t.internalFields.item,l),t.internalFields.item===this.option("selectedItem")&&s.addClass("dx-menu-item-selected"),s.attr("tabIndex",-1),this._hasSubmenu(t)&&this.setAria("haspopup","true",s)}},_renderItemFrame:function(e,t,i){var n=i.children("."+g);return n.length?n:this.callBase.apply(this,arguments)},_refreshItem:function(e,t){var i=this._dataAdapter.getNodeByItem(t),n=e.data(this._itemIndexKey()),s=e.closest("ul"),a=e.closest("li");this._renderItem(n,i,s,a)},_addContentClasses:function(e,t){var i=!!e.text&&!!e.text.length,n=!!e.icon,s=!!e.items&&!!e.items.length;t.toggleClass(x,i),t.toggleClass(k,n),this.hasIcons||(this.hasIcons=n),t.toggleClass(A,s)},_getItemContent:function(e){var t=this.callBase(e);return t.length||(t=e.children(".dx-menu-item-content")),t},_postprocessRenderItem:function(e){var t,i=n(e.itemElement),s=this._dataAdapter.getSelectedNodesKeys();s.length&&this._selectedGetter(e.itemData)&&this._isItemSelectable(e.itemData)&&(t=this._dataAdapter.getNodeByItem(e.itemData)).internalFields.key===s[0]?(i.addClass(this._selectedItemClass()),this._setAriaSelected(i,"true")):this._setAriaSelected(i,"false")},_isItemSelectable:function(e){return!1!==e.selectable},_renderSeparator:function(e){n("<li>").appendTo(e).addClass("dx-menu-separator")},_itemClickHandler:function(e){if(!e._skipHandling){var t=this._createAction(this._updateSubmenuVisibilityOnClick.bind(this));this._itemDXEventHandler(e,"onItemClick",{},{afterExecute:t.bind(this)}),e._skipHandling=!0}},_updateSubmenuVisibilityOnClick:function(e){this._updateSelectedItemOnClick(e),"onClick"===this._getShowSubmenuMode()&&this._addExpandedClass(e.args[0].itemElement)},_updateSelectedItemOnClick:function(e){var t,i=e.args?e.args[0]:e;if(this._isItemSelectionAllowed(i.itemData)){var n=(t=this._dataAdapter.getSelectedNodesKeys()).length&&this._dataAdapter.getNodeByKey(t[0]);n&&this._toggleItemSelection(n,!1),n&&n.internalFields.item===i.itemData?(this._fireSelectionChangeEvent(null,this.option("selectedItem")),this._setOptionSilent("selectedItem",null)):this.selectItem(i.itemData)}},_isItemSelectionAllowed:function(e){var t=this._isSelectionEnabled()&&this.option("selectByClick");return!this._isContainerEmpty()&&t&&this._isItemSelectable(e)&&!this._itemsGetter(e)},_isContainerEmpty:function(){return this._itemContainer().is(":empty")},_syncSelectionOptions:s.asyncNoop,_optionChanged:function(e){switch(e.name){case"showSubmenuMode":break;case"selectedItem":var t=e.value,i=this._dataAdapter.getNodeByItem(t),n=this._dataAdapter.getSelectedNodesKeys()[0];if(i&&i.internalFields.key!==n){if(!1===i.selectable)break;n&&this._toggleItemSelection(this._dataAdapter.getNodeByKey(n),!1),this._toggleItemSelection(i,!0),this._updateSelectedItems()}break;case"cssClass":case"position":case"selectByClick":case"animation":case"useInkRipple":this._invalidate();break;default:this.callBase(e)}},_toggleItemSelection:function(e,t){var i=this._getElementByItem(e.internalFields.item);i&&n(i).toggleClass("dx-menu-item-selected"),this._dataAdapter.toggleSelection(e.internalFields.key,t)},_getElementByItem:function(e){var t,i=this;return l(this._itemElements(),function(s,a){return n(a).data(i._itemDataKey())!==e||(t=a,!1)}),t},_updateSelectedItems:function(e,t){(e||t)&&(this._updateSelection(t,e),this._fireSelectionChangeEvent(t,e))},_fireSelectionChangeEvent:function(e,t){this._createActionByOption("onSelectionChanged",{excludeValidators:["disabled","readOnly"]})({addedItems:[e],removedItems:[t]})},selectItem:function(e){var t=e.nodeType?this._getItemData(e):e,i=this._dataAdapter.getNodeByItem(t),n=this._dataAdapter.getSelectedNodesKeys()[0],s=this.option("selectedItem");i.internalFields.key!==n&&(n&&this._toggleItemSelection(this._dataAdapter.getNodeByKey(n),!1),this._toggleItemSelection(i,!0),this._updateSelectedItems(s,t),this._setOptionSilent("selectedItem",t))},unselectItem:function(e){var t=e.nodeType?this._getItemData(e):e,i=this._dataAdapter.getNodeByItem(t),n=this.option("selectedItem");i.internalFields.selected&&(this._toggleItemSelection(i,!1),this._updateSelectedItems(n,null),this._setOptionSilent("selectedItem",null))}});i.exports=N}

