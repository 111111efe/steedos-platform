function(t,e,n){"use strict";var i=t("../../core/renderer"),s=t("../../core/dom_adapter"),o=t("../../events/core/events_engine"),a=t("../../core/guid"),r=t("../../core/component_registrator"),u=t("../../core/utils/common").noop,h=t("../../core/utils/type"),l=t("../../core/utils/dom"),d=l.contains,c=l.getPublicElement,m=t("../../core/utils/iterator").each,_=t("../../core/utils/array").inArray,v=t("../../core/utils/extend").extend,f=t("../../core/utils/window"),p=t("../../animation/fx"),b=t("../../animation/position"),g=t("../../core/devices"),x=t("../../events/utils"),S=t("../overlay"),y=t("./ui.menu_base"),w=t("../../core/utils/deferred").Deferred,C="dx-menu",I="dx-menu-item",A="dx-menu-item-expanded",E="dx-menu-phone-overlay",O="dx-menu-items-container",H="dx-menu-item-wrapper",k="dx-submenu",B="dx-context-menu",M="dx-has-context-menu",D="dx-state-disabled",L="up",T="down",P="left",$="right",V="first",N="last",R=["onShowing","onShown","onSubmenuCreated","onHiding","onHidden","onPositioning","onLeftFirstItem","onLeftLastItem","onCloseRootSubmenu","onExpandLastSubmenu"],F=["up","down","first","last"],j="dxcontextmenu",J=y.inherit((Q=function(t){var e=null,n=t.option("showEvent");return h.isObject(n)?null!==n.name&&(e=n.name||"dxcontextmenu"):e=n,e},W=function(t){var e=t.option("showEvent");return h.isObject(e)&&e.delay},{_getDefaultOptions:function(){return v(this.callBase(),{showEvent:"dxcontextmenu",closeOnOutsideClick:!0,position:{at:"top left",my:"top left"},onShowing:null,onShown:null,onSubmenuCreated:null,onHiding:null,onHidden:null,onPositioning:null,submenuDirection:"auto",visible:!1,target:void 0,onLeftFirstItem:null,onLeftLastItem:null,onCloseRootSubmenu:null,onExpandLastSubmenu:null})},_defaultOptionsRules:function(){return this.callBase().concat([{device:function(){return!f.hasWindow()},options:{animation:null}}])},_initActions:function(){this._actions={},m(R,function(t,e){this._actions[e]=this._createActionByOption(e)||u}.bind(this))},_setOptionsByReference:function(){this.callBase(),v(this._optionsByReference,{animation:!0,selectedItem:!0})},_focusInHandler:u,_itemContainer:function(){return this._overlay?this._overlay.$content():i()},_eventBindingTarget:function(){return this._itemContainer()},itemsContainer:function(){return this._overlay?this._overlay.$content():void 0},_supportedKeys:function(){var t=function(){var t=i(this.option("focusedElement"));this.hide(),t.length&&this._isSelectionEnabled()&&this.selectItem(t[0])};return v(this.callBase(),{space:t,esc:this.hide})},_getActiveItem:function(){var t=this._getAvailableItems(),e=t.filter(".dx-state-focused"),n=t.filter(".dx-state-hover"),i;return n.closest(".dx-menu-items-container").find(".dx-menu-item").index(e)>=0?e:n.length?n:this.callBase()},_moveFocus:function(t){var e,n=this._getItemsByLocation(t),s=this._getActiveItem(!0),o=this.itemsContainer().find(".dx-state-hover"),a,r=!(!i(this.option("focusedElement")).length&&!o.length);switch(t){case"up":e=r?this._prevItem(n):s,s.is(n.first())&&this._actions.onLeftFirstItem(s);break;case"down":e=r?this._nextItem(n):s,s.is(n.last())&&this._actions.onLeftLastItem(s);break;case"right":e=this.option("rtlEnabled")?this._hideSubmenuHandler():this._expandSubmenuHandler(n,t);break;case"left":e=this.option("rtlEnabled")?this._expandSubmenuHandler(n,t):this._hideSubmenuHandler();break;case"first":e=n.first();break;case"last":e=n.last();break;default:return this.callBase(t)}0!==e.length&&this.option("focusedElement",c(e))},_getItemsByLocation:function(t){var e,n=this._getActiveItem(!0);return _(t,F)>=0&&(e=n.closest(".dx-menu-items-container").children().children()),e=this._getAvailableItems(e)},_getAriaTarget:function(){return this.$element()},_refreshActiveDescendant:function(){if(this._overlay){var t=this.getFocusedItemId();this.setAria("activedescendant","",this._overlay.$content()),this.setAria("activedescendant",t,this._overlay.$content())}},_hideSubmenuHandler:function(){var t=this._getActiveItem(!0),e=t.parents(".dx-menu-item-expanded").first();return e.length?(this._hideSubmenusOnSameLevel(e),this._hideSubmenu(t.closest(".dx-submenu")),e):(this._actions.onCloseRootSubmenu(t),t)},_expandSubmenuHandler:function(t,e){var n=this._getActiveItem(!0),i=this._getItemData(n),s=this._dataAdapter.getNodeByItem(i),o=this._hasSubmenu(s),a=n.children(".dx-submenu");return o&&!n.hasClass("dx-state-disabled")?(a.length&&"hidden"!==a.css("visibility")||this._showSubmenu(n),this._nextItem(this._getItemsByLocation(e))):(this._actions.onExpandLastSubmenu(n),n)},_clean:function(){this._overlay&&(this._overlay.$element().remove(),this._overlay=null),this._detachShowContextMenuEvents(this._getTarget()),this.callBase()},_initMarkup:function(){this.$element().addClass("dx-has-context-menu"),this.callBase()},_render:function(){this.callBase(),this._renderVisibility(this.option("visible")),this._addWidgetClass()},_renderContentImpl:function(){this._detachShowContextMenuEvents(this._getTarget()),this._attachShowContextMenuEvents()},_attachKeyboardEvents:function(){!this._keyboardProcessor&&this._focusTarget().length&&this.callBase()},_renderContextMenuOverlay:function(){if(!this._overlay){var t,e=this._getOverlayOptions(),n=i("<div>");this._overlay=this._createComponent(n.appendTo(this._$element),S,e),(t=this._overlay.$content()).addClass("dx-context-menu"),this._addCustomCssClass(t),this._addPlatformDependentClass(t),this._attachContextMenuEvent()}},_itemContextMenuHandler:function(t){this.callBase(t),t.stopPropagation()},_addPlatformDependentClass:function(t){g.current().phone&&t.addClass(E)},_detachShowContextMenuEvents:function(t){var e,n=Q(this);n&&(e=x.addNamespace(n,this.NAME),this._showContextMenuEventHandler?o.off(s.getDocument(),e,t,this._showContextMenuEventHandler):o.off(i(t),e))},_attachShowContextMenuEvents:function(){var t,e,n,a,r=this,u=r._getTarget(),l=Q(r);l&&(n=x.addNamespace(l,r.NAME),a=r._createAction(function(e){(t=W(r))?setTimeout(function(){r._show(e.event)},t):r._show(e.event)}.bind(r),{validatingTargetName:"target"}),e=function(t){a({event:t,target:i(t.currentTarget)})},a=r._createAction(a),h.isRenderer(u)||u.nodeType||h.isWindow(u)?(r._showContextMenuEventHandler=void 0,o.on(u,n,e)):(r._showContextMenuEventHandler=e,o.on(s.getDocument(),n,u,r._showContextMenuEventHandler)))},_hoverEndHandler:function(t){this.callBase(t),t.stopPropagation()},_renderDimensions:u,_renderContainer:function(t,e){var n,s=e||this._itemContainer();return(t=i("<div>")).appendTo(s).addClass("dx-submenu").css("visibility",e?"hidden":"visible"),n=this.callBase(t),e?n:this.option("width")?n.css("minWidth",this.option("width")):this.option("height")?n.css("minHeight",this.option("height")):n},_renderSubmenuItems:function(t,e){this._renderItems(this._getChildNodes(t),e),this._actions.onSubmenuCreated({itemElement:c(e),itemData:t.internalFields.item,submenuElement:c(e.children(".dx-submenu"))})},_getOverlayOptions:function(){var t=this.option("position"),e=this.option("animation"),n;return{focusStateEnabled:this.option("focusStateEnabled"),animation:e,innerOverlay:!0,closeOnOutsideClick:this._closeOnOutsideClickHandler.bind(this),propagateOutsideClick:!0,closeOnTargetScroll:!0,deferRendering:!1,position:{at:t.at,my:t.my,of:this._getTarget(),collision:"flipfit"},shading:!1,showTitle:!1,height:"auto",width:"auto",onShown:this._overlayShownActionHandler.bind(this),onHiding:this._overlayHidingActionHandler.bind(this),onHidden:this._overlayHiddenActionHandler.bind(this)}},_overlayShownActionHandler:function(t){this._actions.onShown(t)},_overlayHidingActionHandler:function(t){this._actions.onHiding(t),t.cancel||(this._hideAllShownSubmenus(),this._setOptionSilent("visible",!1))},_overlayHiddenActionHandler:function(t){this._actions.onHidden(t)},_closeOnOutsideClickHandler:function(t){var e,n,i,o,a,r,u=this.option("closeOnOutsideClick");return h.isFunction(u)?u(t):!(!u||!s.isDocument(t.target)&&(n=this._getActiveItemsContainer(t.target),i=this._getItemsContainers(),e=this._searchActiveItem(t.target),o=this.$element().parents(".dx-menu-item"),a=e[0]===o[0]&&e.length&&o.length,((r=this._isIncludeOverlay(n,i)&&e.length)||a)&&("onClick"===this._getShowSubmenuMode()&&this._hideAllShownChildSubmenus(e),1)))},_getActiveItemsContainer:function(t){return i(t).closest(".dx-menu-items-container")},_getItemsContainers:function(){return this._overlay._$content.find(".dx-menu-items-container")},_searchActiveItem:function(t){return i(t).closest(".dx-menu-item").eq(0)},_isIncludeOverlay:function(t,e){var n=!1;return m(e,function(e,i){t.is(i)&&!n&&(n=!0)}),n},_hideAllShownChildSubmenus:function(t){var e,n=this,i=t.find(".dx-submenu"),s=v([],this._shownSubmenus);i.length>0&&m(s,function(i,s){(e=n._searchActiveItem(s.context).parent()).parent().is(t.parent().parent())&&!e.is(t.parent())&&n._hideSubmenu(s)})},_showSubmenu:function(t){var e=this._dataAdapter.getNodeByItem(this._getItemData(t));if(this._hideSubmenusOnSameLevel(t),this._hasSubmenu(e)){var n=t.children(".dx-submenu"),i=n.length;this.callBase(t),i||this._renderSubmenuItems(e,t),this._isSubmenuVisible(n)||this._drawSubmenu(t)}},_hideSubmenusOnSameLevel:function(t){var e=t.parent(".dx-menu-item-wrapper").siblings().find(".dx-menu-item-expanded");e.length&&(e.removeClass("dx-menu-item-expanded"),this._hideSubmenu(e.find(".dx-submenu")))},_hideSubmenuGroup:function(t){this._isSubmenuVisible(t)&&this._hideSubmenuCore(t)},_isSubmenuVisible:function(t){return"visible"===t.css("visibility")},_drawSubmenu:function(t){var e=this.option("animation")?this.option("animation").show:{},n=t.children(".dx-submenu"),i=this._getSubmenuPosition(t);this._overlay&&this._overlay.option("visible")&&(h.isDefined(this._shownSubmenus)||(this._shownSubmenus=[]),_(n,this._shownSubmenus)&&this._shownSubmenus.push(n),e&&p.stop(n),b.setup(n,i),e&&(h.isPlainObject(e.to)&&(e.to.position=i),this._animate(n,e)),n.css("visibility","visible"))},_animate:function(t,e){p.animate(t,e)},_getSubmenuPosition:function(t){var e=this.option("submenuDirection").toLowerCase(),n,i={collision:"flip",of:t.parent(".dx-menu-item-wrapper"),offset:{h:0,v:-1}};switch(e){case"left":i.at="left top",i.my="right top";break;case"right":i.at="right top",i.my="left top";break;default:this.option("rtlEnabled")?(i.at="left top",i.my="right top"):(i.at="right top",i.my="left top")}return i},_updateSubmenuVisibilityOnClick:function(t){if(t.args.length){var e=i(t.args[0].itemElement),n=t.args[0].itemData,s=this._dataAdapter.getNodeByItem(n);if(s){var o=e.find(".dx-submenu"),a;if(this._hasSubmenu(s)&&!o.length&&(this._renderSubmenuItems(s,e),o=e.find(".dx-submenu")),e.context!==o.context||"visible"!==o.css("visibility")){var r=n&&!1===n.closeMenuOnClick;if(n&&!n.disabled&&!r)if(this._updateSelectedItemOnClick(t),0===o.length){var u=i(e.parents(".dx-submenu")[0]);this._hideSubmenu(u),!t.canceled&&this._overlay&&this._overlay.option("visible")&&this.option("visible",!1)}else this._shownSubmenus&&this._shownSubmenus.length>0&&this._shownSubmenus[0].is(o)&&this._hideSubmenu(o),this._showSubmenu(e)}}}},_hideSubmenu:function(t){var e=this,n=v([],e._shownSubmenus);m(n,function(n,i){(t.is(i)||d(t[0],i[0]))&&(i.parent().removeClass("dx-menu-item-expanded"),e._hideSubmenuCore(i))})},_hideSubmenuCore:function(t){var e=_(t,this._shownSubmenus),n=this.option("animation")?this.option("animation").hide:null;e>=0&&this._shownSubmenus.splice(e,1),this._stopAnimate(t),n&&this._animate(t,n),t.css("visibility","hidden")},_stopAnimate:function(t){p.stop(t,!0)},_hideAllShownSubmenus:function(){var t=this,e=v([],t._shownSubmenus),n;this._overlay.$content().find(".dx-menu-item-expanded").removeClass("dx-menu-item-expanded"),m(e,function(e,n){t._hideSubmenu(n)})},_visibilityChanged:function(t){t&&this._renderContentImpl()},_optionChanged:function(t){if(_(t.name,R)>-1)this._initActions();else switch(t.name){case"visible":this._renderVisibility(t.value);break;case"showEvent":case"position":case"submenuDirection":this._invalidate();break;case"target":t.previousValue&&this._detachShowContextMenuEvents(t.previousValue),this._invalidate();break;case"closeOnOutsideClick":break;default:this.callBase(t)}},_renderVisibility:function(t){return this._cachedJQEvent=void 0,t?this._show():this._hide()},_toggleVisibility:u,_show:function(t){h.isDefined(t)?this._cachedJQEvent=t:t=this._cachedJQEvent;var e={jQEvent:t},n=(new w).reject().promise();if(this._actions.onShowing(e),e.cancel)return n;var i=this._positionContextMenu(t);if(i){this._overlay||(this._renderContextMenuOverlay(),this._overlay.$content().addClass(this._widgetClass()),this._renderFocusState(),this._attachHoverEvents(),this._attachClickEvent(),this._renderItems(this._dataAdapter.getRootNodes())),this._setOptionSilent("visible",!0),this._overlay.option("position",i),n=this._overlay.show(),t&&t.stopPropagation();var s="dx-"+new a;this._overlay.$content().attr({id:s,role:"menu"}),this.setAria("owns",s)}return n},_getTarget:function(){return this.option("target")||this.option("position").of||i(s.getDocument())},_getContextMenuPosition:function(){return v({},this.option("position"),{of:this._getTarget()})},_positionContextMenu:function(t){var e,n=this._getContextMenuPosition(),i=this._isInitialOptionValue("position"),s=this._createActionByOption("onPositioning",e);return t&&t.preventDefault&&i&&(n.of=t),s(e={position:n,event:t}),e.cancel?n=null:e.event&&(e.event.cancel=!0,t.preventDefault()),n},_hide:function(){var t;return this._overlay&&(this._overlay.$content().removeAttr("id"),t=this._overlay.hide(),this._setOptionSilent("visible",!1)),this.setAria("owns",void 0),this._cachedJQEvent=void 0,t||(new w).reject().promise()},toggle:function(t){var e=this.option("visible");return t=void 0===t?!e:t,this._renderVisibility(t)},show:function(){return this.toggle(!0)},hide:function(){return this.toggle(!1)}})),Q,W;r("dxContextMenu",J),n.exports=J}

