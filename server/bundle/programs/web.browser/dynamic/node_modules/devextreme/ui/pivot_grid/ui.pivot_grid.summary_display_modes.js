function(n,e){"use strict";var t=n("../../core/utils/type"),i=n("../../core/utils/extend").extend,r=n("../../core/utils/array").inArray,a=t.isDefined,l=n("./ui.pivot_grid.utils"),u=l.findField,o=l.foreachTree,s="column",c="row",h=null,d=function(n,e){var t=n/e;return a(n)&&!isNaN(t)||(t=h),t},f=function(n,e){return d(n.value(),n.grandTotal(e).value())},v=function(n,e){var t=n.parent(e),i=t?t.value():n.value();return d(n.value(),i)},p=function(n){return function(e){var t=e.prev(s,n),i=t&&t.value();return a(i)&&a(e.value())?e.value()-i:h}},_=function(n){var e=p(n);return function(t){var i=e(t),r=t.prev(s,n),a=r&&r.value();return i!==h&&a?i/a:h}},g={percentOfColumnTotal:function(n){return v(n,c)},percentOfRowTotal:function(n){return v(n,s)},percentOfColumnGrandTotal:function(n){return f(n,c)},percentOfRowGrandTotal:function(n){return f(n,s)},percentOfGrandTotal:function(n){return f(n)}},m=function n(e,t){if(e&&e.parent(t)){var i=e.prev(t);return i||(i=n(e.parent(t),t)),i}},x=function(n){if(n.runningTotal){var e=n.runningTotal===s?c:s;return function(t){var i=n.allowCrossGroupCalculation?m(t,e):t.prev(e,!1),r=t.value(!0),l=i&&i.value(!0);return a(l)&&a(r)?r=l+r:a(l)&&(r=l),r}}};function y(){return{fields:{},positions:{}}}function w(n,e,i){var a,l,o={index:-1};if(t.isObject(e)||(i.fields[e]?e=i[e]:(l=n.columns.concat(n.rows).concat(n.values),a=u(l,e),e=i[e]=l[a])),e){var s=e.area||"data";o=i.positions[e.index]=i.positions[e.index]||{area:s,index:r(e,n["data"===s?"values":s+"s"])}}return o}function C(n){return n===c?"_rowPath":"_columnPath"}var P=function(n,e,t,i,r,a){this._columnPath=n,this._rowPath=e,this._fieldIndex=r,this._fieldsCache=a||{fields:{},positions:{}},this._data=t,this._descriptions=i;var l=t.values&&t.values[e[0].index]&&t.values[e[0].index][n[0].index];l&&(l.originalCell=l.originalCell||l.slice(),this._cell=l)};function T(n){var e=n.summaryDisplayMode,i=n.allowCrossGroupCalculation,r=h;return t.isFunction(n.calculateSummaryValue)?r=n.calculateSummaryValue:e&&(r="absoluteVariation"===e?p(i):"percentVariation"===e?_(i):g[e])&&!n.format&&-1!==e.indexOf("percent")&&l.setFieldProperty(n,"format","percent"),r}function E(n,e,t,i){var r=n.values[e][t]=n.values[e][t]||[],a=r.originalCell;a&&(!r.allowResetting&&i||(n.values[e][t]=a.slice()),n.values[e][t].allowResetting=i)}P.prototype=i(P.prototype,{_getPath:function(n){return this[C(n)]},_getDimension:function(n){return n=n===c?"rows":"columns",this._descriptions[n]},_createCell:function(n){var e=this;return new P(n._columnPath||this._columnPath,n._rowPath||this._rowPath,this._data,this._descriptions,this._fieldIndex)},parent:function(n){var e=this._getPath(n).slice(),t={};return e.shift(),e.length?(t[C(n)]=e,this._createCell(t)):h},children:function(n){var e=this._getPath(n).slice(),t=e[0],i=[],r={};if(t.children)for(var a=0;a<t.children.length;a++)r[C(n)]=[t.children[a]].concat(e.slice()),i.push(this._createCell(r));return i},grandTotal:function(n){var e={},t=this._rowPath,i=this._columnPath,r=this._getPath(n),a=C(n);return n?e[a]=[r[r.length-1]]:(e._rowPath=[t[t.length-1]],e._columnPath=[i[i.length-1]]),this._createCell(e)},next:function(n,e){var t,i,a=this._getPath(n),l=a[0],u=this.parent(n);if(u&&(i=r(l,a[1].children),(t=u.children(n))[i+1]))return t[i+1];if(e&&u){do{t=(u=u.next(n,e))?u.children(n):[]}while(u&&!t.length);return t[0]||h}return h},prev:function(n,e){var t,i,a=this._getPath(n),l=a[0],u=this.parent(n);if(u&&(i=r(l,a[1].children),(t=u.children(n))[i-1]))return t[i-1];if(e&&u){do{t=(u=u.prev(n,e))?u.children(n):[]}while(u&&!t.length);return t[t.length-1]||h}return h},cell:function(){return this._cell},field:function n(e){if("data"===e)return this._descriptions.values[this._fieldIndex];var t=this._getPath(e),i,n=this._getDimension(e)[t.length-2];return n||h},child:function(n,e){for(var t,i=this.children(n),r=0;r<i.length;r++)if(t=t||i[r].field(n),i[r].value(t)===e)return i[r];return h},slice:function(n,e){var t,i,r,a,l=this,u={},o=w(this._descriptions,n,this._fieldsCache),d=o.area,f=o.index,v=h,p=[];if((d===c||d===s)&&(i=this._getPath(d).slice())[a=-1!==f&&i.length-2-f]){p[i.length-1]=i[i.length-1];for(var _=a;_>=0;_--){if(i[_+1]){t=i[_+1].children||[],r=_===a?e:i[_].value,i[_]=void 0;for(var g=0;g<t.length;g++)if(t[g].value===r){i[_]=t[g];break}}if(void 0===i[_])return v}u[C(d)]=i,v=this._createCell(u)}return v},value:function(n,e){var t,i,r=this._cell,l=this._fieldIndex,u=!0===n||!1===n,o=u?h:n,s=u&&n||e;if(a(o)){var c=w(this._descriptions,o,this._fieldsCache);if(l=c.index,"data"!==c.area)return(t=this._getPath(c.area))[i=-1!==l&&t.length-2-l]&&t[i].value}return r&&r.originalCell?s?r[l]:r.originalCell[l]:h}}),e.applyDisplaySummaryMode=function(n,e){var t=[],i=[{index:e.grandTotalColumnIndex,children:e.columns}],r=[{index:e.grandTotalRowIndex,children:e.rows}],a=n.values,l={fields:{},positions:{}};e.values=e.values||[],o(r,function(r){var u=r[0];u.isEmpty=[],e.values[u.index]=e.values[u.index]||[],o(i,function(i){var o,s,c,h,d,f,v=i[0];v.isEmpty=v.isEmpty||[],E(e,u.index,v.index,!1);for(var p=0;p<a.length;p++)h=a[p],d=!1,(o=t[p]=void 0===t[p]?T(h):t[p])&&(d=null==(f=(c=(s=new P(i,r,e,n,p,l)).cell())[p]=o(s))),void 0===v.isEmpty[p]&&(v.isEmpty[p]=!0),void 0===u.isEmpty[p]&&(u.isEmpty[p]=!0),d||(u.isEmpty[p]=v.isEmpty[p]=!1)},!1)},!1),e.isEmptyGrandTotalRow=r[0].isEmpty,e.isEmptyGrandTotalColumn=i[0].isEmpty},e.applyRunningTotal=function(n,e){var t=[],i=[{index:e.grandTotalColumnIndex,children:e.columns}],r=[{index:e.grandTotalRowIndex,children:e.rows}],a=n.values,l={fields:{},positions:{}};e.values=e.values||[],o(r,function(r){var u=r[0];e.values[u.index]=e.values[u.index]||[],o(i,function(i){var o,s,c,h,d=i[0];E(e,u.index,d.index,!0);for(var f=0;f<a.length;f++)h=a[f],(o=t[f]=void 0===t[f]?x(h):t[f])&&((c=(s=new P(i,r,e,n,f,l)).cell())[f]=o(s))},!1)},!1)},e.createMockSummaryCell=function(n,e,t){var i=new P([],[],{},n,0);return i.value=function(i){if(a(i)){var r=u(e,i),l=e[r];t[r]||!l||a(l.area)||(n.values.push(l),t[r]=!0)}},i.grandTotal=function(){return this},i.children=function(){return[]},i}}

