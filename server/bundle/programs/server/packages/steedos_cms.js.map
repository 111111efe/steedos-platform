{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos_cms/server/routes/site.coffee","meteor://ðŸ’»app/server/routes/site.coffee","meteor://ðŸ’»app/packages/steedos_cms/server/routes/avatar.coffee","meteor://ðŸ’»app/server/routes/avatar.coffee"],"names":["Cookies","renderSite","Npm","require","Template","registerHelpers","dict","_","each","v","k","registerHelper","CategoryId","instance","data","params","categoryId","CategoryActive","c","Category","db","cms_categories","findOne","ParentCategory","parent","SubCategories","siteId","find","site","sort","order","created","SubCategoriesCount","count","fromNow","value","moment","DateFormat","formatString","format","Posts","limit","skip","cms_posts","category","postDate","PostsCount","PostSummary","body","substring","key","TAPi18n","__","RecentPosts","cat","children","calculateChildren","push","$in","Markdown","text","Spacebars","SafeString","PostAttachmentUrl","attachment","isPreview","url","Meteor","absoluteUrl","_id","original","name","Steedos","isMobile","IsImageAttachment","ref","type","startsWith","IsHtmlAttachment","isProduction","postId","fileIds","postAttachments","Creator","getCollection","fields","versions","fetch","forEach","att","length","pluck","cfs","files","cms_sites","tag","a","b","req","res","next","authToken","cookies","hashedToken","html","isPostIncSuc","layout","templateName","user","userId","writeHead","end","get","Accounts","_hashLoginToken","users","visibility","theme","Assets","getText","SSR","compileTemplate","direct","update","$inc","viewCount","console","error","render","JsonRoutes","add","startup","color","colors","initials","position","ref1","reqModifiedHeader","svg","username","avatar","setHeader","file","charCodeAt","substr","toUpperCase","write","headers","modified","toUTCString","Date","readStream","pipe"],"mappings":"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","file":"/packages/steedos_cms.js","sourcesContent":["Cookies = Npm.require(\"cookies\")\n\nTemplate.registerHelpers = (dict) ->\n\t_.each dict, (v, k)->\n\t\tTemplate.registerHelper k, v\n\n\nTemplate.registerHelpers\n\n\n\tCategoryId: ()->\n\t\treturn Template.instance().data.params.categoryId\n\n\tCategoryActive: (c)->\n\t\tcategoryId = Template.instance().data.params.categoryId\n\t\tif categoryId == c\n\t\t\treturn \"active\"\n\n\tCategory: ()->\n\t\tcategoryId = Template.instance().data.params.categoryId\n\t\tif categoryId\n\t\t\treturn db.cms_categories.findOne(categoryId)\n\n\tParentCategory: ()->\n\t\tcategoryId = Template.instance().data.params.categoryId\n\t\tif categoryId\n\t\t\tc = db.cms_categories.findOne(categoryId)\n\t\t\tif c?.parent\n\t\t\t\treturn db.cms_categories.findOne(c.parent)\n\n\tSubCategories: (parent)->\n\t\tif parent == \"root\"\n\t\t\tsiteId = Template.instance().data.params.siteId\n\t\t\treturn db.cms_categories.find({site: siteId, parent: null}, {sort: {order: 1, created: 1}})\n\t\telse\n\t\t\treturn db.cms_categories.find({parent: parent}, {sort: {order: 1, created: 1}})\n\t\t\t\n\tSubCategoriesCount: (parent)->\n\t\tif parent == \"root\"\n\t\t\tsiteId = Template.instance().data.params.siteId\n\t\t\treturn db.cms_categories.find({site: siteId, parent: null}).count()\n\t\telse\n\t\t\treturn db.cms_categories.find({parent: parent}).count()\n\n\tfromNow: (value)->\n\t\treturn moment(value).fromNow()\n\n\tDateFormat: (value, formatString) ->\n\t\tif !formatString\n\t\t\tformatString = \"YYYY-MM-DD\"\n\t\treturn moment(value).format(formatString)\n\n\tPosts: (categoryId, limit, skip)->\n\t\tif !limit \n\t\t\tlimit = 5\n\t\tskip = 0\n\t\tsiteId = Template.instance().data.params.siteId\n\t\tif !siteId \n\t\t\treturn []\n\t\tif categoryId \n\t\t\treturn db.cms_posts.find({site: siteId, category: categoryId}, {sort: {postDate: -1}, limit: limit, skip: skip})\n\t\telse\n\t\t\treturn db.cms_posts.find({site: siteId}, {sort: {postDate: -1}, limit: limit, skip: skip})\n\n\tPostsCount: (categoryId)->\n\t\tsiteId = Template.instance().data.params.siteId\n\t\tif !siteId \n\t\t\treturn 0\n\t\tif categoryId \n\t\t\treturn db.cms_posts.find({site: siteId, category: categoryId}).count()\n\t\telse\n\t\t\treturn db.cms_posts.find({site: siteId}).count()\n\t   \n\tPostSummary: ->\n\t\tif this.body\n\t\t\treturn this.body.substring(0, 400)\n\n\t_: (key) ->\n\t\treturn TAPi18n.__ key\n\n\tRecentPosts: (categoryId, limit, skip)->\n\t\tif !limit \n\t\t\tlimit = 5\n\t\tskip = 0\n\t\tsiteId = Template.instance().data.params.siteId\n\t\tcat = db.cms_categories.findOne(categoryId)\n\t\tif !cat \n\t\t\treturn []\n\t\tchildren = cat.calculateChildren();\n\t\tchildren.push(categoryId)\n\t\treturn db.cms_posts.find({site: siteId, category: {$in: children}}, {sort: {postDate: -1}, limit: limit, skip: skip})\n\n\tMarkdown: (text)->\n\t\tif text\n\t\t\treturn Spacebars.SafeString(Markdown(text))\n\n\tSafeString: (text)->\n\t\tif text\n\t\t\treturn Spacebars.SafeString(text)\n\n\tPostAttachmentUrl: (attachment,isPreview)-> \n\t\turl = Meteor.absoluteUrl(\"api/files/files/#{attachment._id}/#{attachment.original.name}\")\n\t\tif !(typeof isPreview == \"boolean\" and isPreview) and !Steedos.isMobile()\n\t\t\turl += \"?download=true\"\n\t\treturn url\n\n\tIsImageAttachment: (attachment)->\n\t\ttype = attachment?.original?.type\n\t\treturn type?.startsWith(\"image/\")\n\n\tIsHtmlAttachment: (attachment)->\n\t\treturn attachment?.original?.type == \"text/html\"\n\n\tisProduction: ()->\n\t\treturn Meteor.isProduction\n\nTemplate.registerHelper 'Post', ->\n\tpostId = Template.instance().data.params.postId\n\tif postId\n\t\treturn db.cms_posts.findOne({_id: postId})\n\n\nTemplate.registerHelper 'images', (postId)->\n\tif postId\n\t\tpostAttachments = Creator.getCollection(\"cms_files\").find({'parent.o': 'cms_posts', 'parent.ids': postId}, {fields: {_id:1, versions: 1}}).fetch();\n\t\tfileIds = []\n\t\tpostAttachments.forEach (att)->\n\t\t\tif att?.versions.length > 0\n\t\t\t\tfileIds.push(att.versions[0])\n\t\treturn _.pluck(cfs.files.find({_id: {$in: fileIds}, \"original.type\": /image\\//},{sort: {\"uploadedAt\": -1}}).fetch(), '_id')\n\nTemplate.registerHelper 'Attachments', ()->\n\tpostId = Template.instance().data.params.postId\n\tif postId\n\t\tpostAttachments = Creator.getCollection(\"cms_files\").find({'parent.o': 'cms_posts', 'parent.ids': postId}, {fields: {_id:1, versions: 1}}).fetch();\n\t\tfileIds = []\n\t\tpostAttachments.forEach (att)->\n\t\t\tif att?.versions.length > 0\n\t\t\t\tfileIds.push(att.versions[0])\n\n\t\treturn cfs.files.find({_id: {$in: fileIds}},{sort: {\"uploadedAt\": -1}}).fetch()\n\nTemplate.registerHelper 'SiteId', ->\n\tsiteId = Template.instance().data.params.siteId\n\treturn siteId\n\nTemplate.registerHelper 'Site', ->\n\tsiteId = Template.instance().data.params.siteId\n\tif siteId\n\t\treturn db.cms_sites.findOne({_id: siteId})\n\nTemplate.registerHelper 'IndexPage', ->\n\tdata = Template.instance().data\n\tif !data.params\n\t\treturn false;\n\telse if data.params.categoryId\n\t\treturn false\n\telse if data.params.postId\n\t\treturn false\n\telse \n\t\treturn true\n\nTemplate.registerHelper 'TagPage', ->\n\ttag = Template.instance().data.params.tag\n\tif tag\n\t\treturn true\n\treturn false\n\nTemplate.registerHelper 'Tag', ->\n\ttag = Template.instance().data.params.tag\n\treturn tag\n\nTemplate.registerHelper 'PostPage', ->\n\tpostId = Template.instance().data.params.postId\n\tif postId\n\t\treturn true\n\treturn false\n\n\nTemplate.registerHelper 'equals', (a, b)->\n\treturn a == b\n\nrenderSite = (req, res, next) ->\n\tsite = db.cms_sites.findOne({_id: req.params.siteId})\n\t\n\tif !site\n\t\tres.writeHead 404\n\t\tres.end(\"Site not found\")\n\t\treturn\n\n\tcookies = new Cookies( req, res );\n\tuserId = cookies.get(\"X-User-Id\")\n\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\tif userId and authToken\n\t\thashedToken = Accounts._hashLoginToken(authToken)\n\t\tuser = Meteor.users.findOne\n\t\t\t_id: userId,\n\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\n\n\tunless site?.visibility == \"public\"\n\t\tres.writeHead 401\n\t\tres.end(\"Access Denied\")\n\t\treturn\n\n\ttemplateName = 'site_theme_' + site.theme\n\tlayout = site.layout\n\tif !layout\n\t\tlayout = Assets.getText('themes/default.html')\n\tSSR.compileTemplate('site_theme_' + site.theme, layout);\n\n\tpostId = req.params.postId\n\tif postId\n\t\tisPostIncSuc = db.cms_posts.direct.update {\n\t\t\t_id: postId\n\t\t}, $inc:\n\t\t\tviewCount: 1\n\t\tunless isPostIncSuc\n\t\t\tconsole.error \"addPostViewer while previewing site post Failed. cms_posts.update.$inc ...#{postId}\"\n\n\thtml = SSR.render templateName, \n\t\tparams: req.params\n\n\tres.end(html);\n\n# JsonRoutes.add \"get\", \"/site/:siteId\", (req, res, next)->\n#   res.statusCode = 302;\n#   res.setHeader \"Location\", \"./s/home\"\n#   res.end();\n\nJsonRoutes.add \"get\", \"/site/:siteId\", renderSite  \n\nJsonRoutes.add \"get\", \"/site/:siteId/c/:categoryId\", renderSite  \n\nJsonRoutes.add \"get\", \"/site/:siteId/p/:postId\", renderSite  \n\nJsonRoutes.add \"get\", \"/site/:siteId/t/:tag\", renderSite  ","var Cookies, renderSite;\n\nCookies = Npm.require(\"cookies\");\n\nTemplate.registerHelpers = function(dict) {\n  return _.each(dict, function(v, k) {\n    return Template.registerHelper(k, v);\n  });\n};\n\nTemplate.registerHelpers({\n  CategoryId: function() {\n    return Template.instance().data.params.categoryId;\n  },\n  CategoryActive: function(c) {\n    var categoryId;\n    categoryId = Template.instance().data.params.categoryId;\n    if (categoryId === c) {\n      return \"active\";\n    }\n  },\n  Category: function() {\n    var categoryId;\n    categoryId = Template.instance().data.params.categoryId;\n    if (categoryId) {\n      return db.cms_categories.findOne(categoryId);\n    }\n  },\n  ParentCategory: function() {\n    var c, categoryId;\n    categoryId = Template.instance().data.params.categoryId;\n    if (categoryId) {\n      c = db.cms_categories.findOne(categoryId);\n      if (c != null ? c.parent : void 0) {\n        return db.cms_categories.findOne(c.parent);\n      }\n    }\n  },\n  SubCategories: function(parent) {\n    var siteId;\n    if (parent === \"root\") {\n      siteId = Template.instance().data.params.siteId;\n      return db.cms_categories.find({\n        site: siteId,\n        parent: null\n      }, {\n        sort: {\n          order: 1,\n          created: 1\n        }\n      });\n    } else {\n      return db.cms_categories.find({\n        parent: parent\n      }, {\n        sort: {\n          order: 1,\n          created: 1\n        }\n      });\n    }\n  },\n  SubCategoriesCount: function(parent) {\n    var siteId;\n    if (parent === \"root\") {\n      siteId = Template.instance().data.params.siteId;\n      return db.cms_categories.find({\n        site: siteId,\n        parent: null\n      }).count();\n    } else {\n      return db.cms_categories.find({\n        parent: parent\n      }).count();\n    }\n  },\n  fromNow: function(value) {\n    return moment(value).fromNow();\n  },\n  DateFormat: function(value, formatString) {\n    if (!formatString) {\n      formatString = \"YYYY-MM-DD\";\n    }\n    return moment(value).format(formatString);\n  },\n  Posts: function(categoryId, limit, skip) {\n    var siteId;\n    if (!limit) {\n      limit = 5;\n    }\n    skip = 0;\n    siteId = Template.instance().data.params.siteId;\n    if (!siteId) {\n      return [];\n    }\n    if (categoryId) {\n      return db.cms_posts.find({\n        site: siteId,\n        category: categoryId\n      }, {\n        sort: {\n          postDate: -1\n        },\n        limit: limit,\n        skip: skip\n      });\n    } else {\n      return db.cms_posts.find({\n        site: siteId\n      }, {\n        sort: {\n          postDate: -1\n        },\n        limit: limit,\n        skip: skip\n      });\n    }\n  },\n  PostsCount: function(categoryId) {\n    var siteId;\n    siteId = Template.instance().data.params.siteId;\n    if (!siteId) {\n      return 0;\n    }\n    if (categoryId) {\n      return db.cms_posts.find({\n        site: siteId,\n        category: categoryId\n      }).count();\n    } else {\n      return db.cms_posts.find({\n        site: siteId\n      }).count();\n    }\n  },\n  PostSummary: function() {\n    if (this.body) {\n      return this.body.substring(0, 400);\n    }\n  },\n  _: function(key) {\n    return TAPi18n.__(key);\n  },\n  RecentPosts: function(categoryId, limit, skip) {\n    var cat, children, siteId;\n    if (!limit) {\n      limit = 5;\n    }\n    skip = 0;\n    siteId = Template.instance().data.params.siteId;\n    cat = db.cms_categories.findOne(categoryId);\n    if (!cat) {\n      return [];\n    }\n    children = cat.calculateChildren();\n    children.push(categoryId);\n    return db.cms_posts.find({\n      site: siteId,\n      category: {\n        $in: children\n      }\n    }, {\n      sort: {\n        postDate: -1\n      },\n      limit: limit,\n      skip: skip\n    });\n  },\n  Markdown: function(text) {\n    if (text) {\n      return Spacebars.SafeString(Markdown(text));\n    }\n  },\n  SafeString: function(text) {\n    if (text) {\n      return Spacebars.SafeString(text);\n    }\n  },\n  PostAttachmentUrl: function(attachment, isPreview) {\n    var url;\n    url = Meteor.absoluteUrl(\"api/files/files/\" + attachment._id + \"/\" + attachment.original.name);\n    if (!(typeof isPreview === \"boolean\" && isPreview) && !Steedos.isMobile()) {\n      url += \"?download=true\";\n    }\n    return url;\n  },\n  IsImageAttachment: function(attachment) {\n    var ref, type;\n    type = attachment != null ? (ref = attachment.original) != null ? ref.type : void 0 : void 0;\n    return type != null ? type.startsWith(\"image/\") : void 0;\n  },\n  IsHtmlAttachment: function(attachment) {\n    var ref;\n    return (attachment != null ? (ref = attachment.original) != null ? ref.type : void 0 : void 0) === \"text/html\";\n  },\n  isProduction: function() {\n    return Meteor.isProduction;\n  }\n});\n\nTemplate.registerHelper('Post', function() {\n  var postId;\n  postId = Template.instance().data.params.postId;\n  if (postId) {\n    return db.cms_posts.findOne({\n      _id: postId\n    });\n  }\n});\n\nTemplate.registerHelper('images', function(postId) {\n  var fileIds, postAttachments;\n  if (postId) {\n    postAttachments = Creator.getCollection(\"cms_files\").find({\n      'parent.o': 'cms_posts',\n      'parent.ids': postId\n    }, {\n      fields: {\n        _id: 1,\n        versions: 1\n      }\n    }).fetch();\n    fileIds = [];\n    postAttachments.forEach(function(att) {\n      if ((att != null ? att.versions.length : void 0) > 0) {\n        return fileIds.push(att.versions[0]);\n      }\n    });\n    return _.pluck(cfs.files.find({\n      _id: {\n        $in: fileIds\n      },\n      \"original.type\": /image\\//\n    }, {\n      sort: {\n        \"uploadedAt\": -1\n      }\n    }).fetch(), '_id');\n  }\n});\n\nTemplate.registerHelper('Attachments', function() {\n  var fileIds, postAttachments, postId;\n  postId = Template.instance().data.params.postId;\n  if (postId) {\n    postAttachments = Creator.getCollection(\"cms_files\").find({\n      'parent.o': 'cms_posts',\n      'parent.ids': postId\n    }, {\n      fields: {\n        _id: 1,\n        versions: 1\n      }\n    }).fetch();\n    fileIds = [];\n    postAttachments.forEach(function(att) {\n      if ((att != null ? att.versions.length : void 0) > 0) {\n        return fileIds.push(att.versions[0]);\n      }\n    });\n    return cfs.files.find({\n      _id: {\n        $in: fileIds\n      }\n    }, {\n      sort: {\n        \"uploadedAt\": -1\n      }\n    }).fetch();\n  }\n});\n\nTemplate.registerHelper('SiteId', function() {\n  var siteId;\n  siteId = Template.instance().data.params.siteId;\n  return siteId;\n});\n\nTemplate.registerHelper('Site', function() {\n  var siteId;\n  siteId = Template.instance().data.params.siteId;\n  if (siteId) {\n    return db.cms_sites.findOne({\n      _id: siteId\n    });\n  }\n});\n\nTemplate.registerHelper('IndexPage', function() {\n  var data;\n  data = Template.instance().data;\n  if (!data.params) {\n    return false;\n  } else if (data.params.categoryId) {\n    return false;\n  } else if (data.params.postId) {\n    return false;\n  } else {\n    return true;\n  }\n});\n\nTemplate.registerHelper('TagPage', function() {\n  var tag;\n  tag = Template.instance().data.params.tag;\n  if (tag) {\n    return true;\n  }\n  return false;\n});\n\nTemplate.registerHelper('Tag', function() {\n  var tag;\n  tag = Template.instance().data.params.tag;\n  return tag;\n});\n\nTemplate.registerHelper('PostPage', function() {\n  var postId;\n  postId = Template.instance().data.params.postId;\n  if (postId) {\n    return true;\n  }\n  return false;\n});\n\nTemplate.registerHelper('equals', function(a, b) {\n  return a === b;\n});\n\nrenderSite = function(req, res, next) {\n  var authToken, cookies, hashedToken, html, isPostIncSuc, layout, postId, site, templateName, user, userId;\n  site = db.cms_sites.findOne({\n    _id: req.params.siteId\n  });\n  if (!site) {\n    res.writeHead(404);\n    res.end(\"Site not found\");\n    return;\n  }\n  cookies = new Cookies(req, res);\n  userId = cookies.get(\"X-User-Id\");\n  authToken = cookies.get(\"X-Auth-Token\");\n  if (userId && authToken) {\n    hashedToken = Accounts._hashLoginToken(authToken);\n    user = Meteor.users.findOne({\n      _id: userId,\n      \"services.resume.loginTokens.hashedToken\": hashedToken\n    });\n  }\n  if ((site != null ? site.visibility : void 0) !== \"public\") {\n    res.writeHead(401);\n    res.end(\"Access Denied\");\n    return;\n  }\n  templateName = 'site_theme_' + site.theme;\n  layout = site.layout;\n  if (!layout) {\n    layout = Assets.getText('themes/default.html');\n  }\n  SSR.compileTemplate('site_theme_' + site.theme, layout);\n  postId = req.params.postId;\n  if (postId) {\n    isPostIncSuc = db.cms_posts.direct.update({\n      _id: postId\n    }, {\n      $inc: {\n        viewCount: 1\n      }\n    });\n    if (!isPostIncSuc) {\n      console.error(\"addPostViewer while previewing site post Failed. cms_posts.update.$inc ...\" + postId);\n    }\n  }\n  html = SSR.render(templateName, {\n    params: req.params\n  });\n  return res.end(html);\n};\n\nJsonRoutes.add(\"get\", \"/site/:siteId\", renderSite);\n\nJsonRoutes.add(\"get\", \"/site/:siteId/c/:categoryId\", renderSite);\n\nJsonRoutes.add(\"get\", \"/site/:siteId/p/:postId\", renderSite);\n\nJsonRoutes.add(\"get\", \"/site/:siteId/t/:tag\", renderSite);\n","Meteor.startup ->\n    \n    JsonRoutes.add 'get', '/avatar/cms_sites/:siteId', (req, res, next) ->\n        site = db.cms_sites.findOne(req.params.siteId);\n        if !site\n            res.writeHead 401\n            res.end()\n            return\n\n        if site.avatar\n            res.setHeader \"Location\", Meteor.absoluteUrl(\"api/files/avatars/\" + site.avatar)\n            res.writeHead 302\n            res.end()\n            return\n\n        username = site.name;\n        if !username\n            username = \"\"\n\n        res.setHeader 'Content-Disposition', 'inline'\n\n        if not file?\n            res.setHeader 'content-type', 'image/svg+xml'\n            res.setHeader 'cache-control', 'public, max-age=31536000'\n\n            colors = ['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFC107','#FF9800','#FF5722','#795548','#9E9E9E','#607D8B']\n\n            position = username.length % colors.length\n            color = colors[position]\n\n            initials = ''\n            if username.charCodeAt(0)>255\n                initials = username.substr(0, 1)\n            else\n                initials = username.substr(0, 2)\n\n            initials = initials.toUpperCase()\n\n            svg = \"\"\"\n            <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n            <svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: #{color};\">\n                <text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n                    #{initials}\n                </text>\n            </svg>\n            \"\"\"\n\n            res.write svg\n            res.end()\n            return\n\n        reqModifiedHeader = req.headers[\"if-modified-since\"];\n        if reqModifiedHeader?\n            if reqModifiedHeader == site.modified?.toUTCString()\n                res.setHeader 'Last-Modified', reqModifiedHeader\n                res.writeHead 304\n                res.end()\n                return\n\n        res.setHeader 'Last-Modified', site.modified?.toUTCString() or new Date().toUTCString()\n        res.setHeader 'content-type', 'image/jpeg'\n        res.setHeader 'Content-Length', file.length\n\n        file.readStream.pipe res\n        return","Meteor.startup(function() {\n  return JsonRoutes.add('get', '/avatar/cms_sites/:siteId', function(req, res, next) {\n    var color, colors, initials, position, ref, ref1, reqModifiedHeader, site, svg, username;\n    site = db.cms_sites.findOne(req.params.siteId);\n    if (!site) {\n      res.writeHead(401);\n      res.end();\n      return;\n    }\n    if (site.avatar) {\n      res.setHeader(\"Location\", Meteor.absoluteUrl(\"api/files/avatars/\" + site.avatar));\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    username = site.name;\n    if (!username) {\n      username = \"\";\n    }\n    res.setHeader('Content-Disposition', 'inline');\n    if (typeof file === \"undefined\" || file === null) {\n      res.setHeader('content-type', 'image/svg+xml');\n      res.setHeader('cache-control', 'public, max-age=31536000');\n      colors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B'];\n      position = username.length % colors.length;\n      color = colors[position];\n      initials = '';\n      if (username.charCodeAt(0) > 255) {\n        initials = username.substr(0, 1);\n      } else {\n        initials = username.substr(0, 2);\n      }\n      initials = initials.toUpperCase();\n      svg = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"no\\\"?>\\n<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" pointer-events=\\\"none\\\" width=\\\"50\\\" height=\\\"50\\\" style=\\\"width: 50px; height: 50px; background-color: \" + color + \";\\\">\\n    <text text-anchor=\\\"middle\\\" y=\\\"50%\\\" x=\\\"50%\\\" dy=\\\"0.36em\\\" pointer-events=\\\"auto\\\" fill=\\\"#ffffff\\\" font-family=\\\"Helvetica, Arial, Lucida Grande, sans-serif\\\" style=\\\"font-weight: 400; font-size: 28px;\\\">\\n        \" + initials + \"\\n    </text>\\n</svg>\";\n      res.write(svg);\n      res.end();\n      return;\n    }\n    reqModifiedHeader = req.headers[\"if-modified-since\"];\n    if (reqModifiedHeader != null) {\n      if (reqModifiedHeader === ((ref = site.modified) != null ? ref.toUTCString() : void 0)) {\n        res.setHeader('Last-Modified', reqModifiedHeader);\n        res.writeHead(304);\n        res.end();\n        return;\n      }\n    }\n    res.setHeader('Last-Modified', ((ref1 = site.modified) != null ? ref1.toUTCString() : void 0) || new Date().toUTCString());\n    res.setHeader('content-type', 'image/jpeg');\n    res.setHeader('Content-Length', file.length);\n    file.readStream.pipe(res);\n  });\n});\n"]}