{"version":3,"sources":["meteor://💻app/packages/steedos:base/checkNpm.js","meteor://💻app/packages/steedos:base/lib/meteor_fix.js","meteor://💻app/packages/steedos:base/lib/steedos_util.js","meteor://💻app/packages/steedos_base/lib/core.coffee","meteor://💻app/lib/core.coffee","meteor://💻app/packages/steedos:base/lib/simple_schema_extend.js","meteor://💻app/packages/steedos_base/lib/methods/last_logon.coffee","meteor://💻app/lib/methods/last_logon.coffee","meteor://💻app/packages/steedos_base/lib/methods/user_add_email.coffee","meteor://💻app/lib/methods/user_add_email.coffee","meteor://💻app/packages/steedos_base/lib/methods/user_avatar.coffee","meteor://💻app/lib/methods/user_avatar.coffee","meteor://💻app/packages/steedos:base/lib/methods/email_templates_reset.js","meteor://💻app/packages/steedos:base/lib/methods/upgrade_data.js","meteor://💻app/packages/steedos_base/lib/steedos/push.coffee","meteor://💻app/lib/steedos/push.coffee","meteor://💻app/packages/steedos_base/lib/admin.coffee","meteor://💻app/lib/admin.coffee","meteor://💻app/packages/steedos:base/lib/array_includes.js","meteor://💻app/packages/steedos_base/lib/settings.coffee","meteor://💻app/lib/settings.coffee","meteor://💻app/packages/steedos_base/lib/user_object_view.coffee","meteor://💻app/lib/user_object_view.coffee","meteor://💻app/packages/steedos:base/lib/server_session.js","meteor://💻app/packages/steedos_base/routes/api_get_apps.coffee","meteor://💻app/routes/api_get_apps.coffee","meteor://💻app/packages/steedos_base/routes/collection.coffee","meteor://💻app/routes/collection.coffee","meteor://💻app/packages/steedos_base/routes/sso.coffee","meteor://💻app/routes/sso.coffee","meteor://💻app/packages/steedos_base/routes/avatar.coffee","meteor://💻app/routes/avatar.coffee","meteor://💻app/packages/steedos_base/routes/access_token.coffee","meteor://💻app/routes/access_token.coffee","meteor://💻app/packages/steedos_base/server/publications/apps.coffee","meteor://💻app/server/publications/apps.coffee","meteor://💻app/packages/steedos_base/server/publications/my_spaces.coffee","meteor://💻app/server/publications/my_spaces.coffee","meteor://💻app/packages/steedos_base/server/publications/space_avatar.coffee","meteor://💻app/server/publications/space_avatar.coffee","meteor://💻app/packages/steedos_base/server/publications/modules.coffee","meteor://💻app/server/publications/modules.coffee","meteor://💻app/packages/steedos_base/server/publications/weixin_pay_code_url.coffee","meteor://💻app/server/publications/weixin_pay_code_url.coffee","meteor://💻app/packages/steedos_base/server/routes/bootstrap.coffee","meteor://💻app/server/routes/bootstrap.coffee","meteor://💻app/packages/steedos_base/server/routes/api_billing_recharge_notify.coffee","meteor://💻app/server/routes/api_billing_recharge_notify.coffee","meteor://💻app/packages/steedos_base/server/methods/my_contacts_limit.coffee","meteor://💻app/server/methods/my_contacts_limit.coffee","meteor://💻app/packages/steedos:base/server/methods/setKeyValue.js","meteor://💻app/packages/steedos_base/server/methods/billing_settleup.coffee","meteor://💻app/server/methods/billing_settleup.coffee","meteor://💻app/packages/steedos_base/server/methods/setUsername.coffee","meteor://💻app/server/methods/setUsername.coffee","meteor://💻app/packages/steedos_base/server/methods/billing_recharge.coffee","meteor://💻app/server/methods/billing_recharge.coffee","meteor://💻app/packages/steedos_base/server/methods/get_space_user_count.coffee","meteor://💻app/packages/steedos_base/server/methods/user_secret.coffee","meteor://💻app/server/methods/user_secret.coffee","meteor://💻app/packages/steedos_base/server/methods/object_workflows.coffee","meteor://💻app/server/methods/object_workflows.coffee","meteor://💻app/packages/steedos_base/server/methods/set_space_user_password.coffee","meteor://💻app/server/methods/set_space_user_password.coffee","meteor://💻app/packages/steedos_base/server/lib/billing_manager.coffee","meteor://💻app/server/lib/billing_manager.coffee","meteor://💻app/packages/steedos:base/server/schedule/statistics.js","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v1.coffee","meteor://💻app/server/steedos/startup/migrations/v1.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v2.coffee","meteor://💻app/server/steedos/startup/migrations/v2.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v3.coffee","meteor://💻app/server/steedos/startup/migrations/v3.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v4.coffee","meteor://💻app/server/steedos/startup/migrations/v4.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v5.coffee","meteor://💻app/server/steedos/startup/migrations/v5.coffee","meteor://💻app/packages/steedos_base/server/steedos/startup/migrations/v6.coffee","meteor://💻app/server/steedos/startup/migrations/v6.coffee","meteor://💻app/packages/steedos_base/tabular.coffee","meteor://💻app/tabular.coffee"],"names":["checkNpmVersions","module","link","v","cookies","mkdirp","Meteor","settings","billing","Mongo","isServer","mongoOptions","ignoreUndefined","mongoOptionStr","process","env","MONGO_OPTIONS","jsonMongoOptions","JSON","parse","Object","assign","setConnectionOptions","autorun","Tracker","Array","prototype","sortByName","locale","Steedos","sort","p1","p2","p1_sort_no","sort_no","p2_sort_no","name","localeCompare","getProperty","k","forEach","t","m","push","remove","from","to","rest","slice","length","apply","filterProperty","h","l","g","d","includes","undefined","findPropertyByPK","r","Cookies","crypto","mixin","db","subs","isPhoneEnabled","ref","ref1","phone","numberToString","number","toString","replace","valiJquerySymbols","str","reg","RegExp","test","getHelpUrl","country","substring","isClient","spaceUpgradedModal","swal","title","TAPi18n","__","text","html","type","confirmButtonText","getAccountBgBodyValue","accountBgBody","steedos_keyvalues","findOne","user","userId","key","value","applyAccountBgBodyValue","accountBgBodyValue","isNeedToLocal","avatar","avatarUrl","background","ref2","url","loggingIn","localStorage","getItem","$","css","absoluteUrl","admin","setItem","removeItem","getAccountSkinValue","accountSkin","getAccountZoomValue","accountZoom","applyAccountZoomValue","accountZoomValue","zoomName","zoomSize","size","removeClass","Session","get","addClass","showHelp","getLocale","window","open","getUrlWithToken","authToken","linker","getSpaceId","Accounts","_storedLoginToken","indexOf","param","getAppUrlWithToken","app_id","openAppWithToken","app","apps","is_new_window","isMobile","isCordova","location","openWindow","openUrlWithIE","cmd","exec","open_url","isNode","nw","require","error","stdout","stderr","toastr","openApp","e","evalFunString","on_click","path","redirectToSignIn","FlowRouter","go","is_use_ie","origin","isInternalApp","is_use_iframe","_id","eval","error1","console","message","stack","set","checkSpaceBalance","spaceId","end_date","min_months","space","isSpaceAdmin","spaces","is_paid","Date","setModalMaxHeight","offset","detectIE","each","footerHeight","headerHeight","height","totalHeight","outerHeight","innerHeight","hasClass","getModalMaxHeight","reValue","screen","isiOS","userAgent","language","DEVICE","browser","conExp","device","numExp","android","blackberry","desktop","ipad","iphone","ipod","mobile","navigator","toLowerCase","browserLanguage","match","getUserOrganizations","isIncludeParents","organizations","parents","space_user","space_users","fields","_","flatten","find","$in","fetch","union","forbidNodeContextmenu","target","ifr","document","body","addEventListener","ev","preventDefault","load","ifrBody","contents","admins","isLegalVersion","app_version","check","modules","isOrgAdminByOrgIds","orgIds","allowAccessOrgs","isOrgAdmin","useOrgs","filter","org","uniq","isOrgAdminByAllOrgIds","i","root_url","URL","pathname","getAPILoginUser","req","res","password","ref3","result","username","query","users","steedos_id","_checkPassword","Error","checkAuthToken","headers","hashedToken","_hashLoginToken","decrypt","iv","c","decipher","decipherMsg","key32","len","createDecipheriv","Buffer","concat","update","final","encrypt","cipher","cipheredMsg","createCipheriv","getUserIdFromAccessToken","access_token","collection","obj","split","oAuth2Server","collections","accessToken","expires","getUserIdFromAuthToken","APIAuthenticationCheck","JsonRoutes","sendResult","data","code","functions","func","args","_wrapped","arguments","call","isHoliday","date","day","getDay","caculateWorkingTime","days","caculateDate","param_date","Number","getTime","caculatePlusHalfWorkingDay","next","caculated_date","first_date","j","max_index","second_date","start_date","time_points","remind","isEmpty","setHours","hour","setMinutes","minute","extend","getSteedosToken","appId","now","secret","steedos_token","parseInt","isI18n","checkUsernameAvailability","$regex","_escapeRegExp","trim","validatePassword","pwd","passworPolicy","passworPolicyError","reason","valid","policy","policyError","convertSpecialCharacter","removeSpecialCharacter","Creator","getDBApps","space_id","dbApps","Collections","is_creator","visible","created","created_by","modified","modified_by","getDBDashboards","dbDashboards","dashboard","getAuthToken","authorization","sessionStorage","getCurrentAppId","startup","SimpleSchema","extendOptions","foreign_key","Match","Optional","Boolean","references","methods","updateUserLastLogon","$set","last_logon","onLogin","users_add_email","email","count","emails","direct","$push","address","verified","sendVerificationEmail","users_remove_email","p","$pull","users_verify_email","users_set_primary_email","primary","multi","showCancelButton","closeOnConfirm","animation","inputValue","updateUserAvatar","emailTemplates","defaultFrom","resetPassword","subject","splits","tokenCode","greeting","profile","token_code","verifyEmail","enrollAccount","add","orgs","fullname","$ne","calculateFullname","ret","msg","Push","Configure","senderID","ANDROID_SENDER_ID","sound","vibrate","ios","badge","clearBadge","alert","appName","Selector","selectorCheckSpaceAdmin","selector","is_cloudadmin","map","n","selectorCheckSpace","u","billing_pay_records","adminConfig","icon","color","tableColumns","extraFields","routerAdmin","paid","showEditColumn","showDelColumn","disableAdd","pageLength","order","space_user_signs","AdminConfig","collections_add","searchElement","O","currentElement","webservices","www","status","getUserObjectsListViews","objects","_getUserObjectListViews","keys","listViews","objectsViews","getCollection","object_name","owner","shared","_user_object_list_views","olistViews","ov","listview","o","list_view","getUserObjectListViews","object_listview","user_id","uuflowManager","getSpace","$or","$exists","errors","errorMessage","allow_models","model","options","express","des_cipher","des_cipheredMsg","des_iv","des_steedos_token","joiner","key8","redirectUrl","returnurl","params","writeHead","end","encodeURI","setHeader","color_index","colors","fontSize","initials","position","reqModifiedHeader","svg","username_array","width","w","fs","file","write","item","charCodeAt","substr","toUpperCase","toUTCString","readStream","pipe","publish","ready","handle","handle2","observeSpaces","self","sus","userSpaces","user_accepted","su","observe","added","doc","removed","oldDoc","without","stop","changed","newDoc","onStop","enable_register","_getLocale","clone","steedosAuth","steedosCore","steedosI18n","toLocaleLowerCase","_Apps","_Dashboards","assigned_menus","lng","permissions","userSession","wrapAsync","cb","getSession","then","resolve","reject","getAllPermissions","translationObjects","Apps","dashboards","Dashboards","object_listviews","object_workflows","getUserObjectPermission","steedosSchema","getDataSources","datasource","datasourceObjects","getObjects","_obj","convertObject","toConfig","database_name","getAppsConfig","getDashboardsConfig","_dbid","translationApps","translationMenus","plugins","getPlugins","on","chunk","bindEnvironment","parser","xml2js","Parser","explicitArray","explicitRoot","parseString","err","WXPay","attach","bpr","code_url_id","sign","wxpay","appid","mch_id","partner_key","total_fee","billingManager","special_pay","user_count","log","get_contacts_limit","froms","fromsChildren","fromsChildrenIds","isLimit","len1","limit","limits","myLitmitOrgIds","myOrgId","myOrgIds","myOrgs","outside_organizations","setting","tempIsLimit","toOrgs","tos","String","space_settings","values","intersection","setKeyValue","insert","billing_settleup","accounting_month","Email","time","s","caculate_by_accounting_month","Package","send","stringify","timeEnd","setUsername","spaceUser","invite_state","billing_recharge","new_id","module_names","listprices","one_month_yuan","order_body","result_obj","space_user_count","listprice_rmb","name_zh","createUnifiedOrder","join","out_trade_no","moment","format","spbill_create_ip","notify_url","trade_type","product_id","info","get_space_user_count","user_count_info","total_user_count","accepted_user_count","create_secret","remove_secret","token","curSpaceUser","ows","flow_id","fl","perms","flow_name","can_add","users_can_add","orgs_can_add","some","setSpaceUserPassword","space_user_id","currentUser","lang","userCP","setPassword","logout","mobile_verified","SMSQueue","Format","Action","ParamString","RecNum","SignName","TemplateCode","get_accounting_period","count_days","end_date_time","start_date_time","billings","transaction","billing_date","getDate","refresh_balance","refresh_date","app_bill","b_m","b_m_d","bill","credits","debits","last_balance","last_bill","payment_bill","setObj","$lt","billing_month","balance","toFixed","get_balance","module_name","listprice","accounting_date","accounting_date_format","days_number","new_bill","$lte","_makeNewID","getSpaceUserCount","recaculateBalance","refresh_dates","r_d","get_modules","m_changelog","modules_changelogs","change_date","operation","get_modules_name","modules_name","a_m","newest_bill","period_result","remaining_months","b","operator_id","new_modules","space_update_obj","difference","_d","user_limit","mcl","operator","cron","statistics","schedule","rule","go_next","scheduleJob","dateFormat","datekey","getFullYear","getMonth","yesterDay","dNow","dBefore","dailyStaticsCount","statics","$gt","staticsCount","ownerName","lastLogon","sUsers","sUser","lastModified","objArr","mod","postsAttachments","attSize","sizeSum","posts","post","atts","cfs","att","original","dailyPostsAttachments","steedos_statistics","space_name","owner_name","steedos","workflow","flows","forms","flow_roles","flow_positions","instances","instances_last_modified","daily_flows","daily_forms","daily_instances","cms","sites","cms_sites","cms_posts","posts_last_modified","posts_attachments_size","comments","cms_comments","daily_sites","daily_posts","daily_comments","daily_posts_attachments_size","Migrations","version","up","update_cfs_instance","parent_id","instance_id","attach_version","isCurrent","metadata","parent","instance","approve","current","attachments","ins","attachs","current_ver","_rev","historys","his","down","organization","check_count","new_org_ids","removed_org_ids","root_org","updateUsers","months","set_obj","pm","setMonth","Tabular","Table","columns","orderable","dom","lengthChange","ordering","searching","autoWidth","changeSelector","$and"],"mappings":"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","file":"/packages/steedos_base.js","sourcesContent":["import {\r\n\tcheckNpmVersions\r\n} from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\t\"node-schedule\": \"^1.3.1\",\r\n\tcookies: \"^0.6.2\",\r\n\t\"xml2js\": \"^0.4.19\",\r\n\tmkdirp: \"^0.3.5\",\r\n\t\"sprintf-js\": \"^1.0.3\",\r\n\t\"url-search-params-polyfill\": \"^7.0.0\",\r\n}, 'steedos:base');\r\n\r\nif (Meteor.settings && Meteor.settings.billing) {\r\n\tcheckNpmVersions({\r\n\t\t\"weixin-pay\": \"^1.1.7\"\r\n\t}, 'steedos:base');\r\n}","import { Mongo } from 'meteor/mongo'       \r\n\r\n// Revert change from Meteor 1.6.1 who set ignoreUndefined: true\r\n// more information https://github.com/meteor/meteor/pull/9444\r\nif (Meteor.isServer) {\r\n\r\n\tlet mongoOptions = {\r\n\t\tignoreUndefined: false,\r\n\t};\r\n\r\n\tconst mongoOptionStr = process.env.MONGO_OPTIONS;\r\n\tif (typeof mongoOptionStr !== 'undefined') {\r\n\t\tconst jsonMongoOptions = JSON.parse(mongoOptionStr);\r\n\r\n\t\tmongoOptions = Object.assign({}, mongoOptions, jsonMongoOptions);\r\n\t}\r\n\r\n\tMongo.setConnectionOptions(mongoOptions);\r\n}\r\n\r\n\r\nMeteor.autorun = Tracker.autorun\r\n","Array.prototype.sortByName = function (locale) {\r\n    if (!this) {\r\n        return;\r\n    }\r\n    if(!locale){\r\n        locale = Steedos.locale()\r\n    }\r\n    this.sort(function (p1, p2) {\r\n\t\tvar p1_sort_no = p1.sort_no || 0;\r\n\t\tvar p2_sort_no = p2.sort_no || 0;\r\n\t\tif(p1_sort_no != p2_sort_no){\r\n            return p1_sort_no > p2_sort_no ? -1 : 1\r\n        }else{\r\n\t\t\treturn p1.name.localeCompare(p2.name, locale);\r\n\t\t}\r\n    });\r\n};\r\n\r\n\r\nArray.prototype.getProperty = function (k) {\r\n    var v = new Array();\r\n    this.forEach(function (t) {\r\n        var m = t ? t[k] : null;\r\n        v.push(m);\r\n    });\r\n    return v;\r\n}\r\n\r\n/*\r\n * 添加Array的remove函数\r\n */\r\nArray.prototype.remove = function (from, to) {\r\n    if (from < 0) {\r\n        return;\r\n    }\r\n    var rest = this.slice((to || from) + 1 || this.length);\r\n    this.length = from < 0 ? this.length + from : from;\r\n    return this.push.apply(this, rest);\r\n};\r\n\r\n/*\r\n * 添加Array的过滤器\r\n * return 符合条件的对象Array\r\n */\r\nArray.prototype.filterProperty = function (h, l) {\r\n    var g = [];\r\n    this.forEach(function (t) {\r\n        var m = t ? t[h] : null;\r\n        var d = false;\r\n        if (m instanceof Array) {\r\n            d = m.includes(l);\r\n        } else {\r\n            if (m instanceof Object) {\r\n                if (\"id\" in m) {\r\n                    m = m[\"id\"];\r\n                } else if (\"_id\" in m) {\r\n                    m = m[\"_id\"];\r\n                }\r\n\r\n            }\r\n            if (l instanceof Array) {\r\n                d = (l === undefined) ? false : l.includes(m);\r\n            } else {\r\n                d = (l === undefined) ? false : m == l;\r\n            }\r\n        }\r\n\r\n        if (d) {\r\n            g.push(t);\r\n        }\r\n    });\r\n    return g;\r\n}\r\n\r\n/*\r\n * 添加Array的过滤器\r\n * return 符合条件的第一个对象\r\n */\r\nArray.prototype.findPropertyByPK = function (h, l) {\r\n    var r = null;\r\n    this.forEach(function (t) {\r\n        var m = t ? t[h] : null;\r\n        var d = false;\r\n        if (m instanceof Array) {\r\n            d = m.includes(l);\r\n        } else {\r\n            d = (l === undefined) ? false : m == l;\r\n        }\r\n\r\n        if (d) {\r\n            r = t;\r\n        }\r\n    });\r\n    return r;\r\n}","Steedos =\r\n\tsettings: {}\r\n\tdb: db\r\n\tsubs: {}\r\n\tisPhoneEnabled: ->\r\n\t\treturn !!Meteor.settings?.public?.phone\r\n\tnumberToString: (number, locale)->\r\n\t\tif typeof number == \"number\"\r\n\t\t\tnumber = number.toString()\r\n\r\n\t\tif !number\r\n\t\t\treturn '';\r\n\r\n\t\tif number != \"NaN\"\r\n\t\t\tunless locale\r\n\t\t\t\tlocale = Steedos.locale()\r\n\t\t\tif locale == \"zh-cn\" || locale == \"zh-CN\"\r\n\t\t\t\t# 中文万分位财务人员看不惯，所以改为国际一样的千分位\r\n\t\t\t\treturn number.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')\r\n\t\t\telse\r\n\t\t\t\treturn number.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',')\r\n\t\telse\r\n\t\t\treturn \"\"\r\n\tvaliJquerySymbols: (str)->\r\n\t\t# reg = /^[^!\"#$%&'()*+,./:;<=>?@[\\]^`{|}~]+$/g\r\n\t\treg = new RegExp(\"^[^!\\\"#$%&'()*\\+,\\.\\/:;<=>?@[\\\\]^`{|}~]+$\")\r\n\t\treturn reg.test(str)\r\n\r\n###\r\n# Kick off the global namespace for Steedos.\r\n# @namespace Steedos\r\n###\r\n\r\nSteedos.getHelpUrl = (locale)->\r\n\tcountry = locale.substring(3)\r\n\treturn \"http://www.steedos.com/\" + country + \"/help/\"\r\n\r\nif Meteor.isClient\r\n\r\n\tSteedos.spaceUpgradedModal = ()->\r\n\t\tswal({title: TAPi18n.__(\"space_paid_info_title\"), text: TAPi18n.__(\"space_paid_info_text\"), html: true, type:\"warning\", confirmButtonText: TAPi18n.__(\"OK\")});\r\n\r\n\tSteedos.getAccountBgBodyValue = ()->\r\n\t\taccountBgBody = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"bg_body\"})\r\n\t\tif accountBgBody\r\n\t\t\treturn accountBgBody.value\r\n\t\telse\r\n\t\t\treturn {};\r\n\r\n\tSteedos.applyAccountBgBodyValue = (accountBgBodyValue,isNeedToLocal)->\r\n\t\tif Meteor.loggingIn() or !Steedos.userId()\r\n\t\t\t# 如果是正在登录中或在登录界面，则取localStorage中设置，而不是直接应用空设置\r\n\t\t\taccountBgBodyValue = {}\r\n\t\t\taccountBgBodyValue.url = localStorage.getItem(\"accountBgBodyValue.url\")\r\n\t\t\taccountBgBodyValue.avatar = localStorage.getItem(\"accountBgBodyValue.avatar\")\r\n\r\n\t\turl = accountBgBodyValue.url\r\n\t\tavatar = accountBgBodyValue.avatar\r\n\t\tif accountBgBodyValue.url\r\n\t\t\tif url == avatar\r\n\t\t\t\tavatarUrl = 'api/files/avatars/' + avatar\r\n\t\t\t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(avatarUrl)})\"\r\n\t\t\telse\r\n\t\t\t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(url)})\"\r\n\t\telse\r\n\t\t\tbackground = Meteor.settings?.public?.admin?.background\r\n\t\t\tif background\r\n\t\t\t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(background)})\"\r\n\t\t\telse\r\n\t\t\t\tbackground = \"/packages/steedos_theme/client/background/sea.jpg\"\r\n\t\t\t\t$(\"body\").css \"backgroundImage\",\"url(#{Steedos.absoluteUrl(background)})\"\r\n\r\n\t\tif isNeedToLocal\r\n\t\t\tif Meteor.loggingIn()\r\n\t\t\t\t# 正在登录中，则不做处理，因为此时Steedos.userId()不足于证明已登录状态\r\n\t\t\t\treturn\r\n\t\t\t# 这里特意不在localStorage中存储Steedos.userId()，因为需要保证登录界面也应用localStorage中的设置\r\n\t\t\t# 登录界面不设置localStorage，因为登录界面accountBgBodyValue肯定为空，设置的话，会造成无法保持登录界面也应用localStorage中的设置\r\n\t\t\tif Steedos.userId()\r\n\t\t\t\tif url\r\n\t\t\t\t\tlocalStorage.setItem(\"accountBgBodyValue.url\",url)\r\n\t\t\t\t\tlocalStorage.setItem(\"accountBgBodyValue.avatar\",avatar)\r\n\t\t\t\telse\r\n\t\t\t\t\tlocalStorage.removeItem(\"accountBgBodyValue.url\")\r\n\t\t\t\t\tlocalStorage.removeItem(\"accountBgBodyValue.avatar\")\r\n\r\n\tSteedos.getAccountSkinValue = ()->\r\n\t\taccountSkin = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"skin\"})\r\n\t\tif accountSkin\r\n\t\t\treturn accountSkin.value\r\n\t\telse\r\n\t\t\treturn {};\r\n\r\n\tSteedos.getAccountZoomValue = ()->\r\n\t\taccountZoom = db.steedos_keyvalues.findOne({user:Steedos.userId(),key:\"zoom\"})\r\n\t\tif accountZoom\r\n\t\t\treturn accountZoom.value\r\n\t\telse\r\n\t\t\treturn {};\r\n\r\n\tSteedos.applyAccountZoomValue = (accountZoomValue,isNeedToLocal)->\r\n\t\tif Meteor.loggingIn() or !Steedos.userId()\r\n\t\t\t# 如果是正在登录中或在登录界面，则取localStorage中设置，而不是直接应用空设置\r\n\t\t\taccountZoomValue = {}\r\n\t\t\taccountZoomValue.name = localStorage.getItem(\"accountZoomValue.name\")\r\n\t\t\taccountZoomValue.size = localStorage.getItem(\"accountZoomValue.size\")\r\n\t\t$(\"body\").removeClass(\"zoom-normal\").removeClass(\"zoom-large\").removeClass(\"zoom-extra-large\");\r\n\t\tzoomName = accountZoomValue.name\r\n\t\tzoomSize = accountZoomValue.size\r\n\t\tunless zoomName\r\n\t\t\tzoomName = \"large\"\r\n\t\t\tzoomSize = 1.2\r\n\t\tif zoomName && !Session.get(\"instancePrint\")\r\n\t\t\t$(\"body\").addClass(\"zoom-#{zoomName}\")\r\n\t\t\t# if Steedos.isNode()\r\n\t\t\t# \tif accountZoomValue.size == \"1\"\r\n\t\t\t# \t\t# node-webkit中size为0才表示100%\r\n\t\t\t# \t\tzoomSize = 0\r\n\t\t\t# \tnw.Window.get().zoomLevel = Number.parseFloat(zoomSize)\r\n\t\t\t# else\r\n\t\t\t# \t$(\"body\").addClass(\"zoom-#{zoomName}\")\r\n\t\tif isNeedToLocal\r\n\t\t\tif Meteor.loggingIn()\r\n\t\t\t\t# 正在登录中，则不做处理，因为此时Steedos.userId()不足于证明已登录状态\r\n\t\t\t\treturn\r\n\t\t\t# 这里特意不在localStorage中存储Steedos.userId()，因为需要保证登录界面也应用localStorage中的设置\r\n\t\t\t# 登录界面不设置localStorage，因为登录界面accountZoomValue肯定为空，设置的话，会造成无法保持登录界面也应用localStorage中的设置\r\n\t\t\tif Steedos.userId()\r\n\t\t\t\tif accountZoomValue.name\r\n\t\t\t\t\tlocalStorage.setItem(\"accountZoomValue.name\",accountZoomValue.name)\r\n\t\t\t\t\tlocalStorage.setItem(\"accountZoomValue.size\",accountZoomValue.size)\r\n\t\t\t\telse\r\n\t\t\t\t\tlocalStorage.removeItem(\"accountZoomValue.name\")\r\n\t\t\t\t\tlocalStorage.removeItem(\"accountZoomValue.size\")\r\n\r\n\tSteedos.showHelp = (url)->\r\n\t\tlocale = Steedos.getLocale()\r\n\t\tcountry = locale.substring(3)\r\n\r\n\t\turl = url || \"http://www.steedos.com/\" + country + \"/help/\"\r\n\r\n\t\twindow.open(url, '_help', 'EnableViewPortScale=yes')\r\n\r\n\tSteedos.getUrlWithToken = (url)->\r\n\t\tauthToken = {};\r\n\t\tauthToken[\"spaceId\"] = Steedos.getSpaceId()\r\n\t\tauthToken[\"X-User-Id\"] = Meteor.userId();\r\n\t\tauthToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\r\n\r\n\t\tlinker = \"?\"\r\n\r\n\t\tif url.indexOf(\"?\") > -1\r\n\t\t\tlinker = \"&\"\r\n\r\n\t\treturn url + linker + $.param(authToken)\r\n\r\n\tSteedos.getAppUrlWithToken = (app_id)->\r\n\t\tauthToken = {};\r\n\t\tauthToken[\"spaceId\"] = Steedos.getSpaceId()\r\n\t\tauthToken[\"X-User-Id\"] = Meteor.userId();\r\n\t\tauthToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\r\n\t\treturn \"api/setup/sso/\" + app_id + \"?\" + $.param(authToken)\r\n\r\n\tSteedos.openAppWithToken = (app_id)->\r\n\t\turl = Steedos.getAppUrlWithToken app_id\r\n\t\turl = Steedos.absoluteUrl url\r\n\r\n\t\tapp = db.apps.findOne(app_id)\r\n\r\n\t\tif !app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()\r\n\t\t\twindow.location = url\r\n\t\telse\r\n\t\t\tSteedos.openWindow(url);\r\n\r\n\tSteedos.openUrlWithIE = (url)->\r\n\t\tif url\r\n\t\t\tif Steedos.isNode()\r\n\t\t\t\texec = nw.require('child_process').exec\r\n\t\t\t\topen_url = url\r\n\t\t\t\tcmd = \"start iexplore.exe \\\"#{open_url}\\\"\"\r\n\t\t\t\texec cmd, (error, stdout, stderr) ->\r\n\t\t\t\t\tif error\r\n\t\t\t\t\t\ttoastr.error error\r\n\t\t\t\t\treturn\r\n\t\t\telse\r\n\t\t\t\tSteedos.openWindow(url)\r\n\r\n\r\n\tSteedos.openApp = (app_id)->\r\n\t\tif !Meteor.userId()\r\n\t\t\tSteedos.redirectToSignIn()\r\n\t\t\treturn true\r\n\r\n\t\tapp = db.apps.findOne(app_id)\r\n\t\tif !app\r\n\t\t\tFlowRouter.go(\"/\")\r\n\t\t\treturn\r\n\r\n\t\t# creatorSettings = Meteor.settings.public?.webservices?.creator\r\n\t\t# if app._id == \"admin\" and creatorSettings?.status == \"active\"\r\n\t\t# \turl = creatorSettings.url\r\n\t\t# \treg = /\\/$/\r\n\t\t# \tunless reg.test url\r\n\t\t# \t\turl += \"/\"\r\n\t\t# \turl = \"#{url}app/admin\"\r\n\t\t# \tSteedos.openWindow(url)\r\n\t\t# \treturn\r\n\r\n\t\ton_click = app.on_click\r\n\t\tif app.is_use_ie\r\n\t\t\tif Steedos.isNode()\r\n\t\t\t\texec = nw.require('child_process').exec\r\n\t\t\t\tif on_click\r\n\t\t\t\t\tpath = \"api/app/sso/#{app_id}?authToken=#{Accounts._storedLoginToken()}&userId=#{Meteor.userId()}\"\r\n\t\t\t\t\topen_url = window.location.origin + \"/\" + path\r\n\t\t\t\telse\r\n\t\t\t\t\topen_url = Steedos.getAppUrlWithToken app_id\r\n\t\t\t\t\topen_url = window.location.origin + \"/\" + open_url\r\n\t\t\t\tcmd = \"start iexplore.exe \\\"#{open_url}\\\"\"\r\n\t\t\t\texec cmd, (error, stdout, stderr) ->\r\n\t\t\t\t\tif error\r\n\t\t\t\t\t\ttoastr.error error\r\n\t\t\t\t\treturn\r\n\t\t\telse\r\n\t\t\t\tSteedos.openAppWithToken(app_id)\r\n\r\n\t\telse if db.apps.isInternalApp(app.url)\r\n\t\t\tFlowRouter.go(app.url)\r\n\r\n\t\telse if app.is_use_iframe\r\n\t\t\tif app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()\r\n\t\t\t\tSteedos.openWindow(Steedos.absoluteUrl(\"apps/iframe/\" + app._id))\r\n\t\t\telse if Steedos.isMobile() || Steedos.isCordova()\r\n\t\t\t\tSteedos.openAppWithToken(app_id)\r\n\t\t\telse\r\n\t\t\t\tFlowRouter.go(\"/apps/iframe/#{app._id}\")\r\n\r\n\t\telse if on_click\r\n\t\t\t# 这里执行的是一个不带参数的闭包函数，用来避免变量污染\r\n\t\t\tevalFunString = \"(function(){#{on_click}})()\"\r\n\t\t\ttry\r\n\t\t\t\teval(evalFunString)\r\n\t\t\tcatch e\r\n\t\t\t\t# just console the error when catch error\r\n\t\t\t\tconsole.error \"catch some error when eval the on_click script for app link:\"\r\n\t\t\t\tconsole.error \"#{e.message}\\r\\n#{e.stack}\"\r\n\t\telse\r\n\t\t\tSteedos.openAppWithToken(app_id)\r\n\r\n\t\tif !app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova() && !app.is_use_ie && !on_click\r\n\t\t\t# 需要选中当前app时，on_click函数里要单独加上Session.set(\"current_app_id\", app_id)\r\n\t\t\tSession.set(\"current_app_id\", app_id)\r\n\r\n\tSteedos.checkSpaceBalance = (spaceId)->\r\n\t\tunless spaceId\r\n\t\t\tspaceId = Steedos.spaceId()\r\n\t\tmin_months = 1\r\n\t\tif Steedos.isSpaceAdmin()\r\n\t\t\tmin_months = 3\r\n\t\tspace = db.spaces.findOne(spaceId)\r\n\t\tend_date = space?.end_date\r\n\t\tif space?.is_paid and end_date != undefined and (end_date - new Date) <= (min_months*30*24*3600*1000)\r\n\t\t\t# 提示用户余额不足\r\n\t\t\ttoastr.error t(\"space_balance_insufficient\")\r\n\r\n\tSteedos.setModalMaxHeight = ()->\r\n\t\taccountZoomValue = Steedos.getAccountZoomValue()\r\n\t\tunless accountZoomValue.name\r\n\t\t\taccountZoomValue.name = 'large'\r\n\t\tswitch accountZoomValue.name\r\n\t\t\twhen 'normal'\r\n\t\t\t\tif Steedos.isMobile()\r\n\t\t\t\t\toffset = -12\r\n\t\t\t\telse\r\n\t\t\t\t\toffset = 75\r\n\t\t\twhen 'large'\r\n\t\t\t\tif Steedos.isMobile()\r\n\t\t\t\t\toffset = -6\r\n\t\t\t\telse\r\n\t\t\t\t\t# 区分IE浏览器\r\n\t\t\t\t\tif Steedos.detectIE()\r\n\t\t\t\t\t\toffset = 199\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\toffset = 9\r\n\t\t\twhen 'extra-large'\r\n\t\t\t\tif Steedos.isMobile()\r\n\t\t\t\t\toffset = -26\r\n\t\t\t\telse\r\n\t\t\t\t\t# 区分IE浏览器\r\n\t\t\t\t\tif Steedos.detectIE()\r\n\t\t\t\t\t\toffset = 303\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\toffset = 53\r\n\r\n\t\tif $(\".modal\").length\r\n\t\t\t$(\".modal\").each ->\r\n\t\t\t\theaderHeight = 0\r\n\t\t\t\tfooterHeight = 0\r\n\t\t\t\ttotalHeight = 0\r\n\t\t\t\t$(\".modal-header\", $(this)).each ->\r\n\t\t\t\t\theaderHeight += $(this).outerHeight(false)\r\n\t\t\t\t$(\".modal-footer\", $(this)).each ->\r\n\t\t\t\t\tfooterHeight += $(this).outerHeight(false)\r\n\r\n\t\t\t\ttotalHeight = headerHeight + footerHeight\r\n\t\t\t\theight = $(\"body\").innerHeight() - totalHeight - offset\r\n\t\t\t\tif $(this).hasClass(\"cf_contact_modal\")\r\n\t\t\t\t\t$(\".modal-body\",$(this)).css({\"max-height\": \"#{height}px\", \"height\": \"#{height}px\"})\r\n\t\t\t\telse\r\n\t\t\t\t\t$(\".modal-body\",$(this)).css({\"max-height\": \"#{height}px\", \"height\": \"auto\"})\r\n\r\n\tSteedos.getModalMaxHeight = (offset)->\r\n\t\tif Steedos.isMobile()\r\n\t\t\treValue = window.screen.height - 126 - 180 - 25\r\n\t\telse\r\n\t\t\treValue = $(window).height() - 180 - 25\r\n\t\tunless Steedos.isiOS() or Steedos.isMobile()\r\n\t\t\t# ios及手机上不需要为zoom放大功能额外计算\r\n\t\t\taccountZoomValue = Steedos.getAccountZoomValue()\r\n\t\t\tswitch accountZoomValue.name\r\n\t\t\t\twhen 'large'\r\n\t\t\t\t\t# 测下来这里不需要额外减数\r\n\t\t\t\t\treValue -= 50\r\n\t\t\t\twhen 'extra-large'\r\n\t\t\t\t\treValue -= 145\r\n\t\tif offset\r\n\t\t\treValue -= offset\r\n\t\treturn reValue + \"px\";\r\n\r\n\tSteedos.isiOS = (userAgent, language)->\r\n\t\tDEVICE =\r\n\t\t\tandroid: 'android'\r\n\t\t\tblackberry: 'blackberry'\r\n\t\t\tdesktop: 'desktop'\r\n\t\t\tipad: 'ipad'\r\n\t\t\tiphone: 'iphone'\r\n\t\t\tipod: 'ipod'\r\n\t\t\tmobile: 'mobile'\r\n\t\tbrowser = {}\r\n\t\tconExp = '(?:[\\\\/:\\\\::\\\\s:;])'\r\n\t\tnumExp = '(\\\\S+[^\\\\s:;:\\\\)]|)'\r\n\t\tuserAgent = (userAgent or navigator.userAgent).toLowerCase()\r\n\t\tlanguage = language or navigator.language or navigator.browserLanguage\r\n\t\tdevice = userAgent.match(new RegExp('(android|ipad|iphone|ipod|blackberry)')) or userAgent.match(new RegExp('(mobile)')) or [\r\n\t\t\t''\r\n\t\t\tDEVICE.desktop\r\n\t\t]\r\n\t\tbrowser.device = device[1]\r\n\t\treturn browser.device == DEVICE.ipad or browser.device == DEVICE.iphone or browser.device == DEVICE.ipod\r\n\r\n\tSteedos.getUserOrganizations = (isIncludeParents)->\r\n\t\tuserId = Meteor.userId()\r\n\t\tspaceId = Steedos.spaceId()\r\n\t\tspace_user = db.space_users.findOne({user:userId,space:spaceId},fields:{organizations:1})\r\n\t\torganizations = space_user?.organizations\r\n\t\tunless organizations\r\n\t\t\treturn []\r\n\t\tif isIncludeParents\r\n\t\t\tparents = _.flatten db.organizations.find(_id:{$in:organizations}).fetch().getProperty(\"parents\")\r\n\t\t\treturn _.union organizations,parents\r\n\t\telse\r\n\t\t\treturn organizations\r\n\r\n\tSteedos.forbidNodeContextmenu = (target, ifr)->\r\n\t\tunless Steedos.isNode()\r\n\t\t\treturn\r\n\t\ttarget.document.body.addEventListener 'contextmenu', (ev) ->\r\n\t\t\tev.preventDefault()\r\n\t\t\treturn false\r\n\t\tif ifr\r\n\t\t\tif typeof ifr == 'string'\r\n\t\t\t\tifr = target.$(ifr)\r\n\t\t\tifr.load ->\r\n\t\t\t\tifrBody = ifr.contents().find('body')\r\n\t\t\t\tif ifrBody\r\n\t\t\t\t\tifrBody[0].addEventListener 'contextmenu', (ev) ->\r\n\t\t\t\t\t\tev.preventDefault()\r\n\t\t\t\t\t\treturn false\r\n\r\nif Meteor.isServer\r\n\tSteedos.getUserOrganizations = (spaceId,userId,isIncludeParents)->\r\n\t\tspace_user = db.space_users.findOne({user:userId,space:spaceId},fields:{organizations:1})\r\n\t\torganizations = space_user?.organizations\r\n\t\tunless organizations\r\n\t\t\treturn []\r\n\t\tif isIncludeParents\r\n\t\t\tparents = _.flatten db.organizations.find(_id:{$in:organizations}).fetch().getProperty(\"parents\")\r\n\t\t\treturn _.union organizations,parents\r\n\t\telse\r\n\t\t\treturn organizations\r\n\r\n#\tSteedos.chargeAPIcheck = (spaceId)->\r\n\r\nif Meteor.isServer\r\n\tCookies = require(\"cookies\")\r\n\t#TODO 添加服务端是否手机的判断(依据request)\r\n\tSteedos.isMobile = ()->\r\n\t\treturn false;\r\n\r\n\tSteedos.isSpaceAdmin = (spaceId, userId)->\r\n\t\tif !spaceId || !userId\r\n\t\t\treturn false\r\n\t\tspace = db.spaces.findOne(spaceId)\r\n\t\tif !space || !space.admins\r\n\t\t\treturn false;\r\n\t\treturn space.admins.indexOf(userId)>=0\r\n\r\n\tSteedos.isLegalVersion = (spaceId,app_version)->\r\n\t\tif !spaceId\r\n\t\t\treturn false\r\n\t\tcheck = false\r\n\t\tmodules = db.spaces.findOne(spaceId)?.modules\r\n\t\tif modules and modules.includes(app_version)\r\n\t\t\tcheck = true\r\n\t\treturn check\r\n\r\n\t# 判断数组orgIds中的org id集合对于用户userId是否有组织管理员权限，只要数组orgIds中任何一个组织有权限就返回true，反之返回false\r\n\tSteedos.isOrgAdminByOrgIds = (orgIds, userId)->\r\n\t\tisOrgAdmin = false\r\n\t\tuseOrgs = db.organizations.find({_id: {$in:orgIds}},{fields:{parents:1,admins:1}}).fetch()\r\n\t\tparents = []\r\n\t\tallowAccessOrgs = useOrgs.filter (org) ->\r\n\t\t\tif org.parents\r\n\t\t\t\tparents = _.union parents,org.parents\r\n\t\t\treturn org.admins?.includes(userId)\r\n\t\tif allowAccessOrgs.length\r\n\t\t\tisOrgAdmin = true\r\n\t\telse\r\n\t\t\tparents = _.flatten parents\r\n\t\t\tparents = _.uniq parents\r\n\t\t\tif parents.length and db.organizations.findOne({_id:{$in:parents}, admins:userId})\r\n\t\t\t\tisOrgAdmin = true\r\n\t\treturn isOrgAdmin\r\n\r\n\r\n\t# 判断数组orgIds中的org id集合对于用户userId是否有全部组织管理员权限，只有数组orgIds中每个组织都有权限才返回true，反之返回false\r\n\tSteedos.isOrgAdminByAllOrgIds = (orgIds, userId)->\r\n\t\tunless orgIds.length\r\n\t\t\treturn true\r\n\t\ti = 0\r\n\t\twhile i < orgIds.length\r\n\t\t\tisOrgAdmin = Steedos.isOrgAdminByOrgIds [orgIds[i]], userId\r\n\t\t\tunless isOrgAdmin\r\n\t\t\t\tbreak\r\n\t\t\ti++\r\n\t\treturn isOrgAdmin\r\n\r\n\tSteedos.absoluteUrl = (url)->\r\n\t\tif url\r\n\t\t\t# url以\"/\"开头的话，去掉开头的\"/\"\r\n\t\t\turl = url.replace(/^\\//,\"\")\r\n\t\tif (Meteor.isCordova)\r\n\t\t\treturn Meteor.absoluteUrl(url);\r\n\t\telse\r\n\t\t\tif Meteor.isClient\r\n\t\t\t\ttry\r\n\t\t\t\t\troot_url = new URL(Meteor.absoluteUrl())\r\n\t\t\t\t\tif url\r\n\t\t\t\t\t\treturn root_url.pathname + url\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\treturn root_url.pathname\r\n\t\t\t\tcatch e\r\n\t\t\t\t\treturn Meteor.absoluteUrl(url)\r\n\t\t\telse\r\n\t\t\t\tMeteor.absoluteUrl(url)\r\n\r\n\t#\t通过request.headers、cookie 获得有效用户\r\n\tSteedos.getAPILoginUser\t= (req, res) ->\r\n\r\n\t\tusername = req.query?.username\r\n\r\n\t\tpassword = req.query?.password\r\n\r\n\t\tif username && password\r\n\t\t\tuser = db.users.findOne({steedos_id: username})\r\n\r\n\t\t\tif !user\r\n\t\t\t\treturn false\r\n\r\n\t\t\tresult = Accounts._checkPassword user, password\r\n\r\n\t\t\tif result.error\r\n\t\t\t\tthrow new Error(result.error)\r\n\t\t\telse\r\n\t\t\t\treturn user\r\n\r\n\t\tuserId = req.query?[\"X-User-Id\"]\r\n\r\n\t\tauthToken = req.query?[\"X-Auth-Token\"]\r\n\r\n\t\tif Steedos.checkAuthToken(userId,authToken)\r\n\t\t\treturn db.users.findOne({_id: userId})\r\n\r\n\t\tcookies = new Cookies(req, res);\r\n\r\n\t\tif req.headers\r\n\t\t\tuserId = req.headers[\"x-user-id\"]\r\n\t\t\tauthToken = req.headers[\"x-auth-token\"]\r\n\r\n\t\t# then check cookie\r\n\t\tif !userId or !authToken\r\n\t\t\tuserId = cookies.get(\"X-User-Id\")\r\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\t\tif !userId or !authToken\r\n\t\t\treturn false\r\n\r\n\t\tif Steedos.checkAuthToken(userId, authToken)\r\n\t\t\treturn db.users.findOne({_id: userId})\r\n\r\n\t\treturn false\r\n\r\n\t#\t检查userId、authToken是否有效\r\n\tSteedos.checkAuthToken = (userId, authToken) ->\r\n\t\tif userId and authToken\r\n\t\t\thashedToken = Accounts._hashLoginToken(authToken)\r\n\t\t\tuser = Meteor.users.findOne\r\n\t\t\t\t_id: userId,\r\n\t\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\t\t\tif user\r\n\t\t\t\treturn true\r\n\t\t\telse\r\n\t\t\t\treturn false\r\n\t\treturn false\r\n\r\n\r\nif Meteor.isServer\r\n\tcrypto = require('crypto');\r\n\tSteedos.decrypt = (password, key, iv)->\r\n\t\ttry\r\n\t\t\tkey32 = \"\"\r\n\t\t\tlen = key.length\r\n\t\t\tif len < 32\r\n\t\t\t\tc = \"\"\r\n\t\t\t\ti = 0\r\n\t\t\t\tm = 32 - len\r\n\t\t\t\twhile i < m\r\n\t\t\t\t\tc = \" \" + c\r\n\t\t\t\t\ti++\r\n\t\t\t\tkey32 = key + c\r\n\t\t\telse if len >= 32\r\n\t\t\t\tkey32 = key.slice(0, 32)\r\n\r\n\t\t\tdecipher = crypto.createDecipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\r\n\r\n\t\t\tdecipherMsg = Buffer.concat([decipher.update(password, 'base64'), decipher.final()])\r\n\r\n\t\t\tpassword = decipherMsg.toString();\r\n\t\t\treturn password;\r\n\t\tcatch e\r\n\t\t\treturn password;\r\n\r\n\tSteedos.encrypt = (password, key, iv)->\r\n\t\tkey32 = \"\"\r\n\t\tlen = key.length\r\n\t\tif len < 32\r\n\t\t\tc = \"\"\r\n\t\t\ti = 0\r\n\t\t\tm = 32 - len\r\n\t\t\twhile i < m\r\n\t\t\t\tc = \" \" + c\r\n\t\t\t\ti++\r\n\t\t\tkey32 = key + c\r\n\t\telse if len >= 32\r\n\t\t\tkey32 = key.slice(0, 32)\r\n\r\n\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\r\n\r\n\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(password, 'utf8')), cipher.final()])\r\n\r\n\t\tpassword = cipheredMsg.toString('base64')\r\n\r\n\t\treturn password;\r\n\r\n\tSteedos.getUserIdFromAccessToken = (access_token)->\r\n\r\n\t\tif !access_token\r\n\t\t\treturn null;\r\n\r\n\t\tuserId = access_token.split(\"-\")[0]\r\n\r\n\t\thashedToken = Accounts._hashLoginToken(access_token)\r\n\r\n\t\tuser = db.users.findOne({_id: userId, \"secrets.hashedToken\": hashedToken})\r\n\r\n\t\tif user\r\n\t\t\treturn userId\r\n\t\telse\r\n\t\t\t# 如果user表未查到，则使用oauth2协议生成的token查找用户\r\n\t\t\tcollection = oAuth2Server.collections.accessToken\r\n\r\n\t\t\tobj = collection.findOne({'accessToken': access_token})\r\n\t\t\tif obj\r\n\t\t\t\t# 判断token的有效期\r\n\t\t\t\tif obj?.expires < new Date()\r\n\t\t\t\t\treturn \"oauth2 access token:\"+access_token+\" is expired.\"\r\n\t\t\t\telse\r\n\t\t\t\t\treturn obj?.userId\r\n\t\t\telse\r\n\t\t\t\treturn \"oauth2 access token:\"+access_token+\" is not found.\"\r\n\t\treturn null\r\n\r\n\tSteedos.getUserIdFromAuthToken = (req, res)->\r\n\r\n\t\tuserId = req.query?[\"X-User-Id\"]\r\n\r\n\t\tauthToken = req.query?[\"X-Auth-Token\"]\r\n\r\n\t\tif Steedos.checkAuthToken(userId,authToken)\r\n\t\t\treturn db.users.findOne({_id: userId})?._id\r\n\r\n\t\tcookies = new Cookies(req, res);\r\n\r\n\t\tif req.headers\r\n\t\t\tuserId = req.headers[\"x-user-id\"]\r\n\t\t\tauthToken = req.headers[\"x-auth-token\"]\r\n\r\n\t\t# then check cookie\r\n\t\tif !userId or !authToken\r\n\t\t\tuserId = cookies.get(\"X-User-Id\")\r\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\t\tif !userId or !authToken\r\n\t\t\treturn null\r\n\r\n\t\tif Steedos.checkAuthToken(userId, authToken)\r\n\t\t\treturn db.users.findOne({_id: userId})?._id\r\n\r\n\tSteedos.APIAuthenticationCheck = (req, res) ->\r\n\t\ttry\r\n\t\t\tuserId = req.userId\r\n\r\n\t\t\tuser = db.users.findOne({_id: userId})\r\n\r\n\t\t\tif !userId || !user\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tdata:\r\n\t\t\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id Or access_token\",\r\n\t\t\t\t\tcode: 401,\r\n\t\t\t\treturn false;\r\n\t\t\telse\r\n\t\t\t\treturn true;\r\n\t\tcatch e\r\n\t\t\tif !userId || !user\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 401,\r\n\t\t\t\t\tdata:\r\n\t\t\t\t\t\t\"error\": e.message,\r\n\t\t\t\t\t\t\"success\": false\r\n\t\t\t\treturn false;\r\n\r\n\r\n# This will add underscore.string methods to Underscore.js\r\n# except for include, contains, reverse and join that are\r\n# dropped because they collide with the functions already\r\n# defined by Underscore.js.\r\n\r\nmixin = (obj) ->\r\n\t_.each _.functions(obj), (name) ->\r\n\t\tif not _[name] and not _.prototype[name]?\r\n\t\t\tfunc = _[name] = obj[name]\r\n\t\t\t_.prototype[name] = ->\r\n\t\t\t\targs = [this._wrapped]\r\n\t\t\t\tpush.apply(args, arguments)\r\n\t\t\t\treturn result.call(this, func.apply(_, args))\r\n\r\n#mixin(_s.exports())\r\n\r\nif Meteor.isServer\r\n# 判断是否是节假日\r\n\tSteedos.isHoliday = (date)->\r\n\t\tif !date\r\n\t\t\tdate = new Date\r\n\t\tcheck date, Date\r\n\t\tday = date.getDay()\r\n\t\t# 周六周日为假期\r\n\t\tif day is 6 or day is 0\r\n\t\t\treturn true\r\n\r\n\t\treturn false\r\n\t# 根据传入时间(date)计算几个工作日(days)后的时间,days目前只能是整数\r\n\tSteedos.caculateWorkingTime = (date, days)->\r\n\t\tcheck date, Date\r\n\t\tcheck days, Number\r\n\t\tparam_date = new Date date\r\n\t\tcaculateDate = (i, days)->\r\n\t\t\tif i < days\r\n\t\t\t\tparam_date = new Date(param_date.getTime() + 24*60*60*1000)\r\n\t\t\t\tif !Steedos.isHoliday(param_date)\r\n\t\t\t\t\ti++\r\n\t\t\t\tcaculateDate(i, days)\r\n\t\t\treturn\r\n\t\tcaculateDate(0, days)\r\n\t\treturn param_date\r\n\r\n\t# 计算半个工作日后的时间\r\n\t# 参数 next如果为true则表示只计算date时间后面紧接着的time_points\r\n\tSteedos.caculatePlusHalfWorkingDay = (date, next) ->\r\n\t\tcheck date, Date\r\n\t\ttime_points = Meteor.settings.remind?.time_points\r\n\t\tif not time_points or _.isEmpty(time_points)\r\n\t\t\tconsole.error \"time_points is null\"\r\n\t\t\ttime_points = [{\"hour\": 8, \"minute\": 30 }, {\"hour\": 14, \"minute\": 30 }]\r\n\r\n\t\tlen = time_points.length\r\n\t\tstart_date = new Date date\r\n\t\tend_date = new Date date\r\n\t\tstart_date.setHours time_points[0].hour\r\n\t\tstart_date.setMinutes time_points[0].minute\r\n\t\tend_date.setHours time_points[len - 1].hour\r\n\t\tend_date.setMinutes time_points[len - 1].minute\r\n\r\n\t\tcaculated_date = new Date date\r\n\r\n\t\tj = 0\r\n\t\tmax_index = len - 1\r\n\t\tif date < start_date\r\n\t\t\tif next\r\n\t\t\t\tj = 0\r\n\t\t\telse\r\n\t\t\t\t# 加半个time_points\r\n\t\t\t\tj = len/2\r\n\t\telse if date >= start_date and date < end_date\r\n\t\t\ti = 0\r\n\t\t\twhile i < max_index\r\n\t\t\t\tfirst_date = new Date date\r\n\t\t\t\tsecond_date = new Date date\r\n\t\t\t\tfirst_date.setHours time_points[i].hour\r\n\t\t\t\tfirst_date.setMinutes time_points[i].minute\r\n\t\t\t\tsecond_date.setHours time_points[i + 1].hour\r\n\t\t\t\tsecond_date.setMinutes time_points[i + 1].minute\r\n\r\n\t\t\t\tif date >= first_date and date < second_date\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\ti++\r\n\r\n\t\t\tif next\r\n\t\t\t\tj = i + 1\r\n\t\t\telse\r\n\t\t\t\tj = i + len/2\r\n\r\n\t\telse if date >= end_date\r\n\t\t\tif next\r\n\t\t\t\tj = max_index + 1\r\n\t\t\telse\r\n\t\t\t\tj = max_index + len/2\r\n\r\n\t\tif j > max_index\r\n\t\t\t# 隔天需判断节假日\r\n\t\t\tcaculated_date = Steedos.caculateWorkingTime date, 1\r\n\t\t\tcaculated_date.setHours time_points[j - max_index - 1].hour\r\n\t\t\tcaculated_date.setMinutes time_points[j - max_index - 1].minute\r\n\t\telse if j <= max_index\r\n\t\t\tcaculated_date.setHours time_points[j].hour\r\n\t\t\tcaculated_date.setMinutes time_points[j].minute\r\n\r\n\t\treturn caculated_date\r\n\r\nif Meteor.isServer\r\n\t_.extend Steedos,\r\n\t\tgetSteedosToken: (appId, userId, authToken)->\r\n\t\t\tcrypto = require('crypto')\r\n\t\t\tapp = db.apps.findOne(appId)\r\n\t\t\tif app\r\n\t\t\t\tsecret = app.secret\r\n\r\n\t\t\tif userId and authToken\r\n\t\t\t\thashedToken = Accounts._hashLoginToken(authToken)\r\n\t\t\t\tuser = Meteor.users.findOne\r\n\t\t\t\t\t_id: userId,\r\n\t\t\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\t\t\t\tif user\r\n\t\t\t\t\tsteedos_id = user.steedos_id\r\n\t\t\t\t\tif app.secret\r\n\t\t\t\t\t\tiv = app.secret\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tiv = \"-8762-fcb369b2e8\"\r\n\t\t\t\t\tnow = parseInt(new Date().getTime()/1000).toString()\r\n\t\t\t\t\tkey32 = \"\"\r\n\t\t\t\t\tlen = steedos_id.length\r\n\t\t\t\t\tif len < 32\r\n\t\t\t\t\t\tc = \"\"\r\n\t\t\t\t\t\ti = 0\r\n\t\t\t\t\t\tm = 32 - len\r\n\t\t\t\t\t\twhile i < m\r\n\t\t\t\t\t\t\tc = \" \" + c\r\n\t\t\t\t\t\t\ti++\r\n\t\t\t\t\t\tkey32 = steedos_id + c\r\n\t\t\t\t\telse if len >= 32\r\n\t\t\t\t\t\tkey32 = steedos_id.slice(0,32)\r\n\r\n\t\t\t\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\r\n\r\n\t\t\t\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()])\r\n\r\n\t\t\t\t\tsteedos_token = cipheredMsg.toString('base64')\r\n\r\n\t\t\treturn steedos_token\r\n\r\n\t\tlocale: (userId, isI18n)->\r\n\t\t\tuser = db.users.findOne({_id:userId},{fields: {locale: 1}})\r\n\t\t\tlocale = user?.locale\r\n\t\t\tif isI18n\r\n\t\t\t\tif locale == \"en-us\"\r\n\t\t\t\t\tlocale = \"en\"\r\n\t\t\t\tif locale == \"zh-cn\"\r\n\t\t\t\t\tlocale = \"zh-CN\"\r\n\t\t\treturn locale\r\n\r\n\t\tcheckUsernameAvailability: (username) ->\r\n\t\t\treturn not Meteor.users.findOne({ username: { $regex : new RegExp(\"^\" + Meteor._escapeRegExp(username).trim() + \"$\", \"i\") } })\r\n\r\n\r\n\t\tvalidatePassword: (pwd)->\r\n\t\t\treason = t \"password_invalid\"\r\n\t\t\tvalid = true\r\n\t\t\tunless pwd\r\n\t\t\t\tvalid = false\r\n\r\n\t\t\tpassworPolicy = Meteor.settings.public?.password?.policy\r\n\t\t\tpassworPolicyError = Meteor.settings.public?.password?.policyError\r\n\t\t\tif passworPolicy\r\n\t\t\t\tif !(new RegExp(passworPolicy)).test(pwd || '')\r\n\t\t\t\t\treason = passworPolicyError\r\n\t\t\t\t\tvalid = false\r\n\t\t\t\telse\r\n\t\t\t\t\tvalid = true\r\n#\t\t\telse\r\n#\t\t\t\tunless /\\d+/.test(pwd)\r\n#\t\t\t\t\tvalid = false\r\n#\t\t\t\tunless /[a-zA-Z]+/.test(pwd)\r\n#\t\t\t\t\tvalid = false\r\n#\t\t\t\tif pwd.length < 8\r\n#\t\t\t\t\tvalid = false\r\n\t\t\tif valid\r\n\t\t\t\treturn true\r\n\t\t\telse\r\n\t\t\t\treturn error:\r\n\t\t\t\t\treason: reason\r\n\r\nSteedos.convertSpecialCharacter = (str)->\r\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\")\r\n\r\nSteedos.removeSpecialCharacter = (str)->\r\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}\\~\\`\\@\\#\\%\\&\\=\\'\\\"\\:\\;\\<\\>\\,\\/])/g, \"\")\r\n\r\nCreator.getDBApps = (space_id)->\r\n\tdbApps = {}\r\n\tCreator.Collections[\"apps\"].find({space: space_id,is_creator:true,visible:true}, {\r\n\t\tfields: {\r\n\t\t\tcreated: 0,\r\n\t\t\tcreated_by: 0,\r\n\t\t\tmodified: 0,\r\n\t\t\tmodified_by: 0\r\n\t\t}\r\n\t}).forEach (app)->\r\n\t\tdbApps[app._id] = app\r\n\r\n\treturn dbApps\r\n\r\nCreator.getDBDashboards = (space_id)->\r\n\tdbDashboards = {}\r\n\tCreator.Collections[\"dashboard\"].find({space: space_id}, {\r\n\t\tfields: {\r\n\t\t\tcreated: 0,\r\n\t\t\tcreated_by: 0,\r\n\t\t\tmodified: 0,\r\n\t\t\tmodified_by: 0\r\n\t\t}\r\n\t}).forEach (dashboard)->\r\n\t\tdbDashboards[dashboard._id] = dashboard\r\n\r\n\treturn dbDashboards\r\n\r\nif Meteor.isServer\r\n\tCookies = require(\"cookies\")\r\n\tSteedos.getAuthToken = (req, res)->\r\n\t\tcookies = new Cookies(req, res)\r\n\t\tauthToken = req.headers['x-auth-token'] || cookies.get(\"X-Auth-Token\")\r\n\t\tif !authToken && req.headers.authorization && req.headers.authorization.split(' ')[0] == 'Bearer'\r\n\t\t\tauthToken = req.headers.authorization.split(' ')[1]\r\n\t\treturn authToken\r\n\r\nif Meteor.isClient\r\n\tMeteor.autorun ()->\r\n\t\tif Session.get('current_app_id')\r\n\t\t\tsessionStorage.setItem('current_app_id', Session.get('current_app_id'))\r\n#\t\telse\r\n#\t\t\tconsole.log('remove current_app_id...');\r\n#\t\t\tsessionStorage.removeItem('current_app_id')\r\n\tSteedos.getCurrentAppId = ()->\r\n\t\tif Session.get('current_app_id')\r\n\t\t\treturn Session.get('current_app_id')\r\n\t\telse\r\n\t\t\treturn sessionStorage.getItem('current_app_id');\r\n","var Cookies, crypto, mixin;         \n\nSteedos = {\n  settings: {},\n  db: db,\n  subs: {},\n  isPhoneEnabled: function() {\n    var ref, ref1;\n    return !!((ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? ref1.phone : void 0 : void 0);\n  },\n  numberToString: function(number, locale) {\n    if (typeof number === \"number\") {\n      number = number.toString();\n    }\n    if (!number) {\n      return '';\n    }\n    if (number !== \"NaN\") {\n      if (!locale) {\n        locale = Steedos.locale();\n      }\n      if (locale === \"zh-cn\" || locale === \"zh-CN\") {\n        return number.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n      } else {\n        return number.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n      }\n    } else {\n      return \"\";\n    }\n  },\n  valiJquerySymbols: function(str) {\n    var reg;\n    reg = new RegExp(\"^[^!\\\"#$%&'()*\\+,\\.\\/:;<=>?@[\\\\]^`{|}~]+$\");\n    return reg.test(str);\n  }\n};\n\n\n/*\n * Kick off the global namespace for Steedos.\n * @namespace Steedos\n */\n\nSteedos.getHelpUrl = function(locale) {\n  var country;\n  country = locale.substring(3);\n  return \"http://www.steedos.com/\" + country + \"/help/\";\n};\n\nif (Meteor.isClient) {\n  Steedos.spaceUpgradedModal = function() {\n    return swal({\n      title: TAPi18n.__(\"space_paid_info_title\"),\n      text: TAPi18n.__(\"space_paid_info_text\"),\n      html: true,\n      type: \"warning\",\n      confirmButtonText: TAPi18n.__(\"OK\")\n    });\n  };\n  Steedos.getAccountBgBodyValue = function() {\n    var accountBgBody;\n    accountBgBody = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"bg_body\"\n    });\n    if (accountBgBody) {\n      return accountBgBody.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.applyAccountBgBodyValue = function(accountBgBodyValue, isNeedToLocal) {\n    var avatar, avatarUrl, background, ref, ref1, ref2, url;\n    if (Meteor.loggingIn() || !Steedos.userId()) {\n      accountBgBodyValue = {};\n      accountBgBodyValue.url = localStorage.getItem(\"accountBgBodyValue.url\");\n      accountBgBodyValue.avatar = localStorage.getItem(\"accountBgBodyValue.avatar\");\n    }\n    url = accountBgBodyValue.url;\n    avatar = accountBgBodyValue.avatar;\n    if (accountBgBodyValue.url) {\n      if (url === avatar) {\n        avatarUrl = 'api/files/avatars/' + avatar;\n        $(\"body\").css(\"backgroundImage\", \"url(\" + (Steedos.absoluteUrl(avatarUrl)) + \")\");\n      } else {\n        $(\"body\").css(\"backgroundImage\", \"url(\" + (Steedos.absoluteUrl(url)) + \")\");\n      }\n    } else {\n      background = (ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? (ref2 = ref1.admin) != null ? ref2.background : void 0 : void 0 : void 0;\n      if (background) {\n        $(\"body\").css(\"backgroundImage\", \"url(\" + (Steedos.absoluteUrl(background)) + \")\");\n      } else {\n        background = \"/packages/steedos_theme/client/background/sea.jpg\";\n        $(\"body\").css(\"backgroundImage\", \"url(\" + (Steedos.absoluteUrl(background)) + \")\");\n      }\n    }\n    if (isNeedToLocal) {\n      if (Meteor.loggingIn()) {\n        return;\n      }\n      if (Steedos.userId()) {\n        if (url) {\n          localStorage.setItem(\"accountBgBodyValue.url\", url);\n          return localStorage.setItem(\"accountBgBodyValue.avatar\", avatar);\n        } else {\n          localStorage.removeItem(\"accountBgBodyValue.url\");\n          return localStorage.removeItem(\"accountBgBodyValue.avatar\");\n        }\n      }\n    }\n  };\n  Steedos.getAccountSkinValue = function() {\n    var accountSkin;\n    accountSkin = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"skin\"\n    });\n    if (accountSkin) {\n      return accountSkin.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.getAccountZoomValue = function() {\n    var accountZoom;\n    accountZoom = db.steedos_keyvalues.findOne({\n      user: Steedos.userId(),\n      key: \"zoom\"\n    });\n    if (accountZoom) {\n      return accountZoom.value;\n    } else {\n      return {};\n    }\n  };\n  Steedos.applyAccountZoomValue = function(accountZoomValue, isNeedToLocal) {\n    var zoomName, zoomSize;\n    if (Meteor.loggingIn() || !Steedos.userId()) {\n      accountZoomValue = {};\n      accountZoomValue.name = localStorage.getItem(\"accountZoomValue.name\");\n      accountZoomValue.size = localStorage.getItem(\"accountZoomValue.size\");\n    }\n    $(\"body\").removeClass(\"zoom-normal\").removeClass(\"zoom-large\").removeClass(\"zoom-extra-large\");\n    zoomName = accountZoomValue.name;\n    zoomSize = accountZoomValue.size;\n    if (!zoomName) {\n      zoomName = \"large\";\n      zoomSize = 1.2;\n    }\n    if (zoomName && !Session.get(\"instancePrint\")) {\n      $(\"body\").addClass(\"zoom-\" + zoomName);\n    }\n    if (isNeedToLocal) {\n      if (Meteor.loggingIn()) {\n        return;\n      }\n      if (Steedos.userId()) {\n        if (accountZoomValue.name) {\n          localStorage.setItem(\"accountZoomValue.name\", accountZoomValue.name);\n          return localStorage.setItem(\"accountZoomValue.size\", accountZoomValue.size);\n        } else {\n          localStorage.removeItem(\"accountZoomValue.name\");\n          return localStorage.removeItem(\"accountZoomValue.size\");\n        }\n      }\n    }\n  };\n  Steedos.showHelp = function(url) {\n    var country, locale;\n    locale = Steedos.getLocale();\n    country = locale.substring(3);\n    url = url || \"http://www.steedos.com/\" + country + \"/help/\";\n    return window.open(url, '_help', 'EnableViewPortScale=yes');\n  };\n  Steedos.getUrlWithToken = function(url) {\n    var authToken, linker;\n    authToken = {};\n    authToken[\"spaceId\"] = Steedos.getSpaceId();\n    authToken[\"X-User-Id\"] = Meteor.userId();\n    authToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n    linker = \"?\";\n    if (url.indexOf(\"?\") > -1) {\n      linker = \"&\";\n    }\n    return url + linker + $.param(authToken);\n  };\n  Steedos.getAppUrlWithToken = function(app_id) {\n    var authToken;\n    authToken = {};\n    authToken[\"spaceId\"] = Steedos.getSpaceId();\n    authToken[\"X-User-Id\"] = Meteor.userId();\n    authToken[\"X-Auth-Token\"] = Accounts._storedLoginToken();\n    return \"api/setup/sso/\" + app_id + \"?\" + $.param(authToken);\n  };\n  Steedos.openAppWithToken = function(app_id) {\n    var app, url;\n    url = Steedos.getAppUrlWithToken(app_id);\n    url = Steedos.absoluteUrl(url);\n    app = db.apps.findOne(app_id);\n    if (!app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()) {\n      return window.location = url;\n    } else {\n      return Steedos.openWindow(url);\n    }\n  };\n  Steedos.openUrlWithIE = function(url) {\n    var cmd, exec, open_url;\n    if (url) {\n      if (Steedos.isNode()) {\n        exec = nw.require('child_process').exec;\n        open_url = url;\n        cmd = \"start iexplore.exe \\\"\" + open_url + \"\\\"\";\n        return exec(cmd, function(error, stdout, stderr) {\n          if (error) {\n            toastr.error(error);\n          }\n        });\n      } else {\n        return Steedos.openWindow(url);\n      }\n    }\n  };\n  Steedos.openApp = function(app_id) {\n    var app, cmd, e, evalFunString, exec, on_click, open_url, path;\n    if (!Meteor.userId()) {\n      Steedos.redirectToSignIn();\n      return true;\n    }\n    app = db.apps.findOne(app_id);\n    if (!app) {\n      FlowRouter.go(\"/\");\n      return;\n    }\n    on_click = app.on_click;\n    if (app.is_use_ie) {\n      if (Steedos.isNode()) {\n        exec = nw.require('child_process').exec;\n        if (on_click) {\n          path = \"api/app/sso/\" + app_id + \"?authToken=\" + (Accounts._storedLoginToken()) + \"&userId=\" + (Meteor.userId());\n          open_url = window.location.origin + \"/\" + path;\n        } else {\n          open_url = Steedos.getAppUrlWithToken(app_id);\n          open_url = window.location.origin + \"/\" + open_url;\n        }\n        cmd = \"start iexplore.exe \\\"\" + open_url + \"\\\"\";\n        exec(cmd, function(error, stdout, stderr) {\n          if (error) {\n            toastr.error(error);\n          }\n        });\n      } else {\n        Steedos.openAppWithToken(app_id);\n      }\n    } else if (db.apps.isInternalApp(app.url)) {\n      FlowRouter.go(app.url);\n    } else if (app.is_use_iframe) {\n      if (app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova()) {\n        Steedos.openWindow(Steedos.absoluteUrl(\"apps/iframe/\" + app._id));\n      } else if (Steedos.isMobile() || Steedos.isCordova()) {\n        Steedos.openAppWithToken(app_id);\n      } else {\n        FlowRouter.go(\"/apps/iframe/\" + app._id);\n      }\n    } else if (on_click) {\n      evalFunString = \"(function(){\" + on_click + \"})()\";\n      try {\n        eval(evalFunString);\n      } catch (error1) {\n        e = error1;\n        console.error(\"catch some error when eval the on_click script for app link:\");\n        console.error(e.message + \"\\r\\n\" + e.stack);\n      }\n    } else {\n      Steedos.openAppWithToken(app_id);\n    }\n    if (!app.is_new_window && !Steedos.isMobile() && !Steedos.isCordova() && !app.is_use_ie && !on_click) {\n      return Session.set(\"current_app_id\", app_id);\n    }\n  };\n  Steedos.checkSpaceBalance = function(spaceId) {\n    var end_date, min_months, space;\n    if (!spaceId) {\n      spaceId = Steedos.spaceId();\n    }\n    min_months = 1;\n    if (Steedos.isSpaceAdmin()) {\n      min_months = 3;\n    }\n    space = db.spaces.findOne(spaceId);\n    end_date = space != null ? space.end_date : void 0;\n    if ((space != null ? space.is_paid : void 0) && end_date !== void 0 && (end_date - new Date) <= (min_months * 30 * 24 * 3600 * 1000)) {\n      return toastr.error(t(\"space_balance_insufficient\"));\n    }\n  };\n  Steedos.setModalMaxHeight = function() {\n    var accountZoomValue, offset;\n    accountZoomValue = Steedos.getAccountZoomValue();\n    if (!accountZoomValue.name) {\n      accountZoomValue.name = 'large';\n    }\n    switch (accountZoomValue.name) {\n      case 'normal':\n        if (Steedos.isMobile()) {\n          offset = -12;\n        } else {\n          offset = 75;\n        }\n        break;\n      case 'large':\n        if (Steedos.isMobile()) {\n          offset = -6;\n        } else {\n          if (Steedos.detectIE()) {\n            offset = 199;\n          } else {\n            offset = 9;\n          }\n        }\n        break;\n      case 'extra-large':\n        if (Steedos.isMobile()) {\n          offset = -26;\n        } else {\n          if (Steedos.detectIE()) {\n            offset = 303;\n          } else {\n            offset = 53;\n          }\n        }\n    }\n    if ($(\".modal\").length) {\n      return $(\".modal\").each(function() {\n        var footerHeight, headerHeight, height, totalHeight;\n        headerHeight = 0;\n        footerHeight = 0;\n        totalHeight = 0;\n        $(\".modal-header\", $(this)).each(function() {\n          return headerHeight += $(this).outerHeight(false);\n        });\n        $(\".modal-footer\", $(this)).each(function() {\n          return footerHeight += $(this).outerHeight(false);\n        });\n        totalHeight = headerHeight + footerHeight;\n        height = $(\"body\").innerHeight() - totalHeight - offset;\n        if ($(this).hasClass(\"cf_contact_modal\")) {\n          return $(\".modal-body\", $(this)).css({\n            \"max-height\": height + \"px\",\n            \"height\": height + \"px\"\n          });\n        } else {\n          return $(\".modal-body\", $(this)).css({\n            \"max-height\": height + \"px\",\n            \"height\": \"auto\"\n          });\n        }\n      });\n    }\n  };\n  Steedos.getModalMaxHeight = function(offset) {\n    var accountZoomValue, reValue;\n    if (Steedos.isMobile()) {\n      reValue = window.screen.height - 126 - 180 - 25;\n    } else {\n      reValue = $(window).height() - 180 - 25;\n    }\n    if (!(Steedos.isiOS() || Steedos.isMobile())) {\n      accountZoomValue = Steedos.getAccountZoomValue();\n      switch (accountZoomValue.name) {\n        case 'large':\n          reValue -= 50;\n          break;\n        case 'extra-large':\n          reValue -= 145;\n      }\n    }\n    if (offset) {\n      reValue -= offset;\n    }\n    return reValue + \"px\";\n  };\n  Steedos.isiOS = function(userAgent, language) {\n    var DEVICE, browser, conExp, device, numExp;\n    DEVICE = {\n      android: 'android',\n      blackberry: 'blackberry',\n      desktop: 'desktop',\n      ipad: 'ipad',\n      iphone: 'iphone',\n      ipod: 'ipod',\n      mobile: 'mobile'\n    };\n    browser = {};\n    conExp = '(?:[\\\\/:\\\\::\\\\s:;])';\n    numExp = '(\\\\S+[^\\\\s:;:\\\\)]|)';\n    userAgent = (userAgent || navigator.userAgent).toLowerCase();\n    language = language || navigator.language || navigator.browserLanguage;\n    device = userAgent.match(new RegExp('(android|ipad|iphone|ipod|blackberry)')) || userAgent.match(new RegExp('(mobile)')) || ['', DEVICE.desktop];\n    browser.device = device[1];\n    return browser.device === DEVICE.ipad || browser.device === DEVICE.iphone || browser.device === DEVICE.ipod;\n  };\n  Steedos.getUserOrganizations = function(isIncludeParents) {\n    var organizations, parents, spaceId, space_user, userId;\n    userId = Meteor.userId();\n    spaceId = Steedos.spaceId();\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: spaceId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    organizations = space_user != null ? space_user.organizations : void 0;\n    if (!organizations) {\n      return [];\n    }\n    if (isIncludeParents) {\n      parents = _.flatten(db.organizations.find({\n        _id: {\n          $in: organizations\n        }\n      }).fetch().getProperty(\"parents\"));\n      return _.union(organizations, parents);\n    } else {\n      return organizations;\n    }\n  };\n  Steedos.forbidNodeContextmenu = function(target, ifr) {\n    if (!Steedos.isNode()) {\n      return;\n    }\n    target.document.body.addEventListener('contextmenu', function(ev) {\n      ev.preventDefault();\n      return false;\n    });\n    if (ifr) {\n      if (typeof ifr === 'string') {\n        ifr = target.$(ifr);\n      }\n      return ifr.load(function() {\n        var ifrBody;\n        ifrBody = ifr.contents().find('body');\n        if (ifrBody) {\n          return ifrBody[0].addEventListener('contextmenu', function(ev) {\n            ev.preventDefault();\n            return false;\n          });\n        }\n      });\n    }\n  };\n}\n\nif (Meteor.isServer) {\n  Steedos.getUserOrganizations = function(spaceId, userId, isIncludeParents) {\n    var organizations, parents, space_user;\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: spaceId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    organizations = space_user != null ? space_user.organizations : void 0;\n    if (!organizations) {\n      return [];\n    }\n    if (isIncludeParents) {\n      parents = _.flatten(db.organizations.find({\n        _id: {\n          $in: organizations\n        }\n      }).fetch().getProperty(\"parents\"));\n      return _.union(organizations, parents);\n    } else {\n      return organizations;\n    }\n  };\n}\n\nif (Meteor.isServer) {\n  Cookies = require(\"cookies\");\n  Steedos.isMobile = function() {\n    return false;\n  };\n  Steedos.isSpaceAdmin = function(spaceId, userId) {\n    var space;\n    if (!spaceId || !userId) {\n      return false;\n    }\n    space = db.spaces.findOne(spaceId);\n    if (!space || !space.admins) {\n      return false;\n    }\n    return space.admins.indexOf(userId) >= 0;\n  };\n  Steedos.isLegalVersion = function(spaceId, app_version) {\n    var check, modules, ref;\n    if (!spaceId) {\n      return false;\n    }\n    check = false;\n    modules = (ref = db.spaces.findOne(spaceId)) != null ? ref.modules : void 0;\n    if (modules && modules.includes(app_version)) {\n      check = true;\n    }\n    return check;\n  };\n  Steedos.isOrgAdminByOrgIds = function(orgIds, userId) {\n    var allowAccessOrgs, isOrgAdmin, parents, useOrgs;\n    isOrgAdmin = false;\n    useOrgs = db.organizations.find({\n      _id: {\n        $in: orgIds\n      }\n    }, {\n      fields: {\n        parents: 1,\n        admins: 1\n      }\n    }).fetch();\n    parents = [];\n    allowAccessOrgs = useOrgs.filter(function(org) {\n      var ref;\n      if (org.parents) {\n        parents = _.union(parents, org.parents);\n      }\n      return (ref = org.admins) != null ? ref.includes(userId) : void 0;\n    });\n    if (allowAccessOrgs.length) {\n      isOrgAdmin = true;\n    } else {\n      parents = _.flatten(parents);\n      parents = _.uniq(parents);\n      if (parents.length && db.organizations.findOne({\n        _id: {\n          $in: parents\n        },\n        admins: userId\n      })) {\n        isOrgAdmin = true;\n      }\n    }\n    return isOrgAdmin;\n  };\n  Steedos.isOrgAdminByAllOrgIds = function(orgIds, userId) {\n    var i, isOrgAdmin;\n    if (!orgIds.length) {\n      return true;\n    }\n    i = 0;\n    while (i < orgIds.length) {\n      isOrgAdmin = Steedos.isOrgAdminByOrgIds([orgIds[i]], userId);\n      if (!isOrgAdmin) {\n        break;\n      }\n      i++;\n    }\n    return isOrgAdmin;\n  };\n  Steedos.absoluteUrl = function(url) {\n    var e, root_url;\n    if (url) {\n      url = url.replace(/^\\//, \"\");\n    }\n    if (Meteor.isCordova) {\n      return Meteor.absoluteUrl(url);\n    } else {\n      if (Meteor.isClient) {\n        try {\n          root_url = new URL(Meteor.absoluteUrl());\n          if (url) {\n            return root_url.pathname + url;\n          } else {\n            return root_url.pathname;\n          }\n        } catch (error1) {\n          e = error1;\n          return Meteor.absoluteUrl(url);\n        }\n      } else {\n        return Meteor.absoluteUrl(url);\n      }\n    }\n  };\n  Steedos.getAPILoginUser = function(req, res) {\n    var authToken, cookies, password, ref, ref1, ref2, ref3, result, user, userId, username;\n    username = (ref = req.query) != null ? ref.username : void 0;\n    password = (ref1 = req.query) != null ? ref1.password : void 0;\n    if (username && password) {\n      user = db.users.findOne({\n        steedos_id: username\n      });\n      if (!user) {\n        return false;\n      }\n      result = Accounts._checkPassword(user, password);\n      if (result.error) {\n        throw new Error(result.error);\n      } else {\n        return user;\n      }\n    }\n    userId = (ref2 = req.query) != null ? ref2[\"X-User-Id\"] : void 0;\n    authToken = (ref3 = req.query) != null ? ref3[\"X-Auth-Token\"] : void 0;\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return db.users.findOne({\n        _id: userId\n      });\n    }\n    cookies = new Cookies(req, res);\n    if (req.headers) {\n      userId = req.headers[\"x-user-id\"];\n      authToken = req.headers[\"x-auth-token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!userId || !authToken) {\n      return false;\n    }\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return db.users.findOne({\n        _id: userId\n      });\n    }\n    return false;\n  };\n  Steedos.checkAuthToken = function(userId, authToken) {\n    var hashedToken, user;\n    if (userId && authToken) {\n      hashedToken = Accounts._hashLoginToken(authToken);\n      user = Meteor.users.findOne({\n        _id: userId,\n        \"services.resume.loginTokens.hashedToken\": hashedToken\n      });\n      if (user) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n    return false;\n  };\n}\n\nif (Meteor.isServer) {\n  crypto = require('crypto');\n  Steedos.decrypt = function(password, key, iv) {\n    var c, decipher, decipherMsg, e, i, key32, len, m;\n    try {\n      key32 = \"\";\n      len = key.length;\n      if (len < 32) {\n        c = \"\";\n        i = 0;\n        m = 32 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key32 = key + c;\n      } else if (len >= 32) {\n        key32 = key.slice(0, 32);\n      }\n      decipher = crypto.createDecipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n      decipherMsg = Buffer.concat([decipher.update(password, 'base64'), decipher.final()]);\n      password = decipherMsg.toString();\n      return password;\n    } catch (error1) {\n      e = error1;\n      return password;\n    }\n  };\n  Steedos.encrypt = function(password, key, iv) {\n    var c, cipher, cipheredMsg, i, key32, len, m;\n    key32 = \"\";\n    len = key.length;\n    if (len < 32) {\n      c = \"\";\n      i = 0;\n      m = 32 - len;\n      while (i < m) {\n        c = \" \" + c;\n        i++;\n      }\n      key32 = key + c;\n    } else if (len >= 32) {\n      key32 = key.slice(0, 32);\n    }\n    cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n    cipheredMsg = Buffer.concat([cipher.update(new Buffer(password, 'utf8')), cipher.final()]);\n    password = cipheredMsg.toString('base64');\n    return password;\n  };\n  Steedos.getUserIdFromAccessToken = function(access_token) {\n    var collection, hashedToken, obj, user, userId;\n    if (!access_token) {\n      return null;\n    }\n    userId = access_token.split(\"-\")[0];\n    hashedToken = Accounts._hashLoginToken(access_token);\n    user = db.users.findOne({\n      _id: userId,\n      \"secrets.hashedToken\": hashedToken\n    });\n    if (user) {\n      return userId;\n    } else {\n      collection = oAuth2Server.collections.accessToken;\n      obj = collection.findOne({\n        'accessToken': access_token\n      });\n      if (obj) {\n        if ((obj != null ? obj.expires : void 0) < new Date()) {\n          return \"oauth2 access token:\" + access_token + \" is expired.\";\n        } else {\n          return obj != null ? obj.userId : void 0;\n        }\n      } else {\n        return \"oauth2 access token:\" + access_token + \" is not found.\";\n      }\n    }\n    return null;\n  };\n  Steedos.getUserIdFromAuthToken = function(req, res) {\n    var authToken, cookies, ref, ref1, ref2, ref3, userId;\n    userId = (ref = req.query) != null ? ref[\"X-User-Id\"] : void 0;\n    authToken = (ref1 = req.query) != null ? ref1[\"X-Auth-Token\"] : void 0;\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return (ref2 = db.users.findOne({\n        _id: userId\n      })) != null ? ref2._id : void 0;\n    }\n    cookies = new Cookies(req, res);\n    if (req.headers) {\n      userId = req.headers[\"x-user-id\"];\n      authToken = req.headers[\"x-auth-token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!userId || !authToken) {\n      return null;\n    }\n    if (Steedos.checkAuthToken(userId, authToken)) {\n      return (ref3 = db.users.findOne({\n        _id: userId\n      })) != null ? ref3._id : void 0;\n    }\n  };\n  Steedos.APIAuthenticationCheck = function(req, res) {\n    var e, user, userId;\n    try {\n      userId = req.userId;\n      user = db.users.findOne({\n        _id: userId\n      });\n      if (!userId || !user) {\n        JsonRoutes.sendResult(res, {\n          data: {\n            \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id Or access_token\"\n          },\n          code: 401\n        });\n        return false;\n      } else {\n        return true;\n      }\n    } catch (error1) {\n      e = error1;\n      if (!userId || !user) {\n        JsonRoutes.sendResult(res, {\n          code: 401,\n          data: {\n            \"error\": e.message,\n            \"success\": false\n          }\n        });\n        return false;\n      }\n    }\n  };\n}\n\nmixin = function(obj) {\n  return _.each(_.functions(obj), function(name) {\n    var func;\n    if (!_[name] && (_.prototype[name] == null)) {\n      func = _[name] = obj[name];\n      return _.prototype[name] = function() {\n        var args;\n        args = [this._wrapped];\n        push.apply(args, arguments);\n        return result.call(this, func.apply(_, args));\n      };\n    }\n  });\n};\n\nif (Meteor.isServer) {\n  Steedos.isHoliday = function(date) {\n    var day;\n    if (!date) {\n      date = new Date;\n    }\n    check(date, Date);\n    day = date.getDay();\n    if (day === 6 || day === 0) {\n      return true;\n    }\n    return false;\n  };\n  Steedos.caculateWorkingTime = function(date, days) {\n    var caculateDate, param_date;\n    check(date, Date);\n    check(days, Number);\n    param_date = new Date(date);\n    caculateDate = function(i, days) {\n      if (i < days) {\n        param_date = new Date(param_date.getTime() + 24 * 60 * 60 * 1000);\n        if (!Steedos.isHoliday(param_date)) {\n          i++;\n        }\n        caculateDate(i, days);\n      }\n    };\n    caculateDate(0, days);\n    return param_date;\n  };\n  Steedos.caculatePlusHalfWorkingDay = function(date, next) {\n    var caculated_date, end_date, first_date, i, j, len, max_index, ref, second_date, start_date, time_points;\n    check(date, Date);\n    time_points = (ref = Meteor.settings.remind) != null ? ref.time_points : void 0;\n    if (!time_points || _.isEmpty(time_points)) {\n      console.error(\"time_points is null\");\n      time_points = [\n        {\n          \"hour\": 8,\n          \"minute\": 30\n        }, {\n          \"hour\": 14,\n          \"minute\": 30\n        }\n      ];\n    }\n    len = time_points.length;\n    start_date = new Date(date);\n    end_date = new Date(date);\n    start_date.setHours(time_points[0].hour);\n    start_date.setMinutes(time_points[0].minute);\n    end_date.setHours(time_points[len - 1].hour);\n    end_date.setMinutes(time_points[len - 1].minute);\n    caculated_date = new Date(date);\n    j = 0;\n    max_index = len - 1;\n    if (date < start_date) {\n      if (next) {\n        j = 0;\n      } else {\n        j = len / 2;\n      }\n    } else if (date >= start_date && date < end_date) {\n      i = 0;\n      while (i < max_index) {\n        first_date = new Date(date);\n        second_date = new Date(date);\n        first_date.setHours(time_points[i].hour);\n        first_date.setMinutes(time_points[i].minute);\n        second_date.setHours(time_points[i + 1].hour);\n        second_date.setMinutes(time_points[i + 1].minute);\n        if (date >= first_date && date < second_date) {\n          break;\n        }\n        i++;\n      }\n      if (next) {\n        j = i + 1;\n      } else {\n        j = i + len / 2;\n      }\n    } else if (date >= end_date) {\n      if (next) {\n        j = max_index + 1;\n      } else {\n        j = max_index + len / 2;\n      }\n    }\n    if (j > max_index) {\n      caculated_date = Steedos.caculateWorkingTime(date, 1);\n      caculated_date.setHours(time_points[j - max_index - 1].hour);\n      caculated_date.setMinutes(time_points[j - max_index - 1].minute);\n    } else if (j <= max_index) {\n      caculated_date.setHours(time_points[j].hour);\n      caculated_date.setMinutes(time_points[j].minute);\n    }\n    return caculated_date;\n  };\n}\n\nif (Meteor.isServer) {\n  _.extend(Steedos, {\n    getSteedosToken: function(appId, userId, authToken) {\n      var app, c, cipher, cipheredMsg, hashedToken, i, iv, key32, len, m, now, secret, steedos_id, steedos_token, user;\n      crypto = require('crypto');\n      app = db.apps.findOne(appId);\n      if (app) {\n        secret = app.secret;\n      }\n      if (userId && authToken) {\n        hashedToken = Accounts._hashLoginToken(authToken);\n        user = Meteor.users.findOne({\n          _id: userId,\n          \"services.resume.loginTokens.hashedToken\": hashedToken\n        });\n        if (user) {\n          steedos_id = user.steedos_id;\n          if (app.secret) {\n            iv = app.secret;\n          } else {\n            iv = \"-8762-fcb369b2e8\";\n          }\n          now = parseInt(new Date().getTime() / 1000).toString();\n          key32 = \"\";\n          len = steedos_id.length;\n          if (len < 32) {\n            c = \"\";\n            i = 0;\n            m = 32 - len;\n            while (i < m) {\n              c = \" \" + c;\n              i++;\n            }\n            key32 = steedos_id + c;\n          } else if (len >= 32) {\n            key32 = steedos_id.slice(0, 32);\n          }\n          cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n          cipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()]);\n          steedos_token = cipheredMsg.toString('base64');\n        }\n      }\n      return steedos_token;\n    },\n    locale: function(userId, isI18n) {\n      var locale, user;\n      user = db.users.findOne({\n        _id: userId\n      }, {\n        fields: {\n          locale: 1\n        }\n      });\n      locale = user != null ? user.locale : void 0;\n      if (isI18n) {\n        if (locale === \"en-us\") {\n          locale = \"en\";\n        }\n        if (locale === \"zh-cn\") {\n          locale = \"zh-CN\";\n        }\n      }\n      return locale;\n    },\n    checkUsernameAvailability: function(username) {\n      return !Meteor.users.findOne({\n        username: {\n          $regex: new RegExp(\"^\" + Meteor._escapeRegExp(username).trim() + \"$\", \"i\")\n        }\n      });\n    },\n    validatePassword: function(pwd) {\n      var passworPolicy, passworPolicyError, reason, ref, ref1, ref2, ref3, valid;\n      reason = t(\"password_invalid\");\n      valid = true;\n      if (!pwd) {\n        valid = false;\n      }\n      passworPolicy = (ref = Meteor.settings[\"public\"]) != null ? (ref1 = ref.password) != null ? ref1.policy : void 0 : void 0;\n      passworPolicyError = (ref2 = Meteor.settings[\"public\"]) != null ? (ref3 = ref2.password) != null ? ref3.policyError : void 0 : void 0;\n      if (passworPolicy) {\n        if (!(new RegExp(passworPolicy)).test(pwd || '')) {\n          reason = passworPolicyError;\n          valid = false;\n        } else {\n          valid = true;\n        }\n      }\n      if (valid) {\n        return true;\n      } else {\n        return {\n          error: {\n            reason: reason\n          }\n        };\n      }\n    }\n  });\n}\n\nSteedos.convertSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\");\n};\n\nSteedos.removeSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}\\~\\`\\@\\#\\%\\&\\=\\'\\\"\\:\\;\\<\\>\\,\\/])/g, \"\");\n};\n\nCreator.getDBApps = function(space_id) {\n  var dbApps;\n  dbApps = {};\n  Creator.Collections[\"apps\"].find({\n    space: space_id,\n    is_creator: true,\n    visible: true\n  }, {\n    fields: {\n      created: 0,\n      created_by: 0,\n      modified: 0,\n      modified_by: 0\n    }\n  }).forEach(function(app) {\n    return dbApps[app._id] = app;\n  });\n  return dbApps;\n};\n\nCreator.getDBDashboards = function(space_id) {\n  var dbDashboards;\n  dbDashboards = {};\n  Creator.Collections[\"dashboard\"].find({\n    space: space_id\n  }, {\n    fields: {\n      created: 0,\n      created_by: 0,\n      modified: 0,\n      modified_by: 0\n    }\n  }).forEach(function(dashboard) {\n    return dbDashboards[dashboard._id] = dashboard;\n  });\n  return dbDashboards;\n};\n\nif (Meteor.isServer) {\n  Cookies = require(\"cookies\");\n  Steedos.getAuthToken = function(req, res) {\n    var authToken, cookies;\n    cookies = new Cookies(req, res);\n    authToken = req.headers['x-auth-token'] || cookies.get(\"X-Auth-Token\");\n    if (!authToken && req.headers.authorization && req.headers.authorization.split(' ')[0] === 'Bearer') {\n      authToken = req.headers.authorization.split(' ')[1];\n    }\n    return authToken;\n  };\n}\n\nif (Meteor.isClient) {\n  Meteor.autorun(function() {\n    if (Session.get('current_app_id')) {\n      return sessionStorage.setItem('current_app_id', Session.get('current_app_id'));\n    }\n  });\n  Steedos.getCurrentAppId = function() {\n    if (Session.get('current_app_id')) {\n      return Session.get('current_app_id');\n    } else {\n      return sessionStorage.getItem('current_app_id');\n    }\n  };\n}\n","Meteor.startup(function () {\r\n\tSimpleSchema.extendOptions({foreign_key: Match.Optional(Boolean), references: Match.Optional(Object)});\r\n})","if Meteor.isServer\r\n        Meteor.methods\r\n                updateUserLastLogon: () ->\r\n                        if not @userId?\r\n                                return\r\n\r\n                        db.users.update({_id: @userId}, {$set: {last_logon: new Date()}})  \r\n\r\n\r\nif Meteor.isClient\r\n        Accounts.onLogin ()->\r\n            Meteor.call 'updateUserLastLogon'","if (Meteor.isServer) {\n  Meteor.methods({\n    updateUserLastLogon: function() {\n      if (this.userId == null) {\n        return;\n      }\n      return db.users.update({\n        _id: this.userId\n      }, {\n        $set: {\n          last_logon: new Date()\n        }\n      });\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  Accounts.onLogin(function() {\n    return Meteor.call('updateUserLastLogon');\n  });\n}\n","if Meteor.isServer\r\n  Meteor.methods\r\n    users_add_email: (email) ->\r\n      if not @userId?\r\n        return {error: true, message: \"email_login_required\"}\r\n      if not email\r\n        return {error: true, message: \"email_required\"}\r\n      if not /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)\r\n        return {error: true, message: \"email_format_error\"}\r\n      if db.users.find({\"emails.address\": email}).count()>0\r\n        return {error: true, message: \"email_exists\"}\r\n\r\n      user = db.users.findOne(_id: this.userId)\r\n      if user.emails? and user.emails.length > 0 \r\n        db.users.direct.update {_id: this.userId}, \r\n          $push: \r\n            emails: \r\n              address: email\r\n              verified: false\r\n      else\r\n        db.users.direct.update {_id: this.userId}, \r\n          $set: \r\n            steedos_id: email\r\n            emails: [\r\n              address: email\r\n              verified: false\r\n            ]\r\n\r\n      Accounts.sendVerificationEmail(this.userId, email);\r\n\r\n      return {}\r\n\r\n    users_remove_email: (email) ->\r\n      if not @userId?\r\n        return {error: true, message: \"email_login_required\"}\r\n      if not email\r\n        return {error: true, message: \"email_required\"}\r\n\r\n      user = db.users.findOne(_id: this.userId)\r\n      if user.emails? and user.emails.length >= 2\r\n        p = null\r\n        user.emails.forEach (e)->\r\n          if e.address == email\r\n            p = e\r\n            return\r\n        \r\n        db.users.direct.update {_id: this.userId}, \r\n          $pull: \r\n            emails: \r\n              p\r\n      else\r\n        return {error: true, message: \"email_at_least_one\"}\r\n\r\n      return {}\r\n\r\n    users_verify_email: (email) ->\r\n      if not @userId?\r\n        return {error: true, message: \"email_login_required\"}\r\n      if not email\r\n        return {error: true, message: \"email_required\"}\r\n      if not /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)\r\n        return {error: true, message: \"email_format_error\"}\r\n      \r\n\r\n      Accounts.sendVerificationEmail(this.userId, email);\r\n\r\n      return {}\r\n\r\n    users_set_primary_email: (email) ->\r\n      if not @userId?\r\n        return {error: true, message: \"email_login_required\"}\r\n      if not email\r\n        return {error: true, message: \"email_required\"}\r\n\r\n      user = db.users.findOne(_id: this.userId)\r\n      emails = user.emails\r\n      emails.forEach (e)->\r\n        if e.address == email\r\n          e.primary = true\r\n        else\r\n          e.primary = false\r\n\r\n      db.users.direct.update {_id: this.userId},\r\n        $set:\r\n          emails: emails\r\n          email: email\r\n\r\n      db.space_users.direct.update({user: this.userId},{$set: {email: email}}, {multi: true})\r\n      return {}\r\n\r\n\r\n\r\nif Meteor.isClient\r\n    Steedos.users_add_email = ()->\r\n        swal\r\n            title: t(\"primary_email_needed\"),\r\n            text: t(\"primary_email_needed_description\"),\r\n            type: 'input',\r\n            showCancelButton: false,\r\n            closeOnConfirm: false,\r\n            animation: \"slide-from-top\"\r\n        , (inputValue) ->\r\n            Meteor.call \"users_add_email\", inputValue, (error, result)->\r\n                if result?.error\r\n                    toastr.error result.message\r\n                else\r\n                    swal t(\"primary_email_updated\"), \"\", \"success\"\r\n###\r\n    Tracker.autorun (c) ->\r\n\r\n        if Meteor.user()\r\n          if Meteor.loggingIn()\r\n            # 正在登录中，则不做处理，因为此时Meteor.userId()不足于证明已登录状态\r\n            return\r\n          primaryEmail = Meteor.user().emails?[0]?.address\r\n          if !primaryEmail\r\n              Steedos.users_add_email();\r\n###","if (Meteor.isServer) {\n  Meteor.methods({\n    users_add_email: function(email) {\n      var user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      if (!/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)) {\n        return {\n          error: true,\n          message: \"email_format_error\"\n        };\n      }\n      if (db.users.find({\n        \"emails.address\": email\n      }).count() > 0) {\n        return {\n          error: true,\n          message: \"email_exists\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      if ((user.emails != null) && user.emails.length > 0) {\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $push: {\n            emails: {\n              address: email,\n              verified: false\n            }\n          }\n        });\n      } else {\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $set: {\n            steedos_id: email,\n            emails: [\n              {\n                address: email,\n                verified: false\n              }\n            ]\n          }\n        });\n      }\n      Accounts.sendVerificationEmail(this.userId, email);\n      return {};\n    },\n    users_remove_email: function(email) {\n      var p, user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      if ((user.emails != null) && user.emails.length >= 2) {\n        p = null;\n        user.emails.forEach(function(e) {\n          if (e.address === email) {\n            p = e;\n          }\n        });\n        db.users.direct.update({\n          _id: this.userId\n        }, {\n          $pull: {\n            emails: p\n          }\n        });\n      } else {\n        return {\n          error: true,\n          message: \"email_at_least_one\"\n        };\n      }\n      return {};\n    },\n    users_verify_email: function(email) {\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      if (!/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(email)) {\n        return {\n          error: true,\n          message: \"email_format_error\"\n        };\n      }\n      Accounts.sendVerificationEmail(this.userId, email);\n      return {};\n    },\n    users_set_primary_email: function(email) {\n      var emails, user;\n      if (this.userId == null) {\n        return {\n          error: true,\n          message: \"email_login_required\"\n        };\n      }\n      if (!email) {\n        return {\n          error: true,\n          message: \"email_required\"\n        };\n      }\n      user = db.users.findOne({\n        _id: this.userId\n      });\n      emails = user.emails;\n      emails.forEach(function(e) {\n        if (e.address === email) {\n          return e.primary = true;\n        } else {\n          return e.primary = false;\n        }\n      });\n      db.users.direct.update({\n        _id: this.userId\n      }, {\n        $set: {\n          emails: emails,\n          email: email\n        }\n      });\n      db.space_users.direct.update({\n        user: this.userId\n      }, {\n        $set: {\n          email: email\n        }\n      }, {\n        multi: true\n      });\n      return {};\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  Steedos.users_add_email = function() {\n    return swal({\n      title: t(\"primary_email_needed\"),\n      text: t(\"primary_email_needed_description\"),\n      type: 'input',\n      showCancelButton: false,\n      closeOnConfirm: false,\n      animation: \"slide-from-top\"\n    }, function(inputValue) {\n      return Meteor.call(\"users_add_email\", inputValue, function(error, result) {\n        if (result != null ? result.error : void 0) {\n          return toastr.error(result.message);\n        } else {\n          return swal(t(\"primary_email_updated\"), \"\", \"success\");\n        }\n      });\n    });\n  };\n}\n\n\n/*\n    Tracker.autorun (c) ->\n\n        if Meteor.user()\n          if Meteor.loggingIn()\n             * 正在登录中，则不做处理，因为此时Meteor.userId()不足于证明已登录状态\n            return\n          primaryEmail = Meteor.user().emails?[0]?.address\n          if !primaryEmail\n              Steedos.users_add_email();\n */\n","if Meteor.isServer\r\n    Meteor.methods\r\n        updateUserAvatar: (avatar) ->\r\n                if not @userId?\r\n                        return\r\n\r\n                db.users.update({_id: @userId}, {$set: {avatar: avatar}})  ","if (Meteor.isServer) {\n  Meteor.methods({\n    updateUserAvatar: function(avatar) {\n      if (this.userId == null) {\n        return;\n      }\n      return db.users.update({\n        _id: this.userId\n      }, {\n        $set: {\n          avatar: avatar\n        }\n      });\n    }\n  });\n}\n","Accounts.emailTemplates = {\r\n\tfrom: (function(){\r\n\t\tvar defaultFrom = \"Steedos <noreply@message.steedos.com>\";\r\n\t\tif(!Meteor.settings)\r\n\t\t\treturn defaultFrom;\r\n\t\t\r\n\t\tif(!Meteor.settings.email)\r\n\t\t\treturn defaultFrom;\r\n\r\n\t\tif(!Meteor.settings.email.from)\r\n\t\t\treturn defaultFrom;\r\n\t\t\r\n\t\treturn Meteor.settings.email.from;\r\n\t})(),\r\n\tresetPassword: {\r\n\t\tsubject: function (user) {\r\n\t\t\treturn TAPi18n.__(\"users_email_reset_password\",{},user.locale);\r\n\t\t},\r\n\t\ttext: function (user, url) {\r\n\t\t\tvar splits = url.split(\"/\");\r\n\t\t\tvar tokenCode = splits[splits.length-1];\r\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\r\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_reset_password_body\",{token_code:tokenCode},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\r\n\t\t}\r\n\t},\r\n\tverifyEmail: {\r\n\t\tsubject: function (user) {\r\n\t\t\treturn TAPi18n.__(\"users_email_verify_email\",{},user.locale);\r\n\t\t},\r\n\t\ttext: function (user, url) {\r\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\r\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_verify_account\",{},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\r\n\t\t}\r\n\t},\r\n\tenrollAccount: {\r\n\t\tsubject: function (user) {\r\n\t\t\treturn TAPi18n.__(\"users_email_create_account\",{},user.locale);\r\n\t\t},\r\n\t\ttext: function (user, url) {\r\n\t\t\tvar greeting = user.profile && user.profile.name ? TAPi18n.__(\"users_email_hello\",{},user.locale) + user.profile.name + \",\" : TAPi18n.__(\"users_email_hello\",{},user.locale) + \",\";\r\n\t\t\treturn greeting + \"\\n\\n\" + TAPi18n.__(\"users_email_start_service\",{},user.locale) + \"\\n\\n\" + url + \"\\n\\n\" + TAPi18n.__(\"users_email_thanks\",{},user.locale) + \"\\n\";\r\n\t\t}\r\n\t}\r\n};","// 修改fullname值有问题的organizations\r\nJsonRoutes.add(\"get\", \"/api/organizations/upgrade/\", function (req, res, next) {\r\n  \r\n\tvar orgs = db.organizations.find({fullname:/新部门/,name:{$ne:\"新部门\"}});\r\n\tif (orgs.count()>0)\r\n\t{\r\n\t\torgs.forEach (function (org)\r\n\t\t{\r\n\t\t\t// 自己和子部门的fullname修改\r\n\t\t\tdb.organizations.direct.update(org._id, {$set: {fullname: org.calculateFullname()}});\r\n\t\t\t\r\n\t\t});\r\n\t}\t\r\n\r\n  \tJsonRoutes.sendResult(res, {\r\n    \tdata: {\r\n\t      \tret: 0,\r\n\t      \tmsg: \"Successfully\"\r\n    \t}\r\n  \t});\r\n});\r\n\r\n","if Meteor.isCordova\r\n        Meteor.startup ->\r\n                Push.Configure\r\n                        android:\r\n                                senderID: window.ANDROID_SENDER_ID\r\n                                sound: true\r\n                                vibrate: true\r\n                        ios:\r\n                                badge: true\r\n                                clearBadge: true\r\n                                sound: true\r\n                                alert: true\r\n                        appName: \"workflow\"\r\n","if (Meteor.isCordova) {\n  Meteor.startup(function() {\n    return Push.Configure({\n      android: {\n        senderID: window.ANDROID_SENDER_ID,\n        sound: true,\n        vibrate: true\n      },\n      ios: {\n        badge: true,\n        clearBadge: true,\n        sound: true,\n        alert: true\n      },\n      appName: \"workflow\"\n    });\n  });\n}\n","Selector = {}\r\n\r\n# Filter data on server by space field\r\nSelector.selectorCheckSpaceAdmin = (userId) ->\r\n\tif Meteor.isClient\r\n\t\tuserId = Meteor.userId()\r\n\t\tunless userId\r\n\t\t\treturn {_id: -1}\r\n\t\tif Steedos.isSpaceAdmin()\r\n\t\t\treturn {space: Session.get(\"spaceId\")}\r\n\t\telse\r\n\t\t\treturn {_id: -1}\r\n\r\n\tif Meteor.isServer\r\n\t\tunless userId\r\n\t\t\treturn {_id: -1}\r\n\t\tuser = db.users.findOne(userId, {fields: {is_cloudadmin: 1}})\r\n\t\tif !user\r\n\t\t\treturn {_id: -1}\r\n\t\tselector = {}\r\n\t\tif !user.is_cloudadmin\r\n\t\t\tspaces = db.spaces.find({admins:{$in:[userId]}}, {fields: {_id: 1}}).fetch()\r\n\t\t\tspaces = spaces.map (n) -> return n._id\r\n\t\t\tselector.space = {$in: spaces}\r\n\t\treturn selector\r\n\r\n# Filter data on server by space field\r\nSelector.selectorCheckSpace = (userId) ->\r\n\tif Meteor.isClient\r\n\t\tuserId = Meteor.userId()\r\n\t\tunless userId\r\n\t\t\treturn {_id: -1}\r\n\t\tspaceId = Session.get(\"spaceId\");\r\n\t\tif spaceId\r\n\t\t\tif db.space_users.findOne({user: userId,space: spaceId}, {fields: {_id: 1}})\r\n\t\t\t\treturn {space: spaceId}\r\n\t\t\telse\r\n\t\t\t\treturn {_id: -1}\r\n\t\telse\r\n\t\t\treturn {_id: -1}\r\n\r\n\tif Meteor.isServer\r\n\t\tunless userId\r\n\t\t\treturn {_id: -1}\r\n\t\tuser = db.users.findOne(userId, {fields: {_id: 1}})\r\n\t\tif !user\r\n\t\t\treturn {_id: -1}\r\n\t\tselector = {}\r\n\t\tspace_users = db.space_users.find({user: userId}, {fields: {space: 1}}).fetch()\r\n\t\tspaces = []\r\n\t\t_.each space_users, (u)->\r\n\t\t\tspaces.push(u.space)\r\n\t\tselector.space = {$in: spaces}\r\n\t\treturn selector\r\n\r\ndb.billing_pay_records.adminConfig =\r\n\ticon: \"globe\"\r\n\tcolor: \"blue\"\r\n\ttableColumns: [\r\n\t\t{name: \"order_created()\"},\r\n\t\t{name: \"modules\"},\r\n\t\t{name: \"user_count\"},\r\n\t\t{name: \"end_date\"},\r\n\t\t{name: \"order_total_fee()\"},\r\n\t\t{name: \"order_paid()\"}\r\n\t]\r\n\textraFields: [\"space\", \"created\", \"paid\", \"total_fee\"]\r\n\trouterAdmin: \"/admin\"\r\n\tselector: (userId) ->\r\n\t\tif Meteor.isClient\r\n\t\t\tif Steedos.isSpaceAdmin()\r\n\t\t\t\treturn {space: Session.get(\"spaceId\"), paid: true}\r\n\t\t\telse\r\n\t\t\t\treturn {_id: -1}\r\n\r\n\t\tif Meteor.isServer\r\n\t\t\treturn {}\r\n\tshowEditColumn: false\r\n\tshowDelColumn: false\r\n\tdisableAdd: true\r\n\tpageLength: 100\r\n\torder: [[0, \"desc\"]]\r\n\r\nMeteor.startup ->\r\n\t@space_user_signs = db.space_user_signs\r\n\t@billing_pay_records = db.billing_pay_records\r\n\tAdminConfig?.collections_add\r\n\t\tspace_user_signs: db.space_user_signs.adminConfig\r\n\t\tbilling_pay_records: db.billing_pay_records.adminConfig","             \n\nSelector = {};\n\nSelector.selectorCheckSpaceAdmin = function(userId) {\n  var selector, spaces, user;\n  if (Meteor.isClient) {\n    userId = Meteor.userId();\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    if (Steedos.isSpaceAdmin()) {\n      return {\n        space: Session.get(\"spaceId\")\n      };\n    } else {\n      return {\n        _id: -1\n      };\n    }\n  }\n  if (Meteor.isServer) {\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    user = db.users.findOne(userId, {\n      fields: {\n        is_cloudadmin: 1\n      }\n    });\n    if (!user) {\n      return {\n        _id: -1\n      };\n    }\n    selector = {};\n    if (!user.is_cloudadmin) {\n      spaces = db.spaces.find({\n        admins: {\n          $in: [userId]\n        }\n      }, {\n        fields: {\n          _id: 1\n        }\n      }).fetch();\n      spaces = spaces.map(function(n) {\n        return n._id;\n      });\n      selector.space = {\n        $in: spaces\n      };\n    }\n    return selector;\n  }\n};\n\nSelector.selectorCheckSpace = function(userId) {\n  var selector, spaceId, space_users, spaces, user;\n  if (Meteor.isClient) {\n    userId = Meteor.userId();\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    spaceId = Session.get(\"spaceId\");\n    if (spaceId) {\n      if (db.space_users.findOne({\n        user: userId,\n        space: spaceId\n      }, {\n        fields: {\n          _id: 1\n        }\n      })) {\n        return {\n          space: spaceId\n        };\n      } else {\n        return {\n          _id: -1\n        };\n      }\n    } else {\n      return {\n        _id: -1\n      };\n    }\n  }\n  if (Meteor.isServer) {\n    if (!userId) {\n      return {\n        _id: -1\n      };\n    }\n    user = db.users.findOne(userId, {\n      fields: {\n        _id: 1\n      }\n    });\n    if (!user) {\n      return {\n        _id: -1\n      };\n    }\n    selector = {};\n    space_users = db.space_users.find({\n      user: userId\n    }, {\n      fields: {\n        space: 1\n      }\n    }).fetch();\n    spaces = [];\n    _.each(space_users, function(u) {\n      return spaces.push(u.space);\n    });\n    selector.space = {\n      $in: spaces\n    };\n    return selector;\n  }\n};\n\ndb.billing_pay_records.adminConfig = {\n  icon: \"globe\",\n  color: \"blue\",\n  tableColumns: [\n    {\n      name: \"order_created()\"\n    }, {\n      name: \"modules\"\n    }, {\n      name: \"user_count\"\n    }, {\n      name: \"end_date\"\n    }, {\n      name: \"order_total_fee()\"\n    }, {\n      name: \"order_paid()\"\n    }\n  ],\n  extraFields: [\"space\", \"created\", \"paid\", \"total_fee\"],\n  routerAdmin: \"/admin\",\n  selector: function(userId) {\n    if (Meteor.isClient) {\n      if (Steedos.isSpaceAdmin()) {\n        return {\n          space: Session.get(\"spaceId\"),\n          paid: true\n        };\n      } else {\n        return {\n          _id: -1\n        };\n      }\n    }\n    if (Meteor.isServer) {\n      return {};\n    }\n  },\n  showEditColumn: false,\n  showDelColumn: false,\n  disableAdd: true,\n  pageLength: 100,\n  order: [[0, \"desc\"]]\n};\n\nMeteor.startup(function() {\n  this.space_user_signs = db.space_user_signs;\n  this.billing_pay_records = db.billing_pay_records;\n  return typeof AdminConfig !== \"undefined\" && AdminConfig !== null ? AdminConfig.collections_add({\n    space_user_signs: db.space_user_signs.adminConfig,\n    billing_pay_records: db.billing_pay_records.adminConfig\n  }) : void 0;\n});\n","if (![].includes) {\r\n  Array.prototype.includes = function(searchElement /*, fromIndex*/ ) {\r\n    'use strict';\r\n    var O = Object(this);\r\n    var len = parseInt(O.length) || 0;\r\n    if (len === 0) {\r\n      return false;\r\n    }\r\n    var n = parseInt(arguments[1]) || 0;\r\n    var k;\r\n    if (n >= 0) {\r\n      k = n;\r\n    } else {\r\n      k = len + n;\r\n      if (k < 0) {k = 0;}\r\n    }\r\n    var currentElement;\r\n    while (k < len) {\r\n      currentElement = O[k];\r\n      if (searchElement === currentElement ||\r\n         (searchElement !== searchElement && currentElement !== currentElement)) {\r\n        return true;\r\n      }\r\n      k++;\r\n    }\r\n    return false;\r\n  };\r\n}","Meteor.startup ->\r\n  Steedos.settings.webservices = Meteor.settings.public.webservices\r\n\r\n  if !Steedos.settings.webservices\r\n    Steedos.settings.webservices =\r\n      www: \r\n        status: \"active\",\r\n        url: \"/\"","Meteor.startup(function() {\n  Steedos.settings.webservices = Meteor.settings[\"public\"].webservices;\n  if (!Steedos.settings.webservices) {\n    return Steedos.settings.webservices = {\n      www: {\n        status: \"active\",\n        url: \"/\"\n      }\n    };\n  }\n});\n","Creator.getUserObjectsListViews = (userId, spaceId, objects)->\r\n\tlistViews = {}\r\n\r\n\tkeys = _.keys(objects)\r\n\r\n\tobjectsViews = Creator.getCollection(\"object_listviews\").find({\r\n\t\tobject_name: {$in: keys},\r\n\t\tspace: spaceId,\r\n\t\t\"$or\": [{owner: userId}, {shared: true}]\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\tcreated: 0,\r\n\t\t\tmodified: 0,\r\n\t\t\tcreated_by: 0,\r\n\t\t\tmodified_by: 0\r\n\t\t}\r\n\t}).fetch()\r\n\r\n\t_getUserObjectListViews = (object_name)->\r\n\t\t_user_object_list_views = {}\r\n\t\tolistViews = _.filter objectsViews, (ov)->\r\n\t\t\treturn ov.object_name == object_name\r\n\r\n\t\t_.each olistViews, (listview)->\r\n\t\t\t_user_object_list_views[listview._id] = listview\r\n\r\n\t\treturn _user_object_list_views\r\n\r\n\t_.forEach objects, (o, key)->\r\n\t\tlist_view = _getUserObjectListViews(key)\r\n\t\tif !_.isEmpty(list_view)\r\n\t\t\tlistViews[key] = list_view\r\n\treturn listViews\r\n\r\n\r\nCreator.getUserObjectListViews = (userId, spaceId, object_name)->\r\n\t_user_object_list_views = {}\r\n\r\n\tobject_listview = Creator.getCollection(\"object_listviews\").find({\r\n\t\tobject_name: object_name,\r\n\t\tspace: spaceId,\r\n\t\t\"$or\": [{owner: userId}, {shared: true}]\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\tcreated: 0,\r\n\t\t\tmodified: 0,\r\n\t\t\tcreated_by: 0,\r\n\t\t\tmodified_by: 0\r\n\t\t}\r\n\t})\r\n\r\n\tobject_listview.forEach (listview)->\r\n\t\t_user_object_list_views[listview._id] = listview\r\n\r\n\treturn _user_object_list_views\r\n\r\n\r\n\r\n\r\n","Creator.getUserObjectsListViews = function(userId, spaceId, objects) {\n  var _getUserObjectListViews, keys, listViews, objectsViews;\n  listViews = {};\n  keys = _.keys(objects);\n  objectsViews = Creator.getCollection(\"object_listviews\").find({\n    object_name: {\n      $in: keys\n    },\n    space: spaceId,\n    \"$or\": [\n      {\n        owner: userId\n      }, {\n        shared: true\n      }\n    ]\n  }, {\n    fields: {\n      created: 0,\n      modified: 0,\n      created_by: 0,\n      modified_by: 0\n    }\n  }).fetch();\n  _getUserObjectListViews = function(object_name) {\n    var _user_object_list_views, olistViews;\n    _user_object_list_views = {};\n    olistViews = _.filter(objectsViews, function(ov) {\n      return ov.object_name === object_name;\n    });\n    _.each(olistViews, function(listview) {\n      return _user_object_list_views[listview._id] = listview;\n    });\n    return _user_object_list_views;\n  };\n  _.forEach(objects, function(o, key) {\n    var list_view;\n    list_view = _getUserObjectListViews(key);\n    if (!_.isEmpty(list_view)) {\n      return listViews[key] = list_view;\n    }\n  });\n  return listViews;\n};\n\nCreator.getUserObjectListViews = function(userId, spaceId, object_name) {\n  var _user_object_list_views, object_listview;\n  _user_object_list_views = {};\n  object_listview = Creator.getCollection(\"object_listviews\").find({\n    object_name: object_name,\n    space: spaceId,\n    \"$or\": [\n      {\n        owner: userId\n      }, {\n        shared: true\n      }\n    ]\n  }, {\n    fields: {\n      created: 0,\n      modified: 0,\n      created_by: 0,\n      modified_by: 0\n    }\n  });\n  object_listview.forEach(function(listview) {\n    return _user_object_list_views[listview._id] = listview;\n  });\n  return _user_object_list_views;\n};\n","// ServerSession = (function () {\r\n//   'use strict';\r\n\r\n//   var Collection = new Mongo.Collection('server_sessions');\r\n\r\n//   var checkForKey = function (key) {\r\n//     if (typeof key === 'undefined') {\r\n//       throw new Error('Please provide a key!');\r\n//     }\r\n//   };\r\n//   var getSessionValue = function (obj, key) {\r\n//     return obj && obj.values && obj.values[key];\r\n//   };\r\n//   var condition = function () {\r\n//     return true;\r\n//   };\r\n\r\n//   Collection.deny({\r\n//     'insert': function () {\r\n//       return true;\r\n//     },\r\n//     'update' : function () {\r\n//       return true;\r\n//     },\r\n//     'remove': function () {\r\n//       return true;\r\n//     }\r\n//   });\r\n\r\n//   // public client and server api\r\n//   var api = {\r\n//     'get': function (key) {\r\n//       console.log(Collection.findOne());\r\n//       var sessionObj = Collection.findOne();\r\n//       if(Meteor.isServer){\r\n//         Meteor.call('server-session/get');\r\n//       }\r\n//       // var sessionObj = Meteor.isServer ? \r\n//       //   Meteor.call('server-session/get') : Collection.findOne();\r\n//       return getSessionValue(sessionObj, key);\r\n//     },\r\n//     'equals': function (key, expected, identical) {\r\n//       var sessionObj = Meteor.isServer ? \r\n//         Meteor.call('server-session/get') : Collection.findOne();\r\n\r\n//       var value = getSessionValue(sessionObj, key);\r\n\r\n//       if (_.isObject(value) && _.isObject(expected)) {\r\n//         return _(value).isEqual(expected);\r\n//       }\r\n\r\n//       if (identical == false) {\r\n//         return expected == value;\r\n//       }\r\n\r\n//       return expected === value;\r\n//     }\r\n//   };\r\n\r\n//   Meteor.startup(function(){\r\n//     if (Meteor.isClient) {\r\n//       Tracker.autorun(function(){\r\n//         if(Meteor.userId()){\r\n//           Meteor.subscribe('server-session');\r\n//         }\r\n//       })\r\n//     }\r\n//   })\r\n\r\n//   if (Meteor.isServer) {\r\n//     // Meteor.startup(function () {\r\n//     //   if (Collection.findOne()) {\r\n//     //     Collection.remove({}); // clear out all stale sessions\r\n//     //   }\r\n//     // });\r\n\r\n//     Meteor.onConnection(function (connection) {\r\n//       var clientID = connection.id;\r\n\r\n//       if (!Collection.findOne({ 'clientID': clientID })) {\r\n//         Collection.insert({ 'clientID': clientID, 'values': {}, \"created\": new Date() });\r\n//       }\r\n\r\n//       connection.onClose(function () {\r\n//         Collection.remove({ 'clientID': clientID });\r\n//       });\r\n//     });\r\n\r\n//     Meteor.publish('server-session', function () {\r\n//       return Collection.find({ 'clientID': this.connection.id });\r\n//     });\r\n\r\n//     Meteor.methods({\r\n//       'server-session/get': function () {\r\n//         return Collection.findOne({ 'clientID': this.connection.id });\r\n//       },\r\n//       'server-session/set': function (key, value) {\r\n//         if (!this.randomSeed) return;\r\n\r\n//         checkForKey(key);\r\n\r\n//         if (!condition(key, value))\r\n//           throw new Meteor.Error('Failed condition validation.');\r\n\r\n//         var updateObj = {};\r\n//         updateObj['values.' + key] = value;\r\n\r\n//         Collection.update({ 'clientID': this.connection.id }, { $set: updateObj });\r\n//       }\r\n//     });  \r\n\r\n//     // server-only api\r\n//     _.extend(api, {\r\n//       'set': function (key, value) {\r\n//         Meteor.call('server-session/set', key, value);          \r\n//       },\r\n//       'setCondition': function (newCondition) {\r\n//         condition = newCondition;\r\n//       }\r\n//     });\r\n//   }\r\n\r\n//   return api;\r\n// })();","JsonRoutes.add 'get', '/api/get/apps', (req, res, next) ->\r\n\ttry\r\n\t\tuser_id = req.headers['x-user-id'] || req.query?.userId\r\n\r\n\t\tspace_id = req.headers['x-space-id'] || req.query?.spaceId\r\n\r\n\t\tuser = Steedos.getAPILoginUser(req, res)\r\n\t\t\r\n\t\tif !user\r\n\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\tcode: 401,\r\n\t\t\t\tdata:\r\n\t\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\r\n\t\t\t\t\t\"success\": false\r\n\t\t\treturn;\r\n\r\n\t\tuser_id = user._id\r\n\r\n\t\t# 校验space是否存在\r\n\t\tuuflowManager.getSpace(space_id)\r\n\r\n\t\tlocale = db.users.findOne({_id:user_id}).locale\r\n\t\tif locale == \"en-us\"\r\n\t\t\tlocale = \"en\"\r\n\t\tif locale == \"zh-cn\"\r\n\t\t\tlocale = \"zh-CN\"\r\n\r\n\t\tspaces = db.space_users.find({user: user_id}).fetch().getProperty(\"space\")\r\n\t\tapps = db.apps.find({$or: [{space: {$exists: false}}, {space: {$in:spaces}}]},{sort:{sort:1}}).fetch()\r\n\r\n\t\tapps.forEach (app) ->\r\n\t\t\tapp.name = TAPi18n.__(app.name,{},locale)\r\n\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { status: \"success\", data: apps}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\r\n\t\r\n\t\t","JsonRoutes.add('get', '/api/get/apps', function(req, res, next) {\n  var apps, e, locale, ref, ref1, space_id, spaces, user, user_id;\n  try {\n    user_id = req.headers['x-user-id'] || ((ref = req.query) != null ? ref.userId : void 0);\n    space_id = req.headers['x-space-id'] || ((ref1 = req.query) != null ? ref1.spaceId : void 0);\n    user = Steedos.getAPILoginUser(req, res);\n    if (!user) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    user_id = user._id;\n    uuflowManager.getSpace(space_id);\n    locale = db.users.findOne({\n      _id: user_id\n    }).locale;\n    if (locale === \"en-us\") {\n      locale = \"en\";\n    }\n    if (locale === \"zh-cn\") {\n      locale = \"zh-CN\";\n    }\n    spaces = db.space_users.find({\n      user: user_id\n    }).fetch().getProperty(\"space\");\n    apps = db.apps.find({\n      $or: [\n        {\n          space: {\n            $exists: false\n          }\n        }, {\n          space: {\n            $in: spaces\n          }\n        }\n      ]\n    }, {\n      sort: {\n        sort: 1\n      }\n    }).fetch();\n    apps.forEach(function(app) {\n      return app.name = TAPi18n.__(app.name, {}, locale);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: apps\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","Cookies = require(\"cookies\")\r\n\r\nJsonRoutes.add \"post\", \"/api/collection/find\", (req, res, next) ->\r\n    try\r\n        # TODO 用户登录验证\r\n        cookies = new Cookies( req, res );\r\n\r\n        # first check request body\r\n        if req.body\r\n            userId = req.body[\"X-User-Id\"]\r\n            authToken = req.body[\"X-Auth-Token\"]\r\n\r\n        # then check cookie\r\n        if !userId or !authToken\r\n            userId = cookies.get(\"X-User-Id\")\r\n            authToken = cookies.get(\"X-Auth-Token\")\r\n\r\n        if !(userId and authToken)\r\n            JsonRoutes.sendResult res, \r\n            code: 401,\r\n            data: \r\n                \"error\": \"Validate Request -- Missing X-Auth-Token\", \r\n                \"instance\": \"1329598861\", \r\n                \"success\": false\r\n            return;\r\n\r\n        model = req.body.model;\r\n        selector = req.body.selector;\r\n        options = req.body.options;\r\n        space = req.body.space;\r\n        data = [];\r\n        allow_models = ['space_users', 'organizations', 'flow_roles', 'roles']\r\n\r\n        if !space\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid space \" + space, \r\n                \"success\": false\r\n            return;\r\n\r\n        # TODO 用户是否属于space\r\n        space_user = db.space_users.findOne({user: userId, space: space})\r\n        \r\n        if !space_user\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid space \" + space, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !allow_models.includes(model)\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid model \" + model, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !db[model]\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid model \" + model, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !selector\r\n            selector = {};\r\n\r\n        if !options\r\n            options = {};\r\n\r\n        selector.space = space\r\n\r\n        data = db[model].find(selector, options).fetch();\r\n\r\n        JsonRoutes.sendResult res, \r\n            code: 200,\r\n            data: data;\r\n    catch e\r\n        console.error e.stack\r\n        JsonRoutes.sendResult res, \r\n            code: 200,\r\n            data: [];\r\n\r\n\r\nJsonRoutes.add \"post\", \"/api/collection/findone\", (req, res, next) ->\r\n    try\r\n        # TODO 用户登录验证\r\n        cookies = new Cookies( req, res );\r\n\r\n        # first check request body\r\n        if req.body\r\n            userId = req.body[\"X-User-Id\"]\r\n            authToken = req.body[\"X-Auth-Token\"]\r\n\r\n        # then check cookie\r\n        if !userId or !authToken\r\n            userId = cookies.get(\"X-User-Id\")\r\n            authToken = cookies.get(\"X-Auth-Token\")\r\n\r\n        if !(userId and authToken)\r\n            JsonRoutes.sendResult res, \r\n            code: 401,\r\n            data: \r\n                \"error\": \"Validate Request -- Missing X-Auth-Token\", \r\n                \"instance\": \"1329598861\", \r\n                \"success\": false\r\n            return;\r\n\r\n        model = req.body.model;\r\n        selector = req.body.selector;\r\n        options = req.body.options;\r\n        space = req.body.space;\r\n        data = [];\r\n        allow_models = ['space_users', 'organizations', 'flow_roles', 'mail_accounts', 'roles']\r\n\r\n        if !space\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid space \" + space, \r\n                \"success\": false\r\n            return;\r\n\r\n        # TODO 用户是否属于space\r\n        space_user = db.space_users.findOne({user: userId, space: space})\r\n        \r\n        if !space_user\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid space \" + space, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !allow_models.includes(model)\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid model \" + model, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !db[model]\r\n            JsonRoutes.sendResult res, \r\n            code: 403,\r\n            data: \r\n                \"error\": \"invalid model \" + model, \r\n                \"success\": false\r\n            return;\r\n\r\n        if !selector\r\n            selector = {};\r\n\r\n        if !options\r\n            options = {};\r\n\r\n        if model == 'mail_accounts'\r\n            selector = {};\r\n            selector.owner = userId\r\n            data = db[model].findOne(selector);\r\n        else\r\n            selector.space = space\r\n        \r\n            data = db[model].findOne(selector, options);\r\n\r\n        JsonRoutes.sendResult res, \r\n            code: 200,\r\n            data: data;\r\n    catch e\r\n        console.error e.stack\r\n        JsonRoutes.sendResult res, \r\n            code: 200,\r\n            data: {}","var Cookies;\n\nCookies = require(\"cookies\");\n\nJsonRoutes.add(\"post\", \"/api/collection/find\", function(req, res, next) {\n  var allow_models, authToken, cookies, data, e, model, options, selector, space, space_user, userId;\n  try {\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token\",\n          \"instance\": \"1329598861\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    model = req.body.model;\n    selector = req.body.selector;\n    options = req.body.options;\n    space = req.body.space;\n    data = [];\n    allow_models = ['space_users', 'organizations', 'flow_roles', 'roles'];\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: space\n    });\n    if (!space_user) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!allow_models.includes(model)) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!db[model]) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!selector) {\n      selector = {};\n    }\n    if (!options) {\n      options = {};\n    }\n    selector.space = space;\n    data = db[model].find(selector, options).fetch();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: []\n    });\n  }\n});\n\nJsonRoutes.add(\"post\", \"/api/collection/findone\", function(req, res, next) {\n  var allow_models, authToken, cookies, data, e, model, options, selector, space, space_user, userId;\n  try {\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing X-Auth-Token\",\n          \"instance\": \"1329598861\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n    model = req.body.model;\n    selector = req.body.selector;\n    options = req.body.options;\n    space = req.body.space;\n    data = [];\n    allow_models = ['space_users', 'organizations', 'flow_roles', 'mail_accounts', 'roles'];\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    space_user = db.space_users.findOne({\n      user: userId,\n      space: space\n    });\n    if (!space_user) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid space \" + space,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!allow_models.includes(model)) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!db[model]) {\n      JsonRoutes.sendResult(res, {\n        code: 403,\n        data: {\n          \"error\": \"invalid model \" + model,\n          \"success\": false\n        }\n      });\n      return;\n    }\n    if (!selector) {\n      selector = {};\n    }\n    if (!options) {\n      options = {};\n    }\n    if (model === 'mail_accounts') {\n      selector = {};\n      selector.owner = userId;\n      data = db[model].findOne(selector);\n    } else {\n      selector.space = space;\n      data = db[model].findOne(selector, options);\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  }\n});\n","crypto = require('crypto')\r\nCookies = require(\"cookies\")\r\nexpress = require(\"express\")\r\n\r\nJsonRoutes.add \"get\", \"/api/setup/sso/:app_id\", (req, res, next) ->\r\n\r\n\tapp = db.apps.findOne(req.params.app_id)\r\n\tif app\r\n\t\tsecret = app.secret\r\n\t\tredirectUrl = app.url\r\n\telse\r\n\t\tsecret = \"-8762-fcb369b2e8\"\r\n\t\tredirectUrl = req.params.redirectUrl\r\n\r\n\tif !redirectUrl\r\n\t\tres.writeHead 401\r\n\t\tres.end()\r\n\t\treturn\r\n\r\n\tcookies = new Cookies( req, res );\r\n\r\n\t# first check request body\r\n\t# if req.body\r\n\t# \tuserId = req.body[\"X-User-Id\"]\r\n\t# \tauthToken = req.body[\"X-Auth-Token\"]\r\n\r\n\t# # then check cookie\r\n\t# if !userId or !authToken\r\n\t# \tuserId = cookies.get(\"X-User-Id\")\r\n\t# \tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\tif !userId and !authToken\r\n\t\tuserId = req.query[\"X-User-Id\"]\r\n\t\tauthToken = req.query[\"X-Auth-Token\"]\r\n\r\n\tif userId and authToken\r\n\t\thashedToken = Accounts._hashLoginToken(authToken)\r\n\t\tuser = Meteor.users.findOne\r\n\t\t\t_id: userId,\r\n\t\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\t\tif user\r\n\t\t\tsteedos_id = user.steedos_id\r\n\t\t\tif app.secret\r\n\t\t\t\tiv = app.secret\r\n\t\t\telse\r\n\t\t\t\tiv = \"-8762-fcb369b2e8\"\r\n\t\t\tnow = parseInt(new Date().getTime()/1000).toString()\r\n\t\t\tkey32 = \"\"\r\n\t\t\tlen = steedos_id.length\r\n\t\t\tif len < 32\r\n\t\t\t\tc = \"\"\r\n\t\t\t\ti = 0\r\n\t\t\t\tm = 32 - len\r\n\t\t\t\twhile i < m\r\n\t\t\t\t\tc = \" \" + c\r\n\t\t\t\t\ti++\r\n\t\t\t\tkey32 = steedos_id + c\r\n\t\t\telse if len >= 32\r\n\t\t\t\tkey32 = steedos_id.slice(0,32)\r\n\r\n\t\t\tcipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'))\r\n\r\n\t\t\tcipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()])\r\n\r\n\t\t\tsteedos_token = cipheredMsg.toString('base64')\r\n\r\n\t\t\t# des-cbc\r\n\t\t\tdes_iv = \"-8762-fc\"\r\n\t\t\tkey8 = \"\"\r\n\t\t\tlen = steedos_id.length\r\n\t\t\tif len < 8\r\n\t\t\t\tc = \"\"\r\n\t\t\t\ti = 0\r\n\t\t\t\tm = 8 - len\r\n\t\t\t\twhile i < m\r\n\t\t\t\t\tc = \" \" + c\r\n\t\t\t\t\ti++\r\n\t\t\t\tkey8 = steedos_id + c\r\n\t\t\telse if len >= 8\r\n\t\t\t\tkey8 = steedos_id.slice(0,8)\r\n\t\t\tdes_cipher = crypto.createCipheriv('des-cbc', new Buffer(key8, 'utf8'), new Buffer(des_iv, 'utf8'))\r\n\t\t\tdes_cipheredMsg = Buffer.concat([des_cipher.update(new Buffer(now, 'utf8')), des_cipher.final()])\r\n\t\t\tdes_steedos_token = des_cipheredMsg.toString('base64')\r\n\r\n\t\t\tjoiner = \"?\"\r\n\r\n\t\t\tif redirectUrl.indexOf(\"?\") > -1\r\n\t\t\t\tjoiner = \"&\"\r\n\r\n\t\t\treturnurl = redirectUrl + joiner + \"X-User-Id=\" + userId + \"&X-Auth-Token=\" + authToken + \"&X-STEEDOS-WEB-ID=\" + steedos_id + \"&X-STEEDOS-AUTHTOKEN=\" + steedos_token + \"&STEEDOS-AUTHTOKEN=\" + des_steedos_token\r\n\r\n\t\t\tif user.username\r\n\t\t\t\treturnurl += \"&X-STEEDOS-USERNAME=#{encodeURI(user.username)}\"\r\n\t\t\tres.setHeader \"Location\", returnurl\r\n\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\tres.writeHead 401\r\n\tres.end()\r\n\treturn\r\n","var Cookies, crypto, express;\n\ncrypto = require('crypto');\n\nCookies = require(\"cookies\");\n\nexpress = require(\"express\");\n\nJsonRoutes.add(\"get\", \"/api/setup/sso/:app_id\", function(req, res, next) {\n  var app, authToken, c, cipher, cipheredMsg, cookies, des_cipher, des_cipheredMsg, des_iv, des_steedos_token, hashedToken, i, iv, joiner, key32, key8, len, m, now, redirectUrl, returnurl, secret, steedos_id, steedos_token, user, userId;\n  app = db.apps.findOne(req.params.app_id);\n  if (app) {\n    secret = app.secret;\n    redirectUrl = app.url;\n  } else {\n    secret = \"-8762-fcb369b2e8\";\n    redirectUrl = req.params.redirectUrl;\n  }\n  if (!redirectUrl) {\n    res.writeHead(401);\n    res.end();\n    return;\n  }\n  cookies = new Cookies(req, res);\n  if (!userId && !authToken) {\n    userId = req.query[\"X-User-Id\"];\n    authToken = req.query[\"X-Auth-Token\"];\n  }\n  if (userId && authToken) {\n    hashedToken = Accounts._hashLoginToken(authToken);\n    user = Meteor.users.findOne({\n      _id: userId,\n      \"services.resume.loginTokens.hashedToken\": hashedToken\n    });\n    if (user) {\n      steedos_id = user.steedos_id;\n      if (app.secret) {\n        iv = app.secret;\n      } else {\n        iv = \"-8762-fcb369b2e8\";\n      }\n      now = parseInt(new Date().getTime() / 1000).toString();\n      key32 = \"\";\n      len = steedos_id.length;\n      if (len < 32) {\n        c = \"\";\n        i = 0;\n        m = 32 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key32 = steedos_id + c;\n      } else if (len >= 32) {\n        key32 = steedos_id.slice(0, 32);\n      }\n      cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(key32, 'utf8'), new Buffer(iv, 'utf8'));\n      cipheredMsg = Buffer.concat([cipher.update(new Buffer(now, 'utf8')), cipher.final()]);\n      steedos_token = cipheredMsg.toString('base64');\n      des_iv = \"-8762-fc\";\n      key8 = \"\";\n      len = steedos_id.length;\n      if (len < 8) {\n        c = \"\";\n        i = 0;\n        m = 8 - len;\n        while (i < m) {\n          c = \" \" + c;\n          i++;\n        }\n        key8 = steedos_id + c;\n      } else if (len >= 8) {\n        key8 = steedos_id.slice(0, 8);\n      }\n      des_cipher = crypto.createCipheriv('des-cbc', new Buffer(key8, 'utf8'), new Buffer(des_iv, 'utf8'));\n      des_cipheredMsg = Buffer.concat([des_cipher.update(new Buffer(now, 'utf8')), des_cipher.final()]);\n      des_steedos_token = des_cipheredMsg.toString('base64');\n      joiner = \"?\";\n      if (redirectUrl.indexOf(\"?\") > -1) {\n        joiner = \"&\";\n      }\n      returnurl = redirectUrl + joiner + \"X-User-Id=\" + userId + \"&X-Auth-Token=\" + authToken + \"&X-STEEDOS-WEB-ID=\" + steedos_id + \"&X-STEEDOS-AUTHTOKEN=\" + steedos_token + \"&STEEDOS-AUTHTOKEN=\" + des_steedos_token;\n      if (user.username) {\n        returnurl += \"&X-STEEDOS-USERNAME=\" + (encodeURI(user.username));\n      }\n      res.setHeader(\"Location\", returnurl);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n  }\n  res.writeHead(401);\n  res.end();\n});\n","Meteor.startup ->\r\n\t\r\n\tJsonRoutes.add 'get', '/avatar/:userId', (req, res, next) ->\r\n\t\t# this.params =\r\n\t\t# \tuserId: decodeURI(req.url).replace(/^\\//, '').replace(/\\?.*$/, '')\r\n\t\twidth = 50 ;\r\n\t\theight = 50 ;\r\n\t\tfontSize = 28 ;\r\n\t\tif req.query.w\r\n\t\t    width = req.query.w ;\r\n\t\tif req.query.h\r\n\t\t    height = req.query.h ;\r\n\t\tif req.query.fs\r\n            fontSize = req.query.fs ;\r\n\r\n\t\tuser = db.users.findOne(req.params.userId);\r\n\t\tif !user\r\n\t\t\tres.writeHead 401\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\tif user.avatar\r\n\t\t\tres.setHeader \"Location\", Steedos.absoluteUrl(\"api/files/avatars/\" + user.avatar)\r\n\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\tif user.profile?.avatar\r\n\t\t\tres.setHeader \"Location\", user.profile.avatar\r\n\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\tif user.avatarUrl\r\n\t\t\tres.setHeader \"Location\", user.avatarUrl\r\n\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\tif not file?\r\n\t\t\tres.setHeader 'Content-Disposition', 'inline'\r\n\t\t\tres.setHeader 'content-type', 'image/svg+xml'\r\n\t\t\tres.setHeader 'cache-control', 'public, max-age=31536000'\r\n\t\t\tsvg = \"\"\"\r\n\t\t\t\t<svg version=\"1.1\" id=\"Layer_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\"\r\n\t\t\t\t\t viewBox=\"0 0 72 72\" style=\"enable-background:new 0 0 72 72;\" xml:space=\"preserve\">\r\n\t\t\t\t<style type=\"text/css\">\r\n\t\t\t\t\t.st0{fill:#FFFFFF;}\r\n\t\t\t\t\t.st1{fill:#D0D0D0;}\r\n\t\t\t\t</style>\r\n\t\t\t\t<g>\r\n\t\t\t\t\t<path class=\"st0\" d=\"M36,71.1c-19.3,0-35-15.7-35-35s15.7-35,35-35s35,15.7,35,35S55.3,71.1,36,71.1z\"/>\r\n\t\t\t\t\t<path class=\"st1\" d=\"M36,2.1c18.7,0,34,15.3,34,34s-15.3,34-34,34S2,54.8,2,36.1S17.3,2.1,36,2.1 M36,0.1c-19.9,0-36,16.1-36,36\r\n\t\t\t\t\t\ts16.1,36,36,36s36-16.1,36-36S55.9,0.1,36,0.1L36,0.1z\"/>\r\n\t\t\t\t</g>\r\n\t\t\t\t<g>\r\n\t\t\t\t\t<g>\r\n\t\t\t\t\t\t<path class=\"st1\" d=\"M35.8,42.6c8.3,0,15.1-6.8,15.1-15.1c0-8.3-6.8-15.1-15.1-15.1c-8.3,0-15.1,6.8-15.1,15.1\r\n\t\t\t\t\t\t\tC20.7,35.8,27.5,42.6,35.8,42.6z\"/>\r\n\t\t\t\t\t\t<path class=\"st1\" d=\"M36.2,70.7c8.7,0,16.7-3.1,22.9-8.2c-3.6-9.6-12.7-15.5-23.3-15.5c-10.4,0-19.4,5.7-23.1,15\r\n\t\t\t\t\t\t\tC19,67.4,27.2,70.7,36.2,70.7z\"/>\r\n\t\t\t\t\t</g>\r\n\t\t\t\t</g>\r\n\t\t\t\t</svg>\r\n\t\t\t\"\"\"\r\n\t\t\tres.write svg\r\n#\t\t\tres.setHeader \"Location\", Steedos.absoluteUrl(\"/packages/steedos_base/client/images/default-avatar.png\")\r\n#\t\t\tres.writeHead 302\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\tusername = user.name;\r\n\t\tif !username\r\n\t\t\tusername = \"\"\r\n\r\n\t\tres.setHeader 'Content-Disposition', 'inline'\r\n\r\n\t\tif not file?\r\n\t\t\tres.setHeader 'content-type', 'image/svg+xml'\r\n\t\t\tres.setHeader 'cache-control', 'public, max-age=31536000'\r\n\r\n\t\t\tcolors = ['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFC107','#FF9800','#FF5722','#795548','#9E9E9E','#607D8B']\r\n\r\n\t\t\tusername_array = Array.from(username)\r\n\t\t\tcolor_index = 0\r\n\t\t\t_.each username_array, (item) ->\r\n\t\t\t\tcolor_index += item.charCodeAt(0);\r\n\r\n\t\t\tposition = color_index % colors.length\r\n\t\t\tcolor = colors[position]\r\n\t\t\t#color = \"#D6DADC\"\r\n\r\n\t\t\tinitials = ''\r\n\t\t\tif username.charCodeAt(0)>255\r\n\t\t\t\tinitials = username.substr(0, 1)\r\n\t\t\telse\r\n\t\t\t\tinitials = username.substr(0, 2)\r\n\r\n\t\t\tinitials = initials.toUpperCase()\r\n\r\n\t\t\tsvg = \"\"\"\r\n\t\t\t<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\r\n\t\t\t<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"#{width}\" height=\"#{height}\" style=\"width: #{width}px; height: #{height}px; background-color: #{color};\">\r\n\t\t\t\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#FFFFFF\" font-family=\"-apple-system, BlinkMacSystemFont, Helvetica, Arial, Microsoft Yahei, SimHei\" style=\"font-weight: 400; font-size: #{fontSize}px;\">\r\n\t\t\t\t\t#{initials}\r\n\t\t\t\t</text>\r\n\t\t\t</svg>\r\n\t\t\t\"\"\"\r\n\r\n\t\t\tres.write svg\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\t\treqModifiedHeader = req.headers[\"if-modified-since\"];\r\n\t\tif reqModifiedHeader?\r\n\t\t\tif reqModifiedHeader == user.modified?.toUTCString()\r\n\t\t\t\tres.setHeader 'Last-Modified', reqModifiedHeader\r\n\t\t\t\tres.writeHead 304\r\n\t\t\t\tres.end()\r\n\t\t\t\treturn\r\n\r\n\t\tres.setHeader 'Last-Modified', user.modified?.toUTCString() or new Date().toUTCString()\r\n\t\tres.setHeader 'content-type', 'image/jpeg'\r\n\t\tres.setHeader 'Content-Length', file.length\r\n\r\n\t\tfile.readStream.pipe res\r\n\t\treturn","Meteor.startup(function() {\n  return JsonRoutes.add('get', '/avatar/:userId', function(req, res, next) {\n    var color, color_index, colors, fontSize, height, initials, position, ref, ref1, ref2, reqModifiedHeader, svg, user, username, username_array, width;\n    width = 50;\n    height = 50;\n    fontSize = 28;\n    if (req.query.w) {\n      width = req.query.w;\n    }\n    if (req.query.h) {\n      height = req.query.h;\n    }\n    if (req.query.fs) {\n      fontSize = req.query.fs;\n    }\n    user = db.users.findOne(req.params.userId);\n    if (!user) {\n      res.writeHead(401);\n      res.end();\n      return;\n    }\n    if (user.avatar) {\n      res.setHeader(\"Location\", Steedos.absoluteUrl(\"api/files/avatars/\" + user.avatar));\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if ((ref = user.profile) != null ? ref.avatar : void 0) {\n      res.setHeader(\"Location\", user.profile.avatar);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if (user.avatarUrl) {\n      res.setHeader(\"Location\", user.avatarUrl);\n      res.writeHead(302);\n      res.end();\n      return;\n    }\n    if (typeof file === \"undefined\" || file === null) {\n      res.setHeader('Content-Disposition', 'inline');\n      res.setHeader('content-type', 'image/svg+xml');\n      res.setHeader('cache-control', 'public, max-age=31536000');\n      svg = \"<svg version=\\\"1.1\\\" id=\\\"Layer_1\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" xmlns:xlink=\\\"http://www.w3.org/1999/xlink\\\" x=\\\"0px\\\" y=\\\"0px\\\"\\n\t viewBox=\\\"0 0 72 72\\\" style=\\\"enable-background:new 0 0 72 72;\\\" xml:space=\\\"preserve\\\">\\n<style type=\\\"text/css\\\">\\n\t.st0{fill:#FFFFFF;}\\n\t.st1{fill:#D0D0D0;}\\n</style>\\n<g>\\n\t<path class=\\\"st0\\\" d=\\\"M36,71.1c-19.3,0-35-15.7-35-35s15.7-35,35-35s35,15.7,35,35S55.3,71.1,36,71.1z\\\"/>\\n\t<path class=\\\"st1\\\" d=\\\"M36,2.1c18.7,0,34,15.3,34,34s-15.3,34-34,34S2,54.8,2,36.1S17.3,2.1,36,2.1 M36,0.1c-19.9,0-36,16.1-36,36\\n\t\ts16.1,36,36,36s36-16.1,36-36S55.9,0.1,36,0.1L36,0.1z\\\"/>\\n</g>\\n<g>\\n\t<g>\\n\t\t<path class=\\\"st1\\\" d=\\\"M35.8,42.6c8.3,0,15.1-6.8,15.1-15.1c0-8.3-6.8-15.1-15.1-15.1c-8.3,0-15.1,6.8-15.1,15.1\\n\t\t\tC20.7,35.8,27.5,42.6,35.8,42.6z\\\"/>\\n\t\t<path class=\\\"st1\\\" d=\\\"M36.2,70.7c8.7,0,16.7-3.1,22.9-8.2c-3.6-9.6-12.7-15.5-23.3-15.5c-10.4,0-19.4,5.7-23.1,15\\n\t\t\tC19,67.4,27.2,70.7,36.2,70.7z\\\"/>\\n\t</g>\\n</g>\\n</svg>\";\n      res.write(svg);\n      res.end();\n      return;\n    }\n    username = user.name;\n    if (!username) {\n      username = \"\";\n    }\n    res.setHeader('Content-Disposition', 'inline');\n    if (typeof file === \"undefined\" || file === null) {\n      res.setHeader('content-type', 'image/svg+xml');\n      res.setHeader('cache-control', 'public, max-age=31536000');\n      colors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B'];\n      username_array = Array.from(username);\n      color_index = 0;\n      _.each(username_array, function(item) {\n        return color_index += item.charCodeAt(0);\n      });\n      position = color_index % colors.length;\n      color = colors[position];\n      initials = '';\n      if (username.charCodeAt(0) > 255) {\n        initials = username.substr(0, 1);\n      } else {\n        initials = username.substr(0, 2);\n      }\n      initials = initials.toUpperCase();\n      svg = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"no\\\"?>\\n<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" pointer-events=\\\"none\\\" width=\\\"\" + width + \"\\\" height=\\\"\" + height + \"\\\" style=\\\"width: \" + width + \"px; height: \" + height + \"px; background-color: \" + color + \";\\\">\\n\t<text text-anchor=\\\"middle\\\" y=\\\"50%\\\" x=\\\"50%\\\" dy=\\\"0.36em\\\" pointer-events=\\\"auto\\\" fill=\\\"#FFFFFF\\\" font-family=\\\"-apple-system, BlinkMacSystemFont, Helvetica, Arial, Microsoft Yahei, SimHei\\\" style=\\\"font-weight: 400; font-size: \" + fontSize + \"px;\\\">\\n\t\t\" + initials + \"\\n\t</text>\\n</svg>\";\n      res.write(svg);\n      res.end();\n      return;\n    }\n    reqModifiedHeader = req.headers[\"if-modified-since\"];\n    if (reqModifiedHeader != null) {\n      if (reqModifiedHeader === ((ref1 = user.modified) != null ? ref1.toUTCString() : void 0)) {\n        res.setHeader('Last-Modified', reqModifiedHeader);\n        res.writeHead(304);\n        res.end();\n        return;\n      }\n    }\n    res.setHeader('Last-Modified', ((ref2 = user.modified) != null ? ref2.toUTCString() : void 0) || new Date().toUTCString());\n    res.setHeader('content-type', 'image/jpeg');\n    res.setHeader('Content-Length', file.length);\n    file.readStream.pipe(res);\n  });\n});\n","Meteor.startup ->\r\n\tJsonRoutes.add 'get', '/api/access/check', (req, res, next) ->\r\n\r\n\t\taccess_token = req.query?.access_token\r\n\r\n\t\tif Steedos.getUserIdFromAccessToken(access_token)\r\n\t\t\tres.writeHead 200\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\t\telse\r\n\t\t\tres.writeHead 401\r\n\t\t\tres.end()\r\n\t\t\treturn\r\n\r\n\r\n\r\n\r\n","Meteor.startup(function() {\n  return JsonRoutes.add('get', '/api/access/check', function(req, res, next) {\n    var access_token, ref;\n    access_token = (ref = req.query) != null ? ref.access_token : void 0;\n    if (Steedos.getUserIdFromAccessToken(access_token)) {\n      res.writeHead(200);\n      res.end();\n    } else {\n      res.writeHead(401);\n      res.end();\n    }\n  });\n});\n","if Meteor.isServer\r\n    Meteor.publish 'apps', (spaceId)->\r\n        unless this.userId\r\n            return this.ready()\r\n        \r\n\r\n        selector = {space: {$exists: false}}\r\n        if spaceId\r\n            selector = {$or: [{space: {$exists: false}}, {space: spaceId}]}\r\n        \r\n        return db.apps.find(selector, {sort: {sort: 1}});\r\n","if (Meteor.isServer) {\n  Meteor.publish('apps', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    selector = {\n      space: {\n        $exists: false\n      }\n    };\n    if (spaceId) {\n      selector = {\n        $or: [\n          {\n            space: {\n              $exists: false\n            }\n          }, {\n            space: spaceId\n          }\n        ]\n      };\n    }\n    return db.apps.find(selector, {\n      sort: {\n        sort: 1\n      }\n    });\n  });\n}\n","\r\n\r\n\t# publish users spaces\r\n\t# we only publish spaces current user joined.\r\n\tMeteor.publish 'my_spaces', ->\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\r\n\r\n\t\tself = this;\r\n\t\tuserSpaces = []\r\n\t\tsus = db.space_users.find({user: this.userId, user_accepted: true}, {fields: {space:1}})\r\n\t\tsus.forEach (su) ->\r\n\t\t\tuserSpaces.push(su.space)\r\n\r\n\t\thandle2 = null\r\n\r\n\t\t# only return user joined spaces, and observes when user join or leave a space\r\n\t\thandle = db.space_users.find({user: this.userId, user_accepted: true}).observe\r\n\t\t\tadded: (doc) ->\r\n\t\t\t\tif doc.space\r\n\t\t\t\t\tif userSpaces.indexOf(doc.space) < 0\r\n\t\t\t\t\t\tuserSpaces.push(doc.space)\r\n\t\t\t\t\t\tobserveSpaces()\r\n\t\t\tremoved: (oldDoc) ->\r\n\t\t\t\tif oldDoc.space\r\n\t\t\t\t\tself.removed \"spaces\", oldDoc.space\r\n\t\t\t\t\tuserSpaces = _.without(userSpaces, oldDoc.space)\r\n\r\n\t\tobserveSpaces = ->\r\n\t\t\tif handle2\r\n\t\t\t\thandle2.stop();\r\n\t\t\thandle2 = db.spaces.find({_id: {$in: userSpaces}}).observe\r\n\t\t\t\tadded: (doc) ->\r\n\t\t\t\t\tself.added \"spaces\", doc._id, doc;\r\n\t\t\t\t\tuserSpaces.push(doc._id)\r\n\t\t\t\tchanged: (newDoc, oldDoc) ->\r\n\t\t\t\t\tself.changed \"spaces\", newDoc._id, newDoc;\r\n\t\t\t\tremoved: (oldDoc) ->\r\n\t\t\t\t\tself.removed \"spaces\", oldDoc._id\r\n\t\t\t\t\tuserSpaces = _.without(userSpaces, oldDoc._id)\r\n\r\n\t\tobserveSpaces();\r\n\r\n\t\tself.ready();\r\n\r\n\t\tself.onStop ->\r\n\t\t\thandle.stop();\r\n\t\t\tif handle2\r\n\t\t\t\thandle2.stop();\r\n","Meteor.publish('my_spaces', function() {\n  var handle, handle2, observeSpaces, self, sus, userSpaces;\n  if (!this.userId) {\n    return this.ready();\n  }\n  self = this;\n  userSpaces = [];\n  sus = db.space_users.find({\n    user: this.userId,\n    user_accepted: true\n  }, {\n    fields: {\n      space: 1\n    }\n  });\n  sus.forEach(function(su) {\n    return userSpaces.push(su.space);\n  });\n  handle2 = null;\n  handle = db.space_users.find({\n    user: this.userId,\n    user_accepted: true\n  }).observe({\n    added: function(doc) {\n      if (doc.space) {\n        if (userSpaces.indexOf(doc.space) < 0) {\n          userSpaces.push(doc.space);\n          return observeSpaces();\n        }\n      }\n    },\n    removed: function(oldDoc) {\n      if (oldDoc.space) {\n        self.removed(\"spaces\", oldDoc.space);\n        return userSpaces = _.without(userSpaces, oldDoc.space);\n      }\n    }\n  });\n  observeSpaces = function() {\n    if (handle2) {\n      handle2.stop();\n    }\n    return handle2 = db.spaces.find({\n      _id: {\n        $in: userSpaces\n      }\n    }).observe({\n      added: function(doc) {\n        self.added(\"spaces\", doc._id, doc);\n        return userSpaces.push(doc._id);\n      },\n      changed: function(newDoc, oldDoc) {\n        return self.changed(\"spaces\", newDoc._id, newDoc);\n      },\n      removed: function(oldDoc) {\n        self.removed(\"spaces\", oldDoc._id);\n        return userSpaces = _.without(userSpaces, oldDoc._id);\n      }\n    });\n  };\n  observeSpaces();\n  self.ready();\n  return self.onStop(function() {\n    handle.stop();\n    if (handle2) {\n      return handle2.stop();\n    }\n  });\n});\n","# publish some one space's avatar\r\nMeteor.publish 'space_avatar', (spaceId)->\r\n\tunless spaceId\r\n\t\treturn this.ready()\r\n\r\n\treturn db.spaces.find({_id: spaceId}, {fields: {avatar: 1,name: 1,enable_register:1}});\r\n","Meteor.publish('space_avatar', function(spaceId) {\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.spaces.find({\n    _id: spaceId\n  }, {\n    fields: {\n      avatar: 1,\n      name: 1,\n      enable_register: 1\n    }\n  });\n});\n","Meteor.publish 'modules', ()->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\treturn db.modules.find();","Meteor.publish('modules', function() {\n  if (!this.userId) {\n    return this.ready();\n  }\n  return db.modules.find();\n});\n","Meteor.publish 'billing_weixin_pay_code_url', (_id)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tunless _id\r\n\t\treturn this.ready()\r\n\r\n\treturn db.billing_pay_records.find({_id: _id});","Meteor.publish('billing_weixin_pay_code_url', function(_id) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!_id) {\n    return this.ready();\n  }\n  return db.billing_pay_records.find({\n    _id: _id\n  });\n});\n","steedosAuth = require(\"@steedos/auth\");\r\nsteedosI18n = require(\"@steedos/i18n\");\r\nsteedosCore = require(\"@steedos/core\");\r\nclone = require(\"clone\");\r\n\r\n_getLocale = (user)->\r\n\tif user?.locale?.toLocaleLowerCase() == 'zh-cn'\r\n\t\tlocale = \"zh-CN\"\r\n\telse if user?.locale?.toLocaleLowerCase() == 'en-us'\r\n\t\tlocale = \"en\"\r\n\telse\r\n\t\tlocale = \"zh-CN\"\r\n\treturn locale\r\n\r\nJsonRoutes.add \"get\", \"/api/bootstrap/:spaceId/\",(req, res, next)->\r\n\tuserId = req.headers['x-user-id']\r\n\tspaceId = req.headers['x-space-id'] || req.params?.spaceId\r\n\tif !userId\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 403,\r\n\t\t\tdata: null\r\n\t\treturn\r\n\r\n\tauthToken = Steedos.getAuthToken(req, res)\r\n\tuserSession = Meteor.wrapAsync((authToken, spaceId, cb)->\r\n\t\t\tsteedosAuth.getSession(authToken, spaceId).then (resolve, reject)->\r\n\t\t\t\tcb(reject, resolve)\r\n\t\t)(authToken, spaceId)\r\n\t\r\n\tunless userSession\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 500,\r\n\t\t\tdata: null\r\n\t\treturn\r\n\r\n\tspace = Creator.Collections[\"spaces\"].findOne({_id: spaceId}, {fields: {name: 1}})\r\n\r\n\tresult = Creator.getAllPermissions(spaceId, userId);\r\n#\tconsole.time('translationObjects');\r\n\tlng = _getLocale(db.users.findOne(userId, {fields: {locale: 1}}))\r\n\tsteedosI18n.translationObjects(lng, result.objects);\r\n#\tconsole.timeEnd('translationObjects');\r\n\tresult.user = userSession\r\n\tresult.space = space\r\n\tresult.apps = clone(Creator.Apps)\r\n\tresult.dashboards = clone(Creator.Dashboards)\r\n\tresult.object_listviews = Creator.getUserObjectsListViews(userId, spaceId, result.objects)\r\n\tresult.object_workflows = Meteor.call 'object_workflows.get', spaceId, userId\r\n\r\n\tpermissions = Meteor.wrapAsync (v, userSession, cb)->\r\n\t\tv.getUserObjectPermission(userSession).then (resolve, reject)->\r\n\t\t\tcb(reject, resolve)\r\n\r\n\t_.each Creator.steedosSchema.getDataSources(), (datasource, name) ->\r\n\t\tif name != 'default'\r\n\t\t\tdatasourceObjects = datasource.getObjects()\r\n\t\t\t_.each(datasourceObjects, (v, k)->\r\n\t\t\t\t_obj = Creator.convertObject(v.toConfig())\r\n#\t\t\t\t_obj.name = \"#{name}.#{k}\"\r\n\t\t\t\t_obj.name = k\r\n\t\t\t\t_obj.database_name = name\r\n\t\t\t\t_obj.permissions = permissions(v, userSession)\r\n\t\t\t\tresult.objects[_obj.name] = _obj\r\n\t\t\t)\r\n\t_.each Creator.steedosSchema.getDataSources(), (datasource, name) ->\r\n\t\tresult.apps = _.extend result.apps, clone(datasource.getAppsConfig())\r\n\t\tresult.dashboards = _.extend result.dashboards, datasource.getDashboardsConfig()\r\n\tresult.apps = _.extend( result.apps || {}, Creator.getDBApps(spaceId))\r\n\tresult.dashboards = _.extend( result.dashboards || {}, Creator.getDBDashboards(spaceId))\r\n\r\n\t_Apps = {}\r\n\t_.each result.apps, (app, key) ->\r\n\t\tif !app._id\r\n\t\t\tapp._id = key\r\n\t\tif app.code\r\n\t\t\tapp._dbid = app._id\r\n\t\t\tapp._id = app.code\r\n\t\t_Apps[app._id] = app\r\n\tsteedosI18n.translationApps(lng, _Apps);\r\n\tresult.apps = _Apps;\r\n\tassigned_menus = clone(result.assigned_menus);\r\n\tsteedosI18n.translationMenus(lng, assigned_menus);\r\n\tresult.assigned_menus = assigned_menus;\r\n\r\n\t_Dashboards = {}\r\n\t_.each result.dashboards, (dashboard, key) ->\r\n\t\tif !dashboard._id\r\n\t\t\tdashboard._id = key\r\n\t\t_Dashboards[dashboard._id] = dashboard\r\n\tresult.dashboards = _Dashboards\r\n\r\n\tresult.plugins = steedosCore.getPlugins?()\r\n\r\n\tJsonRoutes.sendResult res,\r\n\t\tcode: 200,\r\n\t\tdata: result\r\n","var _getLocale, clone, steedosAuth, steedosCore, steedosI18n;\n\nsteedosAuth = require(\"@steedos/auth\");\n\nsteedosI18n = require(\"@steedos/i18n\");\n\nsteedosCore = require(\"@steedos/core\");\n\nclone = require(\"clone\");\n\n_getLocale = function(user) {\n  var locale, ref, ref1;\n  if ((user != null ? (ref = user.locale) != null ? ref.toLocaleLowerCase() : void 0 : void 0) === 'zh-cn') {\n    locale = \"zh-CN\";\n  } else if ((user != null ? (ref1 = user.locale) != null ? ref1.toLocaleLowerCase() : void 0 : void 0) === 'en-us') {\n    locale = \"en\";\n  } else {\n    locale = \"zh-CN\";\n  }\n  return locale;\n};\n\nJsonRoutes.add(\"get\", \"/api/bootstrap/:spaceId/\", function(req, res, next) {\n  var _Apps, _Dashboards, assigned_menus, authToken, lng, permissions, ref, result, space, spaceId, userId, userSession;\n  userId = req.headers['x-user-id'];\n  spaceId = req.headers['x-space-id'] || ((ref = req.params) != null ? ref.spaceId : void 0);\n  if (!userId) {\n    JsonRoutes.sendResult(res, {\n      code: 403,\n      data: null\n    });\n    return;\n  }\n  authToken = Steedos.getAuthToken(req, res);\n  userSession = Meteor.wrapAsync(function(authToken, spaceId, cb) {\n    return steedosAuth.getSession(authToken, spaceId).then(function(resolve, reject) {\n      return cb(reject, resolve);\n    });\n  })(authToken, spaceId);\n  if (!userSession) {\n    JsonRoutes.sendResult(res, {\n      code: 500,\n      data: null\n    });\n    return;\n  }\n  space = Creator.Collections[\"spaces\"].findOne({\n    _id: spaceId\n  }, {\n    fields: {\n      name: 1\n    }\n  });\n  result = Creator.getAllPermissions(spaceId, userId);\n  lng = _getLocale(db.users.findOne(userId, {\n    fields: {\n      locale: 1\n    }\n  }));\n  steedosI18n.translationObjects(lng, result.objects);\n  result.user = userSession;\n  result.space = space;\n  result.apps = clone(Creator.Apps);\n  result.dashboards = clone(Creator.Dashboards);\n  result.object_listviews = Creator.getUserObjectsListViews(userId, spaceId, result.objects);\n  result.object_workflows = Meteor.call('object_workflows.get', spaceId, userId);\n  permissions = Meteor.wrapAsync(function(v, userSession, cb) {\n    return v.getUserObjectPermission(userSession).then(function(resolve, reject) {\n      return cb(reject, resolve);\n    });\n  });\n  _.each(Creator.steedosSchema.getDataSources(), function(datasource, name) {\n    var datasourceObjects;\n    if (name !== 'default') {\n      datasourceObjects = datasource.getObjects();\n      return _.each(datasourceObjects, function(v, k) {\n        var _obj;\n        _obj = Creator.convertObject(v.toConfig());\n        _obj.name = k;\n        _obj.database_name = name;\n        _obj.permissions = permissions(v, userSession);\n        return result.objects[_obj.name] = _obj;\n      });\n    }\n  });\n  _.each(Creator.steedosSchema.getDataSources(), function(datasource, name) {\n    result.apps = _.extend(result.apps, clone(datasource.getAppsConfig()));\n    return result.dashboards = _.extend(result.dashboards, datasource.getDashboardsConfig());\n  });\n  result.apps = _.extend(result.apps || {}, Creator.getDBApps(spaceId));\n  result.dashboards = _.extend(result.dashboards || {}, Creator.getDBDashboards(spaceId));\n  _Apps = {};\n  _.each(result.apps, function(app, key) {\n    if (!app._id) {\n      app._id = key;\n    }\n    if (app.code) {\n      app._dbid = app._id;\n      app._id = app.code;\n    }\n    return _Apps[app._id] = app;\n  });\n  steedosI18n.translationApps(lng, _Apps);\n  result.apps = _Apps;\n  assigned_menus = clone(result.assigned_menus);\n  steedosI18n.translationMenus(lng, assigned_menus);\n  result.assigned_menus = assigned_menus;\n  _Dashboards = {};\n  _.each(result.dashboards, function(dashboard, key) {\n    if (!dashboard._id) {\n      dashboard._id = key;\n    }\n    return _Dashboards[dashboard._id] = dashboard;\n  });\n  result.dashboards = _Dashboards;\n  result.plugins = typeof steedosCore.getPlugins === \"function\" ? steedosCore.getPlugins() : void 0;\n  return JsonRoutes.sendResult(res, {\n    code: 200,\n    data: result\n  });\n});\n","JsonRoutes.add 'post', '/api/billing/recharge/notify', (req, res, next) ->\r\n\ttry\r\n\t\tbody = \"\"\r\n\t\treq.on('data', (chunk)->\r\n\t\t\tbody += chunk\r\n\t\t)\r\n\t\treq.on('end', Meteor.bindEnvironment((()->\r\n\t\t\t\txml2js = require('xml2js')\r\n\t\t\t\tparser = new xml2js.Parser({ trim:true, explicitArray:false, explicitRoot:false })\r\n\t\t\t\tparser.parseString(body, (err, result)->\r\n\t\t\t\t\t\t# 特别提醒：商户系统对于支付结果通知的内容一定要做签名验证,并校验返回的订单金额是否与商户侧的订单金额一致，防止数据泄漏导致出现“假通知”，造成资金损失\r\n\t\t\t\t\t\tWXPay = require('weixin-pay')\r\n\t\t\t\t\t\twxpay = WXPay({\r\n\t\t\t\t\t\t\tappid: Meteor.settings.billing.appid,\r\n\t\t\t\t\t\t\tmch_id: Meteor.settings.billing.mch_id,\r\n\t\t\t\t\t\t\tpartner_key: Meteor.settings.billing.partner_key #微信商户平台API密钥\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tsign = wxpay.sign(_.clone(result))\r\n\t\t\t\t\t\tattach = JSON.parse(result.attach)\r\n\t\t\t\t\t\tcode_url_id = attach.code_url_id\r\n\t\t\t\t\t\tbpr = db.billing_pay_records.findOne(code_url_id)\r\n\t\t\t\t\t\tif bpr and bpr.total_fee is Number(result.total_fee) and sign is result.sign\r\n\t\t\t\t\t\t\tdb.billing_pay_records.update({_id: code_url_id}, {$set: {paid: true}})\r\n\t\t\t\t\t\t\tbillingManager.special_pay(bpr.space, bpr.modules, Number(result.total_fee), bpr.created_by, bpr.end_date, bpr.user_count)\r\n\t\t\t\t\t\r\n\t\t\t\t)\r\n\t\t\t), (err)->\r\n\t\t\t\tconsole.error err.stack\r\n\t\t\t\tconsole.log 'Failed to bind environment'\r\n\t\t\t)\r\n\t\t)\r\n\t\t\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\n\tres.writeHead(200, {'Content-Type': 'application/xml'})\r\n\tres.end('<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>')\r\n\r\n\t\t","JsonRoutes.add('post', '/api/billing/recharge/notify', function(req, res, next) {\n  var body, e;\n  try {\n    body = \"\";\n    req.on('data', function(chunk) {\n      return body += chunk;\n    });\n    req.on('end', Meteor.bindEnvironment((function() {\n      var parser, xml2js;\n      xml2js = require('xml2js');\n      parser = new xml2js.Parser({\n        trim: true,\n        explicitArray: false,\n        explicitRoot: false\n      });\n      return parser.parseString(body, function(err, result) {\n        var WXPay, attach, bpr, code_url_id, sign, wxpay;\n        WXPay = require('weixin-pay');\n        wxpay = WXPay({\n          appid: Meteor.settings.billing.appid,\n          mch_id: Meteor.settings.billing.mch_id,\n          partner_key: Meteor.settings.billing.partner_key\n        });\n        sign = wxpay.sign(_.clone(result));\n        attach = JSON.parse(result.attach);\n        code_url_id = attach.code_url_id;\n        bpr = db.billing_pay_records.findOne(code_url_id);\n        if (bpr && bpr.total_fee === Number(result.total_fee) && sign === result.sign) {\n          db.billing_pay_records.update({\n            _id: code_url_id\n          }, {\n            $set: {\n              paid: true\n            }\n          });\n          return billingManager.special_pay(bpr.space, bpr.modules, Number(result.total_fee), bpr.created_by, bpr.end_date, bpr.user_count);\n        }\n      });\n    }), function(err) {\n      console.error(err.stack);\n      return console.log('Failed to bind environment');\n    }));\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n  }\n  res.writeHead(200, {\n    'Content-Type': 'application/xml'\n  });\n  return res.end('<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>');\n});\n","Meteor.methods\r\n\tget_contacts_limit: (space)->\r\n\t\t# 根据当前用户所属组织，查询出当前用户限定的组织查看范围\r\n\t\t# 返回的isLimit为true表示限定在当前用户所在组织范围，organizations值记录额外的组织范围\r\n\t\t# 返回的isLimit为false表示不限定组织范围，即表示能看整个工作区的组织\r\n\t\t# 默认返回限定在当前用户所属组织\r\n\t\tcheck space, String\r\n\t\treValue =\r\n\t\t\tisLimit: true\r\n\t\t\toutside_organizations: []\r\n\t\tunless this.userId\r\n\t\t\treturn reValue\r\n\t\tisLimit = false\r\n\t\toutside_organizations = []\r\n\t\tsetting = db.space_settings.findOne({space: space, key: \"contacts_view_limits\"})\r\n\t\tlimits = setting?.values || [];\r\n\r\n\t\tif limits.length\r\n\t\t\tmyOrgs = db.organizations.find({space: space, users: this.userId}, {fields:{_id: 1}})\r\n\t\t\tmyOrgIds = myOrgs.map (n) ->\r\n\t\t\t\treturn n._id\r\n\t\t\tunless myOrgIds.length\r\n\t\t\t\treturn reValue\r\n\t\t\t\r\n\t\t\tmyLitmitOrgIds = []\r\n\t\t\tfor limit in limits\r\n\t\t\t\tfroms = limit.froms\r\n\t\t\t\ttos = limit.tos\r\n\t\t\t\tfromsChildren = db.organizations.find({space: space, parents: {$in: froms}}, {fields:{_id: 1}})\r\n\t\t\t\tfromsChildrenIds = fromsChildren?.map (n) ->\r\n\t\t\t\t\treturn n._id\r\n\t\t\t\tfor myOrgId in myOrgIds\r\n\t\t\t\t\ttempIsLimit = false\r\n\t\t\t\t\tif froms.indexOf(myOrgId) > -1\r\n\t\t\t\t\t\ttempIsLimit = true\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tif fromsChildrenIds.indexOf(myOrgId) > -1\r\n\t\t\t\t\t\t\ttempIsLimit = true\r\n\t\t\t\t\tif tempIsLimit\r\n\t\t\t\t\t\tisLimit = true\r\n\t\t\t\t\t\toutside_organizations.push tos\r\n\t\t\t\t\t\tmyLitmitOrgIds.push myOrgId\r\n\r\n\t\t\tmyLitmitOrgIds = _.uniq myLitmitOrgIds\r\n\t\t\tif myLitmitOrgIds.length < myOrgIds.length\r\n\t\t\t\t# 如果受限的组织个数小于用户所属组织的个数，则说明当前用户至少有一个组织是不受限的\r\n\t\t\t\tisLimit = false\r\n\t\t\t\toutside_organizations = []\r\n\t\t\telse\r\n\t\t\t\toutside_organizations = _.uniq _.flatten outside_organizations\r\n\r\n\t\tif isLimit\r\n\t\t\ttoOrgs = db.organizations.find({space: space, _id: {$in: outside_organizations}}, {fields:{_id: 1, parents: 1}}).fetch()\r\n\t\t\t# 把outside_organizations中有父子节点关系的节点筛选出来并取出最外层节点\r\n\t\t\t# 把outside_organizations中有属于用户所属组织的子孙节点的节点删除\r\n\t\t\torgs = _.filter toOrgs, (org) ->\r\n\t\t\t\tparents = org.parents or []\r\n\t\t\t\treturn _.intersection(parents, outside_organizations).length < 1 and _.intersection(parents, myOrgIds).length < 1\r\n\t\t\toutside_organizations = orgs.map (n) ->\r\n\t\t\t\treturn n._id\r\n\r\n\t\treValue.isLimit = isLimit\r\n\t\treValue.outside_organizations = outside_organizations\r\n\t\treturn reValue\r\n","Meteor.methods({\n  get_contacts_limit: function(space) {\n    var froms, fromsChildren, fromsChildrenIds, i, isLimit, j, len, len1, limit, limits, myLitmitOrgIds, myOrgId, myOrgIds, myOrgs, orgs, outside_organizations, reValue, setting, tempIsLimit, toOrgs, tos;\n    check(space, String);\n    reValue = {\n      isLimit: true,\n      outside_organizations: []\n    };\n    if (!this.userId) {\n      return reValue;\n    }\n    isLimit = false;\n    outside_organizations = [];\n    setting = db.space_settings.findOne({\n      space: space,\n      key: \"contacts_view_limits\"\n    });\n    limits = (setting != null ? setting.values : void 0) || [];\n    if (limits.length) {\n      myOrgs = db.organizations.find({\n        space: space,\n        users: this.userId\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      myOrgIds = myOrgs.map(function(n) {\n        return n._id;\n      });\n      if (!myOrgIds.length) {\n        return reValue;\n      }\n      myLitmitOrgIds = [];\n      for (i = 0, len = limits.length; i < len; i++) {\n        limit = limits[i];\n        froms = limit.froms;\n        tos = limit.tos;\n        fromsChildren = db.organizations.find({\n          space: space,\n          parents: {\n            $in: froms\n          }\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        fromsChildrenIds = fromsChildren != null ? fromsChildren.map(function(n) {\n          return n._id;\n        }) : void 0;\n        for (j = 0, len1 = myOrgIds.length; j < len1; j++) {\n          myOrgId = myOrgIds[j];\n          tempIsLimit = false;\n          if (froms.indexOf(myOrgId) > -1) {\n            tempIsLimit = true;\n          } else {\n            if (fromsChildrenIds.indexOf(myOrgId) > -1) {\n              tempIsLimit = true;\n            }\n          }\n          if (tempIsLimit) {\n            isLimit = true;\n            outside_organizations.push(tos);\n            myLitmitOrgIds.push(myOrgId);\n          }\n        }\n      }\n      myLitmitOrgIds = _.uniq(myLitmitOrgIds);\n      if (myLitmitOrgIds.length < myOrgIds.length) {\n        isLimit = false;\n        outside_organizations = [];\n      } else {\n        outside_organizations = _.uniq(_.flatten(outside_organizations));\n      }\n    }\n    if (isLimit) {\n      toOrgs = db.organizations.find({\n        space: space,\n        _id: {\n          $in: outside_organizations\n        }\n      }, {\n        fields: {\n          _id: 1,\n          parents: 1\n        }\n      }).fetch();\n      orgs = _.filter(toOrgs, function(org) {\n        var parents;\n        parents = org.parents || [];\n        return _.intersection(parents, outside_organizations).length < 1 && _.intersection(parents, myOrgIds).length < 1;\n      });\n      outside_organizations = orgs.map(function(n) {\n        return n._id;\n      });\n    }\n    reValue.isLimit = isLimit;\n    reValue.outside_organizations = outside_organizations;\n    return reValue;\n  }\n});\n","Meteor.methods({\r\n    setKeyValue: function(key, value) {\r\n        check(key, String);\r\n        check(value, Object);\r\n\r\n        obj = {};\r\n        obj.user = this.userId;\r\n        obj.key = key;\r\n        obj.value = value;\r\n\r\n        var c = db.steedos_keyvalues.find({\r\n            user: this.userId,\r\n            key: key\r\n        }).count();\r\n        if (c > 0) {\r\n            db.steedos_keyvalues.update({\r\n                user: this.userId,\r\n                key: key\r\n            }, {\r\n                $set: {\r\n                    value: value\r\n                }\r\n            });\r\n        } else {\r\n            db.steedos_keyvalues.insert(obj);\r\n        }\r\n\r\n        return true;\r\n    }\r\n})","Meteor.methods\r\n\tbilling_settleup: (accounting_month, space_id=\"\")->\r\n\t\tcheck(accounting_month, String)\r\n\t\tcheck(space_id, String)\r\n\r\n\t\tuser = db.users.findOne({_id: this.userId}, {fields: {is_cloudadmin: 1}})\r\n\r\n\t\tif not user.is_cloudadmin\r\n\t\t\treturn\r\n\r\n\t\tconsole.time 'billing'\r\n\t\tspaces = []\r\n\t\tif space_id\r\n\t\t\tspaces = db.spaces.find({_id: space_id, is_paid: true}, {fields: {_id: 1}})\r\n\t\telse\r\n\t\t\tspaces = db.spaces.find({is_paid: true}, {fields: {_id: 1}})\r\n\t\tresult = []\r\n\t\tspaces.forEach (s) ->\r\n\t\t\ttry\r\n\t\t\t\tbillingManager.caculate_by_accounting_month(accounting_month, s._id)\r\n\t\t\tcatch err\r\n\t\t\t\te = {}\r\n\t\t\t\te._id = s._id\r\n\t\t\t\te.name = s.name\r\n\t\t\t\te.err = err\r\n\t\t\t\tresult.push e\r\n\t\tif result.length > 0\r\n\t\t\tconsole.error result\r\n\t\t\ttry\r\n\t\t\t\tEmail = Package.email.Email\r\n\t\t\t\tEmail.send\r\n\t\t\t\t\tto: 'support@steedos.com'\r\n\t\t\t\t\tfrom: Accounts.emailTemplates.from\r\n\t\t\t\t\tsubject: 'billing settleup result'\r\n\t\t\t\t\ttext: JSON.stringify('result': result)\r\n\t\t\tcatch err\r\n\t\t\t\tconsole.error err\r\n\t\tconsole.timeEnd 'billing'","Meteor.methods({\n  billing_settleup: function(accounting_month, space_id) {\n    var Email, err, result, spaces, user;\n    if (space_id == null) {\n      space_id = \"\";\n    }\n    check(accounting_month, String);\n    check(space_id, String);\n    user = db.users.findOne({\n      _id: this.userId\n    }, {\n      fields: {\n        is_cloudadmin: 1\n      }\n    });\n    if (!user.is_cloudadmin) {\n      return;\n    }\n    console.time('billing');\n    spaces = [];\n    if (space_id) {\n      spaces = db.spaces.find({\n        _id: space_id,\n        is_paid: true\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n    } else {\n      spaces = db.spaces.find({\n        is_paid: true\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n    }\n    result = [];\n    spaces.forEach(function(s) {\n      var e, err;\n      try {\n        return billingManager.caculate_by_accounting_month(accounting_month, s._id);\n      } catch (error) {\n        err = error;\n        e = {};\n        e._id = s._id;\n        e.name = s.name;\n        e.err = err;\n        return result.push(e);\n      }\n    });\n    if (result.length > 0) {\n      console.error(result);\n      try {\n        Email = Package.email.Email;\n        Email.send({\n          to: 'support@steedos.com',\n          from: Accounts.emailTemplates.from,\n          subject: 'billing settleup result',\n          text: JSON.stringify({\n            'result': result\n          })\n        });\n      } catch (error) {\n        err = error;\n        console.error(err);\n      }\n    }\n    return console.timeEnd('billing');\n  }\n});\n","Meteor.methods\r\n\tsetUsername: (space_id, username, user_id) ->\r\n\t\tcheck(space_id, String);\r\n\t\tcheck(username, String);\r\n\r\n\t\tif !Steedos.isSpaceAdmin(space_id, Meteor.userId()) and user_id\r\n\t\t\tthrow new Meteor.Error(400, 'contact_space_user_needed')\r\n\r\n\t\tif not Meteor.userId()\r\n\t\t\tthrow new Meteor.Error(400,'error-invalid-user')\r\n\r\n\t\tunless user_id\r\n\t\t\tuser_id = Meteor.user()._id\r\n\r\n\t\tspaceUser = db.space_users.findOne({user: user_id, space: space_id})\r\n\r\n\t\tif spaceUser.invite_state == \"pending\" or spaceUser.invite_state == \"refused\"\r\n\t\t\tthrow new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改用户名\")\r\n\r\n\t\tdb.users.update({_id: user_id}, {$set: {username: username}})\r\n\r\n\t\treturn username\r\n","Meteor.methods({\n  setUsername: function(space_id, username, user_id) {\n    var spaceUser;\n    check(space_id, String);\n    check(username, String);\n    if (!Steedos.isSpaceAdmin(space_id, Meteor.userId()) && user_id) {\n      throw new Meteor.Error(400, 'contact_space_user_needed');\n    }\n    if (!Meteor.userId()) {\n      throw new Meteor.Error(400, 'error-invalid-user');\n    }\n    if (!user_id) {\n      user_id = Meteor.user()._id;\n    }\n    spaceUser = db.space_users.findOne({\n      user: user_id,\n      space: space_id\n    });\n    if (spaceUser.invite_state === \"pending\" || spaceUser.invite_state === \"refused\") {\n      throw new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改用户名\");\n    }\n    db.users.update({\n      _id: user_id\n    }, {\n      $set: {\n        username: username\n      }\n    });\n    return username;\n  }\n});\n","Meteor.methods\r\n\tbilling_recharge: (total_fee, space_id, new_id, module_names, end_date, user_count)->\r\n\t\tcheck total_fee, Number\r\n\t\tcheck space_id, String \r\n\t\tcheck new_id, String \r\n\t\tcheck module_names, Array \r\n\t\tcheck end_date, String \r\n\t\tcheck user_count, Number \r\n\r\n\t\tuser_id = this.userId\r\n\r\n\t\tlistprices = 0\r\n\t\torder_body = []\r\n\t\tdb.modules.find({name: {$in: module_names}}).forEach (m)->\r\n\t\t\tlistprices += m.listprice_rmb\r\n\t\t\torder_body.push m.name_zh\r\n\r\n\t\tspace = db.spaces.findOne(space_id)\r\n\t\tif not space.is_paid\r\n\t\t\tspace_user_count = db.space_users.find({space:space_id}).count()\r\n\t\t\tone_month_yuan = space_user_count * listprices\r\n\t\t\tif total_fee < one_month_yuan*100\r\n\t\t\t\tthrow new Meteor.Error 'error!', \"充值金额应不少于一个月所需费用：￥#{one_month_yuan}\"\r\n\r\n\t\tresult_obj = {}\r\n\r\n\t\tattach = {}\r\n\t\tattach.code_url_id = new_id\r\n\t\tWXPay = require('weixin-pay')\r\n\r\n\t\twxpay = WXPay({\r\n\t\t\tappid: Meteor.settings.billing.appid,\r\n\t\t\tmch_id: Meteor.settings.billing.mch_id,\r\n\t\t\tpartner_key: Meteor.settings.billing.partner_key #微信商户平台API密钥\r\n\t\t})\r\n\r\n\t\twxpay.createUnifiedOrder({\r\n\t\t\tbody: order_body.join(\",\"),\r\n\t\t\tout_trade_no: moment().format('YYYYMMDDHHmmssSSS'),\r\n\t\t\ttotal_fee: total_fee,\r\n\t\t\tspbill_create_ip: '127.0.0.1',\r\n\t\t\tnotify_url: Meteor.absoluteUrl() + 'api/billing/recharge/notify',\r\n\t\t\ttrade_type: 'NATIVE',\r\n\t\t\tproduct_id: moment().format('YYYYMMDDHHmmssSSS'),\r\n\t\t\tattach: JSON.stringify(attach)\r\n\t\t}, Meteor.bindEnvironment(((err, result) -> \r\n\t\t\t\tif err \r\n\t\t\t\t\tconsole.error err.stack\r\n\t\t\t\tif result\r\n\t\t\t\t\tobj = {}\r\n\t\t\t\t\tobj._id = new_id\r\n\t\t\t\t\tobj.created = new Date\r\n\t\t\t\t\tobj.info = result\r\n\t\t\t\t\tobj.total_fee = total_fee\r\n\t\t\t\t\tobj.created_by = user_id\r\n\t\t\t\t\tobj.space = space_id\r\n\t\t\t\t\tobj.paid = false\r\n\t\t\t\t\tobj.modules = module_names\r\n\t\t\t\t\tobj.end_date = end_date\r\n\t\t\t\t\tobj.user_count = user_count\r\n\t\t\t\t\tdb.billing_pay_records.insert(obj)\r\n\t\t\t), ()->\r\n\t\t\t\tconsole.log 'Failed to bind environment'\r\n\t\t\t)\r\n\t\t)\r\n\r\n\t\t\r\n\t\treturn \"success\"","Meteor.methods({\n  billing_recharge: function(total_fee, space_id, new_id, module_names, end_date, user_count) {\n    var WXPay, attach, listprices, one_month_yuan, order_body, result_obj, space, space_user_count, user_id, wxpay;\n    check(total_fee, Number);\n    check(space_id, String);\n    check(new_id, String);\n    check(module_names, Array);\n    check(end_date, String);\n    check(user_count, Number);\n    user_id = this.userId;\n    listprices = 0;\n    order_body = [];\n    db.modules.find({\n      name: {\n        $in: module_names\n      }\n    }).forEach(function(m) {\n      listprices += m.listprice_rmb;\n      return order_body.push(m.name_zh);\n    });\n    space = db.spaces.findOne(space_id);\n    if (!space.is_paid) {\n      space_user_count = db.space_users.find({\n        space: space_id\n      }).count();\n      one_month_yuan = space_user_count * listprices;\n      if (total_fee < one_month_yuan * 100) {\n        throw new Meteor.Error('error!', \"充值金额应不少于一个月所需费用：￥\" + one_month_yuan);\n      }\n    }\n    result_obj = {};\n    attach = {};\n    attach.code_url_id = new_id;\n    WXPay = require('weixin-pay');\n    wxpay = WXPay({\n      appid: Meteor.settings.billing.appid,\n      mch_id: Meteor.settings.billing.mch_id,\n      partner_key: Meteor.settings.billing.partner_key\n    });\n    wxpay.createUnifiedOrder({\n      body: order_body.join(\",\"),\n      out_trade_no: moment().format('YYYYMMDDHHmmssSSS'),\n      total_fee: total_fee,\n      spbill_create_ip: '127.0.0.1',\n      notify_url: Meteor.absoluteUrl() + 'api/billing/recharge/notify',\n      trade_type: 'NATIVE',\n      product_id: moment().format('YYYYMMDDHHmmssSSS'),\n      attach: JSON.stringify(attach)\n    }, Meteor.bindEnvironment((function(err, result) {\n      var obj;\n      if (err) {\n        console.error(err.stack);\n      }\n      if (result) {\n        obj = {};\n        obj._id = new_id;\n        obj.created = new Date;\n        obj.info = result;\n        obj.total_fee = total_fee;\n        obj.created_by = user_id;\n        obj.space = space_id;\n        obj.paid = false;\n        obj.modules = module_names;\n        obj.end_date = end_date;\n        obj.user_count = user_count;\n        return db.billing_pay_records.insert(obj);\n      }\n    }), function() {\n      return console.log('Failed to bind environment');\n    }));\n    return \"success\";\n  }\n});\n","Meteor.methods\r\n\tget_space_user_count: (space_id)->\r\n\t\tcheck space_id, String\r\n\t\tuser_count_info = new Object\r\n\t\tuser_count_info.total_user_count = db.space_users.find({space: space_id}).count()\r\n\t\tuser_count_info.accepted_user_count = db.space_users.find({space: space_id, user_accepted: true}).count()\r\n\t\treturn user_count_info","Meteor.methods\r\n\tcreate_secret: (name)->\r\n\t\tif !this.userId\r\n\t\t\treturn false;\r\n\r\n\t\tdb.users.create_secret this.userId, name\r\n\r\n\tremove_secret: (token)->\r\n\t\tif !this.userId || !token\r\n\t\t\treturn false;\r\n\r\n\t\thashedToken = Accounts._hashLoginToken(token)\r\n\r\n\t\tconsole.log(\"token\", token)\r\n\r\n\t\tdb.users.update({_id: this.userId}, {$pull: {\"secrets\": {hashedToken: hashedToken}}})\r\n","Meteor.methods({\n  create_secret: function(name) {\n    if (!this.userId) {\n      return false;\n    }\n    return db.users.create_secret(this.userId, name);\n  },\n  remove_secret: function(token) {\n    var hashedToken;\n    if (!this.userId || !token) {\n      return false;\n    }\n    hashedToken = Accounts._hashLoginToken(token);\n    console.log(\"token\", token);\n    return db.users.update({\n      _id: this.userId\n    }, {\n      $pull: {\n        \"secrets\": {\n          hashedToken: hashedToken\n        }\n      }\n    });\n  }\n});\n","Meteor.methods\r\n    'object_workflows.get': (spaceId, userId) ->\r\n        check spaceId, String\r\n        check userId, String\r\n\r\n        curSpaceUser = Creator.Collections[\"space_users\"].findOne({space: spaceId, user: userId}, {fields: {organizations: 1}})\r\n        if !curSpaceUser\r\n            throw new Meteor.Error 'not-authorized'\r\n\r\n        organizations = Creator.getCollection('organizations').find({\r\n            _id: {\r\n                $in: curSpaceUser.organizations\r\n            }\r\n        }, {fields: {parents: 1}}).fetch()\r\n\r\n        ows = Creator.getCollection('object_workflows').find({ space: spaceId }, { fields: { object_name: 1, flow_id: 1, space: 1 } }).fetch()\r\n        _.each ows,(o) ->\r\n            fl = Creator.getCollection('flows').findOne(o.flow_id, { fields: { name: 1, perms: 1 } })\r\n            if fl\r\n                o.flow_name = fl.name\r\n                o.can_add = false\r\n\r\n                perms = fl.perms\r\n                if perms\r\n                    if perms.users_can_add && perms.users_can_add.includes(userId)\r\n                        o.can_add = true\r\n                    else if perms.orgs_can_add && perms.orgs_can_add.length > 0\r\n                        if curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_add).length > 0\r\n                            o.can_add = true\r\n                        else\r\n                            if organizations\r\n                                o.can_add = _.some organizations, (org)->\r\n                                    return org.parents && _.intersection(org.parents, perms.orgs_can_add).length > 0\r\n\r\n        ows = ows.filter (n)->\r\n            return n.flow_name\r\n\r\n        return ows","Meteor.methods({\n  'object_workflows.get': function(spaceId, userId) {\n    var curSpaceUser, organizations, ows;\n    check(spaceId, String);\n    check(userId, String);\n    curSpaceUser = Creator.Collections[\"space_users\"].findOne({\n      space: spaceId,\n      user: userId\n    }, {\n      fields: {\n        organizations: 1\n      }\n    });\n    if (!curSpaceUser) {\n      throw new Meteor.Error('not-authorized');\n    }\n    organizations = Creator.getCollection('organizations').find({\n      _id: {\n        $in: curSpaceUser.organizations\n      }\n    }, {\n      fields: {\n        parents: 1\n      }\n    }).fetch();\n    ows = Creator.getCollection('object_workflows').find({\n      space: spaceId\n    }, {\n      fields: {\n        object_name: 1,\n        flow_id: 1,\n        space: 1\n      }\n    }).fetch();\n    _.each(ows, function(o) {\n      var fl, perms;\n      fl = Creator.getCollection('flows').findOne(o.flow_id, {\n        fields: {\n          name: 1,\n          perms: 1\n        }\n      });\n      if (fl) {\n        o.flow_name = fl.name;\n        o.can_add = false;\n        perms = fl.perms;\n        if (perms) {\n          if (perms.users_can_add && perms.users_can_add.includes(userId)) {\n            return o.can_add = true;\n          } else if (perms.orgs_can_add && perms.orgs_can_add.length > 0) {\n            if (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_add).length > 0) {\n              return o.can_add = true;\n            } else {\n              if (organizations) {\n                return o.can_add = _.some(organizations, function(org) {\n                  return org.parents && _.intersection(org.parents, perms.orgs_can_add).length > 0;\n                });\n              }\n            }\n          }\n        }\n      }\n    });\n    ows = ows.filter(function(n) {\n      return n.flow_name;\n    });\n    return ows;\n  }\n});\n","Meteor.methods\r\n\tsetSpaceUserPassword: (space_user_id, space_id, password) ->\r\n\t\tif !this.userId\r\n\t\t\tthrow new Meteor.Error(400, \"请先登录\")\r\n\t\t\r\n\t\tspace = db.spaces.findOne({_id: space_id})\r\n\t\tisSpaceAdmin = space?.admins?.includes(this.userId)\r\n\r\n\t\tunless isSpaceAdmin\r\n\t\t\tthrow new Meteor.Error(400, \"您没有权限修改该用户密码\")\r\n\r\n\t\tspaceUser = db.space_users.findOne({_id: space_user_id, space: space_id})\r\n\t\tuser_id = spaceUser.user;\r\n\t\tuserCP = db.users.findOne({_id: user_id})\r\n\t\tcurrentUser = db.users.findOne({_id: this.userId})\r\n\r\n\t\tif spaceUser.invite_state == \"pending\" or spaceUser.invite_state == \"refused\"\r\n\t\t\tthrow new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改密码\")\r\n\r\n\t\tSteedos.validatePassword(password)\r\n\r\n\t\tAccounts.setPassword(user_id, password, {logout: true})\r\n\r\n\t\t# 如果用户手机号通过验证，就发短信提醒\r\n\t\tif userCP.mobile && userCP.mobile_verified\r\n\t\t\tlang = 'en'\r\n\t\t\tif userCP.locale is 'zh-cn'\r\n\t\t\t\tlang = 'zh-CN'\r\n\t\t\tSMSQueue.send\r\n\t\t\t\tFormat: 'JSON',\r\n\t\t\t\tAction: 'SingleSendSms',\r\n\t\t\t\tParamString: '',\r\n\t\t\t\tRecNum: userCP.mobile,\r\n\t\t\t\tSignName: '华炎办公',\r\n\t\t\t\tTemplateCode: 'SMS_67200967',\r\n\t\t\t\tmsg: TAPi18n.__('sms.change_password.template', {}, lang)\r\n\r\n","Meteor.methods({\n  setSpaceUserPassword: function(space_user_id, space_id, password) {\n    var currentUser, isSpaceAdmin, lang, ref, space, spaceUser, userCP, user_id;\n    if (!this.userId) {\n      throw new Meteor.Error(400, \"请先登录\");\n    }\n    space = db.spaces.findOne({\n      _id: space_id\n    });\n    isSpaceAdmin = space != null ? (ref = space.admins) != null ? ref.includes(this.userId) : void 0 : void 0;\n    if (!isSpaceAdmin) {\n      throw new Meteor.Error(400, \"您没有权限修改该用户密码\");\n    }\n    spaceUser = db.space_users.findOne({\n      _id: space_user_id,\n      space: space_id\n    });\n    user_id = spaceUser.user;\n    userCP = db.users.findOne({\n      _id: user_id\n    });\n    currentUser = db.users.findOne({\n      _id: this.userId\n    });\n    if (spaceUser.invite_state === \"pending\" || spaceUser.invite_state === \"refused\") {\n      throw new Meteor.Error(400, \"该用户尚未同意加入该工作区，无法修改密码\");\n    }\n    Steedos.validatePassword(password);\n    Accounts.setPassword(user_id, password, {\n      logout: true\n    });\n    if (userCP.mobile && userCP.mobile_verified) {\n      lang = 'en';\n      if (userCP.locale === 'zh-cn') {\n        lang = 'zh-CN';\n      }\n      return SMSQueue.send({\n        Format: 'JSON',\n        Action: 'SingleSendSms',\n        ParamString: '',\n        RecNum: userCP.mobile,\n        SignName: '华炎办公',\n        TemplateCode: 'SMS_67200967',\n        msg: TAPi18n.__('sms.change_password.template', {}, lang)\n      });\n    }\n  }\n});\n","billingManager = {}\r\n\r\n# 获得结算周期内的可结算日数\r\n# space_id 结算对象工作区\r\n# accounting_month 结算月，格式：YYYYMM\r\nbillingManager.get_accounting_period = (space_id, accounting_month)->\r\n\tcount_days = 0\r\n\r\n\tend_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\r\n\tend_date = moment(end_date_time.getTime()).format('YYYYMMDD')\r\n\r\n\tbilling = db.billings.findOne({space: space_id, transaction: \"Starting balance\"})\r\n\tfirst_date = billing.billing_date\r\n\r\n\tstart_date = accounting_month + \"01\"\r\n\tstart_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 1-end_date_time.getDate())\r\n\r\n\tif first_date >= end_date # 这个月不在本次结算范围之内，count_days=0\r\n\t\t# do nothing\r\n\telse if start_date <= first_date and first_date < end_date\r\n\t\tcount_days = (end_date_time - start_date_time)/(24*60*60*1000) + 1\r\n\telse if first_date < start_date\r\n\t\tcount_days = (end_date_time - start_date_time)/(24*60*60*1000) + 1\r\n\r\n\treturn {\"count_days\": count_days}\r\n\r\n# 重算这一日的余额\r\nbillingManager.refresh_balance = (space_id, refresh_date)->\r\n\tlast_bill = null\r\n\tbill = db.billings.findOne({space: space_id, created: refresh_date})\r\n\r\n\t# 获取正常付款的小于refresh_date的最近的一条记录\r\n\tpayment_bill = db.billings.findOne(\r\n\t\t{\r\n\t\t\tspace: space_id,\r\n\t\t\tcreated: {\r\n\t\t\t\t$lt: refresh_date\r\n\t\t\t},\r\n\t\t\tbilling_month: bill.billing_month\r\n\t\t},\r\n\t\t{\r\n\t\t\tsort: {\r\n\t\t\t\tmodified: -1\r\n\t\t\t}\r\n\t\t}\r\n\t)\r\n\tif payment_bill\r\n\t\tlast_bill = payment_bill\r\n\telse\r\n\t\t# 获取最新的结算的一条记录\r\n\t\tb_m_d = new Date(parseInt(bill.billing_month.slice(0,4)), parseInt(bill.billing_month.slice(4,6)), 0)\r\n\t\tb_m = moment(b_m_d.getTime()-(b_m_d.getDate()*24*60*60*1000)).format(\"YYYYMM\")\r\n\r\n\t\tapp_bill = db.billings.findOne(\r\n\t\t\t{\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\tbilling_month: b_m\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tsort: {\r\n\t\t\t\t\tmodified: -1\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t)\r\n\t\tif app_bill\r\n\t\t\tlast_bill = app_bill\r\n\r\n\tlast_balance = if last_bill and last_bill.balance then last_bill.balance else 0.0\r\n\r\n\tdebits = if bill.debits then bill.debits else 0.0\r\n\tcredits = if bill.credits then bill.credits else 0.0\r\n\tsetObj = new Object\r\n\tsetObj.balance = Number((last_balance + credits - debits).toFixed(2))\r\n\tsetObj.modified = new Date\r\n\tdb.billings.direct.update({_id: bill._id}, {$set: setObj})\r\n\r\n# 结算当月的支出与余额\r\nbillingManager.get_balance = (space_id, accounting_month, user_count, count_days, module_name, listprice)->\r\n\taccounting_date = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\r\n\tdays_number = accounting_date.getDate()\r\n\taccounting_date_format = moment(accounting_date).format(\"YYYYMMDD\")\r\n\r\n\tdebits = Number(((count_days/days_number) * user_count * listprice).toFixed(2))\r\n\tlast_bill = db.billings.findOne(\r\n\t\t{\r\n\t\t\tspace: space_id,\r\n\t\t\tbilling_date: {\r\n\t\t\t\t$lte: accounting_date_format\r\n\t\t\t}\r\n\t\t},\r\n\t\t{\r\n\t\t\tsort: {\r\n\t\t\t\tmodified: -1\r\n\t\t\t}\r\n\t\t}\r\n\t)\r\n\tlast_balance = if last_bill and last_bill.balance then last_bill.balance else 0.0\r\n\r\n\tnow = new Date\r\n\tnew_bill = new Object\r\n\tnew_bill._id = db.billings._makeNewID()\r\n\tnew_bill.billing_month = accounting_month\r\n\tnew_bill.billing_date = accounting_date_format\r\n\tnew_bill.space = space_id\r\n\tnew_bill.transaction = module_name\r\n\tnew_bill.listprice = listprice\r\n\tnew_bill.user_count = user_count\r\n\tnew_bill.debits = debits\r\n\tnew_bill.balance = Number((last_balance - debits).toFixed(2))\r\n\tnew_bill.created = now\r\n\tnew_bill.modified = now\r\n\tdb.billings.direct.insert(new_bill)\r\n\r\nbillingManager.getSpaceUserCount = (space_id)->\r\n\tdb.space_users.find({space: space_id, user_accepted: true}).count()\r\n\r\nbillingManager.recaculateBalance = (accounting_month, space_id)->\r\n\trefresh_dates = new Array\r\n\tdb.billings.find(\r\n\t\t{\r\n\t\t\tbilling_month: accounting_month,\r\n\t\t\tspace: space_id,\r\n\t\t\ttransaction: {$in: [\"Payment\", \"Service adjustment\"]}\r\n\t\t},\r\n\t\t{\r\n\t\t\tsort: {created: 1}\r\n\t\t}\r\n\t).forEach (bill)->\r\n\t\trefresh_dates.push(bill.created)\r\n\r\n\tif refresh_dates.length > 0\r\n\t\t_.each refresh_dates, (r_d)->\r\n\t\t\tbillingManager.refresh_balance(space_id, r_d)\r\n\r\nbillingManager.get_modules = (space_id, accounting_month)->\r\n\tmodules = new Array\r\n\tstart_date = accounting_month + \"01\"\r\n\tend_date_time = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\r\n\tend_date = moment(end_date_time.getTime()).format('YYYYMMDD')\r\n\r\n\tdb.modules.find().forEach (m)->\r\n\t\tm_changelog = db.modules_changelogs.findOne(\r\n\t\t\t{\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\tmodule: m.name,\r\n\t\t\t\tchange_date: {\r\n\t\t\t\t\t$lte: end_date\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tcreated: -1\r\n\t\t\t}\r\n\t\t)\r\n\t\t# 若未获得可匹配的记录，说明该module未安装，当月不计算费用\r\n\t\tif not m_changelog\r\n\t\t\t#  do nothing\r\n\r\n\t\t# 若该记录的change_date<startdate & operation=“install”，说明当月前已安装，因此需计算费用，将module_name与modules.listprice加入modules数组中\r\n\t\telse if m_changelog.change_date < start_date and m_changelog.operation == \"install\"\r\n\t\t\tmodules.push(m)\r\n\t\t# 若该记录的change_date<startdate & operation=“uninstall”，说明当月前已卸载，因此不计算费用\r\n\t\telse if m_changelog.change_date < start_date and m_changelog.operation == \"uninstall\"\r\n\t\t\t#  do nothing\r\n\t\t# 若该记录的change_date≥startdate，说明当月内发生过安装或卸载的操作，需计算费用，将module_name与modules.listprice加入modules数组中\r\n\t\telse if m_changelog.change_date >= start_date\r\n\t\t\tmodules.push(m)\r\n\r\n\treturn modules\r\n\r\nbillingManager.get_modules_name = ()->\r\n\tmodules_name = new Array\r\n\tdb.modules.find().forEach((m)->\r\n\t\tmodules_name.push(m.name)\r\n\t)\r\n\treturn modules_name\r\n\r\n\r\nbillingManager.caculate_by_accounting_month = (accounting_month, space_id)->\r\n\tif accounting_month > (moment().format('YYYYMM'))\r\n\t\treturn\r\n\tif accounting_month == (moment().format('YYYYMM'))\r\n\t\t# 重算当月的充值后余额\r\n\t\tbillingManager.recaculateBalance(accounting_month, space_id)\r\n\r\n\t\tdebits = 0\r\n\t\tmodules_name = billingManager.get_modules_name()\r\n\t\tb_m_d = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\r\n\t\tb_m = moment(b_m_d.getTime()-(b_m_d.getDate()*24*60*60*1000)).format(\"YYYYMMDD\")\r\n\t\tdb.billings.find(\r\n\t\t\t{\r\n\t\t\t\tbilling_date: b_m,\r\n\t\t\t\tspace: space_id,\r\n\t\t\t\ttransaction: {\r\n\t\t\t\t\t$in: modules_name\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t).forEach((b)->\r\n\t\t\tdebits += b.debits\r\n\t\t)\r\n\t\tnewest_bill = db.billings.findOne({space: space_id}, {sort: {modified: -1}})\r\n\t\tbalance = newest_bill.balance\r\n\t\tremaining_months = 0\r\n\t\tif balance > 0\r\n\t\t\tif debits > 0\r\n\t\t\t\tremaining_months = parseInt(balance/debits) + 1\r\n\t\t\telse\r\n\t\t\t\t# 当月刚升级，并没有扣款\r\n\t\t\t\tremaining_months = 1\r\n\r\n\t\tdb.spaces.direct.update(\r\n\t\t\t{\r\n\t\t\t\t_id: space_id\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t$set: {\r\n\t\t\t\t\tbalance: balance,\r\n\t\t\t\t\t\"billing.remaining_months\": remaining_months\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t)\r\n\telse\r\n\t\t# 获得其结算对象日期paymentdates数组和count_days可结算日数\r\n\t\tperiod_result = billingManager.get_accounting_period(space_id, accounting_month)\r\n\t\tif period_result[\"count_days\"] == 0\r\n\t\t\t# 也需对当月的充值记录执行更新\r\n\t\t\tbillingManager.recaculateBalance(accounting_month, space_id)\r\n\r\n\t\telse\r\n\t\t\tuser_count = billingManager.getSpaceUserCount(space_id)\r\n\r\n\t\t\t# 清除当月的已结算记录\r\n\t\t\tmodules_name = billingManager.get_modules_name()\r\n\t\t\taccounting_date = new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 0)\r\n\t\t\taccounting_date_format = moment(accounting_date).format(\"YYYYMMDD\")\r\n\t\t\tdb.billings.remove(\r\n\t\t\t\t{\r\n\t\t\t\t\tbilling_date: accounting_date_format,\r\n\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\ttransaction: {\r\n\t\t\t\t\t\t$in: modules_name\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t)\r\n\t\t\t# 重算当月的充值后余额\r\n\t\t\tbillingManager.recaculateBalance(accounting_month, space_id)\r\n\r\n\t\t\t# 结算当月的APP使用后余额\r\n\t\t\tmodules = billingManager.get_modules(space_id, accounting_month)\r\n\t\t\tif modules and  modules.length>0\r\n\t\t\t\t_.each modules, (m)->\r\n\t\t\t\t\tbillingManager.get_balance(space_id, accounting_month, user_count, period_result[\"count_days\"], m.name, m.listprice)\r\n\r\n\t\ta_m = moment(new Date(parseInt(accounting_month.slice(0,4)), parseInt(accounting_month.slice(4,6)), 1).getTime()).format(\"YYYYMM\")\r\n\t\tbillingManager.caculate_by_accounting_month(a_m, space_id)\r\n\r\nbillingManager.special_pay = (space_id, module_names, total_fee, operator_id, end_date, user_count)->\r\n\tspace = db.spaces.findOne(space_id)\r\n\r\n\tmodules = space.modules || new Array\r\n\r\n\tnew_modules = _.difference(module_names, modules)\r\n\r\n\tm = moment()\r\n\tnow = m._d\r\n\r\n\tspace_update_obj = new Object\r\n\r\n\t# 更新space是否专业版的标记\r\n\tif space.is_paid isnt true\r\n\t\tspace_update_obj.is_paid = true\r\n\t\tspace_update_obj.start_date = new Date\r\n\r\n\t# 更新modules\r\n\tspace_update_obj.modules = module_names\r\n\tspace_update_obj.modified = now\r\n\tspace_update_obj.modified_by = operator_id\r\n\tspace_update_obj.end_date = new Date(end_date)\r\n\tspace_update_obj.user_limit = user_count\r\n\r\n\tr = db.spaces.direct.update({_id: space_id}, {$set: space_update_obj})\r\n\tif r\r\n\t\t_.each new_modules, (module)->\r\n\t\t\tmcl = new Object\r\n\t\t\tmcl._id = db.modules_changelogs._makeNewID()\r\n\t\t\tmcl.change_date = m.format(\"YYYYMMDD\")\r\n\t\t\tmcl.operator = operator_id\r\n\t\t\tmcl.space = space_id\r\n\t\t\tmcl.operation = \"install\"\r\n\t\t\tmcl.module = module\r\n\t\t\tmcl.created = now\r\n\t\t\tdb.modules_changelogs.insert(mcl)\r\n\r\n\treturn","                   \n\nbillingManager = {};\n\nbillingManager.get_accounting_period = function(space_id, accounting_month) {\n  var billing, count_days, end_date, end_date_time, first_date, start_date, start_date_time;\n  count_days = 0;\n  end_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  end_date = moment(end_date_time.getTime()).format('YYYYMMDD');\n  billing = db.billings.findOne({\n    space: space_id,\n    transaction: \"Starting balance\"\n  });\n  first_date = billing.billing_date;\n  start_date = accounting_month + \"01\";\n  start_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 1 - end_date_time.getDate());\n  if (first_date >= end_date) {\n\n  } else if (start_date <= first_date && first_date < end_date) {\n    count_days = (end_date_time - start_date_time) / (24 * 60 * 60 * 1000) + 1;\n  } else if (first_date < start_date) {\n    count_days = (end_date_time - start_date_time) / (24 * 60 * 60 * 1000) + 1;\n  }\n  return {\n    \"count_days\": count_days\n  };\n};\n\nbillingManager.refresh_balance = function(space_id, refresh_date) {\n  var app_bill, b_m, b_m_d, bill, credits, debits, last_balance, last_bill, payment_bill, setObj;\n  last_bill = null;\n  bill = db.billings.findOne({\n    space: space_id,\n    created: refresh_date\n  });\n  payment_bill = db.billings.findOne({\n    space: space_id,\n    created: {\n      $lt: refresh_date\n    },\n    billing_month: bill.billing_month\n  }, {\n    sort: {\n      modified: -1\n    }\n  });\n  if (payment_bill) {\n    last_bill = payment_bill;\n  } else {\n    b_m_d = new Date(parseInt(bill.billing_month.slice(0, 4)), parseInt(bill.billing_month.slice(4, 6)), 0);\n    b_m = moment(b_m_d.getTime() - (b_m_d.getDate() * 24 * 60 * 60 * 1000)).format(\"YYYYMM\");\n    app_bill = db.billings.findOne({\n      space: space_id,\n      billing_month: b_m\n    }, {\n      sort: {\n        modified: -1\n      }\n    });\n    if (app_bill) {\n      last_bill = app_bill;\n    }\n  }\n  last_balance = last_bill && last_bill.balance ? last_bill.balance : 0.0;\n  debits = bill.debits ? bill.debits : 0.0;\n  credits = bill.credits ? bill.credits : 0.0;\n  setObj = new Object;\n  setObj.balance = Number((last_balance + credits - debits).toFixed(2));\n  setObj.modified = new Date;\n  return db.billings.direct.update({\n    _id: bill._id\n  }, {\n    $set: setObj\n  });\n};\n\nbillingManager.get_balance = function(space_id, accounting_month, user_count, count_days, module_name, listprice) {\n  var accounting_date, accounting_date_format, days_number, debits, last_balance, last_bill, new_bill, now;\n  accounting_date = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  days_number = accounting_date.getDate();\n  accounting_date_format = moment(accounting_date).format(\"YYYYMMDD\");\n  debits = Number(((count_days / days_number) * user_count * listprice).toFixed(2));\n  last_bill = db.billings.findOne({\n    space: space_id,\n    billing_date: {\n      $lte: accounting_date_format\n    }\n  }, {\n    sort: {\n      modified: -1\n    }\n  });\n  last_balance = last_bill && last_bill.balance ? last_bill.balance : 0.0;\n  now = new Date;\n  new_bill = new Object;\n  new_bill._id = db.billings._makeNewID();\n  new_bill.billing_month = accounting_month;\n  new_bill.billing_date = accounting_date_format;\n  new_bill.space = space_id;\n  new_bill.transaction = module_name;\n  new_bill.listprice = listprice;\n  new_bill.user_count = user_count;\n  new_bill.debits = debits;\n  new_bill.balance = Number((last_balance - debits).toFixed(2));\n  new_bill.created = now;\n  new_bill.modified = now;\n  return db.billings.direct.insert(new_bill);\n};\n\nbillingManager.getSpaceUserCount = function(space_id) {\n  return db.space_users.find({\n    space: space_id,\n    user_accepted: true\n  }).count();\n};\n\nbillingManager.recaculateBalance = function(accounting_month, space_id) {\n  var refresh_dates;\n  refresh_dates = new Array;\n  db.billings.find({\n    billing_month: accounting_month,\n    space: space_id,\n    transaction: {\n      $in: [\"Payment\", \"Service adjustment\"]\n    }\n  }, {\n    sort: {\n      created: 1\n    }\n  }).forEach(function(bill) {\n    return refresh_dates.push(bill.created);\n  });\n  if (refresh_dates.length > 0) {\n    return _.each(refresh_dates, function(r_d) {\n      return billingManager.refresh_balance(space_id, r_d);\n    });\n  }\n};\n\nbillingManager.get_modules = function(space_id, accounting_month) {\n  var end_date, end_date_time, modules, start_date;\n  modules = new Array;\n  start_date = accounting_month + \"01\";\n  end_date_time = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n  end_date = moment(end_date_time.getTime()).format('YYYYMMDD');\n  db.modules.find().forEach(function(m) {\n    var m_changelog;\n    m_changelog = db.modules_changelogs.findOne({\n      space: space_id,\n      module: m.name,\n      change_date: {\n        $lte: end_date\n      }\n    }, {\n      created: -1\n    });\n    if (!m_changelog) {\n\n    } else if (m_changelog.change_date < start_date && m_changelog.operation === \"install\") {\n      return modules.push(m);\n    } else if (m_changelog.change_date < start_date && m_changelog.operation === \"uninstall\") {\n\n    } else if (m_changelog.change_date >= start_date) {\n      return modules.push(m);\n    }\n  });\n  return modules;\n};\n\nbillingManager.get_modules_name = function() {\n  var modules_name;\n  modules_name = new Array;\n  db.modules.find().forEach(function(m) {\n    return modules_name.push(m.name);\n  });\n  return modules_name;\n};\n\nbillingManager.caculate_by_accounting_month = function(accounting_month, space_id) {\n  var a_m, accounting_date, accounting_date_format, b_m, b_m_d, balance, debits, modules, modules_name, newest_bill, period_result, remaining_months, user_count;\n  if (accounting_month > (moment().format('YYYYMM'))) {\n    return;\n  }\n  if (accounting_month === (moment().format('YYYYMM'))) {\n    billingManager.recaculateBalance(accounting_month, space_id);\n    debits = 0;\n    modules_name = billingManager.get_modules_name();\n    b_m_d = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n    b_m = moment(b_m_d.getTime() - (b_m_d.getDate() * 24 * 60 * 60 * 1000)).format(\"YYYYMMDD\");\n    db.billings.find({\n      billing_date: b_m,\n      space: space_id,\n      transaction: {\n        $in: modules_name\n      }\n    }).forEach(function(b) {\n      return debits += b.debits;\n    });\n    newest_bill = db.billings.findOne({\n      space: space_id\n    }, {\n      sort: {\n        modified: -1\n      }\n    });\n    balance = newest_bill.balance;\n    remaining_months = 0;\n    if (balance > 0) {\n      if (debits > 0) {\n        remaining_months = parseInt(balance / debits) + 1;\n      } else {\n        remaining_months = 1;\n      }\n    }\n    return db.spaces.direct.update({\n      _id: space_id\n    }, {\n      $set: {\n        balance: balance,\n        \"billing.remaining_months\": remaining_months\n      }\n    });\n  } else {\n    period_result = billingManager.get_accounting_period(space_id, accounting_month);\n    if (period_result[\"count_days\"] === 0) {\n      billingManager.recaculateBalance(accounting_month, space_id);\n    } else {\n      user_count = billingManager.getSpaceUserCount(space_id);\n      modules_name = billingManager.get_modules_name();\n      accounting_date = new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 0);\n      accounting_date_format = moment(accounting_date).format(\"YYYYMMDD\");\n      db.billings.remove({\n        billing_date: accounting_date_format,\n        space: space_id,\n        transaction: {\n          $in: modules_name\n        }\n      });\n      billingManager.recaculateBalance(accounting_month, space_id);\n      modules = billingManager.get_modules(space_id, accounting_month);\n      if (modules && modules.length > 0) {\n        _.each(modules, function(m) {\n          return billingManager.get_balance(space_id, accounting_month, user_count, period_result[\"count_days\"], m.name, m.listprice);\n        });\n      }\n    }\n    a_m = moment(new Date(parseInt(accounting_month.slice(0, 4)), parseInt(accounting_month.slice(4, 6)), 1).getTime()).format(\"YYYYMM\");\n    return billingManager.caculate_by_accounting_month(a_m, space_id);\n  }\n};\n\nbillingManager.special_pay = function(space_id, module_names, total_fee, operator_id, end_date, user_count) {\n  var m, modules, new_modules, now, r, space, space_update_obj;\n  space = db.spaces.findOne(space_id);\n  modules = space.modules || new Array;\n  new_modules = _.difference(module_names, modules);\n  m = moment();\n  now = m._d;\n  space_update_obj = new Object;\n  if (space.is_paid !== true) {\n    space_update_obj.is_paid = true;\n    space_update_obj.start_date = new Date;\n  }\n  space_update_obj.modules = module_names;\n  space_update_obj.modified = now;\n  space_update_obj.modified_by = operator_id;\n  space_update_obj.end_date = new Date(end_date);\n  space_update_obj.user_limit = user_count;\n  r = db.spaces.direct.update({\n    _id: space_id\n  }, {\n    $set: space_update_obj\n  });\n  if (r) {\n    _.each(new_modules, function(module) {\n      var mcl;\n      mcl = new Object;\n      mcl._id = db.modules_changelogs._makeNewID();\n      mcl.change_date = m.format(\"YYYYMMDD\");\n      mcl.operator = operator_id;\n      mcl.space = space_id;\n      mcl.operation = \"install\";\n      mcl.module = module;\n      mcl.created = now;\n      return db.modules_changelogs.insert(mcl);\n    });\n  }\n};\n","Meteor.startup(function () {\r\n\r\n  if (Meteor.settings.cron && Meteor.settings.cron.statistics) {\r\n\r\n    var schedule = require('node-schedule');\r\n    // 定时执行统计\r\n    var rule = Meteor.settings.cron.statistics;\r\n\r\n    var go_next = true;\r\n\r\n    schedule.scheduleJob(rule, Meteor.bindEnvironment(function () {\r\n      if (!go_next)\r\n        return;\r\n      go_next = false;\r\n\r\n      console.time('statistics');\r\n      // 日期格式化 \r\n      var dateFormat = function (date) {\r\n        var datekey = \"\"+date.getFullYear()+\"-\"+(date.getMonth()+1)+\"-\"+(date.getDate());\r\n        return datekey;\r\n      };\r\n      // 计算前一天时间\r\n      var yesterDay = function () {\r\n        var dNow = new Date();   //当前时间\r\n        var dBefore = new Date(dNow.getTime() - 24*3600*1000);   //得到前一天的时间\r\n        return dBefore;\r\n      };\r\n      // 统计当日数据\r\n      var dailyStaticsCount = function (collection, space) {\r\n        var statics = collection.find({\"space\":space[\"_id\"],\"created\":{$gt: yesterDay()}});\r\n        return statics.count();\r\n      };\r\n      // 查询总数\r\n      var staticsCount = function (collection, space) {\r\n        var statics = collection.find({\"space\": space[\"_id\"]});\r\n        return statics.count();\r\n      };\r\n      // 查询拥有者名字\r\n      var ownerName = function (collection, space) {\r\n        var owner = collection.findOne({\"_id\": space[\"owner\"]});\r\n        var name = owner.name;\r\n        return name;\r\n      };\r\n      // 最近登录日期\r\n      var lastLogon = function (collection, space) {\r\n        var lastLogon = 0;\r\n        var sUsers = db.space_users.find({\"space\": space[\"_id\"]}, {fields: {user: 1}}); \r\n        sUsers.forEach(function (sUser) {\r\n          var user = collection.findOne({\"_id\":sUser[\"user\"]});\r\n          if(user && (lastLogon < user.last_logon)){\r\n            lastLogon = user.last_logon;\r\n          }\r\n        })\r\n        return lastLogon;\r\n      };\r\n      // 最近修改日期\r\n      var lastModified = function (collection, space) {\r\n        var obj = collection.find({\"space\": space[\"_id\"]}, {sort: {modified: -1}, limit: 1});\r\n        var objArr = obj.fetch();\r\n        if(objArr.length > 0)\r\n          var mod = objArr[0].modified;\r\n          return mod;\r\n      };\r\n      // 文章附件大小\r\n      var postsAttachments = function (collection, space) {\r\n        var attSize = 0;\r\n        var sizeSum = 0;\r\n        var posts = collection.find({\"space\": space[\"_id\"]});\r\n        posts.forEach(function (post) {\r\n          var atts = cfs.posts.find({\"post\":post[\"_id\"]});\r\n          atts.forEach(function (att) {\r\n            attSize = att.original.size;\r\n            sizeSum += attSize;\r\n          })  \r\n        })\r\n        return sizeSum;\r\n      };\r\n      // 当日新增附件大小\r\n      var dailyPostsAttachments = function (collection, space) {\r\n        var attSize = 0;\r\n        var sizeSum = 0;\r\n        var posts = collection.find({\"space\": space[\"_id\"]});\r\n        posts.forEach(function (post) {\r\n          var atts = cfs.posts.find({\"post\": post[\"_id\"], \"uploadedAt\": {$gt: yesterDay()}});\r\n          atts.forEach(function (att) {\r\n            attSize = att.original.size;\r\n            sizeSum += attSize;\r\n          })\r\n        })\r\n        return sizeSum;\r\n      };\r\n      // 插入数据\r\n      db.spaces.find({\"is_paid\":true}).forEach(function (space) {\r\n        db.steedos_statistics.insert({\r\n          space: space[\"_id\"],\r\n          space_name: space[\"name\"],\r\n          balance: space[\"balance\"],\r\n          owner_name: ownerName(db.users, space),\r\n          created: new Date(),\r\n          steedos:{\r\n            users: staticsCount(db.space_users, space),\r\n            organizations: staticsCount(db.organizations, space),\r\n            last_logon: lastLogon(db.users, space)\r\n          },\r\n          workflow:{\r\n            flows: staticsCount(db.flows, space),\r\n            forms: staticsCount(db.forms, space),\r\n            flow_roles: staticsCount(db.flow_roles, space),\r\n            flow_positions: staticsCount(db.flow_positions, space),\r\n            instances: staticsCount(db.instances, space),\r\n            instances_last_modified: lastModified(db.instances, space),\r\n            daily_flows: dailyStaticsCount(db.flows, space),\r\n            daily_forms: dailyStaticsCount(db.forms, space),\r\n            daily_instances: dailyStaticsCount(db.instances, space)\r\n          },\r\n          cms: {\r\n            sites: staticsCount(db.cms_sites, space),\r\n            posts: staticsCount(db.cms_posts, space),\r\n            posts_last_modified: lastModified(db.cms_posts, space),\r\n            posts_attachments_size: postsAttachments(db.cms_posts, space),\r\n            comments: staticsCount(db.cms_comments, space),\r\n            daily_sites: dailyStaticsCount(db.cms_sites, space),\r\n            daily_posts: dailyStaticsCount(db.cms_posts, space),\r\n            daily_comments: dailyStaticsCount(db.cms_comments, space),\r\n            daily_posts_attachments_size: dailyPostsAttachments(db.cms_posts, space)\r\n          }\r\n        });\r\n      });\r\n      \r\n      console.timeEnd('statistics');\r\n\r\n      go_next = true;\r\n\r\n    }, function () {\r\n      console.log('Failed to bind environment');\r\n    }));\r\n\r\n  }\r\n\r\n})\r\n\r\n\r\n\r\n\r\n","Meteor.startup ->\r\n    Migrations.add\r\n        version: 1\r\n        name: '在线编辑时，需给文件增加lock 属性，防止多人同时编辑 #429, 附件页面使用cfs显示'\r\n        up: ->\r\n            console.time('upgrade_cfs_instance')\r\n            try\r\n                update_cfs_instance = (parent_id, space_id, instance_id, attach_version, isCurrent)->\r\n                    metadata = {parent: parent_id, owner: attach_version['created_by'], owner_name: attach_version['created_by_name'], space: space_id, instance: instance_id, approve: attach_version['approve']}\r\n                    if isCurrent\r\n                        metadata.current = true\r\n\r\n                    cfs.instances.update({_id: attach_version['_rev']}, {$set: {metadata: metadata}})\r\n                i = 0\r\n                db.instances.find({\"attachments.current\": {$exists: true}}, {sort: {modified: -1}, fields: {space: 1, attachments: 1}}).forEach (ins) ->\r\n                    attachs = ins.attachments\r\n                    space_id = ins.space\r\n                    instance_id = ins._id\r\n                    attachs.forEach (att)->\r\n                        current_ver = att.current\r\n                        parent_id = current_ver._rev\r\n                        update_cfs_instance(parent_id, space_id, instance_id, current_ver, true)\r\n\r\n                        if att.historys\r\n                            att.historys.forEach (his) ->\r\n                                update_cfs_instance(parent_id, space_id, instance_id, his, false)\r\n\r\n                    i++\r\n\r\n            catch e\r\n                console.error(e)\r\n\r\n            console.timeEnd('upgrade_cfs_instance')\r\n        down: ->\r\n            console.log('version 1 down')","Meteor.startup(function() {\n  return Migrations.add({\n    version: 1,\n    name: '在线编辑时，需给文件增加lock 属性，防止多人同时编辑 #429, 附件页面使用cfs显示',\n    up: function() {\n      var e, i, update_cfs_instance;\n      console.time('upgrade_cfs_instance');\n      try {\n        update_cfs_instance = function(parent_id, space_id, instance_id, attach_version, isCurrent) {\n          var metadata;\n          metadata = {\n            parent: parent_id,\n            owner: attach_version['created_by'],\n            owner_name: attach_version['created_by_name'],\n            space: space_id,\n            instance: instance_id,\n            approve: attach_version['approve']\n          };\n          if (isCurrent) {\n            metadata.current = true;\n          }\n          return cfs.instances.update({\n            _id: attach_version['_rev']\n          }, {\n            $set: {\n              metadata: metadata\n            }\n          });\n        };\n        i = 0;\n        db.instances.find({\n          \"attachments.current\": {\n            $exists: true\n          }\n        }, {\n          sort: {\n            modified: -1\n          },\n          fields: {\n            space: 1,\n            attachments: 1\n          }\n        }).forEach(function(ins) {\n          var attachs, instance_id, space_id;\n          attachs = ins.attachments;\n          space_id = ins.space;\n          instance_id = ins._id;\n          attachs.forEach(function(att) {\n            var current_ver, parent_id;\n            current_ver = att.current;\n            parent_id = current_ver._rev;\n            update_cfs_instance(parent_id, space_id, instance_id, current_ver, true);\n            if (att.historys) {\n              return att.historys.forEach(function(his) {\n                return update_cfs_instance(parent_id, space_id, instance_id, his, false);\n              });\n            }\n          });\n          return i++;\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_cfs_instance');\n    },\n    down: function() {\n      return console.log('version 1 down');\n    }\n  });\n});\n","Meteor.startup ->\r\n    Migrations.add\r\n        version: 2\r\n        name: '组织结构允许一个人属于多个部门 #379'\r\n        up: ->\r\n            console.log 'version 2 up'\r\n            console.time 'upgrade_space_user'\r\n            try\r\n                collection = db.space_users\r\n                collection.find({organizations: {$exists: false}}, {fields: {organization: 1}}).forEach (su)->\r\n                    if su.organization\r\n                        collection.direct.update(su._id, {$set: {organizations: [su.organization]}})\r\n\r\n            catch e\r\n                console.error e\r\n\r\n            console.timeEnd 'upgrade_space_user'\r\n        down: ->\r\n            console.log 'version 2 down'\r\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 2,\n    name: '组织结构允许一个人属于多个部门 #379',\n    up: function() {\n      var collection, e;\n      console.log('version 2 up');\n      console.time('upgrade_space_user');\n      try {\n        collection = db.space_users;\n        collection.find({\n          organizations: {\n            $exists: false\n          }\n        }, {\n          fields: {\n            organization: 1\n          }\n        }).forEach(function(su) {\n          if (su.organization) {\n            return collection.direct.update(su._id, {\n              $set: {\n                organizations: [su.organization]\n              }\n            });\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_space_user');\n    },\n    down: function() {\n      return console.log('version 2 down');\n    }\n  });\n});\n","Meteor.startup ->\r\n    Migrations.add\r\n        version: 3\r\n        name: '给space_users表email字段赋值'\r\n        up: ->\r\n            console.log 'version 3 up'\r\n            console.time 'upgrade_space_user_email'\r\n            try\r\n                collection = db.space_users\r\n                collection.find({email: {$exists: false}}, {fields: {user: 1}}).forEach (su)->\r\n                    if su.user\r\n                        u = db.users.findOne({_id: su.user}, {fields: {emails: 1}})\r\n                        if u && u.emails && u.emails.length > 0\r\n                            if /^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(u.emails[0].address)\r\n                                address = u.emails[0].address\r\n                                collection.direct.update(su._id, {$set: {email: address}})\r\n                        \r\n\r\n            catch e\r\n                console.error e\r\n\r\n            console.timeEnd 'upgrade_space_user_email'\r\n        down: ->\r\n            console.log 'version 3 down'\r\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 3,\n    name: '给space_users表email字段赋值',\n    up: function() {\n      var collection, e;\n      console.log('version 3 up');\n      console.time('upgrade_space_user_email');\n      try {\n        collection = db.space_users;\n        collection.find({\n          email: {\n            $exists: false\n          }\n        }, {\n          fields: {\n            user: 1\n          }\n        }).forEach(function(su) {\n          var address, u;\n          if (su.user) {\n            u = db.users.findOne({\n              _id: su.user\n            }, {\n              fields: {\n                emails: 1\n              }\n            });\n            if (u && u.emails && u.emails.length > 0) {\n              if (/^([A-Z0-9\\.\\-\\_\\+])*([A-Z0-9\\+\\-\\_])+\\@[A-Z0-9]+([\\-][A-Z0-9]+)*([\\.][A-Z0-9\\-]+){1,8}$/i.test(u.emails[0].address)) {\n                address = u.emails[0].address;\n                return collection.direct.update(su._id, {\n                  $set: {\n                    email: address\n                  }\n                });\n              }\n            }\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_space_user_email');\n    },\n    down: function() {\n      return console.log('version 3 down');\n    }\n  });\n});\n","Meteor.startup ->\r\n    Migrations.add\r\n        version: 4\r\n        name: '给organizations表设置sort_no'\r\n        up: ->\r\n            console.log 'version 4 up'\r\n            console.time 'upgrade_organizations_sort_no'\r\n            try\r\n                db.organizations.direct.update({sort_no: {$exists: false}}, {$set: {sort_no: 100}}, {multi: true})\r\n            catch e\r\n                console.error e\r\n\r\n            console.timeEnd 'upgrade_organizations_sort_no'\r\n        down: ->\r\n            console.log 'version 4 down'\r\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 4,\n    name: '给organizations表设置sort_no',\n    up: function() {\n      var e;\n      console.log('version 4 up');\n      console.time('upgrade_organizations_sort_no');\n      try {\n        db.organizations.direct.update({\n          sort_no: {\n            $exists: false\n          }\n        }, {\n          $set: {\n            sort_no: 100\n          }\n        }, {\n          multi: true\n        });\n      } catch (error) {\n        e = error;\n        console.error(e);\n      }\n      return console.timeEnd('upgrade_organizations_sort_no');\n    },\n    down: function() {\n      return console.log('version 4 down');\n    }\n  });\n});\n","Meteor.startup ->\r\n\tMigrations.add\r\n\t\tversion: 5\r\n\t\tname: '解决删除organization导致space_user数据错误的问题'\r\n\t\tup: ->\r\n\t\t\tconsole.log 'version 5 up'\r\n\t\t\tconsole.time 'fix_space_user_organizations'\r\n\t\t\ttry\r\n\r\n\t\t\t\tdb.space_users.find().forEach (su)->\r\n\t\t\t\t\tif not su.organizations\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\tif su.organizations.length is 1\r\n\t\t\t\t\t\tcheck_count = db.organizations.find(su.organizations[0]).count()\r\n\t\t\t\t\t\tif check_count is 0\r\n\t\t\t\t\t\t\troot_org = db.organizations.findOne({space: su.space, parent: null})\r\n\t\t\t\t\t\t\tif root_org\r\n\t\t\t\t\t\t\t\tr = db.space_users.direct.update({_id: su._id}, {$set: {organizations: [root_org._id], organization: root_org._id}})\r\n\t\t\t\t\t\t\t\tif r\r\n\t\t\t\t\t\t\t\t\troot_org.updateUsers()\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tconsole.error \"fix_space_user_organizations\"\r\n\t\t\t\t\t\t\t\tconsole.error su._id\r\n\t\t\t\t\telse if su.organizations.length > 1\r\n\t\t\t\t\t\tremoved_org_ids = []\r\n\t\t\t\t\t\tsu.organizations.forEach (o)->\r\n\t\t\t\t\t\t\tcheck_count = db.organizations.find(o).count()\r\n\t\t\t\t\t\t\tif check_count is 0\r\n\t\t\t\t\t\t\t\tremoved_org_ids.push(o)\r\n\t\t\t\t\t\tif removed_org_ids.length > 0\r\n\t\t\t\t\t\t\tnew_org_ids = _.difference(su.organizations, removed_org_ids)\r\n\t\t\t\t\t\t\tif new_org_ids.includes(su.organization)\r\n\t\t\t\t\t\t\t\tdb.space_users.direct.update({_id: su._id}, {$set: {organizations: new_org_ids}})\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tdb.space_users.direct.update({_id: su._id}, {$set: {organizations: new_org_ids, organization: new_org_ids[0]}})\r\n\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.error \"fix_space_user_organizations\"\r\n\t\t\t\tconsole.error e.stack\r\n\r\n\t\t\tconsole.timeEnd 'fix_space_user_organizations'\r\n\t\tdown: ->\r\n\t\t\tconsole.log 'version 5 down'\r\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 5,\n    name: '解决删除organization导致space_user数据错误的问题',\n    up: function() {\n      var e;\n      console.log('version 5 up');\n      console.time('fix_space_user_organizations');\n      try {\n        db.space_users.find().forEach(function(su) {\n          var check_count, new_org_ids, r, removed_org_ids, root_org;\n          if (!su.organizations) {\n            return;\n          }\n          if (su.organizations.length === 1) {\n            check_count = db.organizations.find(su.organizations[0]).count();\n            if (check_count === 0) {\n              root_org = db.organizations.findOne({\n                space: su.space,\n                parent: null\n              });\n              if (root_org) {\n                r = db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: [root_org._id],\n                    organization: root_org._id\n                  }\n                });\n                if (r) {\n                  return root_org.updateUsers();\n                }\n              } else {\n                console.error(\"fix_space_user_organizations\");\n                return console.error(su._id);\n              }\n            }\n          } else if (su.organizations.length > 1) {\n            removed_org_ids = [];\n            su.organizations.forEach(function(o) {\n              check_count = db.organizations.find(o).count();\n              if (check_count === 0) {\n                return removed_org_ids.push(o);\n              }\n            });\n            if (removed_org_ids.length > 0) {\n              new_org_ids = _.difference(su.organizations, removed_org_ids);\n              if (new_org_ids.includes(su.organization)) {\n                return db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: new_org_ids\n                  }\n                });\n              } else {\n                return db.space_users.direct.update({\n                  _id: su._id\n                }, {\n                  $set: {\n                    organizations: new_org_ids,\n                    organization: new_org_ids[0]\n                  }\n                });\n              }\n            }\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(\"fix_space_user_organizations\");\n        console.error(e.stack);\n      }\n      return console.timeEnd('fix_space_user_organizations');\n    },\n    down: function() {\n      return console.log('version 5 down');\n    }\n  });\n});\n","Meteor.startup ->\r\n\tMigrations.add\r\n\t\tversion: 6\r\n\t\tname: '财务系统升级'\r\n\t\tup: ->\r\n\t\t\tconsole.log 'version 6 up'\r\n\t\t\tconsole.time 'billing upgrade'\r\n\t\t\ttry\r\n\t\t\t\t# 清空modules表\r\n\t\t\t\tdb.modules.remove({})\r\n\r\n\t\t\t\tdb.modules.insert({\r\n\t\t\t\t\t\"_id\": \"workflow.standard\",\r\n\t\t\t\t\t\"name_en\": \"Workflow Standard\",\r\n\t\t\t\t\t\"name\": \"workflow.standard\",\r\n\t\t\t\t\t\"name_zh\": \"审批王基础版\",\r\n\t\t\t\t\t\"listprice\": 1.0,\r\n\t\t\t\t\t\"listprice_rmb\": 2\r\n\t\t\t\t})\r\n\r\n\t\t\t\tdb.modules.insert({\r\n\t\t\t\t\t\"_id\": \"workflow.professional\",\r\n\t\t\t\t\t\"name_en\": \"Workflow Professional\",\r\n\t\t\t\t\t\"name\": \"workflow.professional\",\r\n\t\t\t\t\t\"name_zh\": \"审批王专业版扩展包\",\r\n\t\t\t\t\t\"listprice\": 3.0,\r\n\t\t\t\t\t\"listprice_rmb\": 18\r\n\t\t\t\t})\r\n\r\n\t\t\t\tdb.modules.insert({\r\n\t\t\t\t\t\"_id\": \"workflow.enterprise\",\r\n\t\t\t\t\t\"name_en\": \"Workflow Enterprise\",\r\n\t\t\t\t\t\"name\": \"workflow.enterprise\",\r\n\t\t\t\t\t\"name_zh\": \"审批王企业版扩展包\",\r\n\t\t\t\t\t\"listprice\": 6.0,\r\n\t\t\t\t\t\"listprice_rmb\": 40\r\n\t\t\t\t})\r\n\r\n\r\n\t\t\t\tstart_date = new Date(moment(new Date).format(\"YYYY-MM-DD\"))\r\n\t\t\t\tdb.spaces.find({is_paid: true, user_limit: {$exists: false}, modules: {$exists: true}}).forEach (s)->\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\tset_obj = {}\r\n\t\t\t\t\t\tuser_count = db.space_users.find({space: s._id, user_accepted: true}).count()\r\n\t\t\t\t\t\tset_obj.user_limit = user_count\r\n\t\t\t\t\t\tbalance = s.balance\r\n\t\t\t\t\t\tif balance > 0\r\n\t\t\t\t\t\t\tmonths = 0\r\n\t\t\t\t\t\t\tlistprices = 0\r\n\t\t\t\t\t\t\t_.each s.modules, (pm)->\r\n\t\t\t\t\t\t\t\tmodule = db.modules.findOne({name: pm})\r\n\t\t\t\t\t\t\t\tif module and module.listprice\r\n\t\t\t\t\t\t\t\t\tlistprices += module.listprice\r\n\t\t\t\t\t\t\tmonths = parseInt((balance/(listprices*user_count)).toFixed()) + 1\r\n\t\t\t\t\t\t\tend_date = new Date\r\n\t\t\t\t\t\t\tend_date.setMonth(end_date.getMonth()+months)\r\n\t\t\t\t\t\t\tend_date = new Date(moment(end_date).format(\"YYYY-MM-DD\"))\r\n\t\t\t\t\t\t\tset_obj.start_date = start_date\r\n\t\t\t\t\t\t\tset_obj.end_date = end_date\r\n\r\n\t\t\t\t\t\telse if balance <= 0\r\n\t\t\t\t\t\t\tset_obj.start_date = start_date\r\n\t\t\t\t\t\t\tset_obj.end_date = new Date\r\n\r\n\t\t\t\t\t\ts.modules.push(\"workflow.standard\")\r\n\t\t\t\t\t\tset_obj.modules = _.uniq(s.modules)\r\n\t\t\t\t\t\tdb.spaces.direct.update({_id: s._id}, {$set: set_obj})\r\n\t\t\t\t\tcatch e\r\n\t\t\t\t\t\tconsole.error \"billing space upgrade\"\r\n\t\t\t\t\t\tconsole.error(s._id)\r\n\t\t\t\t\t\tconsole.error(set_obj)\r\n\t\t\t\t\t\tconsole.error e.stack\r\n\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.error \"billing upgrade\"\r\n\t\t\t\tconsole.error e.stack\r\n\r\n\t\t\tconsole.timeEnd 'billing upgrade'\r\n\t\tdown: ->\r\n\t\t\tconsole.log 'version 6 down'\r\n","Meteor.startup(function() {\n  return Migrations.add({\n    version: 6,\n    name: '财务系统升级',\n    up: function() {\n      var e, start_date;\n      console.log('version 6 up');\n      console.time('billing upgrade');\n      try {\n        db.modules.remove({});\n        db.modules.insert({\n          \"_id\": \"workflow.standard\",\n          \"name_en\": \"Workflow Standard\",\n          \"name\": \"workflow.standard\",\n          \"name_zh\": \"审批王基础版\",\n          \"listprice\": 1.0,\n          \"listprice_rmb\": 2\n        });\n        db.modules.insert({\n          \"_id\": \"workflow.professional\",\n          \"name_en\": \"Workflow Professional\",\n          \"name\": \"workflow.professional\",\n          \"name_zh\": \"审批王专业版扩展包\",\n          \"listprice\": 3.0,\n          \"listprice_rmb\": 18\n        });\n        db.modules.insert({\n          \"_id\": \"workflow.enterprise\",\n          \"name_en\": \"Workflow Enterprise\",\n          \"name\": \"workflow.enterprise\",\n          \"name_zh\": \"审批王企业版扩展包\",\n          \"listprice\": 6.0,\n          \"listprice_rmb\": 40\n        });\n        start_date = new Date(moment(new Date).format(\"YYYY-MM-DD\"));\n        db.spaces.find({\n          is_paid: true,\n          user_limit: {\n            $exists: false\n          },\n          modules: {\n            $exists: true\n          }\n        }).forEach(function(s) {\n          var balance, e, end_date, listprices, months, set_obj, user_count;\n          try {\n            set_obj = {};\n            user_count = db.space_users.find({\n              space: s._id,\n              user_accepted: true\n            }).count();\n            set_obj.user_limit = user_count;\n            balance = s.balance;\n            if (balance > 0) {\n              months = 0;\n              listprices = 0;\n              _.each(s.modules, function(pm) {\n                var module;\n                module = db.modules.findOne({\n                  name: pm\n                });\n                if (module && module.listprice) {\n                  return listprices += module.listprice;\n                }\n              });\n              months = parseInt((balance / (listprices * user_count)).toFixed()) + 1;\n              end_date = new Date;\n              end_date.setMonth(end_date.getMonth() + months);\n              end_date = new Date(moment(end_date).format(\"YYYY-MM-DD\"));\n              set_obj.start_date = start_date;\n              set_obj.end_date = end_date;\n            } else if (balance <= 0) {\n              set_obj.start_date = start_date;\n              set_obj.end_date = new Date;\n            }\n            s.modules.push(\"workflow.standard\");\n            set_obj.modules = _.uniq(s.modules);\n            return db.spaces.direct.update({\n              _id: s._id\n            }, {\n              $set: set_obj\n            });\n          } catch (error) {\n            e = error;\n            console.error(\"billing space upgrade\");\n            console.error(s._id);\n            console.error(set_obj);\n            return console.error(e.stack);\n          }\n        });\n      } catch (error) {\n        e = error;\n        console.error(\"billing upgrade\");\n        console.error(e.stack);\n      }\n      return console.timeEnd('billing upgrade');\n    },\n    down: function() {\n      return console.log('version 6 down');\n    }\n  });\n});\n","Meteor.startup ()->\r\n\tnew Tabular.Table\r\n\t\tname: \"customize_apps\",\r\n\t\tcollection: db.apps,\r\n\t\tcolumns: [\r\n\t\t\t{\r\n\t\t\t\tdata: \"name\"\r\n\t\t\t\torderable: false\r\n\t\t\t}\r\n\t\t]\r\n\t\tdom: \"tp\"\r\n\t\textraFields: [\"_id\", \"space\"]\r\n\t\tlengthChange: false\r\n\t\tordering: false\r\n\t\tpageLength: 10\r\n\t\tinfo: false\r\n\t\tsearching: true\r\n\t\tautoWidth: true\r\n\t\tchangeSelector: (selector, userId) ->\r\n\t\t\tunless userId\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\tspace = selector.space\r\n\t\t\tunless space\r\n\t\t\t\tif selector?.$and?.length > 0\r\n\t\t\t\t\tspace = selector.$and.getProperty('space')[0]\r\n\t\t\tunless space\r\n\t\t\t\treturn {_id: -1}\r\n\t\t\treturn selector","Meteor.startup(function() {\n  return new Tabular.Table({\n    name: \"customize_apps\",\n    collection: db.apps,\n    columns: [\n      {\n        data: \"name\",\n        orderable: false\n      }\n    ],\n    dom: \"tp\",\n    extraFields: [\"_id\", \"space\"],\n    lengthChange: false,\n    ordering: false,\n    pageLength: 10,\n    info: false,\n    searching: true,\n    autoWidth: true,\n    changeSelector: function(selector, userId) {\n      var ref, space;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      space = selector.space;\n      if (!space) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          space = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!space) {\n        return {\n          _id: -1\n        };\n      }\n      return selector;\n    }\n  });\n});\n"]}