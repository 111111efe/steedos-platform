{"version":3,"sources":["meteor://💻app/packages/steedos:creator/checkNpm.js","meteor://💻app/packages/steedos_creator/core.coffee","meteor://💻app/core.coffee","meteor://💻app/packages/steedos_creator/lib/apps.coffee","meteor://💻app/packages/steedos_creator/server/methods/object_recent_viewed.coffee","meteor://💻app/server/methods/object_recent_viewed.coffee","meteor://💻app/packages/steedos_creator/server/methods/object_recent_record.coffee","meteor://💻app/server/methods/object_recent_record.coffee","meteor://💻app/packages/steedos_creator/server/methods/object_listviews_options.coffee","meteor://💻app/server/methods/object_listviews_options.coffee","meteor://💻app/packages/steedos_creator/server/methods/report_data.coffee","meteor://💻app/server/methods/report_data.coffee","meteor://💻app/packages/steedos_creator/server/methods/user_tabular_settings.coffee","meteor://💻app/server/methods/user_tabular_settings.coffee","meteor://💻app/packages/steedos_creator/server/methods/object_export2xml.coffee","meteor://💻app/server/methods/object_export2xml.coffee","meteor://💻app/packages/steedos_creator/server/methods/related_objects_records.coffee","meteor://💻app/server/methods/related_objects_records.coffee","meteor://💻app/packages/steedos_creator/server/publications/object.coffee","meteor://💻app/server/publications/object.coffee","meteor://💻app/packages/steedos_creator/server/publications/object_tabular.coffee","meteor://💻app/server/publications/object_tabular.coffee","meteor://💻app/packages/steedos_creator/server/publications/object_listviews.coffee","meteor://💻app/packages/steedos_creator/server/publications/user_tabular_settings.coffee","meteor://💻app/packages/steedos_creator/server/publications/related_objects_records.coffee","meteor://💻app/server/publications/related_objects_records.coffee","meteor://💻app/packages/steedos_creator/server/publications/space_user_info.coffee","meteor://💻app/packages/steedos_creator/server/publications/contacts_view_limits.coffee","meteor://💻app/server/publications/contacts_view_limits.coffee","meteor://💻app/packages/steedos_creator/server/publications/contacts_no_force_phone_users.coffee","meteor://💻app/server/publications/contacts_no_force_phone_users.coffee","meteor://💻app/packages/steedos_creator/server/lib/permission_manager.coffee","meteor://💻app/server/lib/permission_manager.coffee","meteor://💻app/packages/steedos_creator/server/lib/uuflow_manager.coffee","meteor://💻app/server/lib/uuflow_manager.coffee","meteor://💻app/packages/steedos_creator/server/routes/s3.coffee","meteor://💻app/server/routes/s3.coffee","meteor://💻app/packages/steedos_creator/server/routes/api_workflow_drafts.coffee","meteor://💻app/server/routes/api_workflow_drafts.coffee"],"names":["checkNpmVersions","module","link","v","busboy","mkdirp","Meteor","settings","cfs","aliyun","Creator","getSchema","object_name","ref","getObject","schema","getObjectFirstListViewUrl","app_id","list_view","list_view_id","getObjectFirstListView","_id","Session","get","getRelativeUrl","getObjectUrl","record_id","getListView","getObjectRouterUrl","getListViewUrl","url","getListViewRelativeUrl","getSwitchListUrl","getRelatedObjectUrl","related_object_name","getObjectLookupFieldOptions","is_deep","is_skip_hide","_object","_options","fields","icon","_","forEach","f","k","hidden","type","push","label","value","r_object","reference_to","f2","k2","getObjectFilterFieldOptions","permission_fields","getFields","include","test","indexOf","getFiltersWithFilterFields","filters","filter_fields","length","n","isString","field","required","findWhere","is_default","is_required","filterItem","matchField","find","getObjectRecord","select_fields","expand","collection","record","ref1","ref2","isClient","Template","instance","odata","getCollection","findOne","getApp","app","Apps","deps","depend","getAppObjectNames","objects","each","obj","permissions","allowRead","getVisibleApps","includeAdmin","apps","visible","getVisibleAppsObjects","visibleObjectNames","flatten","pluck","filter","Objects","name","sort","sortingMethod","bind","key","uniq","getAppsObjects","tempObjects","concat","validateFilters","logic","e","errorMsg","filter_items","filter_length","flag","index","word","map","isEmpty","compact","replace","match","i","includes","w","error","console","log","toastr","formatFiltersToMongo","options","selector","Array","operation","option","reg","sub_selector","evaluateFormula","RegExp","isBetweenFilterOperation","getBetweenTimeBuiltinValues","formatFiltersToDev","logicTempFilters","steedosFilters","require","is_logic_or","pop","USER_CONTEXT","formatLogicFiltersToDev","filter_logic","format_logic","x","_f","isArray","JSON","stringify","getRelatedObjects","spaceId","userId","related_object_names","related_objects","unrelated_objects","getObjectRelateds","_collection_name","getPermissions","difference","related_object","isActive","getRelatedObjectNames","getActions","actions","disabled_actions","sortBy","values","action","Steedos","isMobile","on","getListViews","disabled_list_views","list_views","object","item","item_name","owner","fieldsName","unreadable_fields","getObjectFieldsName","isloading","bootstrapLoaded","convertSpecialCharacter","str","getDisabledFields","fieldName","autoform","disabled","omit","getHiddenFields","getFieldsWithNoGroup","group","getSortedFieldGroupNames","names","unique","getFieldsForGroup","groupName","getFieldsWithoutOmit","keys","pick","getFieldsInFirstLevel","firstLevelKeys","getFieldsForReorder","isSingle","childKeys","is_range_1","is_range_2","is_wide_1","is_wide_2","sc_1","sc_2","is_wide","is_range","slice","isServer","getAllRelatedObjects","related_field","related_field_name","enable_files","appsByName","methods","collection_recent_viewed","current_recent_viewed","doc","space","update","$inc","count","$set","modified","Date","modified_by","insert","_makeNewID","o","ids","created","created_by","async_recent_aggregate","recent_aggregate","search_object","_records","callback","Collections","object_recent_viewed","rawCollection","aggregate","$match","$group","maxCreated","$max","$sort","$limit","toArray","err","data","Error","isFunction","wrapAsync","searchText","_object_collection","_object_name_key","query","query_and","records","search_Keywords","NAME_FIELD_KEY","split","keyword","subquery","$regex","trim","$and","$in","limit","_name","_object_name","record_object","record_object_collection","self","objectsByName","object_record","enable_search","update_filters","listview_id","filter_scope","object_listviews","direct","update_columns","columns","check","compoundFields","cursor","filterFields","objectFields","result","Object","childKey","objectField","splits","isCommonSpace","isSpaceAdmin","skip","fetch","compoundFieldItem","compoundFilterFields","itemKey","itemValue","referenceItem","setting","column_width","obj1","_id_actions","_mixFieldsData","_mixRelatedData","_writeXmlFile","fs","logger","path","xml2js","Logger","jsonObj","objName","builder","day","fileAddress","fileName","filePath","month","now","stream","xml","year","Builder","buildObject","Buffer","getFullYear","getMonth","getDate","join","__meteor_bootstrap__","serverDir","existsSync","sync","writeFile","mixBool","mixDate","mixDefault","objFields","field_name","date","dateStr","format","moment","relatedObjNames","relatedObjName","relatedCollection","relatedRecordList","relatedTableData","relatedObj","fieldsData","Export2xml","recordList","info","time","recordObj","timeEnd","related_objects_records","related_records","viewAllRecords","publish","id","space_id","publishComposite","tableName","_fields","_keys","object_colleciton","reference_fields","ready","String","Match","Optional","getObjectName","unblock","field_keys","children","_objectKeys","reference_field","parent","children_fields","name_field_key","p_k","reference_ids","reference_to_object","s_k","getProperty","reduce","isObject","shared","user","db","space_settings","permissionManager","getFlowPermissions","flow_id","user_id","flow","my_permissions","org_ids","organizations","orgs_can_add","orgs_can_admin","orgs_can_monitor","users_can_add","users_can_admin","users_can_monitor","uuflowManager","getFlow","users","parents","org","parent_id","perms","org_id","_eval","check_authorization","req","authToken","hashedToken","Accounts","_hashLoginToken","getSpace","spaces","flows","getSpaceUser","space_user","space_users","getSpaceUserOrgInfo","organization","fullname","organization_name","organization_fullname","isFlowEnabled","state","isFlowSpaceMatched","getForm","form_id","form","forms","getCategory","category_id","categories","create_instance","instance_from_client","user_info","appr_obj","approve_from_client","category","ins_obj","new_ins_id","space_user_org_info","start_step","trace_from_client","trace_obj","checkIsInApproval","instances","flow_version","current","form_version","submitter","submitter_name","applicant","applicant_name","applicant_organization","applicant_organization_name","applicant_organization_fullname","applicant_company","company_id","code","is_archived","is_deleted","record_ids","Mongo","ObjectID","_str","is_finished","steps","step","step_type","start_date","trace","user_name","handler","handler_name","handler_organization","handler_organization_name","handler_organization_fullname","read_date","is_read","is_error","description","initiateValues","approves","traces","inbox_users","current_step_name","auto_remind","flow_name","category_name","initiateAttach","initiateRecordInstanceInfo","recordIds","flowId","fieldCodes","filterValues","ow","tableFieldCodes","tableFieldMap","ff","object_workflows","field_map","fm","fieldsObj","lookupFieldName","lookupObject","oTableCode","objectFieldName","wTableCode","workflow_field","object_field","hasOwnProperty","workflow_table_field_code","object_table_field_code","multiple","tfc","c","parse","tr","newTr","tfm","wTdCode","field_map_script","extend","evalFieldMapScript","objectName","objectId","func","script","insId","approveId","cf","versions","versionId","idx","newFile","FS","File","attachData","createReadStream","original","metadata","reason","size","owner_name","approve","$push","$each","$position","locked","instance_state","$exists","Busboy","Fiber","getQueryString","JsonRoutes","parseFiles","res","next","files","image","method","headers","fieldname","file","filename","encoding","mimetype","buffers","mimeType","body","run","pipe","add","fileCollection","extention","fileObj","newFileObjId","resp","toLowerCase","decodeURIComponent","version_id","setHeader","end","statusCode","collectionName","getUserIdFromAuthToken","params","resultData","sendResult","stack","errors","message","accessKeyId","secretAccessKey","ALY","canonicalizedQueryString","queryKeys","queryStr","stringToSign","util","Format","Version","AccessKeyId","SignatureMethod","Timestamp","iso8601","SignatureVersion","SignatureNonce","getTime","popEscape","toUpperCase","substr","Signature","crypto","hmac","queryParamsToString","oss","r","ref3","uploadAddress","uploadAuth","videoId","store","Action","Title","FileName","HTTP","call","VideoId","UploadAddress","toString","UploadAuth","OSS","AccessKeySecret","Endpoint","SecurityToken","putObject","Bucket","Key","Body","AccessControlAllowOrigin","ContentType","CacheControl","ContentDisposition","ContentEncoding","ServerSideEncryption","Expires","bindEnvironment","getPlayInfoQuery","getPlayInfoResult","getPlayInfoUrl","newDate","current_user_id","current_user_info","hashData","inserted_instances","new_ins","inserts","errorMessage"],"mappings":"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","file":"/packages/steedos_creator.js","sourcesContent":["import {\r\n\tcheckNpmVersions\r\n} from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\tbusboy: \"^0.2.13\",\r\n\tmkdirp: \"^0.3.5\",\r\n\t\"xml2js\": \"^0.4.19\",\r\n\t\"node-xlsx\": \"^0.12.0\"\r\n}, 'steedos:creator');\r\n\r\nif (Meteor.settings && Meteor.settings.cfs && Meteor.settings.cfs.aliyun) {\r\n\tcheckNpmVersions({\r\n\t\t\"aliyun-sdk\": \"^1.11.12\"\r\n\t}, 'steedos:creator');\r\n}","\r\n\t# Creator.initApps()\r\n\r\n\r\n# Creator.initApps = ()->\r\n# \tif Meteor.isServer\r\n# \t\t_.each Creator.Apps, (app, app_id)->\r\n# \t\t\tdb_app = db.apps.findOne(app_id)\r\n# \t\t\tif !db_app\r\n# \t\t\t\tapp._id = app_id\r\n# \t\t\t\tdb.apps.insert(app)\r\n# else\r\n# \tapp._id = app_id\r\n# \tdb.apps.update({_id: app_id}, app)\r\n\r\nCreator.getSchema = (object_name)->\r\n\treturn Creator.getObject(object_name)?.schema\r\n\r\nCreator.getObjectFirstListViewUrl = (object_name)->\r\n\tlist_view = Creator.getObjectFirstListView(object_name)\r\n\tlist_view_id = list_view?._id\r\n\tapp_id = Session.get(\"app_id\")\r\n\tif object_name is \"meeting\"\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\")\r\n\telse\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id)\r\n\r\nCreator.getObjectUrl = (object_name, record_id, app_id) ->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tlist_view = Creator.getListView(object_name, null)\r\n\tlist_view_id = list_view?._id\r\n\r\n\tif record_id\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id)\r\n\telse\r\n\t\tif object_name is \"meeting\"\r\n\t\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\")\r\n\t\telse\r\n\t\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id)\r\n\r\nCreator.getObjectRouterUrl = (object_name, record_id, app_id) ->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tlist_view = Creator.getListView(object_name, null)\r\n\tlist_view_id = list_view?._id\r\n\r\n\tif record_id\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id\r\n\telse\r\n\t\tif object_name is \"meeting\"\r\n\t\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\"\r\n\t\telse\r\n\t\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id\r\n\r\nCreator.getListViewUrl = (object_name, app_id, list_view_id) ->\r\n\turl = Creator.getListViewRelativeUrl(object_name, app_id, list_view_id)\r\n\treturn Creator.getRelativeUrl(url)\r\n\r\nCreator.getListViewRelativeUrl = (object_name, app_id, list_view_id) ->\r\n\tif list_view_id is \"calendar\"\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\"\r\n\telse\r\n\t\treturn \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id\r\n\r\nCreator.getSwitchListUrl = (object_name, app_id, list_view_id) ->\r\n\tif list_view_id\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + list_view_id + \"/list\")\r\n\telse\r\n\t\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/list/switch\")\r\n\r\nCreator.getRelatedObjectUrl = (object_name, app_id, record_id, related_object_name) ->\r\n\treturn Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + record_id + \"/\" + related_object_name + \"/grid\")\r\n\r\nCreator.getObjectLookupFieldOptions = (object_name, is_deep, is_skip_hide)->\r\n\t_options = []\r\n\tunless object_name\r\n\t\treturn _options\r\n\t_object = Creator.getObject(object_name)\r\n\tfields = _object?.fields\r\n\ticon = _object?.icon\r\n\t_.forEach fields, (f, k)->\r\n\t\tif is_skip_hide and f.hidden\r\n\t\t\treturn\r\n\t\tif f.type == \"select\"\r\n\t\t\t_options.push {label: \"#{f.label || k}\", value: \"#{k}\", icon: icon}\r\n\t\telse\r\n\t\t\t_options.push {label: f.label || k, value: k, icon: icon}\r\n\tif is_deep\r\n\t\t_.forEach fields, (f, k)->\r\n\t\t\tif is_skip_hide and f.hidden\r\n\t\t\t\treturn\r\n\t\t\tif (f.type == \"lookup\" || f.type == \"master_detail\") && f.reference_to\r\n\t\t\t\tr_object = Creator.getObject(f.reference_to)\r\n\t\t\t\tif r_object\r\n\t\t\t\t\t_.forEach r_object.fields, (f2, k2)->\r\n\t\t\t\t\t\t_options.push {label: \"#{f.label || k}=>#{f2.label || k2}\", value: \"#{k}.#{k2}\", icon: r_object?.icon}\r\n\treturn _options\r\n\r\n# 统一为对象object_name提供可用于过虑器过虑字段\r\nCreator.getObjectFilterFieldOptions = (object_name)->\r\n\t_options = []\r\n\tunless object_name\r\n\t\treturn _options\r\n\t_object = Creator.getObject(object_name)\r\n\tfields = _object?.fields\r\n\tpermission_fields = Creator.getFields(object_name)\r\n\ticon = _object?.icon\r\n\t_.forEach fields, (f, k)->\r\n\t\t# hidden,grid等类型的字段，不需要过滤\r\n\t\tif !_.include([\"grid\",\"object\", \"[Object]\", \"[object]\", \"Object\"], f.type) and !f.hidden\r\n\t\t\t# filters.$.field及flow.current等子字段也不需要过滤\r\n\t\t\tif !/\\w+\\./.test(k) and _.indexOf(permission_fields, k) > -1\r\n\t\t\t\t_options.push {label: f.label || k, value: k, icon: icon}\r\n\r\n\treturn _options\r\n\r\n###\r\nfilters: 要转换的filters\r\nfields: 对象字段\r\nfilter_fields: 默认过滤字段，支持字符串数组和对象数组两种格式，如:['filed_name1','filed_name2'],[{field:'filed_name1',required:true}]\r\n处理逻辑: 把filters中存在于filter_fields的过滤条件增加每项的is_default、is_required属性，不存在于filter_fields的过滤条件对应的移除每项的相关属性\r\n返回结果: 处理后的filters\r\n###\r\nCreator.getFiltersWithFilterFields = (filters, fields, filter_fields)->\r\n\tunless filters\r\n\t\tfilters = []\r\n\tunless filter_fields\r\n\t\tfilter_fields = []\r\n\tif filter_fields?.length\r\n\t\tfilter_fields.forEach (n)->\r\n\t\t\tif _.isString(n)\r\n\t\t\t\tn = \r\n\t\t\t\t\tfield: n,\r\n\t\t\t\t\trequired: false\r\n\t\t\tif fields[n.field] and !_.findWhere(filters,{field:n.field})\r\n\t\t\t\tfilters.push\r\n\t\t\t\t\tfield: n.field,\r\n\t\t\t\t\tis_default: true,\r\n\t\t\t\t\tis_required: n.required\r\n\tfilters.forEach (filterItem)->\r\n\t\tmatchField = filter_fields.find (n)-> return n == filterItem.field or n.field == filterItem.field\r\n\t\tif _.isString(matchField)\r\n\t\t\tmatchField = \r\n\t\t\t\tfield: matchField,\r\n\t\t\t\trequired: false\r\n\t\tif matchField\r\n\t\t\tfilterItem.is_default = true\r\n\t\t\tfilterItem.is_required = matchField.required\r\n\t\telse\r\n\t\t\tdelete filterItem.is_default\r\n\t\t\tdelete filterItem.is_required\r\n\treturn filters\r\n\r\nCreator.getObjectRecord = (object_name, record_id, select_fields, expand)->\r\n\r\n\tif !object_name\r\n\t\tobject_name = Session.get(\"object_name\")\r\n\r\n\tif !record_id\r\n\t\trecord_id = Session.get(\"record_id\")\r\n\tif Meteor.isClient\r\n\t\tif object_name == Session.get(\"object_name\") &&  record_id == Session.get(\"record_id\")\r\n\t\t\tif Template.instance()?.record\r\n\t\t\t\treturn Template.instance()?.record?.get()\r\n\t\telse\r\n\t\t\treturn Creator.odata.get(object_name, record_id, select_fields, expand)\r\n\r\n\tcollection = Creator.getCollection(object_name)\r\n\tif collection\r\n\t\trecord = collection.findOne(record_id)\r\n\t\treturn record\r\n\r\nCreator.getApp = (app_id)->\r\n\tif !app_id\r\n\t\tapp_id = Session.get(\"app_id\")\r\n\tapp = Creator.Apps[app_id]\r\n\tCreator.deps?.app?.depend()\r\n\treturn app\r\n\r\n\r\nCreator.getAppObjectNames = (app_id)->\r\n\tapp = Creator.getApp(app_id)\r\n\r\n\tobjects = []\r\n\tif app\r\n\t\t_.each app.objects, (v)->\r\n\t\t\tobj = Creator.getObject(v)\r\n\t\t\tif obj?.permissions.get().allowRead and !obj.hidden\r\n\t\t\t\tobjects.push v\r\n\treturn objects\r\n\r\nCreator.getVisibleApps = (includeAdmin)->\r\n\tapps = []\r\n\t_.each Creator.Apps, (v, k)->\r\n\t\tif (v.visible != false and v._id != \"admin\") or (includeAdmin and v._id == \"admin\")\r\n\t\t\tapps.push v\r\n\treturn apps;\r\n\r\nCreator.getVisibleAppsObjects = ()->\r\n\tapps = Creator.getVisibleApps()\r\n\tvisibleObjectNames = _.flatten(_.pluck(apps,'objects'))\r\n\tobjects = _.filter Creator.Objects, (obj)->\r\n\t\tif visibleObjectNames.indexOf(obj.name) < 0\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn !obj.hidden\r\n\tobjects = objects.sort(Creator.sortingMethod.bind({key:\"label\"}))\r\n\tobjects = _.pluck(objects,'name')\r\n\treturn _.uniq objects\r\n\r\nCreator.getAppsObjects = ()->\r\n\tobjects = []\r\n\ttempObjects = []\r\n\t_.forEach Creator.Apps, (app)->\r\n\t\ttempObjects = _.filter app.objects, (obj)->\r\n\t\t\treturn !obj.hidden\r\n\t\tobjects = objects.concat(tempObjects)\r\n\treturn _.uniq objects\r\n\r\nCreator.validateFilters = (filters, logic)->\r\n\tfilter_items = _.map filters, (obj) ->\r\n\t\tif _.isEmpty(obj)\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn obj\r\n\tfilter_items = _.compact(filter_items)\r\n\terrorMsg = \"\"\r\n\tfilter_length = filter_items.length\r\n\tif logic\r\n\t\t# 格式化filter\r\n\t\tlogic = logic.replace(/\\n/g, \"\").replace(/\\s+/g, \" \")\r\n\r\n\t\t# 判断特殊字符\r\n\t\tif /[._\\-!+]+/ig.test(logic)\r\n\t\t\terrorMsg = \"含有特殊字符。\"\r\n\r\n\t\tif !errorMsg\r\n\t\t\tindex = logic.match(/\\d+/ig)\r\n\t\t\tif !index\r\n\t\t\t\terrorMsg = \"有些筛选条件进行了定义，但未在高级筛选条件中被引用。\"\r\n\t\t\telse\r\n\t\t\t\tindex.forEach (i)->\r\n\t\t\t\t\tif i < 1 or i > filter_length\r\n\t\t\t\t\t\terrorMsg = \"您的筛选条件引用了未定义的筛选器：#{i}。\"\r\n\r\n\t\t\t\tflag = 1\r\n\t\t\t\twhile flag <= filter_length\r\n\t\t\t\t\tif !index.includes(\"#{flag}\")\r\n\t\t\t\t\t\terrorMsg = \"有些筛选条件进行了定义，但未在高级筛选条件中被引用。\"\r\n\t\t\t\t\tflag++;\r\n\r\n\t\tif !errorMsg\r\n\t\t\t# 判断是否有非法英文字符\r\n\t\t\tword = logic.match(/[a-zA-Z]+/ig)\r\n\t\t\tif word\r\n\t\t\t\tword.forEach (w)->\r\n\t\t\t\t\tif !/^(and|or)$/ig.test(w)\r\n\t\t\t\t\t\terrorMsg = \"检查您的高级筛选条件中的拼写。\"\r\n\r\n\t\tif !errorMsg\r\n\t\t\t# 判断格式是否正确\r\n\t\t\ttry\r\n\t\t\t\tCreator.eval(logic.replace(/and/ig, \"&&\").replace(/or/ig, \"||\"))\r\n\t\t\tcatch e\r\n\t\t\t\terrorMsg = \"您的筛选器中含有特殊字符\"\r\n\r\n\t\t\tif /(AND)[^()]+(OR)/ig.test(logic) ||  /(OR)[^()]+(AND)/ig.test(logic)\r\n\t\t\t\terrorMsg = \"您的筛选器必须在连续性的 AND 和 OR 表达式前后使用括号。\"\r\n\tif errorMsg\r\n\t\tconsole.log \"error\", errorMsg\r\n\t\tif Meteor.isClient\r\n\t\t\ttoastr.error(errorMsg)\r\n\t\treturn false\r\n\telse\r\n\t\treturn true\r\n\r\n# \"=\", \"<>\", \">\", \">=\", \"<\", \"<=\", \"startswith\", \"contains\", \"notcontains\".\r\n###\r\noptions参数：\r\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\r\n\tuserId-- 当前登录用户\r\n\tspaceId-- 当前所在工作区\r\nextend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\r\n###\r\nCreator.formatFiltersToMongo = (filters, options)->\r\n\tunless filters?.length\r\n\t\treturn\r\n\t# 当filters不是[Array]类型而是[Object]类型时，进行格式转换\r\n\tunless filters[0] instanceof Array\r\n\t\tfilters = _.map filters, (obj)->\r\n\t\t\treturn [obj.field, obj.operation, obj.value]\r\n\tselector = []\r\n\t_.each filters, (filter)->\r\n\t\tfield = filter[0]\r\n\t\toption = filter[1]\r\n\t\tif Meteor.isClient\r\n\t\t\tvalue = Creator.evaluateFormula(filter[2])\r\n\t\telse\r\n\t\t\tvalue = Creator.evaluateFormula(filter[2], null, options)\r\n\t\tsub_selector = {}\r\n\t\tsub_selector[field] = {}\r\n\t\tif option == \"=\"\r\n\t\t\tsub_selector[field][\"$eq\"] = value\r\n\t\telse if option == \"<>\"\r\n\t\t\tsub_selector[field][\"$ne\"] = value\r\n\t\telse if option == \">\"\r\n\t\t\tsub_selector[field][\"$gt\"] = value\r\n\t\telse if option == \">=\"\r\n\t\t\tsub_selector[field][\"$gte\"] = value\r\n\t\telse if option == \"<\"\r\n\t\t\tsub_selector[field][\"$lt\"] = value\r\n\t\telse if option == \"<=\"\r\n\t\t\tsub_selector[field][\"$lte\"] = value\r\n\t\telse if option == \"startswith\"\r\n\t\t\treg = new RegExp(\"^\" + value, \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\telse if option == \"contains\"\r\n\t\t\treg = new RegExp(value, \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\telse if option == \"notcontains\"\r\n\t\t\treg = new RegExp(\"^((?!\" + value + \").)*$\", \"i\")\r\n\t\t\tsub_selector[field][\"$regex\"] = reg\r\n\t\tselector.push sub_selector\r\n\treturn selector\r\n\r\nCreator.isBetweenFilterOperation = (operation)->\r\n\treturn operation == \"between\" or !!Creator.getBetweenTimeBuiltinValues(true)?[operation]\r\n\r\n###\r\noptions参数：\r\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\r\n\tuserId-- 当前登录用户\r\n\tspaceId-- 当前所在工作区\r\n\textend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\r\n###\r\nCreator.formatFiltersToDev = (filters, object_name, options)->\r\n\tsteedosFilters = require(\"@steedos/filters\");\r\n\tunless filters.length\r\n\t\treturn\r\n\tif options?.is_logic_or\r\n\t\t# 如果is_logic_or为true，为filters第一层元素增加or间隔\r\n\t\tlogicTempFilters = []\r\n\t\tfilters.forEach (n)->\r\n\t\t\tlogicTempFilters.push(n)\r\n\t\t\tlogicTempFilters.push(\"or\")\r\n\t\tlogicTempFilters.pop()\r\n\t\tfilters = logicTempFilters\r\n\tselector = steedosFilters.formatFiltersToDev(filters, Creator.USER_CONTEXT)\r\n\treturn selector\r\n\r\n###\r\noptions参数：\r\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\r\n\tuserId-- 当前登录用户\r\n\tspaceId-- 当前所在工作区\r\nextend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\r\n###\r\nCreator.formatLogicFiltersToDev = (filters, filter_logic, options)->\r\n\tformat_logic = filter_logic.replace(/\\(\\s+/ig, \"(\").replace(/\\s+\\)/ig, \")\").replace(/\\(/g, \"[\").replace(/\\)/g, \"]\").replace(/\\s+/g, \",\").replace(/(and|or)/ig, \"'$1'\")\r\n\tformat_logic = format_logic.replace(/(\\d)+/ig, (x)->\r\n\t\t_f = filters[x-1]\r\n\t\tfield = _f.field\r\n\t\toption = _f.operation\r\n\t\tif Meteor.isClient\r\n\t\t\tvalue = Creator.evaluateFormula(_f.value)\r\n\t\telse\r\n\t\t\tvalue = Creator.evaluateFormula(_f.value, null, options)\r\n\t\tsub_selector = []\r\n\t\tif _.isArray(value) == true\r\n\t\t\tif option == \"=\"\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"or\"\r\n\t\t\telse if option == \"<>\"\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"and\"\r\n\t\t\telse\r\n\t\t\t\t_.each value, (v)->\r\n\t\t\t\t\tsub_selector.push [field, option, v], \"or\"\r\n\t\t\tif sub_selector[sub_selector.length - 1] == \"and\" || sub_selector[sub_selector.length - 1] == \"or\"\r\n\t\t\t\tsub_selector.pop()\r\n\t\telse\r\n\t\t\tsub_selector = [field, option, value]\r\n\t\tconsole.log \"sub_selector\", sub_selector\r\n\t\treturn JSON.stringify(sub_selector)\r\n\t)\r\n\tformat_logic = \"[#{format_logic}]\"\r\n\treturn Creator.eval(format_logic)\r\n\r\nCreator.getRelatedObjects = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\trelated_object_names = []\r\n\t_object = Creator.getObject(object_name)\r\n\r\n\tif !_object\r\n\t\treturn related_object_names\r\n\r\n#\trelated_object_names = _.pluck(_object.related_objects,\"object_name\")\r\n\r\n\trelated_objects = Creator.getObjectRelateds(_object._collection_name)\r\n\r\n\trelated_object_names = _.pluck(related_objects,\"object_name\")\r\n\tif related_object_names?.length == 0\r\n\t\treturn related_object_names\r\n\r\n\tpermissions = Creator.getPermissions(object_name, spaceId, userId)\r\n\tunrelated_objects = permissions.unrelated_objects\r\n\r\n\trelated_object_names = _.difference related_object_names, unrelated_objects\r\n\treturn _.filter related_objects, (related_object)->\r\n\t\trelated_object_name = related_object.object_name\r\n\t\tisActive = related_object_names.indexOf(related_object_name) > -1\r\n\t\tallowRead = Creator.getPermissions(related_object_name, spaceId, userId)?.allowRead\r\n\t\treturn isActive and allowRead\r\n\r\nCreator.getRelatedObjectNames = (object_name, spaceId, userId)->\r\n\trelated_objects = Creator.getRelatedObjects(object_name, spaceId, userId)\r\n\treturn _.pluck(related_objects,\"object_name\")\r\n\r\nCreator.getActions = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\tobj = Creator.getObject(object_name)\r\n\r\n\tif !obj\r\n\t\treturn\r\n\r\n\tpermissions = Creator.getPermissions(object_name, spaceId, userId)\r\n\tdisabled_actions = permissions.disabled_actions\r\n\tactions = _.sortBy(_.values(obj.actions) , 'sort');\r\n\r\n\t_.each actions, (action)->\r\n\t\tif Steedos.isMobile() && action.on == \"record\" && action.name != 'standard_edit'\r\n\t\t\taction.on = 'record_more'\r\n\r\n\tactions = _.filter actions, (action)->\r\n\t\treturn _.indexOf(disabled_actions, action.name) < 0\r\n\r\n\treturn actions\r\n\r\n///\r\n\t返回当前用户有权限访问的所有list_view，包括分享的，用户自定义非分享的（除非owner变了），以及默认的其他视图\r\n\t注意Creator.getPermissions函数中是不会有用户自定义非分享的视图的，所以Creator.getPermissions函数中拿到的结果不全，并不是当前用户能看到所有视图\r\n///\r\nCreator.getListViews = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\tobject = Creator.getObject(object_name)\r\n\r\n\tif !object\r\n\t\treturn\r\n\r\n\tdisabled_list_views = Creator.getPermissions(object_name, spaceId, userId).disabled_list_views || []\r\n\r\n\tlist_views = []\r\n\r\n\tisMobile = Steedos.isMobile()\r\n\r\n\t_.each object.list_views, (item, item_name)->\r\n\t\tif isMobile and item.type == \"calendar\"\r\n\t\t\t# 手机上先不显示日历视图\r\n\t\t\treturn\r\n\t\tif item_name != \"default\"\r\n\t\t\tif _.indexOf(disabled_list_views, item_name) < 0 || item.owner == userId\r\n\t\t\t\tlist_views.push item\r\n\r\n\treturn list_views\r\n\r\n# 前台理论上不应该调用该函数，因为字段的权限都在Creator.getObject(object_name).fields的相关属性中有标识了\r\nCreator.getFields = (object_name, spaceId, userId)->\r\n\tif Meteor.isClient\r\n\t\tif !object_name\r\n\t\t\tobject_name = Session.get(\"object_name\")\r\n\t\tif !spaceId\r\n\t\t\tspaceId = Session.get(\"spaceId\")\r\n\t\tif !userId\r\n\t\t\tuserId = Meteor.userId()\r\n\r\n\tfieldsName = Creator.getObjectFieldsName(object_name)\r\n\tunreadable_fields =  Creator.getPermissions(object_name, spaceId, userId).unreadable_fields\r\n\treturn _.difference(fieldsName, unreadable_fields)\r\n\r\nCreator.isloading = ()->\r\n\treturn !Creator.bootstrapLoaded.get()\r\n\r\nCreator.convertSpecialCharacter = (str)->\r\n\treturn str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\")\r\n\r\n# 计算fields相关函数\r\n# START\r\nCreator.getDisabledFields = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn field.autoform and field.autoform.disabled and !field.autoform.omit and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getHiddenFields = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn field.autoform and field.autoform.type == \"hidden\" and !field.autoform.omit and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getFieldsWithNoGroup = (schema)->\r\n\tfields = _.map(schema, (field, fieldName) ->\r\n\t\treturn (!field.autoform or !field.autoform.group or field.autoform.group == \"-\") and (!field.autoform or field.autoform.type != \"hidden\") and fieldName\r\n\t)\r\n\tfields = _.compact(fields)\r\n\treturn fields\r\n\r\nCreator.getSortedFieldGroupNames = (schema)->\r\n\tnames = _.map(schema, (field) ->\r\n \t\treturn field.autoform and field.autoform.group != \"-\" and field.autoform.group\r\n\t)\r\n\tnames = _.compact(names)\r\n\tnames = _.unique(names)\r\n\treturn names\r\n\r\nCreator.getFieldsForGroup = (schema, groupName) ->\r\n  \tfields = _.map(schema, (field, fieldName) ->\r\n    \treturn field.autoform and field.autoform.group == groupName and field.autoform.type != \"hidden\" and fieldName\r\n  \t)\r\n  \tfields = _.compact(fields)\r\n  \treturn fields\r\n\r\nCreator.getFieldsWithoutOmit = (schema, keys) ->\r\n\tkeys = _.map(keys, (key) ->\r\n\t\tfield = _.pick(schema, key)\r\n\t\tif field[key].autoform?.omit\r\n\t\t\treturn false\r\n\t\telse\r\n\t\t\treturn key\r\n\t)\r\n\tkeys = _.compact(keys)\r\n\treturn keys\r\n\r\nCreator.getFieldsInFirstLevel = (firstLevelKeys, keys) ->\r\n\tkeys = _.map(keys, (key) ->\r\n\t\tif _.indexOf(firstLevelKeys, key) > -1\r\n\t\t\treturn key\r\n\t\telse\r\n\t\t\treturn false\r\n\t)\r\n\tkeys = _.compact(keys)\r\n\treturn keys\r\n\r\nCreator.getFieldsForReorder = (schema, keys, isSingle) ->\r\n\tfields = []\r\n\ti = 0\r\n\twhile i < keys.length\r\n\t\tsc_1 = _.pick(schema, keys[i])\r\n\t\tsc_2 = _.pick(schema, keys[i+1])\r\n\r\n\t\tis_wide_1 = false\r\n\t\tis_wide_2 = false\r\n\r\n\t\tis_range_1 = false\r\n\t\tis_range_2 = false\r\n\r\n\t\t_.each sc_1, (value) ->\r\n\t\t\tif value.autoform?.is_wide || value.autoform?.type == \"table\"\r\n\t\t\t\tis_wide_1 = true\r\n\r\n\t\t\tif value.autoform?.is_range\r\n\t\t\t\tis_range_1 = true\r\n\r\n\t\t_.each sc_2, (value) ->\r\n\t\t\tif value.autoform?.is_wide || value.autoform?.type == \"table\"\r\n\t\t\t\tis_wide_2 = true\r\n\r\n\t\t\tif value.autoform?.is_range\r\n\t\t\t\tis_range_2 = true\r\n\r\n\t\tif isSingle\r\n\t\t\tfields.push keys.slice(i, i+1)\r\n\t\t\ti += 1\r\n\t\telse\r\n\t\t\tif !is_range_1 && is_range_2\r\n\t\t\t\tchildKeys = keys.slice(i, i+1)\r\n\t\t\t\tchildKeys.push undefined\r\n\t\t\t\tfields.push childKeys\r\n\t\t\t\ti += 1\r\n\t\t\telse if is_wide_1\r\n\t\t\t\tfields.push keys.slice(i, i+1)\r\n\t\t\t\ti += 1\r\n\t\t\telse if !is_wide_1 and is_wide_2\r\n\t\t\t\tchildKeys = keys.slice(i, i+1)\r\n\t\t\t\tchildKeys.push undefined\r\n\t\t\t\tfields.push childKeys\r\n\t\t\t\ti += 1\r\n\t\t\telse if !is_wide_1 and !is_wide_2\r\n\t\t\t\tchildKeys = keys.slice(i, i+1)\r\n\t\t\t\tif keys[i+1]\r\n\t\t\t\t\tchildKeys.push keys[i+1]\r\n\t\t\t\telse\r\n\t\t\t\t\tchildKeys.push undefined\r\n\t\t\t\tfields.push childKeys\r\n\t\t\t\ti += 2\r\n\r\n\treturn fields\r\n\r\n# END\r\n\r\nif Meteor.isServer\r\n\tCreator.getAllRelatedObjects = (object_name)->\r\n\t\trelated_object_names = []\r\n\t\t_.each Creator.Objects, (related_object, related_object_name)->\r\n\t\t\t_.each related_object.fields, (related_field, related_field_name)->\r\n\t\t\t\tif related_field.type == \"master_detail\" and related_field.reference_to and related_field.reference_to == object_name\r\n\t\t\t\t\trelated_object_names.push related_object_name\r\n\r\n\t\tif Creator.getObject(object_name).enable_files\r\n\t\t\trelated_object_names.push \"cms_files\"\r\n\r\n\t\treturn related_object_names","Creator.getSchema = function(object_name) {\n  var ref;\n  return (ref = Creator.getObject(object_name)) != null ? ref.schema : void 0;\n};\n\nCreator.getObjectFirstListViewUrl = function(object_name) {\n  var app_id, list_view, list_view_id;\n  list_view = Creator.getObjectFirstListView(object_name);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  app_id = Session.get(\"app_id\");\n  if (object_name === \"meeting\") {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\");\n  } else {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id);\n  }\n};\n\nCreator.getObjectUrl = function(object_name, record_id, app_id) {\n  var list_view, list_view_id;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  list_view = Creator.getListView(object_name, null);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  if (record_id) {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id);\n  } else {\n    if (object_name === \"meeting\") {\n      return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/calendar/\");\n    } else {\n      return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id);\n    }\n  }\n};\n\nCreator.getObjectRouterUrl = function(object_name, record_id, app_id) {\n  var list_view, list_view_id;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  list_view = Creator.getListView(object_name, null);\n  list_view_id = list_view != null ? list_view._id : void 0;\n  if (record_id) {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/view/\" + record_id;\n  } else {\n    if (object_name === \"meeting\") {\n      return \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\";\n    } else {\n      return \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id;\n    }\n  }\n};\n\nCreator.getListViewUrl = function(object_name, app_id, list_view_id) {\n  var url;\n  url = Creator.getListViewRelativeUrl(object_name, app_id, list_view_id);\n  return Creator.getRelativeUrl(url);\n};\n\nCreator.getListViewRelativeUrl = function(object_name, app_id, list_view_id) {\n  if (list_view_id === \"calendar\") {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/calendar/\";\n  } else {\n    return \"/app/\" + app_id + \"/\" + object_name + \"/grid/\" + list_view_id;\n  }\n};\n\nCreator.getSwitchListUrl = function(object_name, app_id, list_view_id) {\n  if (list_view_id) {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + list_view_id + \"/list\");\n  } else {\n    return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/list/switch\");\n  }\n};\n\nCreator.getRelatedObjectUrl = function(object_name, app_id, record_id, related_object_name) {\n  return Creator.getRelativeUrl(\"/app/\" + app_id + \"/\" + object_name + \"/\" + record_id + \"/\" + related_object_name + \"/grid\");\n};\n\nCreator.getObjectLookupFieldOptions = function(object_name, is_deep, is_skip_hide) {\n  var _object, _options, fields, icon;\n  _options = [];\n  if (!object_name) {\n    return _options;\n  }\n  _object = Creator.getObject(object_name);\n  fields = _object != null ? _object.fields : void 0;\n  icon = _object != null ? _object.icon : void 0;\n  _.forEach(fields, function(f, k) {\n    if (is_skip_hide && f.hidden) {\n      return;\n    }\n    if (f.type === \"select\") {\n      return _options.push({\n        label: \"\" + (f.label || k),\n        value: \"\" + k,\n        icon: icon\n      });\n    } else {\n      return _options.push({\n        label: f.label || k,\n        value: k,\n        icon: icon\n      });\n    }\n  });\n  if (is_deep) {\n    _.forEach(fields, function(f, k) {\n      var r_object;\n      if (is_skip_hide && f.hidden) {\n        return;\n      }\n      if ((f.type === \"lookup\" || f.type === \"master_detail\") && f.reference_to) {\n        r_object = Creator.getObject(f.reference_to);\n        if (r_object) {\n          return _.forEach(r_object.fields, function(f2, k2) {\n            return _options.push({\n              label: (f.label || k) + \"=>\" + (f2.label || k2),\n              value: k + \".\" + k2,\n              icon: r_object != null ? r_object.icon : void 0\n            });\n          });\n        }\n      }\n    });\n  }\n  return _options;\n};\n\nCreator.getObjectFilterFieldOptions = function(object_name) {\n  var _object, _options, fields, icon, permission_fields;\n  _options = [];\n  if (!object_name) {\n    return _options;\n  }\n  _object = Creator.getObject(object_name);\n  fields = _object != null ? _object.fields : void 0;\n  permission_fields = Creator.getFields(object_name);\n  icon = _object != null ? _object.icon : void 0;\n  _.forEach(fields, function(f, k) {\n    if (!_.include([\"grid\", \"object\", \"[Object]\", \"[object]\", \"Object\"], f.type) && !f.hidden) {\n      if (!/\\w+\\./.test(k) && _.indexOf(permission_fields, k) > -1) {\n        return _options.push({\n          label: f.label || k,\n          value: k,\n          icon: icon\n        });\n      }\n    }\n  });\n  return _options;\n};\n\n\n/*\nfilters: 要转换的filters\nfields: 对象字段\nfilter_fields: 默认过滤字段，支持字符串数组和对象数组两种格式，如:['filed_name1','filed_name2'],[{field:'filed_name1',required:true}]\n处理逻辑: 把filters中存在于filter_fields的过滤条件增加每项的is_default、is_required属性，不存在于filter_fields的过滤条件对应的移除每项的相关属性\n返回结果: 处理后的filters\n */\n\nCreator.getFiltersWithFilterFields = function(filters, fields, filter_fields) {\n  if (!filters) {\n    filters = [];\n  }\n  if (!filter_fields) {\n    filter_fields = [];\n  }\n  if (filter_fields != null ? filter_fields.length : void 0) {\n    filter_fields.forEach(function(n) {\n      if (_.isString(n)) {\n        n = {\n          field: n,\n          required: false\n        };\n      }\n      if (fields[n.field] && !_.findWhere(filters, {\n        field: n.field\n      })) {\n        return filters.push({\n          field: n.field,\n          is_default: true,\n          is_required: n.required\n        });\n      }\n    });\n  }\n  filters.forEach(function(filterItem) {\n    var matchField;\n    matchField = filter_fields.find(function(n) {\n      return n === filterItem.field || n.field === filterItem.field;\n    });\n    if (_.isString(matchField)) {\n      matchField = {\n        field: matchField,\n        required: false\n      };\n    }\n    if (matchField) {\n      filterItem.is_default = true;\n      return filterItem.is_required = matchField.required;\n    } else {\n      delete filterItem.is_default;\n      return delete filterItem.is_required;\n    }\n  });\n  return filters;\n};\n\nCreator.getObjectRecord = function(object_name, record_id, select_fields, expand) {\n  var collection, record, ref, ref1, ref2;\n  if (!object_name) {\n    object_name = Session.get(\"object_name\");\n  }\n  if (!record_id) {\n    record_id = Session.get(\"record_id\");\n  }\n  if (Meteor.isClient) {\n    if (object_name === Session.get(\"object_name\") && record_id === Session.get(\"record_id\")) {\n      if ((ref = Template.instance()) != null ? ref.record : void 0) {\n        return (ref1 = Template.instance()) != null ? (ref2 = ref1.record) != null ? ref2.get() : void 0 : void 0;\n      }\n    } else {\n      return Creator.odata.get(object_name, record_id, select_fields, expand);\n    }\n  }\n  collection = Creator.getCollection(object_name);\n  if (collection) {\n    record = collection.findOne(record_id);\n    return record;\n  }\n};\n\nCreator.getApp = function(app_id) {\n  var app, ref, ref1;\n  if (!app_id) {\n    app_id = Session.get(\"app_id\");\n  }\n  app = Creator.Apps[app_id];\n  if ((ref = Creator.deps) != null) {\n    if ((ref1 = ref.app) != null) {\n      ref1.depend();\n    }\n  }\n  return app;\n};\n\nCreator.getAppObjectNames = function(app_id) {\n  var app, objects;\n  app = Creator.getApp(app_id);\n  objects = [];\n  if (app) {\n    _.each(app.objects, function(v) {\n      var obj;\n      obj = Creator.getObject(v);\n      if ((obj != null ? obj.permissions.get().allowRead : void 0) && !obj.hidden) {\n        return objects.push(v);\n      }\n    });\n  }\n  return objects;\n};\n\nCreator.getVisibleApps = function(includeAdmin) {\n  var apps;\n  apps = [];\n  _.each(Creator.Apps, function(v, k) {\n    if ((v.visible !== false && v._id !== \"admin\") || (includeAdmin && v._id === \"admin\")) {\n      return apps.push(v);\n    }\n  });\n  return apps;\n};\n\nCreator.getVisibleAppsObjects = function() {\n  var apps, objects, visibleObjectNames;\n  apps = Creator.getVisibleApps();\n  visibleObjectNames = _.flatten(_.pluck(apps, 'objects'));\n  objects = _.filter(Creator.Objects, function(obj) {\n    if (visibleObjectNames.indexOf(obj.name) < 0) {\n      return false;\n    } else {\n      return !obj.hidden;\n    }\n  });\n  objects = objects.sort(Creator.sortingMethod.bind({\n    key: \"label\"\n  }));\n  objects = _.pluck(objects, 'name');\n  return _.uniq(objects);\n};\n\nCreator.getAppsObjects = function() {\n  var objects, tempObjects;\n  objects = [];\n  tempObjects = [];\n  _.forEach(Creator.Apps, function(app) {\n    tempObjects = _.filter(app.objects, function(obj) {\n      return !obj.hidden;\n    });\n    return objects = objects.concat(tempObjects);\n  });\n  return _.uniq(objects);\n};\n\nCreator.validateFilters = function(filters, logic) {\n  var e, errorMsg, filter_items, filter_length, flag, index, word;\n  filter_items = _.map(filters, function(obj) {\n    if (_.isEmpty(obj)) {\n      return false;\n    } else {\n      return obj;\n    }\n  });\n  filter_items = _.compact(filter_items);\n  errorMsg = \"\";\n  filter_length = filter_items.length;\n  if (logic) {\n    logic = logic.replace(/\\n/g, \"\").replace(/\\s+/g, \" \");\n    if (/[._\\-!+]+/ig.test(logic)) {\n      errorMsg = \"含有特殊字符。\";\n    }\n    if (!errorMsg) {\n      index = logic.match(/\\d+/ig);\n      if (!index) {\n        errorMsg = \"有些筛选条件进行了定义，但未在高级筛选条件中被引用。\";\n      } else {\n        index.forEach(function(i) {\n          if (i < 1 || i > filter_length) {\n            return errorMsg = \"您的筛选条件引用了未定义的筛选器：\" + i + \"。\";\n          }\n        });\n        flag = 1;\n        while (flag <= filter_length) {\n          if (!index.includes(\"\" + flag)) {\n            errorMsg = \"有些筛选条件进行了定义，但未在高级筛选条件中被引用。\";\n          }\n          flag++;\n        }\n      }\n    }\n    if (!errorMsg) {\n      word = logic.match(/[a-zA-Z]+/ig);\n      if (word) {\n        word.forEach(function(w) {\n          if (!/^(and|or)$/ig.test(w)) {\n            return errorMsg = \"检查您的高级筛选条件中的拼写。\";\n          }\n        });\n      }\n    }\n    if (!errorMsg) {\n      try {\n        Creator[\"eval\"](logic.replace(/and/ig, \"&&\").replace(/or/ig, \"||\"));\n      } catch (error) {\n        e = error;\n        errorMsg = \"您的筛选器中含有特殊字符\";\n      }\n      if (/(AND)[^()]+(OR)/ig.test(logic) || /(OR)[^()]+(AND)/ig.test(logic)) {\n        errorMsg = \"您的筛选器必须在连续性的 AND 和 OR 表达式前后使用括号。\";\n      }\n    }\n  }\n  if (errorMsg) {\n    console.log(\"error\", errorMsg);\n    if (Meteor.isClient) {\n      toastr.error(errorMsg);\n    }\n    return false;\n  } else {\n    return true;\n  }\n};\n\n\n/*\noptions参数：\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\n\tuserId-- 当前登录用户\n\tspaceId-- 当前所在工作区\nextend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\n */\n\nCreator.formatFiltersToMongo = function(filters, options) {\n  var selector;\n  if (!(filters != null ? filters.length : void 0)) {\n    return;\n  }\n  if (!(filters[0] instanceof Array)) {\n    filters = _.map(filters, function(obj) {\n      return [obj.field, obj.operation, obj.value];\n    });\n  }\n  selector = [];\n  _.each(filters, function(filter) {\n    var field, option, reg, sub_selector, value;\n    field = filter[0];\n    option = filter[1];\n    if (Meteor.isClient) {\n      value = Creator.evaluateFormula(filter[2]);\n    } else {\n      value = Creator.evaluateFormula(filter[2], null, options);\n    }\n    sub_selector = {};\n    sub_selector[field] = {};\n    if (option === \"=\") {\n      sub_selector[field][\"$eq\"] = value;\n    } else if (option === \"<>\") {\n      sub_selector[field][\"$ne\"] = value;\n    } else if (option === \">\") {\n      sub_selector[field][\"$gt\"] = value;\n    } else if (option === \">=\") {\n      sub_selector[field][\"$gte\"] = value;\n    } else if (option === \"<\") {\n      sub_selector[field][\"$lt\"] = value;\n    } else if (option === \"<=\") {\n      sub_selector[field][\"$lte\"] = value;\n    } else if (option === \"startswith\") {\n      reg = new RegExp(\"^\" + value, \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    } else if (option === \"contains\") {\n      reg = new RegExp(value, \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    } else if (option === \"notcontains\") {\n      reg = new RegExp(\"^((?!\" + value + \").)*$\", \"i\");\n      sub_selector[field][\"$regex\"] = reg;\n    }\n    return selector.push(sub_selector);\n  });\n  return selector;\n};\n\nCreator.isBetweenFilterOperation = function(operation) {\n  var ref;\n  return operation === \"between\" || !!((ref = Creator.getBetweenTimeBuiltinValues(true)) != null ? ref[operation] : void 0);\n};\n\n\n/*\noptions参数：\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\n\tuserId-- 当前登录用户\n\tspaceId-- 当前所在工作区\n\textend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\n */\n\nCreator.formatFiltersToDev = function(filters, object_name, options) {\n  var logicTempFilters, selector, steedosFilters;\n  steedosFilters = require(\"@steedos/filters\");\n  if (!filters.length) {\n    return;\n  }\n  if (options != null ? options.is_logic_or : void 0) {\n    logicTempFilters = [];\n    filters.forEach(function(n) {\n      logicTempFilters.push(n);\n      return logicTempFilters.push(\"or\");\n    });\n    logicTempFilters.pop();\n    filters = logicTempFilters;\n  }\n  selector = steedosFilters.formatFiltersToDev(filters, Creator.USER_CONTEXT);\n  return selector;\n};\n\n\n/*\noptions参数：\n\textend-- 是否需要把当前用户基本信息加入公式，即让公式支持Creator.USER_CONTEXT中的值，默认为true\n\tuserId-- 当前登录用户\n\tspaceId-- 当前所在工作区\nextend为true时，后端需要额外传入userId及spaceId用于抓取Creator.USER_CONTEXT对应的值\n */\n\nCreator.formatLogicFiltersToDev = function(filters, filter_logic, options) {\n  var format_logic;\n  format_logic = filter_logic.replace(/\\(\\s+/ig, \"(\").replace(/\\s+\\)/ig, \")\").replace(/\\(/g, \"[\").replace(/\\)/g, \"]\").replace(/\\s+/g, \",\").replace(/(and|or)/ig, \"'$1'\");\n  format_logic = format_logic.replace(/(\\d)+/ig, function(x) {\n    var _f, field, option, sub_selector, value;\n    _f = filters[x - 1];\n    field = _f.field;\n    option = _f.operation;\n    if (Meteor.isClient) {\n      value = Creator.evaluateFormula(_f.value);\n    } else {\n      value = Creator.evaluateFormula(_f.value, null, options);\n    }\n    sub_selector = [];\n    if (_.isArray(value) === true) {\n      if (option === \"=\") {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"or\");\n        });\n      } else if (option === \"<>\") {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"and\");\n        });\n      } else {\n        _.each(value, function(v) {\n          return sub_selector.push([field, option, v], \"or\");\n        });\n      }\n      if (sub_selector[sub_selector.length - 1] === \"and\" || sub_selector[sub_selector.length - 1] === \"or\") {\n        sub_selector.pop();\n      }\n    } else {\n      sub_selector = [field, option, value];\n    }\n    console.log(\"sub_selector\", sub_selector);\n    return JSON.stringify(sub_selector);\n  });\n  format_logic = \"[\" + format_logic + \"]\";\n  return Creator[\"eval\"](format_logic);\n};\n\nCreator.getRelatedObjects = function(object_name, spaceId, userId) {\n  var _object, permissions, related_object_names, related_objects, unrelated_objects;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  related_object_names = [];\n  _object = Creator.getObject(object_name);\n  if (!_object) {\n    return related_object_names;\n  }\n  related_objects = Creator.getObjectRelateds(_object._collection_name);\n  related_object_names = _.pluck(related_objects, \"object_name\");\n  if ((related_object_names != null ? related_object_names.length : void 0) === 0) {\n    return related_object_names;\n  }\n  permissions = Creator.getPermissions(object_name, spaceId, userId);\n  unrelated_objects = permissions.unrelated_objects;\n  related_object_names = _.difference(related_object_names, unrelated_objects);\n  return _.filter(related_objects, function(related_object) {\n    var allowRead, isActive, ref, related_object_name;\n    related_object_name = related_object.object_name;\n    isActive = related_object_names.indexOf(related_object_name) > -1;\n    allowRead = (ref = Creator.getPermissions(related_object_name, spaceId, userId)) != null ? ref.allowRead : void 0;\n    return isActive && allowRead;\n  });\n};\n\nCreator.getRelatedObjectNames = function(object_name, spaceId, userId) {\n  var related_objects;\n  related_objects = Creator.getRelatedObjects(object_name, spaceId, userId);\n  return _.pluck(related_objects, \"object_name\");\n};\n\nCreator.getActions = function(object_name, spaceId, userId) {\n  var actions, disabled_actions, obj, permissions;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  obj = Creator.getObject(object_name);\n  if (!obj) {\n    return;\n  }\n  permissions = Creator.getPermissions(object_name, spaceId, userId);\n  disabled_actions = permissions.disabled_actions;\n  actions = _.sortBy(_.values(obj.actions), 'sort');\n  _.each(actions, function(action) {\n    if (Steedos.isMobile() && action.on === \"record\" && action.name !== 'standard_edit') {\n      return action.on = 'record_more';\n    }\n  });\n  actions = _.filter(actions, function(action) {\n    return _.indexOf(disabled_actions, action.name) < 0;\n  });\n  return actions;\n};\n\n/返回当前用户有权限访问的所有list_view，包括分享的，用户自定义非分享的（除非owner变了），以及默认的其他视图注意Creator.getPermissions函数中是不会有用户自定义非分享的视图的，所以Creator.getPermissions函数中拿到的结果不全，并不是当前用户能看到所有视图/;\n\nCreator.getListViews = function(object_name, spaceId, userId) {\n  var disabled_list_views, isMobile, list_views, object;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  object = Creator.getObject(object_name);\n  if (!object) {\n    return;\n  }\n  disabled_list_views = Creator.getPermissions(object_name, spaceId, userId).disabled_list_views || [];\n  list_views = [];\n  isMobile = Steedos.isMobile();\n  _.each(object.list_views, function(item, item_name) {\n    if (isMobile && item.type === \"calendar\") {\n      return;\n    }\n    if (item_name !== \"default\") {\n      if (_.indexOf(disabled_list_views, item_name) < 0 || item.owner === userId) {\n        return list_views.push(item);\n      }\n    }\n  });\n  return list_views;\n};\n\nCreator.getFields = function(object_name, spaceId, userId) {\n  var fieldsName, unreadable_fields;\n  if (Meteor.isClient) {\n    if (!object_name) {\n      object_name = Session.get(\"object_name\");\n    }\n    if (!spaceId) {\n      spaceId = Session.get(\"spaceId\");\n    }\n    if (!userId) {\n      userId = Meteor.userId();\n    }\n  }\n  fieldsName = Creator.getObjectFieldsName(object_name);\n  unreadable_fields = Creator.getPermissions(object_name, spaceId, userId).unreadable_fields;\n  return _.difference(fieldsName, unreadable_fields);\n};\n\nCreator.isloading = function() {\n  return !Creator.bootstrapLoaded.get();\n};\n\nCreator.convertSpecialCharacter = function(str) {\n  return str.replace(/([\\^\\$\\(\\)\\*\\+\\?\\.\\\\\\|\\[\\]\\{\\}])/g, \"\\\\$1\");\n};\n\nCreator.getDisabledFields = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.disabled && !field.autoform.omit && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getHiddenFields = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.type === \"hidden\" && !field.autoform.omit && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getFieldsWithNoGroup = function(schema) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return (!field.autoform || !field.autoform.group || field.autoform.group === \"-\") && (!field.autoform || field.autoform.type !== \"hidden\") && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getSortedFieldGroupNames = function(schema) {\n  var names;\n  names = _.map(schema, function(field) {\n    return field.autoform && field.autoform.group !== \"-\" && field.autoform.group;\n  });\n  names = _.compact(names);\n  names = _.unique(names);\n  return names;\n};\n\nCreator.getFieldsForGroup = function(schema, groupName) {\n  var fields;\n  fields = _.map(schema, function(field, fieldName) {\n    return field.autoform && field.autoform.group === groupName && field.autoform.type !== \"hidden\" && fieldName;\n  });\n  fields = _.compact(fields);\n  return fields;\n};\n\nCreator.getFieldsWithoutOmit = function(schema, keys) {\n  keys = _.map(keys, function(key) {\n    var field, ref;\n    field = _.pick(schema, key);\n    if ((ref = field[key].autoform) != null ? ref.omit : void 0) {\n      return false;\n    } else {\n      return key;\n    }\n  });\n  keys = _.compact(keys);\n  return keys;\n};\n\nCreator.getFieldsInFirstLevel = function(firstLevelKeys, keys) {\n  keys = _.map(keys, function(key) {\n    if (_.indexOf(firstLevelKeys, key) > -1) {\n      return key;\n    } else {\n      return false;\n    }\n  });\n  keys = _.compact(keys);\n  return keys;\n};\n\nCreator.getFieldsForReorder = function(schema, keys, isSingle) {\n  var childKeys, fields, i, is_range_1, is_range_2, is_wide_1, is_wide_2, sc_1, sc_2;\n  fields = [];\n  i = 0;\n  while (i < keys.length) {\n    sc_1 = _.pick(schema, keys[i]);\n    sc_2 = _.pick(schema, keys[i + 1]);\n    is_wide_1 = false;\n    is_wide_2 = false;\n    is_range_1 = false;\n    is_range_2 = false;\n    _.each(sc_1, function(value) {\n      var ref, ref1, ref2;\n      if (((ref = value.autoform) != null ? ref.is_wide : void 0) || ((ref1 = value.autoform) != null ? ref1.type : void 0) === \"table\") {\n        is_wide_1 = true;\n      }\n      if ((ref2 = value.autoform) != null ? ref2.is_range : void 0) {\n        return is_range_1 = true;\n      }\n    });\n    _.each(sc_2, function(value) {\n      var ref, ref1, ref2;\n      if (((ref = value.autoform) != null ? ref.is_wide : void 0) || ((ref1 = value.autoform) != null ? ref1.type : void 0) === \"table\") {\n        is_wide_2 = true;\n      }\n      if ((ref2 = value.autoform) != null ? ref2.is_range : void 0) {\n        return is_range_2 = true;\n      }\n    });\n    if (isSingle) {\n      fields.push(keys.slice(i, i + 1));\n      i += 1;\n    } else {\n      if (!is_range_1 && is_range_2) {\n        childKeys = keys.slice(i, i + 1);\n        childKeys.push(void 0);\n        fields.push(childKeys);\n        i += 1;\n      } else if (is_wide_1) {\n        fields.push(keys.slice(i, i + 1));\n        i += 1;\n      } else if (!is_wide_1 && is_wide_2) {\n        childKeys = keys.slice(i, i + 1);\n        childKeys.push(void 0);\n        fields.push(childKeys);\n        i += 1;\n      } else if (!is_wide_1 && !is_wide_2) {\n        childKeys = keys.slice(i, i + 1);\n        if (keys[i + 1]) {\n          childKeys.push(keys[i + 1]);\n        } else {\n          childKeys.push(void 0);\n        }\n        fields.push(childKeys);\n        i += 2;\n      }\n    }\n  }\n  return fields;\n};\n\nif (Meteor.isServer) {\n  Creator.getAllRelatedObjects = function(object_name) {\n    var related_object_names;\n    related_object_names = [];\n    _.each(Creator.Objects, function(related_object, related_object_name) {\n      return _.each(related_object.fields, function(related_field, related_field_name) {\n        if (related_field.type === \"master_detail\" && related_field.reference_to && related_field.reference_to === object_name) {\n          return related_object_names.push(related_object_name);\n        }\n      });\n    });\n    if (Creator.getObject(object_name).enable_files) {\n      related_object_names.push(\"cms_files\");\n    }\n    return related_object_names;\n  };\n}\n","Creator.appsByName = {}\r\n\r\n","Meteor.methods\r\n\t\"object_recent_viewed\": (object_name, record_id)->\r\n\r\n\t\tif !this.userId\r\n\t\t\treturn null\r\n\r\n\t\tif object_name == \"object_recent_viewed\"\r\n\t\t\treturn\r\n\t\tif object_name and record_id\r\n\r\n\t\t\tdoc = Creator.getCollection(object_name).findOne({_id: record_id}, {fields: {space: 1}})\r\n\t\t\tspaceId = doc.space\r\n\r\n\t\t\tcollection_recent_viewed = Creator.getCollection(\"object_recent_viewed\")\r\n\t\t\tfilters = { owner: this.userId, space: spaceId, 'record.o': object_name, 'record.ids': [record_id]}\r\n\t\t\tcurrent_recent_viewed = collection_recent_viewed.findOne(filters)\r\n\t\t\tif current_recent_viewed\r\n\t\t\t\tcollection_recent_viewed.update(\r\n\t\t\t\t\tcurrent_recent_viewed._id,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$inc: {\r\n\t\t\t\t\t\t\tcount: 1\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\tmodified: new Date()\r\n\t\t\t\t\t\t\tmodified_by: this.userId\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t)\r\n\t\t\telse\r\n\t\t\t\tcollection_recent_viewed.insert(\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t_id: collection_recent_viewed._makeNewID()\r\n\t\t\t\t\t\towner: this.userId\r\n\t\t\t\t\t\tspace: spaceId\r\n\t\t\t\t\t\trecord: {o: object_name, ids: [record_id]}\r\n\t\t\t\t\t\tcount: 1\r\n\t\t\t\t\t\tcreated: new Date()\r\n\t\t\t\t\t\tcreated_by: this.userId\r\n\t\t\t\t\t\tmodified: new Date()\r\n\t\t\t\t\t\tmodified_by: this.userId\r\n\t\t\t\t\t}\r\n\t\t\t\t)\r\n\t\t\treturn","Meteor.methods({\n  \"object_recent_viewed\": function(object_name, record_id) {\n    var collection_recent_viewed, current_recent_viewed, doc, filters, spaceId;\n    if (!this.userId) {\n      return null;\n    }\n    if (object_name === \"object_recent_viewed\") {\n      return;\n    }\n    if (object_name && record_id) {\n      doc = Creator.getCollection(object_name).findOne({\n        _id: record_id\n      }, {\n        fields: {\n          space: 1\n        }\n      });\n      spaceId = doc.space;\n      collection_recent_viewed = Creator.getCollection(\"object_recent_viewed\");\n      filters = {\n        owner: this.userId,\n        space: spaceId,\n        'record.o': object_name,\n        'record.ids': [record_id]\n      };\n      current_recent_viewed = collection_recent_viewed.findOne(filters);\n      if (current_recent_viewed) {\n        collection_recent_viewed.update(current_recent_viewed._id, {\n          $inc: {\n            count: 1\n          },\n          $set: {\n            modified: new Date(),\n            modified_by: this.userId\n          }\n        });\n      } else {\n        collection_recent_viewed.insert({\n          _id: collection_recent_viewed._makeNewID(),\n          owner: this.userId,\n          space: spaceId,\n          record: {\n            o: object_name,\n            ids: [record_id]\n          },\n          count: 1,\n          created: new Date(),\n          created_by: this.userId,\n          modified: new Date(),\n          modified_by: this.userId\n        });\n      }\n    }\n  }\n});\n","recent_aggregate = (created_by, spaceId, _records, callback)->\r\n\tCreator.Collections.object_recent_viewed.rawCollection().aggregate([\r\n\t\t{$match: {created_by: created_by, space: spaceId}},\r\n\t\t{$group: {_id: {object_name: \"$record.o\", record_id: \"$record.ids\", space: \"$space\"}, maxCreated: {$max: \"$created\"}}},\r\n\t\t{$sort: {maxCreated: -1}},\r\n\t\t{$limit: 10}\r\n\t]).toArray (err, data)->\r\n\t\tif err\r\n\t\t\tthrow new Error(err)\r\n\r\n\t\tdata.forEach (doc) ->\r\n\t\t\t_records.push doc._id\r\n\r\n\t\tif callback && _.isFunction(callback)\r\n\t\t\tcallback()\r\n\r\n\t\treturn\r\n\r\nasync_recent_aggregate = Meteor.wrapAsync(recent_aggregate)\r\n\r\nsearch_object = (space, object_name,userId, searchText)->\r\n\tdata = new Array()\r\n\r\n\tif searchText\r\n\r\n\t\t_object = Creator.getObject(object_name)\r\n\r\n\t\t_object_collection = Creator.getCollection(object_name)\r\n\t\t_object_name_key = _object?.NAME_FIELD_KEY\r\n\t\tif _object && _object_collection && _object_name_key\r\n\t\t\tquery = {}\r\n\t\t\tsearch_Keywords = searchText.split(\" \")\r\n\t\t\tquery_and = []\r\n\t\t\tsearch_Keywords.forEach (keyword)->\r\n\t\t\t\tsubquery = {}\r\n\t\t\t\tsubquery[_object_name_key] = {$regex: keyword.trim()}\r\n\t\t\t\tquery_and.push subquery\r\n\r\n\t\t\tquery.$and = query_and\r\n\t\t\tquery.space = {$in: [space]}\r\n\r\n\t\t\tfields = {_id: 1}\r\n\t\t\tfields[_object_name_key] = 1\r\n\r\n\t\t\trecords = _object_collection.find(query, {fields: fields, sort: {modified: 1}, limit: 5})\r\n\r\n\t\t\trecords.forEach (record)->\r\n\t\t\t\tdata.push {_id: record._id, _name: record[_object_name_key], _object_name: object_name}\r\n\t\r\n\treturn data\r\n\r\nMeteor.methods\r\n\t'object_recent_record': (spaceId)->\r\n\t\tdata = new Array()\r\n\t\trecords = new Array()\r\n\t\tasync_recent_aggregate(this.userId, spaceId, records)\r\n\t\trecords.forEach (item)->\r\n\t\t\trecord_object = Creator.getObject(item.object_name, item.space)\r\n\r\n\t\t\tif !record_object\r\n\t\t\t\treturn\r\n\r\n\t\t\trecord_object_collection = Creator.getCollection(item.object_name, item.space)\r\n\r\n\t\t\tif record_object && record_object_collection\r\n\t\t\t\tfields = {_id: 1}\r\n\r\n\t\t\t\tfields[record_object.NAME_FIELD_KEY] = 1\r\n\r\n\t\t\t\trecord = record_object_collection.findOne(item.record_id[0], {fields: fields})\r\n\t\t\t\tif record\r\n\t\t\t\t\tdata.push {_id: record._id, _name: record[record_object.NAME_FIELD_KEY], _object_name: item.object_name}\r\n\r\n\t\treturn data\r\n\r\n\t'object_record_search': (options)->\r\n\t\tself = this\r\n\r\n\t\tdata = new Array()\r\n\r\n\t\tsearchText = options.searchText\r\n\t\tspace = options.space\r\n\r\n\t\t_.forEach Creator.objectsByName, (_object, name)->\r\n\t\t\tif _object.enable_search\r\n\t\t\t\tobject_record = search_object(space, _object.name, self.userId, searchText)\r\n\t\t\t\tdata = data.concat(object_record)\r\n\r\n\t\treturn data\r\n","var async_recent_aggregate, recent_aggregate, search_object;\n\nrecent_aggregate = function(created_by, spaceId, _records, callback) {\n  return Creator.Collections.object_recent_viewed.rawCollection().aggregate([\n    {\n      $match: {\n        created_by: created_by,\n        space: spaceId\n      }\n    }, {\n      $group: {\n        _id: {\n          object_name: \"$record.o\",\n          record_id: \"$record.ids\",\n          space: \"$space\"\n        },\n        maxCreated: {\n          $max: \"$created\"\n        }\n      }\n    }, {\n      $sort: {\n        maxCreated: -1\n      }\n    }, {\n      $limit: 10\n    }\n  ]).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return _records.push(doc._id);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\nasync_recent_aggregate = Meteor.wrapAsync(recent_aggregate);\n\nsearch_object = function(space, object_name, userId, searchText) {\n  var _object, _object_collection, _object_name_key, data, fields, query, query_and, records, search_Keywords;\n  data = new Array();\n  if (searchText) {\n    _object = Creator.getObject(object_name);\n    _object_collection = Creator.getCollection(object_name);\n    _object_name_key = _object != null ? _object.NAME_FIELD_KEY : void 0;\n    if (_object && _object_collection && _object_name_key) {\n      query = {};\n      search_Keywords = searchText.split(\" \");\n      query_and = [];\n      search_Keywords.forEach(function(keyword) {\n        var subquery;\n        subquery = {};\n        subquery[_object_name_key] = {\n          $regex: keyword.trim()\n        };\n        return query_and.push(subquery);\n      });\n      query.$and = query_and;\n      query.space = {\n        $in: [space]\n      };\n      fields = {\n        _id: 1\n      };\n      fields[_object_name_key] = 1;\n      records = _object_collection.find(query, {\n        fields: fields,\n        sort: {\n          modified: 1\n        },\n        limit: 5\n      });\n      records.forEach(function(record) {\n        return data.push({\n          _id: record._id,\n          _name: record[_object_name_key],\n          _object_name: object_name\n        });\n      });\n    }\n  }\n  return data;\n};\n\nMeteor.methods({\n  'object_recent_record': function(spaceId) {\n    var data, records;\n    data = new Array();\n    records = new Array();\n    async_recent_aggregate(this.userId, spaceId, records);\n    records.forEach(function(item) {\n      var fields, record, record_object, record_object_collection;\n      record_object = Creator.getObject(item.object_name, item.space);\n      if (!record_object) {\n        return;\n      }\n      record_object_collection = Creator.getCollection(item.object_name, item.space);\n      if (record_object && record_object_collection) {\n        fields = {\n          _id: 1\n        };\n        fields[record_object.NAME_FIELD_KEY] = 1;\n        record = record_object_collection.findOne(item.record_id[0], {\n          fields: fields\n        });\n        if (record) {\n          return data.push({\n            _id: record._id,\n            _name: record[record_object.NAME_FIELD_KEY],\n            _object_name: item.object_name\n          });\n        }\n      }\n    });\n    return data;\n  },\n  'object_record_search': function(options) {\n    var data, searchText, self, space;\n    self = this;\n    data = new Array();\n    searchText = options.searchText;\n    space = options.space;\n    _.forEach(Creator.objectsByName, function(_object, name) {\n      var object_record;\n      if (_object.enable_search) {\n        object_record = search_object(space, _object.name, self.userId, searchText);\n        return data = data.concat(object_record);\n      }\n    });\n    return data;\n  }\n});\n","Meteor.methods\r\n    update_filters: (listview_id, filters, filter_scope, filter_logic)->\r\n        Creator.Collections.object_listviews.direct.update({_id: listview_id}, {$set: {filters: filters, filter_scope: filter_scope, filter_logic: filter_logic}})\r\n\r\n    update_columns: (listview_id, columns)->\r\n        check(columns, Array)\r\n        \r\n        if columns.length < 1\r\n            throw new Meteor.Error 400, \"Select at least one field to display\"\r\n        Creator.Collections.object_listviews.update({_id: listview_id}, {$set: {columns: columns}})\r\n","Meteor.methods({\n  update_filters: function(listview_id, filters, filter_scope, filter_logic) {\n    return Creator.Collections.object_listviews.direct.update({\n      _id: listview_id\n    }, {\n      $set: {\n        filters: filters,\n        filter_scope: filter_scope,\n        filter_logic: filter_logic\n      }\n    });\n  },\n  update_columns: function(listview_id, columns) {\n    check(columns, Array);\n    if (columns.length < 1) {\n      throw new Meteor.Error(400, \"Select at least one field to display\");\n    }\n    return Creator.Collections.object_listviews.update({\n      _id: listview_id\n    }, {\n      $set: {\n        columns: columns\n      }\n    });\n  }\n});\n","Meteor.methods\r\n\t'report_data': (options)->\r\n\t\tcheck(options, Object)\r\n\t\tspace = options.space\r\n\t\tfields = options.fields\r\n\t\tobject_name = options.object_name\r\n\t\tfilter_scope = options.filter_scope\r\n\t\tfilters = options.filters\r\n\t\tfilterFields = {}\r\n\t\tcompoundFields = []\r\n\t\tobjectFields = Creator.getObject(object_name)?.fields\r\n\t\t_.each fields, (item, index)->\r\n\t\t\tsplits = item.split(\".\")\r\n\t\t\tname = splits[0]\r\n\t\t\tobjectField = objectFields[name]\r\n\t\t\tif splits.length > 1 and objectField\r\n\t\t\t\tchildKey = item.replace name + \".\", \"\"\r\n\t\t\t\tcompoundFields.push({name: name, childKey: childKey, field: objectField})\r\n\t\t\tfilterFields[name] = 1\r\n\r\n\t\tselector = {}\r\n\t\tuserId = this.userId\r\n\t\tselector.space = space\r\n\t\tif filter_scope == \"spacex\"\r\n\t\t\tselector.space = \r\n\t\t\t\t$in: [null,space]\r\n\t\telse if filter_scope == \"mine\"\r\n\t\t\tselector.owner = userId\r\n\r\n\t\tif Creator.isCommonSpace(space) && Creator.isSpaceAdmin(space, @userId)\r\n\t\t\tdelete selector.space\r\n\r\n\t\tif filters and filters.length > 0\r\n\t\t\tselector[\"$and\"] = filters\r\n\r\n\t\tcursor = Creator.getCollection(object_name).find(selector, {fields: filterFields, skip: 0, limit: 10000})\r\n#\t\tif cursor.count() > 10000\r\n#\t\t\treturn []\r\n\t\tresult = cursor.fetch()\r\n\t\tif compoundFields.length\r\n\t\t\tresult = result.map (item,index)->\r\n\t\t\t\t_.each compoundFields, (compoundFieldItem, index)->\r\n\t\t\t\t\titemKey = compoundFieldItem.name + \"*%*\" + compoundFieldItem.childKey.replace(/\\./g, \"*%*\")\r\n\t\t\t\t\titemValue = item[compoundFieldItem.name]\r\n\t\t\t\t\ttype = compoundFieldItem.field.type\r\n\t\t\t\t\tif [\"lookup\", \"master_detail\"].indexOf(type) > -1\r\n\t\t\t\t\t\treference_to = compoundFieldItem.field.reference_to\r\n\t\t\t\t\t\tcompoundFilterFields = {}\r\n\t\t\t\t\t\tcompoundFilterFields[compoundFieldItem.childKey] = 1\r\n\t\t\t\t\t\treferenceItem = Creator.getCollection(reference_to).findOne {_id: itemValue}, fields: compoundFilterFields\r\n\t\t\t\t\t\tif referenceItem\r\n\t\t\t\t\t\t\titem[itemKey] = referenceItem[compoundFieldItem.childKey]\r\n\t\t\t\t\telse if type == \"select\"\r\n\t\t\t\t\t\toptions = compoundFieldItem.field.options\r\n\t\t\t\t\t\titem[itemKey] = _.findWhere(options, {value: itemValue})?.label or itemValue\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\titem[itemKey] = itemValue\r\n\t\t\t\t\tunless item[itemKey]\r\n\t\t\t\t\t\titem[itemKey] = \"--\"\r\n\t\t\t\treturn item\r\n\t\t\treturn result\r\n\t\telse\r\n\t\t\treturn result\r\n\r\n","Meteor.methods({\n  'report_data': function(options) {\n    var compoundFields, cursor, fields, filterFields, filter_scope, filters, objectFields, object_name, ref, result, selector, space, userId;\n    check(options, Object);\n    space = options.space;\n    fields = options.fields;\n    object_name = options.object_name;\n    filter_scope = options.filter_scope;\n    filters = options.filters;\n    filterFields = {};\n    compoundFields = [];\n    objectFields = (ref = Creator.getObject(object_name)) != null ? ref.fields : void 0;\n    _.each(fields, function(item, index) {\n      var childKey, name, objectField, splits;\n      splits = item.split(\".\");\n      name = splits[0];\n      objectField = objectFields[name];\n      if (splits.length > 1 && objectField) {\n        childKey = item.replace(name + \".\", \"\");\n        compoundFields.push({\n          name: name,\n          childKey: childKey,\n          field: objectField\n        });\n      }\n      return filterFields[name] = 1;\n    });\n    selector = {};\n    userId = this.userId;\n    selector.space = space;\n    if (filter_scope === \"spacex\") {\n      selector.space = {\n        $in: [null, space]\n      };\n    } else if (filter_scope === \"mine\") {\n      selector.owner = userId;\n    }\n    if (Creator.isCommonSpace(space) && Creator.isSpaceAdmin(space, this.userId)) {\n      delete selector.space;\n    }\n    if (filters && filters.length > 0) {\n      selector[\"$and\"] = filters;\n    }\n    cursor = Creator.getCollection(object_name).find(selector, {\n      fields: filterFields,\n      skip: 0,\n      limit: 10000\n    });\n    result = cursor.fetch();\n    if (compoundFields.length) {\n      result = result.map(function(item, index) {\n        _.each(compoundFields, function(compoundFieldItem, index) {\n          var compoundFilterFields, itemKey, itemValue, ref1, referenceItem, reference_to, type;\n          itemKey = compoundFieldItem.name + \"*%*\" + compoundFieldItem.childKey.replace(/\\./g, \"*%*\");\n          itemValue = item[compoundFieldItem.name];\n          type = compoundFieldItem.field.type;\n          if ([\"lookup\", \"master_detail\"].indexOf(type) > -1) {\n            reference_to = compoundFieldItem.field.reference_to;\n            compoundFilterFields = {};\n            compoundFilterFields[compoundFieldItem.childKey] = 1;\n            referenceItem = Creator.getCollection(reference_to).findOne({\n              _id: itemValue\n            }, {\n              fields: compoundFilterFields\n            });\n            if (referenceItem) {\n              item[itemKey] = referenceItem[compoundFieldItem.childKey];\n            }\n          } else if (type === \"select\") {\n            options = compoundFieldItem.field.options;\n            item[itemKey] = ((ref1 = _.findWhere(options, {\n              value: itemValue\n            })) != null ? ref1.label : void 0) || itemValue;\n          } else {\n            item[itemKey] = itemValue;\n          }\n          if (!item[itemKey]) {\n            return item[itemKey] = \"--\";\n          }\n        });\n        return item;\n      });\n      return result;\n    } else {\n      return result;\n    }\n  }\n});\n","###\r\n    type: \"user\"\r\n    object_name: \"object_listviews\"\r\n    record_id: \"{object_name},{listview_id}\"\r\n    settings:\r\n        column_width: { field_a: 100, field_2: 150 }\r\n        sort: [[\"field_a\", \"desc\"]]\r\n    owner: {userId}\r\n###\r\n\r\nMeteor.methods\r\n    \"tabular_sort_settings\": (object_name, list_view_id, sort)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_listviews\", owner: userId})\r\n        if setting\r\n            Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.sort\": sort}})\r\n        else\r\n            doc = \r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_listviews\"\r\n                settings: {}\r\n                owner: userId\r\n\r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].sort = sort\r\n\r\n            Creator.Collections.settings.insert(doc)\r\n\r\n    \"tabular_column_width_settings\": (object_name, list_view_id, column_width)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_listviews\", owner: userId})\r\n        if setting\r\n            Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.column_width\": column_width}})\r\n        else\r\n            doc = \r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_listviews\"\r\n                settings: {}\r\n                owner: userId\r\n\r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].column_width = column_width\r\n\r\n            Creator.Collections.settings.insert(doc)\r\n\r\n    \"grid_settings\": (object_name, list_view_id, column_width, sort)->\r\n        userId = this.userId\r\n        setting = Creator.Collections.settings.findOne({object_name: object_name, record_id: \"object_gridviews\", owner: userId})\r\n        if setting\r\n            # 每次都强制改变_id_actions列的宽度，以解决当用户只改变字段次序而没有改变任何字段宽度时，前端没有订阅到字段次序变更的数据的问题\r\n            column_width._id_actions = if setting.settings[\"#{list_view_id}\"]?.column_width?._id_actions == 46 then 47 else 46\r\n            if sort\r\n                Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.sort\": sort, \"settings.#{list_view_id}.column_width\": column_width}})\r\n            else\r\n                Creator.Collections.settings.update({_id: setting._id}, {$set: {\"settings.#{list_view_id}.column_width\": column_width}})\r\n        else\r\n            doc =\r\n                type: \"user\"\r\n                object_name: object_name\r\n                record_id: \"object_gridviews\"\r\n                settings: {}\r\n                owner: userId\r\n            \r\n            doc.settings[list_view_id] = {}\r\n            doc.settings[list_view_id].column_width = column_width\r\n            doc.settings[list_view_id].sort = sort\r\n\r\n            Creator.Collections.settings.insert(doc)","\n/*\n    type: \"user\"\n    object_name: \"object_listviews\"\n    record_id: \"{object_name},{listview_id}\"\n    settings:\n        column_width: { field_a: 100, field_2: 150 }\n        sort: [[\"field_a\", \"desc\"]]\n    owner: {userId}\n */\nMeteor.methods({\n  \"tabular_sort_settings\": function(object_name, list_view_id, sort) {\n    var doc, obj, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_listviews\",\n      owner: userId\n    });\n    if (setting) {\n      return Creator.Collections.settings.update({\n        _id: setting._id\n      }, {\n        $set: (\n          obj = {},\n          obj[\"settings.\" + list_view_id + \".sort\"] = sort,\n          obj\n        )\n      });\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_listviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].sort = sort;\n      return Creator.Collections.settings.insert(doc);\n    }\n  },\n  \"tabular_column_width_settings\": function(object_name, list_view_id, column_width) {\n    var doc, obj, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_listviews\",\n      owner: userId\n    });\n    if (setting) {\n      return Creator.Collections.settings.update({\n        _id: setting._id\n      }, {\n        $set: (\n          obj = {},\n          obj[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n          obj\n        )\n      });\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_listviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].column_width = column_width;\n      return Creator.Collections.settings.insert(doc);\n    }\n  },\n  \"grid_settings\": function(object_name, list_view_id, column_width, sort) {\n    var doc, obj, obj1, ref, ref1, setting, userId;\n    userId = this.userId;\n    setting = Creator.Collections.settings.findOne({\n      object_name: object_name,\n      record_id: \"object_gridviews\",\n      owner: userId\n    });\n    if (setting) {\n      column_width._id_actions = ((ref = setting.settings[\"\" + list_view_id]) != null ? (ref1 = ref.column_width) != null ? ref1._id_actions : void 0 : void 0) === 46 ? 47 : 46;\n      if (sort) {\n        return Creator.Collections.settings.update({\n          _id: setting._id\n        }, {\n          $set: (\n            obj = {},\n            obj[\"settings.\" + list_view_id + \".sort\"] = sort,\n            obj[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n            obj\n          )\n        });\n      } else {\n        return Creator.Collections.settings.update({\n          _id: setting._id\n        }, {\n          $set: (\n            obj1 = {},\n            obj1[\"settings.\" + list_view_id + \".column_width\"] = column_width,\n            obj1\n          )\n        });\n      }\n    } else {\n      doc = {\n        type: \"user\",\n        object_name: object_name,\n        record_id: \"object_gridviews\",\n        settings: {},\n        owner: userId\n      };\n      doc.settings[list_view_id] = {};\n      doc.settings[list_view_id].column_width = column_width;\n      doc.settings[list_view_id].sort = sort;\n      return Creator.Collections.settings.insert(doc);\n    }\n  }\n});\n","xml2js = require 'xml2js'\r\nfs = require 'fs'\r\npath = require 'path'\r\nmkdirp = require 'mkdirp'\r\n\r\nlogger = new Logger 'Export_TO_XML'\r\n\r\n_writeXmlFile = (jsonObj,objName) ->\r\n\t# 转xml\r\n\tbuilder = new xml2js.Builder()\r\n\txml = builder.buildObject jsonObj\r\n\r\n\t# 转为buffer\r\n\tstream = new Buffer xml\r\n\r\n\t# 根据当天时间的年月日作为存储路径\r\n\tnow = new Date\r\n\tyear = now.getFullYear()\r\n\tmonth = now.getMonth() + 1\r\n\tday = now.getDate()\r\n\r\n\t# 文件路径\r\n\tfilePath = path.join(__meteor_bootstrap__.serverDir,'../../../export/' + year + '/' + month + '/' + day + '/' + objName )\r\n\tfileName = jsonObj?._id + \".xml\"\r\n\tfileAddress = path.join filePath, fileName\r\n\r\n\tif !fs.existsSync filePath\r\n\t\tmkdirp.sync filePath\r\n\r\n\t# 写入文件\r\n\tfs.writeFile fileAddress, stream, (err) ->\r\n\t\tif err\r\n\t\t\tlogger.error \"#{jsonObj._id}写入xml文件失败\",err\r\n\t\r\n\treturn filePath\r\n\r\n\r\n# 整理Fields的json数据\r\n_mixFieldsData = (obj,objName) ->\r\n\t# 初始化对象数据\r\n\tjsonObj = {}\r\n\t# 获取fields\r\n\tobjFields = Creator?.getObject(objName)?.fields\r\n\r\n\tmixDefault = (field_name)->\r\n\t\tjsonObj[field_name] = obj[field_name] || \"\"\r\n\r\n\tmixDate = (field_name,type)->\r\n\t\tdate = obj[field_name]\r\n\t\tif type == \"date\"\r\n\t\t\tformat = \"YYYY-MM-DD\"\r\n\t\telse\r\n\t\t\tformat = \"YYYY-MM-DD HH:mm:ss\"\r\n\t\tif date? and format?\r\n\t\t\tdateStr = moment(date).format(format)\r\n\t\tjsonObj[field_name] = dateStr || \"\"\r\n\r\n\tmixBool = (field_name)->\r\n\t\tif obj[field_name] == true\r\n\t\t\tjsonObj[field_name] = \"是\"\r\n\t\telse if obj[field_name] == false\r\n\t\t\tjsonObj[field_name] = \"否\"\r\n\t\telse\r\n\t\t\tjsonObj[field_name] = \"\"\r\n\r\n\t# 循环每个fields,并判断取值\r\n\t_.each objFields, (field, field_name)->\r\n\t\tswitch field?.type\r\n\t\t\twhen \"date\",\"datetime\" then mixDate field_name,field.type\r\n\t\t\twhen \"boolean\" then mixBool field_name\r\n\t\t\telse mixDefault field_name\r\n\r\n\treturn jsonObj\r\n\r\n# 获取子表整理数据\r\n_mixRelatedData = (obj,objName) ->\r\n\t# 初始化对象数据\r\n\trelated_objects = {}\r\n\r\n\t# 获取相关表\r\n\trelatedObjNames = Creator?.getAllRelatedObjects objName\r\n\r\n\t# 循环相关表\r\n\trelatedObjNames.forEach (relatedObjName) ->\r\n\t\t# 每个表定义一个对象数组\r\n\t\trelatedTableData = []\r\n\r\n\t\t# *设置关联搜索查询的字段\r\n\t\t# 附件的关联搜索字段是定死的\r\n\t\tif relatedObjName == \"cms_files\"\r\n\t\t\trelated_field_name = \"parent.ids\"\r\n\t\telse\r\n\t\t\t# 获取fields\r\n\t\t\tfields = Creator?.Objects[relatedObjName]?.fields\r\n\t\t\t# 循环每个field,找出reference_to的关联字段\r\n\t\t\trelated_field_name = \"\"\r\n\t\t\t_.each fields, (field, field_name)->\r\n\t\t\t\tif field?.reference_to == objName\r\n\t\t\t\t\trelated_field_name = field_name\r\n\r\n\t\t# 根据找出的关联字段，查子表数据\r\n\t\tif related_field_name\r\n\t\t\trelatedCollection = Creator.getCollection(relatedObjName)\r\n\t\t\t# 获取到所有的数据\r\n\t\t\trelatedRecordList = relatedCollection.find({\"#{related_field_name}\":obj._id}).fetch()\r\n\t\t\t# 循环每一条数据\r\n\t\t\trelatedRecordList.forEach (relatedObj)->\r\n\t\t\t\t# 整合fields数据\r\n\t\t\t\tfieldsData = _mixFieldsData relatedObj,relatedObjName\r\n\t\t\t\t# 把一条记录插入到对象数组中\r\n\t\t\t\trelatedTableData.push fieldsData\r\n\r\n\t\t# 把一个子表的所有数据插入到related_objects中，再循环下一个\r\n\t\trelated_objects[relatedObjName] = relatedTableData\r\n\r\n\treturn related_objects\r\n\r\n# Creator.Export2xml()\r\nCreator.Export2xml = (objName, recordList) ->\r\n\tlogger.info \"Run Creator.Export2xml\"\r\n\r\n\tconsole.time \"Creator.Export2xml\"\r\n\r\n\t# 测试数据\r\n\t# objName = \"archive_records\"\r\n\r\n\t# 查找对象数据\r\n\tcollection = Creator.getCollection(objName)\r\n\t# 测试数据\r\n\trecordList = collection.find({}).fetch()\r\n\r\n\trecordList.forEach (recordObj)->\r\n\t\tjsonObj = {}\r\n\t\tjsonObj._id = recordObj._id\r\n\r\n\t\t# 整理主表的Fields数据\r\n\t\tfieldsData = _mixFieldsData recordObj,objName\r\n\t\tjsonObj[objName] = fieldsData\r\n\r\n\t\t# 整理相关表数据\r\n\t\trelated_objects = _mixRelatedData recordObj,objName\r\n\r\n\t\tjsonObj[\"related_objects\"] = related_objects\r\n\r\n\t\t# 转为xml保存文件\r\n\t\tfilePath = _writeXmlFile jsonObj,objName\r\n\r\n\tconsole.timeEnd \"Creator.Export2xml\"\r\n\treturn filePath","var _mixFieldsData, _mixRelatedData, _writeXmlFile, fs, logger, mkdirp, path, xml2js;\n\nxml2js = require('xml2js');\n\nfs = require('fs');\n\npath = require('path');\n\nmkdirp = require('mkdirp');\n\nlogger = new Logger('Export_TO_XML');\n\n_writeXmlFile = function(jsonObj, objName) {\n  var builder, day, fileAddress, fileName, filePath, month, now, stream, xml, year;\n  builder = new xml2js.Builder();\n  xml = builder.buildObject(jsonObj);\n  stream = new Buffer(xml);\n  now = new Date;\n  year = now.getFullYear();\n  month = now.getMonth() + 1;\n  day = now.getDate();\n  filePath = path.join(__meteor_bootstrap__.serverDir, '../../../export/' + year + '/' + month + '/' + day + '/' + objName);\n  fileName = (jsonObj != null ? jsonObj._id : void 0) + \".xml\";\n  fileAddress = path.join(filePath, fileName);\n  if (!fs.existsSync(filePath)) {\n    mkdirp.sync(filePath);\n  }\n  fs.writeFile(fileAddress, stream, function(err) {\n    if (err) {\n      return logger.error(jsonObj._id + \"写入xml文件失败\", err);\n    }\n  });\n  return filePath;\n};\n\n_mixFieldsData = function(obj, objName) {\n  var jsonObj, mixBool, mixDate, mixDefault, objFields, ref;\n  jsonObj = {};\n  objFields = typeof Creator !== \"undefined\" && Creator !== null ? (ref = Creator.getObject(objName)) != null ? ref.fields : void 0 : void 0;\n  mixDefault = function(field_name) {\n    return jsonObj[field_name] = obj[field_name] || \"\";\n  };\n  mixDate = function(field_name, type) {\n    var date, dateStr, format;\n    date = obj[field_name];\n    if (type === \"date\") {\n      format = \"YYYY-MM-DD\";\n    } else {\n      format = \"YYYY-MM-DD HH:mm:ss\";\n    }\n    if ((date != null) && (format != null)) {\n      dateStr = moment(date).format(format);\n    }\n    return jsonObj[field_name] = dateStr || \"\";\n  };\n  mixBool = function(field_name) {\n    if (obj[field_name] === true) {\n      return jsonObj[field_name] = \"是\";\n    } else if (obj[field_name] === false) {\n      return jsonObj[field_name] = \"否\";\n    } else {\n      return jsonObj[field_name] = \"\";\n    }\n  };\n  _.each(objFields, function(field, field_name) {\n    switch (field != null ? field.type : void 0) {\n      case \"date\":\n      case \"datetime\":\n        return mixDate(field_name, field.type);\n      case \"boolean\":\n        return mixBool(field_name);\n      default:\n        return mixDefault(field_name);\n    }\n  });\n  return jsonObj;\n};\n\n_mixRelatedData = function(obj, objName) {\n  var relatedObjNames, related_objects;\n  related_objects = {};\n  relatedObjNames = typeof Creator !== \"undefined\" && Creator !== null ? Creator.getAllRelatedObjects(objName) : void 0;\n  relatedObjNames.forEach(function(relatedObjName) {\n    var fields, obj1, ref, relatedCollection, relatedRecordList, relatedTableData, related_field_name;\n    relatedTableData = [];\n    if (relatedObjName === \"cms_files\") {\n      related_field_name = \"parent.ids\";\n    } else {\n      fields = typeof Creator !== \"undefined\" && Creator !== null ? (ref = Creator.Objects[relatedObjName]) != null ? ref.fields : void 0 : void 0;\n      related_field_name = \"\";\n      _.each(fields, function(field, field_name) {\n        if ((field != null ? field.reference_to : void 0) === objName) {\n          return related_field_name = field_name;\n        }\n      });\n    }\n    if (related_field_name) {\n      relatedCollection = Creator.getCollection(relatedObjName);\n      relatedRecordList = relatedCollection.find((\n        obj1 = {},\n        obj1[\"\" + related_field_name] = obj._id,\n        obj1\n      )).fetch();\n      relatedRecordList.forEach(function(relatedObj) {\n        var fieldsData;\n        fieldsData = _mixFieldsData(relatedObj, relatedObjName);\n        return relatedTableData.push(fieldsData);\n      });\n    }\n    return related_objects[relatedObjName] = relatedTableData;\n  });\n  return related_objects;\n};\n\nCreator.Export2xml = function(objName, recordList) {\n  var collection;\n  logger.info(\"Run Creator.Export2xml\");\n  console.time(\"Creator.Export2xml\");\n  collection = Creator.getCollection(objName);\n  recordList = collection.find({}).fetch();\n  recordList.forEach(function(recordObj) {\n    var fieldsData, filePath, jsonObj, related_objects;\n    jsonObj = {};\n    jsonObj._id = recordObj._id;\n    fieldsData = _mixFieldsData(recordObj, objName);\n    jsonObj[objName] = fieldsData;\n    related_objects = _mixRelatedData(recordObj, objName);\n    jsonObj[\"related_objects\"] = related_objects;\n    return filePath = _writeXmlFile(jsonObj, objName);\n  });\n  console.timeEnd(\"Creator.Export2xml\");\n  return filePath;\n};\n","Meteor.methods \r\n\trelated_objects_records: (object_name, related_object_name, related_field_name, record_id, spaceId)->\r\n\t\tuserId = this.userId\r\n\t\tif related_object_name == \"cfs.files.filerecord\"\r\n\t\t\tselector = {\"metadata.space\": spaceId}\r\n\t\telse\r\n\t\t\tselector = {space: spaceId}\r\n\t\t\r\n\t\tif related_object_name == \"cms_files\"\r\n\t\t\t# 附件的关联搜索条件是定死的\r\n\t\t\tselector[\"parent.o\"] = object_name\r\n\t\t\tselector[\"parent.ids\"] = [record_id]\r\n\t\telse\r\n\t\t\tselector[related_field_name] = record_id\r\n\r\n\t\tpermissions = Creator.getPermissions(related_object_name, spaceId, userId)\r\n\t\tif !permissions.viewAllRecords and permissions.allowRead\r\n\t\t\tselector.owner = userId\r\n\t\t\r\n\t\trelated_records = Creator.getCollection(related_object_name).find(selector)\r\n\t\treturn related_records.count()","Meteor.methods({\n  related_objects_records: function(object_name, related_object_name, related_field_name, record_id, spaceId) {\n    var permissions, related_records, selector, userId;\n    userId = this.userId;\n    if (related_object_name === \"cfs.files.filerecord\") {\n      selector = {\n        \"metadata.space\": spaceId\n      };\n    } else {\n      selector = {\n        space: spaceId\n      };\n    }\n    if (related_object_name === \"cms_files\") {\n      selector[\"parent.o\"] = object_name;\n      selector[\"parent.ids\"] = [record_id];\n    } else {\n      selector[related_field_name] = record_id;\n    }\n    permissions = Creator.getPermissions(related_object_name, spaceId, userId);\n    if (!permissions.viewAllRecords && permissions.allowRead) {\n      selector.owner = userId;\n    }\n    related_records = Creator.getCollection(related_object_name).find(selector);\n    return related_records.count();\n  }\n});\n","Meteor.publish \"creator_object_record\", (object_name, id, space_id)->\r\n\tcollection = Creator.getCollection(object_name, space_id)\r\n\tif collection\r\n\t\treturn collection.find({_id: id})\r\n\r\n","Meteor.publish(\"creator_object_record\", function(object_name, id, space_id) {\n  var collection;\n  collection = Creator.getCollection(object_name, space_id);\n  if (collection) {\n    return collection.find({\n      _id: id\n    });\n  }\n});\n","Meteor.publishComposite \"steedos_object_tabular\", (tableName, ids, fields, spaceId)->\r\n\tunless this.userId\r\n\t\treturn this.ready()\r\n\r\n\tcheck(tableName, String);\r\n\tcheck(ids, Array);\r\n\tcheck(fields, Match.Optional(Object));\r\n\r\n\t_object_name = tableName.replace(\"creator_\",\"\")\r\n\t_object = Creator.getObject(_object_name, spaceId)\r\n\r\n\tif spaceId\r\n\t\t_object_name = Creator.getObjectName(_object)\r\n\r\n\tobject_colleciton = Creator.getCollection(_object_name)\r\n\r\n\r\n\t_fields = _object?.fields\r\n\tif !_fields || !object_colleciton\r\n\t\treturn this.ready()\r\n\r\n\treference_fields = _.filter _fields, (f)->\r\n\t\treturn _.isFunction(f.reference_to) || !_.isEmpty(f.reference_to)\r\n\r\n\tself = this\r\n\r\n\tself.unblock();\r\n\r\n\tif reference_fields.length > 0\r\n\t\tdata = {\r\n\t\t\tfind: ()->\r\n\t\t\t\tself.unblock();\r\n\t\t\t\tfield_keys = {}\r\n\t\t\t\t_.each _.keys(fields), (f)->\r\n\t\t\t\t\tunless /\\w+(\\.\\$){1}\\w?/.test(f)\r\n\t\t\t\t\t\tfield_keys[f] = 1\r\n\t\t\t\t\r\n\t\t\t\treturn object_colleciton.find({_id: {$in: ids}}, {fields: field_keys});\r\n\t\t}\r\n\r\n\t\tdata.children = []\r\n\r\n\t\tkeys = _.keys(fields)\r\n\r\n\t\tif keys.length < 1\r\n\t\t\tkeys = _.keys(_fields)\r\n\r\n\t\t_keys = []\r\n\r\n\t\tkeys.forEach (key)->\r\n\t\t\tif _object.schema._objectKeys[key + '.']\r\n\t\t\t\t_keys = _keys.concat(_.map(_object.schema._objectKeys[key + '.'], (k)->\r\n\t\t\t\t\treturn key + '.' + k\r\n\t\t\t\t))\r\n\t\t\t_keys.push(key)\r\n\r\n\t\t_keys.forEach (key)->\r\n\t\t\treference_field = _fields[key]\r\n\r\n\t\t\tif reference_field && (_.isFunction(reference_field.reference_to) || !_.isEmpty(reference_field.reference_to))  # and Creator.Collections[reference_field.reference_to]\r\n\t\t\t\tdata.children.push {\r\n\t\t\t\t\tfind: (parent) ->\r\n\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t\tself.unblock();\r\n\r\n\t\t\t\t\t\t\tquery = {}\r\n\r\n\t\t\t\t\t\t\t# 表格子字段特殊处理\r\n\t\t\t\t\t\t\tif /\\w+(\\.\\$\\.){1}\\w+/.test(key)\r\n\t\t\t\t\t\t\t\tp_k = key.replace(/(\\w+)\\.\\$\\.\\w+/ig, \"$1\")\r\n\t\t\t\t\t\t\t\ts_k = key.replace(/\\w+\\.\\$\\.(\\w+)/ig, \"$1\")\r\n\t\t\t\t\t\t\t\treference_ids = parent[p_k].getProperty(s_k)\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\treference_ids = key.split('.').reduce (o, x) ->\r\n\t\t\t\t\t\t\t\t\t\to?[x]\r\n\t\t\t\t\t\t\t\t, parent\r\n\r\n\t\t\t\t\t\t\treference_to = reference_field.reference_to\r\n\r\n\t\t\t\t\t\t\tif _.isFunction(reference_to)\r\n\t\t\t\t\t\t\t\treference_to = reference_to()\r\n\r\n\t\t\t\t\t\t\tif _.isArray(reference_to)\r\n\t\t\t\t\t\t\t\tif _.isObject(reference_ids) && !_.isArray(reference_ids)\r\n\t\t\t\t\t\t\t\t\treference_to = reference_ids.o\r\n\t\t\t\t\t\t\t\t\treference_ids = reference_ids.ids || []\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\treturn []\r\n\r\n\t\t\t\t\t\t\tif _.isArray(reference_ids)\r\n\t\t\t\t\t\t\t\tquery._id = {$in: reference_ids}\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tquery._id = reference_ids\r\n\r\n\t\t\t\t\t\t\treference_to_object = Creator.getObject(reference_to, spaceId)\r\n\r\n\t\t\t\t\t\t\tname_field_key = reference_to_object.NAME_FIELD_KEY\r\n\r\n\t\t\t\t\t\t\tchildren_fields = {_id: 1, space: 1}\r\n\r\n\t\t\t\t\t\t\tif name_field_key\r\n\t\t\t\t\t\t\t\tchildren_fields[name_field_key] = 1\r\n\r\n\t\t\t\t\t\t\treturn Creator.getCollection(reference_to, spaceId).find(query, {\r\n\t\t\t\t\t\t\t\tfields: children_fields\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\tcatch e\r\n\t\t\t\t\t\t\tconsole.log(reference_to, parent, e)\r\n\t\t\t\t\t\t\treturn []\r\n\t\t\t\t}\r\n\r\n\t\treturn data\r\n\telse\r\n\t\treturn {\r\n\t\t\tfind: ()->\r\n\t\t\t\tself.unblock();\r\n\t\t\t\treturn object_colleciton.find({_id: {$in: ids}}, {fields: fields})\r\n\t\t};\r\n\r\n","Meteor.publishComposite(\"steedos_object_tabular\", function(tableName, ids, fields, spaceId) {\n  var _fields, _keys, _object, _object_name, data, keys, object_colleciton, reference_fields, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  _object_name = tableName.replace(\"creator_\", \"\");\n  _object = Creator.getObject(_object_name, spaceId);\n  if (spaceId) {\n    _object_name = Creator.getObjectName(_object);\n  }\n  object_colleciton = Creator.getCollection(_object_name);\n  _fields = _object != null ? _object.fields : void 0;\n  if (!_fields || !object_colleciton) {\n    return this.ready();\n  }\n  reference_fields = _.filter(_fields, function(f) {\n    return _.isFunction(f.reference_to) || !_.isEmpty(f.reference_to);\n  });\n  self = this;\n  self.unblock();\n  if (reference_fields.length > 0) {\n    data = {\n      find: function() {\n        var field_keys;\n        self.unblock();\n        field_keys = {};\n        _.each(_.keys(fields), function(f) {\n          if (!/\\w+(\\.\\$){1}\\w?/.test(f)) {\n            return field_keys[f] = 1;\n          }\n        });\n        return object_colleciton.find({\n          _id: {\n            $in: ids\n          }\n        }, {\n          fields: field_keys\n        });\n      }\n    };\n    data.children = [];\n    keys = _.keys(fields);\n    if (keys.length < 1) {\n      keys = _.keys(_fields);\n    }\n    _keys = [];\n    keys.forEach(function(key) {\n      if (_object.schema._objectKeys[key + '.']) {\n        _keys = _keys.concat(_.map(_object.schema._objectKeys[key + '.'], function(k) {\n          return key + '.' + k;\n        }));\n      }\n      return _keys.push(key);\n    });\n    _keys.forEach(function(key) {\n      var reference_field;\n      reference_field = _fields[key];\n      if (reference_field && (_.isFunction(reference_field.reference_to) || !_.isEmpty(reference_field.reference_to))) {\n        return data.children.push({\n          find: function(parent) {\n            var children_fields, e, name_field_key, p_k, query, reference_ids, reference_to, reference_to_object, s_k;\n            try {\n              self.unblock();\n              query = {};\n              if (/\\w+(\\.\\$\\.){1}\\w+/.test(key)) {\n                p_k = key.replace(/(\\w+)\\.\\$\\.\\w+/ig, \"$1\");\n                s_k = key.replace(/\\w+\\.\\$\\.(\\w+)/ig, \"$1\");\n                reference_ids = parent[p_k].getProperty(s_k);\n              } else {\n                reference_ids = key.split('.').reduce(function(o, x) {\n                  return o != null ? o[x] : void 0;\n                }, parent);\n              }\n              reference_to = reference_field.reference_to;\n              if (_.isFunction(reference_to)) {\n                reference_to = reference_to();\n              }\n              if (_.isArray(reference_to)) {\n                if (_.isObject(reference_ids) && !_.isArray(reference_ids)) {\n                  reference_to = reference_ids.o;\n                  reference_ids = reference_ids.ids || [];\n                } else {\n                  return [];\n                }\n              }\n              if (_.isArray(reference_ids)) {\n                query._id = {\n                  $in: reference_ids\n                };\n              } else {\n                query._id = reference_ids;\n              }\n              reference_to_object = Creator.getObject(reference_to, spaceId);\n              name_field_key = reference_to_object.NAME_FIELD_KEY;\n              children_fields = {\n                _id: 1,\n                space: 1\n              };\n              if (name_field_key) {\n                children_fields[name_field_key] = 1;\n              }\n              return Creator.getCollection(reference_to, spaceId).find(query, {\n                fields: children_fields\n              });\n            } catch (error) {\n              e = error;\n              console.log(reference_to, parent, e);\n              return [];\n            }\n          }\n        });\n      }\n    });\n    return data;\n  } else {\n    return {\n      find: function() {\n        self.unblock();\n        return object_colleciton.find({\n          _id: {\n            $in: ids\n          }\n        }, {\n          fields: fields\n        });\n      }\n    };\n  }\n});\n","Meteor.publish \"object_listviews\", (object_name, spaceId)->\r\n    userId = this.userId\r\n    return Creator.getCollection(\"object_listviews\").find({object_name: object_name, space: spaceId ,\"$or\":[{owner: userId}, {shared: true}]})","Meteor.publish \"user_tabular_settings\", (object_name)->\r\n    userId = this.userId\r\n    return Creator.Collections.settings.find({object_name: {$in: object_name}, record_id: {$in: [\"object_listviews\", \"object_gridviews\"]}, owner: userId})\r\n","Meteor.publish \"related_objects_records\", (object_name, related_object_name, related_field_name, record_id, spaceId)->\r\n\tuserId = this.userId\r\n\tif related_object_name == \"cfs.files.filerecord\"\r\n\t\tselector = {\"metadata.space\": spaceId}\r\n\telse\r\n\t\tselector = {space: spaceId}\r\n\t\r\n\tif related_object_name == \"cms_files\"\r\n\t\t# 附件的关联搜索条件是定死的\r\n\t\tselector[\"parent.o\"] = object_name\r\n\t\tselector[\"parent.ids\"] = [record_id]\r\n\telse\r\n\t\tselector[related_field_name] = record_id\r\n\r\n\tpermissions = Creator.getPermissions(related_object_name, spaceId, userId)\r\n\tif !permissions.viewAllRecords and permissions.allowRead\r\n\t\tselector.owner = userId\r\n\t\r\n\treturn Creator.getCollection(related_object_name).find(selector)","Meteor.publish(\"related_objects_records\", function(object_name, related_object_name, related_field_name, record_id, spaceId) {\n  var permissions, selector, userId;\n  userId = this.userId;\n  if (related_object_name === \"cfs.files.filerecord\") {\n    selector = {\n      \"metadata.space\": spaceId\n    };\n  } else {\n    selector = {\n      space: spaceId\n    };\n  }\n  if (related_object_name === \"cms_files\") {\n    selector[\"parent.o\"] = object_name;\n    selector[\"parent.ids\"] = [record_id];\n  } else {\n    selector[related_field_name] = record_id;\n  }\n  permissions = Creator.getPermissions(related_object_name, spaceId, userId);\n  if (!permissions.viewAllRecords && permissions.allowRead) {\n    selector.owner = userId;\n  }\n  return Creator.getCollection(related_object_name).find(selector);\n});\n","Meteor.publish 'space_user_info', (spaceId, userId)->\r\n\treturn Creator.getCollection(\"space_users\").find({space: spaceId, user: userId})","\r\nif Meteor.isServer\r\n\r\n\tMeteor.publish 'contacts_view_limits', (spaceId)->\r\n\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tselector =\r\n\t\t\tspace: spaceId\r\n\t\t\tkey: 'contacts_view_limits'\r\n\r\n\t\treturn db.space_settings.find(selector)","if (Meteor.isServer) {\n  Meteor.publish('contacts_view_limits', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    if (!spaceId) {\n      return this.ready();\n    }\n    selector = {\n      space: spaceId,\n      key: 'contacts_view_limits'\n    };\n    return db.space_settings.find(selector);\n  });\n}\n","\r\nif Meteor.isServer\r\n\r\n\tMeteor.publish 'contacts_no_force_phone_users', (spaceId)->\r\n\r\n\t\tunless this.userId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tunless spaceId\r\n\t\t\treturn this.ready()\r\n\r\n\t\tselector =\r\n\t\t\tspace: spaceId\r\n\t\t\tkey: 'contacts_no_force_phone_users'\r\n\r\n\t\treturn db.space_settings.find(selector)","if (Meteor.isServer) {\n  Meteor.publish('contacts_no_force_phone_users', function(spaceId) {\n    var selector;\n    if (!this.userId) {\n      return this.ready();\n    }\n    if (!spaceId) {\n      return this.ready();\n    }\n    selector = {\n      space: spaceId,\n      key: 'contacts_no_force_phone_users'\n    };\n    return db.space_settings.find(selector);\n  });\n}\n","permissionManager = {}\r\n\r\npermissionManager.getFlowPermissions = (flow_id, user_id) ->\r\n\t# 根据:flow_id查到对应的flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\tspace_id = flow.space\r\n\t# 根据space_id和:user_id到organizations表中查到用户所属所有的org_id（包括上级组ID）\r\n\torg_ids = new Array\r\n\torganizations = db.organizations.find({\r\n\t\tspace: space_id, users: user_id }, { fields: { parents: 1 } }).fetch()\r\n\t_.each(organizations, (org) ->\r\n\t\torg_ids.push(org._id)\r\n\t\tif org.parents\r\n\t\t\t_.each(org.parents, (parent_id) ->\r\n\t\t\t\torg_ids.push(parent_id)\r\n\t\t\t)\r\n\t)\r\n\torg_ids = _.uniq(org_ids)\r\n\tmy_permissions = new Array\r\n\tif flow.perms\r\n\t\t# 判断flow.perms.users_can_admin中是否包含当前用户，\r\n\t\t# 或者flow.perms.orgs_can_add是否包含4步得到的org_id数组中的任何一个，\r\n\t\t# 若是，则在返回的数组中加上add\r\n\t\tif flow.perms.users_can_add\r\n\t\t\tusers_can_add = flow.perms.users_can_add\r\n\t\t\tif users_can_add.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"add\")\r\n\r\n\t\tif flow.perms.orgs_can_add\r\n\t\t\torgs_can_add = flow.perms.orgs_can_add\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_add.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"add\")\r\n\t\t\t)\r\n\t\t# 判断flow.perms.users_can_monitor中是否包含当前用户，\r\n\t\t# 或者flow.perms.orgs_can_monitor是否包含4步得到的org_id数组中的任何一个，\r\n\t\t# 若是，则在返回的数组中加上monitor\r\n\t\tif flow.perms.users_can_monitor\r\n\t\t\tusers_can_monitor = flow.perms.users_can_monitor\r\n\t\t\tif users_can_monitor.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"monitor\")\r\n\r\n\t\tif flow.perms.orgs_can_monitor\r\n\t\t\torgs_can_monitor = flow.perms.orgs_can_monitor\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_monitor.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"monitor\")\r\n\t\t\t)\r\n\t\t# 判断flow.perms.users_can_admin中是否包含当前用户，\r\n\t\t# 或者flow.perms.orgs_can_admin是否包含4步得到的org_id数组中的任何一个，\r\n\t\t# 若是，则在返回的数组中加上admin\r\n\t\tif flow.perms.users_can_admin\r\n\t\t\tusers_can_admin = flow.perms.users_can_admin\r\n\t\t\tif users_can_admin.includes(user_id)\r\n\t\t\t\tmy_permissions.push(\"admin\")\r\n\r\n\t\tif flow.perms.orgs_can_admin\r\n\t\t\torgs_can_admin = flow.perms.orgs_can_admin\r\n\t\t\t_.each(org_ids, (org_id) ->\r\n\t\t\t\tif orgs_can_admin.includes(org_id)\r\n\t\t\t\t\tmy_permissions.push(\"admin\")\r\n\t\t\t)\r\n\r\n\tmy_permissions = _.uniq(my_permissions)\r\n\treturn my_permissions","                      \n\npermissionManager = {};\n\npermissionManager.getFlowPermissions = function(flow_id, user_id) {\n  var flow, my_permissions, org_ids, organizations, orgs_can_add, orgs_can_admin, orgs_can_monitor, space_id, users_can_add, users_can_admin, users_can_monitor;\n  flow = uuflowManager.getFlow(flow_id);\n  space_id = flow.space;\n  org_ids = new Array;\n  organizations = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  }).fetch();\n  _.each(organizations, function(org) {\n    org_ids.push(org._id);\n    if (org.parents) {\n      return _.each(org.parents, function(parent_id) {\n        return org_ids.push(parent_id);\n      });\n    }\n  });\n  org_ids = _.uniq(org_ids);\n  my_permissions = new Array;\n  if (flow.perms) {\n    if (flow.perms.users_can_add) {\n      users_can_add = flow.perms.users_can_add;\n      if (users_can_add.includes(user_id)) {\n        my_permissions.push(\"add\");\n      }\n    }\n    if (flow.perms.orgs_can_add) {\n      orgs_can_add = flow.perms.orgs_can_add;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_add.includes(org_id)) {\n          return my_permissions.push(\"add\");\n        }\n      });\n    }\n    if (flow.perms.users_can_monitor) {\n      users_can_monitor = flow.perms.users_can_monitor;\n      if (users_can_monitor.includes(user_id)) {\n        my_permissions.push(\"monitor\");\n      }\n    }\n    if (flow.perms.orgs_can_monitor) {\n      orgs_can_monitor = flow.perms.orgs_can_monitor;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_monitor.includes(org_id)) {\n          return my_permissions.push(\"monitor\");\n        }\n      });\n    }\n    if (flow.perms.users_can_admin) {\n      users_can_admin = flow.perms.users_can_admin;\n      if (users_can_admin.includes(user_id)) {\n        my_permissions.push(\"admin\");\n      }\n    }\n    if (flow.perms.orgs_can_admin) {\n      orgs_can_admin = flow.perms.orgs_can_admin;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_admin.includes(org_id)) {\n          return my_permissions.push(\"admin\");\n        }\n      });\n    }\n  }\n  my_permissions = _.uniq(my_permissions);\n  return my_permissions;\n};\n","_eval = require('eval')\r\nuuflowManager = {}\r\n\r\nuuflowManager.check_authorization = (req) ->\r\n\tquery = req.query\r\n\tuserId = query[\"X-User-Id\"]\r\n\tauthToken = query[\"X-Auth-Token\"]\r\n\r\n\tif not userId or not authToken\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\thashedToken = Accounts._hashLoginToken(authToken)\r\n\tuser = Meteor.users.findOne\r\n\t\t_id: userId,\r\n\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\r\n\tif not user\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\treturn user\r\n\r\nuuflowManager.getSpace = (space_id) ->\r\n\tspace = Creator.Collections.spaces.findOne(space_id)\r\n\tif not space\r\n\t\tthrow new Meteor.Error('error!', \"space_id有误或此space已经被删除\")\r\n\treturn space\r\n\r\nuuflowManager.getFlow = (flow_id) ->\r\n\tflow = Creator.Collections.flows.findOne(flow_id)\r\n\tif not flow\r\n\t\tthrow new Meteor.Error('error!', \"id有误或此流程已经被删除\")\r\n\treturn flow\r\n\r\nuuflowManager.getSpaceUser = (space_id, user_id) ->\r\n\tspace_user = Creator.Collections.space_users.findOne({ space: space_id, user: user_id })\r\n\tif not space_user\r\n\t\tthrow new Meteor.Error('error!', \"user_id对应的用户不属于当前space\")\r\n\treturn space_user\r\n\r\nuuflowManager.getSpaceUserOrgInfo = (space_user) ->\r\n\tinfo = new Object\r\n\tinfo.organization = space_user.organization\r\n\torg = Creator.Collections.organizations.findOne(space_user.organization, { fields: { name: 1 , fullname: 1 } })\r\n\tinfo.organization_name = org.name\r\n\tinfo.organization_fullname = org.fullname\r\n\treturn info\r\n\r\nuuflowManager.isFlowEnabled = (flow) ->\r\n\tif flow.state isnt \"enabled\"\r\n\t\tthrow new Meteor.Error('error!', \"流程未启用,操作失败\")\r\n\r\nuuflowManager.isFlowSpaceMatched = (flow, space_id) ->\r\n\tif flow.space isnt space_id\r\n\t\tthrow new Meteor.Error('error!', \"流程和工作区ID不匹配\")\r\n\r\nuuflowManager.getForm = (form_id) ->\r\n\tform = Creator.Collections.forms.findOne(form_id)\r\n\tif not form\r\n\t\tthrow new Meteor.Error('error!', '表单ID有误或此表单已经被删除')\r\n\r\n\treturn form\r\n\r\nuuflowManager.getCategory = (category_id) ->\r\n\treturn Creator.Collections.categories.findOne(category_id)\r\n\r\nuuflowManager.create_instance = (instance_from_client, user_info) ->\r\n\tcheck instance_from_client[\"applicant\"], String\r\n\tcheck instance_from_client[\"space\"], String\r\n\tcheck instance_from_client[\"flow\"], String\r\n\tcheck instance_from_client[\"record_ids\"], [{o: String, ids: [String]}]\r\n\r\n\t# 校验是否record已经发起的申请还在审批中\r\n\tuuflowManager.checkIsInApproval(instance_from_client[\"record_ids\"][0], instance_from_client[\"space\"])\r\n\r\n\tspace_id = instance_from_client[\"space\"]\r\n\tflow_id = instance_from_client[\"flow\"]\r\n\tuser_id = user_info._id\r\n\t# 获取前台所传的trace\r\n\ttrace_from_client = null\r\n\t# 获取前台所传的approve\r\n\tapprove_from_client = null\r\n\tif instance_from_client[\"traces\"] and instance_from_client[\"traces\"][0]\r\n\t\ttrace_from_client = instance_from_client[\"traces\"][0]\r\n\t\tif trace_from_client[\"approves\"] and trace_from_client[\"approves\"][0]\r\n\t\t\tapprove_from_client = instance_from_client[\"traces\"][0][\"approves\"][0]\r\n\r\n\t# 获取一个space\r\n\tspace = uuflowManager.getSpace(space_id)\r\n\t# 获取一个flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\t# 获取一个space下的一个user\r\n\tspace_user = uuflowManager.getSpaceUser(space_id, user_id)\r\n\t# 获取space_user所在的部门信息\r\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t# 判断一个flow是否为启用状态\r\n\tuuflowManager.isFlowEnabled(flow)\r\n\t# 判断一个flow和space_id是否匹配\r\n\tuuflowManager.isFlowSpaceMatched(flow, space_id)\r\n\r\n\tform = uuflowManager.getForm(flow.form)\r\n\r\n\tpermissions = permissionManager.getFlowPermissions(flow_id, user_id)\r\n\r\n\tif not permissions.includes(\"add\")\r\n\t\tthrow new Meteor.Error('error!', \"当前用户没有此流程的新建权限\")\r\n\r\n\tnow = new Date\r\n\tins_obj = {}\r\n\tins_obj._id = Creator.Collections.instances._makeNewID()\r\n\tins_obj.space = space_id\r\n\tins_obj.flow = flow_id\r\n\tins_obj.flow_version = flow.current._id\r\n\tins_obj.form = flow.form\r\n\tins_obj.form_version = flow.current.form_version\r\n\tins_obj.name = flow.name\r\n\tins_obj.submitter = user_id\r\n\tins_obj.submitter_name = user_info.name\r\n\tins_obj.applicant = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tins_obj.applicant_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tins_obj.applicant_organization = if instance_from_client[\"applicant_organization\"] then instance_from_client[\"applicant_organization\"] else space_user.organization\r\n\tins_obj.applicant_organization_name = if instance_from_client[\"applicant_organization_name\"] then instance_from_client[\"applicant_organization_name\"] else space_user_org_info.organization_name\r\n\tins_obj.applicant_organization_fullname = if instance_from_client[\"applicant_organization_fullname\"] then instance_from_client[\"applicant_organization_fullname\"] else  space_user_org_info.organization_fullname\r\n\tins_obj.applicant_company = if instance_from_client[\"applicant_company\"] then instance_from_client[\"applicant_company\"] else space_user.company_id\r\n\tins_obj.state = 'draft'\r\n\tins_obj.code = ''\r\n\tins_obj.is_archived = false\r\n\tins_obj.is_deleted = false\r\n\tins_obj.created = now\r\n\tins_obj.created_by = user_id\r\n\tins_obj.modified = now\r\n\tins_obj.modified_by = user_id\r\n\tins_obj.values = new Object\r\n\r\n\tins_obj.record_ids = instance_from_client[\"record_ids\"]\r\n\r\n\tif space_user.company_id\r\n\t\tins_obj.company_id = space_user.company_id\r\n\r\n\t# 新建Trace\r\n\ttrace_obj = {}\r\n\ttrace_obj._id = new Mongo.ObjectID()._str\r\n\ttrace_obj.instance = ins_obj._id\r\n\ttrace_obj.is_finished = false\r\n\t# 当前最新版flow中开始节点\r\n\tstart_step = _.find(flow.current.steps, (step) ->\r\n\t\treturn step.step_type is 'start'\r\n\t)\r\n\ttrace_obj.step = start_step._id\r\n\ttrace_obj.name = start_step.name\r\n\r\n\ttrace_obj.start_date = now\r\n\t# 新建Approve\r\n\tappr_obj = {}\r\n\tappr_obj._id = new Mongo.ObjectID()._str\r\n\tappr_obj.instance = ins_obj._id\r\n\tappr_obj.trace = trace_obj._id\r\n\tappr_obj.is_finished = false\r\n\tappr_obj.user = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tappr_obj.user_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tappr_obj.handler = user_id\r\n\tappr_obj.handler_name = user_info.name\r\n\tappr_obj.handler_organization = space_user.organization\r\n\tappr_obj.handler_organization_name = space_user_org_info.name\r\n\tappr_obj.handler_organization_fullname = space_user_org_info.fullname\r\n\tappr_obj.type = 'draft'\r\n\tappr_obj.start_date = now\r\n\tappr_obj.read_date = now\r\n\tappr_obj.is_read = true\r\n\tappr_obj.is_error = false\r\n\tappr_obj.description = ''\r\n\tappr_obj.values = uuflowManager.initiateValues(ins_obj.record_ids[0], flow_id, space_id, form.current.fields)\r\n\r\n\ttrace_obj.approves = [appr_obj]\r\n\tins_obj.traces = [trace_obj]\r\n\r\n\tins_obj.inbox_users = instance_from_client.inbox_users || []\r\n\r\n\tins_obj.current_step_name = start_step.name\r\n\r\n\tif flow.auto_remind is true\r\n\t\tins_obj.auto_remind = true\r\n\r\n\t# 新建申请单时，instances记录流程名称、流程分类名称 #1313\r\n\tins_obj.flow_name = flow.name\r\n\tif form.category\r\n\t\tcategory = uuflowManager.getCategory(form.category)\r\n\t\tif category\r\n\t\t\tins_obj.category_name = category.name\r\n\t\t\tins_obj.category = category._id\r\n\r\n\tnew_ins_id = Creator.Collections.instances.insert(ins_obj)\r\n\r\n\tuuflowManager.initiateAttach(ins_obj.record_ids[0], space_id, ins_obj._id, appr_obj._id)\r\n\r\n\tuuflowManager.initiateRecordInstanceInfo(ins_obj.record_ids[0], new_ins_id, space_id)\r\n\r\n\treturn new_ins_id\r\n\r\nuuflowManager.initiateValues = (recordIds, flowId, spaceId, fields) ->\r\n\tfieldCodes = []\r\n\t_.each fields, (f)->\r\n\t\tif f.type == 'section'\r\n\t\t\t_.each f.fields, (ff)->\r\n\t\t\t\tfieldCodes.push ff.code\r\n\t\telse\r\n\t\t\tfieldCodes.push f.code\r\n\r\n\tvalues = {}\r\n\tow = Creator.Collections.object_workflows.findOne({\r\n\t\tobject_name: recordIds.o,\r\n\t\tflow_id: flowId\r\n\t})\r\n\trecord = Creator.getCollection(recordIds.o, spaceId).findOne(recordIds.ids[0])\r\n\tif ow and record\r\n\t\ttableFieldCodes = []\r\n\t\ttableFieldMap = []\r\n\r\n\t\tow.field_map.forEach (fm) ->\r\n\t\t\t# 判断是否是子表字段\r\n\t\t\tif fm.workflow_field.indexOf('.$.') > 0 and fm.object_field.indexOf('.$.') > 0\r\n\t\t\t\twTableCode = fm.workflow_field.split('.$.')[0]\r\n\t\t\t\toTableCode = fm.object_field.split('.$.')[0]\r\n\t\t\t\tif record.hasOwnProperty(oTableCode) and _.isArray(record[oTableCode])\r\n\t\t\t\t\ttableFieldCodes.push(JSON.stringify({\r\n\t\t\t\t\t\tworkflow_table_field_code: wTableCode,\r\n\t\t\t\t\t\tobject_table_field_code: oTableCode\r\n\t\t\t\t\t}))\r\n\t\t\t\t\ttableFieldMap.push(fm)\r\n\r\n\t\t\t# 处理lookup类型字段\r\n\t\t\telse if fm.object_field.indexOf('.') > 0 and fm.object_field.indexOf('.$.') == -1\r\n\t\t\t\tobjectFieldName = fm.object_field.split('.')[0]\r\n\t\t\t\tlookupFieldName = fm.object_field.split('.')[1]\r\n\t\t\t\tobject = Creator.getObject(recordIds.o, spaceId)\r\n\t\t\t\tif object\r\n\t\t\t\t\tobjectField = object.fields[objectFieldName]\r\n\t\t\t\t\tif objectField && (objectField.type == \"lookup\" || objectField.type == \"master_detail\") && !objectField.multiple\r\n\t\t\t\t\t\tfieldsObj = {}\r\n\t\t\t\t\t\tfieldsObj[lookupFieldName] = 1\r\n\t\t\t\t\t\tlookupObject = Creator.getCollection(objectField.reference_to, spaceId).findOne(record[objectFieldName], { fields: fieldsObj })\r\n\t\t\t\t\t\tif lookupObject\r\n\t\t\t\t\t\t\tvalues[fm.workflow_field] = lookupObject[lookupFieldName]\r\n\r\n\t\t\telse if record.hasOwnProperty(fm.object_field)\r\n\t\t\t\tvalues[fm.workflow_field] = record[fm.object_field]\r\n\r\n\t\t_.uniq(tableFieldCodes).forEach (tfc) ->\r\n\t\t\tc = JSON.parse(tfc)\r\n\t\t\tvalues[c.workflow_table_field_code] = []\r\n\t\t\trecord[c.object_table_field_code].forEach (tr) ->\r\n\t\t\t\tnewTr = {}\r\n\t\t\t\t_.each tr, (v, k) ->\r\n\t\t\t\t\ttableFieldMap.forEach (tfm) ->\r\n\t\t\t\t\t\tif tfm.object_field is (c.object_table_field_code + '.$.' + k)\r\n\t\t\t\t\t\t\twTdCode = tfm.workflow_field.split('.$.')[1]\r\n\t\t\t\t\t\t\tnewTr[wTdCode] = v\r\n\t\t\t\tif not _.isEmpty(newTr)\r\n\t\t\t\t\tvalues[c.workflow_table_field_code].push(newTr)\r\n\r\n\t\t# 如果配置了脚本则执行脚本\r\n\t\tif ow.field_map_script\r\n\t\t\t_.extend(values, uuflowManager.evalFieldMapScript(ow.field_map_script, recordIds.o, spaceId, recordIds.ids[0]))\r\n\r\n\t# 过滤掉values中的非法key\r\n\tfilterValues = {}\r\n\t_.each _.keys(values), (k)->\r\n\t\tif fieldCodes.includes(k)\r\n\t\t\tfilterValues[k] = values[k]\r\n\r\n\treturn filterValues\r\n\r\nuuflowManager.evalFieldMapScript = (field_map_script, objectName, spaceId, objectId)->\r\n\trecord = Creator.getCollection(objectName, spaceId).findOne(objectId)\r\n\tscript = \"module.exports = function (record) { \" + field_map_script + \" }\"\r\n\tfunc = _eval(script, \"field_map_script\")\r\n\tvalues = func(record)\r\n\tif _.isObject values\r\n\t\treturn values\r\n\telse\r\n\t\tconsole.error \"evalFieldMapScript: 脚本返回值类型不是对象\"\r\n\treturn {}\r\n\r\n\r\n\r\nuuflowManager.initiateAttach = (recordIds, spaceId, insId, approveId) ->\r\n\r\n\tCreator.Collections['cms_files'].find({\r\n\t\tspace: spaceId,\r\n\t\tparent: recordIds\r\n\t}).forEach (cf) ->\r\n\t\t_.each cf.versions, (versionId, idx) ->\r\n\t\t\tf = Creator.Collections['cfs.files.filerecord'].findOne(versionId)\r\n\t\t\tnewFile = new FS.File()\r\n\r\n\t\t\tnewFile.attachData f.createReadStream('files'), {\r\n\t\t\t\t\ttype: f.original.type\r\n\t\t\t}, (err) ->\r\n\t\t\t\tif (err)\r\n\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason)\r\n\r\n\t\t\t\tnewFile.name(f.name())\r\n\t\t\t\tnewFile.size(f.size())\r\n\t\t\t\tmetadata = {\r\n\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\towner_name: f.metadata.owner_name,\r\n\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\tinstance: insId,\r\n\t\t\t\t\tapprove: approveId\r\n\t\t\t\t\tparent: cf._id\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif idx is 0\r\n\t\t\t\t\tmetadata.current = true\r\n\r\n\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\tcfs.instances.insert(newFile)\r\n\r\n\treturn\r\n\r\nuuflowManager.initiateRecordInstanceInfo = (recordIds, insId, spaceId) ->\r\n\tCreator.getCollection(recordIds.o, spaceId).update(recordIds.ids[0], {\r\n\t\t$push: {\r\n\t\t\tinstances: {\r\n\t\t\t\t$each: [{\r\n\t\t\t\t\t_id: insId,\r\n\t\t\t\t\tstate: 'draft'\r\n\t\t\t\t}],\r\n\t\t\t\t$position: 0\r\n\t\t\t}\r\n\t\t},\r\n\t\t$set: {\r\n\t\t\tlocked: true\r\n\t\t\tinstance_state: 'draft'\r\n\t\t}\r\n\t})\r\n\r\n\treturn\r\n\r\nuuflowManager.checkIsInApproval = (recordIds, spaceId) ->\r\n\trecord = Creator.getCollection(recordIds.o, spaceId).findOne({\r\n\t\t_id: recordIds.ids[0], instances: { $exists: true }\r\n\t}, { fields: { instances: 1 } })\r\n\r\n\tif record and record.instances[0].state isnt 'completed' and Creator.Collections.instances.find(record.instances[0]._id).count() > 0\r\n\t\tthrow new Meteor.Error('error!', \"此记录已发起流程正在审批中，待审批结束方可发起下一次审批！\")\r\n\r\n\treturn\r\n\r\n","var _eval;               \n\n_eval = require('eval');\n\nuuflowManager = {};\n\nuuflowManager.check_authorization = function(req) {\n  var authToken, hashedToken, query, user, userId;\n  query = req.query;\n  userId = query[\"X-User-Id\"];\n  authToken = query[\"X-Auth-Token\"];\n  if (!userId || !authToken) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  hashedToken = Accounts._hashLoginToken(authToken);\n  user = Meteor.users.findOne({\n    _id: userId,\n    \"services.resume.loginTokens.hashedToken\": hashedToken\n  });\n  if (!user) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  return user;\n};\n\nuuflowManager.getSpace = function(space_id) {\n  var space;\n  space = Creator.Collections.spaces.findOne(space_id);\n  if (!space) {\n    throw new Meteor.Error('error!', \"space_id有误或此space已经被删除\");\n  }\n  return space;\n};\n\nuuflowManager.getFlow = function(flow_id) {\n  var flow;\n  flow = Creator.Collections.flows.findOne(flow_id);\n  if (!flow) {\n    throw new Meteor.Error('error!', \"id有误或此流程已经被删除\");\n  }\n  return flow;\n};\n\nuuflowManager.getSpaceUser = function(space_id, user_id) {\n  var space_user;\n  space_user = Creator.Collections.space_users.findOne({\n    space: space_id,\n    user: user_id\n  });\n  if (!space_user) {\n    throw new Meteor.Error('error!', \"user_id对应的用户不属于当前space\");\n  }\n  return space_user;\n};\n\nuuflowManager.getSpaceUserOrgInfo = function(space_user) {\n  var info, org;\n  info = new Object;\n  info.organization = space_user.organization;\n  org = Creator.Collections.organizations.findOne(space_user.organization, {\n    fields: {\n      name: 1,\n      fullname: 1\n    }\n  });\n  info.organization_name = org.name;\n  info.organization_fullname = org.fullname;\n  return info;\n};\n\nuuflowManager.isFlowEnabled = function(flow) {\n  if (flow.state !== \"enabled\") {\n    throw new Meteor.Error('error!', \"流程未启用,操作失败\");\n  }\n};\n\nuuflowManager.isFlowSpaceMatched = function(flow, space_id) {\n  if (flow.space !== space_id) {\n    throw new Meteor.Error('error!', \"流程和工作区ID不匹配\");\n  }\n};\n\nuuflowManager.getForm = function(form_id) {\n  var form;\n  form = Creator.Collections.forms.findOne(form_id);\n  if (!form) {\n    throw new Meteor.Error('error!', '表单ID有误或此表单已经被删除');\n  }\n  return form;\n};\n\nuuflowManager.getCategory = function(category_id) {\n  return Creator.Collections.categories.findOne(category_id);\n};\n\nuuflowManager.create_instance = function(instance_from_client, user_info) {\n  var appr_obj, approve_from_client, category, flow, flow_id, form, ins_obj, new_ins_id, now, permissions, space, space_id, space_user, space_user_org_info, start_step, trace_from_client, trace_obj, user_id;\n  check(instance_from_client[\"applicant\"], String);\n  check(instance_from_client[\"space\"], String);\n  check(instance_from_client[\"flow\"], String);\n  check(instance_from_client[\"record_ids\"], [\n    {\n      o: String,\n      ids: [String]\n    }\n  ]);\n  uuflowManager.checkIsInApproval(instance_from_client[\"record_ids\"][0], instance_from_client[\"space\"]);\n  space_id = instance_from_client[\"space\"];\n  flow_id = instance_from_client[\"flow\"];\n  user_id = user_info._id;\n  trace_from_client = null;\n  approve_from_client = null;\n  if (instance_from_client[\"traces\"] && instance_from_client[\"traces\"][0]) {\n    trace_from_client = instance_from_client[\"traces\"][0];\n    if (trace_from_client[\"approves\"] && trace_from_client[\"approves\"][0]) {\n      approve_from_client = instance_from_client[\"traces\"][0][\"approves\"][0];\n    }\n  }\n  space = uuflowManager.getSpace(space_id);\n  flow = uuflowManager.getFlow(flow_id);\n  space_user = uuflowManager.getSpaceUser(space_id, user_id);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  uuflowManager.isFlowEnabled(flow);\n  uuflowManager.isFlowSpaceMatched(flow, space_id);\n  form = uuflowManager.getForm(flow.form);\n  permissions = permissionManager.getFlowPermissions(flow_id, user_id);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"当前用户没有此流程的新建权限\");\n  }\n  now = new Date;\n  ins_obj = {};\n  ins_obj._id = Creator.Collections.instances._makeNewID();\n  ins_obj.space = space_id;\n  ins_obj.flow = flow_id;\n  ins_obj.flow_version = flow.current._id;\n  ins_obj.form = flow.form;\n  ins_obj.form_version = flow.current.form_version;\n  ins_obj.name = flow.name;\n  ins_obj.submitter = user_id;\n  ins_obj.submitter_name = user_info.name;\n  ins_obj.applicant = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  ins_obj.applicant_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  ins_obj.applicant_organization = instance_from_client[\"applicant_organization\"] ? instance_from_client[\"applicant_organization\"] : space_user.organization;\n  ins_obj.applicant_organization_name = instance_from_client[\"applicant_organization_name\"] ? instance_from_client[\"applicant_organization_name\"] : space_user_org_info.organization_name;\n  ins_obj.applicant_organization_fullname = instance_from_client[\"applicant_organization_fullname\"] ? instance_from_client[\"applicant_organization_fullname\"] : space_user_org_info.organization_fullname;\n  ins_obj.applicant_company = instance_from_client[\"applicant_company\"] ? instance_from_client[\"applicant_company\"] : space_user.company_id;\n  ins_obj.state = 'draft';\n  ins_obj.code = '';\n  ins_obj.is_archived = false;\n  ins_obj.is_deleted = false;\n  ins_obj.created = now;\n  ins_obj.created_by = user_id;\n  ins_obj.modified = now;\n  ins_obj.modified_by = user_id;\n  ins_obj.values = new Object;\n  ins_obj.record_ids = instance_from_client[\"record_ids\"];\n  if (space_user.company_id) {\n    ins_obj.company_id = space_user.company_id;\n  }\n  trace_obj = {};\n  trace_obj._id = new Mongo.ObjectID()._str;\n  trace_obj.instance = ins_obj._id;\n  trace_obj.is_finished = false;\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  trace_obj.step = start_step._id;\n  trace_obj.name = start_step.name;\n  trace_obj.start_date = now;\n  appr_obj = {};\n  appr_obj._id = new Mongo.ObjectID()._str;\n  appr_obj.instance = ins_obj._id;\n  appr_obj.trace = trace_obj._id;\n  appr_obj.is_finished = false;\n  appr_obj.user = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  appr_obj.user_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  appr_obj.handler = user_id;\n  appr_obj.handler_name = user_info.name;\n  appr_obj.handler_organization = space_user.organization;\n  appr_obj.handler_organization_name = space_user_org_info.name;\n  appr_obj.handler_organization_fullname = space_user_org_info.fullname;\n  appr_obj.type = 'draft';\n  appr_obj.start_date = now;\n  appr_obj.read_date = now;\n  appr_obj.is_read = true;\n  appr_obj.is_error = false;\n  appr_obj.description = '';\n  appr_obj.values = uuflowManager.initiateValues(ins_obj.record_ids[0], flow_id, space_id, form.current.fields);\n  trace_obj.approves = [appr_obj];\n  ins_obj.traces = [trace_obj];\n  ins_obj.inbox_users = instance_from_client.inbox_users || [];\n  ins_obj.current_step_name = start_step.name;\n  if (flow.auto_remind === true) {\n    ins_obj.auto_remind = true;\n  }\n  ins_obj.flow_name = flow.name;\n  if (form.category) {\n    category = uuflowManager.getCategory(form.category);\n    if (category) {\n      ins_obj.category_name = category.name;\n      ins_obj.category = category._id;\n    }\n  }\n  new_ins_id = Creator.Collections.instances.insert(ins_obj);\n  uuflowManager.initiateAttach(ins_obj.record_ids[0], space_id, ins_obj._id, appr_obj._id);\n  uuflowManager.initiateRecordInstanceInfo(ins_obj.record_ids[0], new_ins_id, space_id);\n  return new_ins_id;\n};\n\nuuflowManager.initiateValues = function(recordIds, flowId, spaceId, fields) {\n  var fieldCodes, filterValues, ow, record, tableFieldCodes, tableFieldMap, values;\n  fieldCodes = [];\n  _.each(fields, function(f) {\n    if (f.type === 'section') {\n      return _.each(f.fields, function(ff) {\n        return fieldCodes.push(ff.code);\n      });\n    } else {\n      return fieldCodes.push(f.code);\n    }\n  });\n  values = {};\n  ow = Creator.Collections.object_workflows.findOne({\n    object_name: recordIds.o,\n    flow_id: flowId\n  });\n  record = Creator.getCollection(recordIds.o, spaceId).findOne(recordIds.ids[0]);\n  if (ow && record) {\n    tableFieldCodes = [];\n    tableFieldMap = [];\n    ow.field_map.forEach(function(fm) {\n      var fieldsObj, lookupFieldName, lookupObject, oTableCode, object, objectField, objectFieldName, wTableCode;\n      if (fm.workflow_field.indexOf('.$.') > 0 && fm.object_field.indexOf('.$.') > 0) {\n        wTableCode = fm.workflow_field.split('.$.')[0];\n        oTableCode = fm.object_field.split('.$.')[0];\n        if (record.hasOwnProperty(oTableCode) && _.isArray(record[oTableCode])) {\n          tableFieldCodes.push(JSON.stringify({\n            workflow_table_field_code: wTableCode,\n            object_table_field_code: oTableCode\n          }));\n          return tableFieldMap.push(fm);\n        }\n      } else if (fm.object_field.indexOf('.') > 0 && fm.object_field.indexOf('.$.') === -1) {\n        objectFieldName = fm.object_field.split('.')[0];\n        lookupFieldName = fm.object_field.split('.')[1];\n        object = Creator.getObject(recordIds.o, spaceId);\n        if (object) {\n          objectField = object.fields[objectFieldName];\n          if (objectField && (objectField.type === \"lookup\" || objectField.type === \"master_detail\") && !objectField.multiple) {\n            fieldsObj = {};\n            fieldsObj[lookupFieldName] = 1;\n            lookupObject = Creator.getCollection(objectField.reference_to, spaceId).findOne(record[objectFieldName], {\n              fields: fieldsObj\n            });\n            if (lookupObject) {\n              return values[fm.workflow_field] = lookupObject[lookupFieldName];\n            }\n          }\n        }\n      } else if (record.hasOwnProperty(fm.object_field)) {\n        return values[fm.workflow_field] = record[fm.object_field];\n      }\n    });\n    _.uniq(tableFieldCodes).forEach(function(tfc) {\n      var c;\n      c = JSON.parse(tfc);\n      values[c.workflow_table_field_code] = [];\n      return record[c.object_table_field_code].forEach(function(tr) {\n        var newTr;\n        newTr = {};\n        _.each(tr, function(v, k) {\n          return tableFieldMap.forEach(function(tfm) {\n            var wTdCode;\n            if (tfm.object_field === (c.object_table_field_code + '.$.' + k)) {\n              wTdCode = tfm.workflow_field.split('.$.')[1];\n              return newTr[wTdCode] = v;\n            }\n          });\n        });\n        if (!_.isEmpty(newTr)) {\n          return values[c.workflow_table_field_code].push(newTr);\n        }\n      });\n    });\n    if (ow.field_map_script) {\n      _.extend(values, uuflowManager.evalFieldMapScript(ow.field_map_script, recordIds.o, spaceId, recordIds.ids[0]));\n    }\n  }\n  filterValues = {};\n  _.each(_.keys(values), function(k) {\n    if (fieldCodes.includes(k)) {\n      return filterValues[k] = values[k];\n    }\n  });\n  return filterValues;\n};\n\nuuflowManager.evalFieldMapScript = function(field_map_script, objectName, spaceId, objectId) {\n  var func, record, script, values;\n  record = Creator.getCollection(objectName, spaceId).findOne(objectId);\n  script = \"module.exports = function (record) { \" + field_map_script + \" }\";\n  func = _eval(script, \"field_map_script\");\n  values = func(record);\n  if (_.isObject(values)) {\n    return values;\n  } else {\n    console.error(\"evalFieldMapScript: 脚本返回值类型不是对象\");\n  }\n  return {};\n};\n\nuuflowManager.initiateAttach = function(recordIds, spaceId, insId, approveId) {\n  Creator.Collections['cms_files'].find({\n    space: spaceId,\n    parent: recordIds\n  }).forEach(function(cf) {\n    return _.each(cf.versions, function(versionId, idx) {\n      var f, newFile;\n      f = Creator.Collections['cfs.files.filerecord'].findOne(versionId);\n      newFile = new FS.File();\n      return newFile.attachData(f.createReadStream('files'), {\n        type: f.original.type\n      }, function(err) {\n        var metadata;\n        if (err) {\n          throw new Meteor.Error(err.error, err.reason);\n        }\n        newFile.name(f.name());\n        newFile.size(f.size());\n        metadata = {\n          owner: f.metadata.owner,\n          owner_name: f.metadata.owner_name,\n          space: spaceId,\n          instance: insId,\n          approve: approveId,\n          parent: cf._id\n        };\n        if (idx === 0) {\n          metadata.current = true;\n        }\n        newFile.metadata = metadata;\n        return cfs.instances.insert(newFile);\n      });\n    });\n  });\n};\n\nuuflowManager.initiateRecordInstanceInfo = function(recordIds, insId, spaceId) {\n  Creator.getCollection(recordIds.o, spaceId).update(recordIds.ids[0], {\n    $push: {\n      instances: {\n        $each: [\n          {\n            _id: insId,\n            state: 'draft'\n          }\n        ],\n        $position: 0\n      }\n    },\n    $set: {\n      locked: true,\n      instance_state: 'draft'\n    }\n  });\n};\n\nuuflowManager.checkIsInApproval = function(recordIds, spaceId) {\n  var record;\n  record = Creator.getCollection(recordIds.o, spaceId).findOne({\n    _id: recordIds.ids[0],\n    instances: {\n      $exists: true\n    }\n  }, {\n    fields: {\n      instances: 1\n    }\n  });\n  if (record && record.instances[0].state !== 'completed' && Creator.Collections.instances.find(record.instances[0]._id).count() > 0) {\n    throw new Meteor.Error('error!', \"此记录已发起流程正在审批中，待审批结束方可发起下一次审批！\");\n  }\n};\n","Busboy = require('busboy');\r\nFiber = require('fibers');\r\n\r\nJsonRoutes.parseFiles = (req, res, next) ->\r\n\t\tfiles = []; # Store files in an array and then pass them to request.\r\n\t\timage = {}; # crate an image object\r\n\r\n\t\tif (req.method == \"POST\")\r\n\t\t\tbusboy = new Busboy({ headers: req.headers });\r\n\t\t\tbusboy.on \"file\",  (fieldname, file, filename, encoding, mimetype) ->\r\n\t\t\t\timage.mimeType = mimetype;\r\n\t\t\t\timage.encoding = encoding;\r\n\t\t\t\timage.filename = filename;\r\n\r\n\t\t\t\t# buffer the read chunks\r\n\t\t\t\tbuffers = [];\r\n\r\n\t\t\t\tfile.on 'data', (data) ->\r\n\t\t\t\t\tbuffers.push(data);\r\n\r\n\t\t\t\tfile.on 'end', () ->\r\n\t\t\t\t\t# concat the chunks\r\n\t\t\t\t\timage.data = Buffer.concat(buffers);\r\n\t\t\t\t\t# push the image object to the file array\r\n\t\t\t\t\tfiles.push(image);\r\n\r\n\r\n\t\t\tbusboy.on \"field\", (fieldname, value) ->\r\n\t\t\t\treq.body[fieldname] = value;\r\n\r\n\t\t\tbusboy.on \"finish\",  () ->\r\n\t\t\t\t# Pass the file array together with the request\r\n\t\t\t\treq.files = files;\r\n\r\n\t\t\t\tFiber ()->\r\n\t\t\t\t\tnext();\r\n\t\t\t\t.run();\r\n\r\n\t\t\t# Pass request to busboy\r\n\t\t\treq.pipe(busboy);\r\n\r\n\t\telse\r\n\t\t\tnext();\r\n\r\nJsonRoutes.add \"post\", \"/s3/\",  (req, res, next) ->\r\n\r\n\tJsonRoutes.parseFiles req, res, ()->\r\n\t\tcollection = cfs.files\r\n\t\tfileCollection = Creator.getObject(\"cms_files\").db\r\n\r\n\t\tif req.files and req.files[0]\r\n\r\n\t\t\tnewFile = new FS.File();\r\n\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}, (err) ->\r\n\t\t\t\tfilename = req.files[0].filename\r\n\t\t\t\textention = filename.split('.').pop()\r\n\t\t\t\tif [\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())\r\n\t\t\t\t\tfilename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + extention\r\n\r\n\t\t\t\tbody = req.body\r\n\t\t\t\ttry\r\n\t\t\t\t\tif body && (body['upload_from'] is \"IE\" or body['upload_from'] is \"node\")\r\n\t\t\t\t\t\tfilename = decodeURIComponent(filename)\r\n\t\t\t\tcatch e\r\n\t\t\t\t\tconsole.error(filename)\r\n\t\t\t\t\tconsole.error e\r\n\t\t\t\t\tfilename = filename.replace(/%/g, \"-\")\r\n\r\n\t\t\t\tnewFile.name(filename)\r\n\r\n\t\t\t\tif body && body['owner'] && body['space'] && body['record_id']  && body['object_name']\r\n\t\t\t\t\tparent = body['parent']\r\n\t\t\t\t\towner = body['owner']\r\n\t\t\t\t\towner_name = body['owner_name']\r\n\t\t\t\t\tspace = body['space']\r\n\t\t\t\t\trecord_id = body['record_id']\r\n\t\t\t\t\tobject_name = body['object_name']\r\n\t\t\t\t\tparent = body['parent']\r\n\t\t\t\t\tmetadata = {owner:owner, owner_name:owner_name, space:space, record_id:record_id, object_name: object_name}\r\n\t\t\t\t\tif parent\r\n\t\t\t\t\t\tmetadata.parent = parent\r\n\t\t\t\t\tnewFile.metadata = metadata\r\n\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\t\t\t\telse\r\n\t\t\t\t\tfileObj = collection.insert newFile\r\n\r\n\r\n\t\t\t\tsize = fileObj.original.size\r\n\t\t\t\tif !size\r\n\t\t\t\t\tsize = 1024\r\n\t\t\t\tif parent\r\n\t\t\t\t\tfileCollection.update({_id:parent},{\r\n\t\t\t\t\t\t$set:\r\n\t\t\t\t\t\t\textention: extention\r\n\t\t\t\t\t\t\tsize: size\r\n\t\t\t\t\t\t\tmodified: (new Date())\r\n\t\t\t\t\t\t\tmodified_by: owner\r\n\t\t\t\t\t\t$push:\r\n\t\t\t\t\t\t\tversions:\r\n\t\t\t\t\t\t\t\t$each: [ fileObj._id ]\r\n\t\t\t\t\t\t\t\t$position: 0\r\n\t\t\t\t\t})\r\n\t\t\t\telse\r\n\t\t\t\t\tnewFileObjId = fileCollection.direct.insert {\r\n\t\t\t\t\t\tname: filename\r\n\t\t\t\t\t\tdescription: ''\r\n\t\t\t\t\t\textention: extention\r\n\t\t\t\t\t\tsize: size\r\n\t\t\t\t\t\tversions: [fileObj._id]\r\n\t\t\t\t\t\tparent: {o:object_name,ids:[record_id]}\r\n\t\t\t\t\t\towner: owner\r\n\t\t\t\t\t\tspace: space\r\n\t\t\t\t\t\tcreated: (new Date())\r\n\t\t\t\t\t\tcreated_by: owner\r\n\t\t\t\t\t\tmodified: (new Date())\r\n\t\t\t\t\t\tmodified_by: owner\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfileObj.update({$set: {'metadata.parent' : newFileObjId}})\r\n\r\n\t\t\t\tresp =\r\n\t\t\t\t\tversion_id: fileObj._id,\r\n\t\t\t\t\tsize: size\r\n\r\n\t\t\t\tres.setHeader(\"x-amz-version-id\",fileObj._id);\r\n\t\t\t\tres.end(JSON.stringify(resp));\r\n\t\t\t\treturn\r\n\t\telse\r\n\t\t\tres.statusCode = 500;\r\n\t\t\tres.end();\r\n\r\nJsonRoutes.add \"post\", \"/s3/:collection\",  (req, res, next) ->\r\n\ttry\r\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res)\r\n\t\tif !userId\r\n\t\t\tthrow new Meteor.Error(500, \"No permission\")\r\n\r\n\t\tcollectionName = req.params.collection\r\n\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\tcollection = cfs[collectionName]\r\n\r\n\t\t\tif not collection\r\n\t\t\t\tthrow new Meteor.Error(500, \"No Collection\")\r\n\r\n\t\t\tif req.files and req.files[0]\r\n\r\n\t\t\t\tnewFile = new FS.File()\r\n\t\t\t\tnewFile.name(req.files[0].filename)\r\n\r\n\t\t\t\tif req.body\r\n\t\t\t\t\tnewFile.metadata = req.body\r\n\r\n\t\t\t\tnewFile.owner = userId\r\n\t\t\t\tnewFile.metadata.owner = userId\r\n\r\n\t\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}\r\n\r\n\t\t\t\tcollection.insert newFile\r\n\r\n\t\t\t\tresultData = collection.files.findOne(newFile._id)\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 200\r\n\t\t\t\t\tdata: resultData\r\n\t\t\t\treturn\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error(500, \"No File\")\r\n\r\n\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: e.error || 500\r\n\t\t\tdata: {errors: e.reason || e.message}\r\n\t\t}\r\n\r\n\r\n\r\ngetQueryString = (accessKeyId, secretAccessKey, query, method) ->\r\n\tconsole.log \"----uuflowManager.getQueryString----\"\r\n\tALY = require('aliyun-sdk')\r\n\tdate = ALY.util.date.getDate()\r\n\r\n\tquery.Format = \"json\"\r\n\tquery.Version = \"2017-03-21\"\r\n\tquery.AccessKeyId = accessKeyId\r\n\tquery.SignatureMethod = \"HMAC-SHA1\"\r\n\tquery.Timestamp = ALY.util.date.iso8601(date)\r\n\tquery.SignatureVersion = \"1.0\"\r\n\tquery.SignatureNonce = String(date.getTime())\r\n\r\n\tqueryKeys = Object.keys(query)\r\n\tqueryKeys.sort()\r\n\r\n\tcanonicalizedQueryString = \"\"\r\n\tqueryKeys.forEach (name) ->\r\n\t\tcanonicalizedQueryString += \"&\" + name + \"=\" + ALY.util.popEscape(query[name])\r\n\r\n\tstringToSign = method.toUpperCase() + '&%2F&' + ALY.util.popEscape(canonicalizedQueryString.substr(1))\r\n\r\n\tquery.Signature = ALY.util.crypto.hmac(secretAccessKey + '&', stringToSign, 'base64', 'sha1')\r\n\r\n\tqueryStr = ALY.util.queryParamsToString(query)\r\n\tconsole.log queryStr\r\n\treturn queryStr\r\n\r\nJsonRoutes.add \"post\", \"/s3/vod/upload\",  (req, res, next) ->\r\n\ttry\r\n\t\tuserId = Steedos.getUserIdFromAuthToken(req, res)\r\n\t\tif !userId\r\n\t\t\tthrow new Meteor.Error(500, \"No permission\")\r\n\r\n\t\tcollectionName = \"videos\"\r\n\r\n\t\tALY = require('aliyun-sdk')\r\n\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\tcollection = cfs[collectionName]\r\n\r\n\t\t\tif not collection\r\n\t\t\t\tthrow new Meteor.Error(500, \"No Collection\")\r\n\r\n\t\t\tif req.files and req.files[0]\r\n\r\n\t\t\t\tif collectionName is 'videos' and Meteor.settings.public.cfs?.store is \"OSS\"\r\n\t\t\t\t\taccessKeyId = Meteor.settings.cfs.aliyun?.accessKeyId\r\n\t\t\t\t\tsecretAccessKey = Meteor.settings.cfs.aliyun?.secretAccessKey\r\n\r\n\t\t\t\t\tdate = ALY.util.date.getDate()\r\n\r\n\t\t\t\t\tquery = {\r\n\t\t\t\t\t\tAction: \"CreateUploadVideo\"\r\n\t\t\t\t\t\tTitle: req.files[0].filename\r\n\t\t\t\t\t\tFileName: req.files[0].filename\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\turl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, query, 'GET')\r\n\r\n\t\t\t\t\tr = HTTP.call 'GET', url\r\n\r\n\t\t\t\t\tconsole.log r\r\n\r\n\t\t\t\t\tif r.data?.VideoId\r\n\t\t\t\t\t\tvideoId = r.data.VideoId\r\n\t\t\t\t\t\tuploadAddress = JSON.parse(new Buffer(r.data.UploadAddress, 'base64').toString())\r\n\t\t\t\t\t\tconsole.log uploadAddress\r\n\t\t\t\t\t\tuploadAuth = JSON.parse(new Buffer(r.data.UploadAuth, 'base64').toString())\r\n\t\t\t\t\t\tconsole.log uploadAuth\r\n\r\n\t\t\t\t\t\toss = new ALY.OSS({\r\n\t\t\t\t\t\t\t\"accessKeyId\": uploadAuth.AccessKeyId,\r\n\t\t\t\t\t\t\t\"secretAccessKey\": uploadAuth.AccessKeySecret,\r\n\t\t\t\t\t\t\t\"endpoint\": uploadAddress.Endpoint,\r\n\t\t\t\t\t\t\t\"apiVersion\": '2013-10-15',\r\n\t\t\t\t\t\t\t\"securityToken\": uploadAuth.SecurityToken\r\n\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\toss.putObject {\r\n\t\t\t\t\t\t\tBucket: uploadAddress.Bucket,\r\n\t\t\t\t\t\t\tKey: uploadAddress.FileName,\r\n\t\t\t\t\t\t\tBody: req.files[0].data,\r\n\t\t\t\t\t\t\tAccessControlAllowOrigin: '',\r\n\t\t\t\t\t\t\tContentType: req.files[0].mimeType,\r\n\t\t\t\t\t\t\tCacheControl: 'no-cache',\r\n\t\t\t\t\t\t\tContentDisposition: '',\r\n\t\t\t\t\t\t\tContentEncoding: 'utf-8',\r\n\t\t\t\t\t\t\tServerSideEncryption: 'AES256',\r\n\t\t\t\t\t\t\tExpires: null\r\n\t\t\t\t\t\t}, Meteor.bindEnvironment (err, data) ->\r\n\r\n\t\t\t\t\t\t\tif err\r\n\t\t\t\t\t\t\t\tconsole.log('error:', err)\r\n\t\t\t\t\t\t\t\tthrow new Meteor.Error(500, err.message)\r\n\r\n\t\t\t\t\t\t\tconsole.log('success:', data)\r\n\r\n\t\t\t\t\t\t\tnewDate = ALY.util.date.getDate()\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoQuery = {\r\n\t\t\t\t\t\t\t\tAction: 'GetPlayInfo'\r\n\t\t\t\t\t\t\t\tVideoId: videoId\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoUrl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, getPlayInfoQuery, 'GET')\r\n\r\n\t\t\t\t\t\t\tgetPlayInfoResult = HTTP.call 'GET', getPlayInfoUrl\r\n\r\n\t\t\t\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\t\t\t\tcode: 200\r\n\t\t\t\t\t\t\t\tdata: getPlayInfoResult\r\n\r\n\t\t\telse\r\n\t\t\t\tthrow new Meteor.Error(500, \"No File\")\r\n\r\n\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: e.error || 500\r\n\t\t\tdata: {errors: e.reason || e.message}\r\n\t\t}","var Busboy, Fiber, getQueryString;\n\nBusboy = require('busboy');\n\nFiber = require('fibers');\n\nJsonRoutes.parseFiles = function(req, res, next) {\n  var busboy, files, image;\n  files = [];\n  image = {};\n  if (req.method === \"POST\") {\n    busboy = new Busboy({\n      headers: req.headers\n    });\n    busboy.on(\"file\", function(fieldname, file, filename, encoding, mimetype) {\n      var buffers;\n      image.mimeType = mimetype;\n      image.encoding = encoding;\n      image.filename = filename;\n      buffers = [];\n      file.on('data', function(data) {\n        return buffers.push(data);\n      });\n      return file.on('end', function() {\n        image.data = Buffer.concat(buffers);\n        return files.push(image);\n      });\n    });\n    busboy.on(\"field\", function(fieldname, value) {\n      return req.body[fieldname] = value;\n    });\n    busboy.on(\"finish\", function() {\n      req.files = files;\n      return Fiber(function() {\n        return next();\n      }).run();\n    });\n    return req.pipe(busboy);\n  } else {\n    return next();\n  }\n};\n\nJsonRoutes.add(\"post\", \"/s3/\", function(req, res, next) {\n  return JsonRoutes.parseFiles(req, res, function() {\n    var collection, fileCollection, newFile;\n    collection = cfs.files;\n    fileCollection = Creator.getObject(\"cms_files\").db;\n    if (req.files && req.files[0]) {\n      newFile = new FS.File();\n      return newFile.attachData(req.files[0].data, {\n        type: req.files[0].mimeType\n      }, function(err) {\n        var body, e, extention, fileObj, filename, metadata, newFileObjId, object_name, owner, owner_name, parent, record_id, resp, size, space;\n        filename = req.files[0].filename;\n        extention = filename.split('.').pop();\n        if ([\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())) {\n          filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + extention;\n        }\n        body = req.body;\n        try {\n          if (body && (body['upload_from'] === \"IE\" || body['upload_from'] === \"node\")) {\n            filename = decodeURIComponent(filename);\n          }\n        } catch (error) {\n          e = error;\n          console.error(filename);\n          console.error(e);\n          filename = filename.replace(/%/g, \"-\");\n        }\n        newFile.name(filename);\n        if (body && body['owner'] && body['space'] && body['record_id'] && body['object_name']) {\n          parent = body['parent'];\n          owner = body['owner'];\n          owner_name = body['owner_name'];\n          space = body['space'];\n          record_id = body['record_id'];\n          object_name = body['object_name'];\n          parent = body['parent'];\n          metadata = {\n            owner: owner,\n            owner_name: owner_name,\n            space: space,\n            record_id: record_id,\n            object_name: object_name\n          };\n          if (parent) {\n            metadata.parent = parent;\n          }\n          newFile.metadata = metadata;\n          fileObj = collection.insert(newFile);\n        } else {\n          fileObj = collection.insert(newFile);\n        }\n        size = fileObj.original.size;\n        if (!size) {\n          size = 1024;\n        }\n        if (parent) {\n          fileCollection.update({\n            _id: parent\n          }, {\n            $set: {\n              extention: extention,\n              size: size,\n              modified: new Date(),\n              modified_by: owner\n            },\n            $push: {\n              versions: {\n                $each: [fileObj._id],\n                $position: 0\n              }\n            }\n          });\n        } else {\n          newFileObjId = fileCollection.direct.insert({\n            name: filename,\n            description: '',\n            extention: extention,\n            size: size,\n            versions: [fileObj._id],\n            parent: {\n              o: object_name,\n              ids: [record_id]\n            },\n            owner: owner,\n            space: space,\n            created: new Date(),\n            created_by: owner,\n            modified: new Date(),\n            modified_by: owner\n          });\n          fileObj.update({\n            $set: {\n              'metadata.parent': newFileObjId\n            }\n          });\n        }\n        resp = {\n          version_id: fileObj._id,\n          size: size\n        };\n        res.setHeader(\"x-amz-version-id\", fileObj._id);\n        res.end(JSON.stringify(resp));\n      });\n    } else {\n      res.statusCode = 500;\n      return res.end();\n    }\n  });\n});\n\nJsonRoutes.add(\"post\", \"/s3/:collection\", function(req, res, next) {\n  var collectionName, e, userId;\n  try {\n    userId = Steedos.getUserIdFromAuthToken(req, res);\n    if (!userId) {\n      throw new Meteor.Error(500, \"No permission\");\n    }\n    collectionName = req.params.collection;\n    JsonRoutes.parseFiles(req, res, function() {\n      var collection, newFile, resultData;\n      collection = cfs[collectionName];\n      if (!collection) {\n        throw new Meteor.Error(500, \"No Collection\");\n      }\n      if (req.files && req.files[0]) {\n        newFile = new FS.File();\n        newFile.name(req.files[0].filename);\n        if (req.body) {\n          newFile.metadata = req.body;\n        }\n        newFile.owner = userId;\n        newFile.metadata.owner = userId;\n        newFile.attachData(req.files[0].data, {\n          type: req.files[0].mimeType\n        });\n        collection.insert(newFile);\n        resultData = collection.files.findOne(newFile._id);\n        JsonRoutes.sendResult(res, {\n          code: 200,\n          data: resultData\n        });\n      } else {\n        throw new Meteor.Error(500, \"No File\");\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: e.error || 500,\n      data: {\n        errors: e.reason || e.message\n      }\n    });\n  }\n});\n\ngetQueryString = function(accessKeyId, secretAccessKey, query, method) {\n  var ALY, canonicalizedQueryString, date, queryKeys, queryStr, stringToSign;\n  console.log(\"----uuflowManager.getQueryString----\");\n  ALY = require('aliyun-sdk');\n  date = ALY.util.date.getDate();\n  query.Format = \"json\";\n  query.Version = \"2017-03-21\";\n  query.AccessKeyId = accessKeyId;\n  query.SignatureMethod = \"HMAC-SHA1\";\n  query.Timestamp = ALY.util.date.iso8601(date);\n  query.SignatureVersion = \"1.0\";\n  query.SignatureNonce = String(date.getTime());\n  queryKeys = Object.keys(query);\n  queryKeys.sort();\n  canonicalizedQueryString = \"\";\n  queryKeys.forEach(function(name) {\n    return canonicalizedQueryString += \"&\" + name + \"=\" + ALY.util.popEscape(query[name]);\n  });\n  stringToSign = method.toUpperCase() + '&%2F&' + ALY.util.popEscape(canonicalizedQueryString.substr(1));\n  query.Signature = ALY.util.crypto.hmac(secretAccessKey + '&', stringToSign, 'base64', 'sha1');\n  queryStr = ALY.util.queryParamsToString(query);\n  console.log(queryStr);\n  return queryStr;\n};\n\nJsonRoutes.add(\"post\", \"/s3/vod/upload\", function(req, res, next) {\n  var ALY, collectionName, e, userId;\n  try {\n    userId = Steedos.getUserIdFromAuthToken(req, res);\n    if (!userId) {\n      throw new Meteor.Error(500, \"No permission\");\n    }\n    collectionName = \"videos\";\n    ALY = require('aliyun-sdk');\n    JsonRoutes.parseFiles(req, res, function() {\n      var accessKeyId, collection, date, oss, query, r, ref, ref1, ref2, ref3, secretAccessKey, uploadAddress, uploadAuth, url, videoId;\n      collection = cfs[collectionName];\n      if (!collection) {\n        throw new Meteor.Error(500, \"No Collection\");\n      }\n      if (req.files && req.files[0]) {\n        if (collectionName === 'videos' && ((ref = Meteor.settings[\"public\"].cfs) != null ? ref.store : void 0) === \"OSS\") {\n          accessKeyId = (ref1 = Meteor.settings.cfs.aliyun) != null ? ref1.accessKeyId : void 0;\n          secretAccessKey = (ref2 = Meteor.settings.cfs.aliyun) != null ? ref2.secretAccessKey : void 0;\n          date = ALY.util.date.getDate();\n          query = {\n            Action: \"CreateUploadVideo\",\n            Title: req.files[0].filename,\n            FileName: req.files[0].filename\n          };\n          url = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, query, 'GET');\n          r = HTTP.call('GET', url);\n          console.log(r);\n          if ((ref3 = r.data) != null ? ref3.VideoId : void 0) {\n            videoId = r.data.VideoId;\n            uploadAddress = JSON.parse(new Buffer(r.data.UploadAddress, 'base64').toString());\n            console.log(uploadAddress);\n            uploadAuth = JSON.parse(new Buffer(r.data.UploadAuth, 'base64').toString());\n            console.log(uploadAuth);\n            oss = new ALY.OSS({\n              \"accessKeyId\": uploadAuth.AccessKeyId,\n              \"secretAccessKey\": uploadAuth.AccessKeySecret,\n              \"endpoint\": uploadAddress.Endpoint,\n              \"apiVersion\": '2013-10-15',\n              \"securityToken\": uploadAuth.SecurityToken\n            });\n            return oss.putObject({\n              Bucket: uploadAddress.Bucket,\n              Key: uploadAddress.FileName,\n              Body: req.files[0].data,\n              AccessControlAllowOrigin: '',\n              ContentType: req.files[0].mimeType,\n              CacheControl: 'no-cache',\n              ContentDisposition: '',\n              ContentEncoding: 'utf-8',\n              ServerSideEncryption: 'AES256',\n              Expires: null\n            }, Meteor.bindEnvironment(function(err, data) {\n              var getPlayInfoQuery, getPlayInfoResult, getPlayInfoUrl, newDate;\n              if (err) {\n                console.log('error:', err);\n                throw new Meteor.Error(500, err.message);\n              }\n              console.log('success:', data);\n              newDate = ALY.util.date.getDate();\n              getPlayInfoQuery = {\n                Action: 'GetPlayInfo',\n                VideoId: videoId\n              };\n              getPlayInfoUrl = \"http://vod.cn-shanghai.aliyuncs.com/?\" + getQueryString(accessKeyId, secretAccessKey, getPlayInfoQuery, 'GET');\n              getPlayInfoResult = HTTP.call('GET', getPlayInfoUrl);\n              return JsonRoutes.sendResult(res, {\n                code: 200,\n                data: getPlayInfoResult\n              });\n            }));\n          }\n        }\n      } else {\n        throw new Meteor.Error(500, \"No File\");\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: e.error || 500,\n      data: {\n        errors: e.reason || e.message\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/drafts', (req, res, next) ->\r\n\ttry\r\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\r\n\t\tcurrent_user_id = current_user_info._id\r\n\r\n\t\thashData = req.body\r\n\r\n\t\tinserted_instances = new Array\r\n\r\n\t\t_.each hashData['Instances'], (instance_from_client) ->\r\n\t\t\tnew_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info)\r\n\r\n\t\t\tnew_ins = Creator.Collections.instances.findOne({ _id: new_ins_id }, { fields: { space: 1, flow: 1, flow_version: 1, form: 1, form_version: 1 } })\r\n\r\n\t\t\tinserted_instances.push(new_ins)\r\n\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { inserts: inserted_instances }\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.reason || e.message }] }\r\n\t\t}\r\n\r\n","JsonRoutes.add('post', '/api/workflow/drafts', function(req, res, next) {\n  var current_user_id, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user_id = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var new_ins, new_ins_id;\n      new_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info);\n      new_ins = Creator.Collections.instances.findOne({\n        _id: new_ins_id\n      }, {\n        fields: {\n          space: 1,\n          flow: 1,\n          flow_version: 1,\n          form: 1,\n          form_version: 1\n        }\n      });\n      return inserted_instances.push(new_ins);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason || e.message\n          }\n        ]\n      }\n    });\n  }\n});\n"]}