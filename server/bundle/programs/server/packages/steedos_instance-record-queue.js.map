{"version":3,"sources":["meteor://💻app/packages/steedos:instance-record-queue/lib/common/main.js","meteor://💻app/packages/steedos:instance-record-queue/lib/common/docs.js","meteor://💻app/packages/steedos:instance-record-queue/lib/server/api.js","meteor://💻app/packages/steedos_instance-record-queue/server/startup.coffee","meteor://💻app/server/startup.coffee","meteor://💻app/packages/steedos:instance-record-queue/server/checkNpm.js"],"names":["InstanceRecordQueue","EventState","collection","db","instance_record_queue","Mongo","Collection","_validateDocument","doc","check","info","Object","sent","Match","Optional","Boolean","sending","Integer","createdAt","Date","createdBy","OneOf","String","send","options","currentUser","Meteor","isClient","userId","isServer","_","extend","test","pick","insert","_eval","require","isConfigured","sendWorker","task","interval","debug","console","log","setInterval","error","message","Configure","self","sendTimeout","Error","syncAttach","sync_attachment","insId","spaceId","newRecordId","objectName","cfs","instances","find","forEach","f","hasStored","_id","newFile","FS","File","cmsFileId","Creator","getCollection","_makeNewID","attachData","createReadStream","type","original","err","reason","name","size","metadata","owner","owner_name","space","record_id","object_name","parent","files","wrapAsync","cb","once","storeName","o","ids","extention","extension","versions","created_by","modified_by","parents","includes","push","current","update","$set","$addToSet","syncInsFields","syncValues","field_map_back","values","ins","objectInfo","field_map_back_script","record","obj","tableFieldCodes","tableFieldMap","tableToRelatedMap","form","findOne","formFields","form_version","fields","formVersion","historys","h","objectFields","objectFieldKeys","keys","relatedObjects","getRelatedObjects","relatedObjectsKeys","pluck","formTableFields","filter","formField","formTableFieldsCode","getRelatedObjectField","key","relatedObjectsKey","startsWith","getFormTableField","formTableFieldCode","getFormField","_formFields","_fieldCode","each","ff","code","fm","relatedObjectField","object_field","formTableField","workflow_field","oTableCode","split","oTableFieldCode","tableToRelatedMapKey","wTableCode","indexOf","hasOwnProperty","isArray","JSON","stringify","workflow_table_field_code","object_table_field_code","wField","oField","reference_to","isEmpty","multiple","is_multiselect","compact","id","isString","oCollection","referObject","getObject","referData","nameFieldKey","NAME_FIELD_KEY","selector","tmp_field_value","temObjFields","length","objField","referObjField","referSetObj","insField","uniq","tfc","c","parse","tr","newTr","v","k","tfm","oTdCode","relatedObjs","getRelatedFieldValue","valueKey","reduce","x","map","tableCode","_FROM_TABLE_CODE","warn","relatedObjectName","relatedObjectValues","relatedObject","tableValueItem","relatedObjectValue","fieldKey","relatedObjectFieldValue","formFieldKey","_code","evalFieldMapBackScript","filterObj","mainObjectValue","relatedObjectsValue","script","func","isObject","syncRelatedObjectsValue","mainRecordId","objectCollection","tableMap","table_id","_table","table_code","oldRelatedRecord","foreign_key","applicant","instance_state","state","final_decision","validate","tableIds","remove","$nin","sendDoc","instance_id","records","flow","traces","ow","flow_id","$in","setObj","removeOldFiles","stack","newObj","r","$push","record_ids","$pull","_querySend","serverSend","isSendingDoc","sendInterval","_ensureIndex","now","timeoutAt","reserved","$lt","result","keepDocs","sentAt","batchSize","sendBatchSize","pendingDocs","$and","errMsg","$exists","sort","limit","startup","ref","settings","cron","instancerecordqueue_interval","checkNpmVersions","module","link"],"mappings":"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","file":"/packages/steedos_instance-record-queue.js","sourcesContent":["InstanceRecordQueue = new EventState();","InstanceRecordQueue.collection = db.instance_record_queue = new Mongo.Collection('instance_record_queue');\r\n\r\nvar _validateDocument = function(doc) {\r\n\r\n\tcheck(doc, {\r\n\t\tinfo: Object,\r\n\t\tsent: Match.Optional(Boolean),\r\n\t\tsending: Match.Optional(Match.Integer),\r\n\t\tcreatedAt: Date,\r\n\t\tcreatedBy: Match.OneOf(String, null)\r\n\t});\r\n\r\n};\r\n\r\nInstanceRecordQueue.send = function(options) {\r\n\tvar currentUser = Meteor.isClient && Meteor.userId && Meteor.userId() || Meteor.isServer && (options.createdBy || '<SERVER>') || null\r\n\tvar doc = _.extend({\r\n\t\tcreatedAt: new Date(),\r\n\t\tcreatedBy: currentUser\r\n\t});\r\n\r\n\tif (Match.test(options, Object)) {\r\n\t\tdoc.info = _.pick(options, 'instance_id', 'records', 'sync_date', 'instance_finish_date', 'step_name');\r\n\t}\r\n\r\n\tdoc.sent = false;\r\n\tdoc.sending = 0;\r\n\r\n\t_validateDocument(doc);\r\n\r\n\treturn InstanceRecordQueue.collection.insert(doc);\r\n};","var _eval = require('eval');\r\nvar isConfigured = false;\r\nvar sendWorker = function (task, interval) {\r\n\r\n\tif (InstanceRecordQueue.debug) {\r\n\t\tconsole.log('InstanceRecordQueue: Send worker started, using interval: ' + interval);\r\n\t}\r\n\r\n\treturn Meteor.setInterval(function () {\r\n\t\ttry {\r\n\t\t\ttask();\r\n\t\t} catch (error) {\r\n\t\t\tconsole.log('InstanceRecordQueue: Error while sending: ' + error.message);\r\n\t\t}\r\n\t}, interval);\r\n};\r\n\r\n/*\r\n\toptions: {\r\n\t\t// Controls the sending interval\r\n\t\tsendInterval: Match.Optional(Number),\r\n\t\t// Controls the sending batch size per interval\r\n\t\tsendBatchSize: Match.Optional(Number),\r\n\t\t// Allow optional keeping notifications in collection\r\n\t\tkeepDocs: Match.Optional(Boolean)\r\n\t}\r\n*/\r\nInstanceRecordQueue.Configure = function (options) {\r\n\tvar self = this;\r\n\toptions = _.extend({\r\n\t\tsendTimeout: 60000, // Timeout period\r\n\t}, options);\r\n\r\n\t// Block multiple calls\r\n\tif (isConfigured) {\r\n\t\tthrow new Error('InstanceRecordQueue.Configure should not be called more than once!');\r\n\t}\r\n\r\n\tisConfigured = true;\r\n\r\n\t// Add debug info\r\n\tif (InstanceRecordQueue.debug) {\r\n\t\tconsole.log('InstanceRecordQueue.Configure', options);\r\n\t}\r\n\r\n\tself.syncAttach = function (sync_attachment, insId, spaceId, newRecordId, objectName) {\r\n\t\tif (sync_attachment == \"lastest\") {\r\n\t\t\tcfs.instances.find({\r\n\t\t\t\t'metadata.instance': insId,\r\n\t\t\t\t'metadata.current': true\r\n\t\t\t}).forEach(function (f) {\r\n\t\t\t\tif (!f.hasStored('instances')) {\r\n\t\t\t\t\tconsole.error('syncAttach-file not stored: ', f._id);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tvar newFile = new FS.File(),\r\n\t\t\t\t\tcmsFileId = Creator.getCollection('cms_files')._makeNewID();\r\n\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\r\n\t\t\t\t\ttype: f.original.type\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnewFile.name(f.name());\r\n\t\t\t\t\tnewFile.size(f.size());\r\n\t\t\t\t\tvar metadata = {\r\n\t\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\t\towner_name: f.metadata.owner_name,\r\n\t\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t\trecord_id: newRecordId,\r\n\t\t\t\t\t\tobject_name: objectName,\r\n\t\t\t\t\t\tparent: cmsFileId\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tnewFile.metadata = metadata;\r\n\t\t\t\t\tcfs.files.insert(newFile);\r\n\t\t\t\t});\r\n\t\t\t\tMeteor.wrapAsync(function (newFile, Creator, cmsFileId, objectName, newRecordId, spaceId, f, cb) {\r\n\t\t\t\t\tnewFile.once('stored', function (storeName) {\r\n\t\t\t\t\t\tCreator.getCollection('cms_files').insert({\r\n\t\t\t\t\t\t\t_id: cmsFileId,\r\n\t\t\t\t\t\t\tparent: {\r\n\t\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\t\tids: [newRecordId]\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tsize: newFile.size(),\r\n\t\t\t\t\t\t\tname: newFile.name(),\r\n\t\t\t\t\t\t\textention: newFile.extension(),\r\n\t\t\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t\t\tversions: [newFile._id],\r\n\t\t\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\t\t\tcreated_by: f.metadata.owner,\r\n\t\t\t\t\t\t\tmodified_by: f.metadata.owner\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tcb(null);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tnewFile.once('error', function (error) {\r\n\t\t\t\t\t\tconsole.error('syncAttach-error: ', error);\r\n\t\t\t\t\t\tcb(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t})(newFile, Creator, cmsFileId, objectName, newRecordId, spaceId, f);\r\n\t\t\t})\r\n\t\t} else if (sync_attachment == \"all\") {\r\n\t\t\tvar parents = [];\r\n\t\t\tcfs.instances.find({\r\n\t\t\t\t'metadata.instance': insId\r\n\t\t\t}).forEach(function (f) {\r\n\t\t\t\tif (!f.hasStored('instances')) {\r\n\t\t\t\t\tconsole.error('syncAttach-file not stored: ', f._id);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tvar newFile = new FS.File(),\r\n\t\t\t\t\tcmsFileId = f.metadata.parent;\r\n\r\n\t\t\t\tif (!parents.includes(cmsFileId)) {\r\n\t\t\t\t\tparents.push(cmsFileId);\r\n\t\t\t\t\tCreator.getCollection('cms_files').insert({\r\n\t\t\t\t\t\t_id: cmsFileId,\r\n\t\t\t\t\t\tparent: {\r\n\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\tids: [newRecordId]\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t\tversions: [],\r\n\t\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\t\tcreated_by: f.metadata.owner,\r\n\t\t\t\t\t\tmodified_by: f.metadata.owner\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\r\n\t\t\t\t\ttype: f.original.type\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnewFile.name(f.name());\r\n\t\t\t\t\tnewFile.size(f.size());\r\n\t\t\t\t\tvar metadata = {\r\n\t\t\t\t\t\towner: f.metadata.owner,\r\n\t\t\t\t\t\towner_name: f.metadata.owner_name,\r\n\t\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t\trecord_id: newRecordId,\r\n\t\t\t\t\t\tobject_name: objectName,\r\n\t\t\t\t\t\tparent: cmsFileId\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tnewFile.metadata = metadata;\r\n\t\t\t\t\tcfs.files.insert(newFile);\r\n\t\t\t\t});\r\n\t\t\t\tMeteor.wrapAsync(function (newFile, Creator, cmsFileId, f, cb) {\r\n\t\t\t\t\tnewFile.once('stored', function (storeName) {\r\n\t\t\t\t\t\tif (f.metadata.current == true) {\r\n\t\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\r\n\t\t\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t\t\tsize: newFile.size(),\r\n\t\t\t\t\t\t\t\t\tname: newFile.name(),\r\n\t\t\t\t\t\t\t\t\textention: newFile.extension(),\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t$addToSet: {\r\n\t\t\t\t\t\t\t\t\tversions: newFile._id\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\r\n\t\t\t\t\t\t\t\t$addToSet: {\r\n\t\t\t\t\t\t\t\t\tversions: newFile._id\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tcb(null);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tnewFile.once('error', function (error) {\r\n\t\t\t\t\t\tconsole.error('syncAttach-error: ', error);\r\n\t\t\t\t\t\tcb(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t})(newFile, Creator, cmsFileId, f);\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\tself.syncInsFields = ['name', 'submitter_name', 'applicant_name', 'applicant_organization_name', 'applicant_organization_fullname', 'state',\r\n\t\t'current_step_name', 'flow_name', 'category_name', 'submit_date', 'finish_date', 'final_decision', 'applicant_organization', 'applicant_company'\r\n\t];\r\n\tself.syncValues = function (field_map_back, values, ins, objectInfo, field_map_back_script, record) {\r\n\t\tvar\r\n\t\t\tobj = {},\r\n\t\t\ttableFieldCodes = [],\r\n\t\t\ttableFieldMap = [],\r\n\t\t\ttableToRelatedMap = {};\r\n\r\n\t\tfield_map_back = field_map_back || [];\r\n\r\n\t\tvar spaceId = ins.space;\r\n\r\n\t\tvar form = Creator.getCollection(\"forms\").findOne(ins.form);\r\n\t\tvar formFields = null;\r\n\t\tif (form.current._id === ins.form_version) {\r\n\t\t\tformFields = form.current.fields || [];\r\n\t\t} else {\r\n\t\t\tvar formVersion = _.find(form.historys, function (h) {\r\n\t\t\t\treturn h._id === ins.form_version;\r\n\t\t\t})\r\n\t\t\tformFields = formVersion ? formVersion.fields : [];\r\n\t\t}\r\n\r\n\t\tvar objectFields = objectInfo.fields;\r\n\t\tvar objectFieldKeys = _.keys(objectFields);\r\n\t\tvar relatedObjects = Creator.getRelatedObjects(objectInfo.name, spaceId);\r\n\t\tvar relatedObjectsKeys = _.pluck(relatedObjects, 'object_name');\r\n\t\tvar formTableFields = _.filter(formFields, function (formField) {\r\n\t\t\treturn formField.type === 'table'\r\n\t\t});\r\n\t\tvar formTableFieldsCode = _.pluck(formTableFields, 'code');\r\n\r\n\t\tvar getRelatedObjectField = function (key) {\r\n\t\t\treturn _.find(relatedObjectsKeys, function (relatedObjectsKey) {\r\n\t\t\t\treturn key.startsWith(relatedObjectsKey + '.');\r\n\t\t\t})\r\n\t\t};\r\n\r\n\t\tvar getFormTableField = function (key) {\r\n\t\t\treturn _.find(formTableFieldsCode, function (formTableFieldCode) {\r\n\t\t\t\treturn key.startsWith(formTableFieldCode + '.');\r\n\t\t\t})\r\n\t\t};\r\n\r\n\t\tvar getFormField = function (_formFields, _fieldCode) {\r\n\t\t\tvar formField = null;\r\n\t\t\t_.each(_formFields, function (ff) {\r\n\t\t\t\tif (!formField) {\r\n\t\t\t\t\tif (ff.code === _fieldCode) {\r\n\t\t\t\t\t\tformField = ff;\r\n\t\t\t\t\t} else if (ff.type === 'section') {\r\n\t\t\t\t\t\t_.each(ff.fields, function (f) {\r\n\t\t\t\t\t\t\tif (!formField) {\r\n\t\t\t\t\t\t\t\tif (f.code === _fieldCode) {\r\n\t\t\t\t\t\t\t\t\tformField = f;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t} else if (ff.type === 'table') {\r\n\t\t\t\t\t\t_.each(ff.fields, function (f) {\r\n\t\t\t\t\t\t\tif (!formField) {\r\n\t\t\t\t\t\t\t\tif (f.code === _fieldCode) {\r\n\t\t\t\t\t\t\t\t\tformField = f;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn formField;\r\n\t\t}\r\n\r\n\t\tfield_map_back.forEach(function (fm) {\r\n\t\t\t//workflow 的子表到creator object 的相关对象\r\n\t\t\tvar relatedObjectField = getRelatedObjectField(fm.object_field);\r\n\t\t\tvar formTableField = getFormTableField(fm.workflow_field);\r\n\t\t\tif (relatedObjectField) {\r\n\t\t\t\tvar oTableCode = fm.object_field.split('.')[0];\r\n\t\t\t\tvar oTableFieldCode = fm.object_field.split('.')[1];\r\n\t\t\t\tvar tableToRelatedMapKey = oTableCode;\r\n\t\t\t\tif (!tableToRelatedMap[tableToRelatedMapKey]) {\r\n\t\t\t\t\ttableToRelatedMap[tableToRelatedMapKey] = {}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (formTableField) {\r\n\t\t\t\t\tvar wTableCode = fm.workflow_field.split('.')[0];\r\n\t\t\t\t\ttableToRelatedMap[tableToRelatedMapKey]['_FROM_TABLE_CODE'] = wTableCode\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttableToRelatedMap[tableToRelatedMapKey][oTableFieldCode] = fm.workflow_field\r\n\t\t\t}\r\n\t\t\t// 判断是否是子表字段\r\n\t\t\telse if (fm.workflow_field.indexOf('.$.') > 0 && fm.object_field.indexOf('.$.') > 0) {\r\n\t\t\t\tvar wTableCode = fm.workflow_field.split('.$.')[0];\r\n\t\t\t\tvar oTableCode = fm.object_field.split('.$.')[0];\r\n\t\t\t\tif (values.hasOwnProperty(wTableCode) && _.isArray(values[wTableCode])) {\r\n\t\t\t\t\ttableFieldCodes.push(JSON.stringify({\r\n\t\t\t\t\t\tworkflow_table_field_code: wTableCode,\r\n\t\t\t\t\t\tobject_table_field_code: oTableCode\r\n\t\t\t\t\t}));\r\n\t\t\t\t\ttableFieldMap.push(fm);\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse if (values.hasOwnProperty(fm.workflow_field)) {\r\n\t\t\t\tvar wField = null;\r\n\r\n\t\t\t\t_.each(formFields, function (ff) {\r\n\t\t\t\t\tif (!wField) {\r\n\t\t\t\t\t\tif (ff.code === fm.workflow_field) {\r\n\t\t\t\t\t\t\twField = ff;\r\n\t\t\t\t\t\t} else if (ff.type === 'section') {\r\n\t\t\t\t\t\t\t_.each(ff.fields, function (f) {\r\n\t\t\t\t\t\t\t\tif (!wField) {\r\n\t\t\t\t\t\t\t\t\tif (f.code === fm.workflow_field) {\r\n\t\t\t\t\t\t\t\t\t\twField = f;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\r\n\t\t\t\tvar oField = objectFields[fm.object_field];\r\n\r\n\t\t\t\tif (oField) {\r\n\t\t\t\t\tif (!wField) {\r\n\t\t\t\t\t\tconsole.log('fm.workflow_field: ', fm.workflow_field)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// 表单选人选组字段 至 对象 lookup master_detail类型字段同步\r\n\t\t\t\t\tif (['user', 'group'].includes(wField.type) && ['lookup', 'master_detail'].includes(oField.type) && ['users', 'organizations'].includes(oField.reference_to)) {\r\n\t\t\t\t\t\tif (!_.isEmpty(values[fm.workflow_field])) {\r\n\t\t\t\t\t\t\tif (oField.multiple && wField.is_multiselect) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = _.compact(_.pluck(values[fm.workflow_field], 'id'))\r\n\t\t\t\t\t\t\t} else if (!oField.multiple && !wField.is_multiselect) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field].id\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to) && _.isString(values[fm.workflow_field])) {\r\n\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\r\n\t\t\t\t\t\tvar referObject = Creator.getObject(oField.reference_to, spaceId)\r\n\t\t\t\t\t\tif (oCollection && referObject) {\r\n\t\t\t\t\t\t\t// 先认为此值是referObject _id字段值\r\n\t\t\t\t\t\t\tvar referData = oCollection.findOne(values[fm.workflow_field], {\r\n\t\t\t\t\t\t\t\tfields: {\r\n\t\t\t\t\t\t\t\t\t_id: 1\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tif (referData) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t// 其次认为此值是referObject NAME_FIELD_KEY值\r\n\t\t\t\t\t\t\tif (!referData) {\r\n\t\t\t\t\t\t\t\tvar nameFieldKey = referObject.NAME_FIELD_KEY;\r\n\t\t\t\t\t\t\t\tvar selector = {};\r\n\t\t\t\t\t\t\t\tselector[nameFieldKey] = values[fm.workflow_field];\r\n\t\t\t\t\t\t\t\treferData = oCollection.findOne(selector, {\r\n\t\t\t\t\t\t\t\t\tfields: {\r\n\t\t\t\t\t\t\t\t\t\t_id: 1\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tif (referData) {\r\n\t\t\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (oField.type === \"boolean\") {\r\n\t\t\t\t\t\t\tvar tmp_field_value = values[fm.workflow_field];\r\n\t\t\t\t\t\t\tif (['true', '是'].includes(tmp_field_value)) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = true;\r\n\t\t\t\t\t\t\t} else if (['false', '否'].includes(tmp_field_value)) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = false;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = tmp_field_value;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse if (['lookup', 'master_detail'].includes(oField.type) && wField.type === 'odata') {\r\n\t\t\t\t\t\t\tif (oField.multiple && wField.is_multiselect) {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = _.compact(_.pluck(values[fm.workflow_field], '_id'))\r\n\t\t\t\t\t\t\t} else if (!oField.multiple && !wField.is_multiselect) {\r\n\t\t\t\t\t\t\t\tif (!_.isEmpty(values[fm.workflow_field])) {\r\n\t\t\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field]._id\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (fm.object_field.indexOf('.') > -1) {\r\n\t\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\r\n\t\t\t\t\t\tif (temObjFields.length === 2) {\r\n\t\t\t\t\t\t\tvar objField = temObjFields[0];\r\n\t\t\t\t\t\t\tvar referObjField = temObjFields[1];\r\n\t\t\t\t\t\t\tvar oField = objectFields[objField];\r\n\t\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\r\n\t\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\r\n\t\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\r\n\t\t\t\t\t\t\t\t\tvar referSetObj = {};\r\n\t\t\t\t\t\t\t\t\treferSetObj[referObjField] = values[fm.workflow_field];\r\n\t\t\t\t\t\t\t\t\toCollection.update(record[objField], {\r\n\t\t\t\t\t\t\t\t\t\t$set: referSetObj\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// else{\r\n\t\t\t\t\t// \tvar relatedObject = _.find(relatedObjects, function(_relatedObject){\r\n\t\t\t\t\t// \t\treturn _relatedObject.object_name === fm.object_field\r\n\t\t\t\t\t// \t})\r\n\t\t\t\t\t//\r\n\t\t\t\t\t// \tif(relatedObject){\r\n\t\t\t\t\t// \t\tobj[fm.object_field] = values[fm.workflow_field];\r\n\t\t\t\t\t// \t}\r\n\t\t\t\t\t// }\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (fm.workflow_field.startsWith('instance.')) {\r\n\t\t\t\t\tvar insField = fm.workflow_field.split('instance.')[1];\r\n\t\t\t\t\tif (self.syncInsFields.includes(insField)) {\r\n\t\t\t\t\t\tif (fm.object_field.indexOf('.') < 0) {\r\n\t\t\t\t\t\t\tobj[fm.object_field] = ins[insField];\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\r\n\t\t\t\t\t\t\tif (temObjFields.length === 2) {\r\n\t\t\t\t\t\t\t\tvar objField = temObjFields[0];\r\n\t\t\t\t\t\t\t\tvar referObjField = temObjFields[1];\r\n\t\t\t\t\t\t\t\tvar oField = objectFields[objField];\r\n\t\t\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\r\n\t\t\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\r\n\t\t\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\r\n\t\t\t\t\t\t\t\t\t\tvar referSetObj = {};\r\n\t\t\t\t\t\t\t\t\t\treferSetObj[referObjField] = ins[insField];\r\n\t\t\t\t\t\t\t\t\t\toCollection.update(record[objField], {\r\n\t\t\t\t\t\t\t\t\t\t\t$set: referSetObj\r\n\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (ins[fm.workflow_field]) {\r\n\t\t\t\t\t\tobj[fm.object_field] = ins[fm.workflow_field];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\t_.uniq(tableFieldCodes).forEach(function (tfc) {\r\n\t\t\tvar c = JSON.parse(tfc);\r\n\t\t\tobj[c.object_table_field_code] = [];\r\n\t\t\tvalues[c.workflow_table_field_code].forEach(function (tr) {\r\n\t\t\t\tvar newTr = {};\r\n\t\t\t\t_.each(tr, function (v, k) {\r\n\t\t\t\t\ttableFieldMap.forEach(function (tfm) {\r\n\t\t\t\t\t\tif (tfm.workflow_field == (c.workflow_table_field_code + '.$.' + k)) {\r\n\t\t\t\t\t\t\tvar oTdCode = tfm.object_field.split('.$.')[1];\r\n\t\t\t\t\t\t\tnewTr[oTdCode] = v;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t\tif (!_.isEmpty(newTr)) {\r\n\t\t\t\t\tobj[c.object_table_field_code].push(newTr);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t});\r\n\t\tvar relatedObjs = {};\r\n\t\tvar getRelatedFieldValue = function (valueKey, parent) {\r\n\t\t\treturn valueKey.split('.').reduce(function (o, x) {\r\n\t\t\t\treturn o[x];\r\n\t\t\t}, parent);\r\n\t\t};\r\n\t\t_.each(tableToRelatedMap, function (map, key) {\r\n\t\t\tvar tableCode = map._FROM_TABLE_CODE;\r\n\t\t\tif (!tableCode) {\r\n\t\t\t\tconsole.warn('tableToRelated: [' + key + '] missing corresponding table.')\r\n\t\t\t} else {\r\n\t\t\t\tvar relatedObjectName = key;\r\n\t\t\t\tvar relatedObjectValues = [];\r\n\t\t\t\tvar relatedObject = Creator.getObject(relatedObjectName, spaceId);\r\n\t\t\t\t_.each(values[tableCode], function (tableValueItem) {\r\n\t\t\t\t\tvar relatedObjectValue = {};\r\n\t\t\t\t\t_.each(map, function (valueKey, fieldKey) {\r\n\t\t\t\t\t\tif (fieldKey != '_FROM_TABLE_CODE') {\r\n\t\t\t\t\t\t\tif (valueKey.startsWith('instance.')) {\r\n\t\t\t\t\t\t\t\trelatedObjectValue[fieldKey] = getRelatedFieldValue(valueKey, { 'instance': ins });\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\t\tvar relatedObjectFieldValue, formFieldKey;\r\n\t\t\t\t\t\t\t\tif (valueKey.startsWith(tableCode + '.')) {\r\n\t\t\t\t\t\t\t\t\tformFieldKey = valueKey.split(\".\")[1];\r\n\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = getRelatedFieldValue(valueKey, { [tableCode]: tableValueItem });\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tformFieldKey = valueKey;\r\n\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = getRelatedFieldValue(valueKey, values)\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tvar formField = getFormField(formFields, formFieldKey);\r\n\t\t\t\t\t\t\t\tvar relatedObjectField = relatedObject.fields[fieldKey];\r\n\t\t\t\t\t\t\t\tif (!relatedObjectField || !formField) {\r\n\t\t\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (formField.type == 'odata' && ['lookup', 'master_detail'].includes(relatedObjectField.type)) {\r\n\t\t\t\t\t\t\t\t\tif (!_.isEmpty(relatedObjectFieldValue)) {\r\n\t\t\t\t\t\t\t\t\t\tif (relatedObjectField.multiple && formField.is_multiselect) {\r\n\t\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = _.compact(_.pluck(relatedObjectFieldValue, '_id'))\r\n\t\t\t\t\t\t\t\t\t\t} else if (!relatedObjectField.multiple && !formField.is_multiselect) {\r\n\t\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = relatedObjectFieldValue._id\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t// 表单选人选组字段 至 对象 lookup master_detail类型字段同步\r\n\t\t\t\t\t\t\t\tif (['user', 'group'].includes(formField.type) && ['lookup', 'master_detail'].includes(relatedObjectField.type) && ['users', 'organizations'].includes(relatedObjectField.reference_to)) {\r\n\t\t\t\t\t\t\t\t\tif (!_.isEmpty(relatedObjectFieldValue)) {\r\n\t\t\t\t\t\t\t\t\t\tif (relatedObjectField.multiple && formField.is_multiselect) {\r\n\t\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = _.compact(_.pluck(relatedObjectFieldValue, 'id'))\r\n\t\t\t\t\t\t\t\t\t\t} else if (!relatedObjectField.multiple && !formField.is_multiselect) {\r\n\t\t\t\t\t\t\t\t\t\t\trelatedObjectFieldValue = relatedObjectFieldValue.id\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\trelatedObjectValue[fieldKey] = relatedObjectFieldValue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\trelatedObjectValue['_table'] = {\r\n\t\t\t\t\t\t_id: tableValueItem[\"_id\"],\r\n\t\t\t\t\t\t_code: tableCode\r\n\t\t\t\t\t};\r\n\t\t\t\t\trelatedObjectValues.push(relatedObjectValue);\r\n\t\t\t\t});\r\n\t\t\t\trelatedObjs[relatedObjectName] = relatedObjectValues;\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tif (field_map_back_script) {\r\n\t\t\t_.extend(obj, self.evalFieldMapBackScript(field_map_back_script, ins));\r\n\t\t}\r\n\t\t// 过滤掉非法的key\r\n\t\tvar filterObj = {};\r\n\r\n\t\t_.each(_.keys(obj), function (k) {\r\n\t\t\tif (objectFieldKeys.includes(k)) {\r\n\t\t\t\tfilterObj[k] = obj[k];\r\n\t\t\t}\r\n\t\t\t// else if(relatedObjectsKeys.includes(k) && _.isArray(obj[k])){\r\n\t\t\t// \tif(_.isArray(relatedObjs[k])){\r\n\t\t\t// \t\trelatedObjs[k] = relatedObjs[k].concat(obj[k])\r\n\t\t\t// \t}else{\r\n\t\t\t// \t\trelatedObjs[k] = obj[k]\r\n\t\t\t// \t}\r\n\t\t\t// }\r\n\t\t})\r\n\t\treturn {\r\n\t\t\tmainObjectValue: filterObj,\r\n\t\t\trelatedObjectsValue: relatedObjs\r\n\t\t};\r\n\t}\r\n\r\n\tself.evalFieldMapBackScript = function (field_map_back_script, ins) {\r\n\t\tvar script = \"module.exports = function (instance) { \" + field_map_back_script + \" }\";\r\n\t\tvar func = _eval(script, \"field_map_script\");\r\n\t\tvar values = func(ins);\r\n\t\tif (_.isObject(values)) {\r\n\t\t\treturn values;\r\n\t\t} else {\r\n\t\t\tconsole.error(\"evalFieldMapBackScript: 脚本返回值类型不是对象\");\r\n\t\t}\r\n\t\treturn {}\r\n\t}\r\n\r\n\tself.syncRelatedObjectsValue = function (mainRecordId, relatedObjects, relatedObjectsValue, spaceId, ins) {\r\n\t\tvar insId = ins._id;\r\n\r\n\t\t_.each(relatedObjects, function (relatedObject) {\r\n\t\t\tvar objectCollection = Creator.getCollection(relatedObject.object_name, spaceId);\r\n\t\t\tvar tableMap = {};\r\n\t\t\t_.each(relatedObjectsValue[relatedObject.object_name], function (relatedObjectValue) {\r\n\t\t\t\tvar table_id = relatedObjectValue._table._id;\r\n\t\t\t\tvar table_code = relatedObjectValue._table._code;\r\n\t\t\t\tif (!tableMap[table_code]) {\r\n\t\t\t\t\ttableMap[table_code] = []\r\n\t\t\t\t};\r\n\t\t\t\ttableMap[table_code].push(table_id);\r\n\t\t\t\tvar oldRelatedRecord = Creator.getCollection(relatedObject.object_name, spaceId).findOne({ [relatedObject.foreign_key]: mainRecordId, \"instances._id\": insId, _table: relatedObjectValue._table }, { fields: { _id: 1 } })\r\n\t\t\t\tif (oldRelatedRecord) {\r\n\t\t\t\t\tCreator.getCollection(relatedObject.object_name, spaceId).update({ _id: oldRelatedRecord._id }, { $set: relatedObjectValue })\r\n\t\t\t\t} else {\r\n\t\t\t\t\trelatedObjectValue[relatedObject.foreign_key] = mainRecordId;\r\n\t\t\t\t\trelatedObjectValue.space = spaceId;\r\n\t\t\t\t\trelatedObjectValue.owner = ins.applicant;\r\n\t\t\t\t\trelatedObjectValue.created_by = ins.applicant;\r\n\t\t\t\t\trelatedObjectValue.modified_by = ins.applicant;\r\n\t\t\t\t\trelatedObjectValue._id = objectCollection._makeNewID();\r\n\t\t\t\t\tvar instance_state = ins.state;\r\n\t\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\r\n\t\t\t\t\t\tinstance_state = ins.final_decision;\r\n\t\t\t\t\t}\r\n\t\t\t\t\trelatedObjectValue.instances = [{\r\n\t\t\t\t\t\t_id: insId,\r\n\t\t\t\t\t\tstate: instance_state\r\n\t\t\t\t\t}];\r\n\t\t\t\t\trelatedObjectValue.instance_state = instance_state;\r\n\t\t\t\t\tCreator.getCollection(relatedObject.object_name, spaceId).insert(relatedObjectValue, { validate: false, filter: false })\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t//清理申请单上被删除子表记录对应的相关表记录\r\n\t\t\t_.each(tableMap, function (tableIds, tableCode) {\r\n\t\t\t\tobjectCollection.remove({\r\n\t\t\t\t\t[relatedObject.foreign_key]: mainRecordId,\r\n\t\t\t\t\t\"instances._id\": insId,\r\n\t\t\t\t\t\"_table._code\": tableCode,\r\n\t\t\t\t\t\"_table._id\": { $nin: tableIds }\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t});\r\n\r\n\t\ttableIds = _.compact(tableIds);\r\n\r\n\r\n\t}\r\n\r\n\tInstanceRecordQueue.sendDoc = self.sendDoc = function (doc) {\r\n\t\tif (InstanceRecordQueue.debug) {\r\n\t\t\tconsole.log(\"sendDoc\");\r\n\t\t\tconsole.log(doc);\r\n\t\t}\r\n\r\n\t\tvar insId = doc.info.instance_id,\r\n\t\t\trecords = doc.info.records;\r\n\t\tvar fields = {\r\n\t\t\tflow: 1,\r\n\t\t\tvalues: 1,\r\n\t\t\tapplicant: 1,\r\n\t\t\tspace: 1,\r\n\t\t\tform: 1,\r\n\t\t\tform_version: 1,\r\n\t\t\ttraces: 1\r\n\t\t};\r\n\t\tself.syncInsFields.forEach(function (f) {\r\n\t\t\tfields[f] = 1;\r\n\t\t})\r\n\t\tvar ins = Creator.getCollection('instances').findOne(insId, {\r\n\t\t\tfields: fields\r\n\t\t});\r\n\t\tvar values = ins.values,\r\n\t\t\tspaceId = ins.space;\r\n\r\n\t\tif (records && !_.isEmpty(records)) {\r\n\t\t\t// 此情况属于从creator中发起审批，或者已经从Apps同步到了creator\r\n\t\t\tvar objectName = records[0].o;\r\n\t\t\tvar ow = Creator.getCollection('object_workflows').findOne({\r\n\t\t\t\tobject_name: objectName,\r\n\t\t\t\tflow_id: ins.flow\r\n\t\t\t});\r\n\t\t\tvar\r\n\t\t\t\tobjectCollection = Creator.getCollection(objectName, spaceId),\r\n\t\t\t\tsync_attachment = ow.sync_attachment;\r\n\t\t\tvar objectInfo = Creator.getObject(objectName, spaceId);\r\n\t\t\tobjectCollection.find({\r\n\t\t\t\t_id: {\r\n\t\t\t\t\t$in: records[0].ids\r\n\t\t\t\t}\r\n\t\t\t}).forEach(function (record) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar syncValues = self.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record)\r\n\t\t\t\t\tvar setObj = syncValues.mainObjectValue;\r\n\r\n\t\t\t\t\tvar instance_state = ins.state;\r\n\t\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\r\n\t\t\t\t\t\tinstance_state = ins.final_decision;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tsetObj['instances.$.state'] = setObj.instance_state = instance_state;\r\n\r\n\t\t\t\t\tobjectCollection.update({\r\n\t\t\t\t\t\t_id: record._id,\r\n\t\t\t\t\t\t'instances._id': insId\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: setObj\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tvar relatedObjects = Creator.getRelatedObjects(ow.object_name, spaceId);\r\n\t\t\t\t\tvar relatedObjectsValue = syncValues.relatedObjectsValue;\r\n\t\t\t\t\tself.syncRelatedObjectsValue(record._id, relatedObjects, relatedObjectsValue, spaceId, ins);\r\n\r\n\r\n\t\t\t\t\t// 以最终申请单附件为准，旧的record中附件删除\r\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\r\n\t\t\t\t\t\t'parent': {\r\n\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\tids: [record._id]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\tvar removeOldFiles = function (cb) {\r\n\t\t\t\t\t\treturn cfs.files.remove({\r\n\t\t\t\t\t\t\t'metadata.record_id': record._id\r\n\t\t\t\t\t\t}, cb);\r\n\t\t\t\t\t};\r\n\t\t\t\t\tMeteor.wrapAsync(removeOldFiles)();\r\n\t\t\t\t\t// 同步新附件\r\n\t\t\t\t\tself.syncAttach(sync_attachment, insId, record.space, record._id, objectName);\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error(error.stack);\r\n\t\t\t\t\tobjectCollection.update({\r\n\t\t\t\t\t\t_id: record._id,\r\n\t\t\t\t\t\t'instances._id': insId\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t'instances.$.state': 'pending',\r\n\t\t\t\t\t\t\t'instance_state': 'pending'\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\r\n\t\t\t\t\t\t'parent': {\r\n\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\tids: [record._id]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\tcfs.files.remove({\r\n\t\t\t\t\t\t'metadata.record_id': record._id\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tthrow new Error(error);\r\n\t\t\t\t}\r\n\r\n\t\t\t})\r\n\t\t} else {\r\n\t\t\t// 此情况属于从apps中发起审批\r\n\t\t\tCreator.getCollection('object_workflows').find({\r\n\t\t\t\tflow_id: ins.flow\r\n\t\t\t}).forEach(function (ow) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar\r\n\t\t\t\t\t\tobjectCollection = Creator.getCollection(ow.object_name, spaceId),\r\n\t\t\t\t\t\tsync_attachment = ow.sync_attachment,\r\n\t\t\t\t\t\tnewRecordId = objectCollection._makeNewID(),\r\n\t\t\t\t\t\tobjectName = ow.object_name;\r\n\r\n\t\t\t\t\tvar objectInfo = Creator.getObject(ow.object_name, spaceId);\r\n\t\t\t\t\tvar syncValues = self.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script);\r\n\t\t\t\t\tvar newObj = syncValues.mainObjectValue;\r\n\r\n\t\t\t\t\tnewObj._id = newRecordId;\r\n\t\t\t\t\tnewObj.space = spaceId;\r\n\t\t\t\t\tnewObj.name = newObj.name || ins.name;\r\n\r\n\t\t\t\t\tvar instance_state = ins.state;\r\n\t\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\r\n\t\t\t\t\t\tinstance_state = ins.final_decision;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnewObj.instances = [{\r\n\t\t\t\t\t\t_id: insId,\r\n\t\t\t\t\t\tstate: instance_state\r\n\t\t\t\t\t}];\r\n\t\t\t\t\tnewObj.instance_state = instance_state;\r\n\r\n\t\t\t\t\tnewObj.owner = ins.applicant;\r\n\t\t\t\t\tnewObj.created_by = ins.applicant;\r\n\t\t\t\t\tnewObj.modified_by = ins.applicant;\r\n\t\t\t\t\tvar r = objectCollection.insert(newObj);\r\n\t\t\t\t\tif (r) {\r\n\t\t\t\t\t\tCreator.getCollection('instances').update(ins._id, {\r\n\t\t\t\t\t\t\t$push: {\r\n\t\t\t\t\t\t\t\trecord_ids: {\r\n\t\t\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\t\t\tids: [newRecordId]\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tvar relatedObjects = Creator.getRelatedObjects(ow.object_name, spaceId);\r\n\t\t\t\t\t\tvar relatedObjectsValue = syncValues.relatedObjectsValue;\r\n\t\t\t\t\t\tself.syncRelatedObjectsValue(newRecordId, relatedObjects, relatedObjectsValue, spaceId, ins);\r\n\t\t\t\t\t\t// workflow里发起审批后，同步时也可以修改相关表的字段值 #1183\r\n\t\t\t\t\t\tvar record = objectCollection.findOne(newRecordId);\r\n\t\t\t\t\t\tself.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// 附件同步\r\n\t\t\t\t\tself.syncAttach(sync_attachment, insId, spaceId, newRecordId, objectName);\r\n\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error(error.stack);\r\n\r\n\t\t\t\t\tobjectCollection.remove({\r\n\t\t\t\t\t\t_id: newRecordId,\r\n\t\t\t\t\t\tspace: spaceId\r\n\t\t\t\t\t});\r\n\t\t\t\t\tCreator.getCollection('instances').update(ins._id, {\r\n\t\t\t\t\t\t$pull: {\r\n\t\t\t\t\t\t\trecord_ids: {\r\n\t\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\t\tids: [newRecordId]\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\r\n\t\t\t\t\t\t'parent': {\r\n\t\t\t\t\t\t\to: objectName,\r\n\t\t\t\t\t\t\tids: [newRecordId]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\tcfs.files.remove({\r\n\t\t\t\t\t\t'metadata.record_id': newRecordId\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\tthrow new Error(error);\r\n\t\t\t\t}\r\n\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tif (doc._id) {\r\n\t\t\tInstanceRecordQueue.collection.update(doc._id, {\r\n\t\t\t\t$set: {\r\n\t\t\t\t\t'info.sync_date': new Date()\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// Universal send function\r\n\tvar _querySend = function (doc) {\r\n\r\n\t\tif (self.sendDoc) {\r\n\t\t\tself.sendDoc(doc);\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tdoc: [doc._id]\r\n\t\t};\r\n\t};\r\n\r\n\tself.serverSend = function (doc) {\r\n\t\tdoc = doc || {};\r\n\t\treturn _querySend(doc);\r\n\t};\r\n\r\n\r\n\t// This interval will allow only one doc to be sent at a time, it\r\n\t// will check for new docs at every `options.sendInterval`\r\n\t// (default interval is 15000 ms)\r\n\t//\r\n\t// It looks in docs collection to see if theres any pending\r\n\t// docs, if so it will try to reserve the pending doc.\r\n\t// If successfully reserved the send is started.\r\n\t//\r\n\t// If doc.query is type string, it's assumed to be a json string\r\n\t// version of the query selector. Making it able to carry `$` properties in\r\n\t// the mongo collection.\r\n\t//\r\n\t// Pr. default docs are removed from the collection after send have\r\n\t// completed. Setting `options.keepDocs` will update and keep the\r\n\t// doc eg. if needed for historical reasons.\r\n\t//\r\n\t// After the send have completed a \"send\" event will be emitted with a\r\n\t// status object containing doc id and the send result object.\r\n\t//\r\n\tvar isSendingDoc = false;\r\n\r\n\tif (options.sendInterval !== null) {\r\n\r\n\t\t// This will require index since we sort docs by createdAt\r\n\t\tInstanceRecordQueue.collection._ensureIndex({\r\n\t\t\tcreatedAt: 1\r\n\t\t});\r\n\t\tInstanceRecordQueue.collection._ensureIndex({\r\n\t\t\tsent: 1\r\n\t\t});\r\n\t\tInstanceRecordQueue.collection._ensureIndex({\r\n\t\t\tsending: 1\r\n\t\t});\r\n\r\n\r\n\t\tvar sendDoc = function (doc) {\r\n\t\t\t// Reserve doc\r\n\t\t\tvar now = +new Date();\r\n\t\t\tvar timeoutAt = now + options.sendTimeout;\r\n\t\t\tvar reserved = InstanceRecordQueue.collection.update({\r\n\t\t\t\t_id: doc._id,\r\n\t\t\t\tsent: false, // xxx: need to make sure this is set on create\r\n\t\t\t\tsending: {\r\n\t\t\t\t\t$lt: now\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t$set: {\r\n\t\t\t\t\tsending: timeoutAt,\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\t// Make sure we only handle docs reserved by this\r\n\t\t\t// instance\r\n\t\t\tif (reserved) {\r\n\r\n\t\t\t\t// Send\r\n\t\t\t\tvar result = InstanceRecordQueue.serverSend(doc);\r\n\r\n\t\t\t\tif (!options.keepDocs) {\r\n\t\t\t\t\t// Pr. Default we will remove docs\r\n\t\t\t\t\tInstanceRecordQueue.collection.remove({\r\n\t\t\t\t\t\t_id: doc._id\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// Update\r\n\t\t\t\t\tInstanceRecordQueue.collection.update({\r\n\t\t\t\t\t\t_id: doc._id\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t// Mark as sent\r\n\t\t\t\t\t\t\tsent: true,\r\n\t\t\t\t\t\t\t// Set the sent date\r\n\t\t\t\t\t\t\tsentAt: new Date(),\r\n\t\t\t\t\t\t\t// Not being sent anymore\r\n\t\t\t\t\t\t\tsending: 0\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// // Emit the send\r\n\t\t\t\t// self.emit('send', {\r\n\t\t\t\t// \tdoc: doc._id,\r\n\t\t\t\t// \tresult: result\r\n\t\t\t\t// });\r\n\r\n\t\t\t} // Else could not reserve\r\n\t\t}; // EO sendDoc\r\n\r\n\t\tsendWorker(function () {\r\n\r\n\t\t\tif (isSendingDoc) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// Set send fence\r\n\t\t\tisSendingDoc = true;\r\n\r\n\t\t\tvar batchSize = options.sendBatchSize || 1;\r\n\r\n\t\t\tvar now = +new Date();\r\n\r\n\t\t\t// Find docs that are not being or already sent\r\n\t\t\tvar pendingDocs = InstanceRecordQueue.collection.find({\r\n\t\t\t\t$and: [\r\n\t\t\t\t\t// Message is not sent\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tsent: false\r\n\t\t\t\t\t},\r\n\t\t\t\t\t// And not being sent by other instances\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tsending: {\r\n\t\t\t\t\t\t\t$lt: now\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\t// And no error\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\terrMsg: {\r\n\t\t\t\t\t\t\t$exists: false\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t]\r\n\t\t\t}, {\r\n\t\t\t\t// Sort by created date\r\n\t\t\t\tsort: {\r\n\t\t\t\t\tcreatedAt: 1\r\n\t\t\t\t},\r\n\t\t\t\tlimit: batchSize\r\n\t\t\t});\r\n\r\n\t\t\tpendingDocs.forEach(function (doc) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tsendDoc(doc);\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.error(error.stack);\r\n\t\t\t\t\tconsole.log('InstanceRecordQueue: Could not send doc id: \"' + doc._id + '\", Error: ' + error.message);\r\n\t\t\t\t\tInstanceRecordQueue.collection.update({\r\n\t\t\t\t\t\t_id: doc._id\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t$set: {\r\n\t\t\t\t\t\t\t// error message\r\n\t\t\t\t\t\t\terrMsg: error.message\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}); // EO forEach\r\n\r\n\t\t\t// Remove the send fence\r\n\t\t\tisSendingDoc = false;\r\n\t\t}, options.sendInterval || 15000); // Default every 15th sec\r\n\r\n\t} else {\r\n\t\tif (InstanceRecordQueue.debug) {\r\n\t\t\tconsole.log('InstanceRecordQueue: Send server is disabled');\r\n\t\t}\r\n\t}\r\n\r\n};","Meteor.startup ->\r\n\tif Meteor.settings.cron?.instancerecordqueue_interval\r\n\t\tInstanceRecordQueue.Configure\r\n\t\t\tsendInterval: Meteor.settings.cron.instancerecordqueue_interval\r\n\t\t\tsendBatchSize: 10\r\n\t\t\tkeepDocs: true\r\n","Meteor.startup(function() {\n  var ref;\n  if ((ref = Meteor.settings.cron) != null ? ref.instancerecordqueue_interval : void 0) {\n    return InstanceRecordQueue.Configure({\n      sendInterval: Meteor.settings.cron.instancerecordqueue_interval,\n      sendBatchSize: 10,\n      keepDocs: true\n    });\n  }\n});\n","import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\t\"eval\": \"^0.1.2\"\r\n}, 'steedos:instance-record-queue');\r\n"]}