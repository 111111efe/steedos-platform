{"version":3,"sources":["meteor://💻app/packages/steedos:instance-record-queue/lib/common/main.js","meteor://💻app/packages/steedos:instance-record-queue/lib/common/docs.js","meteor://💻app/packages/steedos:instance-record-queue/lib/server/api.js","meteor://💻app/packages/steedos_instance-record-queue/server/startup.coffee","meteor://💻app/server/startup.coffee","meteor://💻app/packages/steedos:instance-record-queue/server/checkNpm.js"],"names":["InstanceRecordQueue","EventState","collection","db","instance_record_queue","Mongo","Collection","_validateDocument","doc","check","info","Object","sent","Match","Optional","Boolean","sending","Integer","createdAt","Date","createdBy","OneOf","String","send","options","currentUser","Meteor","isClient","userId","isServer","_","extend","test","pick","insert","_eval","require","isConfigured","sendWorker","task","interval","debug","console","log","setInterval","error","message","Configure","self","sendTimeout","Error","syncAttach","sync_attachment","insId","spaceId","newRecordId","objectName","cfs","instances","find","forEach","f","newFile","FS","File","cmsFileId","Creator","getCollection","_makeNewID","attachData","createReadStream","type","original","err","reason","name","size","metadata","owner","owner_name","space","record_id","object_name","parent","fileObj","files","_id","o","ids","extention","extension","versions","created_by","modified_by","parents","includes","push","current","update","$set","$addToSet","syncInsFields","syncValues","field_map_back","values","ins","objectInfo","field_map_back_script","record","obj","tableFieldCodes","tableFieldMap","form","findOne","formFields","form_version","fields","formVersion","historys","h","objectFields","objectFieldKeys","keys","fm","workflow_field","indexOf","object_field","wTableCode","split","oTableCode","hasOwnProperty","isArray","JSON","stringify","workflow_table_field_code","object_table_field_code","wField","each","ff","code","oField","is_multiselect","multiple","reference_to","isString","oCollection","referObject","getObject","referData","nameFieldKey","NAME_FIELD_KEY","selector","tmp_field_value","temObjFields","length","objField","referObjField","referSetObj","startsWith","insField","uniq","tfc","c","parse","tr","newTr","v","k","tfm","oTdCode","isEmpty","evalFieldMapBackScript","filterObj","script","func","isObject","sendDoc","instance_id","records","flow","applicant","ow","flow_id","objectCollection","$in","setObj","locked","instance_state","state","final_decision","remove","stack","newObj","r","$push","record_ids","$pull","_querySend","serverSend","isSendingDoc","sendInterval","_ensureIndex","now","timeoutAt","reserved","$lt","result","keepDocs","sentAt","batchSize","sendBatchSize","pendingDocs","$and","errMsg","$exists","sort","limit","startup","ref","settings","cron","instancerecordqueue_interval","checkNpmVersions","module","link"],"mappings":"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","file":"/packages/steedos_instance-record-queue.js","sourcesContent":["InstanceRecordQueue = new EventState();","InstanceRecordQueue.collection = db.instance_record_queue = new Mongo.Collection('instance_record_queue');\n\nvar _validateDocument = function(doc) {\n\n\tcheck(doc, {\n\t\tinfo: Object,\n\t\tsent: Match.Optional(Boolean),\n\t\tsending: Match.Optional(Match.Integer),\n\t\tcreatedAt: Date,\n\t\tcreatedBy: Match.OneOf(String, null)\n\t});\n\n};\n\nInstanceRecordQueue.send = function(options) {\n\tvar currentUser = Meteor.isClient && Meteor.userId && Meteor.userId() || Meteor.isServer && (options.createdBy || '<SERVER>') || null\n\tvar doc = _.extend({\n\t\tcreatedAt: new Date(),\n\t\tcreatedBy: currentUser\n\t});\n\n\tif (Match.test(options, Object)) {\n\t\tdoc.info = _.pick(options, 'instance_id', 'records', 'sync_date', 'instance_finish_date', 'step_name');\n\t}\n\n\tdoc.sent = false;\n\tdoc.sending = 0;\n\n\t_validateDocument(doc);\n\n\treturn InstanceRecordQueue.collection.insert(doc);\n};","var _eval = require('eval');\nvar isConfigured = false;\nvar sendWorker = function (task, interval) {\n\n\tif (InstanceRecordQueue.debug) {\n\t\tconsole.log('InstanceRecordQueue: Send worker started, using interval: ' + interval);\n\t}\n\n\treturn Meteor.setInterval(function () {\n\t\ttry {\n\t\t\ttask();\n\t\t} catch (error) {\n\t\t\tconsole.log('InstanceRecordQueue: Error while sending: ' + error.message);\n\t\t}\n\t}, interval);\n};\n\n/*\n\toptions: {\n\t\t// Controls the sending interval\n\t\tsendInterval: Match.Optional(Number),\n\t\t// Controls the sending batch size per interval\n\t\tsendBatchSize: Match.Optional(Number),\n\t\t// Allow optional keeping notifications in collection\n\t\tkeepDocs: Match.Optional(Boolean)\n\t}\n*/\nInstanceRecordQueue.Configure = function (options) {\n\tvar self = this;\n\toptions = _.extend({\n\t\tsendTimeout: 60000, // Timeout period\n\t}, options);\n\n\t// Block multiple calls\n\tif (isConfigured) {\n\t\tthrow new Error('InstanceRecordQueue.Configure should not be called more than once!');\n\t}\n\n\tisConfigured = true;\n\n\t// Add debug info\n\tif (InstanceRecordQueue.debug) {\n\t\tconsole.log('InstanceRecordQueue.Configure', options);\n\t}\n\n\tself.syncAttach = function (sync_attachment, insId, spaceId, newRecordId, objectName) {\n\t\tif (sync_attachment == \"lastest\") {\n\t\t\tcfs.instances.find({\n\t\t\t\t'metadata.instance': insId,\n\t\t\t\t'metadata.current': true\n\t\t\t}).forEach(function (f) {\n\t\t\t\tvar newFile = new FS.File(),\n\t\t\t\t\tcmsFileId = Creator.getCollection('cms_files')._makeNewID();\n\n\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\n\t\t\t\t\ttype: f.original.type\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\n\t\t\t\t\t}\n\t\t\t\t\tnewFile.name(f.name());\n\t\t\t\t\tnewFile.size(f.size());\n\t\t\t\t\tvar metadata = {\n\t\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\t\towner_name: f.metadata.owner_name,\n\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\trecord_id: newRecordId,\n\t\t\t\t\t\tobject_name: objectName,\n\t\t\t\t\t\tparent: cmsFileId\n\t\t\t\t\t};\n\n\t\t\t\t\tnewFile.metadata = metadata;\n\t\t\t\t\tvar fileObj = cfs.files.insert(newFile);\n\t\t\t\t\tif (fileObj) {\n\t\t\t\t\t\tCreator.getCollection('cms_files').insert({\n\t\t\t\t\t\t\t_id: cmsFileId,\n\t\t\t\t\t\t\tparent: {\n\t\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tsize: fileObj.size(),\n\t\t\t\t\t\t\tname: fileObj.name(),\n\t\t\t\t\t\t\textention: fileObj.extension(),\n\t\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\t\tversions: [fileObj._id],\n\t\t\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\t\t\tcreated_by: f.metadata.owner,\n\t\t\t\t\t\t\tmodified_by: f.metadata.owner\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t} else if (sync_attachment == \"all\") {\n\t\t\tvar parents = [];\n\t\t\tcfs.instances.find({\n\t\t\t\t'metadata.instance': insId\n\t\t\t}).forEach(function (f) {\n\t\t\t\tvar newFile = new FS.File(),\n\t\t\t\t\tcmsFileId = f.metadata.parent;\n\n\t\t\t\tif (!parents.includes(cmsFileId)) {\n\t\t\t\t\tparents.push(cmsFileId);\n\t\t\t\t\tCreator.getCollection('cms_files').insert({\n\t\t\t\t\t\t_id: cmsFileId,\n\t\t\t\t\t\tparent: {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t},\n\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\tversions: [],\n\t\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\t\tcreated_by: f.metadata.owner,\n\t\t\t\t\t\tmodified_by: f.metadata.owner\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\n\t\t\t\t\ttype: f.original.type\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\n\t\t\t\t\t}\n\t\t\t\t\tnewFile.name(f.name());\n\t\t\t\t\tnewFile.size(f.size());\n\t\t\t\t\tvar metadata = {\n\t\t\t\t\t\towner: f.metadata.owner,\n\t\t\t\t\t\towner_name: f.metadata.owner_name,\n\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\trecord_id: newRecordId,\n\t\t\t\t\t\tobject_name: objectName,\n\t\t\t\t\t\tparent: cmsFileId\n\t\t\t\t\t};\n\n\t\t\t\t\tnewFile.metadata = metadata;\n\t\t\t\t\tvar fileObj = cfs.files.insert(newFile);\n\t\t\t\t\tif (fileObj) {\n\n\t\t\t\t\t\tif (f.metadata.current == true) {\n\t\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\n\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\tsize: fileObj.size(),\n\t\t\t\t\t\t\t\t\tname: fileObj.name(),\n\t\t\t\t\t\t\t\t\textention: fileObj.extension(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t$addToSet: {\n\t\t\t\t\t\t\t\t\tversions: fileObj._id\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tCreator.getCollection('cms_files').update(cmsFileId, {\n\t\t\t\t\t\t\t\t$addToSet: {\n\t\t\t\t\t\t\t\t\tversions: fileObj._id\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\t}\n\n\tself.syncInsFields = ['name', 'submitter_name', 'applicant_name', 'applicant_organization_name', 'applicant_organization_fullname', 'state',\n\t\t'current_step_name', 'flow_name', 'category_name', 'submit_date', 'finish_date', 'final_decision', 'applicant_organization', 'applicant_company'\n\t];\n\tself.syncValues = function (field_map_back, values, ins, objectInfo, field_map_back_script, record) {\n\t\tvar\n\t\t\tobj = {},\n\t\t\ttableFieldCodes = [],\n\t\t\ttableFieldMap = [];\n\n\t\tfield_map_back = field_map_back || [];\n\n\t\tvar spaceId = ins.space;\n\n\t\tvar form = Creator.getCollection(\"forms\").findOne(ins.form);\n\t\tvar formFields = null;\n\t\tif (form.current._id === ins.form_version) {\n\t\t\tformFields = form.current.fields || [];\n\t\t} else {\n\t\t\tvar formVersion = _.find(form.historys, function (h) {\n\t\t\t\treturn h._id === ins.form_version;\n\t\t\t})\n\t\t\tformFields = formVersion ? formVersion.fields : [];\n\t\t}\n\n\t\tvar objectFields = objectInfo.fields;\n\t\tvar objectFieldKeys = _.keys(objectFields);\n\n\t\tfield_map_back.forEach(function (fm) {\n\t\t\t// 判断是否是子表字段\n\t\t\tif (fm.workflow_field.indexOf('.$.') > 0 && fm.object_field.indexOf('.$.') > 0) {\n\t\t\t\tvar wTableCode = fm.workflow_field.split('.$.')[0];\n\t\t\t\tvar oTableCode = fm.object_field.split('.$.')[0];\n\t\t\t\tif (values.hasOwnProperty(wTableCode) && _.isArray(values[wTableCode])) {\n\t\t\t\t\ttableFieldCodes.push(JSON.stringify({\n\t\t\t\t\t\tworkflow_table_field_code: wTableCode,\n\t\t\t\t\t\tobject_table_field_code: oTableCode\n\t\t\t\t\t}));\n\t\t\t\t\ttableFieldMap.push(fm);\n\t\t\t\t}\n\n\t\t\t} else if (values.hasOwnProperty(fm.workflow_field)) {\n\t\t\t\tvar wField = null;\n\n\t\t\t\t_.each(formFields, function (ff) {\n\t\t\t\t\tif (!wField) {\n\t\t\t\t\t\tif (ff.code === fm.workflow_field) {\n\t\t\t\t\t\t\twField = ff;\n\t\t\t\t\t\t} else if (ff.type === 'section') {\n\t\t\t\t\t\t\t_.each(ff.fields, function (f) {\n\t\t\t\t\t\t\t\tif (!wField) {\n\t\t\t\t\t\t\t\t\tif (f.code === fm.workflow_field) {\n\t\t\t\t\t\t\t\t\t\twField = f;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\n\t\t\t\tvar oField = objectFields[fm.object_field];\n\n\t\t\t\tif (oField) {\n\t\t\t\t\tif (!wField) {\n\t\t\t\t\t\tconsole.log('fm.workflow_field: ', fm.workflow_field)\n\t\t\t\t\t}\n\t\t\t\t\t// 表单选人选组字段 至 对象 lookup master_detail类型字段同步\n\t\t\t\t\tif (!wField.is_multiselect && ['user', 'group'].includes(wField.type) && !oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && ['users', 'organizations'].includes(oField.reference_to)) {\n\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field]['id'];\n\t\t\t\t\t} else if (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to) && _.isString(values[fm.workflow_field])) {\n\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\t\tvar referObject = Creator.getObject(oField.reference_to, spaceId)\n\t\t\t\t\t\tif (oCollection && referObject) {\n\t\t\t\t\t\t\t// 先认为此值是referObject _id字段值\n\t\t\t\t\t\t\tvar referData = oCollection.findOne(values[fm.workflow_field], {\n\t\t\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\t\t\t_id: 1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (referData) {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// 其次认为此值是referObject NAME_FIELD_KEY值\n\t\t\t\t\t\t\tif (!referData) {\n\t\t\t\t\t\t\t\tvar nameFieldKey = referObject.NAME_FIELD_KEY;\n\t\t\t\t\t\t\t\tvar selector = {};\n\t\t\t\t\t\t\t\tselector[nameFieldKey] = values[fm.workflow_field];\n\t\t\t\t\t\t\t\treferData = oCollection.findOne(selector, {\n\t\t\t\t\t\t\t\t\tfields: {\n\t\t\t\t\t\t\t\t\t\t_id: 1\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tif (referData) {\n\t\t\t\t\t\t\t\t\tobj[fm.object_field] = referData._id;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (oField.type === \"boolean\") {\n\t\t\t\t\t\t\tvar tmp_field_value = values[fm.workflow_field];\n\t\t\t\t\t\t\tif (['true', '是'].includes(tmp_field_value)) {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = true;\n\t\t\t\t\t\t\t} else if (['false', '否'].includes(tmp_field_value)) {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = false;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tobj[fm.object_field] = tmp_field_value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tobj[fm.object_field] = values[fm.workflow_field];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (fm.object_field.indexOf('.') > -1) {\n\t\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\n\t\t\t\t\t\tif (temObjFields.length === 2) {\n\t\t\t\t\t\t\tvar objField = temObjFields[0];\n\t\t\t\t\t\t\tvar referObjField = temObjFields[1];\n\t\t\t\t\t\t\tvar oField = objectFields[objField];\n\t\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\n\t\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\n\t\t\t\t\t\t\t\t\tvar referSetObj = {};\n\t\t\t\t\t\t\t\t\treferSetObj[referObjField] = values[fm.workflow_field];\n\t\t\t\t\t\t\t\t\toCollection.update(record[objField], {\n\t\t\t\t\t\t\t\t\t\t$set: referSetObj\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\tif (fm.workflow_field.startsWith('instance.')) {\n\t\t\t\t\tvar insField = fm.workflow_field.split('instance.')[1];\n\t\t\t\t\tif (self.syncInsFields.includes(insField)) {\n\t\t\t\t\t\tif (fm.object_field.indexOf('.') < 0) {\n\t\t\t\t\t\t\tobj[fm.object_field] = ins[insField];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvar temObjFields = fm.object_field.split('.');\n\t\t\t\t\t\t\tif (temObjFields.length === 2) {\n\t\t\t\t\t\t\t\tvar objField = temObjFields[0];\n\t\t\t\t\t\t\t\tvar referObjField = temObjFields[1];\n\t\t\t\t\t\t\t\tvar oField = objectFields[objField];\n\t\t\t\t\t\t\t\tif (!oField.multiple && ['lookup', 'master_detail'].includes(oField.type) && _.isString(oField.reference_to)) {\n\t\t\t\t\t\t\t\t\tvar oCollection = Creator.getCollection(oField.reference_to, spaceId)\n\t\t\t\t\t\t\t\t\tif (oCollection && record && record[objField]) {\n\t\t\t\t\t\t\t\t\t\tvar referSetObj = {};\n\t\t\t\t\t\t\t\t\t\treferSetObj[referObjField] = ins[insField];\n\t\t\t\t\t\t\t\t\t\toCollection.update(record[objField], {\n\t\t\t\t\t\t\t\t\t\t\t$set: referSetObj\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t} else {\n\t\t\t\t\tif (ins[fm.workflow_field]) {\n\t\t\t\t\t\tobj[fm.object_field] = ins[fm.workflow_field];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\n\t\t_.uniq(tableFieldCodes).forEach(function (tfc) {\n\t\t\tvar c = JSON.parse(tfc);\n\t\t\tobj[c.object_table_field_code] = [];\n\t\t\tvalues[c.workflow_table_field_code].forEach(function (tr) {\n\t\t\t\tvar newTr = {};\n\t\t\t\t_.each(tr, function (v, k) {\n\t\t\t\t\ttableFieldMap.forEach(function (tfm) {\n\t\t\t\t\t\tif (tfm.workflow_field == (c.workflow_table_field_code + '.$.' + k)) {\n\t\t\t\t\t\t\tvar oTdCode = tfm.object_field.split('.$.')[1];\n\t\t\t\t\t\t\tnewTr[oTdCode] = v;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\tif (!_.isEmpty(newTr)) {\n\t\t\t\t\tobj[c.object_table_field_code].push(newTr);\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\n\n\n\t\tif (field_map_back_script) {\n\t\t\t_.extend(obj, self.evalFieldMapBackScript(field_map_back_script, ins));\n\t\t}\n\n\t\t// 过滤掉非法的key\n\t\tvar filterObj = {};\n\t\t_.each(_.keys(obj), function (k) {\n\t\t\tif (objectFieldKeys.includes(k)) {\n\t\t\t\tfilterObj[k] = obj[k];\n\t\t\t}\n\t\t})\n\n\t\treturn filterObj;\n\t}\n\n\tself.evalFieldMapBackScript = function (field_map_back_script, ins) {\n\t\tvar script = \"module.exports = function (instance) { \" + field_map_back_script + \" }\";\n\t\tvar func = _eval(script, \"field_map_script\");\n\t\tvar values = func(ins);\n\t\tif (_.isObject(values)) {\n\t\t\treturn values;\n\t\t} else {\n\t\t\tconsole.error(\"evalFieldMapBackScript: 脚本返回值类型不是对象\");\n\t\t}\n\t\treturn {}\n\t}\n\n\tself.sendDoc = function (doc) {\n\t\tif (InstanceRecordQueue.debug) {\n\t\t\tconsole.log(\"sendDoc\");\n\t\t\tconsole.log(doc);\n\t\t}\n\n\t\tvar insId = doc.info.instance_id,\n\t\t\trecords = doc.info.records;\n\t\tvar fields = {\n\t\t\tflow: 1,\n\t\t\tvalues: 1,\n\t\t\tapplicant: 1,\n\t\t\tspace: 1,\n\t\t\tform: 1,\n\t\t\tform_version: 1\n\t\t};\n\t\tself.syncInsFields.forEach(function (f) {\n\t\t\tfields[f] = 1;\n\t\t})\n\t\tvar ins = Creator.getCollection('instances').findOne(insId, {\n\t\t\tfields: fields\n\t\t});\n\t\tvar values = ins.values,\n\t\t\tspaceId = ins.space;\n\n\t\tif (records && !_.isEmpty(records)) {\n\t\t\t// 此情况属于从creator中发起审批\n\t\t\tvar objectName = records[0].o;\n\t\t\tvar ow = Creator.getCollection('object_workflows').findOne({\n\t\t\t\tobject_name: objectName,\n\t\t\t\tflow_id: ins.flow\n\t\t\t});\n\t\t\tvar\n\t\t\t\tobjectCollection = Creator.getCollection(objectName, spaceId),\n\t\t\t\tsync_attachment = ow.sync_attachment;\n\t\t\tvar objectInfo = Creator.getObject(objectName, spaceId);\n\t\t\tobjectCollection.find({\n\t\t\t\t_id: {\n\t\t\t\t\t$in: records[0].ids\n\t\t\t\t}\n\t\t\t}).forEach(function (record) {\n\t\t\t\t// 附件同步\n\t\t\t\ttry {\n\t\t\t\t\tvar setObj = self.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record);\n\t\t\t\t\tsetObj.locked = false;\n\n\t\t\t\t\tvar instance_state = ins.state;\n\t\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\n\t\t\t\t\t\tinstance_state = ins.final_decision;\n\t\t\t\t\t}\n\t\t\t\t\tsetObj['instances.$.state'] = setObj.instance_state = instance_state;\n\n\t\t\t\t\tobjectCollection.update({\n\t\t\t\t\t\t_id: record._id,\n\t\t\t\t\t\t'instances._id': insId\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: setObj\n\t\t\t\t\t})\n\t\t\t\t\t// 以最终申请单附件为准，旧的record中附件删除\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t\t'parent': {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [record._id]\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tcfs.files.remove({\n\t\t\t\t\t\t'metadata.record_id': record._id\n\t\t\t\t\t})\n\t\t\t\t\t// 同步新附件\n\t\t\t\t\tself.syncAttach(sync_attachment, insId, record.space, record._id, objectName);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(error.stack);\n\t\t\t\t\tobjectCollection.update({\n\t\t\t\t\t\t_id: record._id,\n\t\t\t\t\t\t'instances._id': insId\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t'instances.$.state': 'pending',\n\t\t\t\t\t\t\t'locked': true,\n\t\t\t\t\t\t\t'instance_state': 'pending'\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t\t'parent': {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [record._id]\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tcfs.files.remove({\n\t\t\t\t\t\t'metadata.record_id': record._id\n\t\t\t\t\t})\n\n\t\t\t\t\tthrow new Error(error);\n\t\t\t\t}\n\n\t\t\t})\n\t\t} else {\n\t\t\t// 此情况属于从apps中发起审批\n\t\t\tCreator.getCollection('object_workflows').find({\n\t\t\t\tflow_id: ins.flow\n\t\t\t}).forEach(function (ow) {\n\t\t\t\ttry {\n\t\t\t\t\tvar\n\t\t\t\t\t\tobjectCollection = Creator.getCollection(ow.object_name, spaceId),\n\t\t\t\t\t\tsync_attachment = ow.sync_attachment,\n\t\t\t\t\t\tnewRecordId = objectCollection._makeNewID(),\n\t\t\t\t\t\tobjectName = ow.object_name;\n\n\t\t\t\t\tvar objectInfo = Creator.getObject(ow.object_name, spaceId);\n\n\t\t\t\t\tvar newObj = self.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script);\n\n\t\t\t\t\tnewObj._id = newRecordId;\n\t\t\t\t\tnewObj.space = spaceId;\n\t\t\t\t\tnewObj.name = newObj.name || ins.name;\n\n\t\t\t\t\tvar instance_state = ins.state;\n\t\t\t\t\tif (ins.state === 'completed' && ins.final_decision) {\n\t\t\t\t\t\tinstance_state = ins.final_decision;\n\t\t\t\t\t}\n\t\t\t\t\tnewObj.instances = [{\n\t\t\t\t\t\t_id: insId,\n\t\t\t\t\t\tstate: instance_state\n\t\t\t\t\t}];\n\t\t\t\t\tnewObj.instance_state = instance_state;\n\n\t\t\t\t\tnewObj.owner = ins.applicant;\n\t\t\t\t\tnewObj.created_by = ins.applicant;\n\t\t\t\t\tnewObj.modified_by = ins.applicant;\n\t\t\t\t\tvar r = objectCollection.insert(newObj);\n\t\t\t\t\tif (r) {\n\t\t\t\t\t\tCreator.getCollection('instances').update(ins._id, {\n\t\t\t\t\t\t\t$push: {\n\t\t\t\t\t\t\t\trecord_ids: {\n\t\t\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t// workflow里发起审批后，同步时也可以修改相关表的字段值 #1183\n\t\t\t\t\t\tvar record = objectCollection.findOne(newRecordId);\n\t\t\t\t\t\tself.syncValues(ow.field_map_back, values, ins, objectInfo, ow.field_map_back_script, record);\n\t\t\t\t\t}\n\n\t\t\t\t\t// 附件同步\n\t\t\t\t\tself.syncAttach(sync_attachment, insId, spaceId, newRecordId, objectName);\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(error.stack);\n\n\t\t\t\t\tobjectCollection.remove({\n\t\t\t\t\t\t_id: newRecordId,\n\t\t\t\t\t\tspace: spaceId\n\t\t\t\t\t});\n\t\t\t\t\tCreator.getCollection('instances').update(ins._id, {\n\t\t\t\t\t\t$pull: {\n\t\t\t\t\t\t\trecord_ids: {\n\t\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tCreator.getCollection('cms_files').remove({\n\t\t\t\t\t\t'parent': {\n\t\t\t\t\t\t\to: objectName,\n\t\t\t\t\t\t\tids: [newRecordId]\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\tcfs.files.remove({\n\t\t\t\t\t\t'metadata.record_id': newRecordId\n\t\t\t\t\t})\n\n\t\t\t\t\tthrow new Error(error);\n\t\t\t\t}\n\n\t\t\t})\n\t\t}\n\n\t\tInstanceRecordQueue.collection.update(doc._id, {\n\t\t\t$set: {\n\t\t\t\t'info.sync_date': new Date()\n\t\t\t}\n\t\t})\n\n\t}\n\n\t// Universal send function\n\tvar _querySend = function (doc) {\n\n\t\tif (self.sendDoc) {\n\t\t\tself.sendDoc(doc);\n\t\t}\n\n\t\treturn {\n\t\t\tdoc: [doc._id]\n\t\t};\n\t};\n\n\tself.serverSend = function (doc) {\n\t\tdoc = doc || {};\n\t\treturn _querySend(doc);\n\t};\n\n\n\t// This interval will allow only one doc to be sent at a time, it\n\t// will check for new docs at every `options.sendInterval`\n\t// (default interval is 15000 ms)\n\t//\n\t// It looks in docs collection to see if theres any pending\n\t// docs, if so it will try to reserve the pending doc.\n\t// If successfully reserved the send is started.\n\t//\n\t// If doc.query is type string, it's assumed to be a json string\n\t// version of the query selector. Making it able to carry `$` properties in\n\t// the mongo collection.\n\t//\n\t// Pr. default docs are removed from the collection after send have\n\t// completed. Setting `options.keepDocs` will update and keep the\n\t// doc eg. if needed for historical reasons.\n\t//\n\t// After the send have completed a \"send\" event will be emitted with a\n\t// status object containing doc id and the send result object.\n\t//\n\tvar isSendingDoc = false;\n\n\tif (options.sendInterval !== null) {\n\n\t\t// This will require index since we sort docs by createdAt\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tcreatedAt: 1\n\t\t});\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tsent: 1\n\t\t});\n\t\tInstanceRecordQueue.collection._ensureIndex({\n\t\t\tsending: 1\n\t\t});\n\n\n\t\tvar sendDoc = function (doc) {\n\t\t\t// Reserve doc\n\t\t\tvar now = +new Date();\n\t\t\tvar timeoutAt = now + options.sendTimeout;\n\t\t\tvar reserved = InstanceRecordQueue.collection.update({\n\t\t\t\t_id: doc._id,\n\t\t\t\tsent: false, // xxx: need to make sure this is set on create\n\t\t\t\tsending: {\n\t\t\t\t\t$lt: now\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\t$set: {\n\t\t\t\t\tsending: timeoutAt,\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Make sure we only handle docs reserved by this\n\t\t\t// instance\n\t\t\tif (reserved) {\n\n\t\t\t\t// Send\n\t\t\t\tvar result = InstanceRecordQueue.serverSend(doc);\n\n\t\t\t\tif (!options.keepDocs) {\n\t\t\t\t\t// Pr. Default we will remove docs\n\t\t\t\t\tInstanceRecordQueue.collection.remove({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t});\n\t\t\t\t} else {\n\n\t\t\t\t\t// Update\n\t\t\t\t\tInstanceRecordQueue.collection.update({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t// Mark as sent\n\t\t\t\t\t\t\tsent: true,\n\t\t\t\t\t\t\t// Set the sent date\n\t\t\t\t\t\t\tsentAt: new Date(),\n\t\t\t\t\t\t\t// Not being sent anymore\n\t\t\t\t\t\t\tsending: 0\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t}\n\n\t\t\t\t// // Emit the send\n\t\t\t\t// self.emit('send', {\n\t\t\t\t// \tdoc: doc._id,\n\t\t\t\t// \tresult: result\n\t\t\t\t// });\n\n\t\t\t} // Else could not reserve\n\t\t}; // EO sendDoc\n\n\t\tsendWorker(function () {\n\n\t\t\tif (isSendingDoc) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// Set send fence\n\t\t\tisSendingDoc = true;\n\n\t\t\tvar batchSize = options.sendBatchSize || 1;\n\n\t\t\tvar now = +new Date();\n\n\t\t\t// Find docs that are not being or already sent\n\t\t\tvar pendingDocs = InstanceRecordQueue.collection.find({\n\t\t\t\t$and: [\n\t\t\t\t\t// Message is not sent\n\t\t\t\t\t{\n\t\t\t\t\t\tsent: false\n\t\t\t\t\t},\n\t\t\t\t\t// And not being sent by other instances\n\t\t\t\t\t{\n\t\t\t\t\t\tsending: {\n\t\t\t\t\t\t\t$lt: now\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t// And no error\n\t\t\t\t\t{\n\t\t\t\t\t\terrMsg: {\n\t\t\t\t\t\t\t$exists: false\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t}, {\n\t\t\t\t// Sort by created date\n\t\t\t\tsort: {\n\t\t\t\t\tcreatedAt: 1\n\t\t\t\t},\n\t\t\t\tlimit: batchSize\n\t\t\t});\n\n\t\t\tpendingDocs.forEach(function (doc) {\n\t\t\t\ttry {\n\t\t\t\t\tsendDoc(doc);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(error.stack);\n\t\t\t\t\tconsole.log('InstanceRecordQueue: Could not send doc id: \"' + doc._id + '\", Error: ' + error.message);\n\t\t\t\t\tInstanceRecordQueue.collection.update({\n\t\t\t\t\t\t_id: doc._id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t// error message\n\t\t\t\t\t\t\terrMsg: error.message\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}); // EO forEach\n\n\t\t\t// Remove the send fence\n\t\t\tisSendingDoc = false;\n\t\t}, options.sendInterval || 15000); // Default every 15th sec\n\n\t} else {\n\t\tif (InstanceRecordQueue.debug) {\n\t\t\tconsole.log('InstanceRecordQueue: Send server is disabled');\n\t\t}\n\t}\n\n};","Meteor.startup ->\n\tif Meteor.settings.cron?.instancerecordqueue_interval\n\t\tInstanceRecordQueue.Configure\n\t\t\tsendInterval: Meteor.settings.cron.instancerecordqueue_interval\n\t\t\tsendBatchSize: 10\n\t\t\tkeepDocs: true\n","Meteor.startup(function() {\n  var ref;\n  if ((ref = Meteor.settings.cron) != null ? ref.instancerecordqueue_interval : void 0) {\n    return InstanceRecordQueue.Configure({\n      sendInterval: Meteor.settings.cron.instancerecordqueue_interval,\n      sendBatchSize: 10,\n      keepDocs: true\n    });\n  }\n});\n","import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t\"eval\": \"^0.1.2\"\n}, 'steedos:instance-record-queue');\n"]}