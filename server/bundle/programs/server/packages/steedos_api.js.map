{"version":3,"sources":["meteor://💻app/packages/steedos:api/checkNpm.js","meteor://💻app/packages/steedos_api/lib/restivus/auth.coffee","meteor://💻app/lib/restivus/auth.coffee","meteor://💻app/packages/steedos:api/lib/restivus/iron-router-error-to-response.js","meteor://💻app/packages/steedos_api/lib/restivus/route.coffee","meteor://💻app/lib/restivus/route.coffee","meteor://💻app/packages/steedos_api/lib/restivus/restivus.coffee","meteor://💻app/lib/restivus/restivus.coffee","meteor://💻app/packages/steedos_api/core.coffee","meteor://💻app/core.coffee","meteor://💻app/packages/steedos_api/routes/s3.coffee","meteor://💻app/routes/s3.coffee","meteor://💻app/packages/steedos_api/routes/push.coffee","meteor://💻app/routes/push.coffee"],"names":["checkNpmVersions","module","link","v","busboy","cookies","getUserQuerySelector","userValidator","Auth","Match","Where","user","check","id","Optional","String","username","email","_","keys","length","Error","loginWithPassword","password","authToken","authenticatingUser","authenticatingUserSelector","hashedToken","passwordVerification","ref","space_users","spaces","Meteor","users","findOne","services","Accounts","_checkPassword","error","_generateStampedLoginToken","_hashStampedToken","_insertHashedLoginToken","_id","db","find","fetch","each","su","space","is_paid","indexOf","admins","push","name","token","userId","adminSpaces","env","process","NODE_ENV","ironRouterSendErrorToResponse","err","req","res","statusCode","status","msg","stack","toString","console","headersSent","socket","destroy","setHeader","Buffer","byteLength","method","end","share","Route","api","path","options","endpoints1","endpoints","prototype","addToApi","availableMethods","allowedMethods","fullPath","rejectedMethods","self","contains","_config","paths","extend","defaultOptionsEndpoint","_resolveEndpoints","_configureEndpoints","filter","reject","apiPath","endpoint","JsonRoutes","add","doneFunc","endpointContext","responseData","responseInitiated","urlParams","params","queryParams","query","bodyParams","body","request","response","done","_callEndpoint","error1","headers","_respond","message","join","toUpperCase","isFunction","action","ref1","ref2","roleRequired","union","isEmpty","authRequired","spaceRequired","invocation","_authAccepted","_roleAccepted","_spaceAccepted","DDPCommon","MethodInvocation","isSimulation","connection","randomSeed","makeRpcSeed","DDP","_CurrentInvocation","withValue","call","_authenticate","auth","userSelector","space_users_count","spaceId","count","intersection","roles","defaultHeaders","delayInMilliseconds","minimumDelayInMilliseconds","randomMultiplierBetweenOneAndTwo","sendResponse","_lowerCaseKeys","match","prettyJson","JSON","stringify","writeHead","write","Math","random","setTimeout","object","chain","pairs","map","attr","toLowerCase","value","Restivus","item","i","l","corsHeaders","_routes","useDefaultAuth","version","_user","_hashLoginToken","enableCors","slice","last","_initAuth","useAuth","warn","addRoute","route","addCollection","collection","collectionEndpoints","collectionRouteEndpoints","endpointsAwaitingConfiguration","entityRouteEndpoints","excludedEndpoints","methods","methodsOnCollection","routeOptions","_userCollectionEndpoints","_collectionEndpoints","_name","configuredEndpoint","endpointOptions","methodType","clone","get","entity","selector","data","put","entityIsUpdated","update","$set","remove","post","entityId","insert","getAll","entities","fields","profile","createUser","logout","e","extraData","searchQuery","reason","onLoggedIn","extra","index","tokenFieldName","tokenLocation","tokenPath","tokenRemovalQuery","tokenToRemove","lastIndexOf","substring","$pull","onLoggedOut","isServer","API","Busboy","Fiber","require","parseFiles","next","files","image","on","fieldname","file","filename","encoding","mimetype","buffers","mimeType","concat","run","pipe","newFile","cfs","instances","FS","File","attachData","type","fileObj","metadata","parent","r","resp","size","includes","moment","Date","format","split","pop","decodeURIComponent","replace","owner","owner_name","instance","approve","current","toLocaleLowerCase","is_private","main","$unset","locked_by","locked_by_name","$ne","original","version_id","Steedos","absoluteUrl","pushTopic","userIds","from","appName","alertTitle","alert","badge","sound","Push","send","pushSend","text","title"],"mappings":"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","file":"/packages/steedos_api.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t'aliyun-sdk': '^1.9.2',\n\tbusboy: \"^0.2.13\",\n\tcookies: \"^0.6.2\",\n\t'csv': \"^1.1.0\",\n\t'url': '^0.11.0',\n\t'request': '^2.81.0',\n\t'xinge': '^1.1.3',\n\t'huawei-push': '^0.0.6-0',\n\t'xiaomi-push': '^0.4.5'\n}, 'steedos:api');","@Auth or= {}\n\n###\n  A valid user will have exactly one of the following identification fields: id, username, or email\n###\nuserValidator = Match.Where (user) ->\n  check user,\n    id: Match.Optional String\n    username: Match.Optional String\n    email: Match.Optional String\n\n  if _.keys(user).length is not 1\n    throw new Match.Error 'User must have exactly one identifier field'\n\n  return true\n\n\n###\n  Return a MongoDB query selector for finding the given user\n###\ngetUserQuerySelector = (user) ->\n  if user.id\n    return {'_id': user.id}\n  else if user.username\n    return {'username': user.username}\n  else if user.email\n    return {'emails.address': user.email}\n\n  # We shouldn't be here if the user object was properly validated\n  throw new Error 'Cannot create selector from invalid user'\n\n\n###\n  Log a user in with their password\n###\n@Auth.loginWithPassword = (user, password) ->\n  if not user or not password\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Validate the login input types\n  check user, userValidator\n  check password, String\n\n  # Retrieve the user from the database\n  authenticatingUserSelector = getUserQuerySelector(user)\n  authenticatingUser = Meteor.users.findOne(authenticatingUserSelector)\n\n  if not authenticatingUser\n    throw new Meteor.Error 401, 'Unauthorized'\n  if not authenticatingUser.services?.password\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Authenticate the user's password\n  passwordVerification = Accounts._checkPassword authenticatingUser, password\n  if passwordVerification.error\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Add a new auth token to the user's account\n  authToken = Accounts._generateStampedLoginToken()\n  hashedToken = Accounts._hashStampedToken authToken\n  Accounts._insertHashedLoginToken authenticatingUser._id, hashedToken\n\n  space_users = db.space_users.find({user: authenticatingUser._id}).fetch()\n  spaces = []\n  _.each space_users, (su)->\n    space = db.spaces.findOne(su.space)\n    # space must be paid, and user must be admins\n    if space?.is_paid and _.indexOf(space.admins, su.user)>=0\n      spaces.push\n        _id: space._id\n        name: space.name\n  return {authToken: authToken.token, userId: authenticatingUser._id, adminSpaces: spaces}\n","var getUserQuerySelector, userValidator;\n\nthis.Auth || (this.Auth = {});\n\n\n/*\n  A valid user will have exactly one of the following identification fields: id, username, or email\n */\n\nuserValidator = Match.Where(function(user) {\n  check(user, {\n    id: Match.Optional(String),\n    username: Match.Optional(String),\n    email: Match.Optional(String)\n  });\n  if (_.keys(user).length === !1) {\n    throw new Match.Error('User must have exactly one identifier field');\n  }\n  return true;\n});\n\n\n/*\n  Return a MongoDB query selector for finding the given user\n */\n\ngetUserQuerySelector = function(user) {\n  if (user.id) {\n    return {\n      '_id': user.id\n    };\n  } else if (user.username) {\n    return {\n      'username': user.username\n    };\n  } else if (user.email) {\n    return {\n      'emails.address': user.email\n    };\n  }\n  throw new Error('Cannot create selector from invalid user');\n};\n\n\n/*\n  Log a user in with their password\n */\n\nthis.Auth.loginWithPassword = function(user, password) {\n  var authToken, authenticatingUser, authenticatingUserSelector, hashedToken, passwordVerification, ref, space_users, spaces;\n  if (!user || !password) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  check(user, userValidator);\n  check(password, String);\n  authenticatingUserSelector = getUserQuerySelector(user);\n  authenticatingUser = Meteor.users.findOne(authenticatingUserSelector);\n  if (!authenticatingUser) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  if (!((ref = authenticatingUser.services) != null ? ref.password : void 0)) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  passwordVerification = Accounts._checkPassword(authenticatingUser, password);\n  if (passwordVerification.error) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  authToken = Accounts._generateStampedLoginToken();\n  hashedToken = Accounts._hashStampedToken(authToken);\n  Accounts._insertHashedLoginToken(authenticatingUser._id, hashedToken);\n  space_users = db.space_users.find({\n    user: authenticatingUser._id\n  }).fetch();\n  spaces = [];\n  _.each(space_users, function(su) {\n    var space;\n    space = db.spaces.findOne(su.space);\n    if ((space != null ? space.is_paid : void 0) && _.indexOf(space.admins, su.user) >= 0) {\n      return spaces.push({\n        _id: space._id,\n        name: space.name\n      });\n    }\n  });\n  return {\n    authToken: authToken.token,\n    userId: authenticatingUser._id,\n    adminSpaces: spaces\n  };\n};\n","// We need a function that treats thrown errors exactly like Iron Router would.\n// This file is written in JavaScript to enable copy-pasting Iron Router code.\n\n// Taken from: https://github.com/iron-meteor/iron-router/blob/9c369499c98af9fd12ef9e68338dee3b1b1276aa/lib/router_server.js#L3\nvar env = process.env.NODE_ENV || 'development';\n\n// Taken from: https://github.com/iron-meteor/iron-router/blob/9c369499c98af9fd12ef9e68338dee3b1b1276aa/lib/router_server.js#L47\nironRouterSendErrorToResponse = function (err, req, res) {\n  if (res.statusCode < 400)\n    res.statusCode = 500;\n\n  if (err.status)\n    res.statusCode = err.status;\n\n  if (env === 'development')\n    msg = (err.stack || err.toString()) + '\\n';\n  else\n    //XXX get this from standard dict of error messages?\n    msg = 'Server error.';\n\n  console.error(err.stack || err.toString());\n\n  if (res.headersSent)\n    return req.socket.destroy();\n\n  res.setHeader('Content-Type', 'text/html');\n  res.setHeader('Content-Length', Buffer.byteLength(msg));\n  if (req.method === 'HEAD')\n    return res.end();\n  res.end(msg);\n  return;\n}\n","class share.Route\n\n  constructor: (@api, @path, @options, @endpoints) ->\n    # Check if options were provided\n    if not @endpoints\n      @endpoints = @options\n      @options = {}\n\n\n  addToApi: do ->\n    availableMethods = ['get', 'post', 'put', 'patch', 'delete', 'options']\n\n    return ->\n      self = this\n\n      # Throw an error if a route has already been added at this path\n      # TODO: Check for collisions with paths that follow same pattern with different parameter names\n      if _.contains @api._config.paths, @path\n        throw new Error \"Cannot add a route at an existing path: #{@path}\"\n\n      # Override the default OPTIONS endpoint with our own\n      @endpoints = _.extend options: @api._config.defaultOptionsEndpoint, @endpoints\n\n      # Configure each endpoint on this route\n      @_resolveEndpoints()\n      @_configureEndpoints()\n\n      # Add to our list of existing paths\n      @api._config.paths.push @path\n\n      allowedMethods = _.filter availableMethods, (method) ->\n        _.contains(_.keys(self.endpoints), method)\n      rejectedMethods = _.reject availableMethods, (method) ->\n        _.contains(_.keys(self.endpoints), method)\n\n      # Setup endpoints on route\n      fullPath = @api._config.apiPath + @path\n      _.each allowedMethods, (method) ->\n        endpoint = self.endpoints[method]\n        JsonRoutes.add method, fullPath, (req, res) ->\n          # Add function to endpoint context for indicating a response has been initiated manually\n          responseInitiated = false\n          doneFunc = ->\n            responseInitiated = true\n\n          endpointContext =\n            urlParams: req.params\n            queryParams: req.query\n            bodyParams: req.body\n            request: req\n            response: res\n            done: doneFunc\n          # Add endpoint config options to context\n          _.extend endpointContext, endpoint\n\n          # Run the requested endpoint\n          responseData = null\n          try\n            responseData = self._callEndpoint endpointContext, endpoint\n          catch error\n            # Do exactly what Iron Router would have done, to avoid changing the API\n            ironRouterSendErrorToResponse(error, req, res);\n            return\n\n          if responseInitiated\n            # Ensure the response is properly completed\n            res.end()\n            return\n          else\n            if res.headersSent\n              throw new Error \"Must call this.done() after handling endpoint response manually: #{method} #{fullPath}\"\n            else if responseData is null or responseData is undefined\n              throw new Error \"Cannot return null or undefined from an endpoint: #{method} #{fullPath}\"\n\n          # Generate and return the http response, handling the different endpoint response types\n          if responseData.body and (responseData.statusCode or responseData.headers)\n            self._respond res, responseData.body, responseData.statusCode, responseData.headers\n          else\n            self._respond res, responseData\n\n      _.each rejectedMethods, (method) ->\n        JsonRoutes.add method, fullPath, (req, res) ->\n          responseData = status: 'error', message: 'API endpoint does not exist'\n          headers = 'Allow': allowedMethods.join(', ').toUpperCase()\n          self._respond res, responseData, 405, headers\n\n\n  ###\n    Convert all endpoints on the given route into our expected endpoint object if it is a bare\n    function\n\n    @param {Route} route The route the endpoints belong to\n  ###\n  _resolveEndpoints: ->\n    _.each @endpoints, (endpoint, method, endpoints) ->\n      if _.isFunction(endpoint)\n        endpoints[method] = {action: endpoint}\n    return\n\n\n  ###\n    Configure the authentication and role requirement on all endpoints (except OPTIONS, which must\n    be configured directly on the endpoint)\n\n    Authentication can be required on an entire route or individual endpoints. If required on an\n    entire route, that serves as the default. If required in any individual endpoints, that will\n    override the default.\n\n    After the endpoint is configured, all authentication and role requirements of an endpoint can be\n    accessed at <code>endpoint.authRequired</code> and <code>endpoint.roleRequired</code>,\n    respectively.\n\n    @param {Route} route The route the endpoints belong to\n    @param {Endpoint} endpoint The endpoint to configure\n  ###\n  _configureEndpoints: ->\n    _.each @endpoints, (endpoint, method) ->\n      if method isnt 'options'\n        # Configure acceptable roles\n        if not @options?.roleRequired\n          @options.roleRequired = []\n        if not endpoint.roleRequired\n          endpoint.roleRequired = []\n        endpoint.roleRequired = _.union endpoint.roleRequired, @options.roleRequired\n        # Make it easier to check if no roles are required\n        if _.isEmpty endpoint.roleRequired\n          endpoint.roleRequired = false\n\n        # Configure auth requirement\n        if endpoint.authRequired is undefined\n          if @options?.authRequired or endpoint.roleRequired\n            endpoint.authRequired = true\n          else\n            endpoint.authRequired = false\n\n        if @options?.spaceRequired\n          endpoint.spaceRequired = @options.spaceRequired\n        return\n    , this\n    return\n\n\n  ###\n    Authenticate an endpoint if required, and return the result of calling it\n\n    @returns The endpoint response or a 401 if authentication fails\n  ###\n  _callEndpoint: (endpointContext, endpoint) ->\n    # Call the endpoint if authentication doesn't fail\n    if @_authAccepted endpointContext, endpoint\n      if @_roleAccepted endpointContext, endpoint\n        if @_spaceAccepted endpointContext, endpoint\n          #endpoint.action.call endpointContext\n          invocation = new DDPCommon.MethodInvocation\n            isSimulation: true,\n            userId: endpointContext.userId,\n            connection: null,\n            randomSeed: DDPCommon.makeRpcSeed()\n       \n          return DDP._CurrentInvocation.withValue invocation, ->\n            return endpoint.action.call(endpointContext);\n        else\n          statusCode: 403\n          body: {status: 'error', message: 'Bad X-Space-Id, Only admins of paid space can call this api.'}\n      else\n        statusCode: 403\n        body: {status: 'error', message: 'You do not have permission to do this.'}\n    else\n      statusCode: 401\n      body: {status: 'error', message: 'You must be logged in to do this.'}\n\n\n  ###\n    Authenticate the given endpoint if required\n\n    Once it's globally configured in the API, authentication can be required on an entire route or\n    individual endpoints. If required on an entire endpoint, that serves as the default. If required\n    in any individual endpoints, that will override the default.\n\n    @returns False if authentication fails, and true otherwise\n  ###\n  _authAccepted: (endpointContext, endpoint) ->\n    if endpoint.authRequired\n      @_authenticate endpointContext\n    else true\n\n\n  ###\n    Verify the request is being made by an actively logged in user\n\n    If verified, attach the authenticated user to the context.\n\n    @returns {Boolean} True if the authentication was successful\n  ###\n  _authenticate: (endpointContext) ->\n    # Get auth info\n    auth = @api._config.auth.user.call(endpointContext)\n\n    # Get the user from the database\n    if auth?.userId and auth?.token and not auth?.user\n      userSelector = {}\n      userSelector._id = auth.userId\n      userSelector[@api._config.auth.token] = auth.token\n      auth.user = Meteor.users.findOne userSelector\n\n    # Attach the user and their ID to the context if the authentication was successful\n    if auth?.user\n      endpointContext.user = auth.user\n      endpointContext.userId = auth.user._id\n      true\n    else false\n\n  ###\n    Authenticate the user role if required\n\n    Must be called after _authAccepted().\n\n    @returns True if the authenticated user belongs to <i>any</i> of the acceptable roles on the\n             endpoint\n  ###\n  _spaceAccepted: (endpointContext, endpoint) ->\n    if endpoint.spaceRequired\n      auth = @api._config.auth.user.call(endpointContext)\n      if auth?.spaceId\n        space_users_count = db.space_users.find({user: auth.userId, space:auth.spaceId}).count()\n        if space_users_count\n          space = db.spaces.findOne(auth.spaceId)\n          # space must be paid, and user must be admins\n          if space?.is_paid and _.indexOf(space.admins, auth.userId)>=0\n            endpointContext.spaceId = auth.spaceId\n            return true\n      endpointContext.spaceId = \"bad\"\n      return false\n    return true\n\n  ###\n    Authenticate the user role if required\n\n    Must be called after _authAccepted().\n\n    @returns True if the authenticated user belongs to <i>any</i> of the acceptable roles on the\n             endpoint\n  ###\n  _roleAccepted: (endpointContext, endpoint) ->\n    if endpoint.roleRequired\n      if _.isEmpty _.intersection(endpoint.roleRequired, endpointContext.user.roles)\n        return false\n    true\n\n\n  ###\n    Respond to an HTTP request\n  ###\n  _respond: (response, body, statusCode=200, headers={}) ->\n    # Override any default headers that have been provided (keys are normalized to be case insensitive)\n    # TODO: Consider only lowercasing the header keys we need normalized, like Content-Type\n    defaultHeaders = @_lowerCaseKeys @api._config.defaultHeaders\n    headers = @_lowerCaseKeys headers\n    headers = _.extend defaultHeaders, headers\n\n    # Prepare JSON body for response when Content-Type indicates JSON type\n    if headers['content-type'].match(/json|javascript/) isnt null\n      if @api._config.prettyJson\n        body = JSON.stringify body, undefined, 2\n      else\n        body = JSON.stringify body\n\n    # Send response\n    sendResponse = ->\n      response.writeHead statusCode, headers\n      response.write body\n      response.end()\n    if statusCode in [401, 403]\n      # Hackers can measure the response time to determine things like whether the 401 response was \n      # caused by bad user id vs bad password.\n      # In doing so, they can first scan for valid user ids regardless of valid passwords.\n      # Delay by a random amount to reduce the ability for a hacker to determine the response time.\n      # See https://www.owasp.org/index.php/Blocking_Brute_Force_Attacks#Finding_Other_Countermeasures\n      # See https://en.wikipedia.org/wiki/Timing_attack\n      minimumDelayInMilliseconds = 500\n      randomMultiplierBetweenOneAndTwo = 1 + Math.random()\n      delayInMilliseconds = minimumDelayInMilliseconds * randomMultiplierBetweenOneAndTwo\n      Meteor.setTimeout sendResponse, delayInMilliseconds\n    else\n      sendResponse()\n\n  ###\n    Return the object with all of the keys converted to lowercase\n  ###\n  _lowerCaseKeys: (object) ->\n    _.chain object\n    .pairs()\n    .map (attr) ->\n      [attr[0].toLowerCase(), attr[1]]\n    .object()\n    .value()\n","share.Route = (function() {\n  function Route(api, path, options, endpoints1) {\n    this.api = api;\n    this.path = path;\n    this.options = options;\n    this.endpoints = endpoints1;\n    if (!this.endpoints) {\n      this.endpoints = this.options;\n      this.options = {};\n    }\n  }\n\n  Route.prototype.addToApi = (function() {\n    var availableMethods;\n    availableMethods = ['get', 'post', 'put', 'patch', 'delete', 'options'];\n    return function() {\n      var allowedMethods, fullPath, rejectedMethods, self;\n      self = this;\n      if (_.contains(this.api._config.paths, this.path)) {\n        throw new Error(\"Cannot add a route at an existing path: \" + this.path);\n      }\n      this.endpoints = _.extend({\n        options: this.api._config.defaultOptionsEndpoint\n      }, this.endpoints);\n      this._resolveEndpoints();\n      this._configureEndpoints();\n      this.api._config.paths.push(this.path);\n      allowedMethods = _.filter(availableMethods, function(method) {\n        return _.contains(_.keys(self.endpoints), method);\n      });\n      rejectedMethods = _.reject(availableMethods, function(method) {\n        return _.contains(_.keys(self.endpoints), method);\n      });\n      fullPath = this.api._config.apiPath + this.path;\n      _.each(allowedMethods, function(method) {\n        var endpoint;\n        endpoint = self.endpoints[method];\n        return JsonRoutes.add(method, fullPath, function(req, res) {\n          var doneFunc, endpointContext, error, responseData, responseInitiated;\n          responseInitiated = false;\n          doneFunc = function() {\n            return responseInitiated = true;\n          };\n          endpointContext = {\n            urlParams: req.params,\n            queryParams: req.query,\n            bodyParams: req.body,\n            request: req,\n            response: res,\n            done: doneFunc\n          };\n          _.extend(endpointContext, endpoint);\n          responseData = null;\n          try {\n            responseData = self._callEndpoint(endpointContext, endpoint);\n          } catch (error1) {\n            error = error1;\n            ironRouterSendErrorToResponse(error, req, res);\n            return;\n          }\n          if (responseInitiated) {\n            res.end();\n            return;\n          } else {\n            if (res.headersSent) {\n              throw new Error(\"Must call this.done() after handling endpoint response manually: \" + method + \" \" + fullPath);\n            } else if (responseData === null || responseData === void 0) {\n              throw new Error(\"Cannot return null or undefined from an endpoint: \" + method + \" \" + fullPath);\n            }\n          }\n          if (responseData.body && (responseData.statusCode || responseData.headers)) {\n            return self._respond(res, responseData.body, responseData.statusCode, responseData.headers);\n          } else {\n            return self._respond(res, responseData);\n          }\n        });\n      });\n      return _.each(rejectedMethods, function(method) {\n        return JsonRoutes.add(method, fullPath, function(req, res) {\n          var headers, responseData;\n          responseData = {\n            status: 'error',\n            message: 'API endpoint does not exist'\n          };\n          headers = {\n            'Allow': allowedMethods.join(', ').toUpperCase()\n          };\n          return self._respond(res, responseData, 405, headers);\n        });\n      });\n    };\n  })();\n\n\n  /*\n    Convert all endpoints on the given route into our expected endpoint object if it is a bare\n    function\n  \n    @param {Route} route The route the endpoints belong to\n   */\n\n  Route.prototype._resolveEndpoints = function() {\n    _.each(this.endpoints, function(endpoint, method, endpoints) {\n      if (_.isFunction(endpoint)) {\n        return endpoints[method] = {\n          action: endpoint\n        };\n      }\n    });\n  };\n\n\n  /*\n    Configure the authentication and role requirement on all endpoints (except OPTIONS, which must\n    be configured directly on the endpoint)\n  \n    Authentication can be required on an entire route or individual endpoints. If required on an\n    entire route, that serves as the default. If required in any individual endpoints, that will\n    override the default.\n  \n    After the endpoint is configured, all authentication and role requirements of an endpoint can be\n    accessed at <code>endpoint.authRequired</code> and <code>endpoint.roleRequired</code>,\n    respectively.\n  \n    @param {Route} route The route the endpoints belong to\n    @param {Endpoint} endpoint The endpoint to configure\n   */\n\n  Route.prototype._configureEndpoints = function() {\n    _.each(this.endpoints, function(endpoint, method) {\n      var ref, ref1, ref2;\n      if (method !== 'options') {\n        if (!((ref = this.options) != null ? ref.roleRequired : void 0)) {\n          this.options.roleRequired = [];\n        }\n        if (!endpoint.roleRequired) {\n          endpoint.roleRequired = [];\n        }\n        endpoint.roleRequired = _.union(endpoint.roleRequired, this.options.roleRequired);\n        if (_.isEmpty(endpoint.roleRequired)) {\n          endpoint.roleRequired = false;\n        }\n        if (endpoint.authRequired === void 0) {\n          if (((ref1 = this.options) != null ? ref1.authRequired : void 0) || endpoint.roleRequired) {\n            endpoint.authRequired = true;\n          } else {\n            endpoint.authRequired = false;\n          }\n        }\n        if ((ref2 = this.options) != null ? ref2.spaceRequired : void 0) {\n          endpoint.spaceRequired = this.options.spaceRequired;\n        }\n      }\n    }, this);\n  };\n\n\n  /*\n    Authenticate an endpoint if required, and return the result of calling it\n  \n    @returns The endpoint response or a 401 if authentication fails\n   */\n\n  Route.prototype._callEndpoint = function(endpointContext, endpoint) {\n    var invocation;\n    if (this._authAccepted(endpointContext, endpoint)) {\n      if (this._roleAccepted(endpointContext, endpoint)) {\n        if (this._spaceAccepted(endpointContext, endpoint)) {\n          invocation = new DDPCommon.MethodInvocation({\n            isSimulation: true,\n            userId: endpointContext.userId,\n            connection: null,\n            randomSeed: DDPCommon.makeRpcSeed()\n          });\n          return DDP._CurrentInvocation.withValue(invocation, function() {\n            return endpoint.action.call(endpointContext);\n          });\n        } else {\n          return {\n            statusCode: 403,\n            body: {\n              status: 'error',\n              message: 'Bad X-Space-Id, Only admins of paid space can call this api.'\n            }\n          };\n        }\n      } else {\n        return {\n          statusCode: 403,\n          body: {\n            status: 'error',\n            message: 'You do not have permission to do this.'\n          }\n        };\n      }\n    } else {\n      return {\n        statusCode: 401,\n        body: {\n          status: 'error',\n          message: 'You must be logged in to do this.'\n        }\n      };\n    }\n  };\n\n\n  /*\n    Authenticate the given endpoint if required\n  \n    Once it's globally configured in the API, authentication can be required on an entire route or\n    individual endpoints. If required on an entire endpoint, that serves as the default. If required\n    in any individual endpoints, that will override the default.\n  \n    @returns False if authentication fails, and true otherwise\n   */\n\n  Route.prototype._authAccepted = function(endpointContext, endpoint) {\n    if (endpoint.authRequired) {\n      return this._authenticate(endpointContext);\n    } else {\n      return true;\n    }\n  };\n\n\n  /*\n    Verify the request is being made by an actively logged in user\n  \n    If verified, attach the authenticated user to the context.\n  \n    @returns {Boolean} True if the authentication was successful\n   */\n\n  Route.prototype._authenticate = function(endpointContext) {\n    var auth, userSelector;\n    auth = this.api._config.auth.user.call(endpointContext);\n    if ((auth != null ? auth.userId : void 0) && (auth != null ? auth.token : void 0) && !(auth != null ? auth.user : void 0)) {\n      userSelector = {};\n      userSelector._id = auth.userId;\n      userSelector[this.api._config.auth.token] = auth.token;\n      auth.user = Meteor.users.findOne(userSelector);\n    }\n    if (auth != null ? auth.user : void 0) {\n      endpointContext.user = auth.user;\n      endpointContext.userId = auth.user._id;\n      return true;\n    } else {\n      return false;\n    }\n  };\n\n\n  /*\n    Authenticate the user role if required\n  \n    Must be called after _authAccepted().\n  \n    @returns True if the authenticated user belongs to <i>any</i> of the acceptable roles on the\n             endpoint\n   */\n\n  Route.prototype._spaceAccepted = function(endpointContext, endpoint) {\n    var auth, space, space_users_count;\n    if (endpoint.spaceRequired) {\n      auth = this.api._config.auth.user.call(endpointContext);\n      if (auth != null ? auth.spaceId : void 0) {\n        space_users_count = db.space_users.find({\n          user: auth.userId,\n          space: auth.spaceId\n        }).count();\n        if (space_users_count) {\n          space = db.spaces.findOne(auth.spaceId);\n          if ((space != null ? space.is_paid : void 0) && _.indexOf(space.admins, auth.userId) >= 0) {\n            endpointContext.spaceId = auth.spaceId;\n            return true;\n          }\n        }\n      }\n      endpointContext.spaceId = \"bad\";\n      return false;\n    }\n    return true;\n  };\n\n\n  /*\n    Authenticate the user role if required\n  \n    Must be called after _authAccepted().\n  \n    @returns True if the authenticated user belongs to <i>any</i> of the acceptable roles on the\n             endpoint\n   */\n\n  Route.prototype._roleAccepted = function(endpointContext, endpoint) {\n    if (endpoint.roleRequired) {\n      if (_.isEmpty(_.intersection(endpoint.roleRequired, endpointContext.user.roles))) {\n        return false;\n      }\n    }\n    return true;\n  };\n\n\n  /*\n    Respond to an HTTP request\n   */\n\n  Route.prototype._respond = function(response, body, statusCode, headers) {\n    var defaultHeaders, delayInMilliseconds, minimumDelayInMilliseconds, randomMultiplierBetweenOneAndTwo, sendResponse;\n    if (statusCode == null) {\n      statusCode = 200;\n    }\n    if (headers == null) {\n      headers = {};\n    }\n    defaultHeaders = this._lowerCaseKeys(this.api._config.defaultHeaders);\n    headers = this._lowerCaseKeys(headers);\n    headers = _.extend(defaultHeaders, headers);\n    if (headers['content-type'].match(/json|javascript/) !== null) {\n      if (this.api._config.prettyJson) {\n        body = JSON.stringify(body, void 0, 2);\n      } else {\n        body = JSON.stringify(body);\n      }\n    }\n    sendResponse = function() {\n      response.writeHead(statusCode, headers);\n      response.write(body);\n      return response.end();\n    };\n    if (statusCode === 401 || statusCode === 403) {\n      minimumDelayInMilliseconds = 500;\n      randomMultiplierBetweenOneAndTwo = 1 + Math.random();\n      delayInMilliseconds = minimumDelayInMilliseconds * randomMultiplierBetweenOneAndTwo;\n      return Meteor.setTimeout(sendResponse, delayInMilliseconds);\n    } else {\n      return sendResponse();\n    }\n  };\n\n\n  /*\n    Return the object with all of the keys converted to lowercase\n   */\n\n  Route.prototype._lowerCaseKeys = function(object) {\n    return _.chain(object).pairs().map(function(attr) {\n      return [attr[0].toLowerCase(), attr[1]];\n    }).object().value();\n  };\n\n  return Route;\n\n})();\n","class @Restivus\n\n  constructor: (options) ->\n    @_routes = []\n    @_config =\n      paths: []\n      useDefaultAuth: false\n      apiPath: 'api/'\n      version: null\n      prettyJson: false\n      auth:\n        token: 'services.resume.loginTokens.hashedToken'\n        user: ->\n          if @request.headers['x-auth-token']\n            token = Accounts._hashLoginToken @request.headers['x-auth-token']\n          if @request.userId\n            _user = db.users.findOne({_id: @request.userId})\n            user: _user\n            userId: @request.headers['x-user-id']\n            spaceId: @request.headers['x-space-id']\n            token: token\n          else\n            userId: @request.headers['x-user-id']\n            spaceId: @request.headers['x-space-id']\n            token: token\n      defaultHeaders:\n        'Content-Type': 'application/json'\n      enableCors: true\n\n    # Configure API with the given options\n    _.extend @_config, options\n\n    if @_config.enableCors\n      corsHeaders =\n        'Access-Control-Allow-Origin': '*'\n        'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'\n\n      if @_config.useDefaultAuth\n        corsHeaders['Access-Control-Allow-Headers'] += ', X-User-Id, X-Auth-Token'\n\n      # Set default header to enable CORS if configured\n      _.extend @_config.defaultHeaders, corsHeaders\n\n      if not @_config.defaultOptionsEndpoint\n        @_config.defaultOptionsEndpoint = ->\n          @response.writeHead 200, corsHeaders\n          @done()\n\n    # Normalize the API path\n    if @_config.apiPath[0] is '/'\n      @_config.apiPath = @_config.apiPath.slice 1\n    if _.last(@_config.apiPath) isnt '/'\n      @_config.apiPath = @_config.apiPath + '/'\n\n    # URL path versioning is the only type of API versioning currently available, so if a version is\n    # provided, append it to the base path of the API\n    if @_config.version\n      @_config.apiPath += @_config.version + '/'\n\n    # Add default login and logout endpoints if auth is configured\n    if @_config.useDefaultAuth\n      @_initAuth()\n    else if @_config.useAuth\n      @_initAuth()\n      console.warn 'Warning: useAuth API config option will be removed in Restivus v1.0 ' +\n          '\\n    Use the useDefaultAuth option instead'\n\n    return this\n\n\n  ###*\n    Add endpoints for the given HTTP methods at the given path\n\n    @param path {String} The extended URL path (will be appended to base path of the API)\n    @param options {Object} Route configuration options\n    @param options.authRequired {Boolean} The default auth requirement for each endpoint on the route\n    @param options.roleRequired {String or String[]} The default role required for each endpoint on the route\n    @param endpoints {Object} A set of endpoints available on the new route (get, post, put, patch, delete, options)\n    @param endpoints.<method> {Function or Object} If a function is provided, all default route\n        configuration options will be applied to the endpoint. Otherwise an object with an `action`\n        and all other route config options available. An `action` must be provided with the object.\n  ###\n  addRoute: (path, options, endpoints) ->\n    # Create a new route and add it to our list of existing routes\n    route = new share.Route(this, path, options, endpoints)\n    @_routes.push(route)\n\n    route.addToApi()\n\n    return this\n\n\n  ###*\n    Generate routes for the Meteor Collection with the given name\n  ###\n  addCollection: (collection, options={}) ->\n    methods = ['get', 'post', 'put', 'delete', 'getAll']\n    methodsOnCollection = ['post', 'getAll']\n\n    # Grab the set of endpoints\n    if collection is Meteor.users\n      collectionEndpoints = @_userCollectionEndpoints\n    else\n      collectionEndpoints = @_collectionEndpoints\n\n    # Flatten the options and set defaults if necessary\n    endpointsAwaitingConfiguration = options.endpoints or {}\n    routeOptions = options.routeOptions or {}\n    excludedEndpoints = options.excludedEndpoints or []\n    # Use collection name as default path\n    path = options.path or collection._name\n\n    # Separate the requested endpoints by the route they belong to (one for operating on the entire\n    # collection and one for operating on a single entity within the collection)\n    collectionRouteEndpoints = {}\n    entityRouteEndpoints = {}\n    if _.isEmpty(endpointsAwaitingConfiguration) and _.isEmpty(excludedEndpoints)\n      # Generate all endpoints on this collection\n      _.each methods, (method) ->\n        # Partition the endpoints into their respective routes\n        if method in methodsOnCollection\n          _.extend collectionRouteEndpoints, collectionEndpoints[method].call(this, collection)\n        else _.extend entityRouteEndpoints, collectionEndpoints[method].call(this, collection)\n        return\n      , this\n    else\n      # Generate any endpoints that haven't been explicitly excluded\n      _.each methods, (method) ->\n        if method not in excludedEndpoints and endpointsAwaitingConfiguration[method] isnt false\n          # Configure endpoint and map to it's http method\n          # TODO: Consider predefining a map of methods to their http method type (e.g., getAll: get)\n          endpointOptions = endpointsAwaitingConfiguration[method]\n          configuredEndpoint = {}\n          _.each collectionEndpoints[method].call(this, collection), (action, methodType) ->\n            configuredEndpoint[methodType] =\n              _.chain action\n              .clone()\n              .extend endpointOptions\n              .value()\n          # Partition the endpoints into their respective routes\n          if method in methodsOnCollection\n            _.extend collectionRouteEndpoints, configuredEndpoint\n          else _.extend entityRouteEndpoints, configuredEndpoint\n          return\n      , this\n\n    # Add the routes to the API\n    @addRoute path, routeOptions, collectionRouteEndpoints\n    @addRoute \"#{path}/:id\", routeOptions, entityRouteEndpoints\n\n    return this\n\n\n  ###*\n    A set of endpoints that can be applied to a Collection Route\n  ###\n  _collectionEndpoints:\n    get: (collection) ->\n      get:\n        action: ->\n          selector = {_id: @urlParams.id}\n          if this.spaceId\n            selector.space = this.spaceId\n          entity = collection.findOne selector\n          if entity\n            {status: 'success', data: entity}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'Item not found'}\n    put: (collection) ->\n      put:\n        action: ->\n          selector = {_id: @urlParams.id}\n          if this.spaceId\n            selector.space = this.spaceId\n          entityIsUpdated = collection.update selector, $set: @bodyParams\n          if entityIsUpdated\n            entity = collection.findOne @urlParams.id\n            {status: 'success', data: entity}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'Item not found'}\n    delete: (collection) ->\n      delete:\n        action: ->\n          selector = {_id: @urlParams.id}\n          if this.spaceId\n            selector.space = this.spaceId\n          if collection.remove selector\n            {status: 'success', data: message: 'Item removed'}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'Item not found'}\n    post: (collection) ->\n      post:\n        action: ->\n          if this.spaceId\n            @bodyParams.space = this.spaceId\n          entityId = collection.insert @bodyParams\n          entity = collection.findOne entityId\n          if entity\n            statusCode: 201\n            body: {status: 'success', data: entity}\n          else\n            statusCode: 400\n            body: {status: 'fail', message: 'No item added'}\n    getAll: (collection) ->\n      get:\n        action: ->\n          selector = {}\n          if this.spaceId\n            selector.space = this.spaceId\n          entities = collection.find(selector).fetch()\n          if entities\n            {status: 'success', data: entities}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'Unable to retrieve items from collection'}\n\n\n  ###*\n    A set of endpoints that can be applied to a Meteor.users Collection Route\n  ###\n  _userCollectionEndpoints:\n    get: (collection) ->\n      get:\n        action: ->\n          entity = collection.findOne @urlParams.id, fields: profile: 1\n          if entity\n            {status: 'success', data: entity}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'User not found'}\n    put: (collection) ->\n      put:\n        action: ->\n          entityIsUpdated = collection.update @urlParams.id, $set: profile: @bodyParams\n          if entityIsUpdated\n            entity = collection.findOne @urlParams.id, fields: profile: 1\n            {status: \"success\", data: entity}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'User not found'}\n    delete: (collection) ->\n      delete:\n        action: ->\n          if collection.remove @urlParams.id\n            {status: 'success', data: message: 'User removed'}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'User not found'}\n    post: (collection) ->\n      post:\n        action: ->\n          # Create a new user account\n          entityId = Accounts.createUser @bodyParams\n          entity = collection.findOne entityId, fields: profile: 1\n          if entity\n            statusCode: 201\n            body: {status: 'success', data: entity}\n          else\n            statusCode: 400\n            {status: 'fail', message: 'No user added'}\n    getAll: (collection) ->\n      get:\n        action: ->\n          entities = collection.find({}, fields: profile: 1).fetch()\n          if entities\n            {status: 'success', data: entities}\n          else\n            statusCode: 404\n            body: {status: 'fail', message: 'Unable to retrieve users'}\n\n\n  ###\n    Add /login and /logout endpoints to the API\n  ###\n  _initAuth: ->\n    self = this\n    ###\n      Add a login endpoint to the API\n\n      After the user is logged in, the onLoggedIn hook is called (see Restfully.configure() for\n      adding hook).\n    ###\n    @addRoute 'login', {authRequired: false},\n      post: ->\n        # Grab the username or email that the user is logging in with\n        user = {}\n        if @bodyParams.user\n          if @bodyParams.user.indexOf('@') is -1\n            user.username = @bodyParams.user\n          else\n            user.email = @bodyParams.user\n        else if @bodyParams.username\n          user.username = @bodyParams.username\n        else if @bodyParams.email\n          user.email = @bodyParams.email\n\n        # Try to log the user into the user's account (if successful we'll get an auth token back)\n        try\n          auth = Auth.loginWithPassword user, @bodyParams.password\n        catch e\n          console.error e\n          return {} =\n            statusCode: e.error\n            body: status: 'error', message: e.reason\n\n        # Get the authenticated user\n        # TODO: Consider returning the user in Auth.loginWithPassword(), instead of fetching it again here\n        if auth.userId and auth.authToken\n          searchQuery = {}\n          searchQuery[self._config.auth.token] = Accounts._hashLoginToken auth.authToken\n          @user = Meteor.users.findOne\n            '_id': auth.userId\n            searchQuery\n          @userId = @user?._id\n\n        response = {status: 'success', data: auth}\n\n        # Call the login hook with the authenticated user attached\n        extraData = self._config.onLoggedIn?.call(this)\n        if extraData?\n          _.extend(response.data, {extra: extraData})\n\n        response\n\n    logout = ->\n      # Remove the given auth token from the user's account\n      authToken = @request.headers['x-auth-token']\n      hashedToken = Accounts._hashLoginToken authToken\n      tokenLocation = self._config.auth.token\n      index = tokenLocation.lastIndexOf '.'\n      tokenPath = tokenLocation.substring 0, index\n      tokenFieldName = tokenLocation.substring index + 1\n      tokenToRemove = {}\n      tokenToRemove[tokenFieldName] = hashedToken\n      tokenRemovalQuery = {}\n      tokenRemovalQuery[tokenPath] = tokenToRemove\n      Meteor.users.update @user._id, {$pull: tokenRemovalQuery}\n\n      response = {status: 'success', data: {message: 'You\\'ve been logged out!'}}\n\n      # Call the logout hook with the authenticated user attached\n      extraData = self._config.onLoggedOut?.call(this)\n      if extraData?\n        _.extend(response.data, {extra: extraData})\n\n      response\n\n    ###\n      Add a logout endpoint to the API\n\n      After the user is logged out, the onLoggedOut hook is called (see Restfully.configure() for\n      adding hook).\n    ###\n    @addRoute 'logout', {authRequired: true},\n      get: ->\n        console.warn \"Warning: Default logout via GET will be removed in Restivus v1.0. Use POST instead.\"\n        console.warn \"    See https://github.com/kahmali/meteor-restivus/issues/100\"\n        return logout.call(this)\n      post: logout\n\nRestivus = @Restivus\n","var Restivus,\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\nthis.Restivus = (function() {\n  function Restivus(options) {\n    var corsHeaders;\n    this._routes = [];\n    this._config = {\n      paths: [],\n      useDefaultAuth: false,\n      apiPath: 'api/',\n      version: null,\n      prettyJson: false,\n      auth: {\n        token: 'services.resume.loginTokens.hashedToken',\n        user: function() {\n          var _user, token;\n          if (this.request.headers['x-auth-token']) {\n            token = Accounts._hashLoginToken(this.request.headers['x-auth-token']);\n          }\n          if (this.request.userId) {\n            _user = db.users.findOne({\n              _id: this.request.userId\n            });\n            return {\n              user: _user,\n              userId: this.request.headers['x-user-id'],\n              spaceId: this.request.headers['x-space-id'],\n              token: token\n            };\n          } else {\n            return {\n              userId: this.request.headers['x-user-id'],\n              spaceId: this.request.headers['x-space-id'],\n              token: token\n            };\n          }\n        }\n      },\n      defaultHeaders: {\n        'Content-Type': 'application/json'\n      },\n      enableCors: true\n    };\n    _.extend(this._config, options);\n    if (this._config.enableCors) {\n      corsHeaders = {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'\n      };\n      if (this._config.useDefaultAuth) {\n        corsHeaders['Access-Control-Allow-Headers'] += ', X-User-Id, X-Auth-Token';\n      }\n      _.extend(this._config.defaultHeaders, corsHeaders);\n      if (!this._config.defaultOptionsEndpoint) {\n        this._config.defaultOptionsEndpoint = function() {\n          this.response.writeHead(200, corsHeaders);\n          return this.done();\n        };\n      }\n    }\n    if (this._config.apiPath[0] === '/') {\n      this._config.apiPath = this._config.apiPath.slice(1);\n    }\n    if (_.last(this._config.apiPath) !== '/') {\n      this._config.apiPath = this._config.apiPath + '/';\n    }\n    if (this._config.version) {\n      this._config.apiPath += this._config.version + '/';\n    }\n    if (this._config.useDefaultAuth) {\n      this._initAuth();\n    } else if (this._config.useAuth) {\n      this._initAuth();\n      console.warn('Warning: useAuth API config option will be removed in Restivus v1.0 ' + '\\n    Use the useDefaultAuth option instead');\n    }\n    return this;\n  }\n\n\n  /**\n    Add endpoints for the given HTTP methods at the given path\n  \n    @param path {String} The extended URL path (will be appended to base path of the API)\n    @param options {Object} Route configuration options\n    @param options.authRequired {Boolean} The default auth requirement for each endpoint on the route\n    @param options.roleRequired {String or String[]} The default role required for each endpoint on the route\n    @param endpoints {Object} A set of endpoints available on the new route (get, post, put, patch, delete, options)\n    @param endpoints.<method> {Function or Object} If a function is provided, all default route\n        configuration options will be applied to the endpoint. Otherwise an object with an `action`\n        and all other route config options available. An `action` must be provided with the object.\n   */\n\n  Restivus.prototype.addRoute = function(path, options, endpoints) {\n    var route;\n    route = new share.Route(this, path, options, endpoints);\n    this._routes.push(route);\n    route.addToApi();\n    return this;\n  };\n\n\n  /**\n    Generate routes for the Meteor Collection with the given name\n   */\n\n  Restivus.prototype.addCollection = function(collection, options) {\n    var collectionEndpoints, collectionRouteEndpoints, endpointsAwaitingConfiguration, entityRouteEndpoints, excludedEndpoints, methods, methodsOnCollection, path, routeOptions;\n    if (options == null) {\n      options = {};\n    }\n    methods = ['get', 'post', 'put', 'delete', 'getAll'];\n    methodsOnCollection = ['post', 'getAll'];\n    if (collection === Meteor.users) {\n      collectionEndpoints = this._userCollectionEndpoints;\n    } else {\n      collectionEndpoints = this._collectionEndpoints;\n    }\n    endpointsAwaitingConfiguration = options.endpoints || {};\n    routeOptions = options.routeOptions || {};\n    excludedEndpoints = options.excludedEndpoints || [];\n    path = options.path || collection._name;\n    collectionRouteEndpoints = {};\n    entityRouteEndpoints = {};\n    if (_.isEmpty(endpointsAwaitingConfiguration) && _.isEmpty(excludedEndpoints)) {\n      _.each(methods, function(method) {\n        if (indexOf.call(methodsOnCollection, method) >= 0) {\n          _.extend(collectionRouteEndpoints, collectionEndpoints[method].call(this, collection));\n        } else {\n          _.extend(entityRouteEndpoints, collectionEndpoints[method].call(this, collection));\n        }\n      }, this);\n    } else {\n      _.each(methods, function(method) {\n        var configuredEndpoint, endpointOptions;\n        if (indexOf.call(excludedEndpoints, method) < 0 && endpointsAwaitingConfiguration[method] !== false) {\n          endpointOptions = endpointsAwaitingConfiguration[method];\n          configuredEndpoint = {};\n          _.each(collectionEndpoints[method].call(this, collection), function(action, methodType) {\n            return configuredEndpoint[methodType] = _.chain(action).clone().extend(endpointOptions).value();\n          });\n          if (indexOf.call(methodsOnCollection, method) >= 0) {\n            _.extend(collectionRouteEndpoints, configuredEndpoint);\n          } else {\n            _.extend(entityRouteEndpoints, configuredEndpoint);\n          }\n        }\n      }, this);\n    }\n    this.addRoute(path, routeOptions, collectionRouteEndpoints);\n    this.addRoute(path + \"/:id\", routeOptions, entityRouteEndpoints);\n    return this;\n  };\n\n\n  /**\n    A set of endpoints that can be applied to a Collection Route\n   */\n\n  Restivus.prototype._collectionEndpoints = {\n    get: function(collection) {\n      return {\n        get: {\n          action: function() {\n            var entity, selector;\n            selector = {\n              _id: this.urlParams.id\n            };\n            if (this.spaceId) {\n              selector.space = this.spaceId;\n            }\n            entity = collection.findOne(selector);\n            if (entity) {\n              return {\n                status: 'success',\n                data: entity\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'Item not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    put: function(collection) {\n      return {\n        put: {\n          action: function() {\n            var entity, entityIsUpdated, selector;\n            selector = {\n              _id: this.urlParams.id\n            };\n            if (this.spaceId) {\n              selector.space = this.spaceId;\n            }\n            entityIsUpdated = collection.update(selector, {\n              $set: this.bodyParams\n            });\n            if (entityIsUpdated) {\n              entity = collection.findOne(this.urlParams.id);\n              return {\n                status: 'success',\n                data: entity\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'Item not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    \"delete\": function(collection) {\n      return {\n        \"delete\": {\n          action: function() {\n            var selector;\n            selector = {\n              _id: this.urlParams.id\n            };\n            if (this.spaceId) {\n              selector.space = this.spaceId;\n            }\n            if (collection.remove(selector)) {\n              return {\n                status: 'success',\n                data: {\n                  message: 'Item removed'\n                }\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'Item not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    post: function(collection) {\n      return {\n        post: {\n          action: function() {\n            var entity, entityId;\n            if (this.spaceId) {\n              this.bodyParams.space = this.spaceId;\n            }\n            entityId = collection.insert(this.bodyParams);\n            entity = collection.findOne(entityId);\n            if (entity) {\n              return {\n                statusCode: 201,\n                body: {\n                  status: 'success',\n                  data: entity\n                }\n              };\n            } else {\n              return {\n                statusCode: 400,\n                body: {\n                  status: 'fail',\n                  message: 'No item added'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    getAll: function(collection) {\n      return {\n        get: {\n          action: function() {\n            var entities, selector;\n            selector = {};\n            if (this.spaceId) {\n              selector.space = this.spaceId;\n            }\n            entities = collection.find(selector).fetch();\n            if (entities) {\n              return {\n                status: 'success',\n                data: entities\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'Unable to retrieve items from collection'\n                }\n              };\n            }\n          }\n        }\n      };\n    }\n  };\n\n\n  /**\n    A set of endpoints that can be applied to a Meteor.users Collection Route\n   */\n\n  Restivus.prototype._userCollectionEndpoints = {\n    get: function(collection) {\n      return {\n        get: {\n          action: function() {\n            var entity;\n            entity = collection.findOne(this.urlParams.id, {\n              fields: {\n                profile: 1\n              }\n            });\n            if (entity) {\n              return {\n                status: 'success',\n                data: entity\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'User not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    put: function(collection) {\n      return {\n        put: {\n          action: function() {\n            var entity, entityIsUpdated;\n            entityIsUpdated = collection.update(this.urlParams.id, {\n              $set: {\n                profile: this.bodyParams\n              }\n            });\n            if (entityIsUpdated) {\n              entity = collection.findOne(this.urlParams.id, {\n                fields: {\n                  profile: 1\n                }\n              });\n              return {\n                status: \"success\",\n                data: entity\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'User not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    \"delete\": function(collection) {\n      return {\n        \"delete\": {\n          action: function() {\n            if (collection.remove(this.urlParams.id)) {\n              return {\n                status: 'success',\n                data: {\n                  message: 'User removed'\n                }\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'User not found'\n                }\n              };\n            }\n          }\n        }\n      };\n    },\n    post: function(collection) {\n      return {\n        post: {\n          action: function() {\n            var entity, entityId;\n            entityId = Accounts.createUser(this.bodyParams);\n            entity = collection.findOne(entityId, {\n              fields: {\n                profile: 1\n              }\n            });\n            if (entity) {\n              return {\n                statusCode: 201,\n                body: {\n                  status: 'success',\n                  data: entity\n                }\n              };\n            } else {\n              ({\n                statusCode: 400\n              });\n              return {\n                status: 'fail',\n                message: 'No user added'\n              };\n            }\n          }\n        }\n      };\n    },\n    getAll: function(collection) {\n      return {\n        get: {\n          action: function() {\n            var entities;\n            entities = collection.find({}, {\n              fields: {\n                profile: 1\n              }\n            }).fetch();\n            if (entities) {\n              return {\n                status: 'success',\n                data: entities\n              };\n            } else {\n              return {\n                statusCode: 404,\n                body: {\n                  status: 'fail',\n                  message: 'Unable to retrieve users'\n                }\n              };\n            }\n          }\n        }\n      };\n    }\n  };\n\n\n  /*\n    Add /login and /logout endpoints to the API\n   */\n\n  Restivus.prototype._initAuth = function() {\n    var logout, self;\n    self = this;\n\n    /*\n      Add a login endpoint to the API\n    \n      After the user is logged in, the onLoggedIn hook is called (see Restfully.configure() for\n      adding hook).\n     */\n    this.addRoute('login', {\n      authRequired: false\n    }, {\n      post: function() {\n        var auth, e, extraData, ref, ref1, response, searchQuery, user;\n        user = {};\n        if (this.bodyParams.user) {\n          if (this.bodyParams.user.indexOf('@') === -1) {\n            user.username = this.bodyParams.user;\n          } else {\n            user.email = this.bodyParams.user;\n          }\n        } else if (this.bodyParams.username) {\n          user.username = this.bodyParams.username;\n        } else if (this.bodyParams.email) {\n          user.email = this.bodyParams.email;\n        }\n        try {\n          auth = Auth.loginWithPassword(user, this.bodyParams.password);\n        } catch (error) {\n          e = error;\n          console.error(e);\n          return {\n            statusCode: e.error,\n            body: {\n              status: 'error',\n              message: e.reason\n            }\n          };\n        }\n        if (auth.userId && auth.authToken) {\n          searchQuery = {};\n          searchQuery[self._config.auth.token] = Accounts._hashLoginToken(auth.authToken);\n          this.user = Meteor.users.findOne({\n            '_id': auth.userId\n          }, searchQuery);\n          this.userId = (ref = this.user) != null ? ref._id : void 0;\n        }\n        response = {\n          status: 'success',\n          data: auth\n        };\n        extraData = (ref1 = self._config.onLoggedIn) != null ? ref1.call(this) : void 0;\n        if (extraData != null) {\n          _.extend(response.data, {\n            extra: extraData\n          });\n        }\n        return response;\n      }\n    });\n    logout = function() {\n      var authToken, extraData, hashedToken, index, ref, response, tokenFieldName, tokenLocation, tokenPath, tokenRemovalQuery, tokenToRemove;\n      authToken = this.request.headers['x-auth-token'];\n      hashedToken = Accounts._hashLoginToken(authToken);\n      tokenLocation = self._config.auth.token;\n      index = tokenLocation.lastIndexOf('.');\n      tokenPath = tokenLocation.substring(0, index);\n      tokenFieldName = tokenLocation.substring(index + 1);\n      tokenToRemove = {};\n      tokenToRemove[tokenFieldName] = hashedToken;\n      tokenRemovalQuery = {};\n      tokenRemovalQuery[tokenPath] = tokenToRemove;\n      Meteor.users.update(this.user._id, {\n        $pull: tokenRemovalQuery\n      });\n      response = {\n        status: 'success',\n        data: {\n          message: 'You\\'ve been logged out!'\n        }\n      };\n      extraData = (ref = self._config.onLoggedOut) != null ? ref.call(this) : void 0;\n      if (extraData != null) {\n        _.extend(response.data, {\n          extra: extraData\n        });\n      }\n      return response;\n    };\n\n    /*\n      Add a logout endpoint to the API\n    \n      After the user is logged out, the onLoggedOut hook is called (see Restfully.configure() for\n      adding hook).\n     */\n    return this.addRoute('logout', {\n      authRequired: true\n    }, {\n      get: function() {\n        console.warn(\"Warning: Default logout via GET will be removed in Restivus v1.0. Use POST instead.\");\n        console.warn(\"    See https://github.com/kahmali/meteor-restivus/issues/100\");\n        return logout.call(this);\n      },\n      post: logout\n    });\n  };\n\n  return Restivus;\n\n})();\n\nRestivus = this.Restivus;\n","if Meteor.isServer\n    @API = new Restivus\n        apiPath: 'steedos/api/',\n        useDefaultAuth: true\n        prettyJson: true\n        enableCors: false\n        defaultHeaders:\n          'Content-Type': 'application/json'","if (Meteor.isServer) {\n  this.API = new Restivus({\n    apiPath: 'steedos/api/',\n    useDefaultAuth: true,\n    prettyJson: true,\n    enableCors: false,\n    defaultHeaders: {\n      'Content-Type': 'application/json'\n    }\n  });\n}\n","Busboy = require('busboy');\nFiber = require('fibers');\n\nJsonRoutes.parseFiles = (req, res, next) ->\n    files = []; # Store files in an array and then pass them to request.\n    image = {}; # crate an image object\n\n    if (req.method == \"POST\")\n      busboy = new Busboy({ headers: req.headers });\n      busboy.on \"file\",  (fieldname, file, filename, encoding, mimetype) ->\n        image.mimeType = mimetype;\n        image.encoding = encoding;\n        image.filename = filename;\n\n        # buffer the read chunks\n        buffers = [];\n\n        file.on 'data', (data) ->\n          buffers.push(data);\n\n        file.on 'end', () ->\n          # concat the chunks\n          image.data = Buffer.concat(buffers);\n          # push the image object to the file array\n          files.push(image);\n\n\n      busboy.on \"field\", (fieldname, value) ->\n        req.body[fieldname] = value;\n\n      busboy.on \"finish\",  () ->\n        # Pass the file array together with the request\n        req.files = files;\n\n        Fiber ()->\n          next();\n        .run();\n\n      # Pass request to busboy\n      req.pipe(busboy);\n\n    else\n      next();\n\n\n#JsonRoutes.Middleware.use(JsonRoutes.parseFiles);\n\nJsonRoutes.add \"post\", \"/api/v4/instances/s3/\",  (req, res, next) ->\n\n  JsonRoutes.parseFiles req, res, ()->\n    collection = cfs.instances\n\n    if req.files and req.files[0]\n\n      newFile = new FS.File();\n      newFile.attachData req.files[0].data, {type: req.files[0].mimeType}, (err) ->\n        filename = req.files[0].filename\n\n        if [\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())\n          filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop()\n\n        body = req.body\n        try\n          if body && (body['upload_from'] is \"IE\" or body['upload_from'] is \"node\")\n            filename = decodeURIComponent(filename)\n        catch e\n          console.error(filename)\n          console.error e\n          filename = filename.replace(/%/g, \"-\")\n\n        newFile.name(filename)\n        \n        if body && body['owner'] && body['owner_name'] && body['space'] && body['instance']  && body['approve']\n          parent = ''\n          metadata = {owner:body['owner'], owner_name:body['owner_name'], space:body['space'], instance:body['instance'], approve: body['approve'], current: true}\n\n          if body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() == \"true\"\n            metadata.is_private = true\n          else\n            metadata.is_private = false\n\n          if body['main'] == \"true\"\n            metadata.main = true\n\n          if body['isAddVersion'] && body['parent']\n            parent = body['parent']\n          # else\n          #   collection.find({'metadata.instance': body['instance'], 'metadata.current' : true}).forEach (c) ->\n          #     if c.name() == filename\n          #       parent = c.metadata.parent\n\n          if parent\n            r = collection.update({'metadata.parent': parent, 'metadata.current' : true}, {$unset : {'metadata.current' : ''}})\n            if r\n              metadata.parent = parent\n              if body['locked_by'] && body['locked_by_name']\n                metadata.locked_by = body['locked_by']\n                metadata.locked_by_name = body['locked_by_name']\n\n              newFile.metadata = metadata\n              fileObj = collection.insert newFile\n\n              # 删除同一个申请单同一个步骤同一个人上传的重复的文件\n              if body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() == \"true\"\n                collection.remove({'metadata.instance': body['instance'], 'metadata.parent': parent, 'metadata.owner': body['owner'], 'metadata.approve': body['approve'], 'metadata.current': {$ne: true}})\n          else\n            newFile.metadata = metadata\n            fileObj = collection.insert newFile\n            fileObj.update({$set: {'metadata.parent' : fileObj._id}})\n\n        # 兼容老版本\n        else\n          fileObj = collection.insert newFile\n\n\n        size = fileObj.original.size\n        if !size\n          size = 1024\n\n        resp =\n          version_id: fileObj._id,\n          size: size\n\n        res.setHeader(\"x-amz-version-id\",fileObj._id);\n        res.end(JSON.stringify(resp));\n        return\n    else\n      res.statusCode = 500;\n      res.end();\n\n\nJsonRoutes.add \"delete\", \"/api/v4/instances/s3/\",  (req, res, next) ->\n\n  collection = cfs.instances\n\n  id = req.query.version_id;\n  if id\n    file = collection.findOne({ _id: id })\n    if file\n      file.remove()\n      resp = {\n        status: \"OK\"\n      }\n      res.end(JSON.stringify(resp));\n      return\n\n  res.statusCode = 404;\n  res.end();\n\n\nJsonRoutes.add \"get\", \"/api/v4/instances/s3/\",  (req, res, next) ->\n\n  id = req.query.version_id;\n\n  res.statusCode = 302;\n  res.setHeader \"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + id + \"?download=1\"\n  res.end();\n\n\n# Meteor.methods\n\n#   s3_upgrade: (min, max) ->\n#     console.log(\"/s3/upgrade\")\n\n#     fs = require('fs')\n#     mime = require('mime')\n\n#     root_path = \"/mnt/fakes3/10\"\n#     console.log(root_path)\n#     collection = cfs.instances\n\n#     # 遍历instance 拼出附件路径 到本地找对应文件 分两种情况 1./filename_versionId 2./filename；\n#     deal_with_version = (root_path, space, ins_id, version, attach_filename) ->\n#       _rev = version._rev\n#       if (collection.find({\"_id\": _rev}).count() >0)\n#         return\n#       created_by = version.created_by\n#       approve = version.approve\n#       filename = version.filename || attach_filename;\n#       mime_type = mime.lookup(filename)\n#       new_path = root_path + \"/spaces/\" + space + \"/workflow/\" + ins_id + \"/\" + filename + \"_\" + _rev\n#       old_path = root_path + \"/spaces/\" + space + \"/workflow/\" + ins_id + \"/\" + filename\n\n#       readFile = (full_path) ->\n#         data = fs.readFileSync full_path\n\n#         if data\n#           newFile = new FS.File();\n#           newFile._id = _rev;\n#           newFile.metadata = {owner:created_by, space:space, instance:ins_id, approve: approve};\n#           newFile.attachData data, {type: mime_type}\n#           newFile.name(filename)\n#           fileObj = collection.insert newFile\n#           console.log(fileObj._id)\n\n#       try\n#         n = fs.statSync new_path\n#         if n && n.isFile()\n#           readFile new_path\n#       catch error\n#         try\n#           old = fs.statSync old_path\n#           if old && old.isFile()\n#             readFile old_path\n#         catch error\n#           console.error(\"file not found: \" + old_path)\n\n\n#     count = db.instances.find({\"attachments.current\": {$exists: true}}, {sort: {modified: -1}}).count();\n#     console.log(\"all instances: \" + count)\n\n#     b = new Date()\n\n#     i = min\n#     db.instances.find({\"attachments.current\": {$exists: true}}, {sort: {modified: -1}, skip: min, limit: max-min}).forEach (ins) ->\n#       i = i + 1\n#       console.log(i + \":\" + ins.name)\n#       attachs = ins.attachments\n#       space = ins.space\n#       ins_id = ins._id\n#       attachs.forEach (att) ->\n#         deal_with_version root_path, space, ins_id, att.current, att.filename\n#         if att.historys\n#           att.historys.forEach (his) ->\n#             deal_with_version root_path, space, ins_id, his, att.filename\n\n#     console.log(new Date() - b)\n\n#     return \"ok\"\n","var Busboy, Fiber;\n\nBusboy = require('busboy');\n\nFiber = require('fibers');\n\nJsonRoutes.parseFiles = function(req, res, next) {\n  var busboy, files, image;\n  files = [];\n  image = {};\n  if (req.method === \"POST\") {\n    busboy = new Busboy({\n      headers: req.headers\n    });\n    busboy.on(\"file\", function(fieldname, file, filename, encoding, mimetype) {\n      var buffers;\n      image.mimeType = mimetype;\n      image.encoding = encoding;\n      image.filename = filename;\n      buffers = [];\n      file.on('data', function(data) {\n        return buffers.push(data);\n      });\n      return file.on('end', function() {\n        image.data = Buffer.concat(buffers);\n        return files.push(image);\n      });\n    });\n    busboy.on(\"field\", function(fieldname, value) {\n      return req.body[fieldname] = value;\n    });\n    busboy.on(\"finish\", function() {\n      req.files = files;\n      return Fiber(function() {\n        return next();\n      }).run();\n    });\n    return req.pipe(busboy);\n  } else {\n    return next();\n  }\n};\n\nJsonRoutes.add(\"post\", \"/api/v4/instances/s3/\", function(req, res, next) {\n  return JsonRoutes.parseFiles(req, res, function() {\n    var collection, newFile;\n    collection = cfs.instances;\n    if (req.files && req.files[0]) {\n      newFile = new FS.File();\n      return newFile.attachData(req.files[0].data, {\n        type: req.files[0].mimeType\n      }, function(err) {\n        var body, e, fileObj, filename, metadata, parent, r, resp, size;\n        filename = req.files[0].filename;\n        if ([\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())) {\n          filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop();\n        }\n        body = req.body;\n        try {\n          if (body && (body['upload_from'] === \"IE\" || body['upload_from'] === \"node\")) {\n            filename = decodeURIComponent(filename);\n          }\n        } catch (error) {\n          e = error;\n          console.error(filename);\n          console.error(e);\n          filename = filename.replace(/%/g, \"-\");\n        }\n        newFile.name(filename);\n        if (body && body['owner'] && body['owner_name'] && body['space'] && body['instance'] && body['approve']) {\n          parent = '';\n          metadata = {\n            owner: body['owner'],\n            owner_name: body['owner_name'],\n            space: body['space'],\n            instance: body['instance'],\n            approve: body['approve'],\n            current: true\n          };\n          if (body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() === \"true\") {\n            metadata.is_private = true;\n          } else {\n            metadata.is_private = false;\n          }\n          if (body['main'] === \"true\") {\n            metadata.main = true;\n          }\n          if (body['isAddVersion'] && body['parent']) {\n            parent = body['parent'];\n          }\n          if (parent) {\n            r = collection.update({\n              'metadata.parent': parent,\n              'metadata.current': true\n            }, {\n              $unset: {\n                'metadata.current': ''\n              }\n            });\n            if (r) {\n              metadata.parent = parent;\n              if (body['locked_by'] && body['locked_by_name']) {\n                metadata.locked_by = body['locked_by'];\n                metadata.locked_by_name = body['locked_by_name'];\n              }\n              newFile.metadata = metadata;\n              fileObj = collection.insert(newFile);\n              if (body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() === \"true\") {\n                collection.remove({\n                  'metadata.instance': body['instance'],\n                  'metadata.parent': parent,\n                  'metadata.owner': body['owner'],\n                  'metadata.approve': body['approve'],\n                  'metadata.current': {\n                    $ne: true\n                  }\n                });\n              }\n            }\n          } else {\n            newFile.metadata = metadata;\n            fileObj = collection.insert(newFile);\n            fileObj.update({\n              $set: {\n                'metadata.parent': fileObj._id\n              }\n            });\n          }\n        } else {\n          fileObj = collection.insert(newFile);\n        }\n        size = fileObj.original.size;\n        if (!size) {\n          size = 1024;\n        }\n        resp = {\n          version_id: fileObj._id,\n          size: size\n        };\n        res.setHeader(\"x-amz-version-id\", fileObj._id);\n        res.end(JSON.stringify(resp));\n      });\n    } else {\n      res.statusCode = 500;\n      return res.end();\n    }\n  });\n});\n\nJsonRoutes.add(\"delete\", \"/api/v4/instances/s3/\", function(req, res, next) {\n  var collection, file, id, resp;\n  collection = cfs.instances;\n  id = req.query.version_id;\n  if (id) {\n    file = collection.findOne({\n      _id: id\n    });\n    if (file) {\n      file.remove();\n      resp = {\n        status: \"OK\"\n      };\n      res.end(JSON.stringify(resp));\n      return;\n    }\n  }\n  res.statusCode = 404;\n  return res.end();\n});\n\nJsonRoutes.add(\"get\", \"/api/v4/instances/s3/\", function(req, res, next) {\n  var id;\n  id = req.query.version_id;\n  res.statusCode = 302;\n  res.setHeader(\"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + id + \"?download=1\");\n  return res.end();\n});\n","JsonRoutes.add \"post\", \"/api/push/message\", (req, res, next) ->\n    if req.body?.pushTopic and req.body.userIds and req.body.data\n        message = \n            from: \"steedos\"\n            query:\n                appName: req.body.pushTopic\n                userId: \n                    \"$in\": userIds\n        if req.body.data.alertTitle?\n            message[\"title\"] = req.body.data.alertTitle\n        if req.body.data.alert?\n            message[\"text\"] = req.body.data.alert\n        if req.body.data.badge?\n            message[\"badge\"] = req.body.data.badge + \"\"\n        if req.body.data.sound?\n            message[\"sound\"] = req.body.data.sound\n        #if req.body.data.data?\n        #    message[\"data\"] = req.body.data.data\n        Push.send message\n\n        res.end(\"success\");\n\n\n\nMeteor.methods\n    pushSend: (text,title,badge,userId) ->\n        if (!userId)\n            return;\n        Push.send\n            from: 'steedos',\n            title: title,\n            text: text,\n            badge: badge,\n            query: \n                userId: userId\n                appName: \"workflow\"\n","JsonRoutes.add(\"post\", \"/api/push/message\", function(req, res, next) {\n  var message, ref;\n  if (((ref = req.body) != null ? ref.pushTopic : void 0) && req.body.userIds && req.body.data) {\n    message = {\n      from: \"steedos\",\n      query: {\n        appName: req.body.pushTopic,\n        userId: {\n          \"$in\": userIds\n        }\n      }\n    };\n    if (req.body.data.alertTitle != null) {\n      message[\"title\"] = req.body.data.alertTitle;\n    }\n    if (req.body.data.alert != null) {\n      message[\"text\"] = req.body.data.alert;\n    }\n    if (req.body.data.badge != null) {\n      message[\"badge\"] = req.body.data.badge + \"\";\n    }\n    if (req.body.data.sound != null) {\n      message[\"sound\"] = req.body.data.sound;\n    }\n    Push.send(message);\n    return res.end(\"success\");\n  }\n});\n\nMeteor.methods({\n  pushSend: function(text, title, badge, userId) {\n    if (!userId) {\n      return;\n    }\n    return Push.send({\n      from: 'steedos',\n      title: title,\n      text: text,\n      badge: badge,\n      query: {\n        userId: userId,\n        appName: \"workflow\"\n      }\n    });\n  }\n});\n"]}