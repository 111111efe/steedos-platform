{"version":3,"sources":["meteor://ðŸ’»app/packages/steedos_cors/cors.coffee","meteor://ðŸ’»app/cors.coffee"],"names":["_staticFilesMiddleware","WebApp","rawConnectHandlers","use","req","res","next","buf","ref","_body","headers","isNaN","setEncoding","on","chunk","err","Steedos","debugLevel","console","log","green","method","url","body","JSON","parse","error","setHeader","toUpperCase","origin","statusCode","end","key","val","toLowerCase","apply","arguments","WebAppInternals","staticFilesMiddleware","staticFiles"],"mappings":"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","file":"/packages/steedos_cors.js","sourcesContent":["# Adding CORS headers so we can use CDNs for static content\r\n\r\n# Try to parse all request bodies as JSON\r\nWebApp.rawConnectHandlers.use (req, res, next) ->\r\n\tif req._body\r\n\t\treturn next()\r\n\r\n\tif req.headers['transfer-encoding'] is undefined and isNaN(req.headers['content-length'])\r\n\t\treturn next()\r\n\r\n\tif req.headers['content-type'] not in ['', undefined]\r\n\t\treturn next()\r\n\r\n\tbuf = ''\r\n\treq.setEncoding('utf8')\r\n\treq.on 'data', (chunk) -> buf += chunk\r\n\treq.on 'end', ->\r\n\t\tif Steedos?.debugLevel? and Steedos.debugLevel is 'debug'\r\n\t\t\tconsole.log '[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf\r\n\r\n\t\ttry\r\n\t\t\treq.body = JSON.parse(buf)\r\n\t\tcatch err\r\n\t\t\treq.body = buf\r\n\r\n\t\treq._body = true\r\n\t\tnext()\r\n\r\n\r\nWebApp.rawConnectHandlers.use (req, res, next) ->\r\n\t#if /^\\/(api|_timesync|sockjs|tap-i18n)(\\/|$)/.test req.url\r\n\tmethod = req.method && req.method.toUpperCase && req.method.toUpperCase();\r\n\r\n\tif req.headers.origin\r\n\t\tres.setHeader(\"Access-Control-Allow-Credentials\", \"true\");\r\n\t\tres.setHeader(\"Access-Control-Allow-Methods\", \"GET, POST, OPTIONS, PUT, DELETE\");\r\n\t\tres.setHeader(\"Access-Control-Allow-Origin\", req.headers.origin)\r\n\telse\r\n\t\tres.setHeader(\"Access-Control-Allow-Origin\", \"*\")\r\n\r\n\tif method == 'OPTIONS'\r\n\t\tres.setHeader(\"Access-Control-Allow-Headers\", \"Origin,X-Requested-With,Content-Type,Accept,X-Auth-Token,X-User-Id,X-Space-Id\");\r\n\t\tres.statusCode = 204;\r\n\t\tres.setHeader('Content-Length', '0');\r\n\t\tres.end();\r\n\t\treturn ;\r\n\r\n\t# Block next handlers to override CORS with value http://meteor.local\r\n\tsetHeader = res.setHeader\r\n\tres.setHeader = (key, val) ->\r\n\t\tif key.toLowerCase() is 'access-control-allow-origin' and val is 'http://meteor.local'\r\n\t\t\treturn\r\n\t\treturn setHeader.apply @, arguments\r\n\r\n\treturn next()\r\n\r\n_staticFilesMiddleware = WebAppInternals.staticFilesMiddleware\r\nWebAppInternals._staticFilesMiddleware = (staticFiles, req, res, next) ->\r\n\tres.setHeader(\"Access-Control-Allow-Origin\", \"*\")\r\n\t_staticFilesMiddleware(staticFiles, req, res, next)\r\n\r\n\r\n","var _staticFilesMiddleware;\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n  var buf, ref;\n  if (req._body) {\n    return next();\n  }\n  if (req.headers['transfer-encoding'] === void 0 && isNaN(req.headers['content-length'])) {\n    return next();\n  }\n  if ((ref = req.headers['content-type']) !== '' && ref !== (void 0)) {\n    return next();\n  }\n  buf = '';\n  req.setEncoding('utf8');\n  req.on('data', function(chunk) {\n    return buf += chunk;\n  });\n  return req.on('end', function() {\n    var err;\n    if (((typeof Steedos !== \"undefined\" && Steedos !== null ? Steedos.debugLevel : void 0) != null) && Steedos.debugLevel === 'debug') {\n      console.log('[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf);\n    }\n    try {\n      req.body = JSON.parse(buf);\n    } catch (error) {\n      err = error;\n      req.body = buf;\n    }\n    req._body = true;\n    return next();\n  });\n});\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n  var method, setHeader;\n  method = req.method && req.method.toUpperCase && req.method.toUpperCase();\n  if (req.headers.origin) {\n    res.setHeader(\"Access-Control-Allow-Credentials\", \"true\");\n    res.setHeader(\"Access-Control-Allow-Methods\", \"GET, POST, OPTIONS, PUT, DELETE\");\n    res.setHeader(\"Access-Control-Allow-Origin\", req.headers.origin);\n  } else {\n    res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n  }\n  if (method === 'OPTIONS') {\n    res.setHeader(\"Access-Control-Allow-Headers\", \"Origin,X-Requested-With,Content-Type,Accept,X-Auth-Token,X-User-Id,X-Space-Id\");\n    res.statusCode = 204;\n    res.setHeader('Content-Length', '0');\n    res.end();\n    return;\n  }\n  setHeader = res.setHeader;\n  res.setHeader = function(key, val) {\n    if (key.toLowerCase() === 'access-control-allow-origin' && val === 'http://meteor.local') {\n      return;\n    }\n    return setHeader.apply(this, arguments);\n  };\n  return next();\n});\n\n_staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function(staticFiles, req, res, next) {\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n  return _staticFilesMiddleware(staticFiles, req, res, next);\n};\n"]}