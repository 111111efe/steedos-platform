{"version":3,"sources":["meteor://💻app/packages/steedos:app-workflow/checkNpm.js","meteor://💻app/packages/steedos_app-workflow/core.coffee","meteor://💻app/core.coffee","meteor://💻app/packages/steedos_app-workflow/server/methods/flow_copy.coffee","meteor://💻app/server/methods/flow_copy.coffee","meteor://💻app/packages/steedos_app-workflow/server/methods/distribute.coffee","meteor://💻app/server/methods/distribute.coffee","meteor://💻app/packages/steedos:app-workflow/server/lib/workflow_manager.js","meteor://💻app/packages/steedos_app-workflow/server/lib/uuflow_manager.coffee","meteor://💻app/server/lib/uuflow_manager.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/push_manager.coffee","meteor://💻app/server/lib/push_manager.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/export.coffee","meteor://💻app/server/lib/export.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/import.coffee","meteor://💻app/server/lib/import.coffee","meteor://💻app/packages/steedos_app-workflow/workflow.app.coffee","meteor://💻app/packages/steedos_app-workflow/cfs/instances.coffee","meteor://💻app/cfs/instances.coffee","meteor://💻app/packages/steedos_app-workflow/routes/export.coffee","meteor://💻app/routes/export.coffee","meteor://💻app/packages/steedos_app-workflow/routes/import.coffee","meteor://💻app/routes/import.coffee"],"names":["checkNpmVersions","module","link","v","cookies","mkdirp","WorkflowCore","Meteor","isClient","openFlowDesign","locale","space","flow","companyId","url","Creator","isSpaceAdmin","userId","Steedos","openWindow","absoluteUrl","openFormDesign","form","Modal","show","formId","keyboard","backdrop","startup","$","document","keydown","e","keyCode","key","length","target","tagName","closest","hasClass","click","isServer","checkCreatePermissions","spaceId","uid","company_id","getCollection","find","_id","count","methods","flow_copy","flowId","options","Error","db","flows","copy","get_distribute_flows","opts","pinyin","query","searchText","values","params","unblock","JSON","parse","Array","test","state","name","$regex","limit","fields","fetch","$in","forEach","f","spaces","findOne","push","label","value","update_distribute_settings","flow_id","distribute_optional_users_id","step_flows","distribute_to_self","distribute_end_notification","distribute_optional_users","setObj","check","String","Boolean","Object","_","each","current","steps","s","allowDistribute","sf","distribute_optional_flows","users","u","id","isEmpty","update","$set","WorkflowManager","getPositionsFilterByUsers","orgId","roleId","flow_positions","role","org","uniqUsers","users_str","users_obj","stringify","uniq","us","getRoleUsersbyOrgAndRole","roleUsers","orgPositions","orgPosition","roleUserIds","concat","getUsers","organization","getOrganization","parent","getRoleUsersByOrgAndRoles","roleIds","getRoleUsersByOrgsAndRoles","orgIds","getRoleUsersByUsersAndRoles","userIds","user","organizations","getSpaceRoles","flow_roles","getRole","getSpacePositions","getUserRoles","userRoles","userPositions","userPosition","getOrganizationsUsers","orgs","orgUsers","getSpaceOrganizations","getOrganizationChildrens","parents","getOrganizationsChildrens","chidrenOrgs","created","created_by","modified","modified_by","getOrganizations","getUser","notNeedDetails","spaceUser","space_users","roles","spaceUsers","getFormulaUsers","userObject","fullname","getProperty","hr","sort_no","mobile","work_phone","position","getFormulaUserObjects","getFormulaUserObject","getFormulaOrgObjects","getFormulaOrgObject","orgArray","orgObject","getInstanceFormVersion","instance","Template","view","template","steedosData","form_fields","form_version","forms","where","historys","field","type","getFormVersion","versionId","findPropertyByPK","getInstanceFlowVersion","flow_version","getInstanceStep","stepId","g_step","step","canAdmin","fl","curSpaceUser","perms","hasAdminRight","users_can_admin","includes","orgs_can_admin","intersection","some","canMonitor","hasMonitorRight","users_can_monitor","orgs_can_monitor","hasInstancePermissions","admins","approvedUsers","union","outbox_users","inbox_users","cc_users","submitter","applicant","originalInstances","instances","related_instances","$all","console","log","hasPermission","ins","havePermissionUsers","getNameForUser","hasFlowAdminPermission","space_id","user_id","space_user","Cookies","require","uuflowManager","check_authorization","req","res","authToken","hashedToken","get","Accounts","_hashLoginToken","getInstance","instance_id","getSpace","getSpaceUser","getFlow","getSpaceUserOrgInfo","info","organization_name","organization_fullname","getTrace","trace_id","trace","traces","t","getApprove","approve_id","approve","approves","isTraceNotFinished","is_finished","isApproveNotFinished","isInstancePending","lang","TAPi18n","__","isHandlerOrAgent","agent","isInstanceDraft","isInstanceSubmitter","current_user_id","isInstanceSubmitterOrApplicantOrSpaceAdmin","getStep","step_id","flow_rev","isExistStep","history","isJudgeLegal","judge","getUserOrganization","positions","role_names","isFlowEnabled","isFlowSpaceMatched","calculateCondition","condition_str","__values","average","max","min","sum","subform_field","sum_field_value","field_value","Number","sub_field","eval","error","stack","setFormFieldVariable","_subform_values","group_fullname","group_id","group_name","organization_selectuser","role_selectuser","subform_fields_all","user_name","user_roles","current_field","values_arr","code","is_multiselect","group","select_user","getNextSteps","applicant_name","applicant_organization_fullname","applicant_organization_name","applicant_roles","approver_name","approver_organization_fullname","approver_organization_name","approver_roles","current_approve","flowVersions","flow_steps","formVersion","lines","nextSteps","prefix","reg","rejectedSteps","start_approve","step_type","submitter_name","submitter_organization_fullname","submitter_organization_name","submitter_roles","trace_steps","version_steps","getUpdatedValues","previous_trace_ids","handler_organization_fullname","handler_organization_name","handler","handler_name","step_line","step_line_condition","condition","replace","vowel","to_step","filter","line","pluck","flowVer","flow_ver_step","flow_step","history_step","next_step_id","_next_step","newest_values","trace_approve","extend","clone","getForm","form_id","form_v","form_h","getCategory","category_id","categories","getInstanceName","vals","default_value","iscript","name_forumla","rev","applicant_organization","moment","submit_date","utcOffset","format","indexOf","trim","getApproveValues","approve_values","permissions","instance_form","sectionField","formula","workflow_engine","approve_from_client","current_user_info","current_user","auto_submitted","applicant_id","checkApplicant","description","geolocation","i","instance_trace","key_str","last_step","last_step_type","last_trace","next_step","next_step_type","next_steps","space_user_org_info","to_users","trace_approves","updateObj","read_date","Date","next_step_user","checkSpaceUser","engine_step_type_is_start_or_submit_or_condition","engine_step_type_is_sign","engine_step_type_is_counterSign","keywords","caculateKeywords","final_decision","pushManager","send_instance_notification","send_message_current_user","last","triggerWebhook","distributedInstancesRemind","h","instance_traces","newTrace","next_step_name","next_step_users","next_user_ids","updated_values","approve_next_step","finish_date","handler_organization","cost_time","start_date","Mongo","ObjectID","_str","unshift","current_step_name","current_step_auto_submit","getHandlersManager","getHandlers","difference","due_date","getDueDate","timeout_hours","next_step_user_id","idx","handler_id","handler_info","newApprove","next_step_space_user","next_step_user_org_info","user_info","getAgent","is_read","is_error","setRemindInfo","getCurrentStepAutoSubmit","timeout_auto_submit","isAllApproveFinished","ref","ref1","ref2","ref3","oneClickApproval","settings","is_group_company","oneClickRejection","appro","splice","ins_html","instanceHtml","templateName","showTrace","showAttachments","width","styles","InstanceReadOnlyTemplate","getInstanceHtml","getFlowCompanyId","create_instance","instance_from_client","appr_obj","category","ins_obj","instance_flow_version","new_ins_id","now","start_step","trace_from_client","trace_obj","permissionManager","getFlowPermissions","_makeNewID","applicant_company","is_archived","is_deleted","auto_remind","flow_name","category_name","insert","timeout_line","l","hours","due_time","getTime","submit_instance","applicant_org_info","attachments","checkUsers","flow_has_upgrade","instance_name","nextTrace","submitter_id","upObj","alerts","current_no","nextApprove","direct","get_SpaceChangeSet","formids","is_admin","sync_token","changeSet","formids_ary","inserts","Spaces","Users","SpaceUsers","Organizations","Roles","Positions","Forms","Flows","Instances","updates","deletes","split","$gt","$lte","deleted_instances","deleted","steedos_id","submitter_steedos_id","applicant_steedos_id","ChangeSet","caculate_date","deadline","priority","remind_date","Match","OneOf","toString","caculateWorkingTime","caculatePlusHalfWorkingDay","base_date","plus_halfday_date","sendRemindSMS","reminded_count","ins_name","users_id","ins_id","send_users","skip_users","remind","substr","$exists","notification","payload","hasOwnProperty","SMSQueue","send","Format","Action","ParamString","RecNum","SignName","TemplateCode","msg","open_app_url","appName","Push","checkMainAttach","file_name","main","main_name_split","new_ins_name","cfs","pop","join","extension","multiValue","is_searchable","isArray","singleV","s_value","s_field","checkValueFieldsRequire","require_but_empty_fields","is_required","triggerRecordInstanceQueue","record_ids","step_name","newObj","cron","instancerecordqueue_interval","records","instance_finish_date","sent","sending","createdAt","createdBy","instance_record_queue","current_trace","next_approves","original_flow","original_instacne","original_instacne_id","original_user","distribute_from_instances","fromId","r","process_delegation_rules","from","enabled","start_time","end_time","$gte","to","cancelProcessDelegation","toId","ccQuery","$elemMatch","a","idxStr","send_message_to_specifyUser","$addToSet","timeoutAutoSubmit","nextStep","nextStepId","nextUserIds","toLine","updatedInstance","services","bqq_app_id","imo_app_cid","imo","appcid","imo_app_uid","appuid","imo_sync_app_key","sync_app_key","imo_push_app_key","push_app_key","get_to_users","send_from","cc_user_ids","approve_user_ids","remove_users","get_body","parameters","approves_description","body","currentStep_type","current_user_name","email_approve_type","email_description","email_final_decision","from_username","href","lastApprove_judge","lastApprove_usersname","last_approve_judge","nextApprove_usersname","nextStep_type","push_approve_type","push_final_decision","to_username","url_approve_type","approve_type","current_username","get_title","title","get_badge","badge","sk_all","sk_all_new","user_spaces","user_accepted","user_space","c","ref4","sk","sk_new","$or","steedos_keyvalues","workflow","send_to_imo","steedos_ids","appmsg","con","fromcid","fromuid","res_b","res_badge","res_m","res_msg","space_u","imo_uid","Math","round","to_s","HTTP","post","app","pushtype","appkey","tappkey","content","poptype","chart","send_to_qq","to_user","from_user","instance_state","i18n_obj","app_id","box","bqq_uri","employee_access_token","oauth","open_id","recv_open_ids","response","tips_url","$ne","encodeURI","data","ret","send_email_to_SMTP","subject","reply_user","email","email_notification","MailQueue","checkMailFromNameLength","html","send_message_by_raix_push","send_message","_approves_des","_approves_username","body_style_end","body_style_start","current_step","to_user_change","appr","_appr_description","_appr_userName","br","footnote","inscribed","push_body","time","timeEnd","action","from_user_id","to_user_ids","from_space_user","username","to_space_user","webhooks","active","w","WebhookQueue","payload_url","content_type","_getFlowByForm","steedosExport","is_copy","roles_name","approver_roles_name","approver_users","approver_orgs","_getFieldNumberRule","_getNumberRuleName","c_fields","instance_number_rules","str","isString","f1","number_rule","number_rule_name","year","first_number","rules","number","steedosImport","new_category","new_flow_ids","new_form_ids","owner","nr","is_valid","_rev","orgs_can_add","users_can_add","approve_roles","role_name","flow_role_query","role_id","remove","Apps","sort","is_creator","admin_menus","permission_sets","expanded","object_name","fs_store","store_name","store","FS","Store","OSS","region","aliyun","internal","bucket","folder","accessKeyId","secretAccessKey","S3","aws","FileSystem","path","steedosStorageDir","fileKeyMaker","fileObj","absolutePath","extention","filename","filenameInStore","final_filename","month","name_split","pathname","_getInfo","substring","getFullYear","getMonth","metadata","resolve","sync","collectionName","Collection","stores","allow","download","files","_ensureIndex","WebApp","connectHandlers","use","next","fileName","writeHead","end","is_paid","JsonRoutes","sendResult","setHeader","add","parseFiles","e1","jsonData","new_flowIds","new_flows","statusCode","reason"],"mappings":"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","file":"/packages/steedos_app-workflow.js","sourcesContent":["import {\r\n\tcheckNpmVersions\r\n} from 'meteor/tmeasday:check-npm-versions';\r\ncheckNpmVersions({\r\n\tcookies: \"^0.6.2\",\r\n\tmkdirp: \"^0.3.5\",\r\n}, 'steedos:app-workflow');","@WorkflowCore = {}\r\n\r\nif Meteor.isClient\r\n\tWorkflowCore.openFlowDesign = (locale, space, flow, companyId)->\r\n\t\turl = \"/applications/designer/current/?locale=#{locale}&space=#{space}\"\r\n\t\tif flow\r\n\t\t\turl = url + \"&flow=#{flow}\"\r\n\t\tif companyId && !Creator.isSpaceAdmin(space, Meteor.userId())\r\n\t\t\turl = url + \"&companyId=#{companyId}\"\r\n\t\tSteedos.openWindow Steedos.absoluteUrl(url)\r\n\tWorkflowCore.openFormDesign = (locale, space, form, companyId)->\r\n\t\tModal.show('formDesign', {formId: form}, {keyboard:false, backdrop: \"static\"})\r\n\r\n\tMeteor.startup ->\r\n\t\t$(document).keydown (e) ->\r\n\t\t\tif e.keyCode == \"13\" or e.key == \"Enter\"\r\n\t\t\t\tif $(\".flow-modal\").length != 1\r\n\t\t\t\t\treturn;\r\n\t\t\t\tif e.target.tagName != \"TEXTAREA\" or $(e.target).closest(\"div\").hasClass(\"bootstrap-tagsinput\")\r\n\t\t\t\t\tif $(\".flow-modal\").length == 1\r\n\t\t\t\t\t\t$(\".flow-modal .btn-confirm\").click()\r\n\r\nif Meteor.isServer\r\n\tWorkflowCore.checkCreatePermissions = (spaceId, uid, company_id)->\r\n#\t\tpermissions = Creator.getObjectPermissions(spaceId, uid, 'flows')\r\n#\r\n#\t\tif !permissions.allowCreate\r\n#\t\t\treturn false\r\n#\r\n#\t\t# 如果不是工作区管理员, 则必须要指定company_id\r\n#\t\tif !Steedos.isSpaceAdmin(spaceId, uid)\r\n#\t\t\tuserCompanyId = Creator.getUserCompanyId(uid, spaceId)\r\n#\t\t\tif !company_id || !userCompanyId || company_id != userCompanyId\r\n#\t\t\t\treturn false\r\n\r\n\t\tif company_id\r\n\t\t\tif Creator.getCollection(\"company\").find({ _id: company_id, space: spaceId }).count() == 0\r\n\t\t\t\treturn false\r\n\r\n\t\treturn true","this.WorkflowCore = {};\n\nif (Meteor.isClient) {\n  WorkflowCore.openFlowDesign = function(locale, space, flow, companyId) {\n    var url;\n    url = \"/applications/designer/current/?locale=\" + locale + \"&space=\" + space;\n    if (flow) {\n      url = url + (\"&flow=\" + flow);\n    }\n    if (companyId && !Creator.isSpaceAdmin(space, Meteor.userId())) {\n      url = url + (\"&companyId=\" + companyId);\n    }\n    return Steedos.openWindow(Steedos.absoluteUrl(url));\n  };\n  WorkflowCore.openFormDesign = function(locale, space, form, companyId) {\n    return Modal.show('formDesign', {\n      formId: form\n    }, {\n      keyboard: false,\n      backdrop: \"static\"\n    });\n  };\n  Meteor.startup(function() {\n    return $(document).keydown(function(e) {\n      if (e.keyCode === \"13\" || e.key === \"Enter\") {\n        if ($(\".flow-modal\").length !== 1) {\n          return;\n        }\n        if (e.target.tagName !== \"TEXTAREA\" || $(e.target).closest(\"div\").hasClass(\"bootstrap-tagsinput\")) {\n          if ($(\".flow-modal\").length === 1) {\n            return $(\".flow-modal .btn-confirm\").click();\n          }\n        }\n      }\n    });\n  });\n}\n\nif (Meteor.isServer) {\n  WorkflowCore.checkCreatePermissions = function(spaceId, uid, company_id) {\n    if (company_id) {\n      if (Creator.getCollection(\"company\").find({\n        _id: company_id,\n        space: spaceId\n      }).count() === 0) {\n        return false;\n      }\n    }\n    return true;\n  };\n}\n","Meteor.methods\r\n\tflow_copy: (spaceId, flowId, options)->\r\n\t\tif (!this.userId)\r\n\t\t\treturn;\r\n\r\n\t\tif !WorkflowCore.checkCreatePermissions(spaceId, this.userId, options?.company_id)\r\n\t\t\tthrow  Meteor.Error(\"No permission\");\r\n\r\n\t\tdb.flows.copy(this.userId, spaceId, flowId, options, false)","Meteor.methods({\n  flow_copy: function(spaceId, flowId, options) {\n    if (!this.userId) {\n      return;\n    }\n    if (!WorkflowCore.checkCreatePermissions(spaceId, this.userId, options != null ? options.company_id : void 0)) {\n      throw Meteor.Error(\"No permission\");\n    }\n    return db.flows.copy(this.userId, spaceId, flowId, options, false);\n  }\n});\n","Meteor.methods\r\n\tget_distribute_flows: (options) ->\r\n\t\tunless options.params\r\n\t\t\treturn []\r\n\r\n\t\tthis.unblock\r\n\t\tuid = this.userId\r\n\t\tsearchText = options.searchText\r\n\t\tvalues = options.values\r\n\t\tspaceId = JSON.parse(options.params).spaceId\r\n\r\n\t\t# Meteor.wrapAsync((callback) ->\r\n\t\t# \tMeteor.setTimeout (->\r\n\t\t# \t\tcallback()\r\n\t\t# \t\treturn\r\n\t\t# \t), 1000\r\n\t\t# \treturn\r\n\t\t# )()\r\n\r\n\t\topts = new Array\r\n\r\n\t\tflows = new Array\r\n\r\n\t\tif searchText\r\n\t\t\tpinyin = /^[a-zA-Z\\']*$/.test(searchText)\r\n\t\t\tif (pinyin && searchText.length > 8) || (!pinyin && searchText.length > 1)\r\n\t\t\t\tquery = { space: spaceId, state: 'enabled', name: { $regex: searchText } }\r\n\t\t\t\tflows = db.flows.find(query, { limit: 10, fields: { name: 1, space: 1 } }).fetch()\r\n\t\telse if values.length\r\n\t\t\tflows = db.flows.find({ _id: { $in: values } }, { fields: { name: 1, space: 1 } }).fetch()\r\n\r\n\t\tflows.forEach (f) ->\r\n\t\t\tspace = db.spaces.findOne({ _id: f.space }, { fields: { name: 1 } })\r\n\t\t\topts.push({ label: \"[#{space.name}]#{f.name}\", value: f._id })\r\n\r\n\t\treturn opts\r\n\r\n\tupdate_distribute_settings: (flow_id, distribute_optional_users_id, step_flows, distribute_to_self, distribute_end_notification) ->\r\n\t\tcheck flow_id, String\r\n\t\tcheck distribute_optional_users_id, Array\r\n\t\tcheck step_flows, Array\r\n\t\tcheck distribute_to_self, Boolean\r\n\t\tcheck distribute_end_notification, Boolean\r\n\r\n\t\tflow = db.flows.findOne(flow_id)\r\n\t\tif not flow\r\n\t\t\tthrow new Meteor.Error 'error', 'flow not found!'\r\n\r\n\t\tsetObj = new Object\r\n\r\n\t\t_.each flow.current.steps, (s) ->\r\n\t\t\tif s.allowDistribute is true\r\n\t\t\t\t_.each step_flows, (sf) ->\r\n\t\t\t\t\tif sf._id is s._id\r\n\t\t\t\t\t\ts.distribute_optional_flows = sf.distribute_optional_flows\r\n\r\n\t\tdistribute_optional_users = new Array\r\n\t\tdb.users.find({ _id: { $in: distribute_optional_users_id } }, { fields: { name: 1 } }).forEach (u) ->\r\n\t\t\tdistribute_optional_users.push({ id: u._id, name: u.name })\r\n\t\tsetObj.distribute_optional_users = distribute_optional_users\r\n\r\n\t\tif not _.isEmpty(step_flows)\r\n\t\t\tsetObj['current.steps'] = flow.current.steps\r\n\r\n\t\tsetObj['distribute_to_self'] = distribute_to_self\r\n\r\n\t\tsetObj['distribute_end_notification'] = distribute_end_notification\r\n\r\n\t\tdb.flows.update({ _id: flow_id }, { $set: setObj })\r\n\r\n\t\treturn true\r\n","Meteor.methods({\n  get_distribute_flows: function(options) {\n    var flows, opts, pinyin, query, searchText, spaceId, uid, values;\n    if (!options.params) {\n      return [];\n    }\n    this.unblock;\n    uid = this.userId;\n    searchText = options.searchText;\n    values = options.values;\n    spaceId = JSON.parse(options.params).spaceId;\n    opts = new Array;\n    flows = new Array;\n    if (searchText) {\n      pinyin = /^[a-zA-Z\\']*$/.test(searchText);\n      if ((pinyin && searchText.length > 8) || (!pinyin && searchText.length > 1)) {\n        query = {\n          space: spaceId,\n          state: 'enabled',\n          name: {\n            $regex: searchText\n          }\n        };\n        flows = db.flows.find(query, {\n          limit: 10,\n          fields: {\n            name: 1,\n            space: 1\n          }\n        }).fetch();\n      }\n    } else if (values.length) {\n      flows = db.flows.find({\n        _id: {\n          $in: values\n        }\n      }, {\n        fields: {\n          name: 1,\n          space: 1\n        }\n      }).fetch();\n    }\n    flows.forEach(function(f) {\n      var space;\n      space = db.spaces.findOne({\n        _id: f.space\n      }, {\n        fields: {\n          name: 1\n        }\n      });\n      return opts.push({\n        label: \"[\" + space.name + \"]\" + f.name,\n        value: f._id\n      });\n    });\n    return opts;\n  },\n  update_distribute_settings: function(flow_id, distribute_optional_users_id, step_flows, distribute_to_self, distribute_end_notification) {\n    var distribute_optional_users, flow, setObj;\n    check(flow_id, String);\n    check(distribute_optional_users_id, Array);\n    check(step_flows, Array);\n    check(distribute_to_self, Boolean);\n    check(distribute_end_notification, Boolean);\n    flow = db.flows.findOne(flow_id);\n    if (!flow) {\n      throw new Meteor.Error('error', 'flow not found!');\n    }\n    setObj = new Object;\n    _.each(flow.current.steps, function(s) {\n      if (s.allowDistribute === true) {\n        return _.each(step_flows, function(sf) {\n          if (sf._id === s._id) {\n            return s.distribute_optional_flows = sf.distribute_optional_flows;\n          }\n        });\n      }\n    });\n    distribute_optional_users = new Array;\n    db.users.find({\n      _id: {\n        $in: distribute_optional_users_id\n      }\n    }, {\n      fields: {\n        name: 1\n      }\n    }).forEach(function(u) {\n      return distribute_optional_users.push({\n        id: u._id,\n        name: u.name\n      });\n    });\n    setObj.distribute_optional_users = distribute_optional_users;\n    if (!_.isEmpty(step_flows)) {\n      setObj['current.steps'] = flow.current.steps;\n    }\n    setObj['distribute_to_self'] = distribute_to_self;\n    setObj['distribute_end_notification'] = distribute_end_notification;\n    db.flows.update({\n      _id: flow_id\n    }, {\n      $set: setObj\n    });\n    return true;\n  }\n});\n","WorkflowManager = {}\r\n\r\nWorkflowManager.getPositionsFilterByUsers = function (spaceId, orgId, roleId) {\r\n\tif (!spaceId || !orgId || !roleId)\r\n\t\treturn []\r\n\r\n\treturn db.flow_positions.find({\r\n\t\tspace: spaceId,\r\n\t\trole: roleId,\r\n\t\torg: orgId\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\tusers: 1\r\n\t\t}\r\n\t}).fetch();\r\n}\r\n\r\nWorkflowManager.uniqUsers = function (users) {\r\n\tif (_.isEmpty(users))\r\n\t\treturn []\r\n\r\n\tvar users_str = [],\r\n\t\tusers_obj = [];\r\n\t_.each(users, function (u) {\r\n\t\tusers_str.push(JSON.stringify(u))\r\n\t})\r\n\r\n\tusers_str = _.uniq(users_str);\r\n\r\n\t_.each(users_str, function (us) {\r\n\t\tusers_obj.push(JSON.parse(us))\r\n\t})\r\n\r\n\treturn users_obj\r\n}\r\n\r\n/*\r\n 返回指定部门下的角色成员,如果指定部门没有找到对应的角色，则会继续找部门的上级部门直到找到为止。\r\n return [{spaceUser}]\r\n */\r\nWorkflowManager.getRoleUsersbyOrgAndRole = function (spaceId, orgId, roleId) {\r\n\tvar roleUsers = new Array();\r\n\r\n\tvar orgPositions = WorkflowManager.getPositionsFilterByUsers(spaceId, orgId, roleId);\r\n\r\n\torgPositions.forEach(function (orgPosition) {\r\n\t\tvar roleUserIds = orgPosition.users;\r\n\t\troleUsers = roleUsers.concat(WorkflowManager.getUsers(spaceId, roleUserIds, true));\r\n\t});\r\n\r\n\tif (orgPositions.length == 0) {\r\n\t\tvar organization = WorkflowManager.getOrganization(orgId);\r\n\t\tif (organization && organization.parent != '')\r\n\t\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersbyOrgAndRole(spaceId, organization.parent, roleId));\r\n\t}\r\n\r\n\treturn roleUsers;\r\n};\r\n\r\nWorkflowManager.getRoleUsersByOrgAndRoles = function (spaceId, orgId, roleIds) {\r\n\r\n\tvar roleUsers = new Array();\r\n\r\n\troleIds.forEach(function (roleId) {\r\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersbyOrgAndRole(spaceId, orgId, roleId));\r\n\t});\r\n\r\n\treturn roleUsers;\r\n\r\n};\r\n\r\nWorkflowManager.getRoleUsersByOrgsAndRoles = function (spaceId, orgIds, roleIds) {\r\n\tvar roleUsers = new Array();\r\n\r\n\tif (!orgIds || !roleIds)\r\n\t\treturn roleUsers;\r\n\r\n\torgIds.forEach(function (orgId) {\r\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersByOrgAndRoles(spaceId, orgId, roleIds));\r\n\t});\r\n\r\n\treturn roleUsers;\r\n};\r\n\r\n/*\r\n 返回用户所在部门下的角色成员.\r\n return [{spaceUser}]\r\n */\r\nWorkflowManager.getRoleUsersByUsersAndRoles = function (spaceId, userIds, roleIds) {\r\n\r\n\tvar roleUsers = new Array();\r\n\r\n\tif (!userIds || !roleIds)\r\n\t\treturn roleUsers;\r\n\r\n\tvar users = WorkflowManager.getUsers(spaceId, userIds, true);\r\n\r\n\tusers.forEach(function (user) {\r\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, user.organizations, roleIds));\r\n\t});\r\n\r\n\treturn roleUsers;\r\n};\r\n\r\nWorkflowManager.getSpaceRoles = function (spaceId) {\r\n\tif (!spaceId) {\r\n\t\treturn;\r\n\t}\r\n\r\n\treturn db.flow_roles.find({\r\n\t\tspace: spaceId\r\n\t}).fetch();\r\n};\r\n\r\nWorkflowManager.getRole = function (spaceId, roleId) {\r\n\r\n\tif (!roleId || !spaceId) {\r\n\t\treturn;\r\n\t}\r\n\r\n\treturn db.flow_roles.findOne({\r\n\t\t_id: roleId,\r\n\t\tspace: spaceId\r\n\t});\r\n};\r\n\r\nWorkflowManager.getSpacePositions = function (spaceId) {\r\n\treturn db.flow_positions.find({\r\n\t\tspace: spaceId\r\n\t}).fetch();\r\n};\r\n\r\n//获取用户岗位\r\nWorkflowManager.getUserRoles = function (spaceId, orgId, userId) {\r\n\r\n\tvar userRoles = new Array();\r\n\r\n\t// var spacePositions = WorkflowManager.getSpacePositions(spaceId);\r\n\r\n\t//orgRoles = spacePositions.filterProperty(\"org\", orgId); ？？？\r\n\t// var userPositions = spacePositions.filterProperty(\"users\", userId);\r\n\r\n\tvar userPositions = db.flow_positions.find({\r\n\t\tspace: spaceId,\r\n\t\tusers: userId\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\trole: 1\r\n\t\t}\r\n\t});\r\n\r\n\tuserPositions.forEach(function (userPosition) {\r\n\t\tuserRoles.push(WorkflowManager.getRole(spaceId, userPosition.role));\r\n\t});\r\n\r\n\treturn userRoles;\r\n};\r\n\r\nWorkflowManager.getOrganizationsUsers = function (spaceId, orgs) {\r\n\r\n\tvar orgUsers = new Array();\r\n\r\n\torgs.forEach(function (org) {\r\n\t\torgUsers = orgUsers.concat(WorkflowManager.getUsers(spaceId, org.users, true));\r\n\t});\r\n\r\n\treturn orgUsers;\r\n}\r\n\r\n//获取space下的所有部门\r\nWorkflowManager.getSpaceOrganizations = function (spaceId) {\r\n\treturn db.organizations.find({\r\n\t\tspace: spaceId\r\n\t}).fetch();\r\n};\r\n\r\nWorkflowManager.getOrganizationChildrens = function (spaceId, orgId) {\r\n\treturn db.organizations.find({\r\n\t\tspace: spaceId,\r\n\t\tparents: orgId\r\n\t}).fetch();\r\n};\r\n\r\nWorkflowManager.getOrganizationsChildrens = function (spaceId, orgIds) {\r\n\tvar chidrenOrgs = new Array();\r\n\torgIds.forEach(function (orgId) {\r\n\t\tchidrenOrgs = chidrenOrgs.concat(WorkflowManager.getOrganizationChildrens(spaceId, orgId));\r\n\t});\r\n\r\n\treturn chidrenOrgs;\r\n};\r\n\r\nWorkflowManager.getOrganization = function (orgId) {\r\n\tif (!orgId) {\r\n\t\treturn;\r\n\t}\r\n\r\n\treturn db.organizations.findOne(orgId, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\r\n};\r\n\r\nWorkflowManager.getOrganizations = function (orgIds) {\r\n\tif (!orgIds) {\r\n\t\treturn [];\r\n\t}\r\n\r\n\tif (\"string\" == typeof (orgIds)) {\r\n\t\treturn [WorkflowManager.getOrganization(orgIds)]\r\n\t}\r\n\r\n\treturn db.organizations.find({\r\n\t\t_id: {\r\n\t\t\t$in: orgIds\r\n\t\t}\r\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}}).fetch();\r\n};\r\n\r\nWorkflowManager.getUser = function (spaceId, userId, notNeedDetails) {\r\n\tif (!userId || !spaceId) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (typeof userId != \"string\") {\r\n\t\treturn WorkflowManager.getUsers(spaceId, userId);\r\n\t}\r\n\r\n\tvar spaceUser = db.space_users.findOne({\r\n\t\tspace: spaceId,\r\n\t\tuser: userId\r\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\r\n\r\n\tif (!spaceUser) {\r\n\t\treturn\r\n\t}\r\n\r\n\tif (notNeedDetails == true) {\r\n\t\tspaceUser.id = spaceUser.user;\r\n\t} else {\r\n\t\tspaceUser.id = spaceUser.user;\r\n\t\tspaceUser.organization = WorkflowManager.getOrganization(spaceUser.organization);\r\n\t\tif (!spaceUser.organization) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tspaceUser.roles = WorkflowManager.getUserRoles(spaceId, spaceUser.organization.id, spaceUser.id);\r\n\t}\r\n\r\n\treturn spaceUser;\r\n};\r\n\r\nWorkflowManager.getUsers = function (spaceId, userIds, notNeedDetails) {\r\n\r\n\tif (\"string\" == typeof (userIds)) {\r\n\t\treturn [WorkflowManager.getUser(spaceId, userIds, notNeedDetails)]\r\n\t}\r\n\r\n\tvar users = new Array();\r\n\tif (userIds && spaceId) {\r\n\t\tvar spaceUsers = db.space_users.find({\r\n\t\t\tspace: spaceId,\r\n\t\t\tuser: {\r\n\t\t\t\t$in: userIds\r\n\t\t\t}\r\n\t\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\r\n\r\n\t\tif (notNeedDetails == true) {\r\n\t\t\tspaceUsers.forEach(function (spaceUser) {\r\n\t\t\t\tspaceUser.id = spaceUser.user;\r\n\t\t\t\tusers.push(spaceUser);\r\n\t\t\t})\r\n\t\t} else {\r\n\t\t\tspaceUsers.forEach(function (spaceUser) {\r\n\t\t\t\tspaceUser.id = spaceUser.user;\r\n\r\n\t\t\t\tspaceUser.organization = WorkflowManager.getOrganization(spaceUser.organization);\r\n\r\n\t\t\t\tspaceUser.organizations = WorkflowManager.getOrganizations(spaceUser.organizations);\r\n\r\n\t\t\t\tif (spaceUser.organization) {\r\n\t\t\t\t\tspaceUser.roles = WorkflowManager.getUserRoles(spaceId, spaceUser.organization.id, spaceUser.id);\r\n\t\t\t\t\tusers.push(spaceUser);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t}\r\n\r\n\treturn users;\r\n};\r\n\r\nWorkflowManager.getFormulaUsers = function (spaceId, userIds) {\r\n\tvar spaceUsers = [];\r\n\tvar users = WorkflowManager.getUsers(spaceId, userIds);\r\n\tusers.forEach(function (user) {\r\n\t\tvar userObject = {};\r\n\t\tuserObject['id'] = user.id;\r\n\t\tuserObject['name'] = user.name;\r\n\t\tuserObject['organization'] = {\r\n\t\t\t'id': user.organization._id,\r\n\t\t\t'name': user.organization.name,\r\n\t\t\t'fullname': user.organization.fullname\r\n\t\t};\r\n\r\n\t\tuserObject[\"organizations\"] = {\r\n\t\t\t'id': user.organizations.getProperty(\"_id\"),\r\n\t\t\t'name': user.organizations.getProperty(\"name\"),\r\n\t\t\t'fullname': user.organizations.getProperty(\"fullname\")\r\n\t\t}\r\n\r\n\t\tuserObject.hr = {}\r\n\r\n\t\tif (user.hr) {\r\n\t\t\tuserObject.hr = user.hr;\r\n\t\t}\r\n\r\n\t\tuserObject.sort_no = user.sort_no\r\n\r\n\t\tuserObject.mobile = user.mobile\r\n\r\n\t\tuserObject.work_phone = user.work_phone\r\n\r\n\t\tuserObject.position = user.position\r\n\r\n\t\tuserObject[\"roles\"] = user.roles ? user.roles.getProperty('name') : [];\r\n\t\tspaceUsers.push(userObject);\r\n\t})\r\n\r\n\treturn spaceUsers;\r\n}\r\n\r\nWorkflowManager.getFormulaUserObjects = function (spaceId, userIds) {\r\n\tif (!userIds)\r\n\t\treturn {\r\n\t\t\torganization: {},\r\n\t\t\thr: {}\r\n\t\t};\r\n\treturn WorkflowManager.getFormulaUserObject(spaceId, userIds);\r\n}\r\n\r\nWorkflowManager.getFormulaUserObject = function (spaceId, userId) {\r\n\r\n\tif (!userId)\r\n\t\treturn {\r\n\t\t\torganization: {},\r\n\t\t\thr: {}\r\n\t\t};\r\n\r\n\tif (userId instanceof Array) {\r\n\t\treturn WorkflowManager.getFormulaUsers(spaceId, userId);\r\n\t} else {\r\n\t\treturn WorkflowManager.getFormulaUsers(spaceId, [userId])[0];\r\n\t}\r\n};\r\n\r\n\r\nWorkflowManager.getFormulaOrgObjects = function (orgIds) {\r\n\tif (!orgIds)\r\n\t\treturn;\r\n\treturn WorkflowManager.getFormulaOrgObject(orgIds);\r\n}\r\n\r\nWorkflowManager.getFormulaOrgObject = function (orgId) {\r\n\r\n\tif (orgId instanceof Array) {\r\n\t\tvar orgArray = new Array();\r\n\t\tvar orgs = WorkflowManager.getOrganizations(orgId);\r\n\t\torgs.forEach(function (org) {\r\n\t\t\tvar orgObject = {};\r\n\t\t\torgObject['id'] = org._id;\r\n\t\t\torgObject['name'] = org.name;\r\n\t\t\torgObject['fullname'] = org.fullname;\r\n\t\t\torgArray.push(orgObject);\r\n\t\t});\r\n\r\n\t\treturn orgArray;\r\n\t} else {\r\n\t\tvar orgObject = {};\r\n\t\tvar org = WorkflowManager.getOrganization(orgId);\r\n\t\tif (!org)\r\n\t\t\treturn null;\r\n\r\n\t\torgObject['id'] = orgId;\r\n\t\torgObject['name'] = org.name;\r\n\t\torgObject['fullname'] = org.fullname;\r\n\r\n\t\treturn orgObject;\r\n\t}\r\n\r\n}\r\n\r\nWorkflowManager.getInstanceFormVersion = function () {\r\n\r\n\tvar instance = Template.instance().view.template.steedosData.instance\r\n\r\n\tvar form, form_fields, form_version;\r\n\tform = db.forms.findOne(instance.form);\r\n\tform_version = {};\r\n\tform_fields = [];\r\n\tif (form.current._id === instance.form_version) {\r\n\t\tform_version = form.current;\r\n\t} else {\r\n\t\tform_version = _.where(form.historys, {\r\n\t\t\t_id: instance.form_version\r\n\t\t})[0];\r\n\t}\r\n\tform_version.fields.forEach(function (field) {\r\n\t\tif (field.type === 'section') {\r\n\t\t\tform_fields.push(field);\r\n\t\t\tif (field.fields) {\r\n\t\t\t\treturn field.fields.forEach(function (f) {\r\n\t\t\t\t\treturn form_fields.push(f);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (field.type === 'table') {\r\n\t\t\tfield['sfields'] = field['fields'];\r\n\t\t\tdelete field['fields'];\r\n\t\t\treturn form_fields.push(field);\r\n\t\t} else {\r\n\t\t\treturn form_fields.push(field);\r\n\t\t}\r\n\t});\r\n\tform_version.fields = form_fields;\r\n\treturn form_version;\r\n};\r\n\r\nWorkflowManager.getFormVersion = function (id, versionId) {\r\n\tvar form = db.forms.findOne({\r\n\t\t_id: id\r\n\t});\r\n\r\n\tvar form_version = form.current\r\n\r\n\tif (form_version._id != versionId) {\r\n\t\tform_version = form.historys.findPropertyByPK(\"_id\", versionId)\r\n\t}\r\n\r\n\tvar form_fields = [];\r\n\r\n\tform_version.fields.forEach(function (field) {\r\n\t\tif (field.type == 'section') {\r\n\t\t\tform_fields.push(field);\r\n\t\t\tif (field.fields) {\r\n\t\t\t\tfield.fields.forEach(function (f) {\r\n\t\t\t\t\tform_fields.push(f);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tform_fields.push(field);\r\n\t\t}\r\n\t});\r\n\r\n\tform_version.fields = form_fields;\r\n\r\n\treturn form_version;\r\n}\r\n\r\nWorkflowManager.getInstanceFlowVersion = function (instance) {\r\n\tif (!instance) {\r\n\t\tinstance = Template.instance().view.template.steedosData.instance;\r\n\t}\r\n\r\n\tvar flow, flow_version;\r\n\tflow = db.flows.findOne(instance.flow);\r\n\tflow_version = {};\r\n\tif (flow.current._id === instance.flow_version) {\r\n\t\tflow_version = flow.current;\r\n\t} else {\r\n\t\tflow_version = _.where(flow.historys, {\r\n\t\t\t_id: instance.flow_version\r\n\t\t})[0];\r\n\t}\r\n\treturn flow_version;\r\n};\r\n\r\nWorkflowManager.getInstanceStep = function (stepId) {\r\n\tflow = WorkflowManager.getInstanceFlowVersion();\r\n\r\n\tif (!flow)\r\n\t\treturn null;\r\n\r\n\tvar g_step;\r\n\r\n\tflow.steps.forEach(\r\n\t\tfunction (step) {\r\n\t\t\tif (step._id == stepId) {\r\n\t\t\t\tg_step = step;\r\n\t\t\t\tg_step.id = step._id;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n\r\n\treturn g_step;\r\n};\r\n\r\n\r\nWorkflowManager.canAdmin = function (fl, curSpaceUser, organizations) {\r\n\tvar perms = fl.perms;\r\n\tvar hasAdminRight = false;\r\n\tif (perms) {\r\n\t\tif (perms.users_can_admin && perms.users_can_admin.includes(curSpaceUser.user)) {\r\n\t\t\thasAdminRight = true;\r\n\t\t} else if (perms.orgs_can_admin && perms.orgs_can_admin.length > 0) {\r\n\t\t\tif (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_admin).length > 0) {\r\n\t\t\t\thasAdminRight = true;\r\n\t\t\t} else {\r\n\t\t\t\tif (organizations) {\r\n\r\n\t\t\t\t\thasAdminRight = _.some(organizations, function (org) {\r\n\t\t\t\t\t\treturn org.parents && _.intersection(org.parents, perms.orgs_can_admin).length > 0;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn hasAdminRight;\r\n};\r\n\r\nWorkflowManager.canMonitor = function (fl, curSpaceUser, organizations) {\r\n\tvar perms = fl.perms;\r\n\tvar hasMonitorRight = false;\r\n\tif (perms) {\r\n\t\tif (perms.users_can_monitor && perms.users_can_monitor.includes(curSpaceUser.user)) {\r\n\t\t\thasMonitorRight = true;\r\n\t\t} else if (perms.orgs_can_monitor && perms.orgs_can_monitor.length > 0) {\r\n\t\t\tif (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_monitor).length > 0) {\r\n\t\t\t\thasMonitorRight = true;\r\n\t\t\t} else {\r\n\t\t\t\tif (organizations) {\r\n\r\n\t\t\t\t\thasMonitorRight = _.some(organizations, function (org) {\r\n\t\t\t\t\t\treturn org.parents && _.intersection(org.parents, perms.orgs_can_monitor).length > 0;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn hasMonitorRight;\r\n};\r\n\r\n//校验user是否对instance有查看权限：\r\n// 1 工作区管理员则返回true\r\n// 2 用户在submitter、applicant、outbox_users、inbox_users、cc_users、created_by、modified_by 中：return true;\r\n// 3 用户是流程管理员，监控员：return true;\r\n// 4 否则：return false;\r\nWorkflowManager.hasInstancePermissions = function (user, instance) {\r\n\r\n\tif (user && instance) {\r\n\t\tvar space = db.spaces.findOne({\r\n\t\t\t_id: instance.space\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\tadmins: 1\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (space && space.admins && space.admins.includes(user._id)) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\r\n\tvar approvedUsers = _.union(instance.outbox_users, instance.inbox_users, instance.cc_users, [instance.submitter], [instance.applicant], [instance.created_by], [instance.modified_by]);\r\n\r\n\tif (approvedUsers.includes(user._id)) {\r\n\t\treturn true;\r\n\t}\r\n\r\n\t//被那些instance关联\r\n\tvar originalInstances = db.instances.find({\r\n\t\trelated_instances: {\r\n\t\t\t$all: [instance._id]\r\n\t\t}\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\toutbox_users: 1,\r\n\t\t\tinbox_users: 1,\r\n\t\t\tcc_users: 1,\r\n\t\t\tsubmitter: 1,\r\n\t\t\tapplicant: 1\r\n\t\t}\r\n\t})\r\n\tconsole.log(\"originalInstances size is \" + originalInstances.count());\r\n\tif (originalInstances.count() > 0) {\r\n\t\tvar hasPermission = false;\r\n\t\t_.some(originalInstances.fetch(), function (ins) {\r\n\t\t\tconsole.log(ins)\r\n\t\t\thavePermissionUsers = _.union(ins.outbox_users, ins.inbox_users, ins.cc_users, [ins.submitter], [ins.applicant]);\r\n\t\t\tconsole.log(havePermissionUsers)\r\n\t\t\tif (havePermissionUsers.includes(user._id)) {\r\n\t\t\t\thasPermission = true;\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t})\r\n\t\tif (hasPermission) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\r\n\tspaceUser = db.space_users.findOne({\r\n\t\tspace: instance.space,\r\n\t\tuser: user._id\r\n\t})\r\n\r\n\tif (spaceUser) {\r\n\t\torganizations = db.organizations.find({\r\n\t\t\t_id: {\r\n\t\t\t\t$in: spaceUser.organizations\r\n\t\t\t}\r\n\t\t}).fetch();\r\n\r\n\t\tflow = db.flows.findOne({\r\n\t\t\t_id: instance.flow\r\n\t\t});\r\n\r\n\t\tif (flow) {\r\n\t\t\treturn WorkflowManager.canMonitor(flow, spaceUser, organizations) || WorkflowManager.canAdmin(flow, spaceUser, organizations)\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\treturn false;\r\n\r\n}\r\n\r\nWorkflowManager.getNameForUser = function (userId) {\r\n\tcheck(userId, String);\r\n\treturn db.users.findOne({\r\n\t\t_id: userId\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\tname: 1\r\n\t\t}\r\n\t});\r\n}\r\n\r\n// 工作区管理员和流程管理员拥有流程的管理权限\r\nWorkflowManager.hasFlowAdminPermission = function (flow_id, space_id, user_id) {\r\n\tvar space = db.spaces.findOne({\r\n\t\t_id: space_id\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\tadmins: 1\r\n\t\t}\r\n\t});\r\n\r\n\tif (!space)\r\n\t\treturn false;\r\n\r\n\tif (space.admins && space.admins.includes(user_id))\r\n\t\treturn true;\r\n\r\n\tvar hasPermission = false;\r\n\r\n\tvar space_user = db.space_users.findOne({\r\n\t\tspace: space_id,\r\n\t\tuser: user_id\r\n\t}, {\r\n\t\tfields: {\r\n\t\t\torganizations: 1,\r\n\t\t\tuser: 1\r\n\t\t}\r\n\t})\r\n\tif (space_user) {\r\n\t\tvar organizations = db.organizations.find({\r\n\t\t\t_id: {\r\n\t\t\t\t$in: space_user.organizations\r\n\t\t\t}\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\tparents: 1\r\n\t\t\t}\r\n\t\t}).fetch()\r\n\r\n\t\tvar fl = db.flows.findOne({\r\n\t\t\t_id: flow_id\r\n\t\t}, {\r\n\t\t\tfields: {\r\n\t\t\t\tperms: 1\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\tif (fl && organizations) {\r\n\t\t\thasPermission = WorkflowManager.canAdmin(fl, space_user, organizations);\r\n\t\t}\r\n\t}\r\n\r\n\treturn hasPermission;\r\n\r\n}","Cookies = require(\"cookies\")\r\n\r\nuuflowManager = {}\r\n\r\nuuflowManager.check_authorization = (req, res) ->\r\n\tquery = req.query\r\n\tuserId = query[\"X-User-Id\"]\r\n\tauthToken = query[\"X-Auth-Token\"]\r\n\r\n\t# then check cookie\r\n\tif !userId or !authToken\r\n\t\tcookies = new Cookies( req, res )\r\n\t\tuserId = cookies.get(\"X-User-Id\")\r\n\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\tif not userId or not authToken\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\thashedToken = Accounts._hashLoginToken(authToken)\r\n\tuser = Meteor.users.findOne\r\n\t\t_id: userId,\r\n\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\r\n\r\n\tif not user\r\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\r\n\r\n\treturn user\r\n\r\nuuflowManager.getInstance = (instance_id) ->\r\n\tins = db.instances.findOne(instance_id)\r\n\tif not ins\r\n\t\tthrow new Meteor.Error('error!', \"申请单ID：#{instance_id}有误或此申请单已经被删除\")\r\n\treturn ins\r\n\r\nuuflowManager.getSpace = (space_id) ->\r\n\tspace = db.spaces.findOne(space_id)\r\n\tif not space\r\n\t\tthrow new Meteor.Error('error!', \"space_id有误或此space已经被删除\")\r\n\treturn space\r\n\r\nuuflowManager.getSpaceUser = (space_id, user_id) ->\r\n\tspace_user = db.space_users.findOne({ space: space_id, user: user_id })\r\n\tif not space_user\r\n\t\tthrow new Meteor.Error('error!', \"user_id对应的用户不属于当前space\")\r\n\treturn space_user\r\n\r\nuuflowManager.getFlow = (flow_id) ->\r\n\tflow = db.flows.findOne(flow_id)\r\n\tif not flow\r\n\t\tthrow new Meteor.Error('error!', \"id有误或此流程已经被删除\")\r\n\treturn flow\r\n\r\nuuflowManager.getSpaceUserOrgInfo = (space_user) ->\r\n\tinfo = new Object\r\n\tinfo.organization = space_user.organization\r\n\torg = db.organizations.findOne(space_user.organization, { fields: { name: 1 , fullname: 1 } })\r\n\tinfo.organization_name = org.name\r\n\tinfo.organization_fullname = org.fullname\r\n\treturn info\r\n\r\nuuflowManager.getTrace = (instance, trace_id) ->\r\n\ttrace = _.find(instance.traces, (t) ->\r\n\t\treturn t._id is trace_id\r\n\t)\r\n\tif not trace\r\n\t\tthrow new Meteor.Error('error!', \"trace_id有误\")\r\n\treturn trace\r\n\r\nuuflowManager.getApprove = (trace, approve_id) ->\r\n\tapprove = _.find(trace.approves, (t) ->\r\n\t\treturn t._id is approve_id\r\n\t)\r\n\tif not approve\r\n\t\tthrow new Meteor.Error('error!', \"trace_id有误\")\r\n\treturn approve\r\n\r\nuuflowManager.isTraceNotFinished = (trace) ->\r\n\tif trace.is_finished isnt false\r\n\t\tthrow new Meteor.Error('error!', \"可能已有人对此文件做了处理。请点击已审核，查看文件的最新状态\")\r\n\treturn\r\n\r\nuuflowManager.isApproveNotFinished = (approve) ->\r\n\tif approve.is_finished != false\r\n\t\tthrow new Meteor.Error('error!', \"当前步骤不为未完成状态,不能进行此操作\")\r\n\treturn\r\n\r\nuuflowManager.isInstancePending = (instance, lang = \"zh-CN\") ->\r\n\tif instance.state isnt \"pending\"\r\n\t\tthrow new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang))\r\n\treturn\r\n\r\nuuflowManager.isHandlerOrAgent = (approve, user_id) ->\r\n\tif approve.user isnt user_id and approve.agent isnt user_id\r\n\t\tthrow new Meteor.Error('error!', \"不是当前步骤对应的处理人或其代理人，不能进行此操作\")\r\n\r\nuuflowManager.isInstanceDraft = (instance, lang = \"zh-CN\") ->\r\n\tif instance.state isnt \"draft\"\r\n\t\tthrow new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang))\r\n\r\nuuflowManager.isInstanceSubmitter = (instance, current_user_id) ->\r\n\tif instance.submitter isnt current_user_id\r\n\t\tthrow new Meteor.Error('error!', '当前用户不是申请单对应的提交人,不能进行此操作')\r\n\r\nuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin = (instance, current_user_id, space) ->\r\n\tif instance.submitter isnt current_user_id and instance.applicant isnt current_user_id && not space.admins.includes(current_user_id)\r\n\t\tthrow new Meteor.Error('error!', \"当前用户不是申请单对应的提交人或申请人或工作区管理员\")\r\n\r\nuuflowManager.getStep = (instance, flow, step_id) ->\r\n\tflow_rev = instance.flow_version\r\n\tisExistStep = null\r\n\tif flow.current._id is flow_rev\r\n\t\tisExistStep = _.find(flow.current.steps, (step) ->\r\n\t\t\treturn step._id is step_id\r\n\t\t)\r\n\telse\r\n\t\t_.each(flow.historys, (history) ->\r\n\t\t\tif history._id is flow_rev\r\n\t\t\t\tisExistStep = _.find(history.steps, (step) ->\r\n\t\t\t\t\treturn step._id is step_id\r\n\t\t\t\t)\r\n\t\t)\r\n\r\n\tif not isExistStep\r\n\t\tthrow new Meteor.Error('error!', \"不能获取step\")\r\n\r\n\treturn isExistStep\r\n\r\nuuflowManager.isJudgeLegal = (judge) ->\r\n\tif judge isnt \"approved\" and judge isnt \"rejected\" and judge isnt \"readed\" and judge isnt \"submitted\"\r\n\t\tthrow new Meteor.Error('error!', \"judge有误\")\r\n\treturn\r\n\r\nuuflowManager.isSpaceAdmin = (space_id, user_id) ->\r\n\tspace = db.spaces.findOne({ _id: space_id }, { fields: { admins: 1 } })\r\n\tif not space.admins.includes(user_id)\r\n\t\tthrow new Meteor.Error('error!', \"当前用户不是工作区管理员,不能进行此操作\")\r\n\treturn\r\n\r\nuuflowManager.getUser = (user_id) ->\r\n\tuser = db.users.findOne(user_id)\r\n\tif not user\r\n\t\tthrow new Meteor.Error('error!', \"用户ID有误或此用户已经被删除\")\r\n\treturn user\r\n\r\nuuflowManager.getUserOrganization = (user_id, space_id) ->\r\n\torg = db.organizations.findOne({ space: space_id, users: user_id })\r\n\treturn org\r\n\r\nuuflowManager.getUserRoles = (user_id, space_id) ->\r\n\trole_names = new Array\r\n\tpositions = db.flow_positions.find({ space: space_id, users: user_id }, { fields: { role: 1 } }).fetch()\r\n\t_.each(positions, (position) ->\r\n\t\trole = db.flow_roles.findOne({ _id: position.role }, { fields: { name: 1 } })\r\n\t\tif role\r\n\t\t\trole_names.push(role.name)\r\n\t)\r\n\treturn role_names\r\n\r\nuuflowManager.isFlowEnabled = (flow) ->\r\n\tif flow.state isnt \"enabled\"\r\n\t\tthrow new Meteor.Error('error!', \"流程未启用,操作失败\")\r\n\r\nuuflowManager.isFlowSpaceMatched = (flow, space_id) ->\r\n\tif flow.space isnt space_id\r\n\t\tthrow new Meteor.Error('error!', \"流程和工作区ID不匹配\")\r\n\r\n# 当前节点为条件节点类型时，根据条件计算出后续步骤\r\nuuflowManager.calculateCondition = (values, condition_str) ->\r\n\ttry\r\n\t\t__values = values\r\n\r\n\t\tsum = (subform_field) ->\r\n\t\t\tif not subform_field\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\r\n\t\t\tif not subform_field instanceof Array\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\r\n\t\t\tsum_field_value = 0\r\n\t\t\t_.each(subform_field, (field_value) ->\r\n\t\t\t\tfield_value = Number(String(field_value))\r\n\t\t\t\tsum_field_value += field_value\r\n\t\t\t)\r\n\t\t\treturn sum_field_value\r\n\r\n\t\taverage = (subform_field) ->\r\n\t\t\tif not subform_field\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\r\n\t\t\tif not subform_field instanceof Array\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\r\n\t\t\treturn sum(subform_field) / count(subform_field)\r\n\r\n\t\tcount = (subform_field) ->\r\n\t\t\tif not subform_field\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\r\n\t\t\tsubform_field.length\r\n\r\n\t\tmax = (subform_field) ->\r\n\t\t\tif not subform_field\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\r\n\t\t\tif not subform_field instanceof Array\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\r\n\t\t\tsub_field = new Array\r\n\t\t\t_.each(subform_field, (field_value) ->\r\n\t\t\t\tsub_field.push(Number(String(field_value)))\r\n\t\t\t)\r\n\t\t\treturn _.max(sub_field)\r\n\r\n\t\tmin = (subform_field) ->\r\n\t\t\tif not subform_field\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\r\n\t\t\tif not subform_field instanceof Array\r\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\r\n\t\t\tsub_field = new Array\r\n\t\t\t_.each(subform_field, (field_value) ->\r\n\t\t\t\tsub_field.push(Number(String(field_value)))\r\n\t\t\t)\r\n\t\t\treturn _.min(sub_field)\r\n\r\n\t\teval(condition_str)\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\treturn false\r\n\r\n\r\n# 代码结构\r\n# 子表\r\n#   数值\r\n#   字符\r\n# 选组\r\n#   多选\r\n#   单选\r\n# 选人\r\n#   多选\r\n#   单选\r\n# 数值\r\n# 字符\r\nuuflowManager.setFormFieldVariable = (fields, __values, space_id) ->\r\n\ttry\r\n\t\t_.each(fields, (field) ->\r\n\t\t\tif field.type is \"table\" #子表\r\n\t\t\t\t#得到已引用的子表字段\r\n\t\t\t\tsubform_fields_all = field.fields\r\n\t\t\t\t_subform_values = new Object\r\n\t\t\t\t_.each(subform_fields_all, (current_field) ->\r\n\t\t\t\t\tvalues_arr = new Array\r\n\t\t\t\t\tif [\"number\", \"percentage\", \"currency\"].includes(current_field[\"type\"])\r\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\r\n\t\t\t\t\t\t\tvalues_arr.push(sub_field[current_field[\"code\"]])\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\telse if current_field[\"type\"] is \"checkbox\"\r\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\r\n\t\t\t\t\t\t\tif sub_field[current_field[\"code\"]] is \"true\"\r\n\t\t\t\t\t\t\t\tvalues_arr.push(true)\r\n\t\t\t\t\t\t\telse if sub_field[current_field[\"code\"]] is \"false\"\r\n\t\t\t\t\t\t\t\tvalues_arr.push(false)\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\r\n\t\t\t\t\t\t\tif sub_field[current_field[\"code\"]]\r\n\t\t\t\t\t\t\t\tvalues_arr.push(sub_field[current_field[\"code\"]])\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tvalues_arr.push(\"\")\r\n\t\t\t\t\t\t)\r\n\r\n\t\t\t\t\t__values[current_field[\"code\"]] = values_arr\r\n\t\t\t\t)\r\n\t\t\telse if field.type is \"group\" #选组\r\n\t\t\t\tif field.is_multiselect\r\n\t\t\t\t\tif __values[field.code] and __values[field.code].length > 0\r\n\t\t\t\t\t\tgroup_id = new Array\r\n\t\t\t\t\t\tgroup_name = new Array\r\n\t\t\t\t\t\tgroup_fullname = new Array\r\n\t\t\t\t\t\t_.each(__values[field.code], (group) ->\r\n\t\t\t\t\t\t\tgroup_id.push(group[\"id\"])\r\n\t\t\t\t\t\t\tgroup_name.push(group[\"name\"])\r\n\t\t\t\t\t\t\tgroup_fullname.push(group[\"fullname\"])\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t\t__values[field.code] = new Object\r\n\t\t\t\t\t\t__values[field.code][\"id\"] = group_id\r\n\t\t\t\t\t\t__values[field.code][\"name\"] = group_name\r\n\t\t\t\t\t\t__values[field.code][\"fullname\"] = group_fullname\r\n\t\t\telse if field.type is \"user\" #选人\r\n\t\t\t\tif field.is_multiselect\r\n\t\t\t\t\tif __values[field.code] and __values[field.code].length > 0\r\n\t\t\t\t\t\tuser_id = new Array\r\n\t\t\t\t\t\tuser_name = new Array\r\n\t\t\t\t\t\torganization = new Object\r\n\t\t\t\t\t\torganization[\"user_organization_fullname\"] = new Array\r\n\t\t\t\t\t\torganization[\"user_organization_name\"] = new Array\r\n\t\t\t\t\t\tuser_roles = new Array\r\n\r\n\t\t\t\t\t\t_.each(__values[field.code], (select_user) ->\r\n\t\t\t\t\t\t\tuser_id.push(select_user[\"id\"])\r\n\t\t\t\t\t\t\tuser_name.push(select_user[\"name\"])\r\n\t\t\t\t\t\t\torganization_selectuser = uuflowManager.getUserOrganization(select_user[\"id\"], space_id)\r\n\t\t\t\t\t\t\trole_selectuser = uuflowManager.getUserRoles(select_user[\"id\"], space_id)\r\n\t\t\t\t\t\t\tif organization_selectuser\r\n\t\t\t\t\t\t\t\torganization[\"user_organization_fullname\"].push(organization_selectuser.fullname)\r\n\t\t\t\t\t\t\t\torganization[\"user_organization_name\"].push(organization_selectuser.name)\r\n\t\t\t\t\t\t\tif role_selectuser\r\n\t\t\t\t\t\t\t\tuser_roles = user_roles or role_selectuser\r\n\t\t\t\t\t\t)\r\n\r\n\t\t\t\t\t\t__values[field.code] = new Object\r\n\t\t\t\t\t\t__values[field.code][\"id\"] = user_id\r\n\t\t\t\t\t\t__values[field.code][\"name\"] = user_name\r\n\t\t\t\t\t\t__values[field.code][\"organization\"] = organization\r\n\t\t\t\t\t\t__values[field.code][\"roles\"] = roles\r\n\t\t\t\telse\r\n\t\t\t\t\tif __values[field.code]\r\n\t\t\t\t\t\torganization_selectuser = uuflowManager.getUserOrganization(__values[field.code][\"id\"], space_id)\r\n\t\t\t\t\t\trole_selectuser = uuflowManager.getUserRoles(__values[field.code][\"id\"], space_id)\r\n\t\t\t\t\t\tif organization_selectuser\r\n\t\t\t\t\t\t\t__values[field.code][\"organization\"] = new Object\r\n\t\t\t\t\t\t\t__values[field.code][\"organization\"][\"fullname\"] = organization_selectuser.fullname\r\n\t\t\t\t\t\t\t__values[field.code][\"organization\"][\"name\"] = organization_selectuser.name\r\n\r\n\t\t\t\t\t\t__values[field.code][\"roles\"] = role_selectuser\r\n\r\n\t\t\telse if [\"number\", \"percentage\", \"currency\"].includes(field.type) #数值类型\r\n\t\t\t\tif __values[field.code]\r\n\t\t\t\t\t__values[field.code] = Number(__values[field.code])\r\n\t\t\t\telse\r\n\t\t\t\t\t__values[field.code] = 0\r\n\t\t\telse if field.type is \"checkbox\" #勾选框\r\n\t\t\t\tif __values[field.code] is \"true\"\r\n\t\t\t\t\t__values[field.code] = true\r\n\t\t\t\telse if __values[field.code] is \"false\"\r\n\t\t\t\t\t__values[field.code] = false\r\n\t\t)\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\n# 应用场景：此函数用于返回备选的所有下一步的id\r\nuuflowManager.getNextSteps = (instance, flow, step, judge) ->\r\n\tstep_type = step.step_type\r\n\tnextSteps = new Array\r\n\tif step_type is \"condition\"\r\n\t\t#step的lines中查询出state=submitted且instance.fields满足其条件的line\r\n\t\t__values = uuflowManager.getUpdatedValues(instance)\r\n\t\tcurrent_approve = null\r\n\t\t# 获取当前Approve\r\n\t\ttraces = instance.traces\r\n\t\t_.each traces, (trace) ->\r\n\t\t\tif trace.is_finished is false\r\n\t\t\t\tcurrent_approve = trace.approves[0]\r\n\r\n\t\tstart_approve = null\r\n\t\t# 获取开始节点Approve\r\n\t\t_.each traces, (trace) ->\r\n\t\t\tif not trace.previous_trace_ids or trace.previous_trace_ids.length is 0\r\n\t\t\t\tstart_approve = trace.approves[0]\r\n\r\n\t\t# 申请人所在组织全名称\r\n\t\tapplicant_organization_fullname = instance.applicant_organization_fullname\r\n\t\t# 申请人所在组织的名称\r\n\t\tapplicant_organization_name = instance.applicant_organization_name\r\n\t\t# 申请人的审批岗位\r\n\t\tapplicant_roles = uuflowManager.getUserRoles(instance.applicant, instance.space)\r\n\t\t# 申请人的全名\r\n\t\tapplicant_name = instance.applicant_name\r\n\t\t# 填单人所在组织全名称\r\n\t\tsubmitter_organization_fullname = start_approve.handler_organization_fullname\r\n\t\t# 填单人所在组织的名称\r\n\t\tsubmitter_organization_name = start_approve.handler_organization_name\r\n\t\t# 填单人的审批岗位\r\n\t\tsubmitter_roles = uuflowManager.getUserRoles(start_approve.handler, instance.space)\r\n\t\t# 填单人的全名\r\n\t\tsubmitter_name = start_approve.handler_name\r\n\t\t# 处理人所在组织全名称\r\n\t\tapprover_organization_fullname = current_approve.handler_organization_fullname\r\n\t\t# 处理人所在组织的名称\r\n\t\tapprover_organization_name = current_approve.handler_organization_name\r\n\t\t# 处理人的审批岗位\r\n\t\tapprover_roles = uuflowManager.getUserRoles(current_approve.handler, instance.space)\r\n\t\t# 处理人的全名\r\n\t\tapprover_name = current_approve.handler_name\r\n\r\n\t\t# Condition中涉及的一些变量\r\n\t\t__values[\"applicant\"] = new Object\r\n\t\t__values[\"applicant\"][\"roles\"] = applicant_roles\r\n\t\t__values[\"applicant\"][\"name\"] = applicant_name\r\n\t\t__values[\"applicant\"][\"organization\"] = new Object\r\n\t\t__values[\"applicant\"][\"organization\"][\"fullname\"] = applicant_organization_fullname\r\n\t\t__values[\"applicant\"][\"organization\"][\"name\"] = applicant_organization_name\r\n\r\n\t\t__values[\"submitter\"] = new Object\r\n\t\t__values[\"submitter\"][\"roles\"] = submitter_roles\r\n\t\t__values[\"submitter\"][\"name\"] = submitter_name\r\n\t\t__values[\"submitter\"][\"organization\"] = new Object\r\n\t\t__values[\"submitter\"][\"organization\"][\"fullname\"] = submitter_organization_fullname\r\n\t\t__values[\"submitter\"][\"organization\"][\"name\"] = submitter_organization_name\r\n\r\n\t\t__values[\"approver\"] = new Object\r\n\t\t__values[\"approver\"][\"roles\"] = approver_roles\r\n\t\t__values[\"approver\"][\"name\"] = approver_name\r\n\t\t__values[\"approver\"][\"organization\"] = new Object\r\n\t\t__values[\"approver\"][\"organization\"][\"fullname\"] = approver_organization_fullname\r\n\t\t__values[\"approver\"][\"organization\"][\"name\"] = approver_organization_name\r\n\r\n\t\t# 获取申请单对应表单\r\n\t\tform = db.forms.findOne(instance.form)\r\n\t\tformVersion = null\r\n\t\tif instance.form_version is form.current._id\r\n\t\t\tformVersion = form.current\r\n\t\telse\r\n\t\t\tformVersion = _.find(form.historys, (history) ->\r\n\t\t\t\treturn instance.form_version is history._id\r\n\t\t\t)\r\n\r\n\t\t# 定义表单中字段\r\n\t\tuuflowManager.setFormFieldVariable(formVersion.fields, __values, instance.space)\r\n\t\t# 匹配包括花括号自身在内的所有符号\r\n\t\treg = /(\\{[^{}]*\\})/\r\n\t\tprefix = \"__values\"\r\n\t\t_.each step.lines, (step_line) ->\r\n\t\t\tstep_line_condition = step_line.condition.replace reg, (vowel) ->\r\n\t\t\t\treturn prefix + vowel.replace(/\\{\\s*/, \"[\\\"\").replace(/\\s*\\}/, \"\\\"]\").replace(/\\s*\\.\\s*/g, \"\\\"][\\\"\")\r\n\t\t\tif step_line.state is \"submitted\" and uuflowManager.calculateCondition(__values, step_line_condition)\r\n\t\t\t\tif step_line.state is \"submitted\"\r\n\t\t\t\t\tnextSteps.push(step_line.to_step)\r\n\r\n\telse if step_type is \"end\"\r\n\t\treturn new Array\r\n\telse if step_type is \"submit\" or step_type is \"start\" or step_type is \"counterSign\"\r\n\t\tlines = _.filter(step.lines, (line) ->\r\n\t\t\treturn line.state is \"submitted\"\r\n\t\t)\r\n\t\tif lines.length is 0\r\n\t\t\tthrow new Meteor.Error('error!', \"流程的连线配置有误\")\r\n\t\telse\r\n\t\t\tnextSteps = _.pluck(lines, 'to_step')\r\n\telse if step_type is \"sign\"\r\n\t\tif judge is \"approved\"\r\n\t\t\tlines = _.filter(step.lines, (line) ->\r\n\t\t\t\treturn line.state is \"approved\"\r\n\t\t\t)\r\n\t\t\tif lines.length is 0\r\n\t\t\t\tthrow new Meteor.Error('error!', \"流程的连线配置有误\")\r\n\t\t\telse\r\n\t\t\t\tnextSteps = _.pluck(lines, 'to_step')\r\n\t\telse if judge is \"rejected\"\r\n\t\t\tlines = _.filter(step.lines, (line) ->\r\n\t\t\t\treturn line.state is \"rejected\"\r\n\t\t\t)\r\n\t\t\trejectedSteps = _.pluck(lines, 'to_step')\r\n\t\t\t# 取出instance的traces,取出所有历史trace中(is_finished=ture)的step_id\r\n\t\t\ttrace_steps = new Array\r\n\t\t\t_.each(instance.traces, (trace) ->\r\n\t\t\t\tif trace.is_finished is true\r\n\t\t\t\t\tflowVersions = new Array\r\n\t\t\t\t\tflowVersions.push(flow.current)\r\n\t\t\t\t\tif flow.historys\r\n\t\t\t\t\t\tflowVersions = flowVersions.concat(flow.historys)\r\n\t\t\t\t\t_.each(flowVersions, (flowVer) ->\r\n\t\t\t\t\t\tif flowVer._id is instance.flow_version\r\n\t\t\t\t\t\t\t_.each(flowVer.steps, (flow_ver_step) ->\r\n\t\t\t\t\t\t\t\tif flow_ver_step._id is trace.step and flow_ver_step.step_type isnt \"condition\"\r\n\t\t\t\t\t\t\t\t\ttrace_steps.push(trace.step)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t)\r\n\t\t\t)\r\n\t\t\t# 取出flow,取到instance对应的版本的开始结点和结束结点的step_id\r\n\t\t\tflow_steps = new Array\r\n\t\t\tif instance.flow_version is flow.current._id\r\n\t\t\t\t_.each(flow.current.steps, (flow_step) ->\r\n\t\t\t\t\tif flow_step.step_type is \"start\" or flow_step.step_type is \"end\"\r\n\t\t\t\t\t\tflow_steps.push(flow_step._id)\r\n\t\t\t\t)\r\n\t\t\telse\r\n\t\t\t\t_.each(flow.historys, (history) ->\r\n\t\t\t\t\t_.each(history.steps, (history_step) ->\r\n\t\t\t\t\t\tif history_step.step_type is \"start\" or history_step.step_type is \"end\"\r\n\t\t\t\t\t\t\tflow_steps.push(history_step._id)\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\r\n\t\t\tnextSteps = _.union(rejectedSteps, trace_steps, flow_steps)\r\n\r\n\t# 若下一步中包含 条件节点 则 继续取得 条件节点的 后续步骤\r\n\tversion_steps = new Object\r\n\tflowVersions = new Array\r\n\tflowVersions.push(flow.current)\r\n\tif flow.historys\r\n\t\tflowVersions = flowVersions.concat(flow.historys)\r\n\r\n\t_.each(flowVersions, (flowVer) ->\r\n\t\tif flowVer._id is instance.flow_version\r\n\t\t\t_.each(flowVer.steps, (flow_ver_step) ->\r\n\t\t\t\tversion_steps[flow_ver_step._id] = flow_ver_step\r\n\t\t\t)\r\n\t)\r\n\r\n\tnextSteps = _.uniq(nextSteps)\r\n\t_.each(nextSteps, (next_step_id) ->\r\n\t\t_next_step = version_steps[next_step_id]\r\n\t\tif _next_step.step_type is \"condition\"\r\n\t\t\tif _next_step.lines\r\n\t\t\t\t_.each(_next_step.lines, (line) ->\r\n\t\t\t\t\tif line.to_step\r\n\t\t\t\t\t\tnextSteps.push(line.to_step)\r\n\t\t\t\t)\r\n\t)\r\n\r\n\tnextSteps = _.uniq(nextSteps)\r\n\treturn nextSteps\r\n\r\nuuflowManager.getUpdatedValues = (instance) ->\r\n\r\n\t# 取得最新的approve\r\n\ttrace_approve = null\r\n\t_.each(instance.traces, (trace) ->\r\n\t\tif trace.is_finished is false\r\n\t\t\ttrace_approve = _.find(trace.approves, (approve) ->\r\n\t\t\t\treturn approve.is_finished is false and approve.type isnt 'cc' and approve.type isnt 'distribute'\r\n\t\t\t)\r\n\t)\r\n\t# 取得最新的values\r\n\tnewest_values = null\r\n\tif not instance.values\r\n\t\tnewest_values = trace_approve?.values\r\n\telse if not trace_approve?.values\r\n\t\tnewest_values = instance.values\r\n\telse\r\n\t\tnewest_values =  _.extend(_.clone(instance.values), trace_approve.values)\r\n\treturn newest_values\r\n\r\nuuflowManager.getForm = (form_id) ->\r\n\tform = db.forms.findOne(form_id)\r\n\tif not form\r\n\t\tthrow new Meteor.Error('error!', '表单ID有误或此表单已经被删除')\r\n\r\n\treturn form\r\n\r\nuuflowManager.getFormVersion = (form, form_version) ->\r\n\tform_v = null\r\n\tif form_version is form.current._id\r\n\t\tform_v = form.current\r\n\telse\r\n\t\tform_v = _.find(form.historys, (form_h) ->\r\n\t\t\treturn form_version is form_h._id\r\n\t\t)\r\n\r\n\tif not form_v\r\n\t\tthrow new Meteor.Error('error!', '未找到表单对应的版本')\r\n\r\n\treturn form_v\r\n\r\nuuflowManager.getCategory = (category_id) ->\r\n\treturn db.categories.findOne(category_id)\r\n\r\nuuflowManager.getInstanceName = (instance, vals) ->\r\n\tvalues = _.clone(vals || instance.values) || {}\r\n\r\n\tapplicant = WorkflowManager.getFormulaUserObject(instance.space, instance.applicant)\r\n\r\n\tvalues[\"applicant\"] = applicant\r\n\r\n\tvalues[\"applicant_name\"] = instance.applicant_name\r\n\tvalues[\"applicant_organization\"] = instance.applicant_organization\r\n\tvalues[\"applicant_organization_fullname\"] = instance.applicant_organization_fullname\r\n\tvalues[\"applicant_organization_name\"] = instance.applicant_organization_name\r\n\r\n\tvalues[\"submit_date\"] = moment(instance.submit_date).utcOffset(0, false).format(\"YYYY-MM-DD\")\r\n\r\n\tform_id = instance.form\r\n\tflow = uuflowManager.getFlow(instance.flow)\r\n\r\n\tdefault_value = flow.name + ' ' + instance.code\r\n\tform_version = instance.form_version\r\n\tform = uuflowManager.getForm(form_id)\r\n\tform_v = uuflowManager.getFormVersion(form, form_version)\r\n\tname_forumla = form_v.name_forumla\r\n\trev = default_value\r\n\r\n\tif name_forumla\r\n\r\n\t\tif name_forumla.indexOf(\"{applicant.\") > -1\r\n\t\t\tiscript = name_forumla.replace(/\\{applicant./g, \"(applicant.\").replace(/\\}/g, \" || '')\")\r\n\r\n\t\tiscript = name_forumla.replace(/\\{/g, \"(values.\").replace(/\\}/g, \" || '')\")\r\n\r\n#\t\tconsole.log(iscript)\r\n\r\n\t\ttry\r\n\r\n\t\t\trev = eval(iscript) || default_value\r\n\r\n\t\t\t#文件名中不能包含特殊字符: '? * : \" < > \\ / |'， 直接替换为空\r\n\t\t\trev = rev.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\")\r\n\r\n\t\tcatch e\r\n\t\t\tconsole.log e\r\n\r\n\treturn rev.trim()\r\n\r\nuuflowManager.getApproveValues = (approve_values, permissions, form_id, form_version) ->\r\n\t# 如果permissions为null，则approve_values为{}\r\n\tif permissions is null\r\n\t\tapprove_values = new Object\r\n\telse\r\n\t\t# 获得instance中的所有字段\r\n\t\tinstance_form = db.forms.findOne(form_id)\r\n\t\tform_v = null\r\n\t\tif form_version is instance_form.current._id\r\n\t\t\tform_v = instance_form.current\r\n\t\telse\r\n\t\t\tform_v = _.find(instance_form.historys, (form_h) ->\r\n\t\t\t\treturn form_version is form_h._id\r\n\t\t\t)\r\n\r\n\t\t_.each(form_v.fields, (field) ->\r\n\t\t\tif field.type is \"table\"\r\n#\t\t\t\t_.each(field.fields, (tableField)->\r\n#\t\t\t\t\tif approve_values[field.code] isnt null\r\n#\t\t\t\t\t\t_.each(approve_values[field.code], (tableValue)->\r\n#\t\t\t\t\t\t\tif !tableField.formula && (permissions[tableField.code] is null or permissions[tableField.code] isnt \"editable\")\r\n#\t\t\t\t\t\t\t\tdelete tableValue[tableField.code]\r\n#\t\t\t\t\t\t)\r\n#\t\t\t\t)\r\n\t\t\t\treturn\r\n\t\t\telse if field.type is \"section\"\r\n\t\t\t\t_.each(field.fields, (sectionField) ->\r\n\t\t\t\t\tif !sectionField.formula && (permissions[sectionField.code] is null or permissions[sectionField.code] isnt \"editable\")\r\n\t\t\t\t\t\tdelete approve_values[sectionField.code]\r\n\t\t\t\t)\r\n\t\t\telse\r\n\t\t\t\tif !field.formula && (permissions[field.code] is null or permissions[field.code] isnt \"editable\")\r\n\t\t\t\t\tdelete approve_values[field.code]\r\n\t\t)\r\n\treturn approve_values\r\n\r\nuuflowManager.workflow_engine = (approve_from_client, current_user_info, current_user, auto_submitted)->\r\n\tinstance_id = approve_from_client[\"instance\"]\r\n\ttrace_id = approve_from_client[\"trace\"]\r\n\tapprove_id = approve_from_client[\"_id\"]\r\n\tvalues = approve_from_client[\"values\"]\r\n\tif not values then values = new Object\r\n\tnext_steps = approve_from_client[\"next_steps\"]\r\n\tjudge = approve_from_client[\"judge\"]\r\n\tdescription = approve_from_client[\"description\"]\r\n\tgeolocation = approve_from_client[\"geolocation\"]\r\n\r\n\tsetObj = new Object\r\n\r\n\t# 获取一个instance\r\n\tinstance = uuflowManager.getInstance(instance_id)\r\n\tspace_id = instance.space\r\n\tflow_id = instance.flow\r\n\t# 获取一个space\r\n\tspace = uuflowManager.getSpace(space_id)\r\n\tapplicant_id = instance.applicant\r\n\t# 校验申请人user_accepted = true\r\n\tcheckApplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\r\n\t# 获取一个flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\t# 获取一个space下的一个user\r\n\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t# 获取space_user所在的部门信息\r\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t# 获取一个trace\r\n\ttrace = uuflowManager.getTrace(instance, trace_id)\r\n\t# 获取一个approve\r\n\tapprove = uuflowManager.getApprove(trace, approve_id)\r\n\t# 判断一个trace是否为未完成状态\r\n\tuuflowManager.isTraceNotFinished(trace)\r\n\t# 判断一个approve是否为未完成状态\r\n\tuuflowManager.isApproveNotFinished(approve)\r\n\t# 判断一个instance是否为审核中状态\r\n\tuuflowManager.isInstancePending(instance)\r\n\t# 判断当前用户是否approve 对应的处理人或代理人\r\n\tuuflowManager.isHandlerOrAgent(approve, current_user)\r\n\r\n\t# 先执行审核状态暂存的操作\r\n\t# ================begin================\r\n\tstep = uuflowManager.getStep(instance, flow, trace.step)\r\n\tstep_type = step.step_type\r\n\tinstance_trace = _.find(instance.traces, (trace)->\r\n\t\treturn trace._id is trace_id\r\n\t)\r\n\r\n\ttrace_approves = instance_trace.approves\r\n\r\n\ti = 0\r\n\twhile i < trace_approves.length\r\n\t\tif trace_approves[i]._id is approve_id\r\n\t\t\tkey_str = \"traces.$.approves.\" + i + \".\"\r\n\t\t\tsetObj[key_str + \"geolocation\"] = geolocation\r\n\t\t\tif step_type is \"condition\"\r\n\t\t\telse if step_type is \"start\" or step_type is \"submit\"\r\n\t\t\t\tsetObj[key_str + \"judge\"] = \"submitted\"\r\n\t\t\t\tsetObj[key_str + \"description\"] = description\r\n\t\t\telse if step_type is \"sign\" or step_type is \"counterSign\"\r\n\t\t\t\t# 如果是会签并且前台没有显示核准驳回已阅的radio则给judge默认submitted\r\n\t\t\t\tif step_type is \"counterSign\" and not judge\r\n\t\t\t\t\tjudge = 'submitted'\r\n\t\t\t\t# 判断前台传的judge是否合法\r\n\t\t\t\tuuflowManager.isJudgeLegal(judge)\r\n\t\t\t\tsetObj[key_str + \"judge\"] = judge\r\n\t\t\t\tsetObj[key_str + \"description\"] = description\r\n\r\n\t\t\tsetObj[key_str + \"next_steps\"] = next_steps\r\n\t\t\tsetObj[key_str + \"is_read\"] = true\r\n\t\t\tif not trace_approves[i].read_date\r\n\t\t\t\tsetObj[key_str + \"read_date\"] = new Date\r\n\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\r\n\t\t\tsetObj[key_str + \"values\"] = uuflowManager.getApproveValues(values, step[\"permissions\"], instance.form, instance.form_version)\r\n\r\n\t\t\t# 更新instance记录\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\r\n\t\t\tdb.instances.update({_id: instance_id, \"traces._id\": trace_id}, {$set: setObj})\r\n\t\ti++\r\n\r\n\r\n\t# ================end================\r\n\tinstance = uuflowManager.getInstance(instance_id)\r\n\t# 防止此时的instance已经被处理\r\n\t# 获取一个trace\r\n\ttrace = uuflowManager.getTrace(instance, trace_id)\r\n\t# 获取一个approve\r\n\tapprove = uuflowManager.getApprove(trace, approve_id)\r\n\t# 判断一个trace是否为未完成状态\r\n\tuuflowManager.isTraceNotFinished(trace)\r\n\t# 判断一个approve是否为未完成状态\r\n\tuuflowManager.isApproveNotFinished(approve)\r\n\t# 判断一个instance是否为审核中状态\r\n\tuuflowManager.isInstancePending(instance)\r\n\t# 判断当前用户是否approve 对应的处理人或代理人\r\n\tuuflowManager.isHandlerOrAgent(approve, current_user)\r\n\tupdateObj = new Object\r\n\r\n\tif next_steps is null or next_steps.length is 0\r\n\t\tthrow new Meteor.Error('error!', '还未指定下一步和处理人，操作失败')\r\n\telse\r\n\t\t# 验证next_steps里面是否只有一个step\r\n\t\tif next_steps.length > 1\r\n\t\t\tthrow new Meteor.Error('error!', '不能指定多个后续步骤')\r\n\t\telse\r\n\t\t\t# 校验下一步处理人user_accepted = true\r\n\t\t\t_.each next_steps[0][\"users\"], (next_step_user) ->\r\n\t\t\t\tcheckSpaceUser = uuflowManager.getSpaceUser(space_id, next_step_user)\r\n\r\n\t\tif step_type is \"start\" or step_type is \"submit\" or step_type is \"condition\"\r\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_start_or_submit_or_condition(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted)\r\n\t\telse if step_type is \"sign\"\r\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_sign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted)\r\n\t\telse if step_type is \"counterSign\"\r\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_counterSign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted)\r\n\t\telse if step_type is \"end\"\r\n\t\t\tthrow new Meteor.Error('error!', 'end结点出现approve，服务器错误')\r\n\r\n\t\tform = db.forms.findOne(instance.form)\r\n\t\tupdateObj.keywords = uuflowManager.caculateKeywords(updateObj.values, form, instance.form_version)\r\n\t\tdb.instances.update({_id: instance_id}, {$set: updateObj})\r\n\r\n\tinstance = uuflowManager.getInstance(instance_id)\r\n\tinstance_trace = _.find(instance.traces, (trace)->\r\n\t\treturn trace._id is trace_id\r\n\t)\r\n\tnext_step_id = next_steps[0][\"step\"]\r\n\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\tnext_step_type = next_step.step_type\r\n\t#发送消息开始\r\n\tif \"completed\" is instance.state\r\n\t\tif \"approved\" is instance.final_decision\r\n\t\t\t#通知填单人、申请人\r\n\t\t\tpushManager.send_instance_notification(\"approved_completed_applicant\", instance, description, current_user_info)\r\n\t\telse if \"rejected\" is instance.final_decision\r\n\t\t\t#通知填单人、申请人\r\n\t\t\tpushManager.send_instance_notification(\"rejected_completed_applicant\", instance, description, current_user_info)\r\n\t\telse\r\n\t\t\t#通知填单人、申请人\r\n\t\t\tpushManager.send_instance_notification(\"submit_completed_applicant\", instance, description, current_user_info)\r\n\r\n\telse if \"pending\" is instance.state\r\n\t\tif \"rejected\" is instance_trace.judge and instance_trace.is_finished is true\r\n\t\t\tif 'start' is next_step_type\r\n\t\t\t\t#驳回给申请人时，发送短消息\r\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_applicant_inbox\", instance, description, current_user_info)\r\n\t\t\telse\r\n\t\t\t\t#通知填单人、申请人\r\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_applicant\", instance, description, current_user_info)\r\n\t\t\t\t# 发送消息给下一步处理人\r\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_inbox\", instance, description, current_user_info)\r\n\t\telse if instance_trace.is_finished is false\r\n\t\t\t# 会签 并且当前trace未结束\r\n\t\t\t# 发送push消息 给 inbox_users\r\n\r\n\t\telse\r\n\t\t\t# 发送消息给下一步处理人\r\n\t\t\tpushManager.send_instance_notification(\"submit_pending_inbox\", instance, description, current_user_info)\r\n\t#发送消息给当前用户\r\n\tpushManager.send_message_current_user(current_user_info)\r\n\r\n\t# 如果已经配置webhook并已激活则触发\r\n\tto_users = instance.inbox_users\r\n\tlast_trace = _.last(instance.traces)\r\n\tlast_step = uuflowManager.getStep(instance, flow, last_trace.step)\r\n\tlast_step_type = last_step.step_type\r\n\tif last_step_type is \"counterSign\" and _.where(last_trace.approves, {is_finished: true}).length > 0\r\n\t\tto_users = []\r\n\r\n\tpushManager.triggerWebhook(flow_id, instance, approve_from_client, 'engine_submit', current_user, to_users)\r\n\r\n\t# 判断申请单是否分发，分发文件结束提醒发起人\r\n\tuuflowManager.distributedInstancesRemind(instance)\r\n\r\n\treturn instance\r\n\r\n\r\nuuflowManager.engine_step_type_is_start_or_submit_or_condition = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) ->\r\n\tsetObj = new Object\r\n\tspace_id = instance.space\r\n\t# 验证next_steps.step是否合法\r\n\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\")\r\n\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\r\n\t_.each next_steps, (approve_next_step) ->\r\n\t\tif not nextSteps.includes approve_next_step[\"step\"]\r\n\t\t\tthrow new Meteor.Error('error!', \"approve中next_steps.step：\" + approve_next_step.step + \" 不合法\")\r\n\r\n\t# 若合法,执行流转\r\n\tnext_step_id = next_steps[0][\"step\"]\r\n\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\tnext_step_type = next_step.step_type\r\n\tnext_step_name = next_step.name\r\n\t# 判断next_step是否为结束结点\r\n\tif next_step_type is \"end\"\r\n\t\t# 若是结束结点\r\n\t\tinstance_traces = instance.traces\r\n\t\ti = 0\r\n\t\twhile i < instance_traces.length\r\n\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t# 更新当前trace记录\r\n\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\th = 0\r\n\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\r\n\t\t\t\t\t\t# instance_traces[i].approves[h].values = uuflowManager.getApproveValues(instance_traces[i].approves[h].values, step[\"permissions\"], instance.form, instance.form_version)\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\th++\r\n\t\t\ti++\r\n\r\n\t\t# 插入下一步trace记录\r\n\t\tnewTrace = new Object\r\n\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\tnewTrace.instance = instance_id\r\n\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\tnewTrace.is_finished = true\r\n\t\tnewTrace.step = next_step_id\r\n\t\tnewTrace.name = next_step_name\r\n\t\tnewTrace.start_date = new Date\r\n\t\tnewTrace.finish_date = new Date\r\n\r\n\t\t# 更新instance记录\r\n\t\tsetObj.state = \"completed\"\r\n\t\tsetObj.modified = new Date\r\n\t\tsetObj.modified_by = current_user\r\n\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\tinstance.values = setObj.values\r\n\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\treturn trace._id is trace_id\r\n\t\t)\r\n\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\treturn approve._id is approve_id\r\n\t\t)\r\n\t\toutbox_users = instance.outbox_users\r\n\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\toutbox_users.unshift(trace_approve.user)\r\n\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\r\n\t\tinstance_traces.push(newTrace)\r\n\t\tsetObj.traces = instance_traces\r\n\t\tsetObj.inbox_users = []\r\n\t\tsetObj.finish_date = new Date\r\n\t\tsetObj.current_step_name = next_step_name\r\n\t\tsetObj.final_decision = 'approved'\r\n\t\tsetObj.current_step_auto_submit = false\r\n\telse\r\n\t\t# 若不是结束结点\r\n\t\t# 先判断nextsteps.step.users是否为空\r\n\t\tnext_step_users = next_steps[0][\"users\"]\r\n\t\tif next_step_users is null or next_step_users.length is 0\r\n\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\r\n\t\telse\r\n\t\t\tif next_step_users.length > 1 and next_step.step_type isnt \"counterSign\"\r\n\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\r\n\t\t\telse\r\n\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\r\n\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id)\r\n\t\t\t\tif _.difference(next_step_users, next_user_ids).length > 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\r\n\t\t\t\telse\r\n\t\t\t\t\t# 若合法，执行流转操作\r\n\t\t\t\t\tinstance_traces = instance.traces\r\n\t\t\t\t\ti = 0\r\n\t\t\t\t\twhile i < instance_traces.length\r\n\t\t\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\r\n\t\t\t\t\t\t\t\t\t# instance_traces[i].approves[h].values = uuflowManager.getApproveValues(instance_traces[i].approves[h].values, step[\"permissions\"], instance.form, instance.form_version)\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\t\t\t\th++\r\n\t\t\t\t\t\ti++\r\n\r\n\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\tnewTrace = new Object\r\n\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\r\n\t\t\t\t\tnewTrace.approves = new Array\r\n\r\n\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\r\n\t\t\t\t\t\t# 插入下一步trace.approve记录\r\n\t\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\r\n\t\t\t\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\t\tif agent\r\n\t\t\t\t\t\t\tnext_step_users[idx] = agent\r\n\t\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\t\t\t\tnewApprove.handler = handler_id\r\n\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({ space: space_id, user: handler_id })\r\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\tnewApprove.start_date = new Date\r\n\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\r\n\t\t\t\t\t\tnewTrace.approves.push(newApprove)\r\n\r\n\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\t\tsetObj.values = updated_values\r\n\t\t\t\t\tinstance.values = setObj.values\r\n\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t\t)\r\n\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\t\t\treturn approve._id is approve_id\r\n\t\t\t\t\t)\r\n\t\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t\toutbox_users.unshift(trace_approve.user)\r\n\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\t\tsetObj.inbox_users = next_step_users\r\n\r\n\t\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\t\tsetObj.traces = instance_traces\r\n\t\t\t\t\tsetObj.current_step_name = next_step_name\r\n\r\n\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\r\n\treturn setObj\r\n\r\nuuflowManager.engine_step_type_is_sign = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted) ->\r\n\tsetObj = new Object\r\n\tspace_id = instance.space\r\n\t# 验证approve的judge是否为空\r\n\r\n\tif not judge\r\n\t\tthrow new Meteor.Error('error!', \"单签结点还未选择处理意见，操作失败\")\r\n\telse\r\n\t\tif judge is \"approved\"\r\n\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\r\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\")\r\n\r\n\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\r\n\t\t\t_.each(next_steps, (approve_next_step) ->\r\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\r\n\t\t\t)\r\n\t\t\t# 若合法,执行流转\r\n\t\t\tnext_step_id = next_steps[0][\"step\"]\r\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\t\t\tnext_step_type = next_step[\"step_type\"]\r\n\t\t\tnext_step_name = next_step[\"name\"]\r\n\t\t\t# 判断next_step是否为结束结点\r\n\t\t\tif next_step_type is \"end\"\r\n\t\t\t\t# 若是结束结点\r\n\t\t\t\tinstance_traces = instance.traces\r\n\t\t\t\ti = 0\r\n\t\t\t\twhile i < instance_traces.length\r\n\t\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\t\t\th++\r\n\t\t\t\t\ti++\r\n\r\n\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\tnewTrace.is_finished = true\r\n\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\tnewTrace.finish_date = new Date\r\n\r\n\t\t\t\t# 更新instance记录\r\n\t\t\t\tsetObj.state = \"completed\"\r\n\t\t\t\tsetObj.final_decision = judge\r\n\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\tinstance.values = setObj.values\r\n\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t)\r\n\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\t\treturn approve._id is approve_id\r\n\t\t\t\t)\r\n\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\t\t\toutbox_users.unshift(trace_approve.user)\r\n\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\tsetObj.traces = instance_traces\r\n\t\t\t\tsetObj.inbox_users = []\r\n\t\t\t\tsetObj.finish_date = new Date\r\n\r\n\t\t\t\tif instance.cc_users\r\n\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\tsetObj.current_step_auto_submit = false\r\n\t\t\telse\r\n\t\t\t\t# 若不是结束结点\r\n\t\t\t\t# 先判断nextsteps.step.users是否为空\r\n\t\t\t\tnext_step_users = next_steps[0][\"users\"]\r\n\t\t\t\tif next_step_users is null or next_step_users.length is 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\r\n\t\t\t\telse\r\n\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\r\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\r\n\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id)\r\n\t\t\t\t\t\tif _.difference(next_step_users, next_user_ids).length > 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t# 若合法，执行流转操作\r\n\t\t\t\t\t\t\tinstance_traces = instance.traces\r\n\t\t\t\t\t\t\ti = 0\r\n\t\t\t\t\t\t\twhile i < instance_traces.length\r\n\t\t\t\t\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\t\t\t\t\t\th++\r\n\t\t\t\t\t\t\t\ti++\r\n\r\n\t\t\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\t\t\tnewTrace = new Object\r\n\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\r\n\t\t\t\t\t\t\tnewTrace.approves = new Array\r\n\r\n\t\t\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\r\n\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\r\n\t\t\t\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\t\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\t\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\t\t\t\tif agent\r\n\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\r\n\t\t\t\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\r\n\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\r\n\t\t\t\t\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\t\t\t\t\tuser: handler_id\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\r\n\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\t\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\r\n\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\r\n\r\n\t\t\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\t\t\tsetObj.final_decision = judge\r\n\t\t\t\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\t\t\t\tsetObj.values = updated_values\r\n\t\t\t\t\t\t\tinstance.values = setObj.values\r\n\t\t\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\t\t\t\t\treturn approve._id is approve_id\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.user)\r\n\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\r\n\t\t\t\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\t\t\t\tsetObj.traces = instance_traces\r\n\r\n\t\t\t\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\t\t\t\tif instance.cc_users\r\n\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\r\n\r\n\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\t\telse if judge is \"rejected\"\r\n\t\t\tif not description\r\n\t\t\t\tthrow new Meteor.Error('error!', \"请填写驳回理由\")\r\n\t\t\telse\r\n\t\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\r\n\t\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"rejected\")\r\n\t\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\r\n\t\t\t\t_.each next_steps, (approve_next_step) ->\r\n\t\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\r\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\r\n\t\t\t\t# 若合法,执行流转\r\n\t\t\t\tnext_step_id = next_steps[0][\"step\"]\r\n\t\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\t\t\t\tnext_step_type = next_step[\"step_type\"]\r\n\t\t\t\tnext_step_name = next_step[\"name\"]\r\n\t\t\t\t# 判断next_step是否为结束结点\r\n\t\t\t\tif next_step_type is \"end\"\r\n\t\t\t\t\t# 若是结束结点\r\n\t\t\t\t\tinstance_traces = instance.traces\r\n\t\t\t\t\ti = 0\r\n\t\t\t\t\twhile i < instance_traces.length\r\n\t\t\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\t\t\t\th++\r\n\t\t\t\t\t\ti++\r\n\r\n\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\tnewTrace = new Object\r\n\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\t\tnewTrace.is_finished = true\r\n\t\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\t\tnewTrace.finish_date = new Date\r\n\r\n\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\tsetObj.state = \"completed\"\r\n\t\t\t\t\tsetObj.final_decision = judge\r\n\t\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\t\tinstance.values = setObj.values\r\n\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t\t)\r\n\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\t\t\treturn approve._id is approve_id\r\n\t\t\t\t\t)\r\n\t\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\t\t\t\toutbox_users.unshift(trace_approve.user)\r\n\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\t\tsetObj.traces = instance_traces\r\n\t\t\t\t\tsetObj.inbox_users = []\r\n\t\t\t\t\tsetObj.finish_date = new Date\r\n\r\n\t\t\t\t\tif instance.cc_users\r\n\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\t\tsetObj.current_step_auto_submit = false\r\n\t\t\t\telse\r\n\t\t\t\t\t# 若不是结束结点\r\n\t\t\t\t\t# 先判断nextsteps.step.users是否为空\r\n\t\t\t\t\tnext_step_users = next_steps[0][\"users\"]\r\n\t\t\t\t\tif next_step_users is null or next_step_users.length is 0\r\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\r\n\t\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id)\r\n\t\t\t\t\t\t\tif _.difference(next_step_users, next_user_ids).length > 0\r\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t# 若合法，执行流转操作\r\n\t\t\t\t\t\t\t\tinstance_traces = instance.traces\r\n\t\t\t\t\t\t\t\ti = 0\r\n\t\t\t\t\t\t\t\twhile i < instance_traces.length\r\n\t\t\t\t\t\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].judge = judge\r\n\t\t\t\t\t\t\t\t\t\th = 0\r\n\t\t\t\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\r\n\t\t\t\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\t\t\t\t\t\t\t\t\t\t\th++\r\n\t\t\t\t\t\t\t\t\ti++\r\n\r\n\t\t\t\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\t\t\t\tnewTrace = new Object\r\n\t\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\t\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\t\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\t\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\t\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\r\n\t\t\t\t\t\t\t\tnewTrace.approves = new Array\r\n\r\n\t\t\t\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\r\n\t\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\r\n\t\t\t\t\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\t\t\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\t\t\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\t\t\t\t\tif agent\r\n\t\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\r\n\t\t\t\t\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\r\n\t\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\r\n\t\t\t\t\t\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\t\t\t\t\t\tuser: handler_id\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\r\n\t\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\t\t\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\t\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\r\n\t\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\r\n\r\n\t\t\t\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\t\t\t\tsetObj.final_decision = judge\r\n\t\t\t\t\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\t\t\t\t\tsetObj.modified_by = current_user\r\n\t\t\t\t\t\t\t\tsetObj.values = updated_values\r\n\t\t\t\t\t\t\t\tinstance.values = setObj.values\r\n\t\t\t\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\r\n\r\n\t\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\t\t\t\t\t\treturn approve._id is approve_id\r\n\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.user)\r\n\t\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\r\n\t\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\r\n\t\t\t\t\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\t\t\t\t\tsetObj.traces = instance_traces\r\n\r\n\t\t\t\t\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\t\t\t\t\tif instance.cc_users\r\n\t\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\r\n\r\n\t\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\r\n\r\n\treturn setObj\r\n\r\nuuflowManager.engine_step_type_is_counterSign = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) ->\r\n\tsetObj = new Object\r\n\tspace_id = instance.space\r\n\t# 验证approve的judge是否为空\r\n\tif not judge\r\n\t\tthrow new Meteor.Error('error!', \"请选择核准或驳回。\")\r\n\telse\r\n\t\tif step.oneClickApproval and ['approved','readed'].includes(judge) and Meteor.settings?.public?.is_group_company\r\n\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\r\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\")\r\n\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\r\n\t\t\t_.each next_steps, (approve_next_step) ->\r\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\r\n\r\n\t\t# 若合法,执行流转\r\n\t\tnext_step_id = next_steps[0][\"step\"]\r\n\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\t\tnext_step_type = next_step[\"step_type\"]\r\n\t\tnext_step_name = next_step[\"name\"]\r\n\r\n\t\tinstance_traces = instance.traces\r\n\t\tisAllApproveFinished = true\r\n\t\ti = 0\r\n\t\twhile i < instance_traces.length\r\n\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\th = 0\r\n\t\t\t\twhile h < instance_traces[i].approves.length\r\n\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id or (Meteor.settings?.public?.is_group_company and (step.oneClickApproval and ['approved','readed'].includes(judge)) or (step.oneClickRejection and 'rejected' is judge))\r\n\t\t\t\t\t\t# 更新当前trace.approve记录\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\r\n\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\r\n\r\n\t\t\t\t\tif instance_traces[i].approves[h].is_finished is false and instance_traces[i].approves[h].type isnt 'cc' and instance_traces[i].approves[h].type isnt 'distribute'\r\n\t\t\t\t\t\tisAllApproveFinished = false\r\n\r\n\t\t\t\t\th++\r\n\t\t\ti++\r\n\r\n\t\tif isAllApproveFinished is true\r\n\t\t\ti = 0\r\n\t\t\twhile i < instance_traces.length\r\n\t\t\t\tif instance_traces[i]._id is trace_id\r\n\t\t\t\t\t# 更新当前trace记录\r\n\t\t\t\t\tinstance_traces[i].is_finished = true\r\n\t\t\t\t\tinstance_traces[i].finish_date = new Date\r\n\t\t\t\t\tinstance_traces[i].judge = \"submitted\"\r\n\t\t\t\ti++\r\n\r\n\t\t\t# 判断next_step是否为结束结点\r\n\t\t\tif next_step_type is \"end\"\r\n\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\tnewTrace = new Object\r\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\tnewTrace.is_finished = true\r\n\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\tnewTrace.finish_date = new Date\r\n\t\t\t\t# 更新instance记录\r\n\t\t\t\tsetObj.state = \"completed\"\r\n\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\r\n\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t)\r\n\r\n\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t_.each instance_trace.approves, (appro) ->\r\n\t\t\t\t\toutbox_users.push appro.user\r\n\t\t\t\t\toutbox_users.push appro.handler\r\n\r\n\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\tsetObj.inbox_users = new Array\r\n\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\tsetObj.traces = instance_traces\r\n\t\t\t\tsetObj.finish_date = new Date\r\n\r\n\t\t\t\tsetObj.values = instance.values\r\n\t\t\t\tif instance.cc_users\r\n\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\tsetObj.final_decision = 'approved'\r\n\t\t\t\tsetObj.current_step_auto_submit = false\r\n\t\t\telse\r\n\t\t\t\t# 若不是结束结点\r\n\t\t\t\t# 先判断nextsteps.step.users是否为空\r\n\t\t\t\tnext_step_users = next_steps[0][\"users\"]\r\n\t\t\t\tif next_step_users is null or next_step_users.length is 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\r\n\t\t\t\telse\r\n\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\r\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\r\n\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id)\r\n\t\t\t\t\t\tif _.difference(next_step_users, next_user_ids).length > 0\r\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\t\t\tnewTrace = new Object\r\n\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\tnewTrace.instance = instance_id\r\n\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\r\n\t\t\t\t\t\t\tnewTrace.is_finished = false\r\n\t\t\t\t\t\t\tnewTrace.step = next_step_id\r\n\t\t\t\t\t\t\tnewTrace.name = next_step_name\r\n\t\t\t\t\t\t\tnewTrace.start_date = new Date\r\n\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\r\n\t\t\t\t\t\t\tnewTrace.approves = new Array\r\n\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\r\n\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\r\n\t\t\t\t\t\t\t\tnewApprove = new Object\r\n\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\r\n\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\r\n\t\t\t\t\t\t\t\tnewApprove.is_finished = false\r\n\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\r\n\r\n\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\r\n\r\n\t\t\t\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\t\t\t\tif agent\r\n\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\r\n\t\t\t\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\r\n\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\r\n\r\n\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\r\n\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\r\n\r\n\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\r\n\t\t\t\t\t\t\t\t\tspace: space_id,\r\n\t\t\t\t\t\t\t\t\tuser: handler_id\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\r\n\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\r\n\t\t\t\t\t\t\t\tnewApprove.is_read = false\r\n\t\t\t\t\t\t\t\tnewApprove.is_error = false\r\n\t\t\t\t\t\t\t\tnewApprove.values = new Object\r\n\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\r\n\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\r\n\r\n\t\t\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\t\t\t\tsetObj.modified_by = current_user\r\n\r\n\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\t\t\t\t\treturn trace._id is trace_id\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\toutbox_users = instance.outbox_users\r\n\t\t\t\t\t\t\t_.each instance_trace.approves, (appro) ->\r\n\t\t\t\t\t\t\t\toutbox_users.push appro.user\r\n\t\t\t\t\t\t\t\toutbox_users.push appro.handler\r\n\r\n\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\r\n\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\r\n\t\t\t\t\t\t\tinstance_traces.push(newTrace)\r\n\t\t\t\t\t\t\tsetObj.traces = instance_traces\r\n\r\n\t\t\t\t\t\t\tsetObj.state = \"pending\"\r\n\t\t\t\t\t\t\tsetObj.values = instance.values\r\n\t\t\t\t\t\t\tif instance.cc_users\r\n\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\r\n\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\t\telse\r\n\t\t\t# 当前trace未结束\r\n\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\r\n\t\t\t\treturn trace._id is trace_id\r\n\t\t\t)\r\n\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\r\n\t\t\t\treturn approve._id is approve_id\r\n\t\t\t)\r\n\t\t\tinstance.outbox_users.unshift(trace_approve.handler)\r\n\t\t\tsetObj.outbox_users = instance.outbox_users\r\n\r\n\t\t\tinstance.inbox_users.splice(instance.inbox_users.indexOf(trace_approve.handler), 1)\r\n\r\n\t\t\tsetObj.inbox_users = instance.inbox_users\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\r\n\t\t\tsetObj.traces = instance_traces\r\n\r\n\t\t\tsetObj.state = \"pending\"\r\n\t\t\tsetObj.values = instance.values\r\n\t\t\tif instance.cc_users\r\n\t\t\t\tsetObj.cc_users = instance.cc_users\r\n\r\n\treturn setObj\r\n\r\n# 生成HTML格式只读表单和签核历程, 由于此方法生成的html数据会作为邮件内容发送，为了再邮件中样式显示正常，\r\n# 请不要写单独的css，所有样式请写在html标签的style属性中。\r\nuuflowManager.ins_html = (current_user_info, ins) ->\r\n\toptions = { templateName: 'table', showTrace: true, showAttachments: false }\r\n\toptions.width = \"765px\" #此处宽度不能设置为偶数，否则会引起子表与主表线条对不齐的bug\r\n\toptions.styles = \"\r\n\t\tbody {\r\n\t\t  background: #ffffff !important;\r\n\t\t}.steedos .pull-right {\r\n\t\t\tfloat: right !important;\r\n\t\t}.steedos .inline-left{\r\n\t\t\tdisplay: inline;float: left;\r\n\t\t}.steedos .inline-right{\r\n\t\t\tdisplay: inline;float: right;\r\n\t\t}.steedos .no-border{\r\n\t\t  border: 0px;\r\n\t\t}.steedos .no-border td{\r\n\t\t  border: 0px;\r\n\t\t}.steedos tr:nth-child(2) td{\r\n\t\t  border-top: 0px !important;\r\n\t\t}.steedos .ins_applicant{\r\n\t\t  display: inline;\r\n\t\t  background: transparent !important;\r\n\t\t  border: none;\r\n\t\t}.steedos .instance-name{\r\n\t\t  width: #{options.width} !important;\r\n\t\t}.steedos table {\r\n\t\t  border-spacing: 0;\r\n\t\t  border-collapse: collapse;\r\n\t\t}.steedos .box {\r\n\t\t  background: #ffffff;\r\n\t\t}.steedos .form-table {\r\n\t\t  width: #{options.width};\r\n\t\t  border: solid 2px #000000;\r\n\t\t  border-collapse: collapse;\r\n\t\t  table-layout: fixed;\r\n\t\t}.steedosTable-item-field{\r\n\t\t\tpadding: 5px;\r\n\t\t}.steedos td{\r\n\t\t  border: solid 1px #000000;\r\n\t\t  border-collapse: collapse;\r\n\t\t}.steedos th {\r\n\t\t  border: 0px;\r\n\t\t  border-collapse: collapse;\r\n\t\t  padding: 0px;\r\n\t\t}.steedos .td-title{\r\n\t\t  padding: 4px 12px;\r\n\t\t}.steedos .td-field {\r\n\t\t  padding: 4px 12px;\r\n\t\t}.instance-view .instance-name {\r\n\t\t  text-align: center;\r\n\t\t  font-weight: bolder;\r\n\t\t}.td-childfield {\r\n\t\t  border-top: solid 1px #000000;\r\n\t\t  border-right: solid 1px #000000;\r\n\t\t  border-bottom: solid 1px #000000;\r\n\t\t  padding: 0px;\r\n\t\t}.panel-heading{\r\n\t\t  padding: 4px 12px;\r\n\t\t  font-weight: bold;\r\n\t\t  color: #333;\r\n\t\t  background-color: #f5f5f5;\r\n\t\t}.table-bordered tr:last-child th {\r\n\t\t  border-bottom: none;\r\n\t\t}.table-bordered tr:last-child td {\r\n\t\t  border-bottom: none;\r\n\t\t}.steedos-table th:first-child{\r\n\t\t  border-left: 0px !important;\r\n\t\t}.steedos-table td:first-child {\r\n\t\t  border-left: 0px !important;\r\n\t\t}.steedos-table table thead .title {\r\n\t\t  min-width: 50px;\r\n\t\t}.steedos-table th:last-child{\r\n\t\t  border-right: 0px !important;\r\n\t\t}.steedos-table td:last-child {\r\n\t\t  border-right: 0px !important;\r\n\t\t}.steedos-table table .number {\r\n\t\t  text-align: right;\r\n\t\t}.callout-default{\r\n\t\t  border-color: #D2D6DE;\r\n\t\t  color: #333;\r\n\t\t  background-color: #F1F1F1;\r\n\t\t  font-weight: bold;\r\n\t\t}.instance-table .callout {\r\n\t\t  margin: 0px;\r\n\t\t  padding: 4px 12px;\r\n\t\t  border-radius: 0px;\r\n\t\t  border-left: none;\r\n\t\t}.approved{\r\n\t\t\tcolor: green;\r\n\t\t}.rejected{\r\n\t\t\tcolor: red;\r\n\t\t}.terminated{\r\n\t\t\tcolor: black;\r\n\t\t}.reassigned{\r\n\t\t\tcolor: black;\r\n\t\t}.retrieved{\r\n\t\t\tcolor: black;\r\n\t\t}.trace-approve-talbe td {\r\n    \t\ttext-align: left;\r\n    \t\tborder: none;\r\n\t\t}.traces td table {\r\n   \t\t\twidth: 100%;\r\n\t\t}.approve-item .name{\r\n\t\t\twidth: 40%;\r\n\t\t}.approve-item .finish-date{\r\n\t\t\twidth: 35%;\r\n\t\t}.td-stepname{\r\n\t\t\tpadding: 4px 12px;\r\n\t\t}.td-approve td{\r\n\t\t\tpadding: 4px 12px;\r\n\t\t}.applicant-wrapper {\r\n    \t\tfont-weight: bolder;\r\n\t\t}\r\n\t\"\r\n\r\n\tinstanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(current_user_info, ins.space, ins, options)\r\n\r\n#\t处理outlook 中，对部分css不支持的处理\r\n\tinstanceHtml = instanceHtml.replace('style=\"width: 100%;display: inline-table;\"', 'style=\"border:0px;text-align: center;width:765px;\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace('class=\"instance-table-name-td\"', 'class=\"instance-table-name-td\" style=\"width:' + options.width + ';border:0px\"')\r\n#\tinstanceHtml = instanceHtml.replace('class=\"instance-table-wrapper-td\"', 'class=\"instance-table-wrapper-td\" style=\"width:' + options.width + ';border:0px\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace('class=\"instance-name\"', 'class=\"instance-name\" style=\"width:' + options.width + '\"')\r\n\tinstanceHtml = instanceHtml.replace('class=\"table-page-body form-table\"', 'class=\"table-page-body form-table\" style=\"width:' + options.width + '\"')\r\n\tinstanceHtml = instanceHtml.replace('class=\"table table-condensed traces\"', 'class=\"table table-condensed traces\" style=\"width:' + options.width + ';border:solid 2.0px #000000\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace('class=\"table-page-footer form-table no-border\"', 'class=\"table-page-footer form-table no-border\" style=\"border:0px;width:765px;\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace(/class=\"td-title \"/g, 'class=\"td-title\" style=\"width:14%\"')\r\n\tinstanceHtml = instanceHtml.replace(/class=\"td-stepname\"/g, 'class=\"td-stepname\" style=\"width:' + 765 * 20 / 100 + 'px\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace(/class=\"td-childfield\"/g, 'class=\"td-childfield\" style=\"padding:0px\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace(/class=\"status approved\"/g, 'class=\"status approved\" style=\"color: green;\"')\r\n\tinstanceHtml = instanceHtml.replace(/class=\"status rejected\"/g, 'class=\"status rejected\" style=\"color: red;\"')\r\n\r\n\tinstanceHtml = instanceHtml.replace(/<table>/g, '<table style=\"width:100%;border:none\">')\r\n\tinstanceHtml = instanceHtml.replace(/<td class=\"name\">/g, '<td class=\"name\" style=\"width: 40%;\">')\r\n\tinstanceHtml = instanceHtml.replace(/<td class=\"finish-date\">/g, '<td class=\"finish-date\" style=\"width: 35%;\">')\r\n\r\n\tinstanceHtml = instanceHtml.replace(/inline-left'/g, \"inline-left' style='display: inline;float: left;'\")\r\n\tinstanceHtml = instanceHtml.replace(/inline-right'/g, \"inline-right' style='display: inline;float: right;'\")\r\n\tinstanceHtml = instanceHtml.replace(/pull-right'/g, \"pull-right' style='float: right;'\")\r\n\r\n\r\n\treturn instanceHtml\r\n\r\nuuflowManager.getFlowCompanyId = (flowId)->\r\n\treturn db.flows.findOne(flowId, { fields: { company_id: 1 } })?.company_id\r\n\r\nuuflowManager.create_instance = (instance_from_client, user_info) ->\r\n\tspace_id = instance_from_client[\"space\"]\r\n\tflow_id = instance_from_client[\"flow\"]\r\n\tinstance_flow_version = instance_from_client[\"flow_version\"]\r\n\tuser_id = user_info._id\r\n\t# 获取前台所传的trace\r\n\ttrace_from_client = null\r\n\t# 获取前台所传的approve\r\n\tapprove_from_client = null\r\n\tif instance_from_client[\"traces\"] and instance_from_client[\"traces\"][0]\r\n\t\ttrace_from_client = instance_from_client[\"traces\"][0]\r\n\t\tif trace_from_client[\"approves\"] and trace_from_client[\"approves\"][0]\r\n\t\t\tapprove_from_client = instance_from_client[\"traces\"][0][\"approves\"][0]\r\n\r\n\t# 获取一个space\r\n\tspace = uuflowManager.getSpace(space_id)\r\n\t# 获取一个flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\t# 获取一个space下的一个user\r\n\tspace_user = uuflowManager.getSpaceUser(space_id, user_id)\r\n\t# 获取space_user所在的部门信息\r\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t# 判断一个flow是否为启用状态\r\n\tuuflowManager.isFlowEnabled(flow)\r\n\t# 判断一个flow和space_id是否匹配\r\n\tuuflowManager.isFlowSpaceMatched(flow, space_id)\r\n\r\n\tform = uuflowManager.getForm(flow.form)\r\n\r\n\tpermissions = permissionManager.getFlowPermissions(flow_id, user_id)\r\n\r\n\tif not permissions.includes(\"add\")\r\n\t\tthrow new Meteor.Error('error!', \"当前用户没有此流程的新建权限\")\r\n\r\n\tnow = new Date\r\n\tins_obj = {}\r\n\tins_obj._id = db.instances._makeNewID()\r\n\tins_obj.space = space_id\r\n\tins_obj.flow = flow_id\r\n\tins_obj.flow_version = flow.current._id\r\n\tins_obj.form = flow.form\r\n\tins_obj.form_version = flow.current.form_version\r\n\tins_obj.name = flow.name\r\n\tins_obj.submitter = user_id\r\n\tins_obj.submitter_name = user_info.name\r\n\tins_obj.applicant = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tins_obj.applicant_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tins_obj.applicant_organization = if instance_from_client[\"applicant_organization\"] then instance_from_client[\"applicant_organization\"] else space_user.organization\r\n\tins_obj.applicant_organization_name = if instance_from_client[\"applicant_organization_name\"] then instance_from_client[\"applicant_organization_name\"] else space_user_org_info.organization_name\r\n\tins_obj.applicant_organization_fullname = if instance_from_client[\"applicant_organization_fullname\"] then instance_from_client[\"applicant_organization_fullname\"] else  space_user_org_info.organization_fullname\r\n\tins_obj.applicant_company = if instance_from_client[\"applicant_company\"] then instance_from_client[\"applicant_company\"] else space_user.company_id\r\n\tins_obj.state = 'draft'\r\n\tins_obj.code = ''\r\n\tins_obj.is_archived = false\r\n\tins_obj.is_deleted = false\r\n\tins_obj.created = now\r\n\tins_obj.created_by = user_id\r\n\tins_obj.modified = now\r\n\tins_obj.modified_by = user_id\r\n\tins_obj.values = new Object\r\n\r\n\tcompanyId = uuflowManager.getFlowCompanyId(flow_id)\r\n\tif companyId\r\n\t\tins_obj.company_id = companyId\r\n\r\n\t# 新建Trace\r\n\ttrace_obj = {}\r\n\ttrace_obj._id = new Mongo.ObjectID()._str\r\n\ttrace_obj.instance = ins_obj._id\r\n\ttrace_obj.is_finished = false\r\n\t# 当前最新版flow中开始节点\r\n\tstart_step = _.find(flow.current.steps, (step) ->\r\n\t\treturn step.step_type is 'start'\r\n\t)\r\n\ttrace_obj.step = start_step._id\r\n\ttrace_obj.name = start_step.name\r\n\r\n\ttrace_obj.start_date = now\r\n\t# 新建Approve\r\n\tappr_obj = {}\r\n\tappr_obj._id = new Mongo.ObjectID()._str\r\n\tappr_obj.instance = ins_obj._id\r\n\tappr_obj.trace = trace_obj._id\r\n\tappr_obj.is_finished = false\r\n\tappr_obj.user = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\r\n\tappr_obj.user_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\r\n\tappr_obj.handler = user_id\r\n\tappr_obj.handler_name = user_info.name\r\n\tappr_obj.handler_organization = space_user.organization\r\n\tappr_obj.handler_organization_name = space_user_org_info.organization_name\r\n\tappr_obj.handler_organization_fullname = space_user_org_info.organization_fullname\r\n\tappr_obj.type = 'draft'\r\n\tappr_obj.start_date = now\r\n\tappr_obj.read_date = now\r\n\tappr_obj.is_read = true\r\n\tappr_obj.is_error = false\r\n\tappr_obj.description = ''\r\n\tappr_obj.values = if approve_from_client and approve_from_client[\"values\"] then approve_from_client[\"values\"] else new Object\r\n\r\n\ttrace_obj.approves = [appr_obj]\r\n\tins_obj.traces = [trace_obj]\r\n\r\n\tins_obj.inbox_users = instance_from_client.inbox_users || []\r\n\r\n\tins_obj.current_step_name = start_step.name\r\n\r\n\tif flow.auto_remind is true\r\n\t\tins_obj.auto_remind = true\r\n\r\n\t# 新建申请单时，instances记录流程名称、流程分类名称 #1313\r\n\tins_obj.flow_name = flow.name\r\n\tif form.category\r\n\t\tcategory = uuflowManager.getCategory(form.category)\r\n\t\tif category\r\n\t\t\tins_obj.category_name = category.name\r\n\t\t\tins_obj.category = category._id\r\n\r\n\tnew_ins_id = db.instances.insert(ins_obj)\r\n\r\n\treturn new_ins_id\r\n\r\nuuflowManager.getCurrentStepAutoSubmit = (timeout_auto_submit, lines)->\r\n\tif timeout_auto_submit && lines\r\n\t\ttimeout_line = _.find lines, (l)->\r\n\t\t\treturn l.timeout_line == true\r\n\t\tif timeout_line\r\n\t\t\treturn true\r\n\r\n\treturn false\r\n\r\nuuflowManager.getDueDate = (hours)->\r\n\tif hours\r\n\t\tdue_time = new Date().getTime() + (1000 * 60 * 60 * hours)\r\n\t\treturn new Date(due_time)\r\n\r\n\treturn undefined\r\n\r\n\r\nuuflowManager.submit_instance = (instance_from_client, user_info) ->\r\n\tcurrent_user = user_info._id\r\n\tlang = \"en\"\r\n\tif user_info.locale is 'zh-cn'\r\n\t\tlang = 'zh-CN'\r\n\r\n\tinstance_id = instance_from_client[\"_id\"]\r\n\ttrace_id = instance_from_client[\"traces\"][0][\"_id\"]\r\n\tapprove_id = instance_from_client[\"traces\"][0][\"approves\"][0][\"_id\"]\r\n\tvalues = instance_from_client[\"traces\"][0][\"approves\"][0][\"values\"]\r\n\tif not values\r\n\t\tvalues = new Object\r\n\t#　验证表单上的applicant已填写\r\n\tif not instance_from_client[\"applicant\"]\r\n\t\tthrow new Meteor.Error('error!', \"请选择提交人\")\r\n\r\n\tapplicant_id = instance_from_client[\"applicant\"]\r\n\tsubmitter_id = instance_from_client[\"submitter\"]\r\n\tnext_steps = instance_from_client[\"traces\"][0][\"approves\"][0][\"next_steps\"]\r\n\tattachments = instance_from_client[\"traces\"][0][\"approves\"][0][\"attachments\"]\r\n\tdescription = instance_from_client[\"traces\"][0][\"approves\"][0][\"description\"]\r\n\t# 获取一个instance\r\n\tinstance = uuflowManager.getInstance(instance_id)\r\n\tspace_id = instance.space\r\n\tflow_id = instance.flow\r\n\t# 获取一个space\r\n\tspace = uuflowManager.getSpace(space_id)\r\n\t# 校验申请人user_accepted = true\r\n\tcheckApplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\r\n\t# 获取一个flow\r\n\tflow = uuflowManager.getFlow(flow_id)\r\n\t# 确定instance的name\r\n\tinstance_name = instance_from_client[\"name\"]\r\n\t# 判断一个instance是否为拟稿状态\r\n\tuuflowManager.isInstanceDraft(instance, lang)\r\n\t# 获取一个space下的一个user\r\n\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\r\n\t# 获取space_user所在的部门信息\r\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\r\n\t# 判断一个用户是否是一个instance的提交者\r\n\tuuflowManager.isInstanceSubmitter(instance, current_user)\r\n\t# 判断一个flow是否为启用状态\r\n\tuuflowManager.isFlowEnabled(flow)\r\n\t# 验证该user_id或其所在的组有提交此申请单的权限\r\n\tpermissions = permissionManager.getFlowPermissions(flow_id, current_user)\r\n\tif not permissions.includes(\"add\")\r\n\t\tthrow new Meteor.Error('error!', \"该提交人没有提交此申请单的权限。\")\r\n\r\n\ttrace = instance_from_client[\"traces\"][0]\r\n\t# 获取一个step\r\n\tstep = uuflowManager.getStep(instance, flow, trace[\"step\"])\r\n\tapprove = trace[\"approves\"][0]\r\n\t# 先执行暂存的操作\r\n\t# ================begin================\r\n\tform = db.forms.findOne(instance.form)\r\n\t# 获取Flow当前版本开始节点\r\n\tstart_step = _.find(flow.current.steps, (step) ->\r\n\t\treturn step.step_type is 'start'\r\n\t)\r\n\r\n\tinstance_traces = instance.traces\r\n\tinstance_traces[0][\"approves\"][0].description = description\r\n\tsetObj = new Object\r\n\tflow_has_upgrade = false\r\n\t# 判断:applicant和原instance的applicant是否相等\r\n\tif applicant_id is instance.applicant\r\n\t\t# applicant和原instance的applicant相等\r\n\t\t# 判断流程是否已升级，instance[\"flow_version\"] == flow[\"current\"][\"_id\"]表示流程未升级\r\n\t\tif instance.flow_version is flow.current._id\r\n\t\t\t# instance_traces[0][\"approves\"][0].values = values\r\n\t\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\r\n\t\t\t# 判断next_steps是否为空,不为空则写入到当前approve的next_steps中\r\n\t\t\tif next_steps\r\n\t\t\t\tinstance_traces[0][\"approves\"][0].next_steps = next_steps\r\n\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\t\telse\r\n\t\t\t# 流程已升级\r\n\t\t\tflow_has_upgrade = true\r\n\t\t\t# 更新instance记录\r\n\t\t\tsetObj.flow_version = flow.current._id\r\n\t\t\tsetObj.form_version = flow.current.form_version\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\t\t\t# 清空原来的值， 存入当前最新版flow中开始节点的step_id\r\n\t\t\tinstance_traces[0].step = start_step._id\r\n\t\t\tinstance_traces[0].name = start_step.name\r\n\t\t\t# instance_traces[0][\"approves\"][0].values = values\r\n\t\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\r\n\r\n\telse\r\n\t\t# applicant和原instance的applicant不相等\r\n\t\tuser = uuflowManager.getUser(applicant_id)\r\n\t\tapplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\r\n\t\t# 获取applicant所在的部门信息\r\n\t\tapplicant_org_info = uuflowManager.getSpaceUserOrgInfo(applicant)\r\n\t\t# 修改instance的applicant,applicant_name，同时修改开始结点的approve的user为:applicant,user_name\r\n\t\tsetObj.applicant = applicant_id\r\n\t\tsetObj.applicant_name = user.name\r\n\t\tsetObj.applicant_organization = applicant_org_info[\"organization\"]\r\n\t\tsetObj.applicant_organization_name = applicant_org_info[\"organization_name\"]\r\n\t\tsetObj.applicant_organization_fullname = applicant_org_info[\"organization_fullname\"]\r\n\t\tsetObj.applicant_company = applicant[\"company_id\"]\r\n\t\tinstance_traces[0][\"approves\"][0].user = applicant_id\r\n\t\tinstance_traces[0][\"approves\"][0].user_name = user.name\r\n\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\r\n\r\n\t\t# 判断流程是否已升级，instance[\"flow_version\"] == flow[\"current\"][\"_id\"]表示流程未升级\r\n\t\tif instance.flow_version is flow.current._id\r\n\t\t\t# instance_traces[0][\"approves\"][0].values = values\r\n\t\t\t# 判断next_steps是否为空,不为空则写入到当前approve的next_steps中\r\n\t\t\tif next_steps\r\n\t\t\t\tinstance_traces[0][\"approves\"][0].next_steps = next_steps\r\n\t\t\t\tsetObj.modified = new Date\r\n\t\t\t\tsetObj.modified_by = current_user\r\n\t\telse\r\n\t\t\t# 流程已升级\r\n\t\t\tflow_has_upgrade = true\r\n\t\t\t# 更新instance记录\r\n\t\t\tsetObj.flow_version = flow.current._id\r\n\t\t\tsetObj.form_version = flow.current.form_version\r\n\t\t\tsetObj.modified = new Date\r\n\t\t\tsetObj.modified_by = current_user\r\n\t\t\t# 清空原来的值， 存入当前最新版flow中开始节点的step_id\r\n\t\t\tinstance_traces[0].step = start_step._id\r\n\t\t\tinstance_traces[0].name = start_step.name\r\n\t\t\t# instance_traces[0][\"approves\"][0].values = values\r\n\r\n\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\r\n\tinstance_traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(values, step.permissions, instance.form, instance.form_version)\r\n\r\n\tsetObj.traces = instance_traces\r\n\tdb.instances.update({ _id: instance_id }, { $set: setObj })\r\n\tif flow_has_upgrade\r\n\t\treturn { alerts: TAPi18n.__('flow.point_upgraded', {}, lang) }\r\n\t# ================end================\r\n\tinstance = db.instances.findOne(instance_id) #使用最新的instance\r\n\t# 判断一个instance是否为拟稿状态\r\n\tuuflowManager.isInstanceDraft(instance, lang)\r\n\ttraces = instance.traces\r\n\tupObj = new Object\r\n\r\n\tif (not approve[\"next_steps\"]) or (approve[\"next_steps\"].length is 0)\r\n\t\tthrow new Meteor.Error('error!', \"还未指定下一步和处理人，提交失败\")\r\n\telse\r\n\t\t# 验证next_steps里面是否只有一个step\r\n\t\tif approve[\"next_steps\"].length > 1\r\n\t\t\tthrow new Meteor.Error('error!', \"不能指定多个后续步骤\")\r\n\t\telse\r\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\")\r\n\t\t\t_.each(approve[\"next_steps\"], (approve_next_step) ->\r\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"下一步步骤不合法\")\r\n\t\t\t)\r\n\t# 校验下一步处理人user_accepted = true\r\n\t_.each(approve[\"next_steps\"][0][\"users\"], (next_step_user) ->\r\n\t\tuuflowManager.getSpaceUser(space_id, next_step_user)\r\n\t)\r\n\tnext_step = uuflowManager.getStep(instance, flow, approve[\"next_steps\"][0][\"step\"])\r\n\t# 判断next_step是否为结束结点\r\n\tif next_step.step_type is \"end\"\r\n\r\n\t\t# 更新approve\r\n\t\ttraces[0][\"approves\"][0].is_finished = true\r\n\t\ttraces[0][\"approves\"][0].finish_date = new Date\r\n\t\ttraces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date\r\n\t\t# 更新trace\r\n\t\ttraces[0].is_finished = true\r\n\t\ttraces[0].judge = \"submitted\"\r\n\t\ttraces[0].finish_date = new Date\r\n\t\t# 插入下一步trace记录\r\n\t\tnewTrace = new Object\r\n\t\tnewTrace._id = new Mongo.ObjectID()._str\r\n\t\tnewTrace.instance = instance_id\r\n\t\tnewTrace.previous_trace_ids = [trace[\"_id\"]]\r\n\t\tnewTrace.is_finished = true\r\n\t\tnewTrace.step = next_step._id\r\n\t\tnewTrace.name = next_step.name\r\n\t\tnewTrace.start_date = new Date\r\n\t\tnewTrace.finish_date = new Date\r\n\t\t# 更新instance记录\r\n\t\t# 申请单名称按照固定规则生成申请单名称：流程名称＋' '+申请单编号\r\n\t\tupObj.submit_date = new Date\r\n\t\tupObj.state = \"completed\"\r\n\t\tupObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\tupObj.code = flow.current_no + 1 + \"\"\r\n\t\tinstance.code = upObj.code\r\n\t\tinstance.values = upObj.values\r\n\t\tupObj.name = uuflowManager.getInstanceName(instance)\r\n\t\tupObj.modified = new Date\r\n\t\tupObj.modified_by = current_user\r\n\t\tupObj.inbox_users = []\r\n\t\tupObj.outbox_users = _.uniq [current_user, traces[0][\"approves\"][0][\"user\"]]\r\n\t\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\r\n\t\t# traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(traces[0][\"approves\"][0].values, step.permissions, instance.form, instance.form_version)\r\n\t\ttraces.push(newTrace)\r\n\t\tupObj.traces = traces\r\n\t\tupObj.finish_date = new Date\r\n\t\tupObj.current_step_name = next_step.name\r\n\t\tupObj.final_decision = \"approved\"\r\n\t\tupObj.current_step_auto_submit = false\r\n\telse # next_step不为结束节点\r\n\t\t# 取得下一步处理人\r\n\t\tnext_step_users = approve[\"next_steps\"][0][\"users\"]\r\n\t\t# 判断nextsteps.step.users是否为空\r\n\t\tif (not next_step_users) or (next_step_users.length is 0)\r\n\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\r\n\t\telse\r\n\t\t\tif next_step_users.length > 1 and next_step.step_type isnt \"counterSign\"\r\n\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\r\n\t\t\telse\r\n\t\t\t\t# 验证下一步处理人next_user是否合法\r\n\t\t\t\tcheckUsers = getHandlersManager.getHandlers(instance_id, approve[\"next_steps\"][0][\"step\"])\r\n\t\t\t\tif _.difference(next_step_users, checkUsers).length > 0\r\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\r\n\t\t\t\telse\r\n\t\t\t\t\t# 若合法，执行流转操作\r\n\t\t\t\t\t# 更新approve\r\n\t\t\t\t\ttraces[0][\"approves\"][0].is_finished = true\r\n\t\t\t\t\ttraces[0][\"approves\"][0].finish_date = new Date\r\n\t\t\t\t\ttraces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date\r\n\t\t\t\t\t# 更新trace\r\n\t\t\t\t\ttraces[0].is_finished = true\r\n\t\t\t\t\ttraces[0].finish_date = new Date\r\n\t\t\t\t\ttraces[0].judge = \"submitted\"\r\n\t\t\t\t\t# 插入下一步trace记录\r\n\t\t\t\t\tnextTrace = new Object\r\n\t\t\t\t\tnextTrace._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\tnextTrace.instance = instance_id\r\n\t\t\t\t\tnextTrace.previous_trace_ids = [trace[\"_id\"]]\r\n\t\t\t\t\tnextTrace.is_finished = false\r\n\t\t\t\t\tnextTrace.step = next_step._id\r\n\t\t\t\t\tnextTrace.name = next_step.name\r\n\t\t\t\t\tnextTrace.start_date = new Date\r\n\t\t\t\t\tnextTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\r\n\t\t\t\t\tnextTrace.approves = new Array\r\n\r\n\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\r\n\t\t\t\t\t# 插入下一步trace.approve记录\r\n\t\t\t\t\t_.each(next_step_users, (next_step_user_id, idx) ->\r\n\t\t\t\t\t\tnextApprove = new Object\r\n\t\t\t\t\t\tnextApprove._id = new Mongo.ObjectID()._str\r\n\r\n\t\t\t\t\t\tuser_info = uuflowManager.getUser(next_step_user_id)\r\n\t\t\t\t\t\thandler_id = next_step_user_id\r\n\t\t\t\t\t\thandler_info = user_info\r\n\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\r\n\t\t\t\t\t\tif agent\r\n\t\t\t\t\t\t\tnext_step_users[idx] = agent\r\n\t\t\t\t\t\t\thandler_id = agent\r\n\t\t\t\t\t\t\thandler_info = uuflowManager.getUser(agent)\r\n\t\t\t\t\t\t\tnextApprove.agent = agent\r\n\r\n\t\t\t\t\t\tnextApprove.instance = instance_id\r\n\t\t\t\t\t\tnextApprove.trace = nextTrace._id\r\n\t\t\t\t\t\tnextApprove.is_finished = false\r\n\t\t\t\t\t\tnextApprove.user = next_step_user_id\r\n\t\t\t\t\t\tnextApprove.user_name = user_info.name\r\n\t\t\t\t\t\tnextApprove.handler = handler_id\r\n\t\t\t\t\t\tnextApprove.handler_name = handler_info.name\r\n\t\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\r\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\tnextApprove.handler_organization = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\tnextApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\tnextApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\tnextApprove.start_date = new Date\r\n\t\t\t\t\t\tnextApprove.due_date = nextTrace.due_date\r\n\t\t\t\t\t\tnextApprove.is_read = false\r\n\t\t\t\t\t\tnextApprove.is_error = false\r\n\t\t\t\t\t\tnextApprove.values = new Object\r\n\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, nextApprove)\r\n\t\t\t\t\t\tnextTrace.approves.push(nextApprove)\r\n\t\t\t\t\t)\r\n\t\t\t\t\t# 更新instance记录\r\n\t\t\t\t\tupObj.name = instance_name\r\n\t\t\t\t\tupObj.submit_date = new Date\r\n\t\t\t\t\tupObj.state = \"pending\"\r\n\t\t\t\t\t# 重新查找暂存之后的instance\r\n\t\t\t\t\tupObj.values = updated_values\r\n\t\t\t\t\tupObj.inbox_users = next_step_users\r\n\t\t\t\t\tupObj.modified = new Date\r\n\t\t\t\t\tupObj.modified_by = current_user\r\n\t\t\t\t\t# 申请单名称按照固定规则生成申请单名称：流程名称＋' '+申请单编号\r\n\t\t\t\t\tupObj.code = flow.current_no + 1 + \"\"\r\n\t\t\t\t\tinstance.code = upObj.code\r\n\t\t\t\t\tinstance.values = upObj.values\r\n\t\t\t\t\tupObj.name = uuflowManager.getInstanceName(instance)\r\n\t\t\t\t\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\r\n\t\t\t\t\t# traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(traces[0][\"approves\"][0].values, step[\"permissions\"], instance.form, instance.form_version)\r\n\t\t\t\t\ttraces.push(nextTrace)\r\n\t\t\t\t\tupObj.traces = traces\r\n\t\t\t\t\tupObj.outbox_users = []\r\n\t\t\t\t\tupObj.current_step_name = next_step.name\r\n\t\t\t\t\tupObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\r\n\r\n\tupObj.keywords = uuflowManager.caculateKeywords(upObj.values, form, instance.form_version)\r\n\tdb.instances.update({ _id: instance_id }, { $set: upObj })\r\n\tdb.flows.direct.update({ _id: flow._id }, { $set: { current_no: flow.current_no + 1 } })\r\n\tif next_step.step_type isnt \"end\"\r\n\t\tinstance = db.instances.findOne(instance_id)\r\n\t\t#发送短消息给申请人\r\n\t\tpushManager.send_instance_notification(\"first_submit_applicant\", instance, \"\", user_info)\r\n\t\t# 发送消息给下一步处理人\r\n\t\tpushManager.send_instance_notification(\"first_submit_inbox\", instance, \"\", user_info)\r\n\treturn {}\r\n\r\nuuflowManager.get_SpaceChangeSet = (formids, is_admin, sync_token) ->\r\n\tsync_token = new Date(Number(sync_token) * 1000)\r\n\tchangeSet = new Object\r\n\tchangeSet.sync_token = new Date().getTime() / 1000\r\n\tchangeSet.inserts = {\r\n\t\tSpaces: [],\r\n\t\tUsers: [],\r\n\t\tSpaceUsers: [],\r\n\t\tOrganizations: [],\r\n\t\tRoles: [],\r\n\t\tPositions: [],\r\n\t\tForms: [],\r\n\t\tFlows: [],\r\n\t\tInstances: []\r\n\t}\r\n\tchangeSet.updates = {\r\n\t\tSpaces: [],\r\n\t\tUsers: [],\r\n\t\tSpaceUsers: [],\r\n\t\tOrganizations: [],\r\n\t\tRoles: [],\r\n\t\tPositions: [],\r\n\t\tForms: [],\r\n\t\tFlows: [],\r\n\t\tInstances: []\r\n\t}\r\n\tchangeSet.deletes = {\r\n\t\tSpaces: [],\r\n\t\tUsers: [],\r\n\t\tSpaceUsers: [],\r\n\t\tOrganizations: [],\r\n\t\tRoles: [],\r\n\t\tPositions: [],\r\n\t\tForms: [],\r\n\t\tFlows: [],\r\n\t\tInstances: []\r\n\t}\r\n\r\n\tif formids and formids.trim()\r\n\t\tformids_ary = formids.split(\",\")\r\n\t\tchangeSet.inserts.Instances = db.instances.find({\r\n\t\t\tform: { $in: formids_ary },\r\n\t\t\tcreated: { $gt: sync_token }\r\n\t\t}).fetch()\r\n\t\tchangeSet.updates.Instances = db.instances.find({\r\n\t\t\tform: { $in: formids_ary },\r\n\t\t\tcreated: { $lte: sync_token },\r\n\t\t\tmodified: { $gt: sync_token }\r\n\t\t}).fetch()\r\n\t\tchangeSet.deletes.Instances = db.deleted_instances.find({\r\n\t\t\tform: { $in: formids_ary },\r\n\t\t\tdeleted: { $gt: sync_token }\r\n\t\t}, { fields: { _id: 1 } }).fetch()\r\n\r\n\telse if is_admin and is_admin.trim()\r\n\t\tchangeSet.inserts.Instances = db.instances.find({\r\n\t\t\tcreated: { $gt: sync_token }\r\n\t\t}).fetch()\r\n\t\tchangeSet.updates.Instances = db.instances.find({\r\n\t\t\tcreated: { $lte: sync_token },\r\n\t\t\tmodified: { $gt: sync_token }\r\n\t\t}).fetch()\r\n\t\tchangeSet.deletes.Instances = db.deleted_instances.find({\r\n\t\t\tdeleted: { $gt: sync_token }\r\n\t\t}, { fields: { _id: 1 } }).fetch()\r\n\r\n\t# 查询提交人和申请人steedos_id\r\n\t_.each changeSet.inserts.Instances, (ins) ->\r\n\t\tsubmitter = db.users.findOne({ _id: ins.submitter }, { fields: { steedos_id: 1 } })\r\n\t\tapplicant = db.users.findOne({ _id: ins.applicant }, { fields: { steedos_id: 1 } })\r\n\t\tins.submitter_steedos_id = submitter.steedos_id if submitter\r\n\t\tins.applicant_steedos_id = applicant.steedos_id if applicant\r\n\t_.each changeSet.updates.Instances, (ins) ->\r\n\t\tsubmitter = db.users.findOne({ _id: ins.submitter }, { fields: { steedos_id: 1 } })\r\n\t\tapplicant = db.users.findOne({ _id: ins.applicant }, { fields: { steedos_id: 1 } })\r\n\t\tins.submitter_steedos_id = submitter.steedos_id if submitter\r\n\t\tins.applicant_steedos_id = applicant.steedos_id if applicant\r\n\r\n\treturn { ChangeSet: changeSet }\r\n\r\n### 文件催办\r\n根据instance.values.priority和instance.values.deadline给approve增加remind相关信息\r\n{\r\n\tdeadline: Date,\r\n\tremind_date: Date,\r\n\treminded_count: Number\r\n}\r\n###\r\nuuflowManager.setRemindInfo = (values, approve) ->\r\n\tcheck values, Object\r\n\tcheck approve, Object\r\n\tcheck approve.start_date, Date\r\n\r\n\tremind_date = null\r\n\tdeadline = null\r\n\tstart_date = approve.start_date\r\n\r\n\tif values.priority and values.deadline\r\n\t\tcheck values.priority, Match.OneOf(\"普通\", \"办文\", \"紧急\", \"特急\")\r\n\t\t# 由于values中的date字段的值为String，故作如下校验\r\n\t\tdeadline = new Date(values.deadline)\r\n\t\tif deadline.toString() is \"Invalid Date\"\r\n\t\t\treturn\r\n\r\n\t\tpriority = values.priority\r\n\r\n\t\tif priority is \"普通\"\r\n\t\t\tremind_date = Steedos.caculateWorkingTime(start_date, 3)\r\n\t\telse if priority is \"办文\"\r\n\t\t\tif Steedos.caculatePlusHalfWorkingDay(start_date) > deadline # 超过了办结时限或者距离办结时限半日内\r\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true)\r\n\t\t\telse if Steedos.caculateWorkingTime(start_date, 1) > deadline\r\n\t\t\t\tcaculate_date = (base_date) ->\r\n\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\r\n\t\t\t\t\tif plus_halfday_date > deadline\r\n\t\t\t\t\t\tremind_date = base_date\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\r\n\t\t\t\t\treturn\r\n\t\t\t\tcaculate_date(start_date)\r\n\t\t\telse\r\n\t\t\t\tremind_date = Steedos.caculateWorkingTime(start_date, 1)\r\n\t\telse if priority is \"紧急\" or priority is \"特急\"\r\n\t\t\tif Steedos.caculatePlusHalfWorkingDay(start_date) > deadline # 超过了办结时限或者距离办结时限半日内\r\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true)\r\n\t\t\telse if Steedos.caculateWorkingTime(start_date, 1) > deadline\r\n\t\t\t\tcaculate_date = (base_date) ->\r\n\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\r\n\t\t\t\t\tif plus_halfday_date > deadline\r\n\t\t\t\t\t\tremind_date = base_date\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\r\n\t\t\t\t\treturn\r\n\t\t\t\tcaculate_date(start_date)\r\n\t\t\telse\r\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay start_date\r\n\t\t\tins = db.instances.findOne(approve.instance)\r\n\t\t\tif ins.state is 'draft'\r\n\t\t\t\tflow = db.flows.findOne({ _id: ins.flow }, { fields: { current_no: 1 } })\r\n\t\t\t\tins.code = flow.current_no + 1 + ''\r\n\t\t\tins.values = values\r\n\t\t\tuuflowManager.sendRemindSMS uuflowManager.getInstanceName(ins), deadline, [approve.user], ins.space, ins._id\r\n\telse\r\n\t\t# 如果没有配置 紧急程度 和办结时限 则按照 '普通' 规则催办\r\n\t\tremind_date = Steedos.caculateWorkingTime(start_date, 3)\r\n\r\n\tapprove.deadline = deadline\r\n\tapprove.remind_date = remind_date\r\n\tapprove.reminded_count = 0\r\n\r\n\treturn\r\n\r\n# 发送催办短信\r\nuuflowManager.sendRemindSMS = (ins_name, deadline, users_id, space_id, ins_id) ->\r\n\tcheck ins_name, String\r\n\tcheck deadline, Date\r\n\tcheck users_id, Array\r\n\tcheck space_id, String\r\n\tcheck ins_id, String\r\n\r\n\tskip_users = Meteor.settings.remind?.skip_users || []\r\n\tsend_users = []\r\n\t_.each users_id, (uid) ->\r\n\t\tif not skip_users.includes(uid)\r\n\t\t\tsend_users.push(uid)\r\n\r\n\tname = if ins_name.length > 15 then ins_name.substr(0,12) + '...' else ins_name\r\n\r\n\tdb.users.find({_id: {$in: _.uniq(send_users)}, mobile: {$exists: true}}, {fields: {mobile: 1, utcOffset: 1, locale: 1, name: 1}}).forEach (user)->\r\n\t\tutcOffset = if user.hasOwnProperty('utcOffset') then user.utcOffset else 8\r\n\t\tparams = {\r\n\t\t\tinstance_name: name,\r\n\t\t\tdeadline: moment(deadline).utcOffset(utcOffset).format('MM-DD HH:mm')\r\n\t\t}\r\n\t\t#设置当前语言环境\r\n\t\tlang = 'en'\r\n\t\tif user.locale is 'zh-cn'\r\n\t\t\tlang = 'zh-CN'\r\n\t\t# 发送手机短信\r\n\t\tSMSQueue.send({\r\n\t\t\tFormat: 'JSON',\r\n\t\t\tAction: 'SingleSendSms',\r\n\t\t\tParamString: JSON.stringify(params),\r\n\t\t\tRecNum: user.mobile,\r\n\t\t\tSignName: 'OA系统',\r\n\t\t\tTemplateCode: 'SMS_67200967',\r\n\t\t\tmsg: TAPi18n.__('sms.remind.template', {instance_name: ins_name, deadline: params.deadline, open_app_url: Meteor.absoluteUrl()+\"workflow.html?space_id=#{space_id}&ins_id=#{ins_id}\"}, lang)\r\n\t\t})\r\n\r\n\t\t# 发推送消息\r\n\t\tnotification = new Object\r\n\t\tnotification[\"createdAt\"] = new Date\r\n\t\tnotification[\"createdBy\"] = '<SERVER>'\r\n\t\tnotification[\"from\"] = 'workflow'\r\n\t\tnotification['title'] = user.name\r\n\t\tnotification['text'] = TAPi18n.__('instance.push.body.remind', {instance_name: ins_name, deadline: params.deadline}, lang)\r\n\r\n\t\tpayload = new Object\r\n\t\tpayload[\"space\"] = space_id\r\n\t\tpayload[\"instance\"] = ins_id\r\n\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1)\r\n\t\tpayload[\"requireInteraction\"] = true\r\n\t\tnotification[\"payload\"] = payload\r\n\t\tnotification['query'] = { userId: user._id, appName: 'workflow' }\r\n\r\n\t\tPush.send(notification)\r\n\r\n\r\n# 如果申请单的名字变了，正文的名字要跟申请单名字保持同步\r\nuuflowManager.checkMainAttach = (instance_id, name) ->\r\n\tmain = cfs.instances.findOne({ 'metadata.instance': instance_id, 'metadata.main': true, 'metadata.current': true })\r\n\tif main\r\n\t\tins = db.instances.findOne({ _id: instance_id }, { fields: { name: 1 } })\r\n\t\tnew_ins_name = name || ins.name\r\n\r\n\t\tnew_ins_name = new_ins_name.replace(/\\r/g, \"\").replace(/\\n/g, \"\")\r\n\r\n\t\t#文件名中不能包含特殊字符: '? * : \" < > \\ / |'， 直接替换为空\r\n\t\tnew_ins_name = new_ins_name.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\")\r\n\r\n\t\tmain_name_split = main.name().split('.')\r\n\t\tmain_name_split.pop()\r\n\t\tif new_ins_name isnt main_name_split.join(\"\")\r\n\t\t\tfile_name = new_ins_name + \".\" + main.extension()\r\n\t\t\tmain.update({ $set: { 'original.name': file_name, 'copies.instances.name': file_name } })\r\n\r\nuuflowManager.caculateKeywords = (values, form, form_version) ->\r\n\tif _.isEmpty(values)\r\n\t\treturn \"\"\r\n\r\n\tkeywords = []\r\n\tform_v = null\r\n\tif form_version is form.current._id\r\n\t\tform_v = form.current\r\n\telse\r\n\t\tform_v = _.find(form.historys, (form_h) ->\r\n\t\t\treturn form_version is form_h._id\r\n\t\t)\r\n\r\n\t_.each form_v.fields, (field) ->\r\n\t\tif field.is_searchable\r\n\t\t\tif field.type == 'input' or field.type == 'email' or field.type == 'url' or field.type == 'number' or field.type == 'select' or field.type == 'radio'\r\n\t\t\t\tif values[field.code]\r\n\t\t\t\t\tkeywords.push values[field.code]\r\n\t\t\t# multiSelect\r\n\t\t\telse if field.type == 'multiSelect'\r\n\t\t\t\tif values[field.code]\r\n\t\t\t\t\tkeywords.push values[field.code]\r\n\t\t\t# 选人选组控件 取name\r\n\t\t\telse if field.type == 'user' or field.type == 'group'\r\n\t\t\t\t# 多选\r\n\t\t\t\tif field.is_multiselect == true\r\n\t\t\t\t\tmultiValue = values[field.code]\r\n\t\t\t\t\tif _.isArray(multiValue)\r\n\t\t\t\t\t\t_.each multiValue, (singleV) ->\r\n\t\t\t\t\t\t\tif singleV and singleV['name']\r\n\t\t\t\t\t\t\t\tkeywords.push singleV['name']\r\n\t\t\t\t# 单选\r\n\t\t\t\telse\r\n\t\t\t\t\tif values[field.code] and values[field.code]['name']\r\n\t\t\t\t\t\tkeywords.push values[field.code]['name']\r\n\t\t# 子表\r\n\t\telse if field.type == 'table'\r\n\t\t\tif values[field.code]\r\n\t\t\t\t_.each values[field.code], (s_value) ->\r\n\t\t\t\t\t_.each field.fields, (s_field) ->\r\n\t\t\t\t\t\tif s_field.is_searchable\r\n\t\t\t\t\t\t\tif s_field.type == 'input' or s_field.type == 'email' or s_field.type == 'url' or s_field.type == 'number' or s_field.type == 'select' or s_field.type == 'radio'\r\n\t\t\t\t\t\t\t\tif s_value[s_field.code]\r\n\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]\r\n\t\t\t\t\t\t\t# multiSelect\r\n\t\t\t\t\t\t\telse if s_field.type == 'multiSelect'\r\n\t\t\t\t\t\t\t\tif s_value[s_field.code]\r\n\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]\r\n\t\t\t\t\t\t\t# 选人选组控件 取name\r\n\t\t\t\t\t\t\telse if s_field.type is 'user' or s_field.type is 'group'\r\n\t\t\t\t\t\t\t\t# 多选\r\n\t\t\t\t\t\t\t\tif s_field.is_multiselect == true\r\n\t\t\t\t\t\t\t\t\tmultiValue = s_value[s_field.code]\r\n\t\t\t\t\t\t\t\t\tif _.isArray(multiValue)\r\n\t\t\t\t\t\t\t\t\t\t_.each multiValue, (singleV) ->\r\n\t\t\t\t\t\t\t\t\t\t\tif singleV and singleV['name']\r\n\t\t\t\t\t\t\t\t\t\t\t\tkeywords.push singleV['name']\r\n\t\t\t\t\t\t\t\t# 单选\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tif s_value[s_field.code] and s_value[s_field.code]['name']\r\n\t\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]['name']\r\n\t\t# 分组\r\n\t\telse if field.type == 'section'\r\n\t\t\t_.each field.fields, (s_field) ->\r\n\t\t\t\tif s_field.is_searchable\r\n\t\t\t\t\tif s_field.type == 'input' or s_field.type == 'email' or s_field.type == 'url' or s_field.type == 'number' or s_field.type == 'select' or s_field.type == 'radio'\r\n\t\t\t\t\t\tif values[s_field.code]\r\n\t\t\t\t\t\t\tkeywords.push values[s_field.code]\r\n\t\t\t\t\t# multiSelect\r\n\t\t\t\t\telse if s_field.type == 'multiSelect'\r\n\t\t\t\t\t\tif values[s_field.code]\r\n\t\t\t\t\t\t\tkeywords.push values[s_field.code]\r\n\t\t\t\t\t# 选人选组控件 取name\r\n\t\t\t\t\telse if s_field.type is 'user' or s_field.type is 'group'\r\n\t\t\t\t\t\t# 多选\r\n\t\t\t\t\t\tif s_field.is_multiselect == true\r\n\t\t\t\t\t\t\tmultiValue = values[s_field.code]\r\n\t\t\t\t\t\t\tif _.isArray(multiValue)\r\n\t\t\t\t\t\t\t\t_.each multiValue, (singleV) ->\r\n\t\t\t\t\t\t\t\t\tif singleV and singleV['name']\r\n\t\t\t\t\t\t\t\t\t\tkeywords.push singleV['name']\r\n\t\t\t\t\t\t# 单选\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tif values[s_field.code] and values[s_field.code]['name']\r\n\t\t\t\t\t\t\t\tkeywords.push values[s_field.code]['name']\r\n\r\n\treturn keywords.join(\" \")\r\n\r\nuuflowManager.checkValueFieldsRequire = (values, form, form_version) ->\r\n\tvalues = values || {}\r\n\r\n\trequire_but_empty_fields = []\r\n\r\n\tform_v = null\r\n\tif form_version is form.current._id\r\n\t\tform_v = form.current\r\n\telse\r\n\t\tform_v = _.find(form.historys, (form_h) ->\r\n\t\t\treturn form_version is form_h._id\r\n\t\t)\r\n\r\n\t_.each form_v.fields, (field) ->\r\n\t\tif field.type != 'table'\r\n\t\t\tif field.is_required and _.isEmpty(values[field.code])\r\n\t\t\t\trequire_but_empty_fields.push field.name || field.code\r\n\r\n\t\t# 子表\r\n\t\telse if field.type == 'table'\r\n\t\t\tif _.isEmpty(values[field.code])\r\n\t\t\t\t_.each field.fields, (s_field) ->\r\n\t\t\t\t\tif s_field.is_required\r\n\t\t\t\t\t\trequire_but_empty_fields.push s_field.name || s_field.code\r\n\t\t\telse\r\n\t\t\t\t_.each values[field.code], (s_value) ->\r\n\t\t\t\t\t_.each field.fields, (s_field) ->\r\n\t\t\t\t\t\tif s_field.is_required and _.isEmpty(s_value[s_field.code])\r\n\t\t\t\t\t\t\trequire_but_empty_fields.push s_field.name || s_field.code\r\n\r\n\treturn require_but_empty_fields\r\n\r\nuuflowManager.triggerRecordInstanceQueue = (ins_id, record_ids, step_name) ->\r\n\r\n\tif Meteor.settings.cron?.instancerecordqueue_interval\r\n\r\n\t\tnewObj = {\r\n\t\t\tinfo: {\r\n\t\t\t\tinstance_id: ins_id\r\n\t\t\t\trecords: record_ids\r\n\t\t\t\tstep_name: step_name\r\n\t\t\t\tinstance_finish_date: new Date()\r\n\t\t\t}\r\n\t\t\tsent: false\r\n\t\t\tsending: 0\r\n\t\t\tcreatedAt: new Date()\r\n\t\t\tcreatedBy: '<SERVER>'\r\n\t\t}\r\n\r\n\t\tdb.instance_record_queue.insert(newObj)\r\n\r\n\treturn\r\n\r\nuuflowManager.distributedInstancesRemind = (instance) ->\r\n\t# 确定是分发过来的\r\n\tif instance?.distribute_from_instances?.length>0\r\n\t\tflow = db.flows.findOne( { _id: instance?.flow } )\r\n\t\tcurrent_trace = instance[\"traces\"].pop()\r\n\t\tif instance?.state == \"draft\"\r\n\t\t\tnext_approves = current_trace?.approves\r\n\t\t\tif next_approves?.length == 1\r\n\t\t\t\tnext_step = next_approves[0]?.next_steps[0]\r\n\t\t\t\tnext_step_id = next_step?.step\r\n\t\telse\r\n\t\t\tnext_step_id = current_trace?.step\r\n\t\tif next_step_id\r\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\r\n\t\t\tif next_step?.step_type == \"end\"\r\n\t\t\t\t# 查原申请单\r\n\t\t\t\toriginal_instacne_id = instance?.distribute_from_instances?.pop()\r\n\t\t\t\t# original_instacne_id = \"X6whjGMLNvxDnFwSe\" # 定死\r\n\t\t\t\toriginal_instacne = db.instances.findOne(\r\n\t\t\t\t\t{ _id: original_instacne_id },\r\n\t\t\t\t\t{ fields: { flow: 1, name: 1,space: 1,created_by: 1 } }\r\n\t\t\t\t\t)\r\n\t\t\t\t# 根据原申请单查流程\r\n\t\t\t\toriginal_flow = db.flows.findOne(\r\n\t\t\t\t\t{ _id: original_instacne?.flow },\r\n\t\t\t\t\t{ fields: { distribute_end_notification: 1 } }\r\n\t\t\t\t\t)\r\n\r\n\t\t\t\tif original_flow?.distribute_end_notification==true\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\t# 分发提醒，这个表单的created_by\r\n\t\t\t\t\t\toriginal_user = db.users.findOne({_id: instance?.created_by})\r\n\r\n\t\t\t\t\t\t#设置当前语言环境\r\n\t\t\t\t\t\tlang = 'en'\r\n\t\t\t\t\t\tif original_user?.locale is 'zh-cn'\r\n\t\t\t\t\t\t\tlang = 'zh-CN'\r\n\t\t\t\t\t\t# 发推送消息\r\n\t\t\t\t\t\tnotification = new Object\r\n\t\t\t\t\t\tnotification[\"createdAt\"] = new Date\r\n\t\t\t\t\t\tnotification[\"createdBy\"] = '<SERVER>'\r\n\t\t\t\t\t\tnotification[\"from\"] = 'workflow'\r\n\t\t\t\t\t\tnotification['title'] = original_user.name\r\n\t\t\t\t\t\tnotification['text'] = TAPi18n.__('instance.push.body.distribute_remind', {instance_name: instance?.name}, lang)\r\n\r\n\t\t\t\t\t\tpayload = new Object\r\n\t\t\t\t\t\tpayload[\"space\"] = original_instacne?.space\r\n\t\t\t\t\t\tpayload[\"instance\"] = original_instacne?._id\r\n\t\t\t\t\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1)\r\n\t\t\t\t\t\tpayload[\"requireInteraction\"] = true\r\n\t\t\t\t\t\tnotification[\"payload\"] = payload\r\n\t\t\t\t\t\tnotification['query'] = { userId: original_user._id, appName: 'workflow' }\r\n\r\n\r\n\t\t\t\t\t\tPush.send(notification)\r\n\t\t\t\t\tcatch e\r\n\t\t\t\t\t\tconsole.error e.stack\r\n\treturn\r\n\r\nuuflowManager.getAgent = (spaceId, fromId)->\r\n\tnow = new Date()\r\n\tr = db.process_delegation_rules.findOne({ space: spaceId, from: fromId, enabled: true, start_time: { $lte: now }, end_time: { $gte: now } })\r\n\treturn r?.to\r\n\r\nuuflowManager.cancelProcessDelegation = (spaceId, toId)->\r\n\tquery = { space: spaceId, inbox_users: toId }\r\n\tquery.traces = { $elemMatch: { is_finished: false, approves: { $elemMatch: { is_finished: false, agent: toId } } } }\r\n\tdb.instances.find(query, { fields: { inbox_users: 1, traces: 1, state: 1 } }).forEach (ins)->\r\n\t\ttrace = _.find ins.traces, (t)->\r\n\t\t\treturn t.is_finished is false\r\n\r\n\t\t_.each trace.approves, (a, idx)->\r\n\t\t\tif a.is_finished is false\r\n\t\t\t\tif a.agent is toId\r\n\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user)\r\n\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\tidxStr = \"traces.$.approves.#{idx}.\"\r\n\t\t\t\t\tsetObj = {}\r\n\t\t\t\t\tsetObj[idxStr + 'handler'] = a.user\r\n\t\t\t\t\tsetObj[idxStr + 'handler_name'] = a.user_name\r\n\t\t\t\t\tsetObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\tsetObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\tsetObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\tsetObj[idxStr + 'agent'] = null\r\n\t\t\t\t\tins.inbox_users.splice(ins.inbox_users.indexOf(toId), 1, a.user)\r\n\t\t\t\t\tsetObj.inbox_users = ins.inbox_users\r\n\r\n\t\t\t\t\t# 如果是分发还需要修改提交人信息\r\n\t\t\t\t\tif ins.state is 'draft'\r\n\t\t\t\t\t\tsetObj.submitter = a.user\r\n\t\t\t\t\t\tsetObj.submitter_name = a.user_name\r\n\r\n\t\t\t\t\tdb.instances.update({ _id: ins._id, inbox_users: toId, 'traces._id': a.trace }, { $set: setObj })\r\n\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', a.user)\r\n\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', toId)\r\n\t\t\t\telse if a.user is toId\r\n\t\t\t\t\tdb.instances.update({ _id: ins._id }, { $addToSet: { inbox_users: toId } })\r\n\r\n\tccQuery = { space: spaceId, cc_users: toId }\r\n\tccQuery['traces.approves'] = { $elemMatch: { is_finished: false, agent: toId, type: 'cc' } }\r\n\tdb.instances.find(ccQuery, { fields: { cc_users: 1, traces: 1 } }).forEach (ins)->\r\n\t\t_.each ins.traces, (t)->\r\n\t\t\t_.each t.approves, (a, idx)->\r\n\t\t\t\tif a.is_finished is false and a.type is 'cc'\r\n\t\t\t\t\tif a.agent is toId\r\n\t\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user)\r\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\r\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\r\n\t\t\t\t\t\tidxStr = \"traces.$.approves.#{idx}.\"\r\n\t\t\t\t\t\tsetObj = {}\r\n\t\t\t\t\t\tsetObj[idxStr + 'handler'] = a.user\r\n\t\t\t\t\t\tsetObj[idxStr + 'handler_name'] = a.user_name\r\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"]\r\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"]\r\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"]\r\n\t\t\t\t\t\tsetObj[idxStr + 'agent'] = null\r\n\t\t\t\t\t\tins.cc_users.splice(ins.cc_users.indexOf(toId), 1, a.user)\r\n\t\t\t\t\t\tsetObj.cc_users = ins.cc_users\r\n\r\n\t\t\t\t\t\tdb.instances.update({ _id: ins._id, cc_users: toId, 'traces._id': a.trace }, { $set: setObj })\r\n\r\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', a.user)\r\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', toId)\r\n\t\t\t\t\telse if a.user is toId\r\n\t\t\t\t\t\tdb.instances.update({ _id: ins._id }, { $addToSet: { cc_users: toId } })\r\n\r\n\r\nuuflowManager.timeoutAutoSubmit = (ins_id)->\r\n\tquery = {}\r\n\tif ins_id\r\n\t\tcheck ins_id, String\r\n\t\tquery._id = ins_id\r\n\r\n\tquery.state = 'pending'\r\n\tquery.current_step_auto_submit = true\r\n\tquery.traces = { $elemMatch: { is_finished: false, due_date: { $lte: new Date } } }\r\n\r\n\tdb.instances.find(query).forEach (ins)->\r\n\t\ttry\r\n\t\t\tflow_id = ins.flow\r\n\t\t\tinstance_id = ins._id\r\n\t\t\ttrace = _.last ins.traces\r\n\t\t\tflow = uuflowManager.getFlow(flow_id)\r\n\t\t\tstep = uuflowManager.getStep(ins, flow, trace.step)\r\n\t\t\tstep_type = step.step_type\r\n\t\t\ttoLine = _.find step.lines, (l)->\r\n\t\t\t\treturn l.timeout_line == true\r\n\t\t\tnextStepId = toLine.to_step\r\n\t\t\tnextStep = uuflowManager.getStep(ins, flow, nextStepId)\r\n\t\t\tif nextStep.step_type == 'condition'\r\n\t\t\t\tnextSteps = uuflowManager.getNextSteps(ins, flow, nextStep, \"\")\r\n\t\t\t\tconsole.error nextSteps\r\n\t\t\t\tnextStepId = nextSteps[0]\r\n\r\n\t\t\tnextUserIds = getHandlersManager.getHandlers(instance_id, nextStepId)\r\n\r\n\t\t\tjudge = \"submitted\"\r\n\t\t\tif step_type is \"sign\"\r\n\t\t\t\tjudge = \"approved\"\r\n\r\n\t\t\tapprove_from_client = {\r\n\t\t\t\t'instance': instance_id\r\n\t\t\t\t'trace': trace._id\r\n\t\t\t\t'judge': judge\r\n\t\t\t\t'next_steps': [{ 'step': nextStepId, 'users': nextUserIds }]\r\n\t\t\t}\r\n\t\t\t_.each trace.approves, (a)->\r\n\t\t\t\tapprove_from_client._id = a._id\r\n\t\t\t\tcurrent_user_info = db.users.findOne(a.handler, { services: 0 })\r\n\t\t\t\tupdatedInstance = uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user_info._id, true)\r\n\r\n\t\t\t\t# 满足超时自动提交条件后，则将申请单提交至下一步骤，并发送提示给当前步骤处理人\r\n\t\t\t\tpushManager.send_instance_notification(\"auto_submit_pending_inbox\", updatedInstance, \"\", current_user_info)\r\n\r\n\t\tcatch e\r\n\t\t\tconsole.error 'AUTO TIMEOUT_AUTO_SUBMIT ERROR: '\r\n\t\t\tconsole.error e.stack\r\n\r\n\r\n\treturn true","var Cookies;               \n\nCookies = require(\"cookies\");\n\nuuflowManager = {};\n\nuuflowManager.check_authorization = function(req, res) {\n  var authToken, cookies, hashedToken, query, user, userId;\n  query = req.query;\n  userId = query[\"X-User-Id\"];\n  authToken = query[\"X-Auth-Token\"];\n  if (!userId || !authToken) {\n    cookies = new Cookies(req, res);\n    userId = cookies.get(\"X-User-Id\");\n    authToken = cookies.get(\"X-Auth-Token\");\n  }\n  if (!userId || !authToken) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  hashedToken = Accounts._hashLoginToken(authToken);\n  user = Meteor.users.findOne({\n    _id: userId,\n    \"services.resume.loginTokens.hashedToken\": hashedToken\n  });\n  if (!user) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  return user;\n};\n\nuuflowManager.getInstance = function(instance_id) {\n  var ins;\n  ins = db.instances.findOne(instance_id);\n  if (!ins) {\n    throw new Meteor.Error('error!', \"申请单ID：\" + instance_id + \"有误或此申请单已经被删除\");\n  }\n  return ins;\n};\n\nuuflowManager.getSpace = function(space_id) {\n  var space;\n  space = db.spaces.findOne(space_id);\n  if (!space) {\n    throw new Meteor.Error('error!', \"space_id有误或此space已经被删除\");\n  }\n  return space;\n};\n\nuuflowManager.getSpaceUser = function(space_id, user_id) {\n  var space_user;\n  space_user = db.space_users.findOne({\n    space: space_id,\n    user: user_id\n  });\n  if (!space_user) {\n    throw new Meteor.Error('error!', \"user_id对应的用户不属于当前space\");\n  }\n  return space_user;\n};\n\nuuflowManager.getFlow = function(flow_id) {\n  var flow;\n  flow = db.flows.findOne(flow_id);\n  if (!flow) {\n    throw new Meteor.Error('error!', \"id有误或此流程已经被删除\");\n  }\n  return flow;\n};\n\nuuflowManager.getSpaceUserOrgInfo = function(space_user) {\n  var info, org;\n  info = new Object;\n  info.organization = space_user.organization;\n  org = db.organizations.findOne(space_user.organization, {\n    fields: {\n      name: 1,\n      fullname: 1\n    }\n  });\n  info.organization_name = org.name;\n  info.organization_fullname = org.fullname;\n  return info;\n};\n\nuuflowManager.getTrace = function(instance, trace_id) {\n  var trace;\n  trace = _.find(instance.traces, function(t) {\n    return t._id === trace_id;\n  });\n  if (!trace) {\n    throw new Meteor.Error('error!', \"trace_id有误\");\n  }\n  return trace;\n};\n\nuuflowManager.getApprove = function(trace, approve_id) {\n  var approve;\n  approve = _.find(trace.approves, function(t) {\n    return t._id === approve_id;\n  });\n  if (!approve) {\n    throw new Meteor.Error('error!', \"trace_id有误\");\n  }\n  return approve;\n};\n\nuuflowManager.isTraceNotFinished = function(trace) {\n  if (trace.is_finished !== false) {\n    throw new Meteor.Error('error!', \"可能已有人对此文件做了处理。请点击已审核，查看文件的最新状态\");\n  }\n};\n\nuuflowManager.isApproveNotFinished = function(approve) {\n  if (approve.is_finished !== false) {\n    throw new Meteor.Error('error!', \"当前步骤不为未完成状态,不能进行此操作\");\n  }\n};\n\nuuflowManager.isInstancePending = function(instance, lang) {\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  if (instance.state !== \"pending\") {\n    throw new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang));\n  }\n};\n\nuuflowManager.isHandlerOrAgent = function(approve, user_id) {\n  if (approve.user !== user_id && approve.agent !== user_id) {\n    throw new Meteor.Error('error!', \"不是当前步骤对应的处理人或其代理人，不能进行此操作\");\n  }\n};\n\nuuflowManager.isInstanceDraft = function(instance, lang) {\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  if (instance.state !== \"draft\") {\n    throw new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang));\n  }\n};\n\nuuflowManager.isInstanceSubmitter = function(instance, current_user_id) {\n  if (instance.submitter !== current_user_id) {\n    throw new Meteor.Error('error!', '当前用户不是申请单对应的提交人,不能进行此操作');\n  }\n};\n\nuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin = function(instance, current_user_id, space) {\n  if (instance.submitter !== current_user_id && instance.applicant !== current_user_id && !space.admins.includes(current_user_id)) {\n    throw new Meteor.Error('error!', \"当前用户不是申请单对应的提交人或申请人或工作区管理员\");\n  }\n};\n\nuuflowManager.getStep = function(instance, flow, step_id) {\n  var flow_rev, isExistStep;\n  flow_rev = instance.flow_version;\n  isExistStep = null;\n  if (flow.current._id === flow_rev) {\n    isExistStep = _.find(flow.current.steps, function(step) {\n      return step._id === step_id;\n    });\n  } else {\n    _.each(flow.historys, function(history) {\n      if (history._id === flow_rev) {\n        return isExistStep = _.find(history.steps, function(step) {\n          return step._id === step_id;\n        });\n      }\n    });\n  }\n  if (!isExistStep) {\n    throw new Meteor.Error('error!', \"不能获取step\");\n  }\n  return isExistStep;\n};\n\nuuflowManager.isJudgeLegal = function(judge) {\n  if (judge !== \"approved\" && judge !== \"rejected\" && judge !== \"readed\" && judge !== \"submitted\") {\n    throw new Meteor.Error('error!', \"judge有误\");\n  }\n};\n\nuuflowManager.isSpaceAdmin = function(space_id, user_id) {\n  var space;\n  space = db.spaces.findOne({\n    _id: space_id\n  }, {\n    fields: {\n      admins: 1\n    }\n  });\n  if (!space.admins.includes(user_id)) {\n    throw new Meteor.Error('error!', \"当前用户不是工作区管理员,不能进行此操作\");\n  }\n};\n\nuuflowManager.getUser = function(user_id) {\n  var user;\n  user = db.users.findOne(user_id);\n  if (!user) {\n    throw new Meteor.Error('error!', \"用户ID有误或此用户已经被删除\");\n  }\n  return user;\n};\n\nuuflowManager.getUserOrganization = function(user_id, space_id) {\n  var org;\n  org = db.organizations.findOne({\n    space: space_id,\n    users: user_id\n  });\n  return org;\n};\n\nuuflowManager.getUserRoles = function(user_id, space_id) {\n  var positions, role_names;\n  role_names = new Array;\n  positions = db.flow_positions.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      role: 1\n    }\n  }).fetch();\n  _.each(positions, function(position) {\n    var role;\n    role = db.flow_roles.findOne({\n      _id: position.role\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    if (role) {\n      return role_names.push(role.name);\n    }\n  });\n  return role_names;\n};\n\nuuflowManager.isFlowEnabled = function(flow) {\n  if (flow.state !== \"enabled\") {\n    throw new Meteor.Error('error!', \"流程未启用,操作失败\");\n  }\n};\n\nuuflowManager.isFlowSpaceMatched = function(flow, space_id) {\n  if (flow.space !== space_id) {\n    throw new Meteor.Error('error!', \"流程和工作区ID不匹配\");\n  }\n};\n\nuuflowManager.calculateCondition = function(values, condition_str) {\n  var __values, average, count, e, max, min, sum;\n  try {\n    __values = values;\n    sum = function(subform_field) {\n      var sum_field_value;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sum_field_value = 0;\n      _.each(subform_field, function(field_value) {\n        field_value = Number(String(field_value));\n        return sum_field_value += field_value;\n      });\n      return sum_field_value;\n    };\n    average = function(subform_field) {\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      return sum(subform_field) / count(subform_field);\n    };\n    count = function(subform_field) {\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      return subform_field.length;\n    };\n    max = function(subform_field) {\n      var sub_field;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sub_field = new Array;\n      _.each(subform_field, function(field_value) {\n        return sub_field.push(Number(String(field_value)));\n      });\n      return _.max(sub_field);\n    };\n    min = function(subform_field) {\n      var sub_field;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sub_field = new Array;\n      _.each(subform_field, function(field_value) {\n        return sub_field.push(Number(String(field_value)));\n      });\n      return _.min(sub_field);\n    };\n    return eval(condition_str);\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return false;\n  }\n};\n\nuuflowManager.setFormFieldVariable = function(fields, __values, space_id) {\n  var e;\n  try {\n    return _.each(fields, function(field) {\n      var _subform_values, group_fullname, group_id, group_name, organization, organization_selectuser, role_selectuser, subform_fields_all, user_id, user_name, user_roles;\n      if (field.type === \"table\") {\n        subform_fields_all = field.fields;\n        _subform_values = new Object;\n        return _.each(subform_fields_all, function(current_field) {\n          var values_arr;\n          values_arr = new Array;\n          if ([\"number\", \"percentage\", \"currency\"].includes(current_field[\"type\"])) {\n            _.each(__values[field.code], function(sub_field) {\n              return values_arr.push(sub_field[current_field[\"code\"]]);\n            });\n          } else if (current_field[\"type\"] === \"checkbox\") {\n            _.each(__values[field.code], function(sub_field) {\n              if (sub_field[current_field[\"code\"]] === \"true\") {\n                return values_arr.push(true);\n              } else if (sub_field[current_field[\"code\"]] === \"false\") {\n                return values_arr.push(false);\n              }\n            });\n          } else {\n            _.each(__values[field.code], function(sub_field) {\n              if (sub_field[current_field[\"code\"]]) {\n                return values_arr.push(sub_field[current_field[\"code\"]]);\n              } else {\n                return values_arr.push(\"\");\n              }\n            });\n          }\n          return __values[current_field[\"code\"]] = values_arr;\n        });\n      } else if (field.type === \"group\") {\n        if (field.is_multiselect) {\n          if (__values[field.code] && __values[field.code].length > 0) {\n            group_id = new Array;\n            group_name = new Array;\n            group_fullname = new Array;\n            _.each(__values[field.code], function(group) {\n              group_id.push(group[\"id\"]);\n              group_name.push(group[\"name\"]);\n              return group_fullname.push(group[\"fullname\"]);\n            });\n            __values[field.code] = new Object;\n            __values[field.code][\"id\"] = group_id;\n            __values[field.code][\"name\"] = group_name;\n            return __values[field.code][\"fullname\"] = group_fullname;\n          }\n        }\n      } else if (field.type === \"user\") {\n        if (field.is_multiselect) {\n          if (__values[field.code] && __values[field.code].length > 0) {\n            user_id = new Array;\n            user_name = new Array;\n            organization = new Object;\n            organization[\"user_organization_fullname\"] = new Array;\n            organization[\"user_organization_name\"] = new Array;\n            user_roles = new Array;\n            _.each(__values[field.code], function(select_user) {\n              var organization_selectuser, role_selectuser;\n              user_id.push(select_user[\"id\"]);\n              user_name.push(select_user[\"name\"]);\n              organization_selectuser = uuflowManager.getUserOrganization(select_user[\"id\"], space_id);\n              role_selectuser = uuflowManager.getUserRoles(select_user[\"id\"], space_id);\n              if (organization_selectuser) {\n                organization[\"user_organization_fullname\"].push(organization_selectuser.fullname);\n                organization[\"user_organization_name\"].push(organization_selectuser.name);\n              }\n              if (role_selectuser) {\n                return user_roles = user_roles || role_selectuser;\n              }\n            });\n            __values[field.code] = new Object;\n            __values[field.code][\"id\"] = user_id;\n            __values[field.code][\"name\"] = user_name;\n            __values[field.code][\"organization\"] = organization;\n            return __values[field.code][\"roles\"] = roles;\n          }\n        } else {\n          if (__values[field.code]) {\n            organization_selectuser = uuflowManager.getUserOrganization(__values[field.code][\"id\"], space_id);\n            role_selectuser = uuflowManager.getUserRoles(__values[field.code][\"id\"], space_id);\n            if (organization_selectuser) {\n              __values[field.code][\"organization\"] = new Object;\n              __values[field.code][\"organization\"][\"fullname\"] = organization_selectuser.fullname;\n              __values[field.code][\"organization\"][\"name\"] = organization_selectuser.name;\n            }\n            return __values[field.code][\"roles\"] = role_selectuser;\n          }\n        }\n      } else if ([\"number\", \"percentage\", \"currency\"].includes(field.type)) {\n        if (__values[field.code]) {\n          return __values[field.code] = Number(__values[field.code]);\n        } else {\n          return __values[field.code] = 0;\n        }\n      } else if (field.type === \"checkbox\") {\n        if (__values[field.code] === \"true\") {\n          return __values[field.code] = true;\n        } else if (__values[field.code] === \"false\") {\n          return __values[field.code] = false;\n        }\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\nuuflowManager.getNextSteps = function(instance, flow, step, judge) {\n  var __values, applicant_name, applicant_organization_fullname, applicant_organization_name, applicant_roles, approver_name, approver_organization_fullname, approver_organization_name, approver_roles, current_approve, flowVersions, flow_steps, form, formVersion, lines, nextSteps, prefix, reg, rejectedSteps, start_approve, step_type, submitter_name, submitter_organization_fullname, submitter_organization_name, submitter_roles, trace_steps, traces, version_steps;\n  step_type = step.step_type;\n  nextSteps = new Array;\n  if (step_type === \"condition\") {\n    __values = uuflowManager.getUpdatedValues(instance);\n    current_approve = null;\n    traces = instance.traces;\n    _.each(traces, function(trace) {\n      if (trace.is_finished === false) {\n        return current_approve = trace.approves[0];\n      }\n    });\n    start_approve = null;\n    _.each(traces, function(trace) {\n      if (!trace.previous_trace_ids || trace.previous_trace_ids.length === 0) {\n        return start_approve = trace.approves[0];\n      }\n    });\n    applicant_organization_fullname = instance.applicant_organization_fullname;\n    applicant_organization_name = instance.applicant_organization_name;\n    applicant_roles = uuflowManager.getUserRoles(instance.applicant, instance.space);\n    applicant_name = instance.applicant_name;\n    submitter_organization_fullname = start_approve.handler_organization_fullname;\n    submitter_organization_name = start_approve.handler_organization_name;\n    submitter_roles = uuflowManager.getUserRoles(start_approve.handler, instance.space);\n    submitter_name = start_approve.handler_name;\n    approver_organization_fullname = current_approve.handler_organization_fullname;\n    approver_organization_name = current_approve.handler_organization_name;\n    approver_roles = uuflowManager.getUserRoles(current_approve.handler, instance.space);\n    approver_name = current_approve.handler_name;\n    __values[\"applicant\"] = new Object;\n    __values[\"applicant\"][\"roles\"] = applicant_roles;\n    __values[\"applicant\"][\"name\"] = applicant_name;\n    __values[\"applicant\"][\"organization\"] = new Object;\n    __values[\"applicant\"][\"organization\"][\"fullname\"] = applicant_organization_fullname;\n    __values[\"applicant\"][\"organization\"][\"name\"] = applicant_organization_name;\n    __values[\"submitter\"] = new Object;\n    __values[\"submitter\"][\"roles\"] = submitter_roles;\n    __values[\"submitter\"][\"name\"] = submitter_name;\n    __values[\"submitter\"][\"organization\"] = new Object;\n    __values[\"submitter\"][\"organization\"][\"fullname\"] = submitter_organization_fullname;\n    __values[\"submitter\"][\"organization\"][\"name\"] = submitter_organization_name;\n    __values[\"approver\"] = new Object;\n    __values[\"approver\"][\"roles\"] = approver_roles;\n    __values[\"approver\"][\"name\"] = approver_name;\n    __values[\"approver\"][\"organization\"] = new Object;\n    __values[\"approver\"][\"organization\"][\"fullname\"] = approver_organization_fullname;\n    __values[\"approver\"][\"organization\"][\"name\"] = approver_organization_name;\n    form = db.forms.findOne(instance.form);\n    formVersion = null;\n    if (instance.form_version === form.current._id) {\n      formVersion = form.current;\n    } else {\n      formVersion = _.find(form.historys, function(history) {\n        return instance.form_version === history._id;\n      });\n    }\n    uuflowManager.setFormFieldVariable(formVersion.fields, __values, instance.space);\n    reg = /(\\{[^{}]*\\})/;\n    prefix = \"__values\";\n    _.each(step.lines, function(step_line) {\n      var step_line_condition;\n      step_line_condition = step_line.condition.replace(reg, function(vowel) {\n        return prefix + vowel.replace(/\\{\\s*/, \"[\\\"\").replace(/\\s*\\}/, \"\\\"]\").replace(/\\s*\\.\\s*/g, \"\\\"][\\\"\");\n      });\n      if (step_line.state === \"submitted\" && uuflowManager.calculateCondition(__values, step_line_condition)) {\n        if (step_line.state === \"submitted\") {\n          return nextSteps.push(step_line.to_step);\n        }\n      }\n    });\n  } else if (step_type === \"end\") {\n    return new Array;\n  } else if (step_type === \"submit\" || step_type === \"start\" || step_type === \"counterSign\") {\n    lines = _.filter(step.lines, function(line) {\n      return line.state === \"submitted\";\n    });\n    if (lines.length === 0) {\n      throw new Meteor.Error('error!', \"流程的连线配置有误\");\n    } else {\n      nextSteps = _.pluck(lines, 'to_step');\n    }\n  } else if (step_type === \"sign\") {\n    if (judge === \"approved\") {\n      lines = _.filter(step.lines, function(line) {\n        return line.state === \"approved\";\n      });\n      if (lines.length === 0) {\n        throw new Meteor.Error('error!', \"流程的连线配置有误\");\n      } else {\n        nextSteps = _.pluck(lines, 'to_step');\n      }\n    } else if (judge === \"rejected\") {\n      lines = _.filter(step.lines, function(line) {\n        return line.state === \"rejected\";\n      });\n      rejectedSteps = _.pluck(lines, 'to_step');\n      trace_steps = new Array;\n      _.each(instance.traces, function(trace) {\n        var flowVersions;\n        if (trace.is_finished === true) {\n          flowVersions = new Array;\n          flowVersions.push(flow.current);\n          if (flow.historys) {\n            flowVersions = flowVersions.concat(flow.historys);\n          }\n          return _.each(flowVersions, function(flowVer) {\n            if (flowVer._id === instance.flow_version) {\n              return _.each(flowVer.steps, function(flow_ver_step) {\n                if (flow_ver_step._id === trace.step && flow_ver_step.step_type !== \"condition\") {\n                  return trace_steps.push(trace.step);\n                }\n              });\n            }\n          });\n        }\n      });\n      flow_steps = new Array;\n      if (instance.flow_version === flow.current._id) {\n        _.each(flow.current.steps, function(flow_step) {\n          if (flow_step.step_type === \"start\" || flow_step.step_type === \"end\") {\n            return flow_steps.push(flow_step._id);\n          }\n        });\n      } else {\n        _.each(flow.historys, function(history) {\n          return _.each(history.steps, function(history_step) {\n            if (history_step.step_type === \"start\" || history_step.step_type === \"end\") {\n              return flow_steps.push(history_step._id);\n            }\n          });\n        });\n      }\n      nextSteps = _.union(rejectedSteps, trace_steps, flow_steps);\n    }\n  }\n  version_steps = new Object;\n  flowVersions = new Array;\n  flowVersions.push(flow.current);\n  if (flow.historys) {\n    flowVersions = flowVersions.concat(flow.historys);\n  }\n  _.each(flowVersions, function(flowVer) {\n    if (flowVer._id === instance.flow_version) {\n      return _.each(flowVer.steps, function(flow_ver_step) {\n        return version_steps[flow_ver_step._id] = flow_ver_step;\n      });\n    }\n  });\n  nextSteps = _.uniq(nextSteps);\n  _.each(nextSteps, function(next_step_id) {\n    var _next_step;\n    _next_step = version_steps[next_step_id];\n    if (_next_step.step_type === \"condition\") {\n      if (_next_step.lines) {\n        return _.each(_next_step.lines, function(line) {\n          if (line.to_step) {\n            return nextSteps.push(line.to_step);\n          }\n        });\n      }\n    }\n  });\n  nextSteps = _.uniq(nextSteps);\n  return nextSteps;\n};\n\nuuflowManager.getUpdatedValues = function(instance) {\n  var newest_values, trace_approve;\n  trace_approve = null;\n  _.each(instance.traces, function(trace) {\n    if (trace.is_finished === false) {\n      return trace_approve = _.find(trace.approves, function(approve) {\n        return approve.is_finished === false && approve.type !== 'cc' && approve.type !== 'distribute';\n      });\n    }\n  });\n  newest_values = null;\n  if (!instance.values) {\n    newest_values = trace_approve != null ? trace_approve.values : void 0;\n  } else if (!(trace_approve != null ? trace_approve.values : void 0)) {\n    newest_values = instance.values;\n  } else {\n    newest_values = _.extend(_.clone(instance.values), trace_approve.values);\n  }\n  return newest_values;\n};\n\nuuflowManager.getForm = function(form_id) {\n  var form;\n  form = db.forms.findOne(form_id);\n  if (!form) {\n    throw new Meteor.Error('error!', '表单ID有误或此表单已经被删除');\n  }\n  return form;\n};\n\nuuflowManager.getFormVersion = function(form, form_version) {\n  var form_v;\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  if (!form_v) {\n    throw new Meteor.Error('error!', '未找到表单对应的版本');\n  }\n  return form_v;\n};\n\nuuflowManager.getCategory = function(category_id) {\n  return db.categories.findOne(category_id);\n};\n\nuuflowManager.getInstanceName = function(instance, vals) {\n  var applicant, default_value, e, flow, form, form_id, form_v, form_version, iscript, name_forumla, rev, values;\n  values = _.clone(vals || instance.values) || {};\n  applicant = WorkflowManager.getFormulaUserObject(instance.space, instance.applicant);\n  values[\"applicant\"] = applicant;\n  values[\"applicant_name\"] = instance.applicant_name;\n  values[\"applicant_organization\"] = instance.applicant_organization;\n  values[\"applicant_organization_fullname\"] = instance.applicant_organization_fullname;\n  values[\"applicant_organization_name\"] = instance.applicant_organization_name;\n  values[\"submit_date\"] = moment(instance.submit_date).utcOffset(0, false).format(\"YYYY-MM-DD\");\n  form_id = instance.form;\n  flow = uuflowManager.getFlow(instance.flow);\n  default_value = flow.name + ' ' + instance.code;\n  form_version = instance.form_version;\n  form = uuflowManager.getForm(form_id);\n  form_v = uuflowManager.getFormVersion(form, form_version);\n  name_forumla = form_v.name_forumla;\n  rev = default_value;\n  if (name_forumla) {\n    if (name_forumla.indexOf(\"{applicant.\") > -1) {\n      iscript = name_forumla.replace(/\\{applicant./g, \"(applicant.\").replace(/\\}/g, \" || '')\");\n    }\n    iscript = name_forumla.replace(/\\{/g, \"(values.\").replace(/\\}/g, \" || '')\");\n    try {\n      rev = eval(iscript) || default_value;\n      rev = rev.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\");\n    } catch (error) {\n      e = error;\n      console.log(e);\n    }\n  }\n  return rev.trim();\n};\n\nuuflowManager.getApproveValues = function(approve_values, permissions, form_id, form_version) {\n  var form_v, instance_form;\n  if (permissions === null) {\n    approve_values = new Object;\n  } else {\n    instance_form = db.forms.findOne(form_id);\n    form_v = null;\n    if (form_version === instance_form.current._id) {\n      form_v = instance_form.current;\n    } else {\n      form_v = _.find(instance_form.historys, function(form_h) {\n        return form_version === form_h._id;\n      });\n    }\n    _.each(form_v.fields, function(field) {\n      if (field.type === \"table\") {\n\n      } else if (field.type === \"section\") {\n        return _.each(field.fields, function(sectionField) {\n          if (!sectionField.formula && (permissions[sectionField.code] === null || permissions[sectionField.code] !== \"editable\")) {\n            return delete approve_values[sectionField.code];\n          }\n        });\n      } else {\n        if (!field.formula && (permissions[field.code] === null || permissions[field.code] !== \"editable\")) {\n          return delete approve_values[field.code];\n        }\n      }\n    });\n  }\n  return approve_values;\n};\n\nuuflowManager.workflow_engine = function(approve_from_client, current_user_info, current_user, auto_submitted) {\n  var applicant_id, approve, approve_id, checkApplicant, description, flow, flow_id, form, geolocation, i, instance, instance_id, instance_trace, judge, key_str, last_step, last_step_type, last_trace, next_step, next_step_id, next_step_type, next_steps, setObj, space, space_id, space_user, space_user_org_info, step, step_type, to_users, trace, trace_approves, trace_id, updateObj, values;\n  instance_id = approve_from_client[\"instance\"];\n  trace_id = approve_from_client[\"trace\"];\n  approve_id = approve_from_client[\"_id\"];\n  values = approve_from_client[\"values\"];\n  if (!values) {\n    values = new Object;\n  }\n  next_steps = approve_from_client[\"next_steps\"];\n  judge = approve_from_client[\"judge\"];\n  description = approve_from_client[\"description\"];\n  geolocation = approve_from_client[\"geolocation\"];\n  setObj = new Object;\n  instance = uuflowManager.getInstance(instance_id);\n  space_id = instance.space;\n  flow_id = instance.flow;\n  space = uuflowManager.getSpace(space_id);\n  applicant_id = instance.applicant;\n  checkApplicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n  flow = uuflowManager.getFlow(flow_id);\n  space_user = uuflowManager.getSpaceUser(space_id, current_user);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  trace = uuflowManager.getTrace(instance, trace_id);\n  approve = uuflowManager.getApprove(trace, approve_id);\n  uuflowManager.isTraceNotFinished(trace);\n  uuflowManager.isApproveNotFinished(approve);\n  uuflowManager.isInstancePending(instance);\n  uuflowManager.isHandlerOrAgent(approve, current_user);\n  step = uuflowManager.getStep(instance, flow, trace.step);\n  step_type = step.step_type;\n  instance_trace = _.find(instance.traces, function(trace) {\n    return trace._id === trace_id;\n  });\n  trace_approves = instance_trace.approves;\n  i = 0;\n  while (i < trace_approves.length) {\n    if (trace_approves[i]._id === approve_id) {\n      key_str = \"traces.$.approves.\" + i + \".\";\n      setObj[key_str + \"geolocation\"] = geolocation;\n      if (step_type === \"condition\") {\n\n      } else if (step_type === \"start\" || step_type === \"submit\") {\n        setObj[key_str + \"judge\"] = \"submitted\";\n        setObj[key_str + \"description\"] = description;\n      } else if (step_type === \"sign\" || step_type === \"counterSign\") {\n        if (step_type === \"counterSign\" && !judge) {\n          judge = 'submitted';\n        }\n        uuflowManager.isJudgeLegal(judge);\n        setObj[key_str + \"judge\"] = judge;\n        setObj[key_str + \"description\"] = description;\n      }\n      setObj[key_str + \"next_steps\"] = next_steps;\n      setObj[key_str + \"is_read\"] = true;\n      if (!trace_approves[i].read_date) {\n        setObj[key_str + \"read_date\"] = new Date;\n      }\n      setObj[key_str + \"values\"] = uuflowManager.getApproveValues(values, step[\"permissions\"], instance.form, instance.form_version);\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      db.instances.update({\n        _id: instance_id,\n        \"traces._id\": trace_id\n      }, {\n        $set: setObj\n      });\n    }\n    i++;\n  }\n  instance = uuflowManager.getInstance(instance_id);\n  trace = uuflowManager.getTrace(instance, trace_id);\n  approve = uuflowManager.getApprove(trace, approve_id);\n  uuflowManager.isTraceNotFinished(trace);\n  uuflowManager.isApproveNotFinished(approve);\n  uuflowManager.isInstancePending(instance);\n  uuflowManager.isHandlerOrAgent(approve, current_user);\n  updateObj = new Object;\n  if (next_steps === null || next_steps.length === 0) {\n    throw new Meteor.Error('error!', '还未指定下一步和处理人，操作失败');\n  } else {\n    if (next_steps.length > 1) {\n      throw new Meteor.Error('error!', '不能指定多个后续步骤');\n    } else {\n      _.each(next_steps[0][\"users\"], function(next_step_user) {\n        var checkSpaceUser;\n        return checkSpaceUser = uuflowManager.getSpaceUser(space_id, next_step_user);\n      });\n    }\n    if (step_type === \"start\" || step_type === \"submit\" || step_type === \"condition\") {\n      updateObj = uuflowManager.engine_step_type_is_start_or_submit_or_condition(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted);\n    } else if (step_type === \"sign\") {\n      updateObj = uuflowManager.engine_step_type_is_sign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted);\n    } else if (step_type === \"counterSign\") {\n      updateObj = uuflowManager.engine_step_type_is_counterSign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted);\n    } else if (step_type === \"end\") {\n      throw new Meteor.Error('error!', 'end结点出现approve，服务器错误');\n    }\n    form = db.forms.findOne(instance.form);\n    updateObj.keywords = uuflowManager.caculateKeywords(updateObj.values, form, instance.form_version);\n    db.instances.update({\n      _id: instance_id\n    }, {\n      $set: updateObj\n    });\n  }\n  instance = uuflowManager.getInstance(instance_id);\n  instance_trace = _.find(instance.traces, function(trace) {\n    return trace._id === trace_id;\n  });\n  next_step_id = next_steps[0][\"step\"];\n  next_step = uuflowManager.getStep(instance, flow, next_step_id);\n  next_step_type = next_step.step_type;\n  if (\"completed\" === instance.state) {\n    if (\"approved\" === instance.final_decision) {\n      pushManager.send_instance_notification(\"approved_completed_applicant\", instance, description, current_user_info);\n    } else if (\"rejected\" === instance.final_decision) {\n      pushManager.send_instance_notification(\"rejected_completed_applicant\", instance, description, current_user_info);\n    } else {\n      pushManager.send_instance_notification(\"submit_completed_applicant\", instance, description, current_user_info);\n    }\n  } else if (\"pending\" === instance.state) {\n    if (\"rejected\" === instance_trace.judge && instance_trace.is_finished === true) {\n      if ('start' === next_step_type) {\n        pushManager.send_instance_notification(\"submit_pending_rejected_applicant_inbox\", instance, description, current_user_info);\n      } else {\n        pushManager.send_instance_notification(\"submit_pending_rejected_applicant\", instance, description, current_user_info);\n        pushManager.send_instance_notification(\"submit_pending_rejected_inbox\", instance, description, current_user_info);\n      }\n    } else if (instance_trace.is_finished === false) {\n\n    } else {\n      pushManager.send_instance_notification(\"submit_pending_inbox\", instance, description, current_user_info);\n    }\n  }\n  pushManager.send_message_current_user(current_user_info);\n  to_users = instance.inbox_users;\n  last_trace = _.last(instance.traces);\n  last_step = uuflowManager.getStep(instance, flow, last_trace.step);\n  last_step_type = last_step.step_type;\n  if (last_step_type === \"counterSign\" && _.where(last_trace.approves, {\n    is_finished: true\n  }).length > 0) {\n    to_users = [];\n  }\n  pushManager.triggerWebhook(flow_id, instance, approve_from_client, 'engine_submit', current_user, to_users);\n  uuflowManager.distributedInstancesRemind(instance);\n  return instance;\n};\n\nuuflowManager.engine_step_type_is_start_or_submit_or_condition = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) {\n  var h, i, instance_trace, instance_traces, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, setObj, space_id, trace_approve, updated_values;\n  setObj = new Object;\n  space_id = instance.space;\n  nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\");\n  _.each(next_steps, function(approve_next_step) {\n    if (!nextSteps.includes(approve_next_step[\"step\"])) {\n      throw new Meteor.Error('error!', \"approve中next_steps.step：\" + approve_next_step.step + \" 不合法\");\n    }\n  });\n  next_step_id = next_steps[0][\"step\"];\n  next_step = uuflowManager.getStep(instance, flow, next_step_id);\n  next_step_type = next_step.step_type;\n  next_step_name = next_step.name;\n  if (next_step_type === \"end\") {\n    instance_traces = instance.traces;\n    i = 0;\n    while (i < instance_traces.length) {\n      if (instance_traces[i]._id === trace_id) {\n        instance_traces[i].is_finished = true;\n        instance_traces[i].finish_date = new Date;\n        instance_traces[i].judge = judge;\n        h = 0;\n        while (h < instance_traces[i].approves.length) {\n          if (instance_traces[i].approves[h]._id === approve_id) {\n            instance_traces[i].approves[h].is_finished = true;\n            instance_traces[i].approves[h].handler = current_user;\n            instance_traces[i].approves[h].handler_name = current_user_info.name;\n            instance_traces[i].approves[h].finish_date = new Date;\n            instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n            instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n            instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n            instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n            instance_traces[i].approves[h].auto_submitted = auto_submitted;\n          }\n          h++;\n        }\n      }\n      i++;\n    }\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [trace_id];\n    newTrace.is_finished = true;\n    newTrace.step = next_step_id;\n    newTrace.name = next_step_name;\n    newTrace.start_date = new Date;\n    newTrace.finish_date = new Date;\n    setObj.state = \"completed\";\n    setObj.modified = new Date;\n    setObj.modified_by = current_user;\n    setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n    instance.values = setObj.values;\n    setObj.name = uuflowManager.getInstanceName(instance);\n    instance_trace = _.find(instance_traces, function(trace) {\n      return trace._id === trace_id;\n    });\n    trace_approve = _.find(instance_trace.approves, function(approve) {\n      return approve._id === approve_id;\n    });\n    outbox_users = instance.outbox_users;\n    outbox_users.unshift(trace_approve.handler);\n    outbox_users.unshift(trace_approve.user);\n    setObj.outbox_users = _.uniq(outbox_users);\n    instance_traces.push(newTrace);\n    setObj.traces = instance_traces;\n    setObj.inbox_users = [];\n    setObj.finish_date = new Date;\n    setObj.current_step_name = next_step_name;\n    setObj.final_decision = 'approved';\n    setObj.current_step_auto_submit = false;\n  } else {\n    next_step_users = next_steps[0][\"users\"];\n    if (next_step_users === null || next_step_users.length === 0) {\n      throw new Meteor.Error('error!', \"未指定下一步处理人\");\n    } else {\n      if (next_step_users.length > 1 && next_step.step_type !== \"counterSign\") {\n        throw new Meteor.Error('error!', \"不能指定多个处理人\");\n      } else {\n        next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id);\n        if (_.difference(next_step_users, next_user_ids).length > 0) {\n          throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n        } else {\n          instance_traces = instance.traces;\n          i = 0;\n          while (i < instance_traces.length) {\n            if (instance_traces[i]._id === trace_id) {\n              instance_traces[i].is_finished = true;\n              instance_traces[i].finish_date = new Date;\n              instance_traces[i].judge = judge;\n              h = 0;\n              while (h < instance_traces[i].approves.length) {\n                if (instance_traces[i].approves[h]._id === approve_id) {\n                  instance_traces[i].approves[h].is_finished = true;\n                  instance_traces[i].approves[h].handler = current_user;\n                  instance_traces[i].approves[h].handler_name = current_user_info.name;\n                  instance_traces[i].approves[h].finish_date = new Date;\n                  instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                  instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                  instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                  instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                  instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                }\n                h++;\n              }\n            }\n            i++;\n          }\n          newTrace = new Object;\n          newTrace._id = new Mongo.ObjectID()._str;\n          newTrace.instance = instance_id;\n          newTrace.previous_trace_ids = [trace_id];\n          newTrace.is_finished = false;\n          newTrace.step = next_step_id;\n          newTrace.name = next_step_name;\n          newTrace.start_date = new Date;\n          newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n          newTrace.approves = new Array;\n          updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          _.each(next_step_users, function(next_step_user_id, idx) {\n            var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n            newApprove = new Object;\n            newApprove._id = new Mongo.ObjectID()._str;\n            newApprove.instance = instance_id;\n            newApprove.trace = newTrace._id;\n            newApprove.is_finished = false;\n            newApprove.user = next_step_user_id;\n            user_info = db.users.findOne({\n              _id: next_step_user_id\n            }, {\n              fields: {\n                name: 1\n              }\n            });\n            newApprove.user_name = user_info.name;\n            handler_id = next_step_user_id;\n            handler_info = user_info;\n            agent = uuflowManager.getAgent(space_id, next_step_user_id);\n            if (agent) {\n              next_step_users[idx] = agent;\n              handler_id = agent;\n              handler_info = db.users.findOne({\n                _id: agent\n              }, {\n                fields: {\n                  name: 1\n                }\n              });\n              newApprove.agent = agent;\n            }\n            newApprove.handler = handler_id;\n            newApprove.handler_name = handler_info.name;\n            next_step_space_user = db.space_users.findOne({\n              space: space_id,\n              user: handler_id\n            });\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n            newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n            newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n            newApprove.start_date = new Date;\n            newApprove.due_date = newTrace.due_date;\n            newApprove.is_read = false;\n            newApprove.is_error = false;\n            newApprove.values = new Object;\n            uuflowManager.setRemindInfo(updated_values, newApprove);\n            return newTrace.approves.push(newApprove);\n          });\n          setObj.state = \"pending\";\n          setObj.modified = new Date;\n          setObj.modified_by = current_user;\n          setObj.values = updated_values;\n          instance.values = setObj.values;\n          setObj.name = uuflowManager.getInstanceName(instance);\n          instance_trace = _.find(instance_traces, function(trace) {\n            return trace._id === trace_id;\n          });\n          trace_approve = _.find(instance_trace.approves, function(approve) {\n            return approve._id === approve_id;\n          });\n          outbox_users = instance.outbox_users;\n          outbox_users.unshift(trace_approve.user);\n          outbox_users.unshift(trace_approve.handler);\n          setObj.outbox_users = _.uniq(outbox_users);\n          setObj.inbox_users = next_step_users;\n          instance_traces.push(newTrace);\n          setObj.traces = instance_traces;\n          setObj.current_step_name = next_step_name;\n          setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n        }\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.engine_step_type_is_sign = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted) {\n  var h, i, instance_trace, instance_traces, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, setObj, space_id, trace_approve, updated_values;\n  setObj = new Object;\n  space_id = instance.space;\n  if (!judge) {\n    throw new Meteor.Error('error!', \"单签结点还未选择处理意见，操作失败\");\n  } else {\n    if (judge === \"approved\") {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\");\n      _.each(next_steps, function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"指定的下一步有误\");\n        }\n      });\n      next_step_id = next_steps[0][\"step\"];\n      next_step = uuflowManager.getStep(instance, flow, next_step_id);\n      next_step_type = next_step[\"step_type\"];\n      next_step_name = next_step[\"name\"];\n      if (next_step_type === \"end\") {\n        instance_traces = instance.traces;\n        i = 0;\n        while (i < instance_traces.length) {\n          if (instance_traces[i]._id === trace_id) {\n            instance_traces[i].is_finished = true;\n            instance_traces[i].finish_date = new Date;\n            instance_traces[i].judge = judge;\n            h = 0;\n            while (h < instance_traces[i].approves.length) {\n              if (instance_traces[i].approves[h]._id === approve_id) {\n                instance_traces[i].approves[h].is_finished = true;\n                instance_traces[i].approves[h].handler = current_user;\n                instance_traces[i].approves[h].handler_name = current_user_info.name;\n                instance_traces[i].approves[h].finish_date = new Date;\n                instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                instance_traces[i].approves[h].auto_submitted = auto_submitted;\n              }\n              h++;\n            }\n          }\n          i++;\n        }\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [trace_id];\n        newTrace.is_finished = true;\n        newTrace.step = next_step_id;\n        newTrace.name = next_step_name;\n        newTrace.start_date = new Date;\n        newTrace.finish_date = new Date;\n        setObj.state = \"completed\";\n        setObj.final_decision = judge;\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n        setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n        instance.values = setObj.values;\n        setObj.name = uuflowManager.getInstanceName(instance);\n        instance_trace = _.find(instance_traces, function(trace) {\n          return trace._id === trace_id;\n        });\n        trace_approve = _.find(instance_trace.approves, function(approve) {\n          return approve._id === approve_id;\n        });\n        outbox_users = instance.outbox_users;\n        outbox_users.unshift(trace_approve.handler);\n        outbox_users.unshift(trace_approve.user);\n        setObj.outbox_users = _.uniq(outbox_users);\n        instance_traces.push(newTrace);\n        setObj.traces = instance_traces;\n        setObj.inbox_users = [];\n        setObj.finish_date = new Date;\n        if (instance.cc_users) {\n          setObj.cc_users = instance.cc_users;\n        }\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = false;\n      } else {\n        next_step_users = next_steps[0][\"users\"];\n        if (next_step_users === null || next_step_users.length === 0) {\n          throw new Meteor.Error('error!', \"未指定下一步处理人\");\n        } else {\n          if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n            throw new Meteor.Error('error!', \"不能指定多个处理人\");\n          } else {\n            next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id);\n            if (_.difference(next_step_users, next_user_ids).length > 0) {\n              throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n            } else {\n              instance_traces = instance.traces;\n              i = 0;\n              while (i < instance_traces.length) {\n                if (instance_traces[i]._id === trace_id) {\n                  instance_traces[i].is_finished = true;\n                  instance_traces[i].finish_date = new Date;\n                  instance_traces[i].judge = judge;\n                  h = 0;\n                  while (h < instance_traces[i].approves.length) {\n                    if (instance_traces[i].approves[h]._id === approve_id) {\n                      instance_traces[i].approves[h].is_finished = true;\n                      instance_traces[i].approves[h].handler = current_user;\n                      instance_traces[i].approves[h].handler_name = current_user_info.name;\n                      instance_traces[i].approves[h].finish_date = new Date;\n                      instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                      instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                      instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                      instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                      instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                    }\n                    h++;\n                  }\n                }\n                i++;\n              }\n              newTrace = new Object;\n              newTrace._id = new Mongo.ObjectID()._str;\n              newTrace.instance = instance_id;\n              newTrace.previous_trace_ids = [trace_id];\n              newTrace.is_finished = false;\n              newTrace.step = next_step_id;\n              newTrace.name = next_step_name;\n              newTrace.start_date = new Date;\n              newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n              newTrace.approves = new Array;\n              updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n              _.each(next_step_users, function(next_step_user_id, idx) {\n                var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                newApprove = new Object;\n                newApprove._id = new Mongo.ObjectID()._str;\n                newApprove.instance = instance_id;\n                newApprove.trace = newTrace._id;\n                newApprove.is_finished = false;\n                newApprove.user = next_step_user_id;\n                user_info = db.users.findOne({\n                  _id: next_step_user_id\n                }, {\n                  fields: {\n                    name: 1\n                  }\n                });\n                newApprove.user_name = user_info.name;\n                handler_id = next_step_user_id;\n                handler_info = user_info;\n                agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                if (agent) {\n                  next_step_users[idx] = agent;\n                  handler_id = agent;\n                  handler_info = db.users.findOne({\n                    _id: agent\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.agent = agent;\n                }\n                newApprove.handler = handler_id;\n                newApprove.handler_name = handler_info.name;\n                next_step_space_user = db.space_users.findOne({\n                  space: space_id,\n                  user: handler_id\n                });\n                next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                newApprove.start_date = new Date;\n                newApprove.due_date = newTrace.due_date;\n                newApprove.is_read = false;\n                newApprove.is_error = false;\n                newApprove.values = new Object;\n                uuflowManager.setRemindInfo(updated_values, newApprove);\n                return newTrace.approves.push(newApprove);\n              });\n              setObj.final_decision = judge;\n              setObj.modified = new Date;\n              setObj.modified_by = current_user;\n              setObj.values = updated_values;\n              instance.values = setObj.values;\n              setObj.name = uuflowManager.getInstanceName(instance);\n              instance_trace = _.find(instance_traces, function(trace) {\n                return trace._id === trace_id;\n              });\n              trace_approve = _.find(instance_trace.approves, function(approve) {\n                return approve._id === approve_id;\n              });\n              outbox_users = instance.outbox_users;\n              outbox_users.unshift(trace_approve.user);\n              outbox_users.unshift(trace_approve.handler);\n              setObj.outbox_users = _.uniq(outbox_users);\n              setObj.inbox_users = next_step_users;\n              instance_traces.push(newTrace);\n              setObj.traces = instance_traces;\n              setObj.state = \"pending\";\n              if (instance.cc_users) {\n                setObj.cc_users = instance.cc_users;\n              }\n              setObj.current_step_name = next_step_name;\n              setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n            }\n          }\n        }\n      }\n    } else if (judge === \"rejected\") {\n      if (!description) {\n        throw new Meteor.Error('error!', \"请填写驳回理由\");\n      } else {\n        nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"rejected\");\n        _.each(next_steps, function(approve_next_step) {\n          if (!nextSteps.includes(approve_next_step[\"step\"])) {\n            throw new Meteor.Error('error!', \"指定的下一步有误\");\n          }\n        });\n        next_step_id = next_steps[0][\"step\"];\n        next_step = uuflowManager.getStep(instance, flow, next_step_id);\n        next_step_type = next_step[\"step_type\"];\n        next_step_name = next_step[\"name\"];\n        if (next_step_type === \"end\") {\n          instance_traces = instance.traces;\n          i = 0;\n          while (i < instance_traces.length) {\n            if (instance_traces[i]._id === trace_id) {\n              instance_traces[i].is_finished = true;\n              instance_traces[i].finish_date = new Date;\n              instance_traces[i].judge = judge;\n              h = 0;\n              while (h < instance_traces[i].approves.length) {\n                if (instance_traces[i].approves[h]._id === approve_id) {\n                  instance_traces[i].approves[h].is_finished = true;\n                  instance_traces[i].approves[h].handler = current_user;\n                  instance_traces[i].approves[h].handler_name = current_user_info.name;\n                  instance_traces[i].approves[h].finish_date = new Date;\n                  instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                  instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                  instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                  instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                  instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                }\n                h++;\n              }\n            }\n            i++;\n          }\n          newTrace = new Object;\n          newTrace._id = new Mongo.ObjectID()._str;\n          newTrace.instance = instance_id;\n          newTrace.previous_trace_ids = [trace_id];\n          newTrace.is_finished = true;\n          newTrace.step = next_step_id;\n          newTrace.name = next_step_name;\n          newTrace.start_date = new Date;\n          newTrace.finish_date = new Date;\n          setObj.state = \"completed\";\n          setObj.final_decision = judge;\n          setObj.modified = new Date;\n          setObj.modified_by = current_user;\n          setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          instance.values = setObj.values;\n          setObj.name = uuflowManager.getInstanceName(instance);\n          instance_trace = _.find(instance_traces, function(trace) {\n            return trace._id === trace_id;\n          });\n          trace_approve = _.find(instance_trace.approves, function(approve) {\n            return approve._id === approve_id;\n          });\n          outbox_users = instance.outbox_users;\n          outbox_users.unshift(trace_approve.handler);\n          outbox_users.unshift(trace_approve.user);\n          setObj.outbox_users = _.uniq(outbox_users);\n          instance_traces.push(newTrace);\n          setObj.traces = instance_traces;\n          setObj.inbox_users = [];\n          setObj.finish_date = new Date;\n          if (instance.cc_users) {\n            setObj.cc_users = instance.cc_users;\n          }\n          setObj.current_step_name = next_step_name;\n          setObj.current_step_auto_submit = false;\n        } else {\n          next_step_users = next_steps[0][\"users\"];\n          if (next_step_users === null || next_step_users.length === 0) {\n            throw new Meteor.Error('error!', \"未指定下一步处理人\");\n          } else {\n            if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n              throw new Meteor.Error('error!', \"不能指定多个处理人\");\n            } else {\n              next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id);\n              if (_.difference(next_step_users, next_user_ids).length > 0) {\n                throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n              } else {\n                instance_traces = instance.traces;\n                i = 0;\n                while (i < instance_traces.length) {\n                  if (instance_traces[i]._id === trace_id) {\n                    instance_traces[i].is_finished = true;\n                    instance_traces[i].finish_date = new Date;\n                    instance_traces[i].judge = judge;\n                    h = 0;\n                    while (h < instance_traces[i].approves.length) {\n                      if (instance_traces[i].approves[h]._id === approve_id) {\n                        instance_traces[i].approves[h].is_finished = true;\n                        instance_traces[i].approves[h].handler = current_user;\n                        instance_traces[i].approves[h].handler_name = current_user_info.name;\n                        instance_traces[i].approves[h].finish_date = new Date;\n                        instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                        instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                        instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                        instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                        instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                      }\n                      h++;\n                    }\n                  }\n                  i++;\n                }\n                newTrace = new Object;\n                newTrace._id = new Mongo.ObjectID()._str;\n                newTrace.instance = instance_id;\n                newTrace.previous_trace_ids = [trace_id];\n                newTrace.is_finished = false;\n                newTrace.step = next_step_id;\n                newTrace.name = next_step_name;\n                newTrace.start_date = new Date;\n                newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n                newTrace.approves = new Array;\n                updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n                _.each(next_step_users, function(next_step_user_id, idx) {\n                  var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                  newApprove = new Object;\n                  newApprove._id = new Mongo.ObjectID()._str;\n                  newApprove.instance = instance_id;\n                  newApprove.trace = newTrace._id;\n                  newApprove.is_finished = false;\n                  newApprove.user = next_step_user_id;\n                  user_info = db.users.findOne({\n                    _id: next_step_user_id\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.user_name = user_info.name;\n                  handler_id = next_step_user_id;\n                  handler_info = user_info;\n                  agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                  if (agent) {\n                    next_step_users[idx] = agent;\n                    handler_id = agent;\n                    handler_info = db.users.findOne({\n                      _id: agent\n                    }, {\n                      fields: {\n                        name: 1\n                      }\n                    });\n                    newApprove.agent = agent;\n                  }\n                  newApprove.handler = handler_id;\n                  newApprove.handler_name = handler_info.name;\n                  next_step_space_user = db.space_users.findOne({\n                    space: space_id,\n                    user: handler_id\n                  });\n                  next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                  newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                  newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                  newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                  newApprove.start_date = new Date;\n                  newApprove.due_date = newTrace.due_date;\n                  newApprove.is_read = false;\n                  newApprove.is_error = false;\n                  newApprove.values = new Object;\n                  uuflowManager.setRemindInfo(updated_values, newApprove);\n                  return newTrace.approves.push(newApprove);\n                });\n                setObj.final_decision = judge;\n                setObj.modified = new Date;\n                setObj.modified_by = current_user;\n                setObj.values = updated_values;\n                instance.values = setObj.values;\n                setObj.name = uuflowManager.getInstanceName(instance);\n                instance_trace = _.find(instance_traces, function(trace) {\n                  return trace._id === trace_id;\n                });\n                trace_approve = _.find(instance_trace.approves, function(approve) {\n                  return approve._id === approve_id;\n                });\n                outbox_users = instance.outbox_users;\n                outbox_users.unshift(trace_approve.user);\n                outbox_users.unshift(trace_approve.handler);\n                setObj.outbox_users = _.uniq(outbox_users);\n                setObj.inbox_users = next_step_users;\n                instance_traces.push(newTrace);\n                setObj.traces = instance_traces;\n                setObj.state = \"pending\";\n                if (instance.cc_users) {\n                  setObj.cc_users = instance.cc_users;\n                }\n                setObj.current_step_name = next_step_name;\n                setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.engine_step_type_is_counterSign = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) {\n  var h, i, instance_trace, instance_traces, isAllApproveFinished, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, ref, ref1, ref2, ref3, setObj, space_id, trace_approve;\n  setObj = new Object;\n  space_id = instance.space;\n  if (!judge) {\n    throw new Meteor.Error('error!', \"请选择核准或驳回。\");\n  } else {\n    if (step.oneClickApproval && ['approved', 'readed'].includes(judge) && ((ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? ref1.is_group_company : void 0 : void 0)) {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\");\n      _.each(next_steps, function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"指定的下一步有误\");\n        }\n      });\n    }\n    next_step_id = next_steps[0][\"step\"];\n    next_step = uuflowManager.getStep(instance, flow, next_step_id);\n    next_step_type = next_step[\"step_type\"];\n    next_step_name = next_step[\"name\"];\n    instance_traces = instance.traces;\n    isAllApproveFinished = true;\n    i = 0;\n    while (i < instance_traces.length) {\n      if (instance_traces[i]._id === trace_id) {\n        h = 0;\n        while (h < instance_traces[i].approves.length) {\n          if (instance_traces[i].approves[h]._id === approve_id || (((ref2 = Meteor.settings) != null ? (ref3 = ref2[\"public\"]) != null ? ref3.is_group_company : void 0 : void 0) && (step.oneClickApproval && ['approved', 'readed'].includes(judge)) || (step.oneClickRejection && 'rejected' === judge))) {\n            instance_traces[i].approves[h].is_finished = true;\n            instance_traces[i].approves[h].finish_date = new Date;\n            instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n            instance_traces[i].approves[h].auto_submitted = auto_submitted;\n          }\n          if (instance_traces[i].approves[h].is_finished === false && instance_traces[i].approves[h].type !== 'cc' && instance_traces[i].approves[h].type !== 'distribute') {\n            isAllApproveFinished = false;\n          }\n          h++;\n        }\n      }\n      i++;\n    }\n    if (isAllApproveFinished === true) {\n      i = 0;\n      while (i < instance_traces.length) {\n        if (instance_traces[i]._id === trace_id) {\n          instance_traces[i].is_finished = true;\n          instance_traces[i].finish_date = new Date;\n          instance_traces[i].judge = \"submitted\";\n        }\n        i++;\n      }\n      if (next_step_type === \"end\") {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [trace_id];\n        newTrace.is_finished = true;\n        newTrace.step = next_step_id;\n        newTrace.name = next_step_name;\n        newTrace.start_date = new Date;\n        newTrace.finish_date = new Date;\n        setObj.state = \"completed\";\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n        instance_trace = _.find(instance_traces, function(trace) {\n          return trace._id === trace_id;\n        });\n        outbox_users = instance.outbox_users;\n        _.each(instance_trace.approves, function(appro) {\n          outbox_users.push(appro.user);\n          return outbox_users.push(appro.handler);\n        });\n        setObj.outbox_users = _.uniq(outbox_users);\n        setObj.inbox_users = new Array;\n        instance_traces.push(newTrace);\n        setObj.traces = instance_traces;\n        setObj.finish_date = new Date;\n        setObj.values = instance.values;\n        if (instance.cc_users) {\n          setObj.cc_users = instance.cc_users;\n        }\n        setObj.current_step_name = next_step_name;\n        setObj.final_decision = 'approved';\n        setObj.current_step_auto_submit = false;\n      } else {\n        next_step_users = next_steps[0][\"users\"];\n        if (next_step_users === null || next_step_users.length === 0) {\n          throw new Meteor.Error('error!', \"未指定下一步处理人\");\n        } else {\n          if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n            throw new Meteor.Error('error!', \"不能指定多个处理人\");\n          } else {\n            next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id);\n            if (_.difference(next_step_users, next_user_ids).length > 0) {\n              throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n            } else {\n              newTrace = new Object;\n              newTrace._id = new Mongo.ObjectID()._str;\n              newTrace.instance = instance_id;\n              newTrace.previous_trace_ids = [trace_id];\n              newTrace.is_finished = false;\n              newTrace.step = next_step_id;\n              newTrace.name = next_step_name;\n              newTrace.start_date = new Date;\n              newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n              newTrace.approves = new Array;\n              _.each(next_step_users, function(next_step_user_id, idx) {\n                var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                newApprove = new Object;\n                newApprove._id = new Mongo.ObjectID()._str;\n                newApprove.instance = instance_id;\n                newApprove.trace = newTrace._id;\n                newApprove.is_finished = false;\n                newApprove.user = next_step_user_id;\n                user_info = db.users.findOne({\n                  _id: next_step_user_id\n                }, {\n                  fields: {\n                    name: 1\n                  }\n                });\n                newApprove.user_name = user_info.name;\n                handler_id = next_step_user_id;\n                handler_info = user_info;\n                agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                if (agent) {\n                  next_step_users[idx] = agent;\n                  handler_id = agent;\n                  handler_info = db.users.findOne({\n                    _id: agent\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.agent = agent;\n                }\n                newApprove.handler = handler_id;\n                newApprove.handler_name = handler_info.name;\n                next_step_space_user = db.space_users.findOne({\n                  space: space_id,\n                  user: handler_id\n                });\n                next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                newApprove.start_date = new Date;\n                newApprove.due_date = newTrace.due_date;\n                newApprove.is_read = false;\n                newApprove.is_error = false;\n                newApprove.values = new Object;\n                uuflowManager.setRemindInfo(instance.values, newApprove);\n                return newTrace.approves.push(newApprove);\n              });\n              setObj.modified = new Date;\n              setObj.modified_by = current_user;\n              instance_trace = _.find(instance_traces, function(trace) {\n                return trace._id === trace_id;\n              });\n              outbox_users = instance.outbox_users;\n              _.each(instance_trace.approves, function(appro) {\n                outbox_users.push(appro.user);\n                return outbox_users.push(appro.handler);\n              });\n              setObj.outbox_users = _.uniq(outbox_users);\n              setObj.inbox_users = next_step_users;\n              instance_traces.push(newTrace);\n              setObj.traces = instance_traces;\n              setObj.state = \"pending\";\n              setObj.values = instance.values;\n              if (instance.cc_users) {\n                setObj.cc_users = instance.cc_users;\n              }\n              setObj.current_step_name = next_step_name;\n              setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n            }\n          }\n        }\n      }\n    } else {\n      instance_trace = _.find(instance_traces, function(trace) {\n        return trace._id === trace_id;\n      });\n      trace_approve = _.find(instance_trace.approves, function(approve) {\n        return approve._id === approve_id;\n      });\n      instance.outbox_users.unshift(trace_approve.handler);\n      setObj.outbox_users = instance.outbox_users;\n      instance.inbox_users.splice(instance.inbox_users.indexOf(trace_approve.handler), 1);\n      setObj.inbox_users = instance.inbox_users;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      setObj.traces = instance_traces;\n      setObj.state = \"pending\";\n      setObj.values = instance.values;\n      if (instance.cc_users) {\n        setObj.cc_users = instance.cc_users;\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.ins_html = function(current_user_info, ins) {\n  var instanceHtml, options;\n  options = {\n    templateName: 'table',\n    showTrace: true,\n    showAttachments: false\n  };\n  options.width = \"765px\";\n  options.styles = \"body { background: #ffffff !important; }.steedos .pull-right { float: right !important; }.steedos .inline-left{ display: inline;float: left; }.steedos .inline-right{ display: inline;float: right; }.steedos .no-border{ border: 0px; }.steedos .no-border td{ border: 0px; }.steedos tr:nth-child(2) td{ border-top: 0px !important; }.steedos .ins_applicant{ display: inline; background: transparent !important; border: none; }.steedos .instance-name{ width: \" + options.width + \" !important; }.steedos table { border-spacing: 0; border-collapse: collapse; }.steedos .box { background: #ffffff; }.steedos .form-table { width: \" + options.width + \"; border: solid 2px #000000; border-collapse: collapse; table-layout: fixed; }.steedosTable-item-field{ padding: 5px; }.steedos td{ border: solid 1px #000000; border-collapse: collapse; }.steedos th { border: 0px; border-collapse: collapse; padding: 0px; }.steedos .td-title{ padding: 4px 12px; }.steedos .td-field { padding: 4px 12px; }.instance-view .instance-name { text-align: center; font-weight: bolder; }.td-childfield { border-top: solid 1px #000000; border-right: solid 1px #000000; border-bottom: solid 1px #000000; padding: 0px; }.panel-heading{ padding: 4px 12px; font-weight: bold; color: #333; background-color: #f5f5f5; }.table-bordered tr:last-child th { border-bottom: none; }.table-bordered tr:last-child td { border-bottom: none; }.steedos-table th:first-child{ border-left: 0px !important; }.steedos-table td:first-child { border-left: 0px !important; }.steedos-table table thead .title { min-width: 50px; }.steedos-table th:last-child{ border-right: 0px !important; }.steedos-table td:last-child { border-right: 0px !important; }.steedos-table table .number { text-align: right; }.callout-default{ border-color: #D2D6DE; color: #333; background-color: #F1F1F1; font-weight: bold; }.instance-table .callout { margin: 0px; padding: 4px 12px; border-radius: 0px; border-left: none; }.approved{ color: green; }.rejected{ color: red; }.terminated{ color: black; }.reassigned{ color: black; }.retrieved{ color: black; }.trace-approve-talbe td { text-align: left; border: none; }.traces td table { width: 100%; }.approve-item .name{ width: 40%; }.approve-item .finish-date{ width: 35%; }.td-stepname{ padding: 4px 12px; }.td-approve td{ padding: 4px 12px; }.applicant-wrapper { font-weight: bolder; }\";\n  instanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(current_user_info, ins.space, ins, options);\n  instanceHtml = instanceHtml.replace('style=\"width: 100%;display: inline-table;\"', 'style=\"border:0px;text-align: center;width:765px;\"');\n  instanceHtml = instanceHtml.replace('class=\"instance-table-name-td\"', 'class=\"instance-table-name-td\" style=\"width:' + options.width + ';border:0px\"');\n  instanceHtml = instanceHtml.replace('class=\"instance-name\"', 'class=\"instance-name\" style=\"width:' + options.width + '\"');\n  instanceHtml = instanceHtml.replace('class=\"table-page-body form-table\"', 'class=\"table-page-body form-table\" style=\"width:' + options.width + '\"');\n  instanceHtml = instanceHtml.replace('class=\"table table-condensed traces\"', 'class=\"table table-condensed traces\" style=\"width:' + options.width + ';border:solid 2.0px #000000\"');\n  instanceHtml = instanceHtml.replace('class=\"table-page-footer form-table no-border\"', 'class=\"table-page-footer form-table no-border\" style=\"border:0px;width:765px;\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-title \"/g, 'class=\"td-title\" style=\"width:14%\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-stepname\"/g, 'class=\"td-stepname\" style=\"width:' + 765 * 20 / 100 + 'px\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-childfield\"/g, 'class=\"td-childfield\" style=\"padding:0px\"');\n  instanceHtml = instanceHtml.replace(/class=\"status approved\"/g, 'class=\"status approved\" style=\"color: green;\"');\n  instanceHtml = instanceHtml.replace(/class=\"status rejected\"/g, 'class=\"status rejected\" style=\"color: red;\"');\n  instanceHtml = instanceHtml.replace(/<table>/g, '<table style=\"width:100%;border:none\">');\n  instanceHtml = instanceHtml.replace(/<td class=\"name\">/g, '<td class=\"name\" style=\"width: 40%;\">');\n  instanceHtml = instanceHtml.replace(/<td class=\"finish-date\">/g, '<td class=\"finish-date\" style=\"width: 35%;\">');\n  instanceHtml = instanceHtml.replace(/inline-left'/g, \"inline-left' style='display: inline;float: left;'\");\n  instanceHtml = instanceHtml.replace(/inline-right'/g, \"inline-right' style='display: inline;float: right;'\");\n  instanceHtml = instanceHtml.replace(/pull-right'/g, \"pull-right' style='float: right;'\");\n  return instanceHtml;\n};\n\nuuflowManager.getFlowCompanyId = function(flowId) {\n  var ref;\n  return (ref = db.flows.findOne(flowId, {\n    fields: {\n      company_id: 1\n    }\n  })) != null ? ref.company_id : void 0;\n};\n\nuuflowManager.create_instance = function(instance_from_client, user_info) {\n  var appr_obj, approve_from_client, category, companyId, flow, flow_id, form, ins_obj, instance_flow_version, new_ins_id, now, permissions, space, space_id, space_user, space_user_org_info, start_step, trace_from_client, trace_obj, user_id;\n  space_id = instance_from_client[\"space\"];\n  flow_id = instance_from_client[\"flow\"];\n  instance_flow_version = instance_from_client[\"flow_version\"];\n  user_id = user_info._id;\n  trace_from_client = null;\n  approve_from_client = null;\n  if (instance_from_client[\"traces\"] && instance_from_client[\"traces\"][0]) {\n    trace_from_client = instance_from_client[\"traces\"][0];\n    if (trace_from_client[\"approves\"] && trace_from_client[\"approves\"][0]) {\n      approve_from_client = instance_from_client[\"traces\"][0][\"approves\"][0];\n    }\n  }\n  space = uuflowManager.getSpace(space_id);\n  flow = uuflowManager.getFlow(flow_id);\n  space_user = uuflowManager.getSpaceUser(space_id, user_id);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  uuflowManager.isFlowEnabled(flow);\n  uuflowManager.isFlowSpaceMatched(flow, space_id);\n  form = uuflowManager.getForm(flow.form);\n  permissions = permissionManager.getFlowPermissions(flow_id, user_id);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"当前用户没有此流程的新建权限\");\n  }\n  now = new Date;\n  ins_obj = {};\n  ins_obj._id = db.instances._makeNewID();\n  ins_obj.space = space_id;\n  ins_obj.flow = flow_id;\n  ins_obj.flow_version = flow.current._id;\n  ins_obj.form = flow.form;\n  ins_obj.form_version = flow.current.form_version;\n  ins_obj.name = flow.name;\n  ins_obj.submitter = user_id;\n  ins_obj.submitter_name = user_info.name;\n  ins_obj.applicant = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  ins_obj.applicant_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  ins_obj.applicant_organization = instance_from_client[\"applicant_organization\"] ? instance_from_client[\"applicant_organization\"] : space_user.organization;\n  ins_obj.applicant_organization_name = instance_from_client[\"applicant_organization_name\"] ? instance_from_client[\"applicant_organization_name\"] : space_user_org_info.organization_name;\n  ins_obj.applicant_organization_fullname = instance_from_client[\"applicant_organization_fullname\"] ? instance_from_client[\"applicant_organization_fullname\"] : space_user_org_info.organization_fullname;\n  ins_obj.applicant_company = instance_from_client[\"applicant_company\"] ? instance_from_client[\"applicant_company\"] : space_user.company_id;\n  ins_obj.state = 'draft';\n  ins_obj.code = '';\n  ins_obj.is_archived = false;\n  ins_obj.is_deleted = false;\n  ins_obj.created = now;\n  ins_obj.created_by = user_id;\n  ins_obj.modified = now;\n  ins_obj.modified_by = user_id;\n  ins_obj.values = new Object;\n  companyId = uuflowManager.getFlowCompanyId(flow_id);\n  if (companyId) {\n    ins_obj.company_id = companyId;\n  }\n  trace_obj = {};\n  trace_obj._id = new Mongo.ObjectID()._str;\n  trace_obj.instance = ins_obj._id;\n  trace_obj.is_finished = false;\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  trace_obj.step = start_step._id;\n  trace_obj.name = start_step.name;\n  trace_obj.start_date = now;\n  appr_obj = {};\n  appr_obj._id = new Mongo.ObjectID()._str;\n  appr_obj.instance = ins_obj._id;\n  appr_obj.trace = trace_obj._id;\n  appr_obj.is_finished = false;\n  appr_obj.user = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  appr_obj.user_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  appr_obj.handler = user_id;\n  appr_obj.handler_name = user_info.name;\n  appr_obj.handler_organization = space_user.organization;\n  appr_obj.handler_organization_name = space_user_org_info.organization_name;\n  appr_obj.handler_organization_fullname = space_user_org_info.organization_fullname;\n  appr_obj.type = 'draft';\n  appr_obj.start_date = now;\n  appr_obj.read_date = now;\n  appr_obj.is_read = true;\n  appr_obj.is_error = false;\n  appr_obj.description = '';\n  appr_obj.values = approve_from_client && approve_from_client[\"values\"] ? approve_from_client[\"values\"] : new Object;\n  trace_obj.approves = [appr_obj];\n  ins_obj.traces = [trace_obj];\n  ins_obj.inbox_users = instance_from_client.inbox_users || [];\n  ins_obj.current_step_name = start_step.name;\n  if (flow.auto_remind === true) {\n    ins_obj.auto_remind = true;\n  }\n  ins_obj.flow_name = flow.name;\n  if (form.category) {\n    category = uuflowManager.getCategory(form.category);\n    if (category) {\n      ins_obj.category_name = category.name;\n      ins_obj.category = category._id;\n    }\n  }\n  new_ins_id = db.instances.insert(ins_obj);\n  return new_ins_id;\n};\n\nuuflowManager.getCurrentStepAutoSubmit = function(timeout_auto_submit, lines) {\n  var timeout_line;\n  if (timeout_auto_submit && lines) {\n    timeout_line = _.find(lines, function(l) {\n      return l.timeout_line === true;\n    });\n    if (timeout_line) {\n      return true;\n    }\n  }\n  return false;\n};\n\nuuflowManager.getDueDate = function(hours) {\n  var due_time;\n  if (hours) {\n    due_time = new Date().getTime() + (1000 * 60 * 60 * hours);\n    return new Date(due_time);\n  }\n  return void 0;\n};\n\nuuflowManager.submit_instance = function(instance_from_client, user_info) {\n  var applicant, applicant_id, applicant_org_info, approve, approve_id, attachments, checkApplicant, checkUsers, current_user, description, flow, flow_has_upgrade, flow_id, form, instance, instance_id, instance_name, instance_traces, lang, newTrace, nextSteps, nextTrace, next_step, next_step_users, next_steps, permissions, setObj, space, space_id, space_user, space_user_org_info, start_step, step, submitter_id, trace, trace_id, traces, upObj, updated_values, user, values;\n  current_user = user_info._id;\n  lang = \"en\";\n  if (user_info.locale === 'zh-cn') {\n    lang = 'zh-CN';\n  }\n  instance_id = instance_from_client[\"_id\"];\n  trace_id = instance_from_client[\"traces\"][0][\"_id\"];\n  approve_id = instance_from_client[\"traces\"][0][\"approves\"][0][\"_id\"];\n  values = instance_from_client[\"traces\"][0][\"approves\"][0][\"values\"];\n  if (!values) {\n    values = new Object;\n  }\n  if (!instance_from_client[\"applicant\"]) {\n    throw new Meteor.Error('error!', \"请选择提交人\");\n  }\n  applicant_id = instance_from_client[\"applicant\"];\n  submitter_id = instance_from_client[\"submitter\"];\n  next_steps = instance_from_client[\"traces\"][0][\"approves\"][0][\"next_steps\"];\n  attachments = instance_from_client[\"traces\"][0][\"approves\"][0][\"attachments\"];\n  description = instance_from_client[\"traces\"][0][\"approves\"][0][\"description\"];\n  instance = uuflowManager.getInstance(instance_id);\n  space_id = instance.space;\n  flow_id = instance.flow;\n  space = uuflowManager.getSpace(space_id);\n  checkApplicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n  flow = uuflowManager.getFlow(flow_id);\n  instance_name = instance_from_client[\"name\"];\n  uuflowManager.isInstanceDraft(instance, lang);\n  space_user = uuflowManager.getSpaceUser(space_id, current_user);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  uuflowManager.isInstanceSubmitter(instance, current_user);\n  uuflowManager.isFlowEnabled(flow);\n  permissions = permissionManager.getFlowPermissions(flow_id, current_user);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"该提交人没有提交此申请单的权限。\");\n  }\n  trace = instance_from_client[\"traces\"][0];\n  step = uuflowManager.getStep(instance, flow, trace[\"step\"]);\n  approve = trace[\"approves\"][0];\n  form = db.forms.findOne(instance.form);\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  instance_traces = instance.traces;\n  instance_traces[0][\"approves\"][0].description = description;\n  setObj = new Object;\n  flow_has_upgrade = false;\n  if (applicant_id === instance.applicant) {\n    if (instance.flow_version === flow.current._id) {\n      instance_traces[0][\"approves\"][0].judge = \"submitted\";\n      if (next_steps) {\n        instance_traces[0][\"approves\"][0].next_steps = next_steps;\n      }\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n    } else {\n      flow_has_upgrade = true;\n      setObj.flow_version = flow.current._id;\n      setObj.form_version = flow.current.form_version;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      instance_traces[0].step = start_step._id;\n      instance_traces[0].name = start_step.name;\n      instance_traces[0][\"approves\"][0].judge = \"submitted\";\n    }\n  } else {\n    user = uuflowManager.getUser(applicant_id);\n    applicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n    applicant_org_info = uuflowManager.getSpaceUserOrgInfo(applicant);\n    setObj.applicant = applicant_id;\n    setObj.applicant_name = user.name;\n    setObj.applicant_organization = applicant_org_info[\"organization\"];\n    setObj.applicant_organization_name = applicant_org_info[\"organization_name\"];\n    setObj.applicant_organization_fullname = applicant_org_info[\"organization_fullname\"];\n    setObj.applicant_company = applicant[\"company_id\"];\n    instance_traces[0][\"approves\"][0].user = applicant_id;\n    instance_traces[0][\"approves\"][0].user_name = user.name;\n    instance_traces[0][\"approves\"][0].judge = \"submitted\";\n    if (instance.flow_version === flow.current._id) {\n      if (next_steps) {\n        instance_traces[0][\"approves\"][0].next_steps = next_steps;\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n      }\n    } else {\n      flow_has_upgrade = true;\n      setObj.flow_version = flow.current._id;\n      setObj.form_version = flow.current.form_version;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      instance_traces[0].step = start_step._id;\n      instance_traces[0].name = start_step.name;\n    }\n  }\n  instance_traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(values, step.permissions, instance.form, instance.form_version);\n  setObj.traces = instance_traces;\n  db.instances.update({\n    _id: instance_id\n  }, {\n    $set: setObj\n  });\n  if (flow_has_upgrade) {\n    return {\n      alerts: TAPi18n.__('flow.point_upgraded', {}, lang)\n    };\n  }\n  instance = db.instances.findOne(instance_id);\n  uuflowManager.isInstanceDraft(instance, lang);\n  traces = instance.traces;\n  upObj = new Object;\n  if ((!approve[\"next_steps\"]) || (approve[\"next_steps\"].length === 0)) {\n    throw new Meteor.Error('error!', \"还未指定下一步和处理人，提交失败\");\n  } else {\n    if (approve[\"next_steps\"].length > 1) {\n      throw new Meteor.Error('error!', \"不能指定多个后续步骤\");\n    } else {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\");\n      _.each(approve[\"next_steps\"], function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"下一步步骤不合法\");\n        }\n      });\n    }\n  }\n  _.each(approve[\"next_steps\"][0][\"users\"], function(next_step_user) {\n    return uuflowManager.getSpaceUser(space_id, next_step_user);\n  });\n  next_step = uuflowManager.getStep(instance, flow, approve[\"next_steps\"][0][\"step\"]);\n  if (next_step.step_type === \"end\") {\n    traces[0][\"approves\"][0].is_finished = true;\n    traces[0][\"approves\"][0].finish_date = new Date;\n    traces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date;\n    traces[0].is_finished = true;\n    traces[0].judge = \"submitted\";\n    traces[0].finish_date = new Date;\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [trace[\"_id\"]];\n    newTrace.is_finished = true;\n    newTrace.step = next_step._id;\n    newTrace.name = next_step.name;\n    newTrace.start_date = new Date;\n    newTrace.finish_date = new Date;\n    upObj.submit_date = new Date;\n    upObj.state = \"completed\";\n    upObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n    upObj.code = flow.current_no + 1 + \"\";\n    instance.code = upObj.code;\n    instance.values = upObj.values;\n    upObj.name = uuflowManager.getInstanceName(instance);\n    upObj.modified = new Date;\n    upObj.modified_by = current_user;\n    upObj.inbox_users = [];\n    upObj.outbox_users = _.uniq([current_user, traces[0][\"approves\"][0][\"user\"]]);\n    traces.push(newTrace);\n    upObj.traces = traces;\n    upObj.finish_date = new Date;\n    upObj.current_step_name = next_step.name;\n    upObj.final_decision = \"approved\";\n    upObj.current_step_auto_submit = false;\n  } else {\n    next_step_users = approve[\"next_steps\"][0][\"users\"];\n    if ((!next_step_users) || (next_step_users.length === 0)) {\n      throw new Meteor.Error('error!', \"未指定下一步处理人\");\n    } else {\n      if (next_step_users.length > 1 && next_step.step_type !== \"counterSign\") {\n        throw new Meteor.Error('error!', \"不能指定多个处理人\");\n      } else {\n        checkUsers = getHandlersManager.getHandlers(instance_id, approve[\"next_steps\"][0][\"step\"]);\n        if (_.difference(next_step_users, checkUsers).length > 0) {\n          throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n        } else {\n          traces[0][\"approves\"][0].is_finished = true;\n          traces[0][\"approves\"][0].finish_date = new Date;\n          traces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date;\n          traces[0].is_finished = true;\n          traces[0].finish_date = new Date;\n          traces[0].judge = \"submitted\";\n          nextTrace = new Object;\n          nextTrace._id = new Mongo.ObjectID()._str;\n          nextTrace.instance = instance_id;\n          nextTrace.previous_trace_ids = [trace[\"_id\"]];\n          nextTrace.is_finished = false;\n          nextTrace.step = next_step._id;\n          nextTrace.name = next_step.name;\n          nextTrace.start_date = new Date;\n          nextTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n          nextTrace.approves = new Array;\n          updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          _.each(next_step_users, function(next_step_user_id, idx) {\n            var agent, handler_id, handler_info, nextApprove, next_step_space_user, next_step_user_org_info;\n            nextApprove = new Object;\n            nextApprove._id = new Mongo.ObjectID()._str;\n            user_info = uuflowManager.getUser(next_step_user_id);\n            handler_id = next_step_user_id;\n            handler_info = user_info;\n            agent = uuflowManager.getAgent(space_id, next_step_user_id);\n            if (agent) {\n              next_step_users[idx] = agent;\n              handler_id = agent;\n              handler_info = uuflowManager.getUser(agent);\n              nextApprove.agent = agent;\n            }\n            nextApprove.instance = instance_id;\n            nextApprove.trace = nextTrace._id;\n            nextApprove.is_finished = false;\n            nextApprove.user = next_step_user_id;\n            nextApprove.user_name = user_info.name;\n            nextApprove.handler = handler_id;\n            nextApprove.handler_name = handler_info.name;\n            next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            nextApprove.handler_organization = next_step_user_org_info[\"organization\"];\n            nextApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n            nextApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n            nextApprove.start_date = new Date;\n            nextApprove.due_date = nextTrace.due_date;\n            nextApprove.is_read = false;\n            nextApprove.is_error = false;\n            nextApprove.values = new Object;\n            uuflowManager.setRemindInfo(updated_values, nextApprove);\n            return nextTrace.approves.push(nextApprove);\n          });\n          upObj.name = instance_name;\n          upObj.submit_date = new Date;\n          upObj.state = \"pending\";\n          upObj.values = updated_values;\n          upObj.inbox_users = next_step_users;\n          upObj.modified = new Date;\n          upObj.modified_by = current_user;\n          upObj.code = flow.current_no + 1 + \"\";\n          instance.code = upObj.code;\n          instance.values = upObj.values;\n          upObj.name = uuflowManager.getInstanceName(instance);\n          traces.push(nextTrace);\n          upObj.traces = traces;\n          upObj.outbox_users = [];\n          upObj.current_step_name = next_step.name;\n          upObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n        }\n      }\n    }\n  }\n  upObj.keywords = uuflowManager.caculateKeywords(upObj.values, form, instance.form_version);\n  db.instances.update({\n    _id: instance_id\n  }, {\n    $set: upObj\n  });\n  db.flows.direct.update({\n    _id: flow._id\n  }, {\n    $set: {\n      current_no: flow.current_no + 1\n    }\n  });\n  if (next_step.step_type !== \"end\") {\n    instance = db.instances.findOne(instance_id);\n    pushManager.send_instance_notification(\"first_submit_applicant\", instance, \"\", user_info);\n    pushManager.send_instance_notification(\"first_submit_inbox\", instance, \"\", user_info);\n  }\n  return {};\n};\n\nuuflowManager.get_SpaceChangeSet = function(formids, is_admin, sync_token) {\n  var changeSet, formids_ary;\n  sync_token = new Date(Number(sync_token) * 1000);\n  changeSet = new Object;\n  changeSet.sync_token = new Date().getTime() / 1000;\n  changeSet.inserts = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  changeSet.updates = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  changeSet.deletes = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  if (formids && formids.trim()) {\n    formids_ary = formids.split(\",\");\n    changeSet.inserts.Instances = db.instances.find({\n      form: {\n        $in: formids_ary\n      },\n      created: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.updates.Instances = db.instances.find({\n      form: {\n        $in: formids_ary\n      },\n      created: {\n        $lte: sync_token\n      },\n      modified: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.deletes.Instances = db.deleted_instances.find({\n      form: {\n        $in: formids_ary\n      },\n      deleted: {\n        $gt: sync_token\n      }\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).fetch();\n  } else if (is_admin && is_admin.trim()) {\n    changeSet.inserts.Instances = db.instances.find({\n      created: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.updates.Instances = db.instances.find({\n      created: {\n        $lte: sync_token\n      },\n      modified: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.deletes.Instances = db.deleted_instances.find({\n      deleted: {\n        $gt: sync_token\n      }\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).fetch();\n  }\n  _.each(changeSet.inserts.Instances, function(ins) {\n    var applicant, submitter;\n    submitter = db.users.findOne({\n      _id: ins.submitter\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    applicant = db.users.findOne({\n      _id: ins.applicant\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    if (submitter) {\n      ins.submitter_steedos_id = submitter.steedos_id;\n    }\n    if (applicant) {\n      return ins.applicant_steedos_id = applicant.steedos_id;\n    }\n  });\n  _.each(changeSet.updates.Instances, function(ins) {\n    var applicant, submitter;\n    submitter = db.users.findOne({\n      _id: ins.submitter\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    applicant = db.users.findOne({\n      _id: ins.applicant\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    if (submitter) {\n      ins.submitter_steedos_id = submitter.steedos_id;\n    }\n    if (applicant) {\n      return ins.applicant_steedos_id = applicant.steedos_id;\n    }\n  });\n  return {\n    ChangeSet: changeSet\n  };\n};\n\n\n/* 文件催办\n根据instance.values.priority和instance.values.deadline给approve增加remind相关信息\n{\n\tdeadline: Date,\n\tremind_date: Date,\n\treminded_count: Number\n}\n */\n\nuuflowManager.setRemindInfo = function(values, approve) {\n  var caculate_date, deadline, flow, ins, priority, remind_date, start_date;\n  check(values, Object);\n  check(approve, Object);\n  check(approve.start_date, Date);\n  remind_date = null;\n  deadline = null;\n  start_date = approve.start_date;\n  if (values.priority && values.deadline) {\n    check(values.priority, Match.OneOf(\"普通\", \"办文\", \"紧急\", \"特急\"));\n    deadline = new Date(values.deadline);\n    if (deadline.toString() === \"Invalid Date\") {\n      return;\n    }\n    priority = values.priority;\n    if (priority === \"普通\") {\n      remind_date = Steedos.caculateWorkingTime(start_date, 3);\n    } else if (priority === \"办文\") {\n      if (Steedos.caculatePlusHalfWorkingDay(start_date) > deadline) {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true);\n      } else if (Steedos.caculateWorkingTime(start_date, 1) > deadline) {\n        caculate_date = function(base_date) {\n          var plus_halfday_date;\n          plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n          if (plus_halfday_date > deadline) {\n            remind_date = base_date;\n          } else {\n            caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n          }\n        };\n        caculate_date(start_date);\n      } else {\n        remind_date = Steedos.caculateWorkingTime(start_date, 1);\n      }\n    } else if (priority === \"紧急\" || priority === \"特急\") {\n      if (Steedos.caculatePlusHalfWorkingDay(start_date) > deadline) {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true);\n      } else if (Steedos.caculateWorkingTime(start_date, 1) > deadline) {\n        caculate_date = function(base_date) {\n          var plus_halfday_date;\n          plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n          if (plus_halfday_date > deadline) {\n            remind_date = base_date;\n          } else {\n            caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n          }\n        };\n        caculate_date(start_date);\n      } else {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date);\n      }\n      ins = db.instances.findOne(approve.instance);\n      if (ins.state === 'draft') {\n        flow = db.flows.findOne({\n          _id: ins.flow\n        }, {\n          fields: {\n            current_no: 1\n          }\n        });\n        ins.code = flow.current_no + 1 + '';\n      }\n      ins.values = values;\n      uuflowManager.sendRemindSMS(uuflowManager.getInstanceName(ins), deadline, [approve.user], ins.space, ins._id);\n    }\n  } else {\n    remind_date = Steedos.caculateWorkingTime(start_date, 3);\n  }\n  approve.deadline = deadline;\n  approve.remind_date = remind_date;\n  approve.reminded_count = 0;\n};\n\nuuflowManager.sendRemindSMS = function(ins_name, deadline, users_id, space_id, ins_id) {\n  var name, ref, send_users, skip_users;\n  check(ins_name, String);\n  check(deadline, Date);\n  check(users_id, Array);\n  check(space_id, String);\n  check(ins_id, String);\n  skip_users = ((ref = Meteor.settings.remind) != null ? ref.skip_users : void 0) || [];\n  send_users = [];\n  _.each(users_id, function(uid) {\n    if (!skip_users.includes(uid)) {\n      return send_users.push(uid);\n    }\n  });\n  name = ins_name.length > 15 ? ins_name.substr(0, 12) + '...' : ins_name;\n  return db.users.find({\n    _id: {\n      $in: _.uniq(send_users)\n    },\n    mobile: {\n      $exists: true\n    }\n  }, {\n    fields: {\n      mobile: 1,\n      utcOffset: 1,\n      locale: 1,\n      name: 1\n    }\n  }).forEach(function(user) {\n    var lang, notification, params, payload, utcOffset;\n    utcOffset = user.hasOwnProperty('utcOffset') ? user.utcOffset : 8;\n    params = {\n      instance_name: name,\n      deadline: moment(deadline).utcOffset(utcOffset).format('MM-DD HH:mm')\n    };\n    lang = 'en';\n    if (user.locale === 'zh-cn') {\n      lang = 'zh-CN';\n    }\n    SMSQueue.send({\n      Format: 'JSON',\n      Action: 'SingleSendSms',\n      ParamString: JSON.stringify(params),\n      RecNum: user.mobile,\n      SignName: 'OA系统',\n      TemplateCode: 'SMS_67200967',\n      msg: TAPi18n.__('sms.remind.template', {\n        instance_name: ins_name,\n        deadline: params.deadline,\n        open_app_url: Meteor.absoluteUrl() + (\"workflow.html?space_id=\" + space_id + \"&ins_id=\" + ins_id)\n      }, lang)\n    });\n    notification = new Object;\n    notification[\"createdAt\"] = new Date;\n    notification[\"createdBy\"] = '<SERVER>';\n    notification[\"from\"] = 'workflow';\n    notification['title'] = user.name;\n    notification['text'] = TAPi18n.__('instance.push.body.remind', {\n      instance_name: ins_name,\n      deadline: params.deadline\n    }, lang);\n    payload = new Object;\n    payload[\"space\"] = space_id;\n    payload[\"instance\"] = ins_id;\n    payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n    payload[\"requireInteraction\"] = true;\n    notification[\"payload\"] = payload;\n    notification['query'] = {\n      userId: user._id,\n      appName: 'workflow'\n    };\n    return Push.send(notification);\n  });\n};\n\nuuflowManager.checkMainAttach = function(instance_id, name) {\n  var file_name, ins, main, main_name_split, new_ins_name;\n  main = cfs.instances.findOne({\n    'metadata.instance': instance_id,\n    'metadata.main': true,\n    'metadata.current': true\n  });\n  if (main) {\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    new_ins_name = name || ins.name;\n    new_ins_name = new_ins_name.replace(/\\r/g, \"\").replace(/\\n/g, \"\");\n    new_ins_name = new_ins_name.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\");\n    main_name_split = main.name().split('.');\n    main_name_split.pop();\n    if (new_ins_name !== main_name_split.join(\"\")) {\n      file_name = new_ins_name + \".\" + main.extension();\n      return main.update({\n        $set: {\n          'original.name': file_name,\n          'copies.instances.name': file_name\n        }\n      });\n    }\n  }\n};\n\nuuflowManager.caculateKeywords = function(values, form, form_version) {\n  var form_v, keywords;\n  if (_.isEmpty(values)) {\n    return \"\";\n  }\n  keywords = [];\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  _.each(form_v.fields, function(field) {\n    var multiValue;\n    if (field.is_searchable) {\n      if (field.type === 'input' || field.type === 'email' || field.type === 'url' || field.type === 'number' || field.type === 'select' || field.type === 'radio') {\n        if (values[field.code]) {\n          return keywords.push(values[field.code]);\n        }\n      } else if (field.type === 'multiSelect') {\n        if (values[field.code]) {\n          return keywords.push(values[field.code]);\n        }\n      } else if (field.type === 'user' || field.type === 'group') {\n        if (field.is_multiselect === true) {\n          multiValue = values[field.code];\n          if (_.isArray(multiValue)) {\n            return _.each(multiValue, function(singleV) {\n              if (singleV && singleV['name']) {\n                return keywords.push(singleV['name']);\n              }\n            });\n          }\n        } else {\n          if (values[field.code] && values[field.code]['name']) {\n            return keywords.push(values[field.code]['name']);\n          }\n        }\n      }\n    } else if (field.type === 'table') {\n      if (values[field.code]) {\n        return _.each(values[field.code], function(s_value) {\n          return _.each(field.fields, function(s_field) {\n            if (s_field.is_searchable) {\n              if (s_field.type === 'input' || s_field.type === 'email' || s_field.type === 'url' || s_field.type === 'number' || s_field.type === 'select' || s_field.type === 'radio') {\n                if (s_value[s_field.code]) {\n                  return keywords.push(s_value[s_field.code]);\n                }\n              } else if (s_field.type === 'multiSelect') {\n                if (s_value[s_field.code]) {\n                  return keywords.push(s_value[s_field.code]);\n                }\n              } else if (s_field.type === 'user' || s_field.type === 'group') {\n                if (s_field.is_multiselect === true) {\n                  multiValue = s_value[s_field.code];\n                  if (_.isArray(multiValue)) {\n                    return _.each(multiValue, function(singleV) {\n                      if (singleV && singleV['name']) {\n                        return keywords.push(singleV['name']);\n                      }\n                    });\n                  }\n                } else {\n                  if (s_value[s_field.code] && s_value[s_field.code]['name']) {\n                    return keywords.push(s_value[s_field.code]['name']);\n                  }\n                }\n              }\n            }\n          });\n        });\n      }\n    } else if (field.type === 'section') {\n      return _.each(field.fields, function(s_field) {\n        if (s_field.is_searchable) {\n          if (s_field.type === 'input' || s_field.type === 'email' || s_field.type === 'url' || s_field.type === 'number' || s_field.type === 'select' || s_field.type === 'radio') {\n            if (values[s_field.code]) {\n              return keywords.push(values[s_field.code]);\n            }\n          } else if (s_field.type === 'multiSelect') {\n            if (values[s_field.code]) {\n              return keywords.push(values[s_field.code]);\n            }\n          } else if (s_field.type === 'user' || s_field.type === 'group') {\n            if (s_field.is_multiselect === true) {\n              multiValue = values[s_field.code];\n              if (_.isArray(multiValue)) {\n                return _.each(multiValue, function(singleV) {\n                  if (singleV && singleV['name']) {\n                    return keywords.push(singleV['name']);\n                  }\n                });\n              }\n            } else {\n              if (values[s_field.code] && values[s_field.code]['name']) {\n                return keywords.push(values[s_field.code]['name']);\n              }\n            }\n          }\n        }\n      });\n    }\n  });\n  return keywords.join(\" \");\n};\n\nuuflowManager.checkValueFieldsRequire = function(values, form, form_version) {\n  var form_v, require_but_empty_fields;\n  values = values || {};\n  require_but_empty_fields = [];\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  _.each(form_v.fields, function(field) {\n    if (field.type !== 'table') {\n      if (field.is_required && _.isEmpty(values[field.code])) {\n        return require_but_empty_fields.push(field.name || field.code);\n      }\n    } else if (field.type === 'table') {\n      if (_.isEmpty(values[field.code])) {\n        return _.each(field.fields, function(s_field) {\n          if (s_field.is_required) {\n            return require_but_empty_fields.push(s_field.name || s_field.code);\n          }\n        });\n      } else {\n        return _.each(values[field.code], function(s_value) {\n          return _.each(field.fields, function(s_field) {\n            if (s_field.is_required && _.isEmpty(s_value[s_field.code])) {\n              return require_but_empty_fields.push(s_field.name || s_field.code);\n            }\n          });\n        });\n      }\n    }\n  });\n  return require_but_empty_fields;\n};\n\nuuflowManager.triggerRecordInstanceQueue = function(ins_id, record_ids, step_name) {\n  var newObj, ref;\n  if ((ref = Meteor.settings.cron) != null ? ref.instancerecordqueue_interval : void 0) {\n    newObj = {\n      info: {\n        instance_id: ins_id,\n        records: record_ids,\n        step_name: step_name,\n        instance_finish_date: new Date()\n      },\n      sent: false,\n      sending: 0,\n      createdAt: new Date(),\n      createdBy: '<SERVER>'\n    };\n    db.instance_record_queue.insert(newObj);\n  }\n};\n\nuuflowManager.distributedInstancesRemind = function(instance) {\n  var current_trace, e, flow, lang, next_approves, next_step, next_step_id, notification, original_flow, original_instacne, original_instacne_id, original_user, payload, ref, ref1, ref2;\n  if ((instance != null ? (ref = instance.distribute_from_instances) != null ? ref.length : void 0 : void 0) > 0) {\n    flow = db.flows.findOne({\n      _id: instance != null ? instance.flow : void 0\n    });\n    current_trace = instance[\"traces\"].pop();\n    if ((instance != null ? instance.state : void 0) === \"draft\") {\n      next_approves = current_trace != null ? current_trace.approves : void 0;\n      if ((next_approves != null ? next_approves.length : void 0) === 1) {\n        next_step = (ref1 = next_approves[0]) != null ? ref1.next_steps[0] : void 0;\n        next_step_id = next_step != null ? next_step.step : void 0;\n      }\n    } else {\n      next_step_id = current_trace != null ? current_trace.step : void 0;\n    }\n    if (next_step_id) {\n      next_step = uuflowManager.getStep(instance, flow, next_step_id);\n      if ((next_step != null ? next_step.step_type : void 0) === \"end\") {\n        original_instacne_id = instance != null ? (ref2 = instance.distribute_from_instances) != null ? ref2.pop() : void 0 : void 0;\n        original_instacne = db.instances.findOne({\n          _id: original_instacne_id\n        }, {\n          fields: {\n            flow: 1,\n            name: 1,\n            space: 1,\n            created_by: 1\n          }\n        });\n        original_flow = db.flows.findOne({\n          _id: original_instacne != null ? original_instacne.flow : void 0\n        }, {\n          fields: {\n            distribute_end_notification: 1\n          }\n        });\n        if ((original_flow != null ? original_flow.distribute_end_notification : void 0) === true) {\n          try {\n            original_user = db.users.findOne({\n              _id: instance != null ? instance.created_by : void 0\n            });\n            lang = 'en';\n            if ((original_user != null ? original_user.locale : void 0) === 'zh-cn') {\n              lang = 'zh-CN';\n            }\n            notification = new Object;\n            notification[\"createdAt\"] = new Date;\n            notification[\"createdBy\"] = '<SERVER>';\n            notification[\"from\"] = 'workflow';\n            notification['title'] = original_user.name;\n            notification['text'] = TAPi18n.__('instance.push.body.distribute_remind', {\n              instance_name: instance != null ? instance.name : void 0\n            }, lang);\n            payload = new Object;\n            payload[\"space\"] = original_instacne != null ? original_instacne.space : void 0;\n            payload[\"instance\"] = original_instacne != null ? original_instacne._id : void 0;\n            payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n            payload[\"requireInteraction\"] = true;\n            notification[\"payload\"] = payload;\n            notification['query'] = {\n              userId: original_user._id,\n              appName: 'workflow'\n            };\n            Push.send(notification);\n          } catch (error) {\n            e = error;\n            console.error(e.stack);\n          }\n        }\n      }\n    }\n  }\n};\n\nuuflowManager.getAgent = function(spaceId, fromId) {\n  var now, r;\n  now = new Date();\n  r = db.process_delegation_rules.findOne({\n    space: spaceId,\n    from: fromId,\n    enabled: true,\n    start_time: {\n      $lte: now\n    },\n    end_time: {\n      $gte: now\n    }\n  });\n  return r != null ? r.to : void 0;\n};\n\nuuflowManager.cancelProcessDelegation = function(spaceId, toId) {\n  var ccQuery, query;\n  query = {\n    space: spaceId,\n    inbox_users: toId\n  };\n  query.traces = {\n    $elemMatch: {\n      is_finished: false,\n      approves: {\n        $elemMatch: {\n          is_finished: false,\n          agent: toId\n        }\n      }\n    }\n  };\n  db.instances.find(query, {\n    fields: {\n      inbox_users: 1,\n      traces: 1,\n      state: 1\n    }\n  }).forEach(function(ins) {\n    var trace;\n    trace = _.find(ins.traces, function(t) {\n      return t.is_finished === false;\n    });\n    return _.each(trace.approves, function(a, idx) {\n      var idxStr, next_step_space_user, next_step_user_org_info, setObj;\n      if (a.is_finished === false) {\n        if (a.agent === toId) {\n          next_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user);\n          next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n          idxStr = \"traces.$.approves.\" + idx + \".\";\n          setObj = {};\n          setObj[idxStr + 'handler'] = a.user;\n          setObj[idxStr + 'handler_name'] = a.user_name;\n          setObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"];\n          setObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"];\n          setObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"];\n          setObj[idxStr + 'agent'] = null;\n          ins.inbox_users.splice(ins.inbox_users.indexOf(toId), 1, a.user);\n          setObj.inbox_users = ins.inbox_users;\n          if (ins.state === 'draft') {\n            setObj.submitter = a.user;\n            setObj.submitter_name = a.user_name;\n          }\n          db.instances.update({\n            _id: ins._id,\n            inbox_users: toId,\n            'traces._id': a.trace\n          }, {\n            $set: setObj\n          });\n          pushManager.send_message_to_specifyUser('current_user', a.user);\n          return pushManager.send_message_to_specifyUser('current_user', toId);\n        } else if (a.user === toId) {\n          return db.instances.update({\n            _id: ins._id\n          }, {\n            $addToSet: {\n              inbox_users: toId\n            }\n          });\n        }\n      }\n    });\n  });\n  ccQuery = {\n    space: spaceId,\n    cc_users: toId\n  };\n  ccQuery['traces.approves'] = {\n    $elemMatch: {\n      is_finished: false,\n      agent: toId,\n      type: 'cc'\n    }\n  };\n  return db.instances.find(ccQuery, {\n    fields: {\n      cc_users: 1,\n      traces: 1\n    }\n  }).forEach(function(ins) {\n    return _.each(ins.traces, function(t) {\n      return _.each(t.approves, function(a, idx) {\n        var idxStr, next_step_space_user, next_step_user_org_info, setObj;\n        if (a.is_finished === false && a.type === 'cc') {\n          if (a.agent === toId) {\n            next_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user);\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            idxStr = \"traces.$.approves.\" + idx + \".\";\n            setObj = {};\n            setObj[idxStr + 'handler'] = a.user;\n            setObj[idxStr + 'handler_name'] = a.user_name;\n            setObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"];\n            setObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"];\n            setObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"];\n            setObj[idxStr + 'agent'] = null;\n            ins.cc_users.splice(ins.cc_users.indexOf(toId), 1, a.user);\n            setObj.cc_users = ins.cc_users;\n            db.instances.update({\n              _id: ins._id,\n              cc_users: toId,\n              'traces._id': a.trace\n            }, {\n              $set: setObj\n            });\n            pushManager.send_message_to_specifyUser('current_user', a.user);\n            return pushManager.send_message_to_specifyUser('current_user', toId);\n          } else if (a.user === toId) {\n            return db.instances.update({\n              _id: ins._id\n            }, {\n              $addToSet: {\n                cc_users: toId\n              }\n            });\n          }\n        }\n      });\n    });\n  });\n};\n\nuuflowManager.timeoutAutoSubmit = function(ins_id) {\n  var query;\n  query = {};\n  if (ins_id) {\n    check(ins_id, String);\n    query._id = ins_id;\n  }\n  query.state = 'pending';\n  query.current_step_auto_submit = true;\n  query.traces = {\n    $elemMatch: {\n      is_finished: false,\n      due_date: {\n        $lte: new Date\n      }\n    }\n  };\n  db.instances.find(query).forEach(function(ins) {\n    var approve_from_client, e, flow, flow_id, instance_id, judge, nextStep, nextStepId, nextSteps, nextUserIds, step, step_type, toLine, trace;\n    try {\n      flow_id = ins.flow;\n      instance_id = ins._id;\n      trace = _.last(ins.traces);\n      flow = uuflowManager.getFlow(flow_id);\n      step = uuflowManager.getStep(ins, flow, trace.step);\n      step_type = step.step_type;\n      toLine = _.find(step.lines, function(l) {\n        return l.timeout_line === true;\n      });\n      nextStepId = toLine.to_step;\n      nextStep = uuflowManager.getStep(ins, flow, nextStepId);\n      if (nextStep.step_type === 'condition') {\n        nextSteps = uuflowManager.getNextSteps(ins, flow, nextStep, \"\");\n        console.error(nextSteps);\n        nextStepId = nextSteps[0];\n      }\n      nextUserIds = getHandlersManager.getHandlers(instance_id, nextStepId);\n      judge = \"submitted\";\n      if (step_type === \"sign\") {\n        judge = \"approved\";\n      }\n      approve_from_client = {\n        'instance': instance_id,\n        'trace': trace._id,\n        'judge': judge,\n        'next_steps': [\n          {\n            'step': nextStepId,\n            'users': nextUserIds\n          }\n        ]\n      };\n      return _.each(trace.approves, function(a) {\n        var current_user_info, updatedInstance;\n        approve_from_client._id = a._id;\n        current_user_info = db.users.findOne(a.handler, {\n          services: 0\n        });\n        updatedInstance = uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user_info._id, true);\n        return pushManager.send_instance_notification(\"auto_submit_pending_inbox\", updatedInstance, \"\", current_user_info);\n      });\n    } catch (error) {\n      e = error;\n      console.error('AUTO TIMEOUT_AUTO_SUBMIT ERROR: ');\n      return console.error(e.stack);\n    }\n  });\n  return true;\n};\n","pushManager = {\r\n\tbqq_app_id: \"200626779\",\r\n\timo_app_cid: Meteor.settings.imo?.appcid,\r\n\timo_app_uid: Meteor.settings.imo?.appuid,\r\n\timo_sync_app_key: Meteor.settings.imo?.sync_app_key,\r\n\timo_push_app_key: Meteor.settings.imo?.push_app_key\r\n}\r\n\r\npushManager.get_to_users = (send_from, instance, cc_user_ids, current_user_info) ->\r\n\tto_users = new Array\r\n\tif ['first_submit_applicant'].includes(send_from)\r\n\t\t# 申请人\r\n\t\tif instance.applicant isnt instance.submitter\r\n\t\t\tapplicant = db.users.findOne(instance.applicant)\r\n\t\t\tto_users.push(applicant)\r\n\r\n\telse if ['submit_terminate_approve', 'submit_completed_approve', 'submit_pending_rejected_approve','approved_completed_approve', 'rejected_completed_approve'].includes(send_from)\r\n\t\t# 已审批人\r\n\t\t# 获得已审批的人(去掉重复及申请人、提交人)\r\n\t\tremove_users = new Array\r\n\t\tremove_users.push(instance.applicant)\r\n\t\tremove_users.push(instance.submitter)\r\n\r\n\t\tapprove_user_ids = _.difference(instance.outbox_users, remove_users)\r\n\t\tto_users = db.users.find({ _id: { $in: approve_user_ids } }).fetch()\r\n\telse if ['reassign_new_inbox_users', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)\r\n\t\t# 待审批人\r\n\t\tto_users = db.users.find({ _id: { $in: instance.inbox_users } }).fetch()\r\n\telse if ['submit_completed_applicant', 'approved_completed_applicant', 'rejected_completed_applicant', 'monitor_delete_applicant', 'submit_terminate_applicant', 'submit_pending_rejected_applicant', 'submit_pending_rejected_applicant_inbox'].includes(send_from)\r\n\t\tapplicant = db.users.findOne(instance.applicant)\r\n\t\tto_users.push(applicant)\r\n\telse if ['trace_approve_cc'].includes(send_from) && cc_user_ids\r\n\t\tto_users = db.users.find({ _id: { $in: cc_user_ids } }).fetch()\r\n\telse if ['trace_approve_cc_submit'].includes(send_from) && cc_user_ids\r\n\t\tto_users = db.users.find({ _id: { $in: cc_user_ids } }).fetch()\r\n\telse if ['auto_submit_pending_inbox'].includes(send_from)\r\n\t\tto_users = [current_user_info]\r\n\r\n\treturn to_users\r\n\r\npushManager.get_body = (parameters, lang = \"zh-CN\") ->\r\n\tsend_from = parameters[\"send_from\"]\r\n\tapplicant_name = parameters[\"applicant_name\"]\r\n\tinstance_name = parameters[\"instance_name\"]\r\n\tto_username = parameters[\"to_username\"]\r\n\thref = parameters[\"href\"]\r\n\tfinal_decision = parameters[\"final_decision\"]\r\n\tdescription = parameters[\"description\"]\r\n\tstate = parameters[\"state\"]\r\n\tfrom_username = parameters[\"from_username\"]\r\n\tcurrent_step_name = parameters[\"current_step_name\"]\r\n\tnextApprove_usersname = parameters[\"nextApprove_usersname\"]\r\n\tnextStep_type = parameters[\"nextStep_type\"]\r\n\tapproves_description = parameters[\"approves_description\"]\r\n\tlastApprove_judge = parameters[\"lastApprove_judge\"]\r\n\tlastApprove_usersname = parameters[\"lastApprove_usersname\"]\r\n\tcurrent_user_name = parameters[\"current_user_name\"]\r\n\tcurrentStep_type = parameters[\"currentStep_type\"]\r\n\r\n\tpush_final_decision = \"\"\r\n\temail_final_decision = \"\"\r\n\temail_description = \"\"\r\n\r\n\tif not final_decision\r\n\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_nil', {}, lang\r\n\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_nil', {}, lang\r\n\telse\r\n\t\tif \"approved\" is final_decision\r\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_approved', {}, lang\r\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_approved', {}, lang\r\n\t\telse if \"rejected\" is final_decision\r\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_rejected', {}, lang\r\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_rejected', {}, lang\r\n\t\t\temail_description = TAPi18n.__ 'instance.email.body.email_description', {description: description}, lang\r\n\t\telse\r\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_nil', {}, lang\r\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_nil', {}, lang\r\n\r\n\temail_approve_type = null\r\n\turl_approve_type = null\r\n\tpush_approve_type = null\r\n\r\n\tif ['submit', 'start'].includes(nextStep_type)\r\n\t\temail_approve_type = TAPi18n.__ 'instance.email.body.input', {}, lang\r\n\t\turl_approve_type = TAPi18n.__ 'instance.email.body.url_input', {}, lang\r\n\t\tpush_approve_type = TAPi18n.__ 'instance.push.body.input', {}, lang\r\n\telse if ['sign', 'counterSign'].includes(nextStep_type)\r\n\t\temail_approve_type = TAPi18n.__ 'instance.email.body.approval', {}, lang\r\n\t\turl_approve_type = TAPi18n.__ 'instance.email.body.url_approval', {}, lang\r\n\t\tpush_approve_type = TAPi18n.__ 'instance.push.body.approval', {}, lang\r\n\r\n\tlast_approve_judge = null\r\n\tif \"submitted\" is lastApprove_judge\r\n\t\tlast_approve_judge = TAPi18n.__ 'instance.email.body.judge_submitted', {}, lang\r\n\telse if \"approved\" is lastApprove_judge\r\n\t\tlast_approve_judge = TAPi18n.__ 'instance.email.body.judge_approved', {}, lang\r\n\r\n\tbody = new Object\r\n\tif \"first_submit_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.first_submit_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\r\n\t\tif not approves_description\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_applicant', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\t\telse\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approves_description: approves_description}, lang\r\n\r\n\telse if \"first_submit_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.first_submit_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\r\n\r\n\t\tif not approves_description\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type}, lang\r\n\t\telse\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_inbox_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,approves_description: approves_description}, lang\r\n\r\n\telse if \"submit_completed_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tif not approves_description\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\r\n\t\telse\r\n\t\t\tif currentStep_type == \"counterSign\"\r\n\t\t\t\tbody[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription_counterSign', {instance_name: instance_name,to_username: to_username, current_username: current_user_name,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang) + approves_description + TAPi18n.__('help.href', {href: href}, lang)\r\n\t\t\telse\r\n\t\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,approves_description: approves_description}, lang\r\n\r\n\telse if \"submit_completed_approve\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\telse if \"submit_pending_rejected_applicant_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_applicant_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_applicant_inbox', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\r\n\telse if \"submit_pending_rejected_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,nextApprove_usersname: nextApprove_usersname}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,nextApprove_usersname: nextApprove_usersname}, lang\r\n\telse if \"submit_pending_rejected_approve\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,current_user: current_user_name,nextApprove_usersname: nextApprove_usersname,current_step_name: current_step_name}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\telse if \"submit_pending_rejected_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname}, lang\r\n\telse if \"submit_pending_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\r\n\r\n\t\tif not approves_description\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge}, lang\r\n\t\telse\r\n\t\t\tif currentStep_type == \"counterSign\"\r\n\t\t\t\tbody[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription_counterSign', {instance_name: instance_name,to_username: to_username,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge}, lang) + approves_description + TAPi18n.__('help.href', {href: href}, lang)\r\n\t\t\telse\r\n\t\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_inbox_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge,approves_description: approves_description}, lang\r\n\r\n\telse if \"submit_terminate_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_terminate_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_terminate_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description}, lang\r\n\telse if \"submit_terminate_approve\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_terminate_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_terminate_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description}, lang\r\n\telse if \"monitor_delete_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.monitor_delete_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.monitor_delete_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\telse if \"approved_completed_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.approved_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\r\n\t\tif not approves_description\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\r\n\t\telse\r\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,approves_description: approves_description}, lang\r\n\r\n\telse if \"approved_completed_approve\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.approved_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\telse if \"rejected_completed_applicant\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.rejected_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.rejected_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\r\n\telse if \"rejected_completed_approve\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.rejected_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.rejected_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\r\n\telse if \"reassign_new_inbox_users\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.reassign_new_inbox_users', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,current_user_name: current_user_name,url_approve_type: url_approve_type,approve_type: push_approve_type}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.reassign_new_inbox_users', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description,current_user_name: current_user_name,url_approve_type: url_approve_type,approve_type: email_approve_type}, lang\r\n\telse if \"trace_approve_cc\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.trace_approve_cc', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.trace_approve_cc', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type}, lang\r\n\telse if \"trace_approve_cc_submit\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.trace_approve_cc_submit', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type, current_user_name: current_user_name}, lang\r\n\telse if \"auto_submit_pending_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.auto_submit_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.auto_submit_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name, to_username: to_username}, lang\r\n\telse if \"return_pending_inbox\" is send_from\r\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.return_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name}, lang\r\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.return_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name, to_username: to_username}, lang\r\n\treturn body\r\n\r\npushManager.get_title = (parameters, lang=\"zh-CN\")->\r\n\tsend_from = parameters[\"send_from\"]\r\n\tinstance_name = parameters[\"instance_name\"]\r\n\tfrom_username = parameters[\"from_username\"]\r\n\tapplicant_name = parameters[\"applicant_name\"]\r\n\tcurrent_step_name = parameters[\"current_step_name\"]\r\n\tnextApprove_usersname = parameters[\"nextApprove_usersname\"]\r\n\tnextStep_type = parameters[\"nextStep_type\"]\r\n\r\n\tapprove_type = null\r\n\r\n\tif ['submit', 'start'].includes(nextStep_type)\r\n\t\tapprove_type = TAPi18n.__('instance.email.title.input', {}, lang)\r\n\telse if ['sign', 'counterSign'].includes(nextStep_type)\r\n\t\tapprove_type = TAPi18n.__('instance.email.title.approval', {}, lang)\r\n\r\n\ttitle = new Object\r\n\tif \"first_submit_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.first_submit_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.first_submit_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"first_submit_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.first_submit_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.first_submit_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"submit_completed_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"submit_completed_approve\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"submit_pending_rejected_applicant_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_applicant_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_applicant_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"submit_pending_rejected_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,nextApprove_usersname: nextApprove_usersname}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,nextApprove_usersname: nextApprove_usersname}, lang\r\n\telse if \"submit_pending_rejected_approve\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,current_user: current_user_name,nextApprove_usersname: nextApprove_usersname,current_step_name: current_step_name}, lang\r\n\telse if \"submit_pending_rejected_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"submit_pending_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"submit_terminate_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_terminate_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_terminate_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"submit_terminate_approve\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_terminate_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_terminate_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"monitor_delete_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.monitor_delete_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.monitor_delete_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"approved_completed_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.approved_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.approved_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"approved_completed_approve\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.approved_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.approved_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"rejected_completed_applicant\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.rejected_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.rejected_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"rejected_completed_approve\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.rejected_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.rejected_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"reassign_new_inbox_users\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.reassign_new_inbox_users', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.reassign_new_inbox_users', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"trace_approve_cc\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.trace_approve_cc', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.trace_approve_cc', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"trace_approve_cc_submit\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.trace_approve_cc_submit', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\telse if \"auto_submit_pending_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.auto_submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.auto_submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\telse if \"return_pending_inbox\" is send_from\r\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.return_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\r\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.return_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\r\n\treturn title\r\n\r\npushManager.get_badge = (send_from, user_id)->\r\n\tif not ['first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'current_user', 'terminate_approval', 'reassign_new_inbox_users', 'trace_approve_cc', 'trace_approve_cc_submit', 'auto_submit_pending_inbox', 'return_pending_inbox'].includes(send_from)\r\n\t\treturn null\r\n\r\n\tbadge = 0\r\n\tuser_spaces = db.space_users.find(\r\n\t\tuser: user_id\r\n\t\tuser_accepted: true, {fields: {space: 1}})\r\n\tuser_spaces.forEach (user_space) ->\r\n\t\tc = db.instances.find(\r\n\t\t\tspace: user_space.space\r\n\t\t\tstate: $in: [\r\n\t\t\t\t'pending'\r\n\t\t\t\t'completed'\r\n\t\t\t\t'draft'\r\n\t\t\t]\r\n\t\t\t$or: [\r\n\t\t\t\t{ inbox_users: user_id }\r\n\t\t\t\t{ cc_users: user_id }\r\n\t\t\t], {fields: {_id: 1}}).count()\r\n\t\tbadge += c\r\n\t\tsk = db.steedos_keyvalues.findOne(\r\n\t\t\tuser: user_id\r\n\t\t\tspace: user_space.space\r\n\t\t\tkey: 'badge', {fields: {_id: 1, value: 1}})\r\n\t\tif sk\r\n\t\t\tif sk.value?.workflow != c\r\n\t\t\t\tdb.steedos_keyvalues.update { _id: sk._id }, $set: 'value.workflow': c\r\n\t\telse\r\n\t\t\tsk_new = {}\r\n\t\t\tsk_new.user = user_id\r\n\t\t\tsk_new.space = user_space.space\r\n\t\t\tsk_new.key = 'badge'\r\n\t\t\tsk_new.value = 'workflow': c\r\n\t\t\tdb.steedos_keyvalues.insert sk_new\r\n\tsk_all = db.steedos_keyvalues.findOne(\r\n\t\tuser: user_id\r\n\t\tspace: null\r\n\t\tkey: 'badge', {fields: {_id: 1}})\r\n\tif sk_all\r\n\t\tdb.steedos_keyvalues.update { _id: sk_all._id }, $set: 'value.workflow': badge\r\n\telse\r\n\t\tsk_all_new = {}\r\n\t\tsk_all_new.user = user_id\r\n\t\tsk_all_new.space = null\r\n\t\tsk_all_new.key = 'badge'\r\n\t\tsk_all_new.value = 'workflow': badge\r\n\t\tdb.steedos_keyvalues.insert sk_all_new\r\n\treturn badge\r\n\r\n# 发送消息和badge到imo客户端\r\npushManager.send_to_imo = (steedos_ids, body, current_user_info)->\r\n\ttry\r\n\t\tif not current_user_info.imo_uid\r\n\t\t\treturn\r\n\r\n\t\tfromuid = current_user_info.imo_uid\r\n\t\tspace_u = db.space_users.findOne({ user: current_user_info._id }, { fields: { space: 1 } })\r\n\t\tspace = db.spaces.findOne(space_u[\"space\"])\r\n\t\tfromcid = space[\"imo_cid\"]\r\n\t\tif not fromcid\r\n\t\t\treturn\r\n\r\n\t\tusers = new Array\r\n\t\tdb.users.find({ steedos_id: { $in: steedos_ids } }, { fields: { imo_uid: 1 } }).forEach (u)->\r\n\t\t\th = new Object\r\n\t\t\th[\"cid\"] = fromcid\r\n\t\t\th[\"uid\"] = u[\"imo_uid\"]\r\n\t\t\tusers.push(h)\r\n\r\n\t\t# 发送badge\r\n\t\tif body[\"badge\"]\r\n\t\t\tappmsg = new Object\r\n\t\t\tappmsg[\"ver\"] = \"1.0\"\r\n\t\t\tappmsg[\"tranid\"] = (Math.round(new Date().getTime()/1000)).toString()\r\n\t\t\tappmsg[\"protocol\"] = \"workbench_pc_web\"\r\n\t\t\tcon = new Object\r\n\t\t\tcon[\"appname\"] = this.imo_sync_app_key\r\n\t\t\tcon[\"type\"] = \"app\"\r\n\t\t\tcon[\"ico\"] = \"\"\r\n\t\t\tcon[\"count\"] = body[\"badge\"].to_s\r\n\t\t\tappmsg[\"contents\"] = [con]\r\n\t\t\tres_b = HTTP.post(\r\n\t\t\t\t'http://open.imoffice.com:8000/',\r\n\t\t\t\t{\r\n\t\t\t\t\tparams:\r\n\t\t\t\t\t\tapp: \"appnoticeopen\",\r\n\t\t\t\t\t\tpushtype: \"2\",\r\n\t\t\t\t\t\tfromcid: fromcid,\r\n\t\t\t\t\t\tfromuid: fromuid,\r\n\t\t\t\t\t\tappcid: this.imo_app_cid,\r\n\t\t\t\t\t\tappuid: this.imo_app_uid,\r\n\t\t\t\t\t\tappkey: this.imo_sync_app_key,\r\n\t\t\t\t\t\ttappkey: this.imo_sync_app_key,\r\n\t\t\t\t\t\tusers: JSON.stringify(users),\r\n\t\t\t\t\t\tappmsg: JSON.stringify(appmsg)\r\n\t\t\t\t}\r\n\t\t\t)\r\n\t\t\tres_badge = res_b.content\r\n\t\t\tif res_badge and res_badge[\"result\"] is \"false\"\r\n\t\t\t\tconsole.error \"send_to_imo 发送消息失败:\" + (res_badge[\"msg\"] || res_badge[\"info\"])\r\n\t\t# 发送msg\r\n\t\tif body[\"alertTitle\"]\r\n\t\t\tmsg = new Object\r\n\t\t\tmsg[\"ver\"] = \"1.0\"\r\n\t\t\tmsg[\"title\"] = \"新消息: \"+body[\"alertTitle\"]\r\n\t\t\tmsg[\"img\"] = \"http:\\/\\/imoapp.imoffice.com:1863\\/WorkBench/Manage\\/Images\\/24bc3fef811a017771038323d80a6cae_170519a.png\"\r\n\t\t\tmsg[\"desc\"] = body[\"alert\"]\r\n\t\t\tmsg[\"lnk\"] = Meteor.absoluteUrl() + \"se/imo/login?appkey=#{this.imo_sync_app_key}\"\r\n\t\t\tres_m = HTTP.post(\r\n\t\t\t\t'http://open.imoffice.com:5186/index.php',\r\n\t\t\t\t{\r\n\t\t\t\t\tparams:\r\n\t\t\t\t\t\tapp: \"sendmsg\",\r\n\t\t\t\t\t\tpushtype: \"2\",\r\n\t\t\t\t\t\tfromcid: fromcid,\r\n\t\t\t\t\t\tfromuid: fromuid,\r\n\t\t\t\t\t\tappcid: this.imo_app_cid,\r\n\t\t\t\t\t\tappuid: this.imo_app_uid,\r\n\t\t\t\t\t\tappkey: this.imo_push_app_key,\r\n\t\t\t\t\t\tusers: JSON.stringify(users),\r\n\t\t\t\t\t\tmsg: JSON.stringify(msg),\r\n\t\t\t\t\t\tpoptype: \"1\",\r\n\t\t\t\t\t\tchart: \"\"\r\n\t\t\t\t}\r\n\t\t\t)\r\n\t\t\tres_msg = res_m.content\r\n\t\t\tif res_msg and res_msg[\"result\"] is \"false\"\r\n\t\t\t\tconsole.error \"send_to_imo 发送消息失败:\" + (res_msg[\"msg\"] || res_msg[\"info\"])\r\n\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\n# 发送消息到qq\r\npushManager.send_to_qq = (to_user, from_user, space_id, instance_id, instance_state, body, i18n_obj)->\r\n\ttry\r\n\t\tif (not to_user.services) or (not to_user.services['bqq']) or (not to_user.services['bqq']['id'])\r\n\t\t\treturn\r\n\r\n\t\tspace = db.spaces.findOne({ _id: space_id, \"services.bqq.company_id\": { $ne: null } }, { fields: { services: 1 } })\r\n\t\tif not space\r\n\t\t\treturn\r\n\r\n\t\tapp_id = this.bqq_app_id\r\n\t\topen_id = from_user.services['bqq']['id']\r\n\t\temployee_access_token = from_user.services['bqq']['accessToken']\r\n\t\trecv_open_ids = to_user.services['bqq']['id']\r\n\t\toauth = space['services']['bqq']\r\n\r\n\t\tbox = \"inbox\"\r\n\t\tif instance_state is \"completed\"\r\n\t\t\tbox = \"completed\"\r\n\r\n\t\ttips_url = '/workflow/space/'+space_id+'/'+box+'/'+instance_id\r\n\r\n\t\tbqq_uri = encodeURI('https://openapi.b.qq.com/api/combomsg/send?company_id='+oauth['company_id']+'&company_token='+oauth['company_token']+'&app_id='+app_id+'&client_ip=0.0.0.0'+'&oauth_version=2'+'&employee_access_token='+employee_access_token+'&brief='+body['alert']+'&url='+tips_url+'&type=picture'+'&title='+body['alert']+'&summary='+body['alertTitle']+'&recv_open_ids='+recv_open_ids+'&open_id='+open_id)\r\n\r\n\t\tresponse = HTTP.post(bqq_uri)\r\n\r\n\t\tif response.data.ret > 0\r\n\t\t\tconsole.error response.data.msg\r\n\r\n\t\treturn\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\npushManager.send_email_to_SMTP = (subject, content, to_user, reply_user)->\r\n\tif not to_user.email or not to_user.email_notification\r\n\t\treturn\r\n\ttry\r\n\t\tMailQueue.send\r\n\t\t\tto: to_user.email\r\n\t\t\tfrom: pushManager.checkMailFromNameLength(reply_user.name) + ' on ' + Meteor.settings.email.from\r\n\t\t\tsubject: subject\r\n\t\t\thtml: content\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\npushManager.checkMailFromNameLength = (name)->\r\n\treturn if name.length <= 18 then name else name.substr(0, 18) + '...'\r\n\r\npushManager.send_message_by_raix_push = (data)->\r\n\tif not data[\"data\"]\r\n\t\treturn\r\n\ttry\r\n\t\tnotification = new Object\r\n\t\tnotification[\"createdAt\"] = new Date\r\n\t\tnotification[\"createdBy\"] = '<SERVER>'\r\n\t\tnotification[\"from\"] = data[\"pushTopic\"]\r\n\t\tnotification['title'] = if data[\"data\"][\"alertTitle\"] then data[\"data\"][\"alertTitle\"] else \"\"\r\n\t\tnotification['text'] = if data[\"data\"][\"alert\"] then data[\"data\"][\"alert\"] else \"\"\r\n\r\n\t\tif data[\"data\"][\"space_id\"] and data[\"data\"][\"instance_id\"]\r\n\t\t\tpayload = new Object\r\n\t\t\tpayload[\"space\"] = data[\"data\"][\"space_id\"]\r\n\t\t\tpayload[\"instance\"] = data[\"data\"][\"instance_id\"]\r\n\t\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length-1)\r\n\r\n\t\t\tnotification[\"payload\"] = payload\r\n\r\n\t\tif data[\"data\"][\"badge\"] > -1\r\n\t\t\tnotification['badge'] = data[\"data\"][\"badge\"]\r\n\r\n\t\t_.each data[\"toUsers\"], (u) ->\r\n\t\t\tuser = db.users.findOne({ steedos_id: u }, { fields: { _id: 1 } })\r\n\t\t\tif user\r\n\t\t\t\tnotification['query'] = {userId: user._id, appName: data[\"pushTopic\"]}\r\n\t\t\t\tPush.send(notification)\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\n#steedos_ids 必须为数组 ； body 如果有，则必须为Hash\r\npushManager.send_message = (steedos_ids, body, current_user_info)->\r\n\tif not steedos_ids or not (steedos_ids instanceof Array)\r\n\t\treturn\r\n\tdata = new Object\r\n\tdata[\"toUsers\"]  = steedos_ids\r\n\tdata[\"pushTopic\"] = 'workflow'\r\n\tdata[\"data\"] = body  if body\r\n\r\n\tpushManager.send_message_by_raix_push(data)\r\n\r\n\tpushManager.send_to_imo(steedos_ids, body, current_user_info) if body\r\n\r\n#通知服务\r\npushManager.send_instance_notification = (send_from, instance, description, current_user_info, cc_user_ids)->\r\n\t\t# Meteor.defer ()->\r\n\t\t\ttry\r\n\t\t\t\tspace_id = instance.space\r\n\t\t\t\tinstance_id = instance._id\r\n\t\t\t\tflow_version = instance.flow_version\r\n\t\t\t\tflow = uuflowManager.getFlow(instance.flow)\r\n\t\t\t\tto_users = pushManager.get_to_users(send_from, instance, cc_user_ids, current_user_info)\r\n\r\n\t\t\t\thref = Meteor.absoluteUrl() + \"workflow/space/#{space_id}/inbox/#{instance_id}\"\r\n\t\t\t\tbody_style_start = \"<div style='border:1px solid #bbb;padding:10px;'>\"\r\n\t\t\t\tbody_style_end = \"</div>\"\r\n\r\n\t\t\t\tcurrent_step_name = instance.current_step_name\r\n\t\t\t\tnextApprove_usersname = null\r\n\r\n\t\t\t\tif ['submit_pending_rejected_approve', 'submit_pending_rejected_applicant'].includes(send_from)\r\n\t\t\t\t\ttrace = _.find(instance.traces, (t) ->\r\n\t\t\t\t\t\treturn t.is_finished is false\r\n\t\t\t\t\t)\r\n\t\t\t\t\tapprove = _.find(trace.approves, (a) ->\r\n\t\t\t\t\t\treturn a.is_finished is false\r\n\t\t\t\t\t)\r\n\t\t\t\t\tnextApprove_usersname = approve.user_name\r\n\r\n\r\n\t\t\t\t#得到下一步步骤类型\r\n\t\t\t\tnextStep_type = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length-1].step).step_type\r\n\t\t\t\t#得到上一步处理结果\r\n\t\t\t\tlastApprove_judge = instance.traces[instance.traces.length-2].approves[0].judge\r\n\t\t\t\t_approves_username = new Array\r\n\t\t\t\t_.each(instance.traces[instance.traces.length-2].approves, (appr)->\r\n\t\t\t\t\t_approves_username.push(appr.handler_name)\r\n\t\t\t\t)\r\n\t\t\t\tlastApprove_usersname = _approves_username.join(\",\")\r\n\t\t\t\t# 得到当前步骤\r\n\t\t\t\tcurrent_step = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length-2].step)\r\n\r\n\t\t\t\t#代申请时，发送给申请人的邮件中，需要添加开始步骤的description\r\n\t\t\t\tapproves_description = null\r\n\t\t\t\t_approves_des = null\r\n\t\t\t\tif ['reassign_new_inbox_users', 'submit_completed_applicant', 'approved_completed_applicant', 'first_submit_applicant', 'first_submit_inbox', 'submit_pending_inbox'].includes(send_from)\r\n\t\t\t\t\tapproves_description = instance.traces[instance.traces.length-2].approves[0].description\r\n\t\t\t\t\tif current_step.step_type is \"counterSign\" and (\"submit_completed_applicant\" is send_from or \"submit_pending_inbox\" is send_from)\r\n\t\t\t\t\t\tto_user_change = 'en'\r\n\t\t\t\t\t\tif to_users[0].locale is 'zh-cn'\r\n\t\t\t\t\t\t\tto_user_change = 'zh-CN'\r\n\r\n\t\t\t\t\t\t_.each(instance.traces[instance.traces.length-2].approves, (appr)->\r\n\t\t\t\t\t\t\t_appr_description = appr.description\r\n\t\t\t\t\t\t\t_appr_userName = appr.user_name\r\n\t\t\t\t\t\t\tbr = '<br/>'\r\n\t\t\t\t\t\t\tif appr.judge is \"approved\"\r\n\t\t\t\t\t\t\t\t_approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.approved', {}, to_user_change) + \",\" + _appr_description + br\r\n\t\t\t\t\t\t\telse if appr.judge is \"rejected\"\r\n\t\t\t\t\t\t\t\t_approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.rejected', {}, to_user_change) + \",\" + _appr_description + br\r\n\r\n\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t\tapproves_description = _approves_des\r\n\r\n\t\t\t\t# from_user 默认为当前登录用户\r\n\t\t\t\tfrom_user = current_user_info\r\n\r\n\t\t\t\t# 发给下一步处理人或发送已处理过的人时，设置from_user对象为申请人\r\n\t\t\t\tif ['reassign_new_inbox_users', 'first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'submit_completed_approve', 'submit_pending_rejected_approve', 'submit_terminate_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)\r\n\t\t\t\t\tfrom_user = db.users.findOne(instance.applicant)\r\n\r\n\t\t\t\t#创建调用get_body、get_title函数时， 需要的参数\r\n\t\t\t\tparameters = new Object\r\n\t\t\t\tparameters[\"send_from\"] = send_from\r\n\t\t\t\tparameters[\"applicant_name\"] = instance.applicant_name\r\n\t\t\t\tparameters[\"instance_name\"] = instance.name\r\n\t\t\t\tparameters[\"href\"] = href\r\n\t\t\t\tparameters[\"final_decision\"] = instance.final_decision\r\n\t\t\t\tparameters[\"description\"] = description\r\n\t\t\t\tparameters[\"state\"] = instance.state\r\n\t\t\t\tparameters[\"from_username\"] = from_user.name\r\n\t\t\t\tparameters[\"current_step_name\"] = current_step_name\r\n\t\t\t\tparameters[\"nextApprove_usersname\"] = nextApprove_usersname\r\n\t\t\t\tparameters[\"nextStep_type\"] = nextStep_type\r\n\t\t\t\tparameters[\"approves_description\"] = approves_description\r\n\t\t\t\tparameters[\"lastApprove_judge\"] = lastApprove_judge\r\n\t\t\t\tparameters[\"lastApprove_usersname\"] = lastApprove_usersname\r\n\t\t\t\tparameters[\"current_user_name\"] = current_user_info.name\r\n\t\t\t\tparameters[\"currentStep_type\"] = current_step.step_type\r\n\t\t\t\t_.each to_users, (to_user)->\r\n\t\t\t\t\t#设置当前语言环境\r\n\t\t\t\t\tlang = 'en'\r\n\t\t\t\t\tif to_user.locale is 'zh-cn'\r\n\t\t\t\t\t\tlang = 'zh-CN'\r\n\r\n\t\t\t\t\tinscribed = TAPi18n.__('instance.email.inscribed', {}, lang)\r\n\t\t\t\t\tfootnote = \"<p style='text-align:left;color:#bbb;'>\" + TAPi18n.__('instance.email.footnote', {}, lang) + \"</p>\"\r\n\r\n\t\t\t\t\tif db.space_users.find({ space: space_id, user: to_user._id }).count() is 0\r\n\t\t\t\t\t\treturn\r\n\t\t\t\t\tif db.users.find(to_user._id).count() is 0\r\n\t\t\t\t\t\treturn\r\n\r\n\t\t\t\t\tparameters[\"to_username\"] = to_user.name\r\n\r\n\t\t\t\t\tins_html = ''\r\n\r\n\t\t\t\t\tif ['first_submit_inbox', 'submit_pending_inbox', 'submit_pending_rejected_inbox', 'submit_pending_rejected_applicant_inbox', 'reassign_new_inbox_users', 'trace_approve_cc', 'auto_submit_pending_inbox'].includes(send_from)\r\n\t\t\t\t\t\tif current_user_info.email && current_user_info.email_notification\r\n\t\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t\t\tconsole.time(\"push-2-1-ins_html\")\r\n\t\t\t\t\t\t\t\tins_html = uuflowManager.ins_html(current_user_info, instance)\r\n\t\t\t\t\t\t\t\tconsole.timeEnd(\"push-2-1-ins_html\")\r\n\t\t\t\t\t\t\tcatch e\r\n\t\t\t\t\t\t\t\tconsole.error e\r\n\r\n\t\t\t\t\tbody = pushManager.get_body(parameters, lang)\r\n\t\t\t\t\ttitle = pushManager.get_title(parameters, lang)\r\n\t\t\t\t\tbadge = pushManager.get_badge(send_from, to_user._id)\r\n\r\n\t\t\t\t\t# push\r\n\t\t\t\t\tpush_body = new Object\r\n\r\n\t\t\t\t\tpush_body[\"alertTitle\"] = title[\"push\"]\r\n\t\t\t\t\tpush_body[\"alert\"] = body[\"push\"]\r\n\t\t\t\t\t#push_body[\"href\"] = href\r\n\t\t\t\t\tpush_body[\"space_id\"] = space_id\r\n\t\t\t\t\tpush_body[\"instance_id\"] = instance_id\r\n\t\t\t\t\tpush_body[\"badge\"] = badge if badge\r\n\t\t\t\t\tpush_body[\"sound\"] = \"default\"\r\n\r\n\t\t\t\t\tcontent = body_style_start + body[\"email\"] +  inscribed + ins_html + body_style_end + footnote\r\n\t\t\t\t\t# Email\r\n\t\t\t\t\t# 发送消息到 SMTP 服务\r\n\t\t\t\t\tpushManager.send_email_to_SMTP(title[\"email\"], content, to_user, from_user)\r\n\t\t\t\t\t# 发送消息到push service 服务\r\n\t\t\t\t\tpushManager.send_message([to_user.steedos_id], push_body, current_user_info)\r\n\t\t\t\t\t# qq企业用户则发送客户端tips\r\n\t\t\t\t\tpushManager.send_to_qq(to_user, from_user, space_id, instance_id, instance.state, push_body, lang)\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.error e.stack\r\n\r\n# 发送给当前用户\r\npushManager.send_message_current_user = (user_info)->\r\n\ttry\r\n\t\tbadge = this.get_badge(\"current_user\", user_info._id)\r\n\t\tpush_body = new Object\r\n\t\tpush_body[\"badge\"] = badge\r\n\t\tthis.send_message([user_info.steedos_id], push_body, user_info)\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\n# 发送push 并且内容只有待审核数量\r\npushManager.send_message_to_specifyUser = (send_from, to_user)->\r\n\ttry\r\n\t\tbadge = this.get_badge(send_from, to_user)\r\n\t\tpush_body = new Object\r\n\t\tpush_body[\"badge\"] = badge\r\n\t\tuser_info = db.users.findOne({_id: to_user})\r\n\t\tthis.send_message([user_info.steedos_id], push_body, user_info) if user_info\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\r\npushManager.triggerWebhook = (flow_id, instance, current_approve, action, from_user_id, to_user_ids)->\r\n\r\n\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id}).fetch()\r\n\r\n\t# 增加from_user和to_users的username、email、mobile\r\n\tfrom_user = db.users.findOne({\"_id\": from_user_id},{fields: {_id:1, username:1}})\r\n\tfrom_space_user = db.space_users.findOne({\"user\": from_user_id},{fields: {mobile:1, email:1}})\r\n\tfrom_user?.mobile = from_space_user?.mobile || \"\"\r\n\tfrom_user?.email = from_space_user?.email || \"\"\r\n\r\n\tif(to_user_ids.length>0)\r\n\t\tto_users = db.users.find({\"_id\": {$in: to_user_ids}},{fields: {_id:1, username:1}}).fetch()\r\n\t\tto_users.forEach (to_user)->\r\n\t\t\tto_space_user = db.space_users.findOne({\"user\": to_user._id},{fields: {mobile:1, email:1}})\r\n\t\t\tto_user?.mobile = to_space_user?.mobile || \"\"\r\n\t\t\tto_user?.email = to_space_user?.email || \"\"\r\n\r\n\tdb.webhooks.find({ flow: { $in: [flow_id, null] }, active: true }).forEach (w)->\r\n\t\tWebhookQueue.send({\r\n\t\t\t\tinstance: instance,\r\n\t\t\t\tcurrent_approve: current_approve,\r\n\t\t\t\tpayload_url: w.payload_url,\r\n\t\t\t\tcontent_type: w.content_type,\r\n\t\t\t\taction: action,\r\n\t\t\t\tfrom_user: from_user,\r\n\t\t\t\tto_users: to_users || []\r\n\t\t\t})\r\n","var ref, ref1, ref2, ref3;             \n\npushManager = {\n  bqq_app_id: \"200626779\",\n  imo_app_cid: (ref = Meteor.settings.imo) != null ? ref.appcid : void 0,\n  imo_app_uid: (ref1 = Meteor.settings.imo) != null ? ref1.appuid : void 0,\n  imo_sync_app_key: (ref2 = Meteor.settings.imo) != null ? ref2.sync_app_key : void 0,\n  imo_push_app_key: (ref3 = Meteor.settings.imo) != null ? ref3.push_app_key : void 0\n};\n\npushManager.get_to_users = function(send_from, instance, cc_user_ids, current_user_info) {\n  var applicant, approve_user_ids, remove_users, to_users;\n  to_users = new Array;\n  if (['first_submit_applicant'].includes(send_from)) {\n    if (instance.applicant !== instance.submitter) {\n      applicant = db.users.findOne(instance.applicant);\n      to_users.push(applicant);\n    }\n  } else if (['submit_terminate_approve', 'submit_completed_approve', 'submit_pending_rejected_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)) {\n    remove_users = new Array;\n    remove_users.push(instance.applicant);\n    remove_users.push(instance.submitter);\n    approve_user_ids = _.difference(instance.outbox_users, remove_users);\n    to_users = db.users.find({\n      _id: {\n        $in: approve_user_ids\n      }\n    }).fetch();\n  } else if (['reassign_new_inbox_users', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)) {\n    to_users = db.users.find({\n      _id: {\n        $in: instance.inbox_users\n      }\n    }).fetch();\n  } else if (['submit_completed_applicant', 'approved_completed_applicant', 'rejected_completed_applicant', 'monitor_delete_applicant', 'submit_terminate_applicant', 'submit_pending_rejected_applicant', 'submit_pending_rejected_applicant_inbox'].includes(send_from)) {\n    applicant = db.users.findOne(instance.applicant);\n    to_users.push(applicant);\n  } else if (['trace_approve_cc'].includes(send_from) && cc_user_ids) {\n    to_users = db.users.find({\n      _id: {\n        $in: cc_user_ids\n      }\n    }).fetch();\n  } else if (['trace_approve_cc_submit'].includes(send_from) && cc_user_ids) {\n    to_users = db.users.find({\n      _id: {\n        $in: cc_user_ids\n      }\n    }).fetch();\n  } else if (['auto_submit_pending_inbox'].includes(send_from)) {\n    to_users = [current_user_info];\n  }\n  return to_users;\n};\n\npushManager.get_body = function(parameters, lang) {\n  var applicant_name, approves_description, body, currentStep_type, current_step_name, current_user_name, description, email_approve_type, email_description, email_final_decision, final_decision, from_username, href, instance_name, lastApprove_judge, lastApprove_usersname, last_approve_judge, nextApprove_usersname, nextStep_type, push_approve_type, push_final_decision, send_from, state, to_username, url_approve_type;\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  send_from = parameters[\"send_from\"];\n  applicant_name = parameters[\"applicant_name\"];\n  instance_name = parameters[\"instance_name\"];\n  to_username = parameters[\"to_username\"];\n  href = parameters[\"href\"];\n  final_decision = parameters[\"final_decision\"];\n  description = parameters[\"description\"];\n  state = parameters[\"state\"];\n  from_username = parameters[\"from_username\"];\n  current_step_name = parameters[\"current_step_name\"];\n  nextApprove_usersname = parameters[\"nextApprove_usersname\"];\n  nextStep_type = parameters[\"nextStep_type\"];\n  approves_description = parameters[\"approves_description\"];\n  lastApprove_judge = parameters[\"lastApprove_judge\"];\n  lastApprove_usersname = parameters[\"lastApprove_usersname\"];\n  current_user_name = parameters[\"current_user_name\"];\n  currentStep_type = parameters[\"currentStep_type\"];\n  push_final_decision = \"\";\n  email_final_decision = \"\";\n  email_description = \"\";\n  if (!final_decision) {\n    push_final_decision = TAPi18n.__('instance.push.final_decision_nil', {}, lang);\n    email_final_decision = TAPi18n.__('instance.email.final_decision_nil', {}, lang);\n  } else {\n    if (\"approved\" === final_decision) {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_approved', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_approved', {}, lang);\n    } else if (\"rejected\" === final_decision) {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_rejected', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_rejected', {}, lang);\n      email_description = TAPi18n.__('instance.email.body.email_description', {\n        description: description\n      }, lang);\n    } else {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_nil', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_nil', {}, lang);\n    }\n  }\n  email_approve_type = null;\n  url_approve_type = null;\n  push_approve_type = null;\n  if (['submit', 'start'].includes(nextStep_type)) {\n    email_approve_type = TAPi18n.__('instance.email.body.input', {}, lang);\n    url_approve_type = TAPi18n.__('instance.email.body.url_input', {}, lang);\n    push_approve_type = TAPi18n.__('instance.push.body.input', {}, lang);\n  } else if (['sign', 'counterSign'].includes(nextStep_type)) {\n    email_approve_type = TAPi18n.__('instance.email.body.approval', {}, lang);\n    url_approve_type = TAPi18n.__('instance.email.body.url_approval', {}, lang);\n    push_approve_type = TAPi18n.__('instance.push.body.approval', {}, lang);\n  }\n  last_approve_judge = null;\n  if (\"submitted\" === lastApprove_judge) {\n    last_approve_judge = TAPi18n.__('instance.email.body.judge_submitted', {}, lang);\n  } else if (\"approved\" === lastApprove_judge) {\n    last_approve_judge = TAPi18n.__('instance.email.body.judge_approved', {}, lang);\n  }\n  body = new Object;\n  if (\"first_submit_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.first_submit_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_applicant_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"first_submit_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.first_submit_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_inbox', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_inbox_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"submit_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname\n      }, lang);\n    } else {\n      if (currentStep_type === \"counterSign\") {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription_counterSign', {\n          instance_name: instance_name,\n          to_username: to_username,\n          current_username: current_user_name,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          lastApprove_usersname: lastApprove_usersname\n        }, lang) + approves_description + TAPi18n.__('help.href', {\n          href: href\n        }, lang);\n      } else {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription', {\n          instance_name: instance_name,\n          to_username: to_username,\n          current_username: current_user_name,\n          href: href,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          lastApprove_usersname: lastApprove_usersname,\n          approves_description: approves_description\n        }, lang);\n      }\n    }\n  } else if (\"submit_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_applicant_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_applicant_inbox', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      current_user: current_user_name,\n      nextApprove_usersname: nextApprove_usersname,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"submit_pending_rejected_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_inbox', {\n      instance_name: instance_name,\n      to_username: to_username,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      approve_type: email_approve_type,\n      url_approve_type: url_approve_type,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type,\n        lastApprove_usersname: lastApprove_usersname,\n        last_approve_judge: last_approve_judge\n      }, lang);\n    } else {\n      if (currentStep_type === \"counterSign\") {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription_counterSign', {\n          instance_name: instance_name,\n          to_username: to_username,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          approve_type: email_approve_type,\n          url_approve_type: url_approve_type,\n          lastApprove_usersname: lastApprove_usersname,\n          last_approve_judge: last_approve_judge\n        }, lang) + approves_description + TAPi18n.__('help.href', {\n          href: href\n        }, lang);\n      } else {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription', {\n          instance_name: instance_name,\n          to_username: to_username,\n          href: href,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          approve_type: email_approve_type,\n          url_approve_type: url_approve_type,\n          lastApprove_usersname: lastApprove_usersname,\n          last_approve_judge: last_approve_judge,\n          approves_description: approves_description\n        }, lang);\n      }\n    }\n  } else if (\"submit_terminate_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_terminate_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_terminate_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description\n    }, lang);\n  } else if (\"submit_terminate_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_terminate_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_terminate_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description\n    }, lang);\n  } else if (\"monitor_delete_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.monitor_delete_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.monitor_delete_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"approved_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.approved_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_applicant_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"approved_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.approved_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"rejected_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.rejected_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.rejected_completed_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"rejected_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.rejected_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.rejected_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"reassign_new_inbox_users\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.reassign_new_inbox_users', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      current_user_name: current_user_name,\n      url_approve_type: url_approve_type,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.reassign_new_inbox_users', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description,\n      current_user_name: current_user_name,\n      url_approve_type: url_approve_type,\n      approve_type: email_approve_type\n    }, lang);\n  } else if (\"trace_approve_cc\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.trace_approve_cc', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.trace_approve_cc', {\n      instance_name: instance_name,\n      to_username: to_username,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      approve_type: email_approve_type,\n      url_approve_type: url_approve_type\n    }, lang);\n  } else if (\"trace_approve_cc_submit\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.trace_approve_cc_submit', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type,\n      current_user_name: current_user_name\n    }, lang);\n  } else if (\"auto_submit_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.auto_submit_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.auto_submit_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name,\n      to_username: to_username\n    }, lang);\n  } else if (\"return_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.return_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.return_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name,\n      to_username: to_username\n    }, lang);\n  }\n  return body;\n};\n\npushManager.get_title = function(parameters, lang) {\n  var applicant_name, approve_type, current_step_name, from_username, instance_name, nextApprove_usersname, nextStep_type, send_from, title;\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  send_from = parameters[\"send_from\"];\n  instance_name = parameters[\"instance_name\"];\n  from_username = parameters[\"from_username\"];\n  applicant_name = parameters[\"applicant_name\"];\n  current_step_name = parameters[\"current_step_name\"];\n  nextApprove_usersname = parameters[\"nextApprove_usersname\"];\n  nextStep_type = parameters[\"nextStep_type\"];\n  approve_type = null;\n  if (['submit', 'start'].includes(nextStep_type)) {\n    approve_type = TAPi18n.__('instance.email.title.input', {}, lang);\n  } else if (['sign', 'counterSign'].includes(nextStep_type)) {\n    approve_type = TAPi18n.__('instance.email.title.approval', {}, lang);\n  }\n  title = new Object;\n  if (\"first_submit_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.first_submit_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.first_submit_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"first_submit_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.first_submit_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.first_submit_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_applicant_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_applicant_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      current_user: current_user_name,\n      nextApprove_usersname: nextApprove_usersname,\n      current_step_name: current_step_name\n    }, lang);\n  } else if (\"submit_pending_rejected_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_terminate_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_terminate_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_terminate_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_terminate_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_terminate_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_terminate_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"monitor_delete_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.monitor_delete_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.monitor_delete_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"approved_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.approved_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.approved_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"approved_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.approved_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.approved_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"rejected_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.rejected_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.rejected_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"rejected_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.rejected_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.rejected_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"reassign_new_inbox_users\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.reassign_new_inbox_users', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.reassign_new_inbox_users', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"trace_approve_cc\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.trace_approve_cc', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.trace_approve_cc', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"trace_approve_cc_submit\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.trace_approve_cc_submit', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"auto_submit_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.auto_submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.auto_submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"return_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.return_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.return_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  }\n  return title;\n};\n\npushManager.get_badge = function(send_from, user_id) {\n  var badge, sk_all, sk_all_new, user_spaces;\n  if (!['first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'current_user', 'terminate_approval', 'reassign_new_inbox_users', 'trace_approve_cc', 'trace_approve_cc_submit', 'auto_submit_pending_inbox', 'return_pending_inbox'].includes(send_from)) {\n    return null;\n  }\n  badge = 0;\n  user_spaces = db.space_users.find({\n    user: user_id,\n    user_accepted: true\n  }, {\n    fields: {\n      space: 1\n    }\n  });\n  user_spaces.forEach(function(user_space) {\n    var c, ref4, sk, sk_new;\n    c = db.instances.find({\n      space: user_space.space,\n      state: {\n        $in: ['pending', 'completed', 'draft']\n      },\n      $or: [\n        {\n          inbox_users: user_id\n        }, {\n          cc_users: user_id\n        }\n      ]\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).count();\n    badge += c;\n    sk = db.steedos_keyvalues.findOne({\n      user: user_id,\n      space: user_space.space,\n      key: 'badge'\n    }, {\n      fields: {\n        _id: 1,\n        value: 1\n      }\n    });\n    if (sk) {\n      if (((ref4 = sk.value) != null ? ref4.workflow : void 0) !== c) {\n        return db.steedos_keyvalues.update({\n          _id: sk._id\n        }, {\n          $set: {\n            'value.workflow': c\n          }\n        });\n      }\n    } else {\n      sk_new = {};\n      sk_new.user = user_id;\n      sk_new.space = user_space.space;\n      sk_new.key = 'badge';\n      sk_new.value = {\n        'workflow': c\n      };\n      return db.steedos_keyvalues.insert(sk_new);\n    }\n  });\n  sk_all = db.steedos_keyvalues.findOne({\n    user: user_id,\n    space: null,\n    key: 'badge'\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (sk_all) {\n    db.steedos_keyvalues.update({\n      _id: sk_all._id\n    }, {\n      $set: {\n        'value.workflow': badge\n      }\n    });\n  } else {\n    sk_all_new = {};\n    sk_all_new.user = user_id;\n    sk_all_new.space = null;\n    sk_all_new.key = 'badge';\n    sk_all_new.value = {\n      'workflow': badge\n    };\n    db.steedos_keyvalues.insert(sk_all_new);\n  }\n  return badge;\n};\n\npushManager.send_to_imo = function(steedos_ids, body, current_user_info) {\n  var appmsg, con, e, fromcid, fromuid, msg, res_b, res_badge, res_m, res_msg, space, space_u, users;\n  try {\n    if (!current_user_info.imo_uid) {\n      return;\n    }\n    fromuid = current_user_info.imo_uid;\n    space_u = db.space_users.findOne({\n      user: current_user_info._id\n    }, {\n      fields: {\n        space: 1\n      }\n    });\n    space = db.spaces.findOne(space_u[\"space\"]);\n    fromcid = space[\"imo_cid\"];\n    if (!fromcid) {\n      return;\n    }\n    users = new Array;\n    db.users.find({\n      steedos_id: {\n        $in: steedos_ids\n      }\n    }, {\n      fields: {\n        imo_uid: 1\n      }\n    }).forEach(function(u) {\n      var h;\n      h = new Object;\n      h[\"cid\"] = fromcid;\n      h[\"uid\"] = u[\"imo_uid\"];\n      return users.push(h);\n    });\n    if (body[\"badge\"]) {\n      appmsg = new Object;\n      appmsg[\"ver\"] = \"1.0\";\n      appmsg[\"tranid\"] = (Math.round(new Date().getTime() / 1000)).toString();\n      appmsg[\"protocol\"] = \"workbench_pc_web\";\n      con = new Object;\n      con[\"appname\"] = this.imo_sync_app_key;\n      con[\"type\"] = \"app\";\n      con[\"ico\"] = \"\";\n      con[\"count\"] = body[\"badge\"].to_s;\n      appmsg[\"contents\"] = [con];\n      res_b = HTTP.post('http://open.imoffice.com:8000/', {\n        params: {\n          app: \"appnoticeopen\",\n          pushtype: \"2\",\n          fromcid: fromcid,\n          fromuid: fromuid,\n          appcid: this.imo_app_cid,\n          appuid: this.imo_app_uid,\n          appkey: this.imo_sync_app_key,\n          tappkey: this.imo_sync_app_key,\n          users: JSON.stringify(users),\n          appmsg: JSON.stringify(appmsg)\n        }\n      });\n      res_badge = res_b.content;\n      if (res_badge && res_badge[\"result\"] === \"false\") {\n        console.error(\"send_to_imo 发送消息失败:\" + (res_badge[\"msg\"] || res_badge[\"info\"]));\n      }\n    }\n    if (body[\"alertTitle\"]) {\n      msg = new Object;\n      msg[\"ver\"] = \"1.0\";\n      msg[\"title\"] = \"新消息: \" + body[\"alertTitle\"];\n      msg[\"img\"] = \"http:\\/\\/imoapp.imoffice.com:1863\\/WorkBench/Manage\\/Images\\/24bc3fef811a017771038323d80a6cae_170519a.png\";\n      msg[\"desc\"] = body[\"alert\"];\n      msg[\"lnk\"] = Meteor.absoluteUrl() + (\"se/imo/login?appkey=\" + this.imo_sync_app_key);\n      res_m = HTTP.post('http://open.imoffice.com:5186/index.php', {\n        params: {\n          app: \"sendmsg\",\n          pushtype: \"2\",\n          fromcid: fromcid,\n          fromuid: fromuid,\n          appcid: this.imo_app_cid,\n          appuid: this.imo_app_uid,\n          appkey: this.imo_push_app_key,\n          users: JSON.stringify(users),\n          msg: JSON.stringify(msg),\n          poptype: \"1\",\n          chart: \"\"\n        }\n      });\n      res_msg = res_m.content;\n      if (res_msg && res_msg[\"result\"] === \"false\") {\n        return console.error(\"send_to_imo 发送消息失败:\" + (res_msg[\"msg\"] || res_msg[\"info\"]));\n      }\n    }\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_to_qq = function(to_user, from_user, space_id, instance_id, instance_state, body, i18n_obj) {\n  var app_id, box, bqq_uri, e, employee_access_token, oauth, open_id, recv_open_ids, response, space, tips_url;\n  try {\n    if ((!to_user.services) || (!to_user.services['bqq']) || (!to_user.services['bqq']['id'])) {\n      return;\n    }\n    space = db.spaces.findOne({\n      _id: space_id,\n      \"services.bqq.company_id\": {\n        $ne: null\n      }\n    }, {\n      fields: {\n        services: 1\n      }\n    });\n    if (!space) {\n      return;\n    }\n    app_id = this.bqq_app_id;\n    open_id = from_user.services['bqq']['id'];\n    employee_access_token = from_user.services['bqq']['accessToken'];\n    recv_open_ids = to_user.services['bqq']['id'];\n    oauth = space['services']['bqq'];\n    box = \"inbox\";\n    if (instance_state === \"completed\") {\n      box = \"completed\";\n    }\n    tips_url = '/workflow/space/' + space_id + '/' + box + '/' + instance_id;\n    bqq_uri = encodeURI('https://openapi.b.qq.com/api/combomsg/send?company_id=' + oauth['company_id'] + '&company_token=' + oauth['company_token'] + '&app_id=' + app_id + '&client_ip=0.0.0.0' + '&oauth_version=2' + '&employee_access_token=' + employee_access_token + '&brief=' + body['alert'] + '&url=' + tips_url + '&type=picture' + '&title=' + body['alert'] + '&summary=' + body['alertTitle'] + '&recv_open_ids=' + recv_open_ids + '&open_id=' + open_id);\n    response = HTTP.post(bqq_uri);\n    if (response.data.ret > 0) {\n      console.error(response.data.msg);\n    }\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_email_to_SMTP = function(subject, content, to_user, reply_user) {\n  var e;\n  if (!to_user.email || !to_user.email_notification) {\n    return;\n  }\n  try {\n    return MailQueue.send({\n      to: to_user.email,\n      from: pushManager.checkMailFromNameLength(reply_user.name) + ' on ' + Meteor.settings.email.from,\n      subject: subject,\n      html: content\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.checkMailFromNameLength = function(name) {\n  if (name.length <= 18) {\n    return name;\n  } else {\n    return name.substr(0, 18) + '...';\n  }\n};\n\npushManager.send_message_by_raix_push = function(data) {\n  var e, notification, payload;\n  if (!data[\"data\"]) {\n    return;\n  }\n  try {\n    notification = new Object;\n    notification[\"createdAt\"] = new Date;\n    notification[\"createdBy\"] = '<SERVER>';\n    notification[\"from\"] = data[\"pushTopic\"];\n    notification['title'] = data[\"data\"][\"alertTitle\"] ? data[\"data\"][\"alertTitle\"] : \"\";\n    notification['text'] = data[\"data\"][\"alert\"] ? data[\"data\"][\"alert\"] : \"\";\n    if (data[\"data\"][\"space_id\"] && data[\"data\"][\"instance_id\"]) {\n      payload = new Object;\n      payload[\"space\"] = data[\"data\"][\"space_id\"];\n      payload[\"instance\"] = data[\"data\"][\"instance_id\"];\n      payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n      notification[\"payload\"] = payload;\n    }\n    if (data[\"data\"][\"badge\"] > -1) {\n      notification['badge'] = data[\"data\"][\"badge\"];\n    }\n    return _.each(data[\"toUsers\"], function(u) {\n      var user;\n      user = db.users.findOne({\n        steedos_id: u\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (user) {\n        notification['query'] = {\n          userId: user._id,\n          appName: data[\"pushTopic\"]\n        };\n        return Push.send(notification);\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message = function(steedos_ids, body, current_user_info) {\n  var data;\n  if (!steedos_ids || !(steedos_ids instanceof Array)) {\n    return;\n  }\n  data = new Object;\n  data[\"toUsers\"] = steedos_ids;\n  data[\"pushTopic\"] = 'workflow';\n  if (body) {\n    data[\"data\"] = body;\n  }\n  pushManager.send_message_by_raix_push(data);\n  if (body) {\n    return pushManager.send_to_imo(steedos_ids, body, current_user_info);\n  }\n};\n\npushManager.send_instance_notification = function(send_from, instance, description, current_user_info, cc_user_ids) {\n  var _approves_des, _approves_username, approve, approves_description, body_style_end, body_style_start, current_step, current_step_name, e, flow, flow_version, from_user, href, instance_id, lastApprove_judge, lastApprove_usersname, nextApprove_usersname, nextStep_type, parameters, space_id, to_user_change, to_users, trace;\n  try {\n    space_id = instance.space;\n    instance_id = instance._id;\n    flow_version = instance.flow_version;\n    flow = uuflowManager.getFlow(instance.flow);\n    to_users = pushManager.get_to_users(send_from, instance, cc_user_ids, current_user_info);\n    href = Meteor.absoluteUrl() + (\"workflow/space/\" + space_id + \"/inbox/\" + instance_id);\n    body_style_start = \"<div style='border:1px solid #bbb;padding:10px;'>\";\n    body_style_end = \"</div>\";\n    current_step_name = instance.current_step_name;\n    nextApprove_usersname = null;\n    if (['submit_pending_rejected_approve', 'submit_pending_rejected_applicant'].includes(send_from)) {\n      trace = _.find(instance.traces, function(t) {\n        return t.is_finished === false;\n      });\n      approve = _.find(trace.approves, function(a) {\n        return a.is_finished === false;\n      });\n      nextApprove_usersname = approve.user_name;\n    }\n    nextStep_type = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length - 1].step).step_type;\n    lastApprove_judge = instance.traces[instance.traces.length - 2].approves[0].judge;\n    _approves_username = new Array;\n    _.each(instance.traces[instance.traces.length - 2].approves, function(appr) {\n      return _approves_username.push(appr.handler_name);\n    });\n    lastApprove_usersname = _approves_username.join(\",\");\n    current_step = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length - 2].step);\n    approves_description = null;\n    _approves_des = null;\n    if (['reassign_new_inbox_users', 'submit_completed_applicant', 'approved_completed_applicant', 'first_submit_applicant', 'first_submit_inbox', 'submit_pending_inbox'].includes(send_from)) {\n      approves_description = instance.traces[instance.traces.length - 2].approves[0].description;\n      if (current_step.step_type === \"counterSign\" && (\"submit_completed_applicant\" === send_from || \"submit_pending_inbox\" === send_from)) {\n        to_user_change = 'en';\n        if (to_users[0].locale === 'zh-cn') {\n          to_user_change = 'zh-CN';\n        }\n        _.each(instance.traces[instance.traces.length - 2].approves, function(appr) {\n          var _appr_description, _appr_userName, br;\n          _appr_description = appr.description;\n          _appr_userName = appr.user_name;\n          br = '<br/>';\n          if (appr.judge === \"approved\") {\n            return _approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.approved', {}, to_user_change) + \",\" + _appr_description + br;\n          } else if (appr.judge === \"rejected\") {\n            return _approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.rejected', {}, to_user_change) + \",\" + _appr_description + br;\n          }\n        });\n        approves_description = _approves_des;\n      }\n    }\n    from_user = current_user_info;\n    if (['reassign_new_inbox_users', 'first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'submit_completed_approve', 'submit_pending_rejected_approve', 'submit_terminate_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)) {\n      from_user = db.users.findOne(instance.applicant);\n    }\n    parameters = new Object;\n    parameters[\"send_from\"] = send_from;\n    parameters[\"applicant_name\"] = instance.applicant_name;\n    parameters[\"instance_name\"] = instance.name;\n    parameters[\"href\"] = href;\n    parameters[\"final_decision\"] = instance.final_decision;\n    parameters[\"description\"] = description;\n    parameters[\"state\"] = instance.state;\n    parameters[\"from_username\"] = from_user.name;\n    parameters[\"current_step_name\"] = current_step_name;\n    parameters[\"nextApprove_usersname\"] = nextApprove_usersname;\n    parameters[\"nextStep_type\"] = nextStep_type;\n    parameters[\"approves_description\"] = approves_description;\n    parameters[\"lastApprove_judge\"] = lastApprove_judge;\n    parameters[\"lastApprove_usersname\"] = lastApprove_usersname;\n    parameters[\"current_user_name\"] = current_user_info.name;\n    parameters[\"currentStep_type\"] = current_step.step_type;\n    return _.each(to_users, function(to_user) {\n      var badge, body, content, e, footnote, ins_html, inscribed, lang, push_body, title;\n      lang = 'en';\n      if (to_user.locale === 'zh-cn') {\n        lang = 'zh-CN';\n      }\n      inscribed = TAPi18n.__('instance.email.inscribed', {}, lang);\n      footnote = \"<p style='text-align:left;color:#bbb;'>\" + TAPi18n.__('instance.email.footnote', {}, lang) + \"</p>\";\n      if (db.space_users.find({\n        space: space_id,\n        user: to_user._id\n      }).count() === 0) {\n        return;\n      }\n      if (db.users.find(to_user._id).count() === 0) {\n        return;\n      }\n      parameters[\"to_username\"] = to_user.name;\n      ins_html = '';\n      if (['first_submit_inbox', 'submit_pending_inbox', 'submit_pending_rejected_inbox', 'submit_pending_rejected_applicant_inbox', 'reassign_new_inbox_users', 'trace_approve_cc', 'auto_submit_pending_inbox'].includes(send_from)) {\n        if (current_user_info.email && current_user_info.email_notification) {\n          try {\n            console.time(\"push-2-1-ins_html\");\n            ins_html = uuflowManager.ins_html(current_user_info, instance);\n            console.timeEnd(\"push-2-1-ins_html\");\n          } catch (error) {\n            e = error;\n            console.error(e);\n          }\n        }\n      }\n      body = pushManager.get_body(parameters, lang);\n      title = pushManager.get_title(parameters, lang);\n      badge = pushManager.get_badge(send_from, to_user._id);\n      push_body = new Object;\n      push_body[\"alertTitle\"] = title[\"push\"];\n      push_body[\"alert\"] = body[\"push\"];\n      push_body[\"space_id\"] = space_id;\n      push_body[\"instance_id\"] = instance_id;\n      if (badge) {\n        push_body[\"badge\"] = badge;\n      }\n      push_body[\"sound\"] = \"default\";\n      content = body_style_start + body[\"email\"] + inscribed + ins_html + body_style_end + footnote;\n      pushManager.send_email_to_SMTP(title[\"email\"], content, to_user, from_user);\n      pushManager.send_message([to_user.steedos_id], push_body, current_user_info);\n      return pushManager.send_to_qq(to_user, from_user, space_id, instance_id, instance.state, push_body, lang);\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message_current_user = function(user_info) {\n  var badge, e, push_body;\n  try {\n    badge = this.get_badge(\"current_user\", user_info._id);\n    push_body = new Object;\n    push_body[\"badge\"] = badge;\n    return this.send_message([user_info.steedos_id], push_body, user_info);\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message_to_specifyUser = function(send_from, to_user) {\n  var badge, e, push_body, user_info;\n  try {\n    badge = this.get_badge(send_from, to_user);\n    push_body = new Object;\n    push_body[\"badge\"] = badge;\n    user_info = db.users.findOne({\n      _id: to_user\n    });\n    if (user_info) {\n      return this.send_message([user_info.steedos_id], push_body, user_info);\n    }\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.triggerWebhook = function(flow_id, instance, current_approve, action, from_user_id, to_user_ids) {\n  var from_space_user, from_user, to_users;\n  instance.attachments = cfs.instances.find({\n    'metadata.instance': instance._id\n  }).fetch();\n  from_user = db.users.findOne({\n    \"_id\": from_user_id\n  }, {\n    fields: {\n      _id: 1,\n      username: 1\n    }\n  });\n  from_space_user = db.space_users.findOne({\n    \"user\": from_user_id\n  }, {\n    fields: {\n      mobile: 1,\n      email: 1\n    }\n  });\n  if (from_user != null) {\n    from_user.mobile = (from_space_user != null ? from_space_user.mobile : void 0) || \"\";\n  }\n  if (from_user != null) {\n    from_user.email = (from_space_user != null ? from_space_user.email : void 0) || \"\";\n  }\n  if (to_user_ids.length > 0) {\n    to_users = db.users.find({\n      \"_id\": {\n        $in: to_user_ids\n      }\n    }, {\n      fields: {\n        _id: 1,\n        username: 1\n      }\n    }).fetch();\n    to_users.forEach(function(to_user) {\n      var to_space_user;\n      to_space_user = db.space_users.findOne({\n        \"user\": to_user._id\n      }, {\n        fields: {\n          mobile: 1,\n          email: 1\n        }\n      });\n      if (to_user != null) {\n        to_user.mobile = (to_space_user != null ? to_space_user.mobile : void 0) || \"\";\n      }\n      return to_user != null ? to_user.email = (to_space_user != null ? to_space_user.email : void 0) || \"\" : void 0;\n    });\n  }\n  return db.webhooks.find({\n    flow: {\n      $in: [flow_id, null]\n    },\n    active: true\n  }).forEach(function(w) {\n    return WebhookQueue.send({\n      instance: instance,\n      current_approve: current_approve,\n      payload_url: w.payload_url,\n      content_type: w.content_type,\n      action: action,\n      from_user: from_user,\n      to_users: to_users || []\n    });\n  });\n};\n","steedosExport = {}\r\n\r\n_getFlowByForm = (form, flowId, is_copy, company_id)->\r\n\r\n\tquery = {form: form}\r\n\r\n\tif flowId\r\n\t\tquery._id = flowId\r\n\r\n\tfields = {history: 0}\r\n\r\n\tflows = db.flows.find(query, fields).fetch();\r\n\r\n\tflows.forEach (flow) ->\r\n\t\tflow.historys = []\r\n\t\tif !is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id != flow.company_id)\r\n\t\t\tflow.current.steps?.forEach (step) ->\r\n\t\t\t\troles_name = []\r\n\t\t\t\tif !_.isEmpty(step.approver_roles)\r\n\t\t\t\t\troles_name = db.flow_roles.find({_id: {$in: step.approver_roles}}, {fields: {name: 1}}).fetch().getProperty(\"name\");\r\n\r\n\t\t\t\tstep.approver_roles_name = roles_name\r\n\r\n\t\t\t\tstep.approver_users = []\r\n\r\n\t\t\t\tstep.approver_orgs = []\r\n\r\n\t\tif !is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id != flow.company_id)\r\n\t\t\tdelete flow.perms\r\n\r\n\treturn flows;\r\n\r\n###\r\n    获取form对象\r\n\r\n    category: form的分组名次\r\n\r\n    form：不包含历史版本\r\n\r\n    instance_number_rules: 表单字段所引用的编号规则\r\n\r\n    flows: 引用此表单的所有流程，不包含历史版本\r\n###\r\nsteedosExport.form = (formId, flowId, is_copy, company_id) ->\r\n\tform = db.forms.findOne({_id: formId}, {fields: {historys: 0}});\r\n\r\n\tif !form\r\n\t\treturn {}\r\n\r\n\tform.historys = []\r\n\r\n\tif form?.category\r\n\t\tcategory = db.categories.findOne({_id: form.category}, {fields: {name: 1}});\r\n\r\n\t\tif category?.name\r\n\t\t\tform.category_name = category.name\r\n\r\n\t_getNumberRuleName = (str)->\r\n\t\tif _.isString(str) && str?.indexOf(\"auto_number(\") > -1\r\n\t\t\tstr = str.replace(\"auto_number(\", \"\").replace(\")\", \"\").replace(\"\\\"\", \"\").replace(\"\\\"\", \"\").replace(\"\\'\", \"\").replace(\"\\'\", \"\")\r\n\t\t\treturn str\r\n\t\treturn ;\r\n\r\n\tinstance_number_rules = new Array()\r\n\r\n\tif form.current\r\n\r\n\t\tfields = new Array()\r\n\r\n\t\tc_fields = form.current.fields\r\n\r\n\t\tc_fields?.forEach (f)->\r\n\t\t\tif f.type == 'table'\r\n\t\t\t\tconsole.log 'ignore table field'\r\n\t\t\telse if f.type == 'section'\r\n\t\t\t\tf?.fields?.forEach (f1)->\r\n\t\t\t\t\tfields.push f1\r\n\t\t\telse\r\n\t\t\t\tfields.push f\r\n\r\n\t\t_getFieldNumberRule = (spaceId, instance_number_rules, str)->\r\n\t\t\tnumber_rule_name = _getNumberRuleName(str)\r\n\r\n\t\t\tif number_rule_name\r\n\t\t\t\tnumber_rule = db.instance_number_rules.findOne({space: spaceId, name: number_rule_name}, {fields: {_id: 1, name: 1, year: 1, first_number: 1, rules: 1}})\r\n\r\n\t\t\t\tnumber_rule.number = 0\r\n\r\n\t\t\t\tif !instance_number_rules.findPropertyByPK(\"_id\", number_rule._id)\r\n\r\n\t\t\t\t\tdelete number_rule._id\r\n\r\n\t\t\t\t\tinstance_number_rules.push(number_rule)\r\n\r\n\t\t\treturn instance_number_rules\r\n\r\n\r\n\t\tfields.forEach (f)->\r\n\t\t\t_getFieldNumberRule(form.space, instance_number_rules, f.default_value)\r\n\r\n\t\t\t_getFieldNumberRule(form.space, instance_number_rules, f.formula)\r\n\r\n\tform.instance_number_rules = instance_number_rules\r\n\r\n\tform.flows = _getFlowByForm(formId, flowId, is_copy, company_id)\r\n\r\n\treturn form","var _getFlowByForm;               \n\nsteedosExport = {};\n\n_getFlowByForm = function(form, flowId, is_copy, company_id) {\n  var fields, flows, query;\n  query = {\n    form: form\n  };\n  if (flowId) {\n    query._id = flowId;\n  }\n  fields = {\n    history: 0\n  };\n  flows = db.flows.find(query, fields).fetch();\n  flows.forEach(function(flow) {\n    var ref;\n    flow.historys = [];\n    if (!is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id !== flow.company_id)) {\n      if ((ref = flow.current.steps) != null) {\n        ref.forEach(function(step) {\n          var roles_name;\n          roles_name = [];\n          if (!_.isEmpty(step.approver_roles)) {\n            roles_name = db.flow_roles.find({\n              _id: {\n                $in: step.approver_roles\n              }\n            }, {\n              fields: {\n                name: 1\n              }\n            }).fetch().getProperty(\"name\");\n          }\n          step.approver_roles_name = roles_name;\n          step.approver_users = [];\n          return step.approver_orgs = [];\n        });\n      }\n    }\n    if (!is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id !== flow.company_id)) {\n      return delete flow.perms;\n    }\n  });\n  return flows;\n};\n\n\n/*\n    获取form对象\n\n    category: form的分组名次\n\n    form：不包含历史版本\n\n    instance_number_rules: 表单字段所引用的编号规则\n\n    flows: 引用此表单的所有流程，不包含历史版本\n */\n\nsteedosExport.form = function(formId, flowId, is_copy, company_id) {\n  var _getFieldNumberRule, _getNumberRuleName, c_fields, category, fields, form, instance_number_rules;\n  form = db.forms.findOne({\n    _id: formId\n  }, {\n    fields: {\n      historys: 0\n    }\n  });\n  if (!form) {\n    return {};\n  }\n  form.historys = [];\n  if (form != null ? form.category : void 0) {\n    category = db.categories.findOne({\n      _id: form.category\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    if (category != null ? category.name : void 0) {\n      form.category_name = category.name;\n    }\n  }\n  _getNumberRuleName = function(str) {\n    if (_.isString(str) && (str != null ? str.indexOf(\"auto_number(\") : void 0) > -1) {\n      str = str.replace(\"auto_number(\", \"\").replace(\")\", \"\").replace(\"\\\"\", \"\").replace(\"\\\"\", \"\").replace(\"\\'\", \"\").replace(\"\\'\", \"\");\n      return str;\n    }\n  };\n  instance_number_rules = new Array();\n  if (form.current) {\n    fields = new Array();\n    c_fields = form.current.fields;\n    if (c_fields != null) {\n      c_fields.forEach(function(f) {\n        var ref;\n        if (f.type === 'table') {\n          return console.log('ignore table field');\n        } else if (f.type === 'section') {\n          return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n            return fields.push(f1);\n          }) : void 0 : void 0;\n        } else {\n          return fields.push(f);\n        }\n      });\n    }\n    _getFieldNumberRule = function(spaceId, instance_number_rules, str) {\n      var number_rule, number_rule_name;\n      number_rule_name = _getNumberRuleName(str);\n      if (number_rule_name) {\n        number_rule = db.instance_number_rules.findOne({\n          space: spaceId,\n          name: number_rule_name\n        }, {\n          fields: {\n            _id: 1,\n            name: 1,\n            year: 1,\n            first_number: 1,\n            rules: 1\n          }\n        });\n        number_rule.number = 0;\n        if (!instance_number_rules.findPropertyByPK(\"_id\", number_rule._id)) {\n          delete number_rule._id;\n          instance_number_rules.push(number_rule);\n        }\n      }\n      return instance_number_rules;\n    };\n    fields.forEach(function(f) {\n      _getFieldNumberRule(form.space, instance_number_rules, f.default_value);\n      return _getFieldNumberRule(form.space, instance_number_rules, f.formula);\n    });\n  }\n  form.instance_number_rules = instance_number_rules;\n  form.flows = _getFlowByForm(formId, flowId, is_copy, company_id);\n  return form;\n};\n","steedosImport = {}\r\n\r\nsteedosImport.workflow = (uid, spaceId, form, enabled, company_id)->\r\n\r\n\tif _.isEmpty(form)\r\n\t\tthrow new Meteor.Error('error', \"无效的json data\")\r\n\r\n\tif company_id\r\n\t\tif Creator.getCollection(\"company\").find({ _id: company_id, space: spaceId }).count() == 0\r\n\t\t\tthrow new Meteor.Error('error', \"无效的字段: company_id\")\r\n\r\n\tnew_form_ids = new Array()\r\n\r\n\tnew_flow_ids = new Array()\r\n\ttry\r\n\t\tif form?.category_name\r\n\t\t\tcategory = db.categories.findOne({space: spaceId, name: form.category_name}, {fields: {_id: 1}})\r\n\r\n\t\t\tif _.isEmpty(category)\r\n\t\t\t\tcategory_id = new Mongo.ObjectID()._str;\r\n\t\t\t\tnew_category = {\r\n\t\t\t\t\t_id: category_id,\r\n\t\t\t\t\tname: form.category_name,\r\n\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\tcreated: new Date,\r\n\t\t\t\t\tcreated_by: uid,\r\n\t\t\t\t\tmodified: new Date,\r\n\t\t\t\t\tmodified_by: uid,\r\n\t\t\t\t\towner: uid\r\n\t\t\t\t}\r\n\t\t\t\tif company_id\r\n\t\t\t\t\tnew_category.company_id = company_id\r\n\t\t\t\tdb.categories.direct.insert(new_category);\r\n\t\t\t\tform.category = category_id\r\n\t\t\telse\r\n\t\t\t\tform.category = category._id\r\n\r\n\t\t\tdelete form.category_name\r\n\r\n\t\tif form?.instance_number_rules\r\n\t\t\tform.instance_number_rules.forEach (nr)->\r\n\t\t\t\ttry\r\n\t\t\t\t\trules = db.instance_number_rules.findOne({space: spaceId, \"name\": nr.name})\r\n\r\n\t\t\t\t\tif !rules\r\n\t\t\t\t\t\tnr.space = spaceId\r\n\t\t\t\t\t\tnr._id = new Mongo.ObjectID()._str\r\n\t\t\t\t\t\tnr.created = new Date\r\n\t\t\t\t\t\tnr.created_by = uid\r\n\t\t\t\t\t\tnr.modified = new Date\r\n\t\t\t\t\t\tnr.modified_by = uid\r\n\t\t\t\t\t\tif company_id\r\n\t\t\t\t\t\t\tnr.company_id = company_id\r\n\t\t\t\t\t\tdb.instance_number_rules.direct.insert(nr)\r\n\t\t\t\tcatch e\r\n\t\t\t\t\tconsole.log \"steedosImport.workflow\", e\r\n\r\n\t\t\tdelete form.instance_number_rules\r\n\r\n\t\tform_id = new Mongo.ObjectID()._str\r\n\r\n\t\tflows = form.flows\r\n\r\n\t\tdelete form.flows\r\n\r\n\t\tform._id = form_id\r\n\r\n\t\tform.space = spaceId\r\n\t\tif enabled\r\n\t\t\tform.state = 'enabled'\r\n\t\t\tform.is_valid = true #直接启用的表单设置is valid值为true\r\n\t\telse\r\n\t\t\tform.state = 'disabled' #设置状态为 未启用\r\n\t\t\tform.is_valid = true #设置已验证为 true , 简化用户操作\r\n\r\n\t\tform.created = new Date()\r\n\r\n\t\tform.created_by = uid\r\n\r\n\t\tform.modified = form.created\r\n\r\n\t\tform.modified_by = uid\r\n\r\n\t\tform.historys = []\r\n\r\n\t\tform.current._id = new Mongo.ObjectID()._str\r\n\r\n\t\tform.current._rev = 1 #重置版本号\r\n\r\n\t\tform.current.form = form_id\r\n\r\n\t\tform.current.created = new Date()\r\n\r\n\t\tform.current.created_by = uid\r\n\r\n\t\tform.current.modified = new Date()\r\n\r\n\t\tform.current.modified_by = uid\r\n\r\n\t\tdelete form.company_id\r\n\t\tif company_id\r\n\t\t\tform.company_id = company_id\r\n\r\n\t\tform.import = true\r\n\r\n\t\tform.owner = uid\r\n\r\n\t\tdb.forms.direct.insert(form)\r\n\r\n\t\tnew_form_ids.push(form_id)\r\n\r\n\t\tflows.forEach (flow)->\r\n\t\t\tflow_id = new Mongo.ObjectID()._str\r\n\r\n\t\t\tflow._id = flow_id\r\n\r\n\t\t\tflow.form = form_id\r\n\r\n\t\t\tif enabled\r\n\t\t\t\tflow.state = 'enabled'\r\n\t\t\t\tflow.is_valid = true #直接启用的流程设置is valid值为true\r\n\t\t\telse\r\n\t\t\t\tflow.state = 'disabled' #设置状态为 未启用\r\n\t\t\t\tflow.is_valid = true\r\n\r\n\t\t\tflow.current_no = 0 #重置编号起始为0\r\n\r\n\t\t\tflow.created = new Date()\r\n\r\n\t\t\tflow.created_by = uid\r\n\r\n\t\t\tflow.modified = flow.created\r\n\r\n\t\t\tflow.modified_by = uid\r\n\r\n\t\t\tdelete flow.company_id\r\n\t\t\tif company_id\r\n\t\t\t\tflow.company_id = company_id\r\n\t\t\t#跨工作区导入时，重置流程权限perms\r\n\t\t\tif !flow.perms || flow.space !=  spaceId || company_id\r\n\t\t\t\torgs_can_add = []\r\n\t\t\t\tif company_id\r\n\t\t\t\t\torgs_can_add = [company_id]\r\n\t\t\t\telse\r\n\t\t\t\t\torgs_can_add = db.organizations.find({\r\n\t\t\t\t\t\tspace: spaceId,\r\n\t\t\t\t\t\tparent: null\r\n\t\t\t\t\t}, {fields: {_id: 1}}).fetch().getProperty(\"_id\")\r\n\t\t\t\t#设置提交部门为：全公司\r\n\t\t\t\tperms = {\r\n\t\t\t\t\t_id: new Mongo.ObjectID()._str\r\n\t\t\t\t\tusers_can_add: []\r\n\t\t\t\t\torgs_can_add: orgs_can_add\r\n\t\t\t\t\tusers_can_monitor: []\r\n\t\t\t\t\torgs_can_monitor: []\r\n\t\t\t\t\tusers_can_admin: []\r\n\t\t\t\t\torgs_can_admin: []\r\n\t\t\t\t}\r\n\r\n\t\t\t\tflow.perms = perms\r\n\r\n\t\t\tflow.space = spaceId\r\n\r\n\t\t\tflow.current._id = new Mongo.ObjectID()._str\r\n\r\n\t\t\tflow.current.flow = flow_id\r\n\r\n\t\t\tflow.current._rev = 1 #重置版本\r\n\r\n\t\t\tflow.current.form_version = form.current._id\r\n\r\n\t\t\tflow.current.created = new Date()\r\n\r\n\t\t\tflow.current.created_by = uid\r\n\r\n\t\t\tflow.current.modified = new Date()\r\n\r\n\t\t\tflow.current.modified_by = uid\r\n\r\n\t\t\tflow.current?.steps.forEach (step)->\r\n\t\t\t\tif _.isEmpty(step.approver_roles_name)\r\n\t\t\t\t\tdelete step.approver_roles_name\r\n\t\t\t\t\tif _.isEmpty(step.approver_roles)\r\n\t\t\t\t\t\tstep.approver_roles = []\r\n\t\t\t\telse\r\n\t\t\t\t\tapprove_roles = new Array()\r\n\t\t\t\t\tstep.approver_roles_name.forEach (role_name) ->\r\n\r\n\t\t\t\t\t\tflow_role_query = {space: spaceId, name: role_name}\r\n\r\n\t\t\t\t\t\tif company_id\r\n\t\t\t\t\t\t\tflow_role_query.company_id = company_id\r\n\r\n\t\t\t\t\t\trole = db.flow_roles.findOne(flow_role_query, {fields: {_id: 1}})\r\n\t\t\t\t\t\tif _.isEmpty(role)\r\n\t\t\t\t\t\t\trole_id = db.flow_roles._makeNewID()\r\n\t\t\t\t\t\t\trole = {\r\n\t\t\t\t\t\t\t\t_id: role_id\r\n\t\t\t\t\t\t\t\tname: role_name\r\n\t\t\t\t\t\t\t\tspace: spaceId\r\n\t\t\t\t\t\t\t\tcreated: new Date\r\n\t\t\t\t\t\t\t\tcreated_by: uid\r\n\t\t\t\t\t\t\t\towner: uid\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tif company_id\r\n\t\t\t\t\t\t\t\trole.company_id = company_id\r\n\r\n\t\t\t\t\t\t\tdb.flow_roles.direct.insert(role)\r\n\r\n\t\t\t\t\t\t\tapprove_roles.push(role_id)\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tapprove_roles.push(role._id)\r\n\r\n\t\t\t\t\tstep.approver_roles = approve_roles\r\n\r\n\t\t\t\t\tdelete step.approver_roles_name\r\n\r\n\t\t\tflow.import = true\r\n\r\n\t\t\tflow.owner = uid\r\n\r\n\t\t\tdb.flows.direct.insert(flow)\r\n\r\n\t\t\tnew_flow_ids.push(flow_id)\r\n\r\n\t\treturn new_flow_ids;\r\n\tcatch e\r\n\t\tnew_form_ids.forEach (id)->\r\n\t\t\tdb.forms.direct.remove(id)\r\n\r\n\t\tnew_flow_ids.forEach (id)->\r\n\t\t\tdb.flows.direct.remove(id)\r\n\t\tthrow  e\r\n\r\n\r\n\r\n\r\n\r\n","                  \n\nsteedosImport = {};\n\nsteedosImport.workflow = function(uid, spaceId, form, enabled, company_id) {\n  var category, category_id, e, flows, form_id, new_category, new_flow_ids, new_form_ids;\n  if (_.isEmpty(form)) {\n    throw new Meteor.Error('error', \"无效的json data\");\n  }\n  if (company_id) {\n    if (Creator.getCollection(\"company\").find({\n      _id: company_id,\n      space: spaceId\n    }).count() === 0) {\n      throw new Meteor.Error('error', \"无效的字段: company_id\");\n    }\n  }\n  new_form_ids = new Array();\n  new_flow_ids = new Array();\n  try {\n    if (form != null ? form.category_name : void 0) {\n      category = db.categories.findOne({\n        space: spaceId,\n        name: form.category_name\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (_.isEmpty(category)) {\n        category_id = new Mongo.ObjectID()._str;\n        new_category = {\n          _id: category_id,\n          name: form.category_name,\n          space: spaceId,\n          created: new Date,\n          created_by: uid,\n          modified: new Date,\n          modified_by: uid,\n          owner: uid\n        };\n        if (company_id) {\n          new_category.company_id = company_id;\n        }\n        db.categories.direct.insert(new_category);\n        form.category = category_id;\n      } else {\n        form.category = category._id;\n      }\n      delete form.category_name;\n    }\n    if (form != null ? form.instance_number_rules : void 0) {\n      form.instance_number_rules.forEach(function(nr) {\n        var e, rules;\n        try {\n          rules = db.instance_number_rules.findOne({\n            space: spaceId,\n            \"name\": nr.name\n          });\n          if (!rules) {\n            nr.space = spaceId;\n            nr._id = new Mongo.ObjectID()._str;\n            nr.created = new Date;\n            nr.created_by = uid;\n            nr.modified = new Date;\n            nr.modified_by = uid;\n            if (company_id) {\n              nr.company_id = company_id;\n            }\n            return db.instance_number_rules.direct.insert(nr);\n          }\n        } catch (error) {\n          e = error;\n          return console.log(\"steedosImport.workflow\", e);\n        }\n      });\n      delete form.instance_number_rules;\n    }\n    form_id = new Mongo.ObjectID()._str;\n    flows = form.flows;\n    delete form.flows;\n    form._id = form_id;\n    form.space = spaceId;\n    if (enabled) {\n      form.state = 'enabled';\n      form.is_valid = true;\n    } else {\n      form.state = 'disabled';\n      form.is_valid = true;\n    }\n    form.created = new Date();\n    form.created_by = uid;\n    form.modified = form.created;\n    form.modified_by = uid;\n    form.historys = [];\n    form.current._id = new Mongo.ObjectID()._str;\n    form.current._rev = 1;\n    form.current.form = form_id;\n    form.current.created = new Date();\n    form.current.created_by = uid;\n    form.current.modified = new Date();\n    form.current.modified_by = uid;\n    delete form.company_id;\n    if (company_id) {\n      form.company_id = company_id;\n    }\n    form[\"import\"] = true;\n    form.owner = uid;\n    db.forms.direct.insert(form);\n    new_form_ids.push(form_id);\n    flows.forEach(function(flow) {\n      var flow_id, orgs_can_add, perms, ref;\n      flow_id = new Mongo.ObjectID()._str;\n      flow._id = flow_id;\n      flow.form = form_id;\n      if (enabled) {\n        flow.state = 'enabled';\n        flow.is_valid = true;\n      } else {\n        flow.state = 'disabled';\n        flow.is_valid = true;\n      }\n      flow.current_no = 0;\n      flow.created = new Date();\n      flow.created_by = uid;\n      flow.modified = flow.created;\n      flow.modified_by = uid;\n      delete flow.company_id;\n      if (company_id) {\n        flow.company_id = company_id;\n      }\n      if (!flow.perms || flow.space !== spaceId || company_id) {\n        orgs_can_add = [];\n        if (company_id) {\n          orgs_can_add = [company_id];\n        } else {\n          orgs_can_add = db.organizations.find({\n            space: spaceId,\n            parent: null\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch().getProperty(\"_id\");\n        }\n        perms = {\n          _id: new Mongo.ObjectID()._str,\n          users_can_add: [],\n          orgs_can_add: orgs_can_add,\n          users_can_monitor: [],\n          orgs_can_monitor: [],\n          users_can_admin: [],\n          orgs_can_admin: []\n        };\n        flow.perms = perms;\n      }\n      flow.space = spaceId;\n      flow.current._id = new Mongo.ObjectID()._str;\n      flow.current.flow = flow_id;\n      flow.current._rev = 1;\n      flow.current.form_version = form.current._id;\n      flow.current.created = new Date();\n      flow.current.created_by = uid;\n      flow.current.modified = new Date();\n      flow.current.modified_by = uid;\n      if ((ref = flow.current) != null) {\n        ref.steps.forEach(function(step) {\n          var approve_roles;\n          if (_.isEmpty(step.approver_roles_name)) {\n            delete step.approver_roles_name;\n            if (_.isEmpty(step.approver_roles)) {\n              return step.approver_roles = [];\n            }\n          } else {\n            approve_roles = new Array();\n            step.approver_roles_name.forEach(function(role_name) {\n              var flow_role_query, role, role_id;\n              flow_role_query = {\n                space: spaceId,\n                name: role_name\n              };\n              if (company_id) {\n                flow_role_query.company_id = company_id;\n              }\n              role = db.flow_roles.findOne(flow_role_query, {\n                fields: {\n                  _id: 1\n                }\n              });\n              if (_.isEmpty(role)) {\n                role_id = db.flow_roles._makeNewID();\n                role = {\n                  _id: role_id,\n                  name: role_name,\n                  space: spaceId,\n                  created: new Date,\n                  created_by: uid,\n                  owner: uid\n                };\n                if (company_id) {\n                  role.company_id = company_id;\n                }\n                db.flow_roles.direct.insert(role);\n                return approve_roles.push(role_id);\n              } else {\n                return approve_roles.push(role._id);\n              }\n            });\n            step.approver_roles = approve_roles;\n            return delete step.approver_roles_name;\n          }\n        });\n      }\n      flow[\"import\"] = true;\n      flow.owner = uid;\n      db.flows.direct.insert(flow);\n      return new_flow_ids.push(flow_id);\n    });\n    return new_flow_ids;\n  } catch (error) {\n    e = error;\n    new_form_ids.forEach(function(id) {\n      return db.forms.direct.remove(id);\n    });\n    new_flow_ids.forEach(function(id) {\n      return db.flows.direct.remove(id);\n    });\n    throw e;\n  }\n};\n","Creator.Apps.workflow =\r\n\tname: \"审批王\"\r\n\tsort: 100\r\n\tis_creator: false\r\n\r\n\t# Menu 支持两种类型的参数\r\n\t# - template_name 指向 Meteor Template, url=/app/admin/page/{template_name}/\r\n\t# - object_name 指向对象, url=/app/admin/{object_name}/grid/all/\t\r\n\tadmin_menus: [\r\n\t\t# 单位管理员可以创建和设置流程及相关参数。\r\n\t\t{ _id: 'menu_workflow', name: '审批', permission_sets: [\"user\"], expanded: false },\r\n\t\t{ _id: 'flows', name: '流程', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"flows\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'flow_roles', name: '审批岗位', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"flow_roles\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'flow_positions', name: '岗位成员', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"flow_positions\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'categories', name: '流程分类', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"categories\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'instance_number_rules', name: '流程编号', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"instance_number_rules\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'space_user_signs', name: '图片签名', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"space_user_signs\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'instances_statistic', name: '效率统计', permission_sets: [\"admin\", \"workflow_admin\"], object_name: \"instances_statistic\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'webhooks', name: 'Webhooks', permission_sets: [\"admin\"], object_name: \"webhooks\", parent: 'menu_workflow' },\r\n\t\t{ _id: 'process_delegation_rules', name: '流程委托', permission_sets: [\"user\"], object_name: \"process_delegation_rules\", parent: 'menu_workflow' },\r\n\t]\r\n\r\n","fs_store\r\nstore_name = \"instances\"\r\nif Meteor.settings.public.cfs?.store == \"OSS\"\r\n    if Meteor.isClient\r\n        fs_store = new FS.Store.OSS(store_name)\r\n    else if Meteor.isServer\r\n        fs_store = new FS.Store.OSS store_name,\r\n            region: Meteor.settings.cfs.aliyun.region\r\n            internal: Meteor.settings.cfs.aliyun.internal\r\n            bucket: Meteor.settings.cfs.aliyun.bucket\r\n            folder: Meteor.settings.cfs.aliyun.folder\r\n            accessKeyId: Meteor.settings.cfs.aliyun.accessKeyId\r\n            secretAccessKey: Meteor.settings.cfs.aliyun.secretAccessKey\r\n\r\nelse if Meteor.settings.public.cfs?.store == \"S3\"\r\n    if Meteor.isClient\r\n        fs_store = new FS.Store.S3(store_name)\r\n    else if Meteor.isServer\r\n        fs_store = new FS.Store.S3 store_name,\r\n            region: Meteor.settings.cfs.aws.region\r\n            bucket: Meteor.settings.cfs.aws.bucket\r\n            folder: Meteor.settings.cfs.aws.folder\r\n            accessKeyId: Meteor.settings.cfs.aws.accessKeyId\r\n            secretAccessKey: Meteor.settings.cfs.aws.secretAccessKey\r\nelse\r\n    if Meteor.isClient\r\n        fs_store = new FS.Store.FileSystem(store_name)\r\n    else if Meteor.isServer\r\n        fs_store = new FS.Store.FileSystem(store_name, {\r\n                path: require('path').join(Creator.steedosStorageDir, \"files/#{store_name}\"),\r\n                fileKeyMaker: (fileObj)->\r\n                    # Lookup the copy\r\n                    store = fileObj and fileObj._getInfo(store_name)\r\n                    # If the store and key is found return the key\r\n                    if store and store.key\r\n                        return store.key\r\n\r\n                    # TO CUSTOMIZE, REPLACE CODE AFTER THIS POINT\r\n\r\n                    filename = fileObj.name();\r\n                    filenameInStore = fileObj.name({store: store_name})\r\n\r\n                    name = filenameInStore || filename\r\n\r\n                    name_split = name.split('.')\r\n                    extention = name_split.pop()\r\n\r\n                    final_filename = name_split.join('.').substring(0,50) + '.' + extention\r\n\r\n                    now = new Date\r\n                    year = now.getFullYear()\r\n                    month = now.getMonth() + 1\r\n                    ins_id = fileObj.metadata.instance\r\n\r\n                    path = require('path')\r\n                    mkdirp = require('mkdirp')\r\n                    pathname = path.join(Creator.steedosStorageDir, \"files/#{store_name}/\" + year + '/' + month + '/' + ins_id)\r\n                    # Set absolute path\r\n                    absolutePath = path.resolve(pathname)\r\n                    # Ensure the path exists\r\n                    mkdirp.sync(absolutePath)\r\n\r\n                    # If no store key found we resolve / generate a key\r\n                    return year + '/' + month + '/' + ins_id + '/' + fileObj.collectionName + '-' + fileObj._id + '-' + final_filename\r\n\r\n            })\r\n\r\ncfs[store_name] = new FS.Collection store_name,\r\n    stores: [fs_store]\r\n\r\ncfs[store_name].allow\r\n    download: ->\r\n        return true;\r\n\r\nif Meteor.isServer\r\n        Meteor.startup ->\r\n                cfs.instances.files._ensureIndex({\"metadata.instance\": 1})\r\n                cfs.instances.files._ensureIndex({\"failures.copies.instances.doneTrying\": 1})\r\n                cfs.instances.files._ensureIndex({\"copies.instances\": 1})\r\n                cfs.instances.files._ensureIndex({\"uploadedAt\": 1})\r\n\r\n","fs_store;\nvar fs_store, ref, ref1, store_name;\n\nstore_name = \"instances\";\n\nif (((ref = Meteor.settings[\"public\"].cfs) != null ? ref.store : void 0) === \"OSS\") {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.OSS(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.OSS(store_name, {\n      region: Meteor.settings.cfs.aliyun.region,\n      internal: Meteor.settings.cfs.aliyun.internal,\n      bucket: Meteor.settings.cfs.aliyun.bucket,\n      folder: Meteor.settings.cfs.aliyun.folder,\n      accessKeyId: Meteor.settings.cfs.aliyun.accessKeyId,\n      secretAccessKey: Meteor.settings.cfs.aliyun.secretAccessKey\n    });\n  }\n} else if (((ref1 = Meteor.settings[\"public\"].cfs) != null ? ref1.store : void 0) === \"S3\") {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.S3(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.S3(store_name, {\n      region: Meteor.settings.cfs.aws.region,\n      bucket: Meteor.settings.cfs.aws.bucket,\n      folder: Meteor.settings.cfs.aws.folder,\n      accessKeyId: Meteor.settings.cfs.aws.accessKeyId,\n      secretAccessKey: Meteor.settings.cfs.aws.secretAccessKey\n    });\n  }\n} else {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.FileSystem(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.FileSystem(store_name, {\n      path: require('path').join(Creator.steedosStorageDir, \"files/\" + store_name),\n      fileKeyMaker: function(fileObj) {\n        var absolutePath, extention, filename, filenameInStore, final_filename, ins_id, mkdirp, month, name, name_split, now, path, pathname, store, year;\n        store = fileObj && fileObj._getInfo(store_name);\n        if (store && store.key) {\n          return store.key;\n        }\n        filename = fileObj.name();\n        filenameInStore = fileObj.name({\n          store: store_name\n        });\n        name = filenameInStore || filename;\n        name_split = name.split('.');\n        extention = name_split.pop();\n        final_filename = name_split.join('.').substring(0, 50) + '.' + extention;\n        now = new Date;\n        year = now.getFullYear();\n        month = now.getMonth() + 1;\n        ins_id = fileObj.metadata.instance;\n        path = require('path');\n        mkdirp = require('mkdirp');\n        pathname = path.join(Creator.steedosStorageDir, (\"files/\" + store_name + \"/\") + year + '/' + month + '/' + ins_id);\n        absolutePath = path.resolve(pathname);\n        mkdirp.sync(absolutePath);\n        return year + '/' + month + '/' + ins_id + '/' + fileObj.collectionName + '-' + fileObj._id + '-' + final_filename;\n      }\n    });\n  }\n}\n\ncfs[store_name] = new FS.Collection(store_name, {\n  stores: [fs_store]\n});\n\ncfs[store_name].allow({\n  download: function() {\n    return true;\n  }\n});\n\nif (Meteor.isServer) {\n  Meteor.startup(function() {\n    cfs.instances.files._ensureIndex({\n      \"metadata.instance\": 1\n    });\n    cfs.instances.files._ensureIndex({\n      \"failures.copies.instances.doneTrying\": 1\n    });\n    cfs.instances.files._ensureIndex({\n      \"copies.instances\": 1\n    });\n    return cfs.instances.files._ensureIndex({\n      \"uploadedAt\": 1\n    });\n  });\n}\n","Cookies = require(\"cookies\")\r\n\r\nMeteor.startup ->\r\n\tWebApp.connectHandlers.use \"/api/workflow/export/form\", (req, res, next)->\r\n\t\tcookies = new Cookies( req, res );\r\n\t\t# first check request body\r\n\t\tif req.body\r\n\t\t\tuserId = req.body[\"X-User-Id\"]\r\n\t\t\tauthToken = req.body[\"X-Auth-Token\"]\r\n\r\n\t\t# then check cookie\r\n\t\tif !userId or !authToken\r\n\t\t\tuserId = cookies.get(\"X-User-Id\")\r\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\t\tif !(userId and authToken)\r\n\t\t\tres.writeHead(401);\r\n\t\t\tres.end JSON.stringify({\r\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\r\n\t\t\t\t\"success\": false\r\n\t\t\t})\r\n\t\t\treturn ;\r\n\r\n\t\tformId = req.query?.form;\r\n\r\n\t\tform = db.forms.findOne({_id: formId}, {fields: {space: 1}})\r\n\r\n\t\tif _.isEmpty(form)\r\n\t\t\tres.writeHead(401);\r\n\t\t\tres.end JSON.stringify({\r\n\t\t\t\t\"error\": \"Validate Request -- Invalid formId\",\r\n\t\t\t\t\"success\": false\r\n\t\t\t})\r\n\t\t\treturn ;\r\n\t\telse\r\n#\t\t\tif !Steedos.isSpaceAdmin(form.space, userId)\r\n#\t\t\t\tres.writeHead(401);\r\n#\t\t\t\tres.end JSON.stringify({\r\n#\t\t\t\t\t\"error\": \"Validate Request -- No permission\",\r\n#\t\t\t\t\t\"success\": false\r\n#\t\t\t\t})\r\n#\t\t\t\treturn;\r\n\r\n\t\t\tspace = db.spaces.findOne(form.space, { fields: { is_paid: 1 } })\r\n\t\t\tif !space?.is_paid\r\n\t\t\t\tJsonRoutes.sendResult res,\r\n\t\t\t\t\tcode: 404,\r\n\t\t\t\t\tdata:\r\n\t\t\t\t\t\t\"error\": \"Validate Request -- Non-paid space.\",\r\n\t\t\t\t\t\t\"success\": false\r\n\t\t\t\treturn;\r\n\r\n\t\tdata = steedosExport.form(formId);\r\n\r\n\t\tif _.isEmpty(data)\r\n\t\t\tfileName = 'null'\r\n\t\telse\r\n\t\t\tfileName = data.name\r\n\r\n\t\tres.setHeader('Content-type', 'application/x-msdownload');\r\n\t\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(fileName)+'.json');\r\n\t\tres.end(JSON.stringify(data))","var Cookies;\n\nCookies = require(\"cookies\");\n\nMeteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/form\", function(req, res, next) {\n    var authToken, cookies, data, fileName, form, formId, ref, space, userId;\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Missing X-Auth-Token\",\n        \"success\": false\n      }));\n      return;\n    }\n    formId = (ref = req.query) != null ? ref.form : void 0;\n    form = db.forms.findOne({\n      _id: formId\n    }, {\n      fields: {\n        space: 1\n      }\n    });\n    if (_.isEmpty(form)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Invalid formId\",\n        \"success\": false\n      }));\n      return;\n    } else {\n      space = db.spaces.findOne(form.space, {\n        fields: {\n          is_paid: 1\n        }\n      });\n      if (!(space != null ? space.is_paid : void 0)) {\n        JsonRoutes.sendResult(res, {\n          code: 404,\n          data: {\n            \"error\": \"Validate Request -- Non-paid space.\",\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    data = steedosExport.form(formId);\n    if (_.isEmpty(data)) {\n      fileName = 'null';\n    } else {\n      fileName = data.name;\n    }\n    res.setHeader('Content-type', 'application/x-msdownload');\n    res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(fileName) + '.json');\n    return res.end(JSON.stringify(data));\n  });\n});\n","Cookies = require(\"cookies\")\r\n\r\nJsonRoutes.add \"post\", \"/api/workflow/import/form\", (req, res, next) ->\r\n\tcookies = new Cookies( req, res );\r\n\r\n\tmsg = \"\"\r\n\t# first check request body\r\n\tif req.body\r\n\t\tuid = req.body[\"X-User-Id\"]\r\n\t\tauthToken = req.body[\"X-Auth-Token\"]\r\n\r\n\t# then check cookie\r\n\tif !uid or !authToken\r\n\t\tuid = cookies.get(\"X-User-Id\")\r\n\t\tauthToken = cookies.get(\"X-Auth-Token\")\r\n\r\n\tif !(uid and authToken)\r\n\t\tres.writeHead(401);\r\n\t\tres.end JSON.stringify({\r\n\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\r\n\t\t\t\"success\": false\r\n\t\t})\r\n\t\treturn ;\r\n\r\n\tspaceId = req.query?.space;\r\n\r\n\tcompany_id = req.query?.company_id;\r\n\r\n\tspace = db.spaces.findOne(spaceId, { fields: { is_paid: 1 } })\r\n\r\n\tif !space?.is_paid\r\n\t\tJsonRoutes.sendResult res,\r\n\t\t\tcode: 404,\r\n\t\t\tdata:\r\n\t\t\t\t\"error\": \"Validate Request -- Non-paid space.\",\r\n\t\t\t\t\"success\": false\r\n\t\treturn;\r\n\r\n\tif !WorkflowCore.checkCreatePermissions(spaceId, uid, company_id)\r\n\t\tres.writeHead(401);\r\n\t\tres.end JSON.stringify({\r\n\t\t\t\"error\": \"Validate Request -- No permission\",\r\n\t\t\t\"success\": false\r\n\t\t})\r\n\t\treturn\r\n\r\n\ttry\r\n\t\tJsonRoutes.parseFiles req, res, ()->\r\n\t\t\ttry\r\n\t\t\t\tif req.files and req.files[0]\r\n\r\n\t\t\t\t\tjsonData = req.files[0].data.toString(\"utf-8\")\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t\tform = JSON.parse(jsonData)\r\n\t\t\t\t\t\tnew_flowIds = steedosImport.workflow(uid, spaceId, form, false, company_id);\r\n\t\t\t\t\t\tmsg = JSON.stringify({new_flows: new_flowIds})\r\n\t\t\t\t\t\tres.statusCode = 200;\r\n\t\t\t\t\tcatch e\r\n\t\t\t\t\t\tconsole.error e\r\n\t\t\t\t\t\tmsg = e.reason\r\n\t\t\t\t\t\tres.statusCode = 500;\r\n\t\t\t\t\tres.end(msg)\r\n\t\t\t\t\treturn\r\n\t\t\t\telse\r\n\t\t\t\t\tmsg = \"无效的附件\"\r\n\t\t\t\t\tres.statusCode = 500;\r\n\t\t\t\t\tres.end(msg);\r\n\t\t\tcatch e1\r\n\t\t\t\tmsg = \"无效的JSON文件\"\r\n\t\t\t\tres.statusCode = 500;\r\n\t\t\t\tres.end(msg);\r\n\tcatch e\r\n\t\tconsole.log(e)\r\n\r\n","var Cookies;\n\nCookies = require(\"cookies\");\n\nJsonRoutes.add(\"post\", \"/api/workflow/import/form\", function(req, res, next) {\n  var authToken, company_id, cookies, e, msg, ref, ref1, space, spaceId, uid;\n  cookies = new Cookies(req, res);\n  msg = \"\";\n  if (req.body) {\n    uid = req.body[\"X-User-Id\"];\n    authToken = req.body[\"X-Auth-Token\"];\n  }\n  if (!uid || !authToken) {\n    uid = cookies.get(\"X-User-Id\");\n    authToken = cookies.get(\"X-Auth-Token\");\n  }\n  if (!(uid && authToken)) {\n    res.writeHead(401);\n    res.end(JSON.stringify({\n      \"error\": \"Validate Request -- Missing X-Auth-Token\",\n      \"success\": false\n    }));\n    return;\n  }\n  spaceId = (ref = req.query) != null ? ref.space : void 0;\n  company_id = (ref1 = req.query) != null ? ref1.company_id : void 0;\n  space = db.spaces.findOne(spaceId, {\n    fields: {\n      is_paid: 1\n    }\n  });\n  if (!(space != null ? space.is_paid : void 0)) {\n    JsonRoutes.sendResult(res, {\n      code: 404,\n      data: {\n        \"error\": \"Validate Request -- Non-paid space.\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!WorkflowCore.checkCreatePermissions(spaceId, uid, company_id)) {\n    res.writeHead(401);\n    res.end(JSON.stringify({\n      \"error\": \"Validate Request -- No permission\",\n      \"success\": false\n    }));\n    return;\n  }\n  try {\n    return JsonRoutes.parseFiles(req, res, function() {\n      var e, e1, form, jsonData, new_flowIds;\n      try {\n        if (req.files && req.files[0]) {\n          jsonData = req.files[0].data.toString(\"utf-8\");\n          try {\n            form = JSON.parse(jsonData);\n            new_flowIds = steedosImport.workflow(uid, spaceId, form, false, company_id);\n            msg = JSON.stringify({\n              new_flows: new_flowIds\n            });\n            res.statusCode = 200;\n          } catch (error) {\n            e = error;\n            console.error(e);\n            msg = e.reason;\n            res.statusCode = 500;\n          }\n          res.end(msg);\n        } else {\n          msg = \"无效的附件\";\n          res.statusCode = 500;\n          return res.end(msg);\n        }\n      } catch (error) {\n        e1 = error;\n        msg = \"无效的JSON文件\";\n        res.statusCode = 500;\n        return res.end(msg);\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.log(e);\n  }\n});\n"]}