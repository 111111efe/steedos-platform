{"version":3,"sources":["meteor://💻app/packages/steedos_object-database/server/routes/api_creator_objects.coffee","meteor://💻app/server/routes/api_creator_objects.coffee","meteor://💻app/packages/steedos_object-database/server/publications/objects.coffee","meteor://💻app/server/publications/objects.coffee","meteor://💻app/packages/steedos_object-database/server/publications/object_layouts.coffee","meteor://💻app/server/publications/object_layouts.coffee"],"names":["_getLocale","clone","getUserProfileObjectLayout","steedosI18n","require","user","locale","ref","ref1","toLocaleLowerCase","userId","spaceId","objectName","spaceUser","Creator","getCollection","findOne","space","fields","profile","profiles","object_name","JsonRoutes","add","req","res","next","_fields","_id","_object","e","isSpaceAdmin","lng","object","objectLayout","psets","psetsAdmin","psetsCurrent","psetsUser","type","params","headers","query","_","isEmpty","in_development","is_enable","Object","db","list_views","getUserObjectListViews","name","assigned_apps","find","users","fetch","permissions","getObjectPermissions","bind","translationObject","assign","datasource","each","_item","field","has","group","required","readonly","disabled","allow_actions","actions","sendResult","code","data","error","console","stack","errors","errorMessage","reason","message","objectql","Meteor","publish","config","getSteedosConfig","tenant","saas","$in","modified"],"mappings":"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","file":"/packages/steedos_object-database.js","sourcesContent":["clone = require(\"clone\");\r\nsteedosI18n = require(\"@steedos/i18n\");\r\n\r\n_getLocale = (user)->\r\n\tif user?.locale?.toLocaleLowerCase() == 'zh-cn'\r\n\t\tlocale = \"zh-CN\"\r\n\telse if user?.locale?.toLocaleLowerCase() == 'en-us'\r\n\t\tlocale = \"en\"\r\n\telse\r\n\t\tlocale = \"zh-CN\"\r\n\treturn locale\r\n\r\ngetUserProfileObjectLayout = (userId, spaceId, objectName)->\r\n\tspaceUser = Creator.getCollection(\"space_users\").findOne({space: spaceId, user: userId}, {fields: {profile: 1}})\r\n\tif spaceUser && spaceUser.profile\r\n\t\treturn Creator.getCollection(\"object_layouts\")?.findOne({space: spaceId, profiles: spaceUser.profile, object_name: objectName});\r\n\r\nJsonRoutes.add 'get', '/api/creator/:space/objects/:_id', (req, res, next) ->\r\n\ttry\r\n\t\t_id = req.params._id\r\n\t\tspaceId = req.params.space\r\n\t\tuserId = req.headers[\"x-user-id\"]\r\n\r\n\t\ttype = req.query?.type\r\n\r\n\t\t_object = Creator.getCollection('objects').findOne(_id) || {}\r\n\r\n\t\tobject = {}\r\n\t\tisSpaceAdmin = Creator.isSpaceAdmin(spaceId, userId)\r\n\t\tif !_.isEmpty(_object)\r\n\t\t\tif isSpaceAdmin || _object.in_development == '0' && _object.is_enable\r\n\t\t\t\tobject = clone(new Creator.Object(_object));\r\n\t\t\t\tdelete object.db\r\n\t\t\t\tobject.list_views = Creator.getUserObjectListViews(userId, spaceId, object.name)\r\n\t#\t\t\tif type == \"added\"\r\n\t\t\t\tpsetsAdmin = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'admin'}, {fields:{_id:1, assigned_apps:1}})\r\n\t\t\t\tpsetsUser = Creator.getCollection(\"permission_set\").findOne({space: spaceId, name: 'user'}, {fields:{_id:1, assigned_apps:1}})\r\n\t\t\t\tpsetsCurrent = Creator.getCollection(\"permission_set\").find({users: userId, space: spaceId}, {fields:{_id:1, assigned_apps:1}}).fetch()\r\n\t\t\t\tpsets = { psetsAdmin, psetsUser, psetsCurrent }\r\n\r\n\t\t\t\tobject.permissions = Creator.getObjectPermissions.bind(psets)(spaceId, userId, object.name)\r\n\r\n\t\t\t\tlng = _getLocale(db.users.findOne(userId, {fields: {locale: 1}}))\r\n\t\t\t\tsteedosI18n.translationObject(lng, object.name, Object.assign(object, {datasource: _object.datasource}))\r\n\r\n\t\t\t\tobjectLayout = getUserProfileObjectLayout(userId, spaceId, object.name)\r\n\t\t\t\tif objectLayout\r\n\t\t\t\t\t_fields = {};\r\n\t\t\t\t\t_.each objectLayout.fields, (_item)->\r\n\t\t\t\t\t\t_fields[_item.field] = object.fields[_item.field]\r\n\t\t\t\t\t\tif _.has(_item, 'group')\r\n\t\t\t\t\t\t\t_fields[_item.field].group = _item.group\r\n\t\t\t\t\t\tif _item.required\r\n\t\t\t\t\t\t\t_fields[_item.field].readonly = false\r\n\t\t\t\t\t\t\t_fields[_item.field].disabled = false\r\n\t\t\t\t\t\t\t_fields[_item.field].required = true\r\n\t\t\t\t\t\telse if _item.readonly\r\n\t\t\t\t\t\t\t_fields[_item.field].readonly = true\r\n\t\t\t\t\t\t\t_fields[_item.field].disabled = true\r\n\t\t\t\t\t\t\t_fields[_item.field].required = false\r\n\t\t\t\t\tobject.fields = _fields\r\n\t\t\t\t\tobject.allow_actions = objectLayout.actions || []\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: object\r\n\t\t}\r\n\tcatch e\r\n\t\tconsole.error e.stack\r\n\t\tJsonRoutes.sendResult res, {\r\n\t\t\tcode: 200\r\n\t\t\tdata: { errors: [{ errorMessage: e.reason || e.message }] }\r\n\t\t}","var _getLocale, clone, getUserProfileObjectLayout, steedosI18n;\n\nclone = require(\"clone\");\n\nsteedosI18n = require(\"@steedos/i18n\");\n\n_getLocale = function(user) {\n  var locale, ref, ref1;\n  if ((user != null ? (ref = user.locale) != null ? ref.toLocaleLowerCase() : void 0 : void 0) === 'zh-cn') {\n    locale = \"zh-CN\";\n  } else if ((user != null ? (ref1 = user.locale) != null ? ref1.toLocaleLowerCase() : void 0 : void 0) === 'en-us') {\n    locale = \"en\";\n  } else {\n    locale = \"zh-CN\";\n  }\n  return locale;\n};\n\ngetUserProfileObjectLayout = function(userId, spaceId, objectName) {\n  var ref, spaceUser;\n  spaceUser = Creator.getCollection(\"space_users\").findOne({\n    space: spaceId,\n    user: userId\n  }, {\n    fields: {\n      profile: 1\n    }\n  });\n  if (spaceUser && spaceUser.profile) {\n    return (ref = Creator.getCollection(\"object_layouts\")) != null ? ref.findOne({\n      space: spaceId,\n      profiles: spaceUser.profile,\n      object_name: objectName\n    }) : void 0;\n  }\n};\n\nJsonRoutes.add('get', '/api/creator/:space/objects/:_id', function(req, res, next) {\n  var _fields, _id, _object, e, isSpaceAdmin, lng, object, objectLayout, psets, psetsAdmin, psetsCurrent, psetsUser, ref, spaceId, type, userId;\n  try {\n    _id = req.params._id;\n    spaceId = req.params.space;\n    userId = req.headers[\"x-user-id\"];\n    type = (ref = req.query) != null ? ref.type : void 0;\n    _object = Creator.getCollection('objects').findOne(_id) || {};\n    object = {};\n    isSpaceAdmin = Creator.isSpaceAdmin(spaceId, userId);\n    if (!_.isEmpty(_object)) {\n      if (isSpaceAdmin || _object.in_development === '0' && _object.is_enable) {\n        object = clone(new Creator.Object(_object));\n        delete object.db;\n        object.list_views = Creator.getUserObjectListViews(userId, spaceId, object.name);\n        psetsAdmin = Creator.getCollection(\"permission_set\").findOne({\n          space: spaceId,\n          name: 'admin'\n        }, {\n          fields: {\n            _id: 1,\n            assigned_apps: 1\n          }\n        });\n        psetsUser = Creator.getCollection(\"permission_set\").findOne({\n          space: spaceId,\n          name: 'user'\n        }, {\n          fields: {\n            _id: 1,\n            assigned_apps: 1\n          }\n        });\n        psetsCurrent = Creator.getCollection(\"permission_set\").find({\n          users: userId,\n          space: spaceId\n        }, {\n          fields: {\n            _id: 1,\n            assigned_apps: 1\n          }\n        }).fetch();\n        psets = {\n          psetsAdmin: psetsAdmin,\n          psetsUser: psetsUser,\n          psetsCurrent: psetsCurrent\n        };\n        object.permissions = Creator.getObjectPermissions.bind(psets)(spaceId, userId, object.name);\n        lng = _getLocale(db.users.findOne(userId, {\n          fields: {\n            locale: 1\n          }\n        }));\n        steedosI18n.translationObject(lng, object.name, Object.assign(object, {\n          datasource: _object.datasource\n        }));\n        objectLayout = getUserProfileObjectLayout(userId, spaceId, object.name);\n        if (objectLayout) {\n          _fields = {};\n          _.each(objectLayout.fields, function(_item) {\n            _fields[_item.field] = object.fields[_item.field];\n            if (_.has(_item, 'group')) {\n              _fields[_item.field].group = _item.group;\n            }\n            if (_item.required) {\n              _fields[_item.field].readonly = false;\n              _fields[_item.field].disabled = false;\n              return _fields[_item.field].required = true;\n            } else if (_item.readonly) {\n              _fields[_item.field].readonly = true;\n              _fields[_item.field].disabled = true;\n              return _fields[_item.field].required = false;\n            }\n          });\n          object.fields = _fields;\n          object.allow_actions = objectLayout.actions || [];\n        }\n      }\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: object\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason || e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","objectql = require(\"@steedos/objectql\");\r\nMeteor.publish \"creator_objects\", (space)->\r\n\t#TODO 根据权限返回Objects记录\r\n\tconfig = objectql.getSteedosConfig();\r\n\tif config.tenant && config.tenant.saas\r\n\t\treturn\r\n\tCreator.getCollection(\"objects\").find({space: {$in: [null, space]}}, {fields: {_id: 1, modified: 1, is_enable: 1, in_development: 1}})","var objectql;\n\nobjectql = require(\"@steedos/objectql\");\n\nMeteor.publish(\"creator_objects\", function(space) {\n  var config;\n  config = objectql.getSteedosConfig();\n  if (config.tenant && config.tenant.saas) {\n    return;\n  }\n  return Creator.getCollection(\"objects\").find({\n    space: {\n      $in: [null, space]\n    }\n  }, {\n    fields: {\n      _id: 1,\n      modified: 1,\n      is_enable: 1,\n      in_development: 1\n    }\n  });\n});\n","Meteor.publish \"publish_object_layouts\", (space)->\r\n\tuserId = this.userId\r\n\tif !userId\r\n\t\treturn\r\n\tspaceUser = Creator.getCollection(\"space_users\").findOne({space: space, user: userId}, {fields: {profile: 1}})\r\n\tif spaceUser && spaceUser.profile\r\n\t\tCreator.getCollection(\"object_layouts\").find({space: {$in: [null, space]}, profiles: spaceUser.profile}, {fields: {_id: 1, modified: 1, object_name: 1}})","Meteor.publish(\"publish_object_layouts\", function(space) {\n  var spaceUser, userId;\n  userId = this.userId;\n  if (!userId) {\n    return;\n  }\n  spaceUser = Creator.getCollection(\"space_users\").findOne({\n    space: space,\n    user: userId\n  }, {\n    fields: {\n      profile: 1\n    }\n  });\n  if (spaceUser && spaceUser.profile) {\n    return Creator.getCollection(\"object_layouts\").find({\n      space: {\n        $in: [null, space]\n      },\n      profiles: spaceUser.profile\n    }, {\n      fields: {\n        _id: 1,\n        modified: 1,\n        object_name: 1\n      }\n    });\n  }\n});\n"]}