{"version":3,"sources":["meteor://💻app/packages/steedos_workflow-chart/routes/chart.coffee","meteor://💻app/routes/chart.coffee"],"names":["FlowversionAPI","traceMaxApproveCount","traceSplitApprovesIndex","isExpandApprove","getAbsoluteUrl","url","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","writeResponse","res","httpCode","body","statusCode","end","sendInvalidURLResponse","sendAuthTokenExpiredResponse","replaceErrorSymbol","str","replace","getStepHandlerName","step","approverNames","stepHandlerName","deal_type","approver_users","map","userId","user","db","users","findOne","name","join","approver_roles","roleId","role","flow_roles","getStepName","stepName","generateStepsGraphSyntax","steps","currentStepId","isConvertToString","graphSyntax","nodes","forEach","lines","length","line","toStepName","step_type","push","_id","findPropertyByPK","to_step","getApproveJudgeText","judge","judgeText","locale","TAPi18n","__","getTraceName","traceName","approveHandlerName","getTraceFromApproveCountersWithType","trace","approves","counters","approve","from_approve_id","type","getTraceCountersWithType","traceFromApproveCounters","toApprove","toApproveFromId","toApproveHandlerName","toApproveType","handler_name","fromApprove","counter","counter2","counterContent","ref","from_type","from_approve_handler_name","to_approve_id","to_approve_handler_name","count","to_approve_handler_names","is_total","pushApprovesWithTypeGraphSyntax","currentTraceName","extraHandlerNamesCounter","fromApproveId","results","splitIndex","tempHandlerNames","toApproveId","toApproves","traceCounters","extraCount","isTypeNode","strToHandlerNames","toHandlerNames","typeName","indexOf","splice","_","isEmpty","results1","generateTracesGraphSyntax","traces","lastApproves","lastTrace","previous_trace_ids","currentFromTraceName","fromApproves","fromTrace","fromApproveHandlerName","fromTraceName","toTraceName","lastApprove","sendHtmlResponse","req","error_msg","flowversion","instance","instance_id","query","ref1","title","decodeURIComponent","instances","fields","flow_version","flow","$slice","WorkflowManager","getInstanceFlowVersion","JSON","stringify","JsonRoutes","add","next"],"mappings":"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","file":"/packages/steedos_workflow-chart.js","sourcesContent":["FlowversionAPI =\r\n\r\n\ttraceMaxApproveCount: 10\r\n\ttraceSplitApprovesIndex: 5\r\n\tisExpandApprove: false\r\n\r\n\tgetAbsoluteUrl: (url)->\r\n\t\trootUrl = if __meteor_runtime_config__ then __meteor_runtime_config__.ROOT_URL_PATH_PREFIX else \"\"\r\n\t\tif rootUrl\r\n\t\t\turl = rootUrl + url\r\n\t\treturn url;\r\n\r\n\twriteResponse: (res, httpCode, body)->\r\n\t\tres.statusCode = httpCode;\r\n\t\tres.end(body);\r\n\t\t\r\n\tsendInvalidURLResponse: (res)->\r\n\t\treturn @writeResponse(res, 404, \"url must has querys as instance_id.\");\r\n\t\t\r\n\tsendAuthTokenExpiredResponse: (res)->\r\n\t\treturn @writeResponse(res, 401, \"the auth_token has expired.\");\r\n\r\n\treplaceErrorSymbol: (str)->\r\n\t\treturn str.replace(/\\\"/g,\"&quot;\").replace(/\\n/g,\"<br/>\")\r\n\r\n\tgetStepHandlerName: (step)->\r\n\t\tswitch step.deal_type\r\n\t\t\twhen 'specifyUser'\r\n\t\t\t\tapproverNames = step.approver_users.map (userId)->\r\n\t\t\t\t\tuser = db.users.findOne(userId)\r\n\t\t\t\t\tif user\r\n\t\t\t\t\t\treturn user.name\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\treturn \"\"\r\n\t\t\t\tstepHandlerName = approverNames.join(\",\")\r\n\t\t\twhen 'applicantRole'\r\n\t\t\t\tapproverNames = step.approver_roles.map (roleId)->\r\n\t\t\t\t\trole = db.flow_roles.findOne(roleId)\r\n\t\t\t\t\tif role\r\n\t\t\t\t\t\treturn role.name\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\treturn \"\"\r\n\t\t\t\tstepHandlerName = approverNames.join(\",\")\r\n\t\t\telse\r\n\t\t\t\tstepHandlerName = ''\r\n\t\t\t\tbreak\r\n\t\treturn stepHandlerName\r\n\r\n\tgetStepName: (stepName, stepHandlerName)->\r\n\t\t# 返回step节点名称\r\n\t\tif stepName\r\n\t\t\tstepName = \"<div class='graph-node'>\r\n\t\t\t\t<div class='step-name'>#{stepName}</div>\r\n\t\t\t\t<div class='step-handler-name'>#{stepHandlerName}</div>\r\n\t\t\t</div>\"\r\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\r\n\t\t\tstepName = FlowversionAPI.replaceErrorSymbol(stepName)\r\n\t\telse\r\n\t\t\tstepName = \"\"\r\n\t\treturn stepName\r\n\r\n\tgenerateStepsGraphSyntax: (steps, currentStepId, isConvertToString)->\r\n\t\t# 该函数返回以下格式的graph脚本\r\n\t\t# graphSyntax = '''\r\n\t\t# \tgraph LR\r\n\t\t# \t\tA-->B\r\n\t\t# \t\tA-->C\r\n\t\t# \t\tB-->C\r\n\t\t# \t\tC-->A\r\n\t\t# \t\tD-->C\r\n\t\t# \t'''\r\n\t\tnodes = [\"graph TB\"]\r\n\t\tsteps.forEach (step)->\r\n\t\t\tlines = step.lines\r\n\t\t\tif lines?.length\r\n\t\t\t\tlines.forEach (line)->\r\n\t\t\t\t\tif step.name\r\n\t\t\t\t\t\t# 标记条件节点\r\n\t\t\t\t\t\tif step.step_type == \"condition\"\r\n\t\t\t\t\t\t\tnodes.push \"\tclass #{step._id} condition;\"\r\n\t\t\t\t\t\tstepHandlerName = FlowversionAPI.getStepHandlerName(step)\r\n\t\t\t\t\t\tstepName = FlowversionAPI.getStepName(step.name, stepHandlerName)\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tstepName = \"\"\r\n\t\t\t\t\ttoStepName = steps.findPropertyByPK(\"_id\",line.to_step).name\r\n\t\t\t\t\ttoStepName = FlowversionAPI.getStepName(toStepName, \"\")\r\n\t\t\t\t\tnodes.push \"\t#{step._id}(\\\"#{stepName}\\\")-->#{line.to_step}(\\\"#{toStepName}\\\")\"\r\n\r\n\t\tif currentStepId\r\n\t\t\tnodes.push \"\tclass #{currentStepId} current-step-node;\"\r\n\t\tif isConvertToString\r\n\t\t\tgraphSyntax = nodes.join \"\\n\"\r\n\t\t\treturn graphSyntax\r\n\t\telse\r\n\t\t\treturn nodes\r\n\r\n\tgetApproveJudgeText: (judge)->\r\n\t\tlocale = \"zh-CN\"\r\n\t\tswitch judge\r\n\t\t\twhen 'approved'\r\n\t\t\t\t# 已核准\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State approved', {}, locale)\r\n\t\t\twhen 'rejected'\r\n\t\t\t\t# 已驳回\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State rejected', {}, locale)\r\n\t\t\twhen 'terminated'\r\n\t\t\t\t# 已取消\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State terminated', {}, locale)\r\n\t\t\twhen 'reassigned'\r\n\t\t\t\t# 转签核\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State reassigned', {}, locale)\r\n\t\t\twhen 'relocated'\r\n\t\t\t\t# 重定位\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State relocated', {}, locale)\r\n\t\t\twhen 'retrieved'\r\n\t\t\t\t# 已取回\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State retrieved', {}, locale)\r\n\t\t\twhen 'returned'\r\n\t\t\t\t# 已退回\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State returned', {}, locale)\r\n\t\t\twhen 'readed'\r\n\t\t\t\t# 已阅\r\n\t\t\t\tjudgeText = TAPi18n.__('Instance State readed', {}, locale)\r\n\t\t\telse\r\n\t\t\t\tjudgeText = ''\r\n\t\t\t\tbreak\r\n\t\treturn judgeText\r\n\r\n\tgetTraceName: (traceName, approveHandlerName)->\r\n\t\t# 返回trace节点名称\r\n\t\tif traceName\r\n\t\t\t# 把特殊字符清空或替换，以避免mermaidAPI出现异常\r\n\t\t\ttraceName = \"<div class='graph-node'>\r\n\t\t\t\t<div class='trace-name'>#{traceName}</div>\r\n\t\t\t\t<div class='trace-handler-name'>#{approveHandlerName}</div>\r\n\t\t\t</div>\"\r\n\t\t\ttraceName = FlowversionAPI.replaceErrorSymbol(traceName)\r\n\t\telse\r\n\t\t\ttraceName = \"\"\r\n\t\treturn traceName\r\n\t\r\n\tgetTraceFromApproveCountersWithType: (trace)->\r\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发节点有有后续子节点的计数情况，其结构为：\r\n\t\t# counters = {\r\n\t\t# \t[fromApproveId(来源节点ID)]:{\r\n\t\t# \t\t[toApproveType(目标结点类型)]:目标节点在指定类型下的后续节点个数\r\n\t\t# \t}\r\n\t\t# }\r\n\t\tcounters = {}\r\n\t\tapproves = trace.approves\r\n\t\tunless approves\r\n\t\t\treturn null\r\n\t\tapproves.forEach (approve)->\r\n\t\t\tif approve.from_approve_id\r\n\t\t\t\tunless counters[approve.from_approve_id]\r\n\t\t\t\t\tcounters[approve.from_approve_id] = {}\r\n\t\t\t\tif counters[approve.from_approve_id][approve.type]\r\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type]++\r\n\t\t\t\telse\r\n\t\t\t\t\tcounters[approve.from_approve_id][approve.type] = 1\r\n\t\treturn counters\r\n\r\n\tgetTraceCountersWithType: (trace, traceFromApproveCounters)->\r\n\t\t# 该函数生成json结构，表现出所有传阅、分发、转发的节点流向，其结构为：\r\n\t\t# counters = {\r\n\t\t# \t[fromApproveId(来源节点ID)]:{\r\n\t\t# \t\t[toApproveType(目标结点类型)]:[{\r\n\t\t# \t\t\tfrom_type: 来源节点类型\r\n\t\t# \t\t\tfrom_approve_handler_name: 来源节点处理人\r\n\t\t# \t\t\tto_approve_id: 目标节点ID\r\n\t\t# \t\t\tto_approve_handler_names: [多个目标节点汇总处理人集合]\r\n\t\t# \t\t\tis_total: true/false，是否汇总节点\r\n\t\t# \t\t},...]\r\n\t\t# \t}\r\n\t\t# }\r\n\t\t# 上述目标结点内容中有一个属性is_total表示是否汇总节点，如果是，则把多个节点汇总合并成一个，\r\n\t\t# 但是本身有后续子节点的节点不参与汇总及计数。\r\n\t\tcounters = {}\r\n\t\tapproves = trace.approves\r\n\t\tunless approves\r\n\t\t\treturn null\r\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\r\n\t\tisExpandApprove = FlowversionAPI.isExpandApprove\r\n\r\n\t\tapproves.forEach (toApprove)->\r\n\t\t\ttoApproveType = toApprove.type\r\n\t\t\ttoApproveFromId = toApprove.from_approve_id\r\n\t\t\ttoApproveHandlerName = toApprove.handler_name\r\n\t\t\tunless toApproveFromId\r\n\t\t\t\treturn\r\n\t\t\tapproves.forEach (fromApprove)->\r\n\t\t\t\tif fromApprove._id == toApproveFromId\r\n\t\t\t\t\tcounter = counters[toApproveFromId]\r\n\t\t\t\t\tunless counter\r\n\t\t\t\t\t\tcounter = counters[toApproveFromId] = {}\r\n\t\t\t\t\tunless counter[toApprove.type]\r\n\t\t\t\t\t\tcounter[toApprove.type] = []\r\n\t\t\t\t\tcounter2 = counter[toApprove.type]\r\n\t\t\t\t\tif traceFromApproveCounters[toApprove._id]?[toApproveType]\r\n\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\r\n\t\t\t\t\t\tcounter2.push\r\n\t\t\t\t\t\t\tfrom_type: fromApprove.type\r\n\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\r\n\t\t\t\t\t\t\tto_approve_id: toApprove._id\r\n\t\t\t\t\t\t\tto_approve_handler_name: toApprove.handler_name\r\n\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcounterContent = if isExpandApprove then null else counter2.findPropertyByPK(\"is_total\", true)\r\n\t\t\t\t\t\t# counterContent = counter2.findPropertyByPK(\"is_total\", true)\r\n\t\t\t\t\t\t# 如果强制要求展开所有节点，则不做汇总处理\r\n\t\t\t\t\t\tif counterContent\r\n\t\t\t\t\t\t\tcounterContent.count++\r\n\t\t\t\t\t\t\tunless counterContent.count > traceMaxApproveCount\r\n\t\t\t\t\t\t\t\tcounterContent.to_approve_handler_names.push toApprove.handler_name\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tcounter2.push\r\n\t\t\t\t\t\t\t\tfrom_type: fromApprove.type\r\n\t\t\t\t\t\t\t\tfrom_approve_handler_name: fromApprove.handler_name\r\n\t\t\t\t\t\t\t\tto_approve_id: toApprove._id\r\n\t\t\t\t\t\t\t\tcount: 1\r\n\t\t\t\t\t\t\t\tto_approve_handler_names: [toApprove.handler_name]\r\n\t\t\t\t\t\t\t\tis_total: true\r\n\r\n\t\treturn counters\r\n\r\n\tpushApprovesWithTypeGraphSyntax: (nodes, trace)->\r\n\t\ttraceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType trace\r\n\t\ttraceCounters = FlowversionAPI.getTraceCountersWithType trace, traceFromApproveCounters\r\n\t\tunless traceCounters\r\n\t\t\treturn\r\n\t\textraHandlerNamesCounter = {} #记录需要额外生成所有处理人姓名的被传阅、分发、转发节点\r\n\t\ttraceMaxApproveCount = FlowversionAPI.traceMaxApproveCount\r\n\t\tsplitIndex = FlowversionAPI.traceSplitApprovesIndex\r\n\t\tcurrentTraceName = trace.name\r\n\t\tfor fromApproveId,fromApprove of traceCounters\r\n\t\t\tfor toApproveType,toApproves of fromApprove\r\n\t\t\t\ttoApproves.forEach (toApprove)->\r\n\t\t\t\t\ttypeName = \"\"\r\n\t\t\t\t\tswitch toApproveType\r\n\t\t\t\t\t\twhen 'cc'\r\n\t\t\t\t\t\t\ttypeName = \"传阅\"\r\n\t\t\t\t\t\twhen 'forward'\r\n\t\t\t\t\t\t\ttypeName = \"转发\"\r\n\t\t\t\t\t\twhen 'distribute'\r\n\t\t\t\t\t\t\ttypeName = \"分发\"\r\n\t\t\t\t\tisTypeNode = [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.from_type) >= 0\r\n\t\t\t\t\tif isTypeNode\r\n\t\t\t\t\t\ttraceName = toApprove.from_approve_handler_name\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.from_approve_handler_name\r\n\t\t\t\t\tif toApprove.is_total\r\n\t\t\t\t\t\ttoHandlerNames = toApprove.to_approve_handler_names\r\n\t\t\t\t\t\tif splitIndex and toApprove.count > splitIndex\r\n\t\t\t\t\t\t\t# 在姓名集合中插入回车符号换行\r\n\t\t\t\t\t\t\ttoHandlerNames.splice(splitIndex,0,\"<br/>,\")\r\n\t\t\t\t\t\tstrToHandlerNames = toHandlerNames.join(\",\").replace(\",,\",\"\")\r\n\t\t\t\t\t\textraCount = toApprove.count - traceMaxApproveCount\r\n\t\t\t\t\t\tif extraCount > 0\r\n\t\t\t\t\t\t\tstrToHandlerNames += \"等#{toApprove.count}人\"\r\n\t\t\t\t\t\t\tunless extraHandlerNamesCounter[fromApproveId]\r\n\t\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId] = {}\r\n\t\t\t\t\t\t\textraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tstrToHandlerNames = toApprove.to_approve_handler_name\r\n\t\t\t\t\tif isTypeNode\r\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}>\\\"#{traceName}\\\"]--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tnodes.push \"\t#{fromApproveId}(\\\"#{traceName}\\\")--#{typeName}-->#{toApprove.to_approve_id}>\\\"#{strToHandlerNames}\\\"]\"\r\n\r\n\t\t# 为需要额外生成所有处理人姓名的被传阅、分发、转发节点，增加鼠标弹出详细层事件\r\n\t\t# extraHandlerNamesCounter的结构为：\r\n\t\t# counters = {\r\n\t\t# \t[fromApproveId(来源节点ID)]:{\r\n\t\t# \t\t[toApproveType(目标结点类型)]:目标结点ID\r\n\t\t# \t}\r\n\t\t# }\r\n\t\tapproves = trace.approves\r\n\t\tunless _.isEmpty(extraHandlerNamesCounter)\r\n\t\t\tfor fromApproveId,fromApprove of extraHandlerNamesCounter\r\n\t\t\t\tfor toApproveType,toApproveId of fromApprove\r\n\t\t\t\t\ttempHandlerNames = []\r\n\t\t\t\t\tapproves.forEach (approve)->\r\n\t\t\t\t\t\tif fromApproveId == approve.from_approve_id\r\n\t\t\t\t\t\t\tunless traceFromApproveCounters[approve._id]?[toApproveType]\r\n\t\t\t\t\t\t\t\t# 有后续子节点，则不参与汇总及计数\r\n\t\t\t\t\t\t\t\ttempHandlerNames.push approve.handler_name\r\n\t\t\t\t\tnodes.push \"\tclick #{toApproveId} callback \\\"#{tempHandlerNames.join(\",\")}\\\"\"\r\n\r\n\tgenerateTracesGraphSyntax: (traces, isConvertToString)->\r\n\t\t# 该函数返回以下格式的graph脚本\r\n\t\t# graphSyntax = '''\r\n\t\t# \tgraph LR\r\n\t\t# \t\tA-->B\r\n\t\t# \t\tA-->C\r\n\t\t# \t\tB-->C\r\n\t\t# \t\tC-->A\r\n\t\t# \t\tD-->C\r\n\t\t# \t'''\r\n\t\tnodes = [\"graph LR\"]\r\n\t\tlastTrace = null\r\n\t\tlastApproves = []\r\n\t\ttraces.forEach (trace)->\r\n\t\t\tlines = trace.previous_trace_ids\r\n\t\t\tcurrentTraceName = trace.name\r\n\t\t\tif lines?.length\r\n\t\t\t\tlines.forEach (line)->\r\n\t\t\t\t\tfromTrace = traces.findPropertyByPK(\"_id\",line)\r\n\t\t\t\t\tcurrentFromTraceName = fromTrace.name\r\n\t\t\t\t\tfromApproves = fromTrace.approves\r\n\t\t\t\t\ttoApproves = trace.approves\r\n\t\t\t\t\tlastTrace = trace\r\n\t\t\t\t\tlastApproves = toApproves\r\n\t\t\t\t\tfromApproves.forEach (fromApprove)->\r\n\t\t\t\t\t\tfromApproveHandlerName = fromApprove.handler_name\r\n\t\t\t\t\t\tif toApproves?.length\r\n\t\t\t\t\t\t\ttoApproves.forEach (toApprove)->\r\n\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(toApprove.type) < 0\r\n\t\t\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\r\n\t\t\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\r\n\t\t\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.getTraceName currentTraceName, toApprove.handler_name\r\n\t\t\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\r\n\t\t\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\r\n\t\t\t\t\t\t\t\t\t\tif judgeText\r\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\r\n\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{toApprove._id}(\\\"#{toTraceName}\\\")\"\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t# 最后一个步骤的trace\r\n\t\t\t\t\t\t\tif [\"cc\",\"forward\",\"distribute\"].indexOf(fromApprove.type) < 0\r\n\t\t\t\t\t\t\t\tfromTraceName = FlowversionAPI.getTraceName currentFromTraceName, fromApproveHandlerName\r\n\t\t\t\t\t\t\t\ttoTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName)\r\n\t\t\t\t\t\t\t\t# 不是传阅、分发、转发，则连接到下一个trace\r\n\t\t\t\t\t\t\t\tjudgeText = FlowversionAPI.getApproveJudgeText fromApprove.judge\r\n\t\t\t\t\t\t\t\tif judgeText\r\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")--#{judgeText}-->#{trace._id}(\\\"#{toTraceName}\\\")\"\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tnodes.push \"\t#{fromApprove._id}(\\\"#{fromTraceName}\\\")-->#{trace._id}(\\\"#{toTraceName}\\\")\"\r\n\t\t\telse\r\n\t\t\t\t# 第一个trace，因traces可能只有一个，这时需要单独显示出来\r\n\t\t\t\ttrace.approves.forEach (approve)->\r\n\t\t\t\t\ttraceName = FlowversionAPI.getTraceName currentTraceName, approve.handler_name\r\n\t\t\t\t\tnodes.push \"\t#{approve._id}(\\\"#{traceName}\\\")\"\r\n\r\n\t\t\tFlowversionAPI.pushApprovesWithTypeGraphSyntax nodes, trace\r\n\r\n\t\t# 签批历程中最后的approves高亮显示，结束步骤的trace中是没有approves的，所以结束步骤不高亮显示\r\n\t\tlastApproves?.forEach (lastApprove)->\r\n\t\t\tnodes.push \"\tclass #{lastApprove._id} current-step-node;\"\r\n\r\n\t\tif isConvertToString\r\n\t\t\tgraphSyntax = nodes.join \"\\n\"\r\n\t\t\treturn graphSyntax\r\n\t\telse\r\n\t\t\treturn nodes\r\n\r\n\tsendHtmlResponse: (req, res, type)->\r\n\t\tquery = req.query\r\n\t\tinstance_id = query.instance_id\r\n\r\n\t\tunless instance_id\r\n\t\t\tFlowversionAPI.sendInvalidURLResponse res \r\n\t\t\r\n\t\ttitle = query.title\r\n\t\tif title\r\n\t\t\ttitle = decodeURIComponent(decodeURIComponent(title))\r\n\t\telse\r\n\t\t\ttitle = \"Workflow Chart\"\r\n\r\n\t\terror_msg = \"\"\r\n\t\tgraphSyntax = \"\"\r\n\t\tFlowversionAPI.isExpandApprove = false\r\n\t\tif type == \"traces_expand\"\r\n\t\t\ttype = \"traces\"\r\n\t\t\tFlowversionAPI.isExpandApprove = true\r\n\t\tswitch type\r\n\t\t\twhen 'traces'\r\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{traces: 1}}\r\n\t\t\t\tif instance\r\n\t\t\t\t\ttraces = instance.traces\r\n\t\t\t\t\tif traces?.length\r\n\t\t\t\t\t\tgraphSyntax = this.generateTracesGraphSyntax traces\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\r\n\t\t\t\telse\r\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\r\n\t\t\telse\r\n\t\t\t\tinstance = db.instances.findOne instance_id,{fields:{flow_version:1,flow:1,traces: {$slice: -1}}}\r\n\t\t\t\tif instance\r\n\t\t\t\t\tcurrentStepId = instance.traces?[0]?.step\r\n\t\t\t\t\tflowversion = WorkflowManager.getInstanceFlowVersion(instance)\r\n\t\t\t\t\tsteps = flowversion?.steps\r\n\t\t\t\t\tif steps?.length\r\n\t\t\t\t\t\tgraphSyntax = this.generateStepsGraphSyntax steps,currentStepId\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\terror_msg = \"没有找到当前申请单的流程步骤数据\"\r\n\t\t\t\telse\r\n\t\t\t\t\terror_msg = \"当前申请单不存在或已被删除\"\r\n\t\t\t\tbreak\r\n\r\n\t\treturn @writeResponse res, 200, \"\"\"\r\n\t\t\t<!DOCTYPE html>\r\n\t\t\t<html>\r\n\t\t\t\t<head>\r\n\t\t\t\t\t<meta charset=\"utf-8\">\r\n\t\t\t\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\">\r\n\t\t\t\t\t<title>#{title}</title>\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"192x192\" href=\"/favicons/android-chrome-192x192.png\">\r\n\t\t\t\t\t<link rel=\"manifest\" href=\"/favicons/manifest.json\">\r\n\t\t\t\t\t<meta name=\"mobile-web-app-capable\" content=\"yes\">\r\n\t\t\t\t\t<meta name=\"theme-color\" content=\"#000\">\r\n\t\t\t\t\t<meta name=\"application-name\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"57x57\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"60x60\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"72x72\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"76x76\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"114x114\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"120x120\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"144x144\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"152x152\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")}\">\r\n\t\t\t\t\t<link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"#{@getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")}\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\">\r\n\t\t\t\t\t<meta name=\"apple-mobile-web-app-title\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"228x228\" href=\"#{@getAbsoluteUrl(\"/favicons/coast-228x228.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-16x16.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-32x32.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"96x96\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-96x96.png\")}\">\r\n\t\t\t\t\t<link rel=\"icon\" type=\"image/png\" sizes=\"230x230\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon-230x230.png\")}\">\r\n\t\t\t\t\t<link rel=\"shortcut icon\" href=\"#{@getAbsoluteUrl(\"/favicons/favicon.ico\")}\">\r\n\t\t\t\t\t<link rel=\"yandex-tableau-widget\" href=\"#{@getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")}\">\r\n\t\t\t\t\t<meta name=\"msapplication-TileColor\" content=\"#fff\">\r\n\t\t\t\t\t<meta name=\"msapplication-TileImage\" content=\"#{@getAbsoluteUrl(\"/favicons/mstile-144x144.png\")}\">\r\n\t\t\t\t\t<meta name=\"msapplication-config\" content=\"#{@getAbsoluteUrl(\"/favicons/browserconfig.xml\")}\">\r\n\t\t\t\t\t<meta property=\"twitter:image\" content=\"#{@getAbsoluteUrl(\"/favicons/twitter.png\")}\">\r\n\t\t\t\t\t<meta property=\"og:image\" content=\"#{@getAbsoluteUrl(\"/favicons/open-graph.png\")}\">\r\n\t\t\t\t\t<link rel=\"stylesheet\" href=\"#{@getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.css\")}\"/>\r\n\t\t\t\t\t<script type=\"text/javascript\" src=\"#{@getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")}\"></script>\r\n\t\t\t\t\t<script type=\"text/javascript\" src=\"#{@getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.min.js\")}\"></script>\r\n\t\t\t\t\t<style>\r\n\t\t\t\t\t\tbody { \r\n\t\t\t\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tbackground-color: #fff;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.loading{\r\n\t\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\t\tleft: 0px;\r\n\t\t\t\t\t\t\tright: 0px;\r\n\t\t\t\t\t\t\ttop: 50%;\r\n\t\t\t\t\t\t\tz-index: 1100;\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tmargin-top: -30px;\r\n\t\t\t\t\t\t\tfont-size: 36px;\r\n\t\t\t\t\t\t\tcolor: #dfdfdf;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.error-msg{\r\n\t\t\t\t\t\t\tposition: absolute;\r\n\t\t\t\t\t\t\tleft: 0px;\r\n\t\t\t\t\t\t\tright: 0px;\r\n\t\t\t\t\t\t\tbottom: 20px;\r\n\t\t\t\t\t\t\tz-index: 1100;\r\n\t\t\t\t\t\t\ttext-align: center;\r\n\t\t\t\t\t\t\tfont-size: 20px;\r\n\t\t\t\t\t\t\tcolor: #a94442;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t#flow-steps-svg .node rect{\r\n\t\t\t\t\t\t\tfill: #ccccff;\r\n\t\t\t\t\t\t\tstroke: rgb(144, 144, 255);\r\n    \t\t\t\t\t\tstroke-width: 2px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t#flow-steps-svg .node.current-step-node rect{\r\n\t\t\t\t\t\t\tfill: #cde498;\r\n\t\t\t\t\t\t\tstroke: #13540c;\r\n\t\t\t\t\t\t\tstroke-width: 2px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t#flow-steps-svg .node.condition rect{\r\n\t\t\t\t\t\t\tfill: #ececff;\r\n\t\t\t\t\t\t\tstroke: rgb(204, 204, 255);\r\n    \t\t\t\t\t\tstroke-width: 1px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t#flow-steps-svg .node .trace-handler-name{\r\n\t\t\t\t\t\t\tcolor: #777;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t#flow-steps-svg .node .step-handler-name{\r\n\t\t\t\t\t\t\tcolor: #777;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tdiv.mermaidTooltip{\r\n\t\t\t\t\t\t\tposition: fixed!important;\r\n\t\t\t\t\t\t\ttext-align: left!important;\r\n\t\t\t\t\t\t\tpadding: 4px!important;\r\n\t\t\t\t\t\t\tfont-size: 14px!important;\r\n\t\t\t\t\t\t\tmax-width: 500px!important;\r\n\t\t\t\t\t\t\tleft: auto!important;\r\n\t\t\t\t\t\t\ttop: 15px!important;\r\n\t\t\t\t\t\t\tright: 15px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.btn-zoom{\r\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\r\n\t\t\t\t\t\t\tborder-color: transparent;\r\n\t\t\t\t\t\t\tdisplay: inline-block;\r\n\t\t\t\t\t\t\tpadding: 2px 10px;\r\n\t\t\t\t\t\t\tfont-size: 26px;\r\n\t\t\t\t\t\t\tborder-radius: 20px;\r\n\t\t\t\t\t\t\tbackground: #eee;\r\n\t\t\t\t\t\t\tcolor: #777;\r\n\t\t\t\t\t\t\tposition: fixed;\r\n\t\t\t\t\t\t\tbottom: 15px;\r\n\t\t\t\t\t\t\toutline: none;\r\n\t\t\t\t\t\t\tcursor: pointer;\r\n\t\t\t\t\t\t\tz-index: 99999;\r\n\t\t\t\t\t\t\t-webkit-user-select: none;\r\n\t\t\t\t\t\t\t-moz-user-select: none;\r\n\t\t\t\t\t\t\t-ms-user-select: none;\r\n\t\t\t\t\t\t\tuser-select: none;\r\n\t\t\t\t\t\t\tline-height: 1.2;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t@media (max-width: 768px) {\r\n\t\t\t\t\t\t\t.btn-zoom{\r\n\t\t\t\t\t\t\t\tdisplay:none;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.btn-zoom:hover{\r\n\t\t\t\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.btn-zoom-up{\r\n\t\t\t\t\t\t\tleft: 15px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t.btn-zoom-down{\r\n\t\t\t\t\t\t\tleft: 60px;\r\n\t\t\t\t\t\t\tpadding: 1px 13px 3px 13px;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t</style>\r\n\t\t\t\t</head>\r\n\t\t\t\t<body>\r\n\t\t\t\t\t<div class = \"loading\">Loading...</div>\r\n\t\t\t\t\t<div class = \"error-msg\">#{error_msg}</div>\r\n\t\t\t\t\t<div class=\"mermaid\"></div>\r\n\t\t\t\t\t<script type=\"text/javascript\">\r\n\t\t\t\t\t\tmermaid.initialize({\r\n\t\t\t\t\t\t\tstartOnLoad:false\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t$(function(){\r\n\t\t\t\t\t\t\tvar graphNodes = #{JSON.stringify(graphSyntax)};\r\n\t\t\t\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\r\n\t\t\t\t\t\t\tmermaid.currentNodes = graphNodes;\r\n\t\t\t\t\t\t\tvar graphSyntax = graphNodes.join(\"\\\\n\");\r\n\t\t\t\t\t\t\tconsole.log(graphNodes);\r\n\t\t\t\t\t\t\tconsole.log(graphSyntax);\r\n\t\t\t\t\t\t\tconsole.log(\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\");\r\n\t\t\t\t\t\t\t$(\".loading\").remove();\r\n\r\n\t\t\t\t\t\t\tvar id = \"flow-steps-svg\";\r\n\t\t\t\t\t\t\tvar element = $('.mermaid');\r\n\t\t\t\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\r\n\t\t\t\t\t\t\t\telement.html(svgCode);\r\n\t\t\t\t\t\t\t\tif(typeof callback !== 'undefined'){\r\n\t\t\t\t\t\t\t\t\tcallback(id);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tbindFunctions(element[0]);\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\r\n\r\n\t\t\t\t\t\t\tvar zoomSVG = function(zoom){\r\n\t\t\t\t\t\t\t\tvar currentWidth = $(\"svg\").width();\r\n\t\t\t\t\t\t\t\tvar newWidth = currentWidth * zoom;\r\n\t\t\t\t\t\t\t\t$(\"svg\").css(\"maxWidth\",newWidth + \"px\").width(newWidth);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t//支持鼠标滚轮缩放画布\r\n\t\t\t\t\t\t\t$(window).on(\"mousewheel\",function(event){\r\n\t\t\t\t\t\t\t\tif(event.ctrlKey){\r\n\t\t\t\t\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\r\n\t\t\t\t\t\t\t\t\tzoomSVG(zoom);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t$(\".btn-zoom\").on(\"click\",function(){\r\n\t\t\t\t\t\t\t\tzoomSVG($(this).attr(\"zoom\"));\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t</script>\r\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-up\" zoom=1.1 title=\"点击放大\">+</a>\r\n\t\t\t\t\t<a class=\"btn-zoom btn-zoom-down\" zoom=0.9 title=\"点击缩小\">-</a>\r\n\t\t\t\t</body>\r\n\t\t\t</html>\r\n\t\t\"\"\"\r\n\r\nJsonRoutes.add 'get', '/api/workflow/chart?instance_id=:instance_id', (req, res, next) ->\r\n\t# 流程图\r\n\tFlowversionAPI.sendHtmlResponse req, res\r\n\r\nJsonRoutes.add 'get', '/api/workflow/chart/traces?instance_id=:instance_id', (req, res, next) ->\r\n\t# 汇总签批历程图\r\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces\"\r\n\r\nJsonRoutes.add 'get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', (req, res, next) ->\r\n\t# 展开所有节点的签批历程图\r\n\tFlowversionAPI.sendHtmlResponse req, res, \"traces_expand\"\r\n\r\n","var FlowversionAPI;\n\nFlowversionAPI = {\n  traceMaxApproveCount: 10,\n  traceSplitApprovesIndex: 5,\n  isExpandApprove: false,\n  getAbsoluteUrl: function(url) {\n    var rootUrl;\n    rootUrl = __meteor_runtime_config__ ? __meteor_runtime_config__.ROOT_URL_PATH_PREFIX : \"\";\n    if (rootUrl) {\n      url = rootUrl + url;\n    }\n    return url;\n  },\n  writeResponse: function(res, httpCode, body) {\n    res.statusCode = httpCode;\n    return res.end(body);\n  },\n  sendInvalidURLResponse: function(res) {\n    return this.writeResponse(res, 404, \"url must has querys as instance_id.\");\n  },\n  sendAuthTokenExpiredResponse: function(res) {\n    return this.writeResponse(res, 401, \"the auth_token has expired.\");\n  },\n  replaceErrorSymbol: function(str) {\n    return str.replace(/\\\"/g, \"&quot;\").replace(/\\n/g, \"<br/>\");\n  },\n  getStepHandlerName: function(step) {\n    var approverNames, stepHandlerName;\n    switch (step.deal_type) {\n      case 'specifyUser':\n        approverNames = step.approver_users.map(function(userId) {\n          var user;\n          user = db.users.findOne(userId);\n          if (user) {\n            return user.name;\n          } else {\n            return \"\";\n          }\n        });\n        stepHandlerName = approverNames.join(\",\");\n        break;\n      case 'applicantRole':\n        approverNames = step.approver_roles.map(function(roleId) {\n          var role;\n          role = db.flow_roles.findOne(roleId);\n          if (role) {\n            return role.name;\n          } else {\n            return \"\";\n          }\n        });\n        stepHandlerName = approverNames.join(\",\");\n        break;\n      default:\n        stepHandlerName = '';\n        break;\n    }\n    return stepHandlerName;\n  },\n  getStepName: function(stepName, stepHandlerName) {\n    if (stepName) {\n      stepName = \"<div class='graph-node'> <div class='step-name'>\" + stepName + \"</div> <div class='step-handler-name'>\" + stepHandlerName + \"</div> </div>\";\n      stepName = FlowversionAPI.replaceErrorSymbol(stepName);\n    } else {\n      stepName = \"\";\n    }\n    return stepName;\n  },\n  generateStepsGraphSyntax: function(steps, currentStepId, isConvertToString) {\n    var graphSyntax, nodes;\n    nodes = [\"graph TB\"];\n    steps.forEach(function(step) {\n      var lines;\n      lines = step.lines;\n      if (lines != null ? lines.length : void 0) {\n        return lines.forEach(function(line) {\n          var stepHandlerName, stepName, toStepName;\n          if (step.name) {\n            if (step.step_type === \"condition\") {\n              nodes.push(\"\tclass \" + step._id + \" condition;\");\n            }\n            stepHandlerName = FlowversionAPI.getStepHandlerName(step);\n            stepName = FlowversionAPI.getStepName(step.name, stepHandlerName);\n          } else {\n            stepName = \"\";\n          }\n          toStepName = steps.findPropertyByPK(\"_id\", line.to_step).name;\n          toStepName = FlowversionAPI.getStepName(toStepName, \"\");\n          return nodes.push(\"\t\" + step._id + \"(\\\"\" + stepName + \"\\\")-->\" + line.to_step + \"(\\\"\" + toStepName + \"\\\")\");\n        });\n      }\n    });\n    if (currentStepId) {\n      nodes.push(\"\tclass \" + currentStepId + \" current-step-node;\");\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  getApproveJudgeText: function(judge) {\n    var judgeText, locale;\n    locale = \"zh-CN\";\n    switch (judge) {\n      case 'approved':\n        judgeText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        judgeText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        judgeText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        judgeText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        judgeText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        judgeText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        judgeText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        judgeText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        judgeText = '';\n        break;\n    }\n    return judgeText;\n  },\n  getTraceName: function(traceName, approveHandlerName) {\n    if (traceName) {\n      traceName = \"<div class='graph-node'> <div class='trace-name'>\" + traceName + \"</div> <div class='trace-handler-name'>\" + approveHandlerName + \"</div> </div>\";\n      traceName = FlowversionAPI.replaceErrorSymbol(traceName);\n    } else {\n      traceName = \"\";\n    }\n    return traceName;\n  },\n  getTraceFromApproveCountersWithType: function(trace) {\n    var approves, counters;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    approves.forEach(function(approve) {\n      if (approve.from_approve_id) {\n        if (!counters[approve.from_approve_id]) {\n          counters[approve.from_approve_id] = {};\n        }\n        if (counters[approve.from_approve_id][approve.type]) {\n          return counters[approve.from_approve_id][approve.type]++;\n        } else {\n          return counters[approve.from_approve_id][approve.type] = 1;\n        }\n      }\n    });\n    return counters;\n  },\n  getTraceCountersWithType: function(trace, traceFromApproveCounters) {\n    var approves, counters, isExpandApprove, traceMaxApproveCount;\n    counters = {};\n    approves = trace.approves;\n    if (!approves) {\n      return null;\n    }\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    isExpandApprove = FlowversionAPI.isExpandApprove;\n    approves.forEach(function(toApprove) {\n      var toApproveFromId, toApproveHandlerName, toApproveType;\n      toApproveType = toApprove.type;\n      toApproveFromId = toApprove.from_approve_id;\n      toApproveHandlerName = toApprove.handler_name;\n      if (!toApproveFromId) {\n        return;\n      }\n      return approves.forEach(function(fromApprove) {\n        var counter, counter2, counterContent, ref;\n        if (fromApprove._id === toApproveFromId) {\n          counter = counters[toApproveFromId];\n          if (!counter) {\n            counter = counters[toApproveFromId] = {};\n          }\n          if (!counter[toApprove.type]) {\n            counter[toApprove.type] = [];\n          }\n          counter2 = counter[toApprove.type];\n          if ((ref = traceFromApproveCounters[toApprove._id]) != null ? ref[toApproveType] : void 0) {\n            return counter2.push({\n              from_type: fromApprove.type,\n              from_approve_handler_name: fromApprove.handler_name,\n              to_approve_id: toApprove._id,\n              to_approve_handler_name: toApprove.handler_name\n            });\n          } else {\n            counterContent = isExpandApprove ? null : counter2.findPropertyByPK(\"is_total\", true);\n            if (counterContent) {\n              counterContent.count++;\n              if (!(counterContent.count > traceMaxApproveCount)) {\n                return counterContent.to_approve_handler_names.push(toApprove.handler_name);\n              }\n            } else {\n              return counter2.push({\n                from_type: fromApprove.type,\n                from_approve_handler_name: fromApprove.handler_name,\n                to_approve_id: toApprove._id,\n                count: 1,\n                to_approve_handler_names: [toApprove.handler_name],\n                is_total: true\n              });\n            }\n          }\n        }\n      });\n    });\n    return counters;\n  },\n  pushApprovesWithTypeGraphSyntax: function(nodes, trace) {\n    var approves, currentTraceName, extraHandlerNamesCounter, fromApprove, fromApproveId, results, splitIndex, tempHandlerNames, toApproveId, toApproveType, toApproves, traceCounters, traceFromApproveCounters, traceMaxApproveCount;\n    traceFromApproveCounters = FlowversionAPI.getTraceFromApproveCountersWithType(trace);\n    traceCounters = FlowversionAPI.getTraceCountersWithType(trace, traceFromApproveCounters);\n    if (!traceCounters) {\n      return;\n    }\n    extraHandlerNamesCounter = {};\n    traceMaxApproveCount = FlowversionAPI.traceMaxApproveCount;\n    splitIndex = FlowversionAPI.traceSplitApprovesIndex;\n    currentTraceName = trace.name;\n    for (fromApproveId in traceCounters) {\n      fromApprove = traceCounters[fromApproveId];\n      for (toApproveType in fromApprove) {\n        toApproves = fromApprove[toApproveType];\n        toApproves.forEach(function(toApprove) {\n          var extraCount, isTypeNode, strToHandlerNames, toHandlerNames, traceName, typeName;\n          typeName = \"\";\n          switch (toApproveType) {\n            case 'cc':\n              typeName = \"传阅\";\n              break;\n            case 'forward':\n              typeName = \"转发\";\n              break;\n            case 'distribute':\n              typeName = \"分发\";\n          }\n          isTypeNode = [\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.from_type) >= 0;\n          if (isTypeNode) {\n            traceName = toApprove.from_approve_handler_name;\n          } else {\n            traceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.from_approve_handler_name);\n          }\n          if (toApprove.is_total) {\n            toHandlerNames = toApprove.to_approve_handler_names;\n            if (splitIndex && toApprove.count > splitIndex) {\n              toHandlerNames.splice(splitIndex, 0, \"<br/>,\");\n            }\n            strToHandlerNames = toHandlerNames.join(\",\").replace(\",,\", \"\");\n            extraCount = toApprove.count - traceMaxApproveCount;\n            if (extraCount > 0) {\n              strToHandlerNames += \"等\" + toApprove.count + \"人\";\n              if (!extraHandlerNamesCounter[fromApproveId]) {\n                extraHandlerNamesCounter[fromApproveId] = {};\n              }\n              extraHandlerNamesCounter[fromApproveId][toApproveType] = toApprove.to_approve_id;\n            }\n          } else {\n            strToHandlerNames = toApprove.to_approve_handler_name;\n          }\n          if (isTypeNode) {\n            return nodes.push(\"\t\" + fromApproveId + \">\\\"\" + traceName + \"\\\"]--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          } else {\n            return nodes.push(\"\t\" + fromApproveId + \"(\\\"\" + traceName + \"\\\")--\" + typeName + \"-->\" + toApprove.to_approve_id + \">\\\"\" + strToHandlerNames + \"\\\"]\");\n          }\n        });\n      }\n    }\n    approves = trace.approves;\n    if (!_.isEmpty(extraHandlerNamesCounter)) {\n      results = [];\n      for (fromApproveId in extraHandlerNamesCounter) {\n        fromApprove = extraHandlerNamesCounter[fromApproveId];\n        results.push((function() {\n          var results1;\n          results1 = [];\n          for (toApproveType in fromApprove) {\n            toApproveId = fromApprove[toApproveType];\n            tempHandlerNames = [];\n            approves.forEach(function(approve) {\n              var ref;\n              if (fromApproveId === approve.from_approve_id) {\n                if (!((ref = traceFromApproveCounters[approve._id]) != null ? ref[toApproveType] : void 0)) {\n                  return tempHandlerNames.push(approve.handler_name);\n                }\n              }\n            });\n            results1.push(nodes.push(\"\tclick \" + toApproveId + \" callback \\\"\" + (tempHandlerNames.join(\",\")) + \"\\\"\"));\n          }\n          return results1;\n        })());\n      }\n      return results;\n    }\n  },\n  generateTracesGraphSyntax: function(traces, isConvertToString) {\n    var graphSyntax, lastApproves, lastTrace, nodes;\n    nodes = [\"graph LR\"];\n    lastTrace = null;\n    lastApproves = [];\n    traces.forEach(function(trace) {\n      var currentTraceName, lines;\n      lines = trace.previous_trace_ids;\n      currentTraceName = trace.name;\n      if (lines != null ? lines.length : void 0) {\n        lines.forEach(function(line) {\n          var currentFromTraceName, fromApproves, fromTrace, toApproves;\n          fromTrace = traces.findPropertyByPK(\"_id\", line);\n          currentFromTraceName = fromTrace.name;\n          fromApproves = fromTrace.approves;\n          toApproves = trace.approves;\n          lastTrace = trace;\n          lastApproves = toApproves;\n          return fromApproves.forEach(function(fromApprove) {\n            var fromApproveHandlerName, fromTraceName, judgeText, toTraceName;\n            fromApproveHandlerName = fromApprove.handler_name;\n            if (toApproves != null ? toApproves.length : void 0) {\n              return toApproves.forEach(function(toApprove) {\n                var fromTraceName, judgeText, toTraceName;\n                if ([\"cc\", \"forward\", \"distribute\"].indexOf(toApprove.type) < 0) {\n                  if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                    fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                    toTraceName = FlowversionAPI.getTraceName(currentTraceName, toApprove.handler_name);\n                    judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                    if (judgeText) {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    } else {\n                      return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + toApprove._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                    }\n                  }\n                }\n              });\n            } else {\n              if ([\"cc\", \"forward\", \"distribute\"].indexOf(fromApprove.type) < 0) {\n                fromTraceName = FlowversionAPI.getTraceName(currentFromTraceName, fromApproveHandlerName);\n                toTraceName = FlowversionAPI.replaceErrorSymbol(currentTraceName);\n                judgeText = FlowversionAPI.getApproveJudgeText(fromApprove.judge);\n                if (judgeText) {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")--\" + judgeText + \"-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                } else {\n                  return nodes.push(\"\t\" + fromApprove._id + \"(\\\"\" + fromTraceName + \"\\\")-->\" + trace._id + \"(\\\"\" + toTraceName + \"\\\")\");\n                }\n              }\n            }\n          });\n        });\n      } else {\n        trace.approves.forEach(function(approve) {\n          var traceName;\n          traceName = FlowversionAPI.getTraceName(currentTraceName, approve.handler_name);\n          return nodes.push(\"\t\" + approve._id + \"(\\\"\" + traceName + \"\\\")\");\n        });\n      }\n      return FlowversionAPI.pushApprovesWithTypeGraphSyntax(nodes, trace);\n    });\n    if (lastApproves != null) {\n      lastApproves.forEach(function(lastApprove) {\n        return nodes.push(\"\tclass \" + lastApprove._id + \" current-step-node;\");\n      });\n    }\n    if (isConvertToString) {\n      graphSyntax = nodes.join(\"\\n\");\n      return graphSyntax;\n    } else {\n      return nodes;\n    }\n  },\n  sendHtmlResponse: function(req, res, type) {\n    var currentStepId, error_msg, flowversion, graphSyntax, instance, instance_id, query, ref, ref1, steps, title, traces;\n    query = req.query;\n    instance_id = query.instance_id;\n    if (!instance_id) {\n      FlowversionAPI.sendInvalidURLResponse(res);\n    }\n    title = query.title;\n    if (title) {\n      title = decodeURIComponent(decodeURIComponent(title));\n    } else {\n      title = \"Workflow Chart\";\n    }\n    error_msg = \"\";\n    graphSyntax = \"\";\n    FlowversionAPI.isExpandApprove = false;\n    if (type === \"traces_expand\") {\n      type = \"traces\";\n      FlowversionAPI.isExpandApprove = true;\n    }\n    switch (type) {\n      case 'traces':\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            traces: 1\n          }\n        });\n        if (instance) {\n          traces = instance.traces;\n          if (traces != null ? traces.length : void 0) {\n            graphSyntax = this.generateTracesGraphSyntax(traces);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n      default:\n        instance = db.instances.findOne(instance_id, {\n          fields: {\n            flow_version: 1,\n            flow: 1,\n            traces: {\n              $slice: -1\n            }\n          }\n        });\n        if (instance) {\n          currentStepId = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.step : void 0 : void 0;\n          flowversion = WorkflowManager.getInstanceFlowVersion(instance);\n          steps = flowversion != null ? flowversion.steps : void 0;\n          if (steps != null ? steps.length : void 0) {\n            graphSyntax = this.generateStepsGraphSyntax(steps, currentStepId);\n          } else {\n            error_msg = \"没有找到当前申请单的流程步骤数据\";\n          }\n        } else {\n          error_msg = \"当前申请单不存在或已被删除\";\n        }\n        break;\n    }\n    return this.writeResponse(res, 200, \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta charset=\\\"utf-8\\\">\\n\t\t<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no\\\">\\n\t\t<title>\" + title + \"</title>\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"192x192\\\" href=\\\"/favicons/android-chrome-192x192.png\\\">\\n\t\t<link rel=\\\"manifest\\\" href=\\\"/favicons/manifest.json\\\">\\n\t\t<meta name=\\\"mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"theme-color\\\" content=\\\"#000\\\">\\n\t\t<meta name=\\\"application-name\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"57x57\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-57x57.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"60x60\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-60x60.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"72x72\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-72x72.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"76x76\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-76x76.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"114x114\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-114x114.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"120x120\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-120x120.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"144x144\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-144x144.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"152x152\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-152x152.png\")) + \"\\\">\\n\t\t<link rel=\\\"apple-touch-icon\\\" sizes=\\\"180x180\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/apple-touch-icon-180x180.png\")) + \"\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-capable\\\" content=\\\"yes\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-status-bar-style\\\" content=\\\"black-translucent\\\">\\n\t\t<meta name=\\\"apple-mobile-web-app-title\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"228x228\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/coast-228x228.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"16x16\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-16x16.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"32x32\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-32x32.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"96x96\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-96x96.png\")) + \"\\\">\\n\t\t<link rel=\\\"icon\\\" type=\\\"image/png\\\" sizes=\\\"230x230\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon-230x230.png\")) + \"\\\">\\n\t\t<link rel=\\\"shortcut icon\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/favicon.ico\")) + \"\\\">\\n\t\t<link rel=\\\"yandex-tableau-widget\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/favicons/yandex-browser-manifest.json\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-TileColor\\\" content=\\\"#fff\\\">\\n\t\t<meta name=\\\"msapplication-TileImage\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/mstile-144x144.png\")) + \"\\\">\\n\t\t<meta name=\\\"msapplication-config\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/browserconfig.xml\")) + \"\\\">\\n\t\t<meta property=\\\"twitter:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/twitter.png\")) + \"\\\">\\n\t\t<meta property=\\\"og:image\\\" content=\\\"\" + (this.getAbsoluteUrl(\"/favicons/open-graph.png\")) + \"\\\">\\n\t\t<link rel=\\\"stylesheet\\\" href=\\\"\" + (this.getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.css\")) + \"\\\"/>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"\" + (this.getAbsoluteUrl(\"/lib/jquery/jquery-1.11.2.min.js\")) + \"\\\"></script>\\n\t\t<script type=\\\"text/javascript\\\" src=\\\"\" + (this.getAbsoluteUrl(\"/packages/steedos_workflow-chart/assets/mermaid/dist/mermaid.min.js\")) + \"\\\"></script>\\n\t\t<style>\\n\t\t\tbody { \\n\t\t\t\tfont-family: 'Source Sans Pro', 'Helvetica Neue', Helvetica, Arial, sans-serif;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tbackground-color: #fff;\\n\t\t\t}\\n\t\t\t.loading{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\ttop: 50%;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tmargin-top: -30px;\\n\t\t\t\tfont-size: 36px;\\n\t\t\t\tcolor: #dfdfdf;\\n\t\t\t}\\n\t\t\t.error-msg{\\n\t\t\t\tposition: absolute;\\n\t\t\t\tleft: 0px;\\n\t\t\t\tright: 0px;\\n\t\t\t\tbottom: 20px;\\n\t\t\t\tz-index: 1100;\\n\t\t\t\ttext-align: center;\\n\t\t\t\tfont-size: 20px;\\n\t\t\t\tcolor: #a94442;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node rect{\\n\t\t\t\tfill: #ccccff;\\n\t\t\t\tstroke: rgb(144, 144, 255);\\n    \t\t\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.current-step-node rect{\\n\t\t\t\tfill: #cde498;\\n\t\t\t\tstroke: #13540c;\\n\t\t\t\tstroke-width: 2px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node.condition rect{\\n\t\t\t\tfill: #ececff;\\n\t\t\t\tstroke: rgb(204, 204, 255);\\n    \t\t\t\t\t\tstroke-width: 1px;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .trace-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\t#flow-steps-svg .node .step-handler-name{\\n\t\t\t\tcolor: #777;\\n\t\t\t}\\n\t\t\tdiv.mermaidTooltip{\\n\t\t\t\tposition: fixed!important;\\n\t\t\t\ttext-align: left!important;\\n\t\t\t\tpadding: 4px!important;\\n\t\t\t\tfont-size: 14px!important;\\n\t\t\t\tmax-width: 500px!important;\\n\t\t\t\tleft: auto!important;\\n\t\t\t\ttop: 15px!important;\\n\t\t\t\tright: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\\n\t\t\t\tborder-color: transparent;\\n\t\t\t\tdisplay: inline-block;\\n\t\t\t\tpadding: 2px 10px;\\n\t\t\t\tfont-size: 26px;\\n\t\t\t\tborder-radius: 20px;\\n\t\t\t\tbackground: #eee;\\n\t\t\t\tcolor: #777;\\n\t\t\t\tposition: fixed;\\n\t\t\t\tbottom: 15px;\\n\t\t\t\toutline: none;\\n\t\t\t\tcursor: pointer;\\n\t\t\t\tz-index: 99999;\\n\t\t\t\t-webkit-user-select: none;\\n\t\t\t\t-moz-user-select: none;\\n\t\t\t\t-ms-user-select: none;\\n\t\t\t\tuser-select: none;\\n\t\t\t\tline-height: 1.2;\\n\t\t\t}\\n\t\t\t@media (max-width: 768px) {\\n\t\t\t\t.btn-zoom{\\n\t\t\t\t\tdisplay:none;\\n\t\t\t\t}\\n\t\t\t}\\n\t\t\t.btn-zoom:hover{\\n\t\t\t\tbackground: rgba(0, 0, 0, 0.2);\\n\t\t\t}\\n\t\t\t.btn-zoom-up{\\n\t\t\t\tleft: 15px;\\n\t\t\t}\\n\t\t\t.btn-zoom-down{\\n\t\t\t\tleft: 60px;\\n\t\t\t\tpadding: 1px 13px 3px 13px;\\n\t\t\t}\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class = \\\"loading\\\">Loading...</div>\\n\t\t<div class = \\\"error-msg\\\">\" + error_msg + \"</div>\\n\t\t<div class=\\\"mermaid\\\"></div>\\n\t\t<script type=\\\"text/javascript\\\">\\n\t\t\tmermaid.initialize({\\n\t\t\t\tstartOnLoad:false\\n\t\t\t});\\n\t\t\t$(function(){\\n\t\t\t\tvar graphNodes = \" + (JSON.stringify(graphSyntax)) + \";\\n\t\t\t\t//方便前面可以通过调用mermaid.currentNodes调式，特意增加currentNodes属性。\\n\t\t\t\tmermaid.currentNodes = graphNodes;\\n\t\t\t\tvar graphSyntax = graphNodes.join(\\\"\\\\n\\\");\\n\t\t\t\tconsole.log(graphNodes);\\n\t\t\t\tconsole.log(graphSyntax);\\n\t\t\t\tconsole.log(\\\"You can access the graph nodes by 'mermaid.currentNodes' in the console of browser.\\\");\\n\t\t\t\t$(\\\".loading\\\").remove();\\n\\n\t\t\t\tvar id = \\\"flow-steps-svg\\\";\\n\t\t\t\tvar element = $('.mermaid');\\n\t\t\t\tvar insertSvg = function(svgCode, bindFunctions) {\\n\t\t\t\t\telement.html(svgCode);\\n\t\t\t\t\tif(typeof callback !== 'undefined'){\\n\t\t\t\t\t\tcallback(id);\\n\t\t\t\t\t}\\n\t\t\t\t\tbindFunctions(element[0]);\\n\t\t\t\t};\\n\t\t\t\tmermaid.render(id, graphSyntax, insertSvg, element[0]);\\n\\n\t\t\t\tvar zoomSVG = function(zoom){\\n\t\t\t\t\tvar currentWidth = $(\\\"svg\\\").width();\\n\t\t\t\t\tvar newWidth = currentWidth * zoom;\\n\t\t\t\t\t$(\\\"svg\\\").css(\\\"maxWidth\\\",newWidth + \\\"px\\\").width(newWidth);\\n\t\t\t\t}\\n\\n\t\t\t\t//支持鼠标滚轮缩放画布\\n\t\t\t\t$(window).on(\\\"mousewheel\\\",function(event){\\n\t\t\t\t\tif(event.ctrlKey){\\n\t\t\t\t\t\tevent.preventDefault();\\n\t\t\t\t\t\tvar zoom = event.originalEvent.wheelDelta > 0 ? 1.1 : 0.9;\\n\t\t\t\t\t\tzoomSVG(zoom);\\n\t\t\t\t\t}\\n\t\t\t\t});\\n\t\t\t\t$(\\\".btn-zoom\\\").on(\\\"click\\\",function(){\\n\t\t\t\t\tzoomSVG($(this).attr(\\\"zoom\\\"));\\n\t\t\t\t});\\n\t\t\t});\\n\t\t</script>\\n\t\t<a class=\\\"btn-zoom btn-zoom-up\\\" zoom=1.1 title=\\\"点击放大\\\">+</a>\\n\t\t<a class=\\\"btn-zoom btn-zoom-down\\\" zoom=0.9 title=\\\"点击缩小\\\">-</a>\\n\t</body>\\n</html>\");\n  }\n};\n\nJsonRoutes.add('get', '/api/workflow/chart?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res);\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces\");\n});\n\nJsonRoutes.add('get', '/api/workflow/chart/traces_expand?instance_id=:instance_id', function(req, res, next) {\n  return FlowversionAPI.sendHtmlResponse(req, res, \"traces_expand\");\n});\n"]}