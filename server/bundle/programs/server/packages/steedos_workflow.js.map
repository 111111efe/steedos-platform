{"version":3,"sources":["meteor://💻app/packages/steedos:workflow/checkNpm.js","meteor://💻app/packages/steedos_workflow/lib/core.coffee","meteor://💻app/lib/core.coffee","meteor://💻app/packages/steedos_workflow/lib/models/auth_tokens.coffee","meteor://💻app/packages/steedos_workflow/client/lib/instance_readonly_template.coffee","meteor://💻app/client/lib/instance_readonly_template.coffee","meteor://💻app/packages/steedos_workflow/client/lib/template_manager.coffee","meteor://💻app/client/lib/template_manager.coffee","meteor://💻app/packages/steedos:workflow/client/coreform/inputTypes/coreform-table/steedos-table.js","meteor://💻app/packages/steedos_workflow/client/views/instance/_image_sign.coffee","meteor://💻app/client/views/instance/_image_sign.coffee","meteor://💻app/packages/steedos_workflow/client/views/instance/_instance_form.coffee","meteor://💻app/client/views/instance/_instance_form.coffee","meteor://💻app/packages/steedos:workflow/client/views/instance/_instance_attachments.js","meteor://💻app/packages/steedos_workflow/client/views/instance/_instance_sign_text.coffee","meteor://💻app/client/views/instance/_instance_sign_text.coffee","meteor://💻app/packages/steedos_workflow/client/views/instance/_traces_help.coffee","meteor://💻app/client/views/instance/_traces_help.coffee","meteor://💻app/packages/steedos_workflow/client/views/instance/_related_instances.coffee","meteor://💻app/client/views/instance/_related_instances.coffee","meteor://💻app/packages/steedos_workflow/client/views/instance/_related_records.coffee","meteor://💻app/client/views/instance/_related_records.coffee","meteor://💻app/packages/steedos_workflow/server/methods/set_instance_step_approve.coffee","meteor://💻app/server/methods/set_instance_step_approve.coffee","meteor://💻app/packages/steedos:workflow/server/methods/get_instance_data.js","meteor://💻app/packages/steedos:workflow/server/methods/save_instance.js","meteor://💻app/packages/steedos:workflow/server/methods/trace_approve_cc.js","meteor://💻app/packages/steedos:workflow/server/methods/forward_instance.js","meteor://💻app/packages/steedos:workflow/server/methods/cfs_instances.js","meteor://💻app/packages/steedos_workflow/server/methods/instance_approve.coffee","meteor://💻app/server/methods/instance_approve.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_return.coffee","meteor://💻app/server/methods/instance_return.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_remind.coffee","meteor://💻app/server/methods/instance_remind.coffee","meteor://💻app/packages/steedos_workflow/server/methods/next_step_users_not_found.coffee","meteor://💻app/server/methods/next_step_users_not_found.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_number_rules.coffee","meteor://💻app/server/methods/instance_number_rules.coffee","meteor://💻app/packages/steedos_workflow/server/methods/check_main_attach.coffee","meteor://💻app/packages/steedos_workflow/server/methods/related_instances.coffee","meteor://💻app/server/methods/related_instances.coffee","meteor://💻app/packages/steedos_workflow/server/methods/edit_flow_positions.coffee","meteor://💻app/server/methods/edit_flow_positions.coffee","meteor://💻app/packages/steedos_workflow/server/methods/start_flow.coffee","meteor://💻app/server/methods/start_flow.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_traces.coffee","meteor://💻app/server/methods/instance_traces.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_batch.coffee","meteor://💻app/server/methods/instance_batch.coffee","meteor://💻app/packages/steedos_workflow/server/methods/flow.coffee","meteor://💻app/server/methods/flow.coffee","meteor://💻app/packages/steedos_workflow/server/methods/hide_instance.coffee","meteor://💻app/server/methods/hide_instance.coffee","meteor://💻app/packages/steedos_workflow/server/methods/instance_value.coffee","meteor://💻app/server/methods/instance_value.coffee","meteor://💻app/packages/steedos_workflow/server/routes/instance.coffee","meteor://💻app/server/routes/instance.coffee","meteor://💻app/packages/steedos_workflow/server/routes/steedos_css.coffee","meteor://💻app/server/routes/steedos_css.coffee","meteor://💻app/packages/steedos_workflow/server/routes/instance_draft_view.coffee","meteor://💻app/server/routes/instance_draft_view.coffee","meteor://💻app/packages/steedos:workflow/server/lib/1_form_formula.js","meteor://💻app/packages/steedos_workflow/server/lib/get_handlers_manager.coffee","meteor://💻app/server/lib/get_handlers_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/permission_manager.coffee","meteor://💻app/server/lib/permission_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/approve_manager.coffee","meteor://💻app/server/lib/approve_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/flow_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/form_manager.coffee","meteor://💻app/server/lib/form_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/step_manager.coffee","meteor://💻app/server/lib/step_manager.coffee","meteor://💻app/packages/steedos_workflow/server/lib/instance_manager.coffee","meteor://💻app/server/lib/instance_manager.coffee","meteor://💻app/packages/steedos_workflow/server/publications/categories.coffee","meteor://💻app/server/publications/categories.coffee","meteor://💻app/packages/steedos_workflow/server/publications/cfs_instances.coffee","meteor://💻app/server/publications/cfs_instances.coffee","meteor://💻app/packages/steedos_workflow/server/publications/flow_positions.coffee","meteor://💻app/server/publications/flow_positions.coffee","meteor://💻app/packages/steedos_workflow/server/publications/flow_positions_tabular.coffee","meteor://💻app/server/publications/flow_positions_tabular.coffee","meteor://💻app/packages/steedos_workflow/server/publications/flow_roles.coffee","meteor://💻app/server/publications/flow_roles.coffee","meteor://💻app/packages/steedos_workflow/server/publications/flows.coffee","meteor://💻app/server/publications/flows.coffee","meteor://💻app/packages/steedos_workflow/server/publications/forms.coffee","meteor://💻app/server/publications/forms.coffee","meteor://💻app/packages/steedos_workflow/server/publications/instance_data.coffee","meteor://💻app/server/publications/instance_data.coffee","meteor://💻app/packages/steedos_workflow/server/publications/instance_list.coffee","meteor://💻app/server/publications/instance_list.coffee","meteor://💻app/packages/steedos_workflow/server/publications/instance_tabular.coffee","meteor://💻app/server/publications/instance_tabular.coffee","meteor://💻app/packages/steedos_workflow/server/publications/instance_draft.coffee","meteor://💻app/server/publications/instance_draft.coffee","meteor://💻app/packages/steedos_workflow/server/publications/distributed_instances_state_by_ids.coffee","meteor://💻app/server/publications/distributed_instances_state_by_ids.coffee","meteor://💻app/packages/steedos_workflow/server/publications/related_instaces.coffee","meteor://💻app/server/publications/related_instaces.coffee","meteor://💻app/packages/steedos_workflow/server/publications/space_user_signs.coffee","meteor://💻app/server/publications/space_user_signs.coffee","meteor://💻app/packages/steedos_workflow/server/publications/user_inbox_instance.coffee","meteor://💻app/server/publications/user_inbox_instance.coffee","meteor://💻app/packages/steedos_workflow/server/publications/flow_main_attach_template.coffee","meteor://💻app/server/publications/flow_main_attach_template.coffee","meteor://💻app/packages/steedos_workflow/server/flow-template/workflow_template.coffee","meteor://💻app/server/flow-template/workflow_template.coffee","meteor://💻app/packages/steedos_workflow/server/schedule/auto_finish_process_delegation.coffee","meteor://💻app/server/schedule/auto_finish_process_delegation.coffee","meteor://💻app/packages/steedos_workflow/server/schedule/timeout_auto_submit.coffee","meteor://💻app/server/schedule/timeout_auto_submit.coffee","meteor://💻app/packages/steedos:workflow/routes/nextStepUsers.js","meteor://💻app/packages/steedos:workflow/routes/getSpaceUsers.js","meteor://💻app/packages/steedos:workflow/routes/getFormulaUserObjects.js","meteor://💻app/packages/steedos:workflow/routes/init_formula_values.js","meteor://💻app/packages/steedos_workflow/routes/getNameForUser.coffee","meteor://💻app/routes/getNameForUser.coffee","meteor://💻app/packages/steedos_workflow/routes/api_designer_startup.coffee","meteor://💻app/routes/api_designer_startup.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_engine.coffee","meteor://💻app/routes/api_workflow_engine.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_drafts.coffee","meteor://💻app/routes/api_workflow_drafts.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_remove.coffee","meteor://💻app/routes/api_workflow_remove.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_submit.coffee","meteor://💻app/routes/api_workflow_submit.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_terminate.coffee","meteor://💻app/routes/api_workflow_terminate.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_reassign.coffee","meteor://💻app/routes/api_workflow_reassign.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_relocate.coffee","meteor://💻app/routes/api_workflow_relocate.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_archive.coffee","meteor://💻app/routes/api_workflow_archive.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_export.coffee","meteor://💻app/routes/api_workflow_export.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_space_changeset.coffee","meteor://💻app/routes/api_workflow_space_changeset.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_retrieve.coffee","meteor://💻app/routes/api_workflow_retrieve.coffee","meteor://💻app/packages/steedos:workflow/routes/api_workflow_forward.js","meteor://💻app/packages/steedos_workflow/routes/api_workflow_instance.coffee","meteor://💻app/routes/api_workflow_instance.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_pending.coffee","meteor://💻app/routes/api_workflow_open_pending.coffee","meteor://💻app/packages/steedos_workflow/routes/export_table_template.coffee","meteor://💻app/routes/export_table_template.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_drafts.coffee","meteor://💻app/routes/api_workflow_open_drafts.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_get.coffee","meteor://💻app/routes/api_workflow_open_get.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_submit.coffee","meteor://💻app/routes/api_workflow_open_submit.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_save.coffee","meteor://💻app/routes/api_workflow_open_save.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_get_by_stepname.coffee","meteor://💻app/routes/api_workflow_open_get_by_stepname.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_open_cfs.coffee","meteor://💻app/routes/api_workflow_open_cfs.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_forward_refill.coffee","meteor://💻app/routes/api_workflow_forward_refill.coffee","meteor://💻app/packages/steedos_workflow/routes/api_workflow_forward_table_refill.coffee","meteor://💻app/routes/api_workflow_forward_table_refill.coffee","meteor://💻app/packages/steedos_workflow/routes/api_sub_table_sort.coffee","meteor://💻app/routes/api_sub_table_sort.coffee","meteor://💻app/packages/steedos_workflow/routes/test_webhook.coffee","meteor://💻app/routes/test_webhook.coffee","meteor://💻app/packages/steedos_workflow/routes/api_formula_users.coffee","meteor://💻app/routes/api_formula_users.coffee","meteor://💻app/packages/steedos_workflow/routes/api_formula_organizations.coffee","meteor://💻app/routes/api_formula_organizations.coffee","meteor://💻app/packages/steedos_workflow/related_instances_tabular.coffee","meteor://💻app/related_instances_tabular.coffee","meteor://💻app/packages/steedos_workflow/tabular.coffee","meteor://💻app/tabular.coffee"],"names":["checkNpmVersions","module","link","v","cookies","mkdirp","Workflow","ImageSign","TracesTemplate","InstanceformTemplate","InstanceAttachmentTemplate","InstanceSignText","RelatedInstances","RelatedRecords","InstanceMacro","context","TracesManager","Meteor","isClient","startup","workflow_three_columns","localStorage","getItem","$","removeClass","addClass","isOpinionField_from_string","field_formula","indexOf","includesOpinionField","form","form_version","_form_version","field_formulas","fields","Array","isServer","uuflowManager","getFormVersion","db","forms","findOne","_id","form_versions","forEach","f","ref","type","console","log","f1","push","formula","_","some","helpers","auth_tokens","Collection","_getLocale","_getRequiredFields","_getStartStepEditableFields","_getStartStepRequiredFields","_getTemplateData","_getViewHtml","InstanceReadOnlyTemplate","instance_attachment","afSelectUserRead","afFormGroupRead","afFormGroup","create","tempalteName","steedosData","template","templateCompiled","templateRenderFunction","SpacebarsCompiler","compile","isBody","eval","Template","Blaze","createInstanceSignText","instanceSignTextCompiled","instanceSignTextHtml","instanceSignTextRenderFunction","instanceSignText","createImageSign","imageSignCompiled","imageSignHtml","imageSignRenderFunction","imageSign","init","absolute","getValue","value","field","locale","utcOffset","date","e","hours","month","seconds","t","t0","t1","year","encodeURI","error","is_multiselect","getProperty","toString","fullname","name","TAPi18n","__","length","split","Date","formatDate","is_textarea","Spacebars","SafeString","Markdown","parseFloat","toFixed","digits","Steedos","numberToString","pluck","getLabel","code","findPropertyByPK","getInstanceFormVersion","instance","form_fields","current","where","historys","getFlowVersion","flow","flow_version","flows","path","viewHtml","Assets","getText","replace","user","ref1","toLocaleLowerCase","rev","is_required","steps","editableCode","startStep","keys","permissions","key","requiredFields","intersection","space","options","WorkflowManager","clone","WorkflowManager_format","getAutoformSchemaValues","insname","ins_state","state","ins_final_decision","ins_code","ins_is_archived","is_archived","ins_is_deleted","applicant_name","applicantContext","sessionUserId","editable","startStepEditableFields","passing","moment","format","getInstanceView","body","instanceCompiled","instanceRenderFunction","instanceTemplate","TemplateManager","getTemplate","templateName","instance_readonly_view","toHTMLWithData","getTracesView","traceCompiled","traceRenderFunction","tracesHtml","instance_style","trace_readonly_view","traces","getAttachmentView","attachmentCompiled","attachmentHtml","attachmentRenderFunction","attachments_readonly_view","getRelatedInstancesView","relatedInstancesCompiled","relatedInstancesHtml","relatedInstancesRenderFunction","related_instances_view","getRelatedRecordsView","relatedRecordsCompiled","relatedRecordsHtml","relatedRecordsRenderFunction","related_records_view","getOnLoadScript","form_script","getInstanceHtml","absoluteUrl","allCssLink","attachment","creatorService","cssHref","formDescription","formDescriptionHtml","html","ins_record_ids","instanceBoxStyle","instanceTracesStyle","onLoadScript","openFileScript","related_instances","related_records","showTracesBtn","showTracesScript","submit_btn","trace","width","settings","webservices","creator","url","record_ids","JSON","stringify","isMobile","showTrace","final_decision","showAttachments","tagger","styles","description","plugins","formId","instance_title","pageTitle","pageTitleTrClass","val","CoreForm","pageTitleFieldName","handleTableTemplate","_export","table_fields","table_field","field_permission","pureCode","required","title_permission","removeSpecialCharacter","isOpinionField","tr_start","td_colspan","tr_end","includes","permission","_template","table","_templateHelps","data","steedos_instance","getInstance","atts","id","style","disabled","instanceId","form_types","ApproveManager","isReadOnly","steedos_form","innersubformContext","obj","doc_values","Session","get","equals","a","b","SimpleSchema","getAutoformSchema","instance_box_style","box","ins","judge","print_template","instance_template","SteedosTable","checkItem","item_index","fieldObj","getField","fieldVal","getItemModalValue","sf_name","sfields","sf","InstanceManager","checkFormFieldValue","setTableItemValue","item_value","tableValue","getTableValue","getTableItemValue","removeTableItem","removed","setTableValue","getValidValue","validValue","handleData","values","instanceFields","getInstanceFields","getModalData","index","Form_formula","getFormulaFieldVariable","AutoForm","getFormValues","insertDoc","addItem","_item_value","getKeys","append","getTr","updateItem","item","tds","getRemoveTd","sfield","getTd","empty","runFormula","removeItem","hide","showModal","method","modalData","Modal","show","getCurrentDataForForm","ss","getFormSchema","schema","Object","objectKeys","_makeGeneric","getThead","isObject","thead","trs","label","sf_length","wide_fields","filterProperty","is_wide","getTbody","tbody","tr","td","td_value","getTDValue","view","CFDataManager","getFormulaSpaceUsers","u","getFormulaOrganizations","o","getFormulaOrganization","addInputType","valueOut","valueConverters","stringToStringArray","stringToNumber","stringToNumberArray","stringToBoolean","stringToBooleanArray","stringToDate","stringToDateArray","contextAdjust","maxlength","max","afTable","events","event","new_item_index","currentTarget","dataset","set","rendered","str","addItemTr","spaceUserSign","userId","space_user_signs","imageURL","sign","unempty","unequals","include","parse","ref2","ref3","getInstanceFlowVersion","approves","ref4","step","approve","judge_name","is_finished","handler","handler_name","handler_organization_name","handler_organization_fullname","finish_date","opinion_fields_code","sign_field_code","is_read","sign_show","concat","after_field","before_field","pre_fields","pre_wide_fields","slice","sort_approve","order","sort","p1","p2","_p1","_p2","getTime","_t","getCfClass","getTableThead","getTableBody","showLabel","templateData","getOpinionFieldStepsName","top_keywords","foo1","opinionFields","foo","json_formula","s1","error1","yijianlan","stepName","image_sign","only_cc_opinion","only_cc","default_description","only_handler","showCCOpinion","markDownToHtml","markDownString","renderer","Renderer","href","title","text","f_label","that","isSection","registerHelper","op","hash","ins_attach_download_url","getPermissions","instanceformChangeEvent","preventDefault","openWindow","target","onCreated","compiled","instanceCustomTemplate","instanceView","renderFunction","View","instance_custom_template","onRendered","currentApprove","currentStep","formula_fields","instanceNumberFields","applicant","nextSteps","nextStepUsers","InstanceEvent","initEvents","getCurrentApprove","each","element","schemaKey","call","result","toastr","reason","trim","getFieldValue","InstanceNumberRules","instanceNumberBuilder","trigger","getCurrentStep","run","showMainTitle","workflowMainAttachTitle","enabled_add_main_attachment","current_step","main_attach_count","cfs","instances","find","count","distribute_main_attach_count","distribute_from_instance","start_step","getStartStep","can_edit_main_attach","step_type","enabled_edit_normal_attachment","getFlow","upload_after_being_distributed","isCC","getCCStep","can_edit_normal_attach","undefined","main_attachment","main_attach","normal_attachments","selector","$ne","dfis","distribute_from_instances","$in","distribute_main","firstVersionMain","metadata","parent","attachmentUploadedAt","uploadedAt","c","firstVersion","sortBy","instanceIds","attachments_count","compact","attachments","$or","fetch","myApprove","myTrace","isInbox","defaultDescription","approve_sort","approvesGroup","approves_sorted","completed_date","hasNext","haveDescriptionApprove","is_completed","last","top_approves","union","filter","top_approve","groupBy","handlerApproves","descriptionApproves","_display","isMyApprove","myApproveDescription","approveId","now","isOpinionOfField","imageSignData","showSignImage","getLastSignApprove","getHandlerSignShowApproves","lastMyApproveDescription","showApprove","judge_description","is_approved","is_rejected","is_readed","setTimeout","is","dateFormat","getFullYear","getStepName","stepId","getInstanceStep","showDeleteButton","approved","from_user","isShowModificationButton","approve_admins","isShow","workflow","contains","isEditing","is_editing","isShowDescription","getApproveStatusIcon","approveJudge","approveStatusIcon","getApproveStatusText","approveStatusText","isForward","showForwardDeleteButton","forward_instance","isDistribute","showDistributeDeleteButton","isLegalVersion","hasFlowAdminPermission","finishDateSchema","isAndroidOrIOS","autoform","optional","readonly","dateTimePickerOptions","ignoreReadonly","widgetPositioning","horizontal","finishDateValues","showTracesView","show_modal_traces_list","space_settings","getInstanceStateText","instance_id","getInstanceStateColor","cla","firstTrace","last_distribute_from","dis_info","$exists","created","created_by","UUflow_api","getNameForUser","users","from_user_name","isEmpty","isCCOrDistributeOrForwardTerminated","judgeTerminated","instanceExists","agentDescription","userName","traceName","traceId","stopPropagation","calling","err","success","forward_space","forwardspace","forwardinstance","Tracker","afterFlush","on","scrollTop","finish_input","opinion_input","allowMultiple","showRelatedInstaces","isArray","related_instaces","related_instace_url","isCordova","show_delete","showRelatedRecords","methods","set_instance_step_approve","ins_id","step_approve","update","$set","get_instance_data","formCached","flowCached","check","String","Boolean","draft_save_instance","setObj","trace_id","approve_id","next_steps","applicant_id","submitter","space_id","flow_id","form_id","current_trace","idx","key_str","current_user","lang","isInstanceDraft","isInstanceSubmitter","modified","modified_by","s","space_users","organization","org_id","organizations","applicant_organization","applicant_organization_name","applicant_organization_fullname","name_forumla","getInstanceName","inbox_save_instance","current_approve","isInstancePending","isTraceNotFinished","isApproveNotFinished","isHandlerOrAgent","stack","step_id","h","permissions_values","getApproveValues","change_values","approveManager","getChangeValues","extend","values_history","form_v","cc_do","cc_user_ids","cc_users","current_user_id","new_approves","space_user","agent","getAgent","handler_id","handler_info","handler_space_user","handler_org_info","fileds","getSpaceUser","getSpaceUserOrgInfo","appr","Mongo","ObjectID","_str","setRemindInfo","$addToSet","$each","$push","current_user_info","pushManager","send_instance_notification","triggerWebhook","cc_read","cc_submit","outbox_users","upobj","start_date","$pull","send_message_to_specifyUser","cc_remove","remove_user_id","multi","cc_save","hasSaveInstanceToAttachment","isForwardAttachments","selectedUsers","action_type","related","from_approve_id","Error","forward_remove","hasAdminPermission","forward_instance_id","inbox_users","deleted","deleted_by","deleted_forward_instance_id","deleted_instances","insert","remove","u_id","set_obj","cancelDistribute","approve_ids","exists","cfs_instances_remove","file_id","cfs_instances_set_current","cfs_instances_lock","user_id","user_name","cfs_instances_unlock","$unset","download_space_instance_attachments_to_disk","spaceId","cfsRecordIds","is_cloudadmin","store","fs","require","pathname","join","__meteor_bootstrap__","serverDir","absolutePath","resolve","sync","time","query","downloadFailedRecordIds","fileName","filePath","wrapAsync","callback","writer","createWriteStream","isFunction","reader","createReadStream","pipe","timeEnd","set_approve_have_read","self","change_approve_info","update_approve_sign","sign_type","lastSignApprove","lastTrace","session_userId","upObj","custom_sign_show","update_sign_show","objs","myApprove_id","instance_return","approve_values","last_trace","newTrace","new_inbox_users","pre_step","pre_trace","r","rest_counter_users","getStep","previous_trace_ids","due_date","getDueDate","timeout_hours","next_step_user_id","newApprove","next_step_space_user","next_step_user_org_info","user_info","handler_organization","is_error","uniq","current_step_name","instance_remind","remind_users","remind_count","remind_deadline","action_types","last_remind_users","priority","Match","OneOf","ap","caculate_date","manual_deadline","caculatePlusHalfWorkingDay","remind_date","caculateWorkingTime","base_date","plus_halfday_date","sendRemindSMS","next_step_users_not_found","deal_type","step_name","params","approver_roles","roles","roles_name","flow_roles","role_name","_eval","_NUMBER","_YYYY","numberRules","res","rules","script","instance_number_rules","number","YYYY","MM","getMonth","mm","DD","getDate","dd","first_number","NUMBER","newNo","_error","check_main_attach","checkMainAttach","remove_related","re_ins_id","update_instance_related","updateFlowPosition","flow_positions","role","org","updateFlowRole","start_flow","flowId","start","keyValue","start_flows","steedos_keyvalues","get_instance_traces","miniApproveFields","categoryId","flowIds","_batch_instances","getBatchInstances","myApproves","insId","my_approve","getMyApprove","change_flow_state","_userId","_flows","_flows_state","form_current_fields_code","isSpaceAdmin","is_valid","flowtype","specifyStep","approver_step","_step","fields_modifiable","hide_instance","is_hidden","permissionManager","getFlowPermissions","spaces","admins","getInstanceValues","Cookies","getInstanceReadOnly","req","next","_hasPermission","_locale","_parent_instances","dataBuf","hide_traces","spaceUserCount","getAPILoginUser","access_token","getUserIdFromAccessToken","JsonRoutes","sendResult","hasInstancePermissions","_parent_id","_parent_ins","charset","Buffer","setHeader","statusCode","end","add","instance_name","i","ret_sync_token","spaceUser","spaceUserOrganizations","sync_token","APIAuthenticationCheck","headers","canMonitor","canAdmin","Number","$gt","$nin","inbox_uers","skip","limit","copies","allCss","WebApp","getRefreshableAssets","css","rootUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","ROOT_URL","endsWith","prototype","l","g","m","d","k","getEach","mixin","dest","src","handerUserObject","hr","sort_no","mobile","work_phone","position","userRoles","handerOrgObject","init_formula_values","autoFormDoc","approver","__values","tableFields","tableValues","formulaTableValues","__tableValues","tablefield","getFormulaUserObjects","getFormulaOrgObjects","getFormulaUserObject","getHandlersManager","getHandlersByUsersAndRoles","user_ids","role_ids","approve_users","getHandlersByUserAndRoles","role_id","getHandlersByUserAndRole","orgs","getHandlersByOrgAndRole","getHandlersByOrgsAndRoles","org_ids","getHandlersByOrgAndRoles","parents","positions","parent_id","getHandlers","_approve","_space_user","_trace","applicantSuperiors","approver_org_field","approver_org_ids","approver_user_field","approver_user_ids","current_flow","current_flow_version","current_form","current_steps","field_code","finished_traces","flow_rev","form_rev","handlers","max_startDate_trace","new_approver_user_ids","new_org_user_ids","newest_values","next_step_users","org_ids_names","org_user_ids","space_user_count","submitter_user_count","unfinished_trace","user_ids_names","valid_approver_org_ids","history","approver_role","role_count","current_flow_history","form_history","form_field","getUpdatedValues","check_org_count","check_orgs","org_children","org_users","unshift","check_org_user","org_user","check_user_count","approve_user","check_approve_user_count","approver_orgs","approver_org_id","valid_approver_org_id","child_orgs","valid_approver_org","child_org","org_user_id","space_user_info_count","approver_users","approver_user_id","_tr","_app","manager","my_permissions","orgs_can_add","orgs_can_admin","orgs_can_monitor","users_can_add","users_can_admin","users_can_monitor","perms","last_values","approve_values_keys","changeValues","last_values_keys","isEqual","flowManager","getCategoriesFlows","categorieId","categoriesForms","formManager","getCategoriesForms","getUnCategoriesFlows","unCategoriesForms","getUnCategoriesForms","_fields","category","stepManager","allowBatch","isExistStep","logger","Logger","handlerInstanceByFieldMap","field_map","currentApproves","currentTraces","getCurrentTrace","next_user_ids","getNextSteps","inbox_user","FIELDS","categoryFlows","inbox_instances","unCategoryFlows","submit_date","currentStepId","publish","ready","categories","app","publishComposite","tableName","ids","Optional","unblock","children","createTemplateFormAndFlow","company_id","versionId","handle","latest","observeChanges","changed","added","onStop","stop","flow_ids","distribute_optional_users","distribute_to_self","distribute_end_notification","getMiniInstance","getMyapproveModified","instance_fields_0","needChange","triggerChangeFields","triggerChangeFieldsValues","myApproveModifieds","read_date","_instanceId","changeFields","_change","_rev","_key","_my_approve_modifieds","has","getInstanceTraces","_insId","asyncLastFinishedApprove","lastFinishedApproveAggregate","instanceid","dataMap","operation","rawCollection","aggregate","toArray","doc","getMyLastFinishedApprove","getStepCurrentName","notFinishedTraces","stepCurrentName","$slice","myLastFinishedApprove","agent_user_name","my_finish_date","is_cc","cc_count","instance_ids","related_instance_ids","_async_get_flow_instances_aggregate","_get_flow_instances_aggregate","_items","$match","$group","$sum","_changeData","_flowsData","_init","dataItem","action","flow_instance","observe","Creator","getCollection","workflowTemplate","absolute_path_cn","absolute_path_us","filesList_cn","filesList_us","mime","path_cn","path_us","readFileList","pathDir","filesList","files","readdirSync","stat","statSync","isDirectory","workflowTemplates","existsSync","file","getType","readFileSync","go_next","rule","schedule","cron","auto_finish_process_delegation","scheduleJob","bindEnvironment","process_delegation_rules","enabled","end_time","$lte","timeout_auto_submit","timeoutAutoSubmit","specifyUserIds","getUsers","applicantId","approveRoleIds","getUser","getRoleUsersByOrgsAndRoles","userField","userFieldValue","orgChildrens","orgField","orgFieldValue","getOrganizations","getOrganizationsChildrens","getOrganization","getOrganizationChildrens","getOrganizationsUsers","orgFieldUsers","specifyOrgIds","specifyOrgs","specifyOrgChildrens","approverRoleIds","getRoleUsersByUsersAndRoles","su","uniqUsers","userIds","spaceUsers","formula_values","errors","errorMessage","message","companyId","spaceIds","spacesQuery","check_authorization","is_deleted","help_text","name_formula","code_formula","current_no","error_message","SpaceUsers","Users","Forms","Flows","Organizations","Positions","Roles","Categories","Spaces","hashData","approve_from_client","workflow_engine","inserted_instances","instance_from_client","new_ins","new_ins_id","create_instance","inserts","delete_obj","getSpace","submit_instance","alerts","distributedInstancesRemind","flow_ver_end_step","flow_vers","instance_flow_ver","instance_trace","old_cc_users","old_inbox_users","old_outbox_users","space_user_org_info","tempUsers","terminate_reason","f_ver","f_step","cost_time","nft_approve","current_step_auto_submit","send_message_current_user","_users","approve_users_handlers","assignee_appr","current_space_user","current_user_organization","inbox_users_from_client","last_trace_from_client","not_in_inbox_users","reassign_reason","difference","new_appr","new_user","user_organization","ah","current_setp","current_setp_type","next_step","next_step_name","next_step_type","relocate_appr","relocate_comment","relocate_inbox_users","relocate_next_step","sameTraces","signShowApproveId","ta","ti","getCurrentStepAutoSubmit","lines","isInstanceFinishedAndNotArchieved","isInstanceSubmitterOrApplicantOrSpaceAdmin","connectHandlers","use","ejs","ejsLint","end_date","error_obj","form_name","ins_to_xls","last_month_date","ret","timezoneoffset","parseInt","$gte","$and","lint","auth_token","formids","is_admin","get_SpaceChangeSet","last_trace_id","org_info","previous_step","previous_trace","previous_trace_approves","previous_trace_id","previous_trace_name","previous_trace_step_id","retrieve_approve","retrieve_comment","retrieve_type","the_trace","retrieve_appr","old_space_id","forward_users","no_permission_user_ids","uid","no_permission_users_name","new_ins_ids","current_trace_id","forward_approves","old_values","new_values","old_form","old_form_version","old_fields","common_fields","select_to_input_fields","exists_field","select_input_field","old_v","old_multiSelected","new_multiSelected","old_table_row_values","new_table_row_values","record_need","FONDSID","iscript","category_name","getCategory","ins_obj","_makeNewID","submitter_name","forward_from_instance","trace_obj","appr_obj","auto_remind","flow_name","collection","instanceHtml","instanceFile","FS","File","attachData","from","size","owner","owner_name","fileObj","main","newFile","original","update_read","redirectTo","writeHead","attach","no_limit_count","ref5","result_instances","space_names","special_user_id","userid","username","workflow_categories","ref6","ref7","status","authToken","is_paid","applicantInfo","applicant_username","user_accepted","perm_users","next_step_id","require_but_empty_fields","getForm","checkValueFieldsRequire","stepname","$elemMatch","Busboy","Fiber","parseFiles","busboy","image","fieldname","filename","encoding","mimetype","buffers","mimeType","toLowerCase","pop","decodeURIComponent","is_private","locked_by","locked_by_name","attach_id","columns","forward_ins","forward_ins_values","original_ins","original_ins_fields","original_ins_form","original_ins_id","original_subtable_fields","ref8","ref9","row_data","subTable","table_data","column","original_ins_field","oh","a_table","a_table_values","column_list","d_ins","d_ins_fields","d_ins_form","d_ins_values","d_match_col","d_match_col_field","d_match_col_fields","d_subtable_fields","d_table","d_table_values","o_ins","o_ins_fields","o_ins_form","o_ins_id","o_match_col","o_match_col_field","o_match_col_fields","o_subtable_fields","o_table","ref10","ref11","ref12","ref13","ref14","ref15","ref16","ref17","ref18","ref19","ref20","ref21","ref22","oTable","dTable","oMatchCol","dMatchCol","refillCol","aTable","o_ins_field","d_ins_field","dh","a_row","results","col","cols","d_col","d_col_fields","o_col","o_col_fields","d_row","has_obj","o_row","new_table_values","sort_col","sub_table","sub_table_values","sum_col","sumCol","sortCol","singleCols","JsonSort","jsonArr","asc","j","jl","temp","isDevelopment","to_users","orgIds","TabularTables","related_instances_tabular","Tabular","Table","orderable","render","input","step_current_name","dom","lengthChange","extraFields","pageLength","info","searching","responsive","details","autoWidth","changeSelector","curSpaceUser","fl","GetBoxInstancesTabularOptions","_get_inbox_instances_tabular_options","_get_outbox_instances_tabular_options","_handleListFields","instancesListTableTabular","newInstancesListTabular","updateTabularTitle","subs","SubsManager","ins_fields","pub","onUnload","instance_list","_tableColumns","drawCallback","ellipsisLink","emptyTd","colSpan","isPad","perfectScrollbar","oInstance","attr","click","goPage","height","pages","Math","ceil","fnRecordsDisplay","_iDisplayLength","DataTable","page","draw","blur","currentPage","keydown","keyCode","createdRow","row","dataIndex","FlowRouter","setAttribute","agent_view","cc_view","instanceNamePriorityClass","modifiedFromNow","modifiedString","priorityIcon","priorityIconClass","priorityValue","step_current_name_view","unread","momentReactiveFromNow","visible","cc_tag","lengthMenu","pagingType","is_list_display","filteredRecordIds","old_filteredRecordIds","findOptions","ag_sort","aggregate_operation","async_aggregate","s1_0","s1_1","$project","$unwind","$first","$sort","$skip","$limit","cb","$last","outbox_instances","flowInstances","ReactiveVar","autorun","_changeOrder"],"mappings":"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","file":"/packages/steedos_workflow.js","sourcesContent":["import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\t\"node-schedule\": \"^1.3.1\",\n\tcookies: \"^0.6.2\",\n\t\"xml2js\": \"^0.4.19\",\n\tmkdirp: \"^0.3.5\",\n\t\"sprintf-js\": \"^1.0.3\",\n}, 'steedos:workflow');","Workflow = {}\n\n@ImageSign = {};\n\n@TracesTemplate = {};\n\n@InstanceformTemplate = {};\n\n@InstanceAttachmentTemplate = {};\n\n@InstanceSignText = {}\n\n@RelatedInstances = {}\n\n@RelatedRecords = {}\n\n@InstanceMacro = {context: {}}\n\n@TracesManager = {};\n\nif Meteor.isClient\n\tMeteor.startup ->\n\t\tworkflow_three_columns = localStorage.getItem(\"workflow_three_columns\")\n\t\tif workflow_three_columns and workflow_three_columns == \"off\"\n\t\t\t$(\"body\").removeClass(\"three-columns\")\n\t\telse\n\t\t\t$(\"body\").addClass(\"three-columns\")\n\n\nInstanceSignText.isOpinionField_from_string = (field_formula)->\n\treturn (field_formula?.indexOf(\"{traces.\") > -1 || field_formula?.indexOf(\"{signature.traces.\") > -1 || field_formula?.indexOf(\"{yijianlan:\") > -1 || field_formula?.indexOf(\"{\\\"yijianlan\\\":\") > -1 || field_formula?.indexOf(\"{'yijianlan':\") > -1)\n\nInstanceSignText.includesOpinionField = (form, form_version)->\n\tfield_formulas = new Array();\n\n\t_form_version = {}\n\n\tif Meteor.isServer\n\t\t_form_version = uuflowManager.getFormVersion(db.forms.findOne({_id: form}), form_version)\n\telse\n\t\t_form_version = db.form_versions.findOne({_id: form_version, form: form})\n\n\tfields = _form_version?.fields || []\n\n\tfields.forEach (f)->\n\t\tif f.type == 'table'\n\t\t\tconsole.log 'ignore opinion field in table'\n\t\telse if f.type == 'section'\n\t\t\tf?.fields?.forEach (f1)->\n\t\t\t\tfield_formulas.push f1.formula\n\t\telse\n\t\t\tfield_formulas.push f.formula\n\n\t_.some field_formulas, (field_formula)->\n\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\n\n","             \n\nWorkflow = {};\n\nthis.ImageSign = {};\n\nthis.TracesTemplate = {};\n\nthis.InstanceformTemplate = {};\n\nthis.InstanceAttachmentTemplate = {};\n\nthis.InstanceSignText = {};\n\nthis.RelatedInstances = {};\n\nthis.RelatedRecords = {};\n\nthis.InstanceMacro = {\n  context: {}\n};\n\nthis.TracesManager = {};\n\nif (Meteor.isClient) {\n  Meteor.startup(function() {\n    var workflow_three_columns;\n    workflow_three_columns = localStorage.getItem(\"workflow_three_columns\");\n    if (workflow_three_columns && workflow_three_columns === \"off\") {\n      return $(\"body\").removeClass(\"three-columns\");\n    } else {\n      return $(\"body\").addClass(\"three-columns\");\n    }\n  });\n}\n\nInstanceSignText.isOpinionField_from_string = function(field_formula) {\n  return (field_formula != null ? field_formula.indexOf(\"{traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{signature.traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{yijianlan:\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{\\\"yijianlan\\\":\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{'yijianlan':\") : void 0) > -1;\n};\n\nInstanceSignText.includesOpinionField = function(form, form_version) {\n  var _form_version, field_formulas, fields;\n  field_formulas = new Array();\n  _form_version = {};\n  if (Meteor.isServer) {\n    _form_version = uuflowManager.getFormVersion(db.forms.findOne({\n      _id: form\n    }), form_version);\n  } else {\n    _form_version = db.form_versions.findOne({\n      _id: form_version,\n      form: form\n    });\n  }\n  fields = (_form_version != null ? _form_version.fields : void 0) || [];\n  fields.forEach(function(f) {\n    var ref;\n    if (f.type === 'table') {\n      return console.log('ignore opinion field in table');\n    } else if (f.type === 'section') {\n      return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n        return field_formulas.push(f1.formula);\n      }) : void 0 : void 0;\n    } else {\n      return field_formulas.push(f.formula);\n    }\n  });\n  return _.some(field_formulas, function(field_formula) {\n    return InstanceformTemplate.helpers.isOpinionField_from_string(field_formula);\n  });\n};\n","db.auth_tokens = new Meteor.Collection('auth_tokens')","InstanceReadOnlyTemplate = {};\n\n\nInstanceReadOnlyTemplate.instance_attachment = \"\"\"\n\t<tr>\n\t\t<td class=\"ins-attach-view\">\n\t\t\t<a href=\"{{ins_attach_download_url _id absolute}}\" class=\"ins_attach_href\" target=\"_parent\" data-name=\"{{this.name}}\" data-type=\"{{this.original.type}}\" data-id=\"{{_id}}\">{{this.name}}</a>\n\t\t</td>\n\t</tr>\n\"\"\"\n\nInstanceReadOnlyTemplate.afSelectUserRead = \"\"\"\n\t<div class='selectUser form-control ins_applicant'>{{value}}</div>\n\"\"\"\n\n\nInstanceReadOnlyTemplate.afFormGroupRead = \"\"\"\n\t<div class='form-group'>\n\t\t{{#with getField this.name}}\n\t\t\t{{#if equals type 'section'}}\n\t\t\t\t\t<div class='section callout callout-default'>\n\t\t\t\t\t\t<label class=\"control-label\">{{f_label this}}</label>\n\t\t\t\t\t\t<p>{{{description}}}</p>\n\t\t\t\t\t</div>\n\t\t\t{{else}}\n\t\t\t\t{{#if equals type 'table'}}\n\t\t\t\t\t<div class=\"panel panel-default steedos-table\">\n\t\t\t\t\t\t<div class=\"panel-body\" style=\"padding:0px;\">\n\t\t\t\t\t\t\t<div class=\"panel-heading\" >\n\t\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t<span class=\"description\">{{{description}}}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"readonly-table\" style=\"padding:0px;overflow-x:auto;\">\n\t\t\t\t\t\t\t\t\t<table type='table' class=\"table table-bordered table-condensed autoform-table\" style='margin-bottom:0px;' {{this.atts}} id=\"{{this.code}}Table\" name=\"{{this.code}}\" data-schema-key=\"{{this.name}}\">\n\t\t\t\t\t\t\t\t\t\t<thead id=\"{{this.name}}Thead\" name=\"{{this.name}}Thead\">\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\n\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t<tbody id=\"{{this.name}}Tbody\" name=\"{{this.name}}Tbody\">\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\n\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t{{else}}\n\t\t\t\t\t{{#if showLabel}}\n\t\t\t\t\t\t<label>{{getLabel code}}</label>\n\t\t\t\t\t{{/if}}\n\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\n\t\t\t\t{{/if}}\n\t\t\t{{/if}}\n\t\t{{/with}}\n\t</div>\n\"\"\"\n\nInstanceReadOnlyTemplate.afFormGroup = \"\"\"\n\n\t{{#with getField this.name}}\n\t\t\t{{#if equals type 'section'}}\n\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t<div class='section callout callout-default'>\n\t\t\t\t\t\t<label class=\"control-label\">{{f_label this}}</label>\n\t\t\t\t\t\t<p>{{{description}}}</p>\n\t\t\t\t\t</div>\n  \t\t\t\t</div>\n\t\t\t{{else}}\n\t\t\t\t{{#if equals type 'table'}}\n\t\t\t\t\t<div class=\"panel panel-default steedos-table\">\n\t\t\t\t\t\t<div class=\"panel-body\" style=\"padding:0px;\">\n\t\t\t\t\t\t\t<div class=\"panel-heading\" >\n\t\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t<span class=\"description\">{{{description}}}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"readonly-table\" style=\"padding:0px;overflow-x:auto;\">\n\t\t\t\t\t\t\t\t\t<table type='table' class=\"table table-bordered table-condensed autoform-table\" style='margin-bottom:0px;' {{this.atts}} id=\"{{this.code}}Table\" name=\"{{this.code}}\" data-schema-key=\"{{this.name}}\">\n\t\t\t\t\t\t\t\t\t\t<thead id=\"{{this.name}}Thead\" name=\"{{this.name}}Thead\">\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\n\t\t\t\t\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t\t\t\t\t<tbody id=\"{{this.name}}Tbody\" name=\"{{this.name}}Tbody\">\n\t\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\n\t\t\t\t\t\t\t\t\t\t</tbody>\n\t\t\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t{{else}}\n\t\t\t\t\t{{#if equals type 'input'}}\n\t\t\t\t\t\t<div class=\"form-group\" data-required=\"{{#if is_required}}true{{/if}}\">\n\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" {{getPermissions code}} data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{else}}\n\t\t\t\t\t\t{{#if equals type 'number'}}\n\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t<input type=\"number\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t{{#if equals type 'date'}}\n\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-type=\"date\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t{{#if equals type 'dateTime'}}\n\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t<input type=\"text\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-type='datetime' data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t{{#if equals type 'password'}}\n\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t<input type=\"password\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t{{#if equals type 'select'}}\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t<select name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<option value=\"{{value}}\">{{label}}</option>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'radio'}}\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"af-radio-group\" data-schema-key=\"{{getLabel code}}\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\n        \t\t\t\t\t\t\t\t\t\t\t\t<label class=\"radio-inline fix-indent\"><input type=\"radio\" value=\"{{value}}\" name=\"{{../code}}\" class=\"radio-inline fix-indent\"> {{label}}</label>\n    \t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\n    \t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'multiSelect'}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"af-checkbox-group\" data-schema-key=\"{{getLabel code}}\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label class=\"checkbox-inline fix-indent\"><input type=\"checkbox\" value=\"{{value}}\" name=\"{{../code}}\" class=\"checkbox-inline fix-indent\"> {{label}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'url'}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"url\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'email'}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"email\" title=\"{{getLabel code}}\" name=\"{{code}}\" data-schema-key=\"{{getLabel code}}\" class=\"form-control\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'checkbox'}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"checkbox\" data-schema-key=\"{{getLabel code}}\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label style=\"width: 100%;\"><input type=\"checkbox\" value=\"true\" name=\"{{code}}\" class=\"checkbox-inline fix-indent\"></label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\"7ZQnDsXBGohZMetA5\" class=\"control-label\">{{getLabel code}}</label>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t{{/if}}\n\t\t\t\t{{/if}}\n\t\t\t{{/if}}\n\t\t{{/with}}\n\"\"\"\n\nInstanceReadOnlyTemplate.create = (tempalteName, steedosData) ->\n\ttemplate = InstanceReadOnlyTemplate[tempalteName]\n\n\ttemplateCompiled = SpacebarsCompiler.compile(template, {isBody: true});\n\n\ttemplateRenderFunction = eval(templateCompiled);\n\n\tTemplate[tempalteName] = new Blaze.Template(tempalteName, templateRenderFunction);\n\tTemplate[tempalteName].steedosData = steedosData\n\tTemplate[tempalteName].helpers InstanceformTemplate.helpers\n\nInstanceReadOnlyTemplate.createInstanceSignText = (steedosData)->\n\tinstanceSignTextHtml = _getViewHtml('client/views/instance/instance_sign_text.html')\n\n\tinstanceSignTextCompiled = SpacebarsCompiler.compile(instanceSignTextHtml, {isBody: true});\n\n\tinstanceSignTextRenderFunction = eval(instanceSignTextCompiled);\n\n\tTemplate.instanceSignText = new Blaze.Template(\"instanceSignText\", instanceSignTextRenderFunction);\n\tTemplate.instanceSignText.steedosData = steedosData\n\tTemplate.instanceSignText.helpers InstanceSignText.helpers\n\nInstanceReadOnlyTemplate.createImageSign = (steedosData) ->\n\timageSignHtml = _getViewHtml('client/views/instance/image_sign.html')\n\timageSignCompiled = SpacebarsCompiler.compile(imageSignHtml, {isBody: true});\n\timageSignRenderFunction = eval(imageSignCompiled);\n\tTemplate.imageSign = new Blaze.Template(\"imageSign\", imageSignRenderFunction);\n\tTemplate.imageSign.steedosData = steedosData\n\tTemplate.imageSign.helpers ImageSign.helpers\n\n\nInstanceReadOnlyTemplate.init = (steedosData) ->\n\tInstanceReadOnlyTemplate.create(\"afSelectUserRead\", steedosData);\n\n\tif Meteor.isServer\n\t\tInstanceReadOnlyTemplate.create(\"afFormGroup\", steedosData);\n\n\tInstanceReadOnlyTemplate.create(\"afFormGroupRead\", steedosData);\n\tif Meteor.isServer\n\t\tInstanceReadOnlyTemplate.create(\"instance_attachment\", {absolute: steedosData.absolute});\n\t\tInstanceReadOnlyTemplate.createImageSign(steedosData)\n\t\tInstanceReadOnlyTemplate.createInstanceSignText(steedosData)\n\n\n\nInstanceReadOnlyTemplate.getValue = (value, field, locale, utcOffset) ->\n\tif !value && value != false\n\t\treturn ''\n\tswitch field.type\n\t\twhen 'email'\n\t\t\tvalue = if value then '<a href=\\'mailto:' + value + '\\'>' + value + '</a>' else ''\n\t\twhen 'url'\n\t\t\tif value\n\t\t\t\tif value.indexOf(\"http\") == 0\n\t\t\t\t\ttry\n\t\t\t\t\t\tvalue = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tvalue = \"<a href='' target='_blank'>\" + value + \"</a>\";\n\n\t\t\t\telse\n\t\t\t\t\tvalue = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n\t\t\telse\n\t\t\t\tvalue = ''\n\t\twhen 'group'\n\t\t\tif field.is_multiselect\n\t\t\t\tvalue = value?.getProperty(\"fullname\").toString()\n\t\t\telse\n\t\t\t\tvalue = value?.fullname\n\t\twhen 'user'\n\t\t\tif field.is_multiselect\n\t\t\t\tvalue = value?.getProperty(\"name\").toString()\n\t\t\telse\n\t\t\t\tvalue = value?.name\n\t\twhen 'password'\n\t\t\tvalue = '******'\n\t\twhen 'checkbox'\n\t\t\tif value && value != 'false'\n\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_yes\", {}, locale)\n\t\t\telse\n\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_no\", {}, locale)\n\t\twhen 'dateTime'\n\t\t\tif value && value.length == 16\n\t\t\t\tt = value.split(\"T\")\n\t\t\t\tt0 = t[0].split(\"-\");\n\t\t\t\tt1 = t[1].split(\":\");\n\n\t\t\t\tyear = t0[0];\n\t\t\t\tmonth = t0[1];\n\t\t\t\tdate = t0[2];\n\t\t\t\thours = t1[0];\n\t\t\t\tseconds = t1[1];\n\n\t\t\t\tvalue = new Date(year, month - 1, date, hours, seconds)\n\t\t\telse\n\t\t\t\tvalue = new Date(value)\n\n\t\t\tvalue = InstanceReadOnlyTemplate.formatDate(value, utcOffset);\n\t\twhen 'input'\n\t\t\tif field.is_textarea\n\t\t\t\tvalue = Spacebars.SafeString(Markdown(value))\n\t\twhen 'number'\n\t\t\tif value or value == 0\n\t\t\t\tif typeof value == 'string'\n\t\t\t\t\tvalue = parseFloat(value)\n\t\t\t\tvalue = value.toFixed(field.digits)\n\t\t\t\tvalue = Steedos.numberToString value, locale\n\t\twhen 'odata'\n\t\t\tif field.is_multiselect\n\t\t\t\tvalue = _.pluck(value, '@label').toString()\n\t\t\telse\n\t\t\t\tvalue = value['@label']\n\n\treturn value;\n\nInstanceReadOnlyTemplate.getLabel = (fields, code) ->\n\tfield = fields.findPropertyByPK(\"code\", code)\n\tif field\n\t\tif field.name\n\t\t\treturn field.name\n\t\telse\n\t\t\treturn field.code\n\n\nInstanceReadOnlyTemplate.getInstanceFormVersion = (instance)->\n\tform = db.forms.findOne(instance.form);\n\n\tform_version = {}\n\n\tform_fields = [];\n\n\tif form.current._id == instance.form_version\n\t\tform_version = form.current\n\telse\n\t\tform_version = _.where(form.historys, {_id: instance.form_version})[0]\n\n\tform_version.fields.forEach (field)->\n\t\tif field.type == 'section'\n\t\t\tform_fields.push(field);\n\t\t\tif field.fields\n\t\t\t\tfield.fields.forEach (f) ->\n\t\t\t\t\tform_fields.push(f);\n\t\telse if field.type == 'table'\n\t\t\tfield['sfields'] = field['fields']\n\t\t\tdelete field['fields']\n\t\t\tform_fields.push(field);\n\t\telse\n\t\t\tform_fields.push(field);\n\n\tform_version.fields = form_fields;\n\n\treturn form_version;\n\nInstanceReadOnlyTemplate.getFlowVersion = (instance)->\n\tflow = db.flows.findOne(instance.flow);\n\tflow_version = {}\n\tif flow.current._id == instance.flow_version\n\t\tflow_version = flow.current\n\telse\n\t\tflow_version = _.where(flow.historys, {_id: instance.flow_version})[0]\n\n\treturn flow_version;\n\n\n_getViewHtml = (path) ->\n\tviewHtml = Assets.getText(path)\n\n\tif viewHtml\n\t\tviewHtml = viewHtml.replace(/<template[\\w\\s\\\"\\=']+>/i,\"\").replace(/<\\/template>/i,\"\")\n\n\treturn viewHtml;\n\n_getLocale = (user)->\n\tif user?.locale?.toLocaleLowerCase() == 'zh-cn'\n\t\tlocale = \"zh-CN\"\n\telse if user?.locale?.toLocaleLowerCase() == 'en-us'\n\t\tlocale = \"en\"\n\telse\n\t\tlocale = \"zh-CN\"\n\treturn locale\n\n\n_getRequiredFields = (fields, rev)->\n\tif !rev\n\t\trev = [];\n\n\tfields.forEach (field)->\n\t\tif field.type == 'section'\n\t\t\t_getRequiredFields(field.fields, rev)\n\t\telse if field.type == 'table'\n\n\t\telse\n\t\t\tif field.is_required\n\t\t\t\trev.push field.code\n\treturn rev;\n\n_getStartStepEditableFields = (fields, steps)->\n\tstartStep = steps.findPropertyByPK(\"step_type\",\"start\")\n\n\teditableCode = []\n\n\t_.keys(startStep.permissions).forEach (key)->\n\t\tif startStep.permissions[key] == 'editable'\n\t\t\teditableCode.push key\n\n\treturn editableCode\n\n_getStartStepRequiredFields = (fields, steps)->\n\trequiredFields = _getRequiredFields(fields)\n\n\teditableCode = _getStartStepEditableFields(fields, steps)\n\n\treturn _.intersection(requiredFields, editableCode)\n\n_getTemplateData = (user, space, instance, options)->\n\tif Meteor.isServer\n\t\tform_version = InstanceReadOnlyTemplate.getInstanceFormVersion(instance)\n\telse\n\t\tform_version = WorkflowManager.getInstanceFormVersion(instance)\n\n\tlocale = _getLocale(user)\n\n\tsteedosData = {}\n\n\tif Meteor.isClient\n\t\tsteedosData = _.clone(WorkflowManager_format.getAutoformSchemaValues())\n\t\tsteedosData.insname = instance.name\n\t\tsteedosData.ins_state = instance.state\n\t\tsteedosData.ins_final_decision = instance.ins_final_decision\n\t\tsteedosData.ins_code = instance.code\n\t\tsteedosData.ins_is_archived = instance.is_archived\n\t\tsteedosData.ins_is_deleted = instance.ins_is_deleted\n\t\tsteedosData.applicant_name = instance.applicant_name\n\t\tsteedosData.applicantContext = instance.applicant_name\n\n\tsteedosData.instance = instance\n\tsteedosData.form_version = form_version\n\tsteedosData.locale = locale\n\tsteedosData.utcOffset = user.utcOffset\n\tsteedosData.space = instance.space\n\tsteedosData.sessionUserId = user._id\n\n\tif Meteor.isServer\n\t\tif options?.editable\n\t\t\tform = db.forms.findOne({_id: instance.form})\n\n\t\t\tflow = db.flows.findOne({_id: instance.flow})\n\n\t\t\tsteedosData.startStepEditableFields = _getStartStepEditableFields(form.current.fields, flow.current.steps);\n\n\treturn steedosData;\n\nInstanceReadOnlyTemplate.formatDate = (date, utcOffset)->\n\tif Meteor.isServer\n\t\tpassing = false;\n\telse\n\t\tpassing = true;\n\n\tif !utcOffset && utcOffset !=0\n\t\tutcOffset = 8\n\n\treturn moment(date).utcOffset(utcOffset, passing).format(\"YYYY-MM-DD HH:mm\");\n\nInstanceReadOnlyTemplate.getInstanceView = (user, space, instance, options)->\n\n\tsteedosData = _getTemplateData(user, space, instance, options)\n\n\tsteedosData.absolute = false;\n\n\tif options?.absolute\n\t\tsteedosData.absolute = true;\n\n\tinstanceTemplate = TemplateManager.getTemplate(instance, options?.templateName);\n\n\tinstanceTemplate = instanceTemplate.replace(/afSelectUser/g,\"afSelectUserRead\")\n\n\tif !options?.editable\n\t\tinstanceTemplate = instanceTemplate.replace(/afFormGroup/g,\"afFormGroupRead\")\n\n\tinstanceCompiled = SpacebarsCompiler.compile(instanceTemplate, {isBody: true});\n\n\tinstanceRenderFunction = eval(instanceCompiled);\n\n\tTemplate.instance_readonly_view = new Blaze.Template(\"instance_readonly_view\", instanceRenderFunction);\n\n\tTemplate.instance_readonly_view.steedosData = steedosData\n\n\tTemplate.instance_readonly_view.helpers InstanceformTemplate.helpers\n\n\tInstanceReadOnlyTemplate.init(steedosData);\n\n\tbody = Blaze.toHTMLWithData(Template.instance_readonly_view, steedosData)\n\n\treturn \"\"\"\n\t\t<div id='instanceform' >\n\t\t\t#{body}\n\t\t</div>\n\t\"\"\"\n\nInstanceReadOnlyTemplate.getTracesView = (user, space, instance, options)->\n\n\tsteedosData = _getTemplateData(user, space, instance)\n\n\tform = db.forms.findOne(instance.form);\n\tif form.instance_style == \"table\" || options?.templateName == \"table\"\n\t\ttracesHtml = _getViewHtml('client/views/instance/traces_table.html')\n\telse\n\t\ttracesHtml = _getViewHtml('client/views/instance/traces.html')\n\n\ttraceCompiled = SpacebarsCompiler.compile(tracesHtml, {isBody: true});\n\n\ttraceRenderFunction = eval(traceCompiled);\n\n\tTemplate.trace_readonly_view = new Blaze.Template(\"trace_readonly_view\", traceRenderFunction);\n\n\tTemplate.trace_readonly_view.steedosData = steedosData\n\n\tTemplate.trace_readonly_view.helpers TracesTemplate.helpers\n\n\tbody = Blaze.toHTMLWithData(Template.trace_readonly_view, instance.traces)\n\n\treturn body;\n\nInstanceReadOnlyTemplate.getAttachmentView = (user, space, instance)->\n\n\tsteedosData = _getTemplateData(user, space, instance)\n\n\tattachmentHtml = _getViewHtml('client/views/instance/instance_attachments.html')\n\n\tattachmentCompiled = SpacebarsCompiler.compile(attachmentHtml, {isBody: true});\n\n\tattachmentRenderFunction = eval(attachmentCompiled);\n\n\tTemplate.attachments_readonly_view = new Blaze.Template(\"attachments_readonly_view\", attachmentRenderFunction);\n\n\tTemplate.attachments_readonly_view.steedosData = steedosData\n\n\tTemplate.attachments_readonly_view.helpers InstanceAttachmentTemplate.helpers\n\n\tbody = Blaze.toHTMLWithData(Template.attachments_readonly_view)\n\n\treturn body;\n\nInstanceReadOnlyTemplate.getRelatedInstancesView = (user, space, instance, options)->\n\tsteedosData = _getTemplateData(user, space, instance)\n\n\tsteedosData.absolute = false;\n\n\tif options?.absolute\n\t\tsteedosData.absolute = true;\n\n\trelatedInstancesHtml = _getViewHtml('client/views/instance/related_instances.html')\n\n\trelatedInstancesCompiled = SpacebarsCompiler.compile(relatedInstancesHtml, {isBody: true});\n\n\trelatedInstancesRenderFunction = eval(relatedInstancesCompiled);\n\n\tTemplate.related_instances_view = new Blaze.Template(\"related_instances_view\", relatedInstancesRenderFunction);\n\n\tTemplate.related_instances_view.steedosData = steedosData\n\n\tTemplate.related_instances_view.helpers RelatedInstances.helpers\n\n\tbody = Blaze.toHTMLWithData(Template.related_instances_view, steedosData)\n\n\treturn body;\n\nInstanceReadOnlyTemplate.getRelatedRecordsView = (user, space, instance, options)->\n\tsteedosData = _getTemplateData(user, space, instance)\n\n\tsteedosData.absolute = false;\n\n\tif options?.absolute\n\t\tsteedosData.absolute = true;\n\n\trelatedRecordsHtml = _getViewHtml('client/views/instance/related_records.html')\n\n\trelatedRecordsCompiled = SpacebarsCompiler.compile(relatedRecordsHtml, {isBody: true});\n\n\trelatedRecordsRenderFunction = eval(relatedRecordsCompiled);\n\n\tTemplate.related_records_view = new Blaze.Template(\"related_records_view\", relatedRecordsRenderFunction);\n\n\tTemplate.related_records_view.steedosData = steedosData\n\n\tTemplate.related_records_view.helpers RelatedRecords.helpers\n\n\tbody = Blaze.toHTMLWithData(Template.related_records_view, steedosData)\n\n\treturn body;\n\nInstanceReadOnlyTemplate.getOnLoadScript = (instance)->\n\tform_version = WorkflowManager.getFormVersion(instance.form, instance.form_version)\n\n\tform_script = form_version.form_script;\n\n\tif form_script && form_script.replace(/\\n/g,\"\").replace(/\\s/g,\"\").length > 0\n\t\tform_script = \"CoreForm = {};CoreForm.instanceform = {};\" + form_script\n\t\tform_script += \";if(CoreForm.form_OnLoad){window.onload = CoreForm.form_OnLoad();}\"\n\telse\n\t\tform_script = \"\"\n\n\n\nInstanceReadOnlyTemplate.getInstanceHtml = (user, space, instance, options)->\n\n\tbody = InstanceReadOnlyTemplate.getInstanceView(user, space, instance, options);\n\n\tonLoadScript = InstanceReadOnlyTemplate.getOnLoadScript(instance);\n\n\tcreatorService = Meteor.settings.public.webservices?.creator?.url\n\tins_record_ids = instance.record_ids\n\n\topenFileScript = \"\"\"\n\t\t\tif(window.isNode && isNode()){\n\t\t\t\tattachs = document.getElementsByClassName(\"ins_attach_href\");\n\t\t\t\tfor(var i = 0; i < attachs.length; i++){\n\t\t\t\t\tattach = attachs[i];\n\t\t\t\t\tattach.addEventListener(\"click\", function(e){\n\t\t\t\t\t\tif(isImage(this.dataset.type) || isHtml(this.dataset.type)){\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\topenWindow(\"/api/files/instances/\" + this.dataset.id);\n\t\t\t\t\t\t}else if(nw_core.canOpenFile(this.dataset.name)){\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\tnw_core.openFile(this.href, this.dataset.name)\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar flow = \"#{instance.flow}\";\n\t\t\tvar space = \"#{instance.space}\";\n\n\t\t\tfunction getCookie(name){\n\t\t\t\tlet pattern = RegExp(name + \"=.[^;]*\")\n\t\t\t\tlet matched = document.cookie.match(pattern)\n\t\t\t\tif(matched){\n\t\t\t\t\tlet cookie = matched[0].split('=')\n\t\t\t\t\treturn cookie[1]\n\t\t\t\t}\n\t\t\t\treturn ''\n\t\t\t}\n\n\t\t\tvar records = document.getElementsByClassName(\"ins-related-records\");\n\t\t\tfor(var i = 0; i < records.length; i++){\n\t\t\t\t\tvar record = records[i];\n\t\t\t\t\trecord.addEventListener(\"click\", function(e){\n\t\t\t\t\t\tvar creatorService = \"#{creatorService}\"\n\t\t\t\t\t\tvar ins_record_ids = #{JSON.stringify(ins_record_ids)}\n\t\t\t\t\t\tif(creatorService && ins_record_ids && ins_record_ids.length > 0){\n\t\t\t\t\t\t\tvar objcetName = ins_record_ids[0].o\n\t\t\t\t\t\t\tvar id = ins_record_ids[0].ids[0]\n\t\t\t\t\t\t\tvar uobj = {};\n\t\t\t\t\t\t\tuobj[\"X-User-Id\"] = getCookie(\"X-User-Id\");\n\t\t\t\t\t\t\tuobj[\"X-Auth-Token\"] = getCookie(\"X-Auth-Token\");\n\t\t\t\t\t\t\tredirectUrl = creatorService + \"app/-/\" + objcetName + \"/view/\" + id + \"?\" + $.param(uobj);\n\t\t\t\t\t\t\topenWindow(redirectUrl);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\"\"\";\n\n\n\tif !Steedos.isMobile()\n\t\tform = db.forms.findOne(instance.form);\n\t\tif form?.instance_style == 'table'\n\t\t\tinstance_style = \"instance-table\"\n\n\tif options?.templateName == 'table'\n\t\tinstance_style = \"instance-table\"\n\n\tif options?.instance_style\n\t\tinstance_style = options.instance_style\n\n\tif !options || options.showTrace == true\n\t\ttrace = InstanceReadOnlyTemplate.getTracesView(user, space, instance)\n\telse\n\t\ttrace = \"\"\n\n\tinstanceBoxStyle = \"\";\n\n\tif instance && instance.final_decision\n\t\tif instance.final_decision == \"approved\"\n\t\t\tinstanceBoxStyle = \"box-success\"\n\t\telse if (instance.final_decision == \"rejected\")\n\t\t\tinstanceBoxStyle = \"box-danger\"\n\tif !options || options.showAttachments == true\n\t\tattachment = InstanceReadOnlyTemplate.getAttachmentView(user, space, instance)\n\telse\n\t\tattachment = \"\"\n\n\trelated_instances = InstanceReadOnlyTemplate.getRelatedInstancesView(user, space, instance, options)\n\n\trelated_records = InstanceReadOnlyTemplate.getRelatedRecordsView(user, space, instance, options)\n\n\tabsoluteUrl = Meteor.absoluteUrl()\n\n\twidth = \"960px\"\n#\t如果给table的parent设置width，则会导致阿里云邮箱显示table 异常\n\tif options?.width\n\t\twidth = \"\"\n\n\tcssHref = Meteor.absoluteUrl(\"steedos-css\")\n\n\tallCssLink = \"\"\"<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"#{cssHref}\">\"\"\"\n\n\tsubmit_btn = \"\"\n\tinstanceTracesStyle = \"\"\n\n#\tif options?.editable\n#\t\tsubmit_btn = '<a class=\"btn btn-block btn-social btn-steedos-workflow\" onclick=\"wc.submit()\"><i class=\"fa fa-facebook\"></i> 提交到审批王</a>'\n\tif options?.tagger == 'email'\n\t\tshowTracesBtn = \"\"\n\telse\n\t\tshowTracesBtn = \"\"\"\n\t\t\t<div class=\"print-tool\">\n\t\t\t\t<label class=\"cbx-label\"><input type=\"checkbox\" checked class=\"cbx-print cbx-print-traces\" id=\"cbx-print-traces\"/><span>#{t('instance_approval_history')}</span></label>\n\t\t\t</div>\n\t\t\t\"\"\"\n\t\tinstanceTracesStyle = \"\"\"\n\t\t\t.instance-view .instance-traces{\n\t\t\t\tpadding-left: 15px;\n\t\t\t\tpadding-right: 15px;\n\t\t\t}\n\t\t\"\"\"\n\n\tshowTracesScript = \"\"\"\n\t\t$( document ).ready(function(){\n\t\t\tvar b = document.getElementById('cbx-print-traces');\n\t\t\tvar t = document.getElementsByClassName('instance-traces')[0];\n\t\t\tif (b.checked){\n\t\t\t\tt.style = 'display: block;'\n\t\t\t} else {\n\t\t\t\tt.style = 'display: none;'\n\t\t\t}\n\t\t\tb.addEventListener('change', function(e){\n\t\t\t\tif (e.target.checked){\n\t\t\t\t\tt.style = 'display: block;'\n\t\t\t\t} else {\n\t\t\t\t\tt.style = 'display: none;'\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\"\"\"\n\n\tif options?.styles\n\t\tallCssLink = \"\"\n\n\tform = db.forms.findOne({_id: instance.form});\n\tformDescriptionHtml = \"\"\n\tif form\n\t\tformDescription = form.description\n\t\tif formDescription\n\t\t\tformDescription = formDescription.replace(/\\n/g,\"<br/>\")\n\t\t\tformDescriptionHtml = \"\"\"\n\t\t\t\t<div class=\"box-header  with-border instance-header\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t#{formDescription}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\"\"\"\n\n\thtml = \"\"\"\n\t\t<!DOCTYPE html>\n\t\t<html>\n\t\t\t<head>\n\t\t\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n\t\t\t\t#{allCssLink}\n\t\t\t\t<script src=\"https://www.steedos.com/website/libs/jquery.min.js\" type=\"text/javascript\"></script>\n\t\t\t\t<script src=\"/js/nw_core.js\" type=\"text/javascript\"></script>\n\t\t\t\t#{options.plugins || \"\"}\n\n\t\t\t\t<style>\n\t\t\t\t\t.steedos{\n\t\t\t\t\t\twidth: #{width};\n\t\t\t\t\t\tmargin-left: auto;\n\t\t\t\t\t\tmargin-right: auto;\n\t\t\t\t\t}\n\n\t\t\t\t\t.instance-view .instance-name{\n\t\t\t\t\t\tdisplay: inline !important\n\t\t\t\t\t}\n\t\t\t\t\t.box-tools{\n\t\t\t\t\t\tdisplay: none;\n\t\t\t\t\t}\n\t\t\t\t\t.box.collapsed-box .box-body,.box.collapsed-box .box-footer {\n\t\t\t\t\t  display: block;\n\t\t\t\t\t}\n\n\t\t\t\t\tbody{\n\t\t\t\t\t\tbackground: azure !important;\n\t\t\t\t\t}\n\n\t\t\t\t\t#{instanceTracesStyle}\n\n\t\t\t\t\t#{options?.styles || \"\"}\n\t\t\t\t</style>\n\t\t\t</head>\n\t\t\t<body>\n\t\t\t\t<div class=\"steedos\">\n\t\t\t\t\t#{submit_btn}\n\t\t\t\t\t#{showTracesBtn}\n\t\t\t\t\t<div class=\"instance-view\">\n\t\t\t\t\t\t<div class=\"instance #{instance_style}\">\n\t\t\t\t\t\t\t<form name=\"instanceForm\">\n\t\t\t\t\t\t\t\t<div class=\"instance-form box #{instanceBoxStyle}\">\n\t\t\t\t\t\t\t\t\t#{formDescriptionHtml}\n\t\t\t\t\t\t\t\t\t<div class=\"box-body\">\n\t\t\t\t\t\t\t\t\t\t<div class=\"col-md-12\">\n\t\t\t\t\t\t\t\t\t\t\t#{body}\n\t\t\t\t\t\t\t\t\t\t\t#{attachment}\n\t\t\t\t\t\t\t\t\t\t\t#{related_instances}\n\t\t\t\t\t\t\t\t\t\t\t#{related_records}\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</form>\n\t\t\t\t\t\t\t#{trace}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</body>\n\t\t\t<script>#{openFileScript};#{onLoadScript};#{showTracesScript}</script>\n\t\t</html>\n\t\"\"\"\n\n\treturn html","var _getLocale, _getRequiredFields, _getStartStepEditableFields, _getStartStepRequiredFields, _getTemplateData, _getViewHtml;                          \n\nInstanceReadOnlyTemplate = {};\n\nInstanceReadOnlyTemplate.instance_attachment = \"<tr>\\n\t<td class=\\\"ins-attach-view\\\">\\n\t\t<a href=\\\"{{ins_attach_download_url _id absolute}}\\\" class=\\\"ins_attach_href\\\" target=\\\"_parent\\\" data-name=\\\"{{this.name}}\\\" data-type=\\\"{{this.original.type}}\\\" data-id=\\\"{{_id}}\\\">{{this.name}}</a>\\n\t</td>\\n</tr>\";\n\nInstanceReadOnlyTemplate.afSelectUserRead = \"<div class='selectUser form-control ins_applicant'>{{value}}</div>\";\n\nInstanceReadOnlyTemplate.afFormGroupRead = \"<div class='form-group'>\\n\t{{#with getField this.name}}\\n\t\t{{#if equals type 'section'}}\\n\t\t\t\t<div class='section callout callout-default'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{f_label this}}</label>\\n\t\t\t\t\t<p>{{{description}}}</p>\\n\t\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t{{#if equals type 'table'}}\\n\t\t\t\t<div class=\\\"panel panel-default steedos-table\\\">\\n\t\t\t\t\t<div class=\\\"panel-body\\\" style=\\\"padding:0px;\\\">\\n\t\t\t\t\t\t<div class=\\\"panel-heading\\\" >\\n\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<span class=\\\"description\\\">{{{description}}}</span>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t<div class=\\\"readonly-table\\\" style=\\\"padding:0px;overflow-x:auto;\\\">\\n\t\t\t\t\t\t\t\t<table type='table' class=\\\"table table-bordered table-condensed autoform-table\\\" style='margin-bottom:0px;' {{this.atts}} id=\\\"{{this.code}}Table\\\" name=\\\"{{this.code}}\\\" data-schema-key=\\\"{{this.name}}\\\">\\n\t\t\t\t\t\t\t\t\t<thead id=\\\"{{this.name}}Thead\\\" name=\\\"{{this.name}}Thead\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\\n\t\t\t\t\t\t\t\t\t</thead>\\n\t\t\t\t\t\t\t\t\t<tbody id=\\\"{{this.name}}Tbody\\\" name=\\\"{{this.name}}Tbody\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\\n\t\t\t\t\t\t\t\t\t</tbody>\\n\t\t\t\t\t\t\t\t</table>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t{{else}}\\n\t\t\t\t{{#if showLabel}}\\n\t\t\t\t\t<label>{{getLabel code}}</label>\\n\t\t\t\t{{/if}}\\n\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\\n\t\t\t{{/if}}\\n\t\t{{/if}}\\n\t{{/with}}\\n</div>\";\n\nInstanceReadOnlyTemplate.afFormGroup = \"\\n{{#with getField this.name}}\\n\t\t{{#if equals type 'section'}}\\n\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t<div class='section callout callout-default'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{f_label this}}</label>\\n\t\t\t\t\t<p>{{{description}}}</p>\\n\t\t\t\t</div>\\n  \t\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t{{#if equals type 'table'}}\\n\t\t\t\t<div class=\\\"panel panel-default steedos-table\\\">\\n\t\t\t\t\t<div class=\\\"panel-body\\\" style=\\\"padding:0px;\\\">\\n\t\t\t\t\t\t<div class=\\\"panel-heading\\\" >\\n\t\t\t\t\t\t\t<label class='control-label'>{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<span class=\\\"description\\\">{{{description}}}</span>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t<div class=\\\"readonly-table\\\" style=\\\"padding:0px;overflow-x:auto;\\\">\\n\t\t\t\t\t\t\t\t<table type='table' class=\\\"table table-bordered table-condensed autoform-table\\\" style='margin-bottom:0px;' {{this.atts}} id=\\\"{{this.code}}Table\\\" name=\\\"{{this.code}}\\\" data-schema-key=\\\"{{this.name}}\\\">\\n\t\t\t\t\t\t\t\t\t<thead id=\\\"{{this.name}}Thead\\\" name=\\\"{{this.name}}Thead\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableThead this}}}\\n\t\t\t\t\t\t\t\t\t</thead>\\n\t\t\t\t\t\t\t\t\t<tbody id=\\\"{{this.name}}Tbody\\\" name=\\\"{{this.name}}Tbody\\\">\\n\t\t\t\t\t\t\t\t\t\t{{{getTableBody this}}}\\n\t\t\t\t\t\t\t\t\t</tbody>\\n\t\t\t\t\t\t\t\t</table>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t{{else}}\\n\t\t\t\t{{#if equals type 'input'}}\\n\t\t\t\t\t<div class=\\\"form-group\\\" data-required=\\\"{{#if is_required}}true{{/if}}\\\">\\n\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" {{getPermissions code}} data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t</div>\\n\t\t\t\t{{else}}\\n\t\t\t\t\t{{#if equals type 'number'}}\\n\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t<input type=\\\"number\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t{{#if equals type 'date'}}\\n\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-type=\\\"date\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t{{#if equals type 'dateTime'}}\\n\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t<input type=\\\"text\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-type='datetime' data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t{{#if equals type 'password'}}\\n\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t<input type=\\\"password\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t{{#if equals type 'select'}}\\n\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t<select name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<option value=\\\"{{value}}\\\">{{label}}</option>\\n\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n\t\t\t\t\t\t\t\t\t\t\t</select>\\n\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t{{#if equals type 'radio'}}\\n\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"af-radio-group\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n        \t\t\t\t\t\t\t\t\t\t\t\t<label class=\\\"radio-inline fix-indent\\\"><input type=\\\"radio\\\" value=\\\"{{value}}\\\" name=\\\"{{../code}}\\\" class=\\\"radio-inline fix-indent\\\"> {{label}}</label>\\n    \t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n    \t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'multiSelect'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"af-checkbox-group\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#each options this}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label class=\\\"checkbox-inline fix-indent\\\"><input type=\\\"checkbox\\\" value=\\\"{{value}}\\\" name=\\\"{{../code}}\\\" class=\\\"checkbox-inline fix-indent\\\"> {{label}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/each}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'url'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\\\"url\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'email'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<input type=\\\"email\\\" title=\\\"{{getLabel code}}\\\" name=\\\"{{code}}\\\" data-schema-key=\\\"{{getLabel code}}\\\" class=\\\"form-control\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{#if equals type 'checkbox'}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"checkbox\\\" data-schema-key=\\\"{{getLabel code}}\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label style=\\\"width: 100%;\\\"><input type=\\\"checkbox\\\" value=\\\"true\\\" name=\\\"{{code}}\\\" class=\\\"checkbox-inline fix-indent\\\"></label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{else}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<label for=\\\"7ZQnDsXBGohZMetA5\\\" class=\\\"control-label\\\">{{getLabel code}}</label>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t<div class='{{getCfClass this}} form-control' readonly disabled>{{{getValue code}}}</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t\t{{/if}}\\n\t\t\t\t\t{{/if}}\\n\t\t\t\t{{/if}}\\n\t\t\t{{/if}}\\n\t\t{{/if}}\\n\t{{/with}}\";\n\nInstanceReadOnlyTemplate.create = function(tempalteName, steedosData) {\n  var template, templateCompiled, templateRenderFunction;\n  template = InstanceReadOnlyTemplate[tempalteName];\n  templateCompiled = SpacebarsCompiler.compile(template, {\n    isBody: true\n  });\n  templateRenderFunction = eval(templateCompiled);\n  Template[tempalteName] = new Blaze.Template(tempalteName, templateRenderFunction);\n  Template[tempalteName].steedosData = steedosData;\n  return Template[tempalteName].helpers(InstanceformTemplate.helpers);\n};\n\nInstanceReadOnlyTemplate.createInstanceSignText = function(steedosData) {\n  var instanceSignTextCompiled, instanceSignTextHtml, instanceSignTextRenderFunction;\n  instanceSignTextHtml = _getViewHtml('client/views/instance/instance_sign_text.html');\n  instanceSignTextCompiled = SpacebarsCompiler.compile(instanceSignTextHtml, {\n    isBody: true\n  });\n  instanceSignTextRenderFunction = eval(instanceSignTextCompiled);\n  Template.instanceSignText = new Blaze.Template(\"instanceSignText\", instanceSignTextRenderFunction);\n  Template.instanceSignText.steedosData = steedosData;\n  return Template.instanceSignText.helpers(InstanceSignText.helpers);\n};\n\nInstanceReadOnlyTemplate.createImageSign = function(steedosData) {\n  var imageSignCompiled, imageSignHtml, imageSignRenderFunction;\n  imageSignHtml = _getViewHtml('client/views/instance/image_sign.html');\n  imageSignCompiled = SpacebarsCompiler.compile(imageSignHtml, {\n    isBody: true\n  });\n  imageSignRenderFunction = eval(imageSignCompiled);\n  Template.imageSign = new Blaze.Template(\"imageSign\", imageSignRenderFunction);\n  Template.imageSign.steedosData = steedosData;\n  return Template.imageSign.helpers(ImageSign.helpers);\n};\n\nInstanceReadOnlyTemplate.init = function(steedosData) {\n  InstanceReadOnlyTemplate.create(\"afSelectUserRead\", steedosData);\n  if (Meteor.isServer) {\n    InstanceReadOnlyTemplate.create(\"afFormGroup\", steedosData);\n  }\n  InstanceReadOnlyTemplate.create(\"afFormGroupRead\", steedosData);\n  if (Meteor.isServer) {\n    InstanceReadOnlyTemplate.create(\"instance_attachment\", {\n      absolute: steedosData.absolute\n    });\n    InstanceReadOnlyTemplate.createImageSign(steedosData);\n    return InstanceReadOnlyTemplate.createInstanceSignText(steedosData);\n  }\n};\n\nInstanceReadOnlyTemplate.getValue = function(value, field, locale, utcOffset) {\n  var date, e, hours, month, seconds, t, t0, t1, year;\n  if (!value && value !== false) {\n    return '';\n  }\n  switch (field.type) {\n    case 'email':\n      value = value ? '<a href=\\'mailto:' + value + '\\'>' + value + '</a>' : '';\n      break;\n    case 'url':\n      if (value) {\n        if (value.indexOf(\"http\") === 0) {\n          try {\n            value = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n          } catch (error) {\n            e = error;\n            value = \"<a href='' target='_blank'>\" + value + \"</a>\";\n          }\n        } else {\n          value = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n        }\n      } else {\n        value = '';\n      }\n      break;\n    case 'group':\n      if (field.is_multiselect) {\n        value = value != null ? value.getProperty(\"fullname\").toString() : void 0;\n      } else {\n        value = value != null ? value.fullname : void 0;\n      }\n      break;\n    case 'user':\n      if (field.is_multiselect) {\n        value = value != null ? value.getProperty(\"name\").toString() : void 0;\n      } else {\n        value = value != null ? value.name : void 0;\n      }\n      break;\n    case 'password':\n      value = '******';\n      break;\n    case 'checkbox':\n      if (value && value !== 'false') {\n        value = TAPi18n.__(\"form_field_checkbox_yes\", {}, locale);\n      } else {\n        value = TAPi18n.__(\"form_field_checkbox_no\", {}, locale);\n      }\n      break;\n    case 'dateTime':\n      if (value && value.length === 16) {\n        t = value.split(\"T\");\n        t0 = t[0].split(\"-\");\n        t1 = t[1].split(\":\");\n        year = t0[0];\n        month = t0[1];\n        date = t0[2];\n        hours = t1[0];\n        seconds = t1[1];\n        value = new Date(year, month - 1, date, hours, seconds);\n      } else {\n        value = new Date(value);\n      }\n      value = InstanceReadOnlyTemplate.formatDate(value, utcOffset);\n      break;\n    case 'input':\n      if (field.is_textarea) {\n        value = Spacebars.SafeString(Markdown(value));\n      }\n      break;\n    case 'number':\n      if (value || value === 0) {\n        if (typeof value === 'string') {\n          value = parseFloat(value);\n        }\n        value = value.toFixed(field.digits);\n        value = Steedos.numberToString(value, locale);\n      }\n      break;\n    case 'odata':\n      if (field.is_multiselect) {\n        value = _.pluck(value, '@label').toString();\n      } else {\n        value = value['@label'];\n      }\n  }\n  return value;\n};\n\nInstanceReadOnlyTemplate.getLabel = function(fields, code) {\n  var field;\n  field = fields.findPropertyByPK(\"code\", code);\n  if (field) {\n    if (field.name) {\n      return field.name;\n    } else {\n      return field.code;\n    }\n  }\n};\n\nInstanceReadOnlyTemplate.getInstanceFormVersion = function(instance) {\n  var form, form_fields, form_version;\n  form = db.forms.findOne(instance.form);\n  form_version = {};\n  form_fields = [];\n  if (form.current._id === instance.form_version) {\n    form_version = form.current;\n  } else {\n    form_version = _.where(form.historys, {\n      _id: instance.form_version\n    })[0];\n  }\n  form_version.fields.forEach(function(field) {\n    if (field.type === 'section') {\n      form_fields.push(field);\n      if (field.fields) {\n        return field.fields.forEach(function(f) {\n          return form_fields.push(f);\n        });\n      }\n    } else if (field.type === 'table') {\n      field['sfields'] = field['fields'];\n      delete field['fields'];\n      return form_fields.push(field);\n    } else {\n      return form_fields.push(field);\n    }\n  });\n  form_version.fields = form_fields;\n  return form_version;\n};\n\nInstanceReadOnlyTemplate.getFlowVersion = function(instance) {\n  var flow, flow_version;\n  flow = db.flows.findOne(instance.flow);\n  flow_version = {};\n  if (flow.current._id === instance.flow_version) {\n    flow_version = flow.current;\n  } else {\n    flow_version = _.where(flow.historys, {\n      _id: instance.flow_version\n    })[0];\n  }\n  return flow_version;\n};\n\n_getViewHtml = function(path) {\n  var viewHtml;\n  viewHtml = Assets.getText(path);\n  if (viewHtml) {\n    viewHtml = viewHtml.replace(/<template[\\w\\s\\\"\\=']+>/i, \"\").replace(/<\\/template>/i, \"\");\n  }\n  return viewHtml;\n};\n\n_getLocale = function(user) {\n  var locale, ref, ref1;\n  if ((user != null ? (ref = user.locale) != null ? ref.toLocaleLowerCase() : void 0 : void 0) === 'zh-cn') {\n    locale = \"zh-CN\";\n  } else if ((user != null ? (ref1 = user.locale) != null ? ref1.toLocaleLowerCase() : void 0 : void 0) === 'en-us') {\n    locale = \"en\";\n  } else {\n    locale = \"zh-CN\";\n  }\n  return locale;\n};\n\n_getRequiredFields = function(fields, rev) {\n  if (!rev) {\n    rev = [];\n  }\n  fields.forEach(function(field) {\n    if (field.type === 'section') {\n      return _getRequiredFields(field.fields, rev);\n    } else if (field.type === 'table') {\n\n    } else {\n      if (field.is_required) {\n        return rev.push(field.code);\n      }\n    }\n  });\n  return rev;\n};\n\n_getStartStepEditableFields = function(fields, steps) {\n  var editableCode, startStep;\n  startStep = steps.findPropertyByPK(\"step_type\", \"start\");\n  editableCode = [];\n  _.keys(startStep.permissions).forEach(function(key) {\n    if (startStep.permissions[key] === 'editable') {\n      return editableCode.push(key);\n    }\n  });\n  return editableCode;\n};\n\n_getStartStepRequiredFields = function(fields, steps) {\n  var editableCode, requiredFields;\n  requiredFields = _getRequiredFields(fields);\n  editableCode = _getStartStepEditableFields(fields, steps);\n  return _.intersection(requiredFields, editableCode);\n};\n\n_getTemplateData = function(user, space, instance, options) {\n  var flow, form, form_version, locale, steedosData;\n  if (Meteor.isServer) {\n    form_version = InstanceReadOnlyTemplate.getInstanceFormVersion(instance);\n  } else {\n    form_version = WorkflowManager.getInstanceFormVersion(instance);\n  }\n  locale = _getLocale(user);\n  steedosData = {};\n  if (Meteor.isClient) {\n    steedosData = _.clone(WorkflowManager_format.getAutoformSchemaValues());\n    steedosData.insname = instance.name;\n    steedosData.ins_state = instance.state;\n    steedosData.ins_final_decision = instance.ins_final_decision;\n    steedosData.ins_code = instance.code;\n    steedosData.ins_is_archived = instance.is_archived;\n    steedosData.ins_is_deleted = instance.ins_is_deleted;\n    steedosData.applicant_name = instance.applicant_name;\n    steedosData.applicantContext = instance.applicant_name;\n  }\n  steedosData.instance = instance;\n  steedosData.form_version = form_version;\n  steedosData.locale = locale;\n  steedosData.utcOffset = user.utcOffset;\n  steedosData.space = instance.space;\n  steedosData.sessionUserId = user._id;\n  if (Meteor.isServer) {\n    if (options != null ? options.editable : void 0) {\n      form = db.forms.findOne({\n        _id: instance.form\n      });\n      flow = db.flows.findOne({\n        _id: instance.flow\n      });\n      steedosData.startStepEditableFields = _getStartStepEditableFields(form.current.fields, flow.current.steps);\n    }\n  }\n  return steedosData;\n};\n\nInstanceReadOnlyTemplate.formatDate = function(date, utcOffset) {\n  var passing;\n  if (Meteor.isServer) {\n    passing = false;\n  } else {\n    passing = true;\n  }\n  if (!utcOffset && utcOffset !== 0) {\n    utcOffset = 8;\n  }\n  return moment(date).utcOffset(utcOffset, passing).format(\"YYYY-MM-DD HH:mm\");\n};\n\nInstanceReadOnlyTemplate.getInstanceView = function(user, space, instance, options) {\n  var body, instanceCompiled, instanceRenderFunction, instanceTemplate, steedosData;\n  steedosData = _getTemplateData(user, space, instance, options);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  instanceTemplate = TemplateManager.getTemplate(instance, options != null ? options.templateName : void 0);\n  instanceTemplate = instanceTemplate.replace(/afSelectUser/g, \"afSelectUserRead\");\n  if (!(options != null ? options.editable : void 0)) {\n    instanceTemplate = instanceTemplate.replace(/afFormGroup/g, \"afFormGroupRead\");\n  }\n  instanceCompiled = SpacebarsCompiler.compile(instanceTemplate, {\n    isBody: true\n  });\n  instanceRenderFunction = eval(instanceCompiled);\n  Template.instance_readonly_view = new Blaze.Template(\"instance_readonly_view\", instanceRenderFunction);\n  Template.instance_readonly_view.steedosData = steedosData;\n  Template.instance_readonly_view.helpers(InstanceformTemplate.helpers);\n  InstanceReadOnlyTemplate.init(steedosData);\n  body = Blaze.toHTMLWithData(Template.instance_readonly_view, steedosData);\n  return \"<div id='instanceform' >\\n\t\" + body + \"\\n</div>\";\n};\n\nInstanceReadOnlyTemplate.getTracesView = function(user, space, instance, options) {\n  var body, form, steedosData, traceCompiled, traceRenderFunction, tracesHtml;\n  steedosData = _getTemplateData(user, space, instance);\n  form = db.forms.findOne(instance.form);\n  if (form.instance_style === \"table\" || (options != null ? options.templateName : void 0) === \"table\") {\n    tracesHtml = _getViewHtml('client/views/instance/traces_table.html');\n  } else {\n    tracesHtml = _getViewHtml('client/views/instance/traces.html');\n  }\n  traceCompiled = SpacebarsCompiler.compile(tracesHtml, {\n    isBody: true\n  });\n  traceRenderFunction = eval(traceCompiled);\n  Template.trace_readonly_view = new Blaze.Template(\"trace_readonly_view\", traceRenderFunction);\n  Template.trace_readonly_view.steedosData = steedosData;\n  Template.trace_readonly_view.helpers(TracesTemplate.helpers);\n  body = Blaze.toHTMLWithData(Template.trace_readonly_view, instance.traces);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getAttachmentView = function(user, space, instance) {\n  var attachmentCompiled, attachmentHtml, attachmentRenderFunction, body, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  attachmentHtml = _getViewHtml('client/views/instance/instance_attachments.html');\n  attachmentCompiled = SpacebarsCompiler.compile(attachmentHtml, {\n    isBody: true\n  });\n  attachmentRenderFunction = eval(attachmentCompiled);\n  Template.attachments_readonly_view = new Blaze.Template(\"attachments_readonly_view\", attachmentRenderFunction);\n  Template.attachments_readonly_view.steedosData = steedosData;\n  Template.attachments_readonly_view.helpers(InstanceAttachmentTemplate.helpers);\n  body = Blaze.toHTMLWithData(Template.attachments_readonly_view);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getRelatedInstancesView = function(user, space, instance, options) {\n  var body, relatedInstancesCompiled, relatedInstancesHtml, relatedInstancesRenderFunction, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  relatedInstancesHtml = _getViewHtml('client/views/instance/related_instances.html');\n  relatedInstancesCompiled = SpacebarsCompiler.compile(relatedInstancesHtml, {\n    isBody: true\n  });\n  relatedInstancesRenderFunction = eval(relatedInstancesCompiled);\n  Template.related_instances_view = new Blaze.Template(\"related_instances_view\", relatedInstancesRenderFunction);\n  Template.related_instances_view.steedosData = steedosData;\n  Template.related_instances_view.helpers(RelatedInstances.helpers);\n  body = Blaze.toHTMLWithData(Template.related_instances_view, steedosData);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getRelatedRecordsView = function(user, space, instance, options) {\n  var body, relatedRecordsCompiled, relatedRecordsHtml, relatedRecordsRenderFunction, steedosData;\n  steedosData = _getTemplateData(user, space, instance);\n  steedosData.absolute = false;\n  if (options != null ? options.absolute : void 0) {\n    steedosData.absolute = true;\n  }\n  relatedRecordsHtml = _getViewHtml('client/views/instance/related_records.html');\n  relatedRecordsCompiled = SpacebarsCompiler.compile(relatedRecordsHtml, {\n    isBody: true\n  });\n  relatedRecordsRenderFunction = eval(relatedRecordsCompiled);\n  Template.related_records_view = new Blaze.Template(\"related_records_view\", relatedRecordsRenderFunction);\n  Template.related_records_view.steedosData = steedosData;\n  Template.related_records_view.helpers(RelatedRecords.helpers);\n  body = Blaze.toHTMLWithData(Template.related_records_view, steedosData);\n  return body;\n};\n\nInstanceReadOnlyTemplate.getOnLoadScript = function(instance) {\n  var form_script, form_version;\n  form_version = WorkflowManager.getFormVersion(instance.form, instance.form_version);\n  form_script = form_version.form_script;\n  if (form_script && form_script.replace(/\\n/g, \"\").replace(/\\s/g, \"\").length > 0) {\n    form_script = \"CoreForm = {};CoreForm.instanceform = {};\" + form_script;\n    return form_script += \";if(CoreForm.form_OnLoad){window.onload = CoreForm.form_OnLoad();}\";\n  } else {\n    return form_script = \"\";\n  }\n};\n\nInstanceReadOnlyTemplate.getInstanceHtml = function(user, space, instance, options) {\n  var absoluteUrl, allCssLink, attachment, body, creatorService, cssHref, form, formDescription, formDescriptionHtml, html, ins_record_ids, instanceBoxStyle, instanceTracesStyle, instance_style, onLoadScript, openFileScript, ref, ref1, related_instances, related_records, showTracesBtn, showTracesScript, submit_btn, trace, width;\n  body = InstanceReadOnlyTemplate.getInstanceView(user, space, instance, options);\n  onLoadScript = InstanceReadOnlyTemplate.getOnLoadScript(instance);\n  creatorService = (ref = Meteor.settings[\"public\"].webservices) != null ? (ref1 = ref.creator) != null ? ref1.url : void 0 : void 0;\n  ins_record_ids = instance.record_ids;\n  openFileScript = \"if(window.isNode && isNode()){\\n\tattachs = document.getElementsByClassName(\\\"ins_attach_href\\\");\\n\tfor(var i = 0; i < attachs.length; i++){\\n\t\tattach = attachs[i];\\n\t\tattach.addEventListener(\\\"click\\\", function(e){\\n\t\t\tif(isImage(this.dataset.type) || isHtml(this.dataset.type)){\\n\t\t\t\te.preventDefault();\\n\t\t\t\topenWindow(\\\"/api/files/instances/\\\" + this.dataset.id);\\n\t\t\t}else if(nw_core.canOpenFile(this.dataset.name)){\\n\t\t\t\te.preventDefault();\\n\t\t\t\tnw_core.openFile(this.href, this.dataset.name)\\n\t\t\t}\\n\t\t});\\n\t}\\n}\\n\\nvar flow = \\\"\" + instance.flow + \"\\\";\\nvar space = \\\"\" + instance.space + \"\\\";\\n\\nfunction getCookie(name){\\n\tlet pattern = RegExp(name + \\\"=.[^;]*\\\")\\n\tlet matched = document.cookie.match(pattern)\\n\tif(matched){\\n\t\tlet cookie = matched[0].split('=')\\n\t\treturn cookie[1]\\n\t}\\n\treturn ''\\n}\\n\\nvar records = document.getElementsByClassName(\\\"ins-related-records\\\");\\nfor(var i = 0; i < records.length; i++){\\n\t\tvar record = records[i];\\n\t\trecord.addEventListener(\\\"click\\\", function(e){\\n\t\t\tvar creatorService = \\\"\" + creatorService + \"\\\"\\n\t\t\tvar ins_record_ids = \" + (JSON.stringify(ins_record_ids)) + \"\\n\t\t\tif(creatorService && ins_record_ids && ins_record_ids.length > 0){\\n\t\t\t\tvar objcetName = ins_record_ids[0].o\\n\t\t\t\tvar id = ins_record_ids[0].ids[0]\\n\t\t\t\tvar uobj = {};\\n\t\t\t\tuobj[\\\"X-User-Id\\\"] = getCookie(\\\"X-User-Id\\\");\\n\t\t\t\tuobj[\\\"X-Auth-Token\\\"] = getCookie(\\\"X-Auth-Token\\\");\\n\t\t\t\tredirectUrl = creatorService + \\\"app/-/\\\" + objcetName + \\\"/view/\\\" + id + \\\"?\\\" + $.param(uobj);\\n\t\t\t\topenWindow(redirectUrl);\\n\t\t\t}\\n\t\t});\\n\t}\";\n  if (!Steedos.isMobile()) {\n    form = db.forms.findOne(instance.form);\n    if ((form != null ? form.instance_style : void 0) === 'table') {\n      instance_style = \"instance-table\";\n    }\n  }\n  if ((options != null ? options.templateName : void 0) === 'table') {\n    instance_style = \"instance-table\";\n  }\n  if (options != null ? options.instance_style : void 0) {\n    instance_style = options.instance_style;\n  }\n  if (!options || options.showTrace === true) {\n    trace = InstanceReadOnlyTemplate.getTracesView(user, space, instance);\n  } else {\n    trace = \"\";\n  }\n  instanceBoxStyle = \"\";\n  if (instance && instance.final_decision) {\n    if (instance.final_decision === \"approved\") {\n      instanceBoxStyle = \"box-success\";\n    } else if (instance.final_decision === \"rejected\") {\n      instanceBoxStyle = \"box-danger\";\n    }\n  }\n  if (!options || options.showAttachments === true) {\n    attachment = InstanceReadOnlyTemplate.getAttachmentView(user, space, instance);\n  } else {\n    attachment = \"\";\n  }\n  related_instances = InstanceReadOnlyTemplate.getRelatedInstancesView(user, space, instance, options);\n  related_records = InstanceReadOnlyTemplate.getRelatedRecordsView(user, space, instance, options);\n  absoluteUrl = Meteor.absoluteUrl();\n  width = \"960px\";\n  if (options != null ? options.width : void 0) {\n    width = \"\";\n  }\n  cssHref = Meteor.absoluteUrl(\"steedos-css\");\n  allCssLink = \"<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" class=\\\"__meteor-css__\\\" href=\\\"\" + cssHref + \"\\\">\";\n  submit_btn = \"\";\n  instanceTracesStyle = \"\";\n  if ((options != null ? options.tagger : void 0) === 'email') {\n    showTracesBtn = \"\";\n  } else {\n    showTracesBtn = \"<div class=\\\"print-tool\\\">\\n\t<label class=\\\"cbx-label\\\"><input type=\\\"checkbox\\\" checked class=\\\"cbx-print cbx-print-traces\\\" id=\\\"cbx-print-traces\\\"/><span>\" + (t('instance_approval_history')) + \"</span></label>\\n</div>\";\n    instanceTracesStyle = \".instance-view .instance-traces{\\n\tpadding-left: 15px;\\n\tpadding-right: 15px;\\n}\";\n  }\n  showTracesScript = \"$( document ).ready(function(){\\n\tvar b = document.getElementById('cbx-print-traces');\\n\tvar t = document.getElementsByClassName('instance-traces')[0];\\n\tif (b.checked){\\n\t\tt.style = 'display: block;'\\n\t} else {\\n\t\tt.style = 'display: none;'\\n\t}\\n\tb.addEventListener('change', function(e){\\n\t\tif (e.target.checked){\\n\t\t\tt.style = 'display: block;'\\n\t\t} else {\\n\t\t\tt.style = 'display: none;'\\n\t\t}\\n\t});\\n});\\n\";\n  if (options != null ? options.styles : void 0) {\n    allCssLink = \"\";\n  }\n  form = db.forms.findOne({\n    _id: instance.form\n  });\n  formDescriptionHtml = \"\";\n  if (form) {\n    formDescription = form.description;\n    if (formDescription) {\n      formDescription = formDescription.replace(/\\n/g, \"<br/>\");\n      formDescriptionHtml = \"<div class=\\\"box-header  with-border instance-header\\\">\\n\t<div>\\n\t\t\" + formDescription + \"\\n\t</div>\\n</div>\";\n    }\n  }\n  html = \"<!DOCTYPE html>\\n<html>\\n\t<head>\\n\t\t<meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=UTF-8\\\"/>\\n\t\t\" + allCssLink + \"\\n\t\t<script src=\\\"https://www.steedos.com/website/libs/jquery.min.js\\\" type=\\\"text/javascript\\\"></script>\\n\t\t<script src=\\\"/js/nw_core.js\\\" type=\\\"text/javascript\\\"></script>\\n\t\t\" + (options.plugins || \"\") + \"\\n\\n\t\t<style>\\n\t\t\t.steedos{\\n\t\t\t\twidth: \" + width + \";\\n\t\t\t\tmargin-left: auto;\\n\t\t\t\tmargin-right: auto;\\n\t\t\t}\\n\\n\t\t\t.instance-view .instance-name{\\n\t\t\t\tdisplay: inline !important\\n\t\t\t}\\n\t\t\t.box-tools{\\n\t\t\t\tdisplay: none;\\n\t\t\t}\\n\t\t\t.box.collapsed-box .box-body,.box.collapsed-box .box-footer {\\n\t\t\t  display: block;\\n\t\t\t}\\n\\n\t\t\tbody{\\n\t\t\t\tbackground: azure !important;\\n\t\t\t}\\n\\n\t\t\t\" + instanceTracesStyle + \"\\n\\n\t\t\t\" + ((options != null ? options.styles : void 0) || \"\") + \"\\n\t\t</style>\\n\t</head>\\n\t<body>\\n\t\t<div class=\\\"steedos\\\">\\n\t\t\t\" + submit_btn + \"\\n\t\t\t\" + showTracesBtn + \"\\n\t\t\t<div class=\\\"instance-view\\\">\\n\t\t\t\t<div class=\\\"instance \" + instance_style + \"\\\">\\n\t\t\t\t\t<form name=\\\"instanceForm\\\">\\n\t\t\t\t\t\t<div class=\\\"instance-form box \" + instanceBoxStyle + \"\\\">\\n\t\t\t\t\t\t\t\" + formDescriptionHtml + \"\\n\t\t\t\t\t\t\t<div class=\\\"box-body\\\">\\n\t\t\t\t\t\t\t\t<div class=\\\"col-md-12\\\">\\n\t\t\t\t\t\t\t\t\t\" + body + \"\\n\t\t\t\t\t\t\t\t\t\" + attachment + \"\\n\t\t\t\t\t\t\t\t\t\" + related_instances + \"\\n\t\t\t\t\t\t\t\t\t\" + related_records + \"\\n\t\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t\t</div>\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</form>\\n\t\t\t\t\t\" + trace + \"\\n\t\t\t\t</div>\\n\t\t\t</div>\\n\t\t</div>\\n\t</body>\\n\t<script>\" + openFileScript + \";\" + onLoadScript + \";\" + showTracesScript + \"</script>\\n</html>\";\n  return html;\n};\n","TemplateManager = {};\n\nformId = 'instanceform';\n\n\nTemplateManager.instance_title = ()->\n\tpageTitle = \"\"\"\n\t\t{{instance.name}}\n\t\"\"\"\n\n\tpageTitleTrClass = \"instance-name\"\n\n\tif CoreForm?.pageTitleFieldName\n\t\tpageTitle = \"\"\"\n\t\t\t\t{{> afFormGroup name=\"#{CoreForm.pageTitleFieldName}\" label=false}}\n\t\t\"\"\"\n\t\tpageTitleTrClass = \"\"\n\n\tif CoreForm?.pageTitle\n\t\tpageTitle = \"\"\"\n\t\t\t#{CoreForm.pageTitle}\n\t\t\"\"\"\n\t\tpageTitleTrClass = \"\"\n\n\tval =\n\t\tpageTitle: pageTitle\n\t\tpageTitleTrClass: pageTitleTrClass\n\n\treturn val\n\nTemplateManager.handleTableTemplate = (instance, _export) ->\n\n\ttemplate = \"\"\"\n\t<div class='instance-template'>\n\t\t<table class=\"table-page-title form-table no-border text-align-center\" style=\"width: 100%;display: inline-table;\">\n\t\t\t<tr class=\"#{this.instance_title().pageTitleTrClass}\">\n\t\t\t\t<td class=\"instance-table-name-td page-title\">\n\t\t\t\t\t#{this.instance_title().pageTitle}\n\t\t\t\t</td>\n\t\t\t</tr>\n\n\t\t</table>\n\t\t<table class=\"table-page-body form-table\">\n\t\t\t\t<tr style=\"height:0px\">\n\t\t\t\t\t<th style='width: 16%'></th>\n\t\t\t\t\t<th></th>\n\t\t\t\t\t<th style='width: 16%'></th>\n\t\t\t\t\t<th></th>\n\t\t\t\t</tr>\n\t\"\"\";\n\n\ttable_fields = InstanceformTemplate.helpers.table_fields(instance)\n\n\ttable_fields.forEach (table_field)->\n\n\t\trequired = \"\"\n\t\tif !CoreForm?.pageTitleFieldName || CoreForm?.pageTitleFieldName != table_field.code\n\t\t\tif table_field.is_required\n\t\t\t\trequired = \"is-required\"\n\n\t\t\tif _export\n\t\t\t\trequired = \"\";\n\n\t\t\tpureCode = Steedos.removeSpecialCharacter(table_field.code);\n\n\t\t\tif InstanceformTemplate.helpers.isOpinionField(table_field)\n\t\t\t\ttemplate += table_field.tr_start\n\t\t\t\ttemplate += \"\"\"\n\t\t\t\t\t<td class=\"td-title #{required}\">\n\t\t\t\t\t\t{{afFieldLabelText name=\"#{table_field.code}\"}}\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class=\"td-field opinion-field opinion-field-#{pureCode} automatic\" colspan = \"#{table_field.td_colspan}\">\n\t\t\t\t\t\t{{> instanceSignText name=\"#{table_field.code}\"}}\n\t\t\t\t\t</td>\n\t\t\t\t\"\"\"\n\t\t\t\ttemplate += table_field.tr_end\n\t\t\telse\n\t\t\t\tif InstanceformTemplate.helpers.includes(table_field.type, 'section,table')\n\t\t\t\t\ttemplate += table_field.tr_start\n\t\t\t\t\ttemplate += \"\"\"\n\t\t\t\t\t\t<td class=\"td-childfield td-childfield-#{pureCode}\" colspan = \"#{table_field.td_colspan}\">\n\t\t\t\t\t\t   {{> afFormGroup name=\"#{table_field.code}\" label=false}}\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\"\"\"\n\t\t\t\t\ttemplate += table_field.tr_end\n\t\t\t\telse\n\t\t\t\t\ttemplate += table_field.tr_start\n\n\t\t\t\t\tif _export\n\t\t\t\t\t\ttitle_permission = \"\"\n\t\t\t\t\t\tfield_permission = \"\"\n\t\t\t\t\telse\n\t\t\t\t\t\ttitle_permission = \"title-\" + table_field.permission\n\t\t\t\t\t\tfield_permission = \"field-\" + table_field.permission\n\n\t\t\t\t\ttemplate += \"\"\"\n\t\t\t\t\t\t<td class=\"td-title td-title-#{pureCode} #{title_permission} #{required}\">\n\t\t\t\t\t\t\t{{afFieldLabelText name=\"#{table_field.code}\"}}\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"td-field td-field-#{pureCode} #{field_permission}\" colspan = \"#{table_field.td_colspan}\">\n\t\t\t\t\t\t\t{{> afFormGroup name=\"#{table_field.code}\" label=false}}\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\"\"\"\n\t\t\t\t\ttemplate += table_field.tr_end\n\n\ttemplate += \"\"\"\n\t\t</table>\n\n\t\t<table class=\"table-page-footer form-table no-border\">\n\t\t\t<tr class=\"applicant-wrapper\">\n\t\t\t\t<td class=\"nowrap\">\n\t\t\t\t\t<div class='inline-left'>\n\t\t\t\t\t\t<label class=\"control-label\">{{_t \"instance_initiator\"}}：</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class='instance-table-wrapper-td inline-left'>\n\t\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\n\t\t\t\t\t</div>\n\t\t\t\t</td>\n\t\t\t\t<td class=\"nowrap\">\n\t\t\t\t\t<div class='pull-left'>\n\t\t\t\t\t\t<div class='inline-left'>\n\t\t\t\t\t\t\t<label>{{_t \"instance_submit_date\"}}：</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class='inline-right'>\n\t\t\t\t\t\t\t<div class=\"form-group\">\n\t\t\t\t\t\t\t\t{{formatDate instance.submit_date '{\"format\":\"YYYY-MM-DD\"}'}}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t</table>\n\t</div>\n\t\"\"\"\n\treturn template\n\n#此处模板公用与：instance 编辑、查看、打印、转发时生成附件、发送邮件body部分(table 模板)\n#如果有修改，请测试确认其他功能是否正常。\nTemplateManager._template =\n\tdefault: (instance)->\n\n\t\ttemplate = \"\"\"\n\t\t\t<div class=\"with-border col-md-12\">\n\t\t\t\t<div class=\"instance-name\">\n\t\t\t\t\t<h3 class=\"box-title\">#{TemplateManager.instance_title().pageTitle}</h3>\n\t\t\t\t\t<span class=\"help-block\"></span>\n\t\t\t\t</div>\n\t\t\t\t<span class=\"help-block\"></span>\n\t\t\t</div>\n\t\t\t{{#each steedos_form.fields}}\n\t\t\t\t{{#if isOpinionField this}}\n\t\t\t\t\t<div class=\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\">\n\t\t\t\t\t\t<div class=\"form-group automatic opinion-field-{{this.code}}\">\n\t\t\t\t\t\t\t<label class=\"control-label\">{{afFieldLabelText name=this.code}}</label>\n\n\t\t\t\t\t\t\t{{> instanceSignText name=this.code}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t{{else}}\n\t\t\t\t\t{{#if includes this.type 'section,table'}}\n\t\t\t\t\t\t<div class=\"col-md-12 field-{{this.code}}\">\n\t\t\t\t\t\t\t{{> afFormGroup name=this.code label=false}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{else}}\n\t\t\t\t\t\t<div class=\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\">\n\t\t\t\t\t\t{{> afFormGroup name=this.code}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t{{/if}}\n\t\t\t{{/each}}\n\t\t\t<div class=\"col-md-12\">\n\t\t\t\t<div class=\"applicant-wrapper form-group form-horizontal\">\n\t\t\t\t<div class=\"input-group\">\n\t\t\t\t\t<div class=\"input-group-addon\">\n\t\t\t\t\t  {{_t \"instance_initiator\"}}&nbsp;:\n\t\t\t\t\t</div>\n\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\n\t\t\t\t  </div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\"\"\"\n\t\treturn template\n\n\ttable: (instance)->\n\t\treturn TemplateManager.handleTableTemplate(instance)\n#\ttable: '''\n#\t\t<table class=\"box-header  with-border\" style=\"width: 100%;display: inline-table;\">\n#\t\t\t<tr class=\"instance-name\">\n#\t\t\t\t<td class=\"instance-table-name-td\">\n#\t\t\t\t\t<h3 class=\"box-title\">{{instance.name}}</h3>\n#\t\t\t\t\t<span class=\"help-block\"></span>\n#\t\t\t\t</td>\n#\t\t\t</tr>\n#            <tr class=\"applicant-wrapper\">\n#\t\t\t\t<td class=\"instance-table-wrapper-td\">\n#\t\t\t\t\t<label class=\"control-label\">{{_t \"instance_initiator\"}}&nbsp;:</label>\n#\t\t\t\t\t{{>Template.dynamic  template=\"afSelectUser\" data=applicantContext}}\n#\t\t\t\t</td>\n#\t\t\t</tr>\n#        </table>\n#\t\t<table class=\"form-table\">\n#\t\t    {{#each table_fields}}\n#\t\t\t\t{{#if isOpinionField this}}\n#\t\t\t\t\t{{{tr_start}}}\n#\t\t\t\t\t\t<td class=\"td-title {{#if is_required}}is-required{{/if}}\">\n#\t\t\t\t\t\t\t{{afFieldLabelText name=this.code}}\n#\t\t\t\t\t\t</td>\n#\t\t\t\t\t\t<td class=\"td-field opinion-field\" colspan = '{{td_colspan}}'>\n#\t\t\t\t\t\t\t{{> instanceSignText step=(getOpinionFieldStepName this) default=''}}\n#\t\t\t\t\t\t</td>\n#\t\t\t\t\t{{{tr_end}}}\n#\t\t\t\t{{else}}\n#\t\t\t\t\t{{#if includes this.type 'section,table'}}\n#\t\t\t\t\t\t{{{tr_start}}}\n#\t\t\t\t\t\t\t<td class=\"td-childfield\" colspan = '{{td_colspan}}'>\n#\t\t\t\t\t\t\t   {{> afFormGroup name=this.code label=false}}\n#\t\t\t\t\t\t\t</td>\n#\t\t\t\t\t\t{{{tr_end}}}\n#\t\t\t\t\t{{else}}\n#\t\t\t\t\t\t{{{tr_start}}}\n#\t\t\t\t\t\t\t<td class=\"td-title {{#if is_required}}is-required{{/if}}\">\n#\t\t\t\t\t\t\t\t{{afFieldLabelText name=this.code}}\n#\t\t\t\t\t\t\t</td>\n#\t\t\t\t\t\t\t<td class=\"td-field {{permission}}\" colspan = '{{td_colspan}}'>\n#\t\t\t\t\t\t\t\t{{> afFormGroup name=this.code label=false}}\n#\t\t\t\t\t\t\t</td>\n#\t\t\t\t\t\t{{{tr_end}}}\n#\t\t\t\t\t{{/if}}\n#\t\t\t\t{{/if}}\n#\n#\t\t    {{/each}}\n#\t\t</table>\n#\t'''\n\nTemplateManager._templateHelps =\n\tapplicantContext: ->\n\t\tsteedos_instance = WorkflowManager.getInstance();\n\t\tdata = {\n\t\t\tname: 'ins_applicant',\n\t\t\tatts: {\n\t\t\t\tname: 'ins_applicant',\n\t\t\t\tid: 'ins_applicant',\n\t\t\t\tclass: 'selectUser form-control',\n\t\t\t\tstyle: 'padding:6px 12px;width:140px;display:inline'\n\t\t\t}\n\t\t}\n#\t\tif not steedos_instance || steedos_instance.state != \"draft\"\n\t\tdata.atts.disabled = true\n\t\treturn data;\n\ninstanceId: ->\n\treturn 'instanceform';#\"instance_\" + Session.get(\"instanceId\");\n\nform_types: ->\n\tif ApproveManager.isReadOnly()\n\t\treturn 'disabled';\n\telse\n\t\treturn 'method';\n\nsteedos_form: ->\n\tform_version = WorkflowManager.getInstanceFormVersion();\n\tif form_version\n\t\treturn form_version\n\ninnersubformContext: (obj)->\n\tdoc_values = WorkflowManager_format.getAutoformSchemaValues();\n\tobj[\"tableValues\"] = if doc_values then doc_values[obj.code] else []\n\tobj[\"formId\"] = formId;\n\treturn obj;\n\ninstance: ->\n\tSession.get(\"change_date\")\n\tif (Session.get(\"instanceId\"))\n\t\tsteedos_instance = WorkflowManager.getInstance();\n\t\treturn steedos_instance;\n\nequals: (a, b) ->\n\treturn (a == b)\n\nincludes: (a, b) ->\n\treturn b.split(',').includes(a);\n\nfields: ->\n\tform_version = WorkflowManager.getInstanceFormVersion();\n\tif form_version\n\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n\ndoc_values: ->\n\tWorkflowManager_format.getAutoformSchemaValues();\n\ninstance_box_style: ->\n\tbox = Session.get(\"box\")\n\tif box == \"inbox\" || box == \"draft\"\n\t\tjudge = Session.get(\"judge\")\n\t\tif judge\n\t\t\tif (judge == \"approved\")\n\t\t\t\treturn \"box-success\"\n\t\t\telse if (judge == \"rejected\")\n\t\t\t\treturn \"box-danger\"\n\tins = WorkflowManager.getInstance();\n\tif ins && ins.final_decision\n\t\tif ins.final_decision == \"approved\"\n\t\t\treturn \"box-success\"\n\t\telse if (ins.final_decision == \"rejected\")\n\t\t\treturn \"box-danger\"\n\n\nTemplateManager.getTemplate = (instance, templateName) ->\n\tflow = db.flows.findOne(instance.flow);\n\tform = db.forms.findOne(instance.form);\n\n\tif templateName\n\t\tif templateName == 'table'\n\t\t\treturn TemplateManager._template.table(instance)\n\t\treturn TemplateManager._template.default(instance)\n\n\tif Session?.get(\"instancePrint\")\n\t\tif flow?.print_template\n\t\t\treturn \"<div class='instance-template'>\" + flow.print_template + \"</div>\"\n\t\telse\n\t\t\tif flow?.instance_template\n\t\t\t\treturn \"<div class='instance-template'>\" + flow.instance_template + \"</div>\"\n\t\t\telse\n\t\t\t\treturn TemplateManager._template.table(instance)\n\telse\n\t\tif Steedos.isMobile()\n\t\t\treturn TemplateManager._template.default(instance)\n\n\t\tif flow?.instance_template\n\t\t\treturn \"<div class='instance-template'>\" + flow.instance_template + \"</div>\"\n\n\t\tif form?.instance_style\n\t\t\tif form.instance_style == 'table'\n\t\t\t\treturn TemplateManager._template.table(instance)\n\t\t\treturn TemplateManager._template.default(instance)\n\t\telse\n\t\t\treturn TemplateManager._template.default(instance)\n\n#TemplateManager.exportTemplate = (flowId) ->\n#\ttemplate = TemplateManager.getTemplate(flowId);\n#\n#\tflow = WorkflowManager.getFlow(flowId);\n#\n#\tif flow?.instance_template\n#\t\treturn template;\n#\n#\treturn template;\n\n","var formId;                 \n\nTemplateManager = {};\n\nformId = 'instanceform';\n\nTemplateManager.instance_title = function() {\n  var pageTitle, pageTitleTrClass, val;\n  pageTitle = \"{{instance.name}}\";\n  pageTitleTrClass = \"instance-name\";\n  if (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) {\n    pageTitle = \"{{> afFormGroup name=\\\"\" + CoreForm.pageTitleFieldName + \"\\\" label=false}}\";\n    pageTitleTrClass = \"\";\n  }\n  if (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitle : void 0) {\n    pageTitle = \"\" + CoreForm.pageTitle;\n    pageTitleTrClass = \"\";\n  }\n  val = {\n    pageTitle: pageTitle,\n    pageTitleTrClass: pageTitleTrClass\n  };\n  return val;\n};\n\nTemplateManager.handleTableTemplate = function(instance, _export) {\n  var table_fields, template;\n  template = \"<div class='instance-template'>\\n\t<table class=\\\"table-page-title form-table no-border text-align-center\\\" style=\\\"width: 100%;display: inline-table;\\\">\\n\t\t<tr class=\\\"\" + (this.instance_title().pageTitleTrClass) + \"\\\">\\n\t\t\t<td class=\\\"instance-table-name-td page-title\\\">\\n\t\t\t\t\" + (this.instance_title().pageTitle) + \"\\n\t\t\t</td>\\n\t\t</tr>\\n\\n\t</table>\\n\t<table class=\\\"table-page-body form-table\\\">\\n\t\t\t<tr style=\\\"height:0px\\\">\\n\t\t\t\t<th style='width: 16%'></th>\\n\t\t\t\t<th></th>\\n\t\t\t\t<th style='width: 16%'></th>\\n\t\t\t\t<th></th>\\n\t\t\t</tr>\";\n  table_fields = InstanceformTemplate.helpers.table_fields(instance);\n  table_fields.forEach(function(table_field) {\n    var field_permission, pureCode, required, title_permission;\n    required = \"\";\n    if (!(typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) || (typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) !== table_field.code) {\n      if (table_field.is_required) {\n        required = \"is-required\";\n      }\n      if (_export) {\n        required = \"\";\n      }\n      pureCode = Steedos.removeSpecialCharacter(table_field.code);\n      if (InstanceformTemplate.helpers.isOpinionField(table_field)) {\n        template += table_field.tr_start;\n        template += \"<td class=\\\"td-title \" + required + \"\\\">\\n\t{{afFieldLabelText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\\n<td class=\\\"td-field opinion-field opinion-field-\" + pureCode + \" automatic\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n\t{{> instanceSignText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\";\n        return template += table_field.tr_end;\n      } else {\n        if (InstanceformTemplate.helpers.includes(table_field.type, 'section,table')) {\n          template += table_field.tr_start;\n          template += \"<td class=\\\"td-childfield td-childfield-\" + pureCode + \"\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n   {{> afFormGroup name=\\\"\" + table_field.code + \"\\\" label=false}}\\n</td>\";\n          return template += table_field.tr_end;\n        } else {\n          template += table_field.tr_start;\n          if (_export) {\n            title_permission = \"\";\n            field_permission = \"\";\n          } else {\n            title_permission = \"title-\" + table_field.permission;\n            field_permission = \"field-\" + table_field.permission;\n          }\n          template += \"<td class=\\\"td-title td-title-\" + pureCode + \" \" + title_permission + \" \" + required + \"\\\">\\n\t{{afFieldLabelText name=\\\"\" + table_field.code + \"\\\"}}\\n</td>\\n<td class=\\\"td-field td-field-\" + pureCode + \" \" + field_permission + \"\\\" colspan = \\\"\" + table_field.td_colspan + \"\\\">\\n\t{{> afFormGroup name=\\\"\" + table_field.code + \"\\\" label=false}}\\n</td>\";\n          return template += table_field.tr_end;\n        }\n      }\n    }\n  });\n  template += \"\t</table>\\n\\n\t<table class=\\\"table-page-footer form-table no-border\\\">\\n\t\t<tr class=\\\"applicant-wrapper\\\">\\n\t\t\t<td class=\\\"nowrap\\\">\\n\t\t\t\t<div class='inline-left'>\\n\t\t\t\t\t<label class=\\\"control-label\\\">{{_t \\\"instance_initiator\\\"}}：</label>\\n\t\t\t\t</div>\\n\t\t\t\t<div class='instance-table-wrapper-td inline-left'>\\n\t\t\t\t\t{{>Template.dynamic  template=\\\"afSelectUser\\\" data=applicantContext}}\\n\t\t\t\t</div>\\n\t\t\t</td>\\n\t\t\t<td class=\\\"nowrap\\\">\\n\t\t\t\t<div class='pull-left'>\\n\t\t\t\t\t<div class='inline-left'>\\n\t\t\t\t\t\t<label>{{_t \\\"instance_submit_date\\\"}}：</label>\\n\t\t\t\t\t</div>\\n\t\t\t\t\t<div class='inline-right'>\\n\t\t\t\t\t\t<div class=\\\"form-group\\\">\\n\t\t\t\t\t\t\t{{formatDate instance.submit_date '{\\\"format\\\":\\\"YYYY-MM-DD\\\"}'}}\\n\t\t\t\t\t\t</div>\\n\t\t\t\t\t</div>\\n\t\t\t\t</div>\\n\t\t\t</td>\\n\t\t</tr>\\n\t</table>\\n</div>\";\n  return template;\n};\n\nTemplateManager._template = {\n  \"default\": function(instance) {\n    var template;\n    template = \"<div class=\\\"with-border col-md-12\\\">\\n\t<div class=\\\"instance-name\\\">\\n\t\t<h3 class=\\\"box-title\\\">\" + (TemplateManager.instance_title().pageTitle) + \"</h3>\\n\t\t<span class=\\\"help-block\\\"></span>\\n\t</div>\\n\t<span class=\\\"help-block\\\"></span>\\n</div>\\n{{#each steedos_form.fields}}\\n\t{{#if isOpinionField this}}\\n\t\t<div class=\\\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\\\">\\n\t\t\t<div class=\\\"form-group automatic opinion-field-{{this.code}}\\\">\\n\t\t\t\t<label class=\\\"control-label\\\">{{afFieldLabelText name=this.code}}</label>\\n\\n\t\t\t\t{{> instanceSignText name=this.code}}\\n\t\t\t</div>\\n\t\t</div>\\n\t{{else}}\\n\t\t{{#if includes this.type 'section,table'}}\\n\t\t\t<div class=\\\"col-md-12 field-{{this.code}}\\\">\\n\t\t\t\t{{> afFormGroup name=this.code label=false}}\\n\t\t\t</div>\\n\t\t{{else}}\\n\t\t\t<div class=\\\"{{#if this.is_wide}}col-md-12{{else}}col-md-6{{/if}} field-{{this.code}}\\\">\\n\t\t\t{{> afFormGroup name=this.code}}\\n\t\t\t</div>\\n\t\t{{/if}}\\n\t{{/if}}\\n{{/each}}\\n<div class=\\\"col-md-12\\\">\\n\t<div class=\\\"applicant-wrapper form-group form-horizontal\\\">\\n\t<div class=\\\"input-group\\\">\\n\t\t<div class=\\\"input-group-addon\\\">\\n\t\t  {{_t \\\"instance_initiator\\\"}}&nbsp;:\\n\t\t</div>\\n\t\t{{>Template.dynamic  template=\\\"afSelectUser\\\" data=applicantContext}}\\n\t  </div>\\n\t</div>\\n</div>\";\n    return template;\n  },\n  table: function(instance) {\n    return TemplateManager.handleTableTemplate(instance);\n  }\n};\n\nTemplateManager._templateHelps = {\n  applicantContext: function() {\n    var data, steedos_instance;\n    steedos_instance = WorkflowManager.getInstance();\n    data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control',\n        style: 'padding:6px 12px;width:140px;display:inline'\n      }\n    };\n    data.atts.disabled = true;\n    return data;\n  }\n};\n\n({\n  instanceId: function() {\n    return 'instanceform';\n  },\n  form_types: function() {\n    if (ApproveManager.isReadOnly()) {\n      return 'disabled';\n    } else {\n      return 'method';\n    }\n  },\n  steedos_form: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return form_version;\n    }\n  },\n  innersubformContext: function(obj) {\n    var doc_values;\n    doc_values = WorkflowManager_format.getAutoformSchemaValues();\n    obj[\"tableValues\"] = doc_values ? doc_values[obj.code] : [];\n    obj[\"formId\"] = formId;\n    return obj;\n  },\n  instance: function() {\n    var steedos_instance;\n    Session.get(\"change_date\");\n    if (Session.get(\"instanceId\")) {\n      steedos_instance = WorkflowManager.getInstance();\n      return steedos_instance;\n    }\n  },\n  equals: function(a, b) {\n    return a === b;\n  },\n  includes: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  fields: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  },\n  doc_values: function() {\n    return WorkflowManager_format.getAutoformSchemaValues();\n  },\n  instance_box_style: function() {\n    var box, ins, judge;\n    box = Session.get(\"box\");\n    if (box === \"inbox\" || box === \"draft\") {\n      judge = Session.get(\"judge\");\n      if (judge) {\n        if (judge === \"approved\") {\n          return \"box-success\";\n        } else if (judge === \"rejected\") {\n          return \"box-danger\";\n        }\n      }\n    }\n    ins = WorkflowManager.getInstance();\n    if (ins && ins.final_decision) {\n      if (ins.final_decision === \"approved\") {\n        return \"box-success\";\n      } else if (ins.final_decision === \"rejected\") {\n        return \"box-danger\";\n      }\n    }\n  }\n});\n\nTemplateManager.getTemplate = function(instance, templateName) {\n  var flow, form;\n  flow = db.flows.findOne(instance.flow);\n  form = db.forms.findOne(instance.form);\n  if (templateName) {\n    if (templateName === 'table') {\n      return TemplateManager._template.table(instance);\n    }\n    return TemplateManager._template[\"default\"](instance);\n  }\n  if (typeof Session !== \"undefined\" && Session !== null ? Session.get(\"instancePrint\") : void 0) {\n    if (flow != null ? flow.print_template : void 0) {\n      return \"<div class='instance-template'>\" + flow.print_template + \"</div>\";\n    } else {\n      if (flow != null ? flow.instance_template : void 0) {\n        return \"<div class='instance-template'>\" + flow.instance_template + \"</div>\";\n      } else {\n        return TemplateManager._template.table(instance);\n      }\n    }\n  } else {\n    if (Steedos.isMobile()) {\n      return TemplateManager._template[\"default\"](instance);\n    }\n    if (flow != null ? flow.instance_template : void 0) {\n      return \"<div class='instance-template'>\" + flow.instance_template + \"</div>\";\n    }\n    if (form != null ? form.instance_style : void 0) {\n      if (form.instance_style === 'table') {\n        return TemplateManager._template.table(instance);\n      }\n      return TemplateManager._template[\"default\"](instance);\n    } else {\n      return TemplateManager._template[\"default\"](instance);\n    }\n  }\n};\n","SteedosTable = {};\n\nSteedosTable.formId = \"instanceform\";\n\nSteedosTable.checkItem = function(field, item_index) {\n    var fieldObj = SteedosTable.getField(field);\n\n    var fieldVal = SteedosTable.getItemModalValue(field, item_index);\n\n    var sf_name = '';\n    var rev = true;\n    fieldObj.sfields.forEach(function(sf) {\n        if (sf.permission == 'editable') {\n            sf_name = fieldObj.code + \".\" + sf.code;\n            if (!InstanceManager.checkFormFieldValue($(\"[name='\" + sf_name + \"']\")[0])) {\n                rev = false;\n            }\n        }\n    });\n\n    return rev;\n}\n\nSteedosTable.setTableItemValue = function(field, item_index, item_value) {\n\n    var tableValue = SteedosTable.getTableValue(field);\n    tableValue[item_index] = item_value;\n}\n\nSteedosTable.getTableItemValue = function(field, item_index) {\n    return SteedosTable.getTableValue(field)[item_index];\n}\n\nSteedosTable.removeTableItem = function(field, item_index) {\n    var item_value = SteedosTable.getTableItemValue(field, item_index);\n    item_value.removed = true;\n}\n\nSteedosTable.setTableValue = function(field, value) {\n    $(\"table[name='\" + field + \"']\").val({\n        val: value\n    });\n}\n\nSteedosTable.getTableValue = function(field) {\n    return $(\"table[name='\" + field + \"']\").val().val;\n}\n\nSteedosTable.getValidValue = function(field) {\n    var value = SteedosTable.getTableValue(field);\n\n    if (!value) {\n        return\n    }\n\n    var validValue = [];\n\n    value.forEach(function(v) {\n        if (!v.removed) {\n            validValue.push(v);\n        }\n    });\n    return validValue;\n}\n\n\nSteedosTable.handleData = function(field, values) {\n\n    if (!values || !(values instanceof Array)) {\n        return values;\n    }\n\n    var fieldObj = SteedosTable.getField(field);\n\n    values.forEach(function(v) {\n        fieldObj.sfields.forEach(function(f) {\n            if (f.type == 'user' || f.type == 'group') {\n                var value = v[f.code]\n                if (f.is_multiselect) {\n                    if (value && value.length > 0 && typeof(value[0]) == 'object') {\n                        v[f.code] = v[f.code].getProperty(\"id\");\n                    }\n                } else {\n                    if (value && typeof(value) == 'object') {\n                        v[f.code] = v[f.code].id;\n                    }\n                }\n            } else if (f.type == 'dateTime') {\n                var value = v[f.code]\n                if (value) {\n                    if (value.length == 16) {\n                        var t = value.split(\"T\");\n                        var t0 = t[0].split(\"-\");\n                        var t1 = t[1].split(\":\");\n\n                        year = t0[0];\n                        month = t0[1];\n                        date = t0[2];\n                        hours = t1[0];\n                        seconds = t1[1];\n                        value = new Date(year, month - 1, date, hours, seconds);\n                        v[f.code] = value;\n                    }\n\n                }\n            }\n        });\n    });\n    return values;\n}\n\nSteedosTable.getField = function(field) {\n    var instanceFields = WorkflowManager.getInstanceFields();\n    if (!instanceFields)\n        return;\n\n    var fieldObj = instanceFields.findPropertyByPK(\"code\", field);\n\n    return fieldObj;\n}\n\n\nSteedosTable.getModalData = function(field, index) {\n\n    var data = {};\n\n    var fieldObj = SteedosTable.getField(field);\n\n    if (!fieldObj) {\n        return;\n    }\n\n    data.field = fieldObj;\n\n    data.field.formula = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", fieldObj.sfields);\n\n    data.value = {};\n\n    data.value[field] = SteedosTable.getTableItemValue(field, index);\n\n    data.index = index;\n\n    return data;\n}\n\n\n\nSteedosTable.getItemModalValue = function(field, item_index) {\n\n    if (!AutoForm.getFormValues(\"steedos_table_modal_\" + field + \"_\" + item_index)) {\n        return {}\n    }\n\n    var item_value = AutoForm.getFormValues(\"steedos_table_modal_\" + field + \"_\" + item_index).insertDoc[field];\n    return item_value;\n}\n\n\nSteedosTable.addItem = function(field, index, _item_value) {\n    var keys = SteedosTable.getKeys(field);\n    var item_value = _item_value || SteedosTable.getItemModalValue(field, index);\n    $(\"tbody[name='\" + field + \"Tbody']\").append(SteedosTable.getTr(keys, item_value, index, field, true))\n\n}\n\nSteedosTable.updateItem = function(field, index, _item_value) {\n\n    var item = $(\"tr[name='\" + field + \"_item_\" + index + \"']\");\n\n    var item_value = _item_value || SteedosTable.getItemModalValue(field, index);\n\n    if (item && item.length > 0) {\n        var keys = SteedosTable.getKeys(field);\n        var tds = SteedosTable.getRemoveTd(field, index);\n\n        var sfields = SteedosTable.getField(field).sfields;\n\n        keys.forEach(function(key) {\n            var sfield = sfields.findPropertyByPK(\"code\", key);\n\n            var value = item_value[key];\n\n            tds = tds + SteedosTable.getTd(sfield, index, value);\n\n        });\n\n        item.empty();\n\n        item.append(tds);\n\n    } else {\n\n        SteedosTable.addItem(field, index);\n    }\n\n    if (SteedosTable.getTableValue(field)) {\n\n        SteedosTable.setTableItemValue(field, index, item_value);\n\n        //SteedosTable.valueHash[field][index] = item_value;\n\n    } else {\n        //SteedosTable.valueHash[field] = [item_value];\n\n        SteedosTable.setTableValue(field, [item_value])\n\n    }\n\n    //执行主表公式计算\n    InstanceManager.runFormula(field);\n\n}\n\nSteedosTable.removeItem = function(field, index) {\n\n    $(\"tr[name='\" + field + \"_item_\" + index + \"']\").hide();\n\n    SteedosTable.removeTableItem(field, index);\n\n    InstanceManager.runFormula(field);\n}\n\nSteedosTable.showModal = function(field, index, method) {\n\n\n    var modalData = SteedosTable.getModalData(field, index);\n\n    modalData.method = method;\n\n    Modal.show(\"steedosTableModal\", modalData);\n\n}\n\nSteedosTable.getKeys = function(field) {\n    if (!AutoForm.getCurrentDataForForm(SteedosTable.formId)) {\n        return [];\n    }\n\n    var ss = AutoForm.getFormSchema(SteedosTable.formId);\n\n    var keys = [];\n\n    if (ss.schema(field + \".$\").type === Object) {\n        keys = ss.objectKeys(SimpleSchema._makeGeneric(field) + '.$')\n    }\n\n    return keys;\n\n}\n\nSteedosTable.getThead = function(field, editable) {\n\n    var fieldObj = field;\n    if (!_.isObject(field))\n        fieldObj = SteedosTable.getField(field);\n\n    if (!fieldObj) {\n        return '';\n    }\n\n    var thead = '',\n        trs = '',\n        label = '',\n        width = 100;\n\n    if (editable) {\n        // trs = \"<th class='removed'></th>\"\n\t\ttrs = \"\"\n    }\n\n    var sfields = fieldObj.sfields;\n\n    if(!sfields){\n    \treturn thead;\n\t}\n\n    var sf_length = sfields.length;\n\n    if (sf_length > 0) {\n        var wide_fields = sfields.filterProperty(\"is_wide\", true);\n\n        width = 100 / (sf_length + wide_fields.length);\n    }\n\n    sfields.forEach(function(sf, index) {\n\n        label = (sf.name != null && sf.name.length > 0) ? sf.name : sf.code;\n\n        trs = trs + \"<td \"; // nowrap='nowrap'\n\n        trs = trs + \" class='title \" + sf.type + \"'\";\n\n        if (index != (sf_length - 1)) {\n            if (sf.is_wide) {\n                trs = trs + \"style='width:\" + width * 2 + \"%'\"\n            } else {\n                trs = trs + \"style='width:\" + width + \"%'\"\n            }\n        }\n\n        trs = trs + \">\" + label + \"</td>\"\n    });\n\n    thead = '<tr>' + trs + '</tr>';\n\n    return thead;\n}\n\nSteedosTable.getTbody = function(keys, field, values, editable) {\n    var tbody = \"\";\n\n    if (values instanceof Array) {\n        values.forEach(function(value, index) {\n            tbody = tbody + SteedosTable.getTr(keys, value, index, field, editable);\n        });\n    }\n\n    return tbody;\n}\n\nSteedosTable.getTr = function(keys, item_value, index, field, editable) {\n\n    var fieldObj = field;\n    if (!_.isObject(field))\n        fieldObj = SteedosTable.getField(field);\n\n    var tr = \"<tr id='\" + fieldObj.code + \"_item_\" + index + \"' name='\" + fieldObj.code + \"_item_\" + index + \"' data-index='\" + index + \"'\"\n\n    if (editable) {\n        tr = tr + \"' class='item edit'\"\n    } else {\n        if(Steedos.isMobile()){\n\t\t\ttr = tr + \" class='item item-readonly'\"\n        }else{\n\t\t\ttr = tr + \" class='item '\"\n        }\n    }\n\n    if (item_value.removed) {\n        tr = tr + \" style='display:none' \";\n    }\n\n    tr = tr + \"'>\";\n\n    var tds = \"\";\n\n    if (editable) {\n        tds = SteedosTable.getRemoveTd(fieldObj.code, index);\n    }\n\n    var sfields = fieldObj.sfields;\n\n    keys.forEach(function(key) {\n        var sfield = sfields.findPropertyByPK(\"code\", key);\n\n        var value = item_value[key];\n\n        tds = tds + SteedosTable.getTd(sfield, index, value);\n\n    });\n\n    tr = tr + tds + \"</tr>\";\n    return tr;\n}\n\nSteedosTable.getRemoveTd = function(field, index) {\n    // return \"<td class='steedosTable-item-remove removed' data-index='\" + index + \"'><i class='fa fa-times' aria-hidden='true'></td>\";\n\treturn \"\"\n}\n\nSteedosTable.getTd = function(field, index, value) {\n    var td = \"<td \";\n\n    td = td + \" class='steedosTable-item-field \" + field.type + \"' \";\n\n    var td_value = \"\";\n\n    if(Meteor.isClient){\n        td_value = SteedosTable.getTDValue(field, value)\n    }else{\n        locale = Template.instance().view.template.steedosData.locale\n\n        utcOffset = Template.instance().view.template.steedosData.utcOffset\n\n        td_value = InstanceReadOnlyTemplate.getValue(value, field, locale, utcOffset)\n    }\n\n    td = td + \" data-index='\" + index + \"'>\" + td_value + \"</td>\"\n\n    return td;\n}\n\n\nSteedosTable.getTDValue = function(field, value) {\n    var td_value = \"\";\n    if (!field) {\n        return td_value\n    }\n    try {\n\n        switch (field.type) {\n            case 'user':\n                if (value) {\n                    if (field.is_multiselect) {\n                        if (value.length > 0) {\n                            if (\"string\" == typeof(value[0])) {\n                                td_value = CFDataManager.getFormulaSpaceUsers(value).getProperty(\"name\").toString();\n                            } else {\n                                td_value = value.getProperty(\"name\").toString();\n                            }\n                        }\n                    } else {\n                        if (\"string\" == typeof(value)) {\n                            var u = CFDataManager.getFormulaSpaceUsers(value);\n                            td_value = u ? u.name : '';\n                        } else {\n                            td_value = value.name;\n                        }\n                    }\n                }\n                break;\n            case 'group':\n                if (value) {\n                    if (field.is_multiselect) {\n                        if (value.length > 0) {\n                            if (\"string\" == typeof(value[0])) {\n                                td_value = CFDataManager.getFormulaOrganizations(value).getProperty(\"name\").toString();\n                            } else {\n                                td_value = value.getProperty(\"name\").toString();\n                            }\n                        }\n                    } else {\n                        if (\"string\" == typeof(value)) {\n                            var o = CFDataManager.getFormulaOrganization(value);\n                            td_value = o ? o.name : '';\n                        } else {\n                            td_value = value.name;\n                        }\n                    }\n                }\n                break;\n            case 'checkbox':\n                if (value === true || value == 'true') {\n                    td_value = TAPi18n.__(\"form_field_checkbox_yes\");\n                } else {\n                    td_value = TAPi18n.__(\"form_field_checkbox_no\");\n                }\n                break;\n            case 'email':\n                td_value = value ? \"<a href='mailto:\" + value + \"'>\" + value + \"</a>\" : \"\";\n                break;\n            case 'url':\n                if(value){\n                    if(value.indexOf(\"http\") == 0){\n                        try {\n                            td_value = \"<a href='\" + encodeURI(value) + \"' target='_blank'>\" + value + \"</a>\";\n                        } catch (e) {\n                            td_value = \"<a href='' target='_blank'>\" + value + \"</a>\";\n                        }\n\n                    }else{\n                        td_value = \"<a href='http://\" + encodeURI(value) + \"' target='_blank'>http://\" + value + \"</a>\";\n                    }\n                }else{\n                    td_value = \"\";\n                }\n                break;\n            case 'password':\n                td_value = '******';\n                break;\n            case 'date':\n                if (value) {\n                    if (value.length == 10) {\n                        var t = value.split(\"-\");\n                        year = t[0];\n                        month = t[1];\n                        date = t[2];\n                        value = new Date(year, month - 1, date);\n                    } else {\n                        value = new Date(value)\n                    }\n                    td_value = $.format.date(value, 'yyyy-MM-dd');\n                }\n                break;\n            case 'dateTime':\n                if (value) {\n                    if (value.length == 16) {\n                        var t = value.split(\"T\");\n                        var t0 = t[0].split(\"-\");\n                        var t1 = t[1].split(\":\");\n\n                        year = t0[0];\n                        month = t0[1];\n                        date = t0[2];\n                        hours = t1[0];\n                        seconds = t1[1];\n\n                        value = new Date(year, month - 1, date, hours, seconds);\n\n                    } else {\n\n                        value = new Date(value)\n                    }\n                    td_value = $.format.date(value, 'yyyy-MM-dd HH:mm');\n                }\n                break;\n            case 'number':\n                if (value || value == 0) {\n                    if (typeof(value) == 'string') {\n                        value = parseFloat(value)\n                    }\n                    td_value = value.toFixed(field.digits);\n                    td_value = Steedos.numberToString(td_value);\n                }\n                break;\n            case 'odata':\n                if(value){\n\t\t\t\t\tif (field.is_multiselect){\n\t\t\t\t\t\ttd_value = _.pluck(value, '@label').toString()\n\t\t\t\t\t}else{\n\t\t\t\t\t\ttd_value = value['@label']\n\t\t\t\t\t}\n                }\n                break;\n            default:\n                td_value = value ? value : '';\n                break;\n        }\n    } catch (e) {\n        e;\n\n        return '';\n    }\n    return td_value;\n};\n\nif(Meteor.isClient){\n    AutoForm.addInputType(\"table\", {\n        template: \"afTable\",\n        valueOut: function() {\n            var name = this.data(\"schemaKey\");\n            return SteedosTable.getValidValue(name);\n        },\n        valueConverters: {\n            \"stringArray\": AutoForm.valueConverters.stringToStringArray,\n            \"number\": AutoForm.valueConverters.stringToNumber,\n            \"numerArray\": AutoForm.valueConverters.stringToNumberArray,\n            \"boolean\": AutoForm.valueConverters.stringToBoolean,\n            \"booleanArray\": AutoForm.valueConverters.stringToBooleanArray,\n            \"date\": AutoForm.valueConverters.stringToDate,\n            \"dateArray\": AutoForm.valueConverters.stringToDateArray\n        },\n        contextAdjust: function(context) {\n            if (typeof context.atts.maxlength === 'undefined' && typeof context.max === 'number') {\n                context.atts.maxlength = context.max;\n            }\n            return context;\n        }\n    });\n\n    Template.afTable.events({\n        'tap .steedos-table .steedosTable-item-add,.add-item-tr': function(event, template) {\n            var name = template.data.name;\n\n            var tableValue = SteedosTable.getTableValue(name);\n\n            var new_item_index = tableValue ? tableValue.length : 0;\n\n            SteedosTable.showModal(name, new_item_index, \"add\");\n        },\n\n        'tap .steedos-table .steedosTable-item-field': function(event, template) {\n            if (template.data.atts.editable) {\n                var field = template.data.name;\n                var index = event.currentTarget.dataset.index;\n                SteedosTable.showModal(field, index, \"edit\");\n            }\n        },\n\n        'tap .steedos-table .steedosTable-item-remove': function(event, template) {\n            var field = template.data.name;\n            var item_index = event.currentTarget.dataset.index;\n            Session.set(\"instance_change\", true);\n            SteedosTable.removeItem(field, item_index);\n        },\n\n        'tap .steedos-table .item-readonly': function (event, template) {\n\t\t\tif (!template.data.atts.editable) {\n\t\t\t\tvar field = template.data.name;\n\t\t\t\tvar index = event.currentTarget.dataset.index;\n\t\t\t\tSteedosTable.showModal(field, index, \"read\");\n\t\t\t}\n\t\t}\n    });\n\n\n\n    Template.afTable.rendered = function() {\n\n        var field = this.data.name;\n\n        var keys = SteedosTable.getKeys(field);\n        var validValue = SteedosTable.handleData(field, this.data.value);\n        SteedosTable.setTableValue(field, validValue);\n\n        $(\"thead[name='\" + field + \"Thead']\").html(SteedosTable.getThead(field, this.data.atts.editable));\n\n        $(\"tbody[name='\" + field + \"Tbody']\").html(SteedosTable.getTbody(keys, field, SteedosTable.getTableValue(field), this.data.atts.editable));\n        \n        str = t(\"steedos_table_add_item\");\n        addItemTr = \"<tr class='add-item-tr'><td colspan='\"+keys.length+\"'><i class='ion ion-plus-round'></i>\"+str+\"</td></tr>\";\n\n        if (this.data.atts.editable) {\n           $(\"tfoot[name='\" + field + \"Tfoot']\").append(addItemTr);\n        }\n    };\n}","ImageSign.helpers =\n\tspaceUserSign: (userId)->\n\t\tspace = \"\"\n\n\t\tif Meteor.isServer\n\t\t\tspace = Template.instance().view.template.steedosData.space\n\t\telse\n\t\t\tspace = Session.get(\"spaceId\")\n\n\t\tspaceUserSign = db.space_user_signs.findOne({space: space, user: userId});\n\t\treturn spaceUserSign\n\n\timageURL: (userId)->\n\n\t\tspaceUserSign = ImageSign.helpers.spaceUserSign(userId);\n\n\t\tabsolute = false\n\n\t\tif Meteor.isServer\n\t\t\tabsolute = Template.instance().view.template.steedosData.absolute\n\n\t\tif spaceUserSign?.sign\n\t\t\tif absolute\n\t\t\t\treturn Meteor.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n\t\t\telse\n\t\t\t\treturn Steedos.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n","ImageSign.helpers = {\n  spaceUserSign: function(userId) {\n    var space, spaceUserSign;\n    space = \"\";\n    if (Meteor.isServer) {\n      space = Template.instance().view.template.steedosData.space;\n    } else {\n      space = Session.get(\"spaceId\");\n    }\n    spaceUserSign = db.space_user_signs.findOne({\n      space: space,\n      user: userId\n    });\n    return spaceUserSign;\n  },\n  imageURL: function(userId) {\n    var absolute, spaceUserSign;\n    spaceUserSign = ImageSign.helpers.spaceUserSign(userId);\n    absolute = false;\n    if (Meteor.isServer) {\n      absolute = Template.instance().view.template.steedosData.absolute;\n    }\n    if (spaceUserSign != null ? spaceUserSign.sign : void 0) {\n      if (absolute) {\n        return Meteor.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n      } else {\n        return Steedos.absoluteUrl(\"api/files/avatars/\" + spaceUserSign.sign);\n      }\n    }\n  }\n};\n","InstanceformTemplate.helpers =\n\tapplicantContext: ->\n\t\tsteedos_instance = WorkflowManager.getInstance();\n\t\tdata = {\n\t\t\tname: 'ins_applicant',\n\t\t\tatts: {name: 'ins_applicant', id: 'ins_applicant', class: 'selectUser form-control ins_applicant'},\n\t\t\tvalue: steedos_instance.applicant_name\n\t\t}\n\t\tif not steedos_instance || steedos_instance.state != \"draft\"\n\t\t\tdata.atts.disabled = true\n\t\treturn data;\n\n\tinstanceId: ->\n\t\treturn 'instanceform';#\"instance_\" + Session.get(\"instanceId\");\n\n\tform_types: ->\n\t\tif ApproveManager.isReadOnly()\n\t\t\treturn 'disabled';\n\t\telse\n\t\t\treturn 'method';\n\n\tsteedos_form: ->\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\n\t\tif form_version\n\t\t\treturn form_version\n\n\tinnersubformContext: (obj)->\n\t\tdoc_values = WorkflowManager_format.getAutoformSchemaValues();\n\t\tobj[\"tableValues\"] = if doc_values then doc_values[obj.code] else []\n\t\tobj[\"formId\"] = \"instanceform\";\n\t\treturn obj;\n\n\tinstance: ->\n\t\tSession.get(\"change_date\")\n\t\tif (Session.get(\"instanceId\"))\n\t\t\tsteedos_instance = WorkflowManager.getInstance();\n\t\t\treturn steedos_instance;\n\n\tempty: (val) ->\n\t\tif val\n\t\t\treturn false\n\t\telse\n\t\t\treturn true;\n\n\tunempty: (val) ->\n\t\tif val\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\n\tequals: (a, b) ->\n\t\treturn (a == b)\n\n\tunequals: (a, b) ->\n\t\treturn !(a == b)\n\n\tincludes: (a, b) ->\n\t\treturn b.split(',').includes(a);\n\n\tinclude: (a, b) ->\n\t\treturn b.split(',').includes(a);\n\n\tfields: ->\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\n\t\tif form_version\n\t\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n\n\tformatDate: (date, options)->\n\t\tif !date\n\t\t\treturn \"\";\n\t\tif options && typeof(options) == 'string'\n\t\t\toptions = JSON.parse(options);\n\n\t\tif !options.format\n\t\t\toptions = {format: \"YYYY-MM-DD HH:mm\"}\n\n\t\treturn moment(date).format(options.format);\n\n\ttraces: ->\n\t\tif Meteor.isServer\n\t\t\tsteedosData = Template.instance()?.view?.template?.steedosData\n\t\t\tinstance = steedosData?.instance\n\t\t\tflow = InstanceReadOnlyTemplate.getFlowVersion(instance);\n\t\t\tlocale = steedosData?.locale\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\n\t\t\t\tlocale = \"zh-CN\"\n\t\telse\n\t\t\tinstance = WorkflowManager.getInstance();\n\n\t\t\tflow = WorkflowManager.getInstanceFlowVersion()\n\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\n\n\t\tif !instance || !flow\n\t\t\treturn {};\n\n\t\tsteps = flow.steps;\n\n\t\ttraces = {};\n\n\t\tinstance.traces?.forEach (trace)->\n\t\t\tstep = steps.findPropertyByPK(\"_id\", trace.step)\n\n\t\t\tapproves = []\n\n\t\t\ttrace.approves?.forEach (approve) ->\n\t\t\t\tif trace.is_finished == true\n# 已结束的显示为核准/驳回/取消申请\n\t\t\t\t\tif approve.judge == 'approved'\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State approved\", {}, locale)\n\t\t\t\t\telse if approve.judge == 'rejected'\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State rejected\", {}, locale)\n\t\t\t\t\telse if approve.judge == 'terminated'\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State terminated\", {}, locale)\n\t\t\t\t\telse if approve.judge == 'reassigned'\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State reassigned\", {}, locale)\n\t\t\t\t\telse if approve.judge == 'relocated'\n\t\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State relocated\", {}, locale)\n\t\t\t\t\telse if approve.judge == ''\n\t\t\t\t\t\tjudge_name = \"\"\n\t\t\t\t\telse\n\t\t\t\t\t\tjudge_name = \"\"\n\n\t\t\t\telse\n\t\t\t\t\tjudge_name = TAPi18n.__(\"Instance State pending\", {}, locale)\n\n\t\t\t\tapproves.push\n\t\t\t\t\t_id: approve._id\n\t\t\t\t\thandler: approve.user\n\t\t\t\t\thandler_name: approve.handler_name\n\t\t\t\t\thandler_organization_name: approve.handler_organization_name\n\t\t\t\t\thandler_organization_fullname: approve.handler_organization_fullname\n\t\t\t\t\tfinish_date: approve.finish_date\n\t\t\t\t\tjudge: approve.judge\n\t\t\t\t\tjudge_name: judge_name\n\t\t\t\t\tdescription: approve.description\n\t\t\t\t\tis_finished: approve.is_finished\n\t\t\t\t\ttype: approve.type\n\t\t\t\t\topinion_fields_code: approve.opinion_fields_code\n\t\t\t\t\tsign_field_code: approve.sign_field_code\n\t\t\t\t\tis_read: approve.is_read\n\t\t\t\t\tsign_show: approve.sign_show\n\n\n\t\t\tif step\n\t\t\t\tif step.name of traces\n\t\t\t\t\ttraces[step.name] = traces[step.name].concat(approves)\n\t\t\t\telse\n\t\t\t\t\ttraces[step.name] = approves\n\n\t\treturn traces;\n\n\n\n\tdoc_values: ->\n\t\tWorkflowManager_format.getAutoformSchemaValues();\n\n\tinstance_box_style: ->\n\t\tbox = Session.get(\"box\")\n\t\tif box == \"inbox\" || box == \"draft\"\n\t\t\tjudge = Session.get(\"judge\")\n\t\t\tif judge\n\t\t\t\tif (judge == \"approved\")\n\t\t\t\t\treturn \"box-success\"\n\t\t\t\telse if (judge == \"rejected\")\n\t\t\t\t\treturn \"box-danger\"\n\t\tins = WorkflowManager.getInstance();\n\t\tif ins && ins.final_decision\n\t\t\tif ins.final_decision == \"approved\"\n\t\t\t\treturn \"box-success\"\n\t\t\telse if (ins.final_decision == \"rejected\")\n\t\t\t\treturn \"box-danger\"\n\n#is_disabled: ->\n#    ins = WorkflowManager.getInstance();\n#    if !ins\n#        return;\n#    if ins.state!=\"draft\"\n#        return \"disabled\";\n#    return;\n\n\ttable_fields: (instance)->\n\t\tif Meteor.isClient\n\t\t\tform_version = WorkflowManager.getInstanceFormVersion();\n\t\telse\n\t\t\tform_version = WorkflowManager.getFormVersion(instance.form, instance.form_version)\n\t\tif form_version\n\t\t\tfields = _.clone(form_version.fields);\n\n\t\t\tfields.forEach (field, index) ->\n\t\t\t\tfield.tr_start = \"\";\n\t\t\t\tfield.tr_end = \"\";\n\t\t\t\ttd_colspan = 1;\n#\t\t\t\t强制设置标头字段为宽字段\n\t\t\t\tif CoreForm?.pageTitleFieldName == field.code\n\t\t\t\t\tfield.is_wide = true\n\n\t\t\t\tif field.formula && field.type != 'odata'\n\t\t\t\t\tfield.permission = \"readonly\";\n\n\t\t\t\tif Steedos.isMobile()\n# 如果当前字段是分组、表格、宽字段\n\t\t\t\t\tif field.type == 'section' || field.type == 'table'\n\t\t\t\t\t\tfield.td_colspan = 4;\n\t\t\t\t\telse\n\t\t\t\t\t\tfield.td_colspan = 3;\n\n\t\t\t\t\tif index != 0\n\t\t\t\t\t\tfield.tr_start = \"<tr>\";\n\t\t\t\t\t\tfield.tr_end = \"</tr>\";\n\t\t\t\telse\n\t\t\t\t\tpre_fields = fields.slice(0, index);\n\n\t\t\t\t\tpre_wide_fields = pre_fields.filterProperty(\"is_wide\", true);\n\n\t\t\t\t\ttr_start = \"\";\n\n\t\t\t\t\ttr_end = \"\";\n\n\t\t\t\t\t# 先计算当前字段是否为宽字段\n\t\t\t\t\tbefore_field = null;\n\t\t\t\t\tafter_field = null;\n\n\t\t\t\t\tif index > 0\n\t\t\t\t\t\tbefore_field = fields[index - 1]\n\n\t\t\t\t\tif index < fields.length - 1\n\t\t\t\t\t\tafter_field = fields[index + 1]\n\n\t\t\t\t\t# 如果当前字段是分组、表格、宽字段\n\t\t\t\t\tif field.type == 'section' || field.type == 'table'\n\t\t\t\t\t\ttd_colspan = 4;\n\t\t\t\t\telse if field.is_wide\n\t\t\t\t\t\ttd_colspan = 3;\n\t\t\t\t\telse\n# 前后都是宽字段\n\t\t\t\t\t\tif before_field && after_field && before_field.is_wide && after_field.is_wide\n\t\t\t\t\t\t\tfield.is_wide = true;\n\t\t\t\t\t\t\ttd_colspan = 3;\n\n\t\t\t\t\t\t# 当前是tr 下的 第一个td & 后边的字段是宽字段\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 && after_field && after_field.is_wide\n\t\t\t\t\t\t\tfield.is_wide = true;\n\t\t\t\t\t\t\ttd_colspan = 3;\n\n\t\t\t\t\t\t# 当前是tr 下的 第一个td & 当前字段是最后一个字段\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 && after_field == null\n\t\t\t\t\t\t\tfield.is_wide = true;\n\t\t\t\t\t\t\ttd_colspan = 3;\n\n\t\t\t\t\tfield.td_colspan = td_colspan;\n\n\n\t\t\t\t\tif index == 0\n# tr_start = \"<tr>\"; 由于Template的编译bug，导致每次给一个tr开始时，会自动补头或补尾。因此在第一行返回一个空字符串.\n\t\t\t\t\t\ttr_start = \"<tr>\";\n\t\t\t\t\telse\n\t\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 == 0 || field.is_wide\n\t\t\t\t\t\t\tif field.type == 'table'\n\t\t\t\t\t\t\t\ttr_start = \"<tr class = \\\"tr-child-table\\\">\";\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\ttr_start = \"<tr>\";\n\n\t\t\t\t\tfield.tr_start = tr_start;\n\n\n\t\t\t\t\tif index + 1 == fields.length || field.type == 'section' || field.type == 'table' || field.is_wide\n\t\t\t\t\t\ttr_end = \"</tr>\";\n\n\t\t\t\t\tif (pre_fields.length + pre_wide_fields.length) % 2 != 0\n\t\t\t\t\t\ttr_end = \"</tr>\";\n\n\t\t\t\t\tfield.tr_end = tr_end;\n\n\t\t\treturn fields;\n\n\tsort_approve: (approves, order)->\n\t\tif !approves\n\t\t\treturn []\n\n\t\tif !approves instanceof Array\n\t\t\treturn []\n\t\telse\n\t\t\tif order == 'desc'\n\t\t\t\tapproves.sort (p1, p2) ->\n\t\t\t\t\t_p1 = 0\n\t\t\t\t\t_p2 = 0\n\n\t\t\t\t\tif p1.finish_date\n\t\t\t\t\t\t_p1 = p1.finish_date.getTime()\n\n\t\t\t\t\tif p2.finish_date\n\t\t\t\t\t\t_p2 = p2.finish_date.getTime();\n\n\t\t\t\t\treturn _p2 - _p1\n\t\t\telse\n\t\t\t\tapproves.sort (p1, p2) ->\n\t\t\t\t\t_p1 = 0\n\t\t\t\t\t_p2 = 0\n\n\t\t\t\t\tif p1.finish_date\n\t\t\t\t\t\t_p1 = p1.finish_date.getTime()\n\n\t\t\t\t\tif p2.finish_date\n\t\t\t\t\t\t_p2 = p2.finish_date.getTime();\n\n\t\t\t\t\treturn _p1 - _p2\n\t\treturn approves\n\n\t_t: (key)->\n\t\treturn TAPi18n.__(key)\n\tgetField: (code)->\n\t\tform_version = Template.instance().view.template.steedosData.form_version\n\t\tif form_version\n\t\t\treturn form_version.fields.findPropertyByPK(\"code\", code)\n\n\tgetValue: (code)->\n\t\tinstance = Template.instance().view.template.steedosData.instance\n\n\t\tform_version = Template.instance().view.template.steedosData.form_version\n\n\t\tlocale = Template.instance().view.template.steedosData.locale\n\n\t\tutcOffset = Template.instance().view.template.steedosData.utcOffset\n\n\t\tvalues = instance.values || {}\n\n\t\tif Meteor.isClient\n\t\t\tvalues = WorkflowManager_format.getAutoformSchemaValues()\n\n\t\treturn InstanceReadOnlyTemplate.getValue values[code], form_version.fields.findPropertyByPK(\"code\", code), locale, utcOffset\n\n\tgetLabel: (code)->\n\t\tform_version = Template.instance().view.template.steedosData.form_version\n\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, code\n\n\tgetCfClass: (field)->\n\t\tif field?.type == \"input\" && field?.is_textarea\n\t\t\treturn \"cfTextarea\"\n\n\tgetTableThead: (field)->\n\t\treturn SteedosTable.getThead(field, false)\n\n\tgetTableBody: (field)->\n\n\t\tif Meteor.isServer\n\t\t\tinstance = Template.instance().view.template.steedosData.instance\n\t\t\tvalues = instance.values || {}\n\t\telse\n\t\t\tvalues = WorkflowManager_format.getAutoformSchemaValues()\n\n\t\ttableValue = values[field.code];\n\t\treturn SteedosTable.getTbody(field.sfields.getProperty(\"code\"), field, tableValue, false)\n\n\tshowLabel: (field)->\n\t\ttemplateData = Template.instance().data\n\t\tif templateData.label == false\n\t\t\treturn false\n\t\treturn true\n\n#\tafFieldLabelText: (op)->\n#\t\tif !Template.instance().view.template.steedosData\n#\t\t\treturn AutoForm.getLabelForField(op.name)\n#\t\telse\n#\t\t\tform_version = Template.instance().view.template.steedosData.form_version\n#\t\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, op?.hash?.name\n\n\tisOpinionField: (field)->\n\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field.formula)\n\n\tisOpinionField_from_string: (field_formula)->\n\t\treturn InstanceSignText.isOpinionField_from_string(field_formula)\n\n\tincludesOpinionField: (form, form_version)->\n\n\t\tfield_formulas = new Array();\n\n\t\tfields = db.form_versions.findOne({_id: form_version, form: form})?.fields || []\n\n\t\tfields.forEach (f)->\n\t\t\tif f.type == 'table'\n\t\t\t\tconsole.log 'ignore opinion field in table'\n\t\t\telse if f.type == 'section'\n\t\t\t\tf?.fields?.forEach (f1)->\n\t\t\t\t\tfield_formulas.push f1.formula\n\t\t\telse\n\t\t\t\tfield_formulas.push f.formula\n\n\t\t_.some field_formulas, (field_formula)->\n\t\t\treturn InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\n\n\tgetOpinionFieldStepsName: (field_formula, top_keywords)->\n\n\t\topinionFields = new Array();\n#\t\tconsole.log(\"field_formula\", field_formula)\n\t\tif InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)\n\t\t\tif field_formula\n\n#\t\t\t\tfoo1 = field_formula.split(\",\")\n\t\t\t\tfoo1 = field_formula.split(\";\")\n\n#\t\t\t\tif top_keywords\n#\t\t\t\t\tfoo1 = field_formula.split(\";\")\n\n\t\t\t\tfoo1.forEach (foo)->\n\t\t\t\t\tjson_formula = {}\n\n\t\t\t\t\ttry\n\t\t\t\t\t\tjson_formula = eval(\"(\" + foo + \")\")\n\t\t\t\t\tcatch\n\t\t\t\t\t\tjson_formula = {}\n\n\t\t\t\t\tif json_formula?.yijianlan\n\t\t\t\t\t\tsf = {}\n\n\t\t\t\t\t\tsf.stepName = json_formula.yijianlan.step\n\n\t\t\t\t\t\tsf.image_sign = json_formula.yijianlan.image_sign || false\n\n\t\t\t\t\t\tsf.only_cc_opinion = json_formula.yijianlan.only_cc || false\n\n\t\t\t\t\t\tsf.default_description = json_formula.yijianlan.default\n\n\t\t\t\t\t\tsf.only_handler = json_formula.yijianlan.only_handler\n\n\t\t\t\t\t\tsf.top_keywords = json_formula.yijianlan.top_keywords || top_keywords\n\n\t\t\t\t\t\topinionFields.push(sf);\n\n\t\t\t\t\telse if(field_formula?.indexOf(\"{traces.\") > -1 || field_formula?.indexOf(\"{signature.traces.\") > -1)\n\n\t\t\t\t\t\tsf = {only_cc_opinion: false, image_sign: false, top_keywords: top_keywords}\n\n\t\t\t\t\t\tif foo.indexOf(\"{signature.\") > -1\n\t\t\t\t\t\t\tsf.image_sign = true\n\t\t\t\t\t\t\tfoo = foo.replace(\"{signature.\",\"\");\n\n\t\t\t\t\t\ts1 = foo.replace(\"{\",\"\").replace(\"}\",\"\")\n\t\t\t\t\t\tif s1.split(\".\").length > 1\n\t\t\t\t\t\t\tsf.stepName = s1.split(\".\")[1]\n\t\t\t\t\t\t\tif opinionFields.filterProperty(\"stepName\",sf.stepName).length > 0\n\t\t\t\t\t\t\t\topinionFields.findPropertyByPK(\"stepName\", sf.stepName)?.only_cc_opinion = true\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tif s1.split(\".\").length > 2\n\t\t\t\t\t\t\t\t\tif s1.split(\".\")[2]?.toLocaleLowerCase() == 'cc'\n\t\t\t\t\t\t\t\t\t\tsf.only_cc_opinion = true\n\t\t\t\t\t\topinionFields.push(sf);\n\n\t\treturn opinionFields\n\n\tshowCCOpinion: (field)->\n\t\tif field.formula?.indexOf(\"{traces.\") > -1 || field.formula?.indexOf(\"{signature.traces.\") > -1\n\t\t\ts1 = field.formula.replace(\"{signature.\",\"\").replace(\"{\",\"\").replace(\"}\",\"\")\n\t\t\tif s1.split(\".\").length > 2\n\t\t\t\tif s1.split(\".\")[2]?.toLocaleLowerCase() == 'cc'\n\t\t\t\t\treturn true\n\t\treturn false\n\n\tmarkDownToHtml: (markDownString)->\n\t\tif markDownString\n\t\t\trenderer = new Markdown.Renderer();\n\t\t\trenderer.link = ( href, title, text ) ->\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer:renderer}))\n\n\tf_label: (that)->\n\t\treturn that.name || that.code\n\nif Meteor.isServer\n\tInstanceformTemplate.helpers.steedos_form = ->\n\t\treturn this.form_version\n\n\tInstanceformTemplate.helpers.isSection = (code)->\n\t\tform_version = this.form_version\n\t\treturn form_version.fields.findPropertyByPK(\"code\", code).type == 'section'\n\n\tInstanceformTemplate.helpers.doc_values = ->\n\t\tinstance = this.instance;\n\t\treturn instance.values;\n\n\tInstanceformTemplate.helpers.applicantContext = ->\n\t\tinstance = this.instance;\n\t\tdata = {\n\t\t\tname: 'ins_applicant',\n\t\t\tatts: {name: 'ins_applicant', id: 'ins_applicant', class: 'selectUser form-control ins_applicant'},\n\t\t\tvalue: instance.applicant_name\n\t\t}\n\n\tInstanceformTemplate.helpers.instance = ->\n\t\treturn this.instance\n\n\tInstanceformTemplate.helpers.fields = ->\n\t\tform_version = this.form_version\n\t\tif form_version\n\t\t\treturn new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n\n\tInstanceformTemplate.helpers.form_types = ->\n\t\treturn \"disabled\"\n\n\tTemplate.registerHelper \"afFieldLabelText\", (op)->\n\t\tform_version = Template.instance().view.template.steedosData.form_version\n\t\tInstanceReadOnlyTemplate.getLabel form_version.fields, op?.hash?.name\n\n\tInstanceformTemplate.helpers._t = (key)->\n\t\tlocale = this.locale\n\n\t\treturn TAPi18n.__(key, {}, locale)\n\n\tInstanceformTemplate.helpers.ins_attach_download_url = (_id, absolute)->\n\t\tif absolute\n\t\t\treturn Meteor.absoluteUrl(\"/api/files/instances/#{_id}?download=true\");\n\t\telse\n\t\t\treturn \"/api/files/instances/#{_id}?download=true\";\n\n\tInstanceformTemplate.helpers.options = (field)->\n\t\toptions = field?.options?.split(\"\\n\")\n\t\trev = []\n\t\toptions?.forEach (item)->\n\t\t\trev.push({label: item, value: item})\n\n\t\treturn rev\n\n\tInstanceformTemplate.helpers.getPermissions = (code)->\n\t\tif !Template.instance().view.template.steedosData.startStepEditableFields?.includes(code)\n\t\t\treturn \"readonly disabled\"\n\t\treturn \"\"\n\nInstanceformTemplate.events =\n\t'change .form-control,.checkbox input,.af-radio-group input,.af-checkbox-group input': (event)->\n\t\tInstanceManager.instanceformChangeEvent(event)\n\n\t'typeahead:change .form-control': (event) ->\n\t\tInstanceManager.instanceformChangeEvent(event)\n\n\t'click .cfTextarea a': (event)->\n\t\tevent.preventDefault();\n\t\tSteedos.openWindow(event.target.href);\n\n\nInstanceformTemplate.onCreated = ()->\n\tinstance = WorkflowManager.getInstance();\n\tif !instance\n\t\treturn;\n\n\ttemplate = TemplateManager.getTemplate(instance);\n\n\ttry\n\t\tcompiled = SpacebarsCompiler.compile(template, {isBody: true});\n\tcatch e\n\t\tconsole.log \"Instance Template Error\", e\n\t\tcompiled = SpacebarsCompiler.compile(\"\", {isBody: true});\n\n\n\trenderFunction = eval(compiled);\n\n\tinstanceView = new Blaze.View(\"custom_instance_template\", renderFunction);\n\n\tinstanceCustomTemplate = new Blaze.Template(instanceView.name, renderFunction);\n\n\tTemplate.instance_custom_template = instanceCustomTemplate\n\n\tTemplate.instance_custom_template.helpers InstanceformTemplate.helpers\n\n\n\n\nInstanceformTemplate.onRendered = ()->\n\t# t = this;\n\n\t#t.subscribe \"instance_data\", Session.get(\"instanceId\"), ->\n\t#    Tracker.afterFlush ->\n\tinstance = WorkflowManager.getInstance();\n\tif !instance\n\t\treturn;\n\n\t#$(\"#ins_applicant\").select2().val(instance.applicant).trigger('change');\n\t#$(\"#ins_applicant\").val(instance.applicant);\n\t$(\"input[name='ins_applicant']\")[0]?.dataset.values = instance.applicant;\n\t$(\"input[name='ins_applicant']\").val(instance.applicant_name)\n\n\n\tApproveManager.error = {nextSteps: '', nextStepUsers: ''};\n\n\t# instance from绑定事件\n\tif Session.get(\"box\") == 'inbox' || Session.get(\"box\") == 'draft'\n\t\tInstanceEvent.initEvents(instance.flow);\n\n\tif !ApproveManager.isReadOnly()\n\n\t\tcurrentApprove = InstanceManager.getCurrentApprove();\n\n\n\t\tinstanceNumberFields = $(\"[data-formula]\", $(\"#instanceform\"))\n\n\t\tinstanceNumberFields.each ()->\n\t\t\tschemaKey = this.dataset.schemaKey\n\t\t\telement = $(this)\n\t\t\tif !$(this).val() && schemaKey && Session.get(\"instanceId\")\n\t\t\t\tMeteor.call 'getInstanceValues', Session.get(\"instanceId\"), (error, result)->\n\t\t\t\t\tif error\n\t\t\t\t\t\ttoastr.error(error.reason)\n\n\t\t\t\t\tif !result[schemaKey]\n\t\t\t\t\t\tkey = element.data(\"formula\")?.replace(\"auto_number(\", \"\").replace(\")\", \"\")\n\n\t\t\t\t\t\tkey = key.replace(/\\\"/g, \"\").replace(/\\'/g, \"\")\n\n\t\t\t\t\t\tif key.indexOf(\"{\") > -1\n\t\t\t\t\t\t\tkey = key.replace(\"{\",\"\").replace(\"}\",\"\")\n\t\t\t\t\t\t\tkey = key.trim()\n\t\t\t\t\t\t\tkey = AutoForm.getFieldValue(key, 'instanceform')\n\t\t\t\t\t\tInstanceNumberRules.instanceNumberBuilder element, key\n\t\t\t\t\telse\n\t\t\t\t\t\telement?.val(result[schemaKey]).trigger(\"change\")\n\n\t\tjudge = currentApprove.judge\n\t\tcurrentStep = InstanceManager.getCurrentStep();\n\t\tform_version = WorkflowManager.getInstanceFormVersion();\n\n\t\tformula_fields = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", form_version.fields);\n\t\tForm_formula.run(\"\", \"\", formula_fields, AutoForm.getFormValues(\"instanceform\").insertDoc, form_version.fields);\n\t\t#在此处初始化session 中的 form_values 变量，用于触发下一步步骤计算\n\t\tSession.set(\"instance_form_values\", {instanceId: instance._id, values: AutoForm.getFormValues(\"instanceform\").insertDoc});\n\n\n\n","InstanceformTemplate.helpers = {\n  applicantContext: function() {\n    var data, steedos_instance;\n    steedos_instance = WorkflowManager.getInstance();\n    data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control ins_applicant'\n      },\n      value: steedos_instance.applicant_name\n    };\n    if (!steedos_instance || steedos_instance.state !== \"draft\") {\n      data.atts.disabled = true;\n    }\n    return data;\n  },\n  instanceId: function() {\n    return 'instanceform';\n  },\n  form_types: function() {\n    if (ApproveManager.isReadOnly()) {\n      return 'disabled';\n    } else {\n      return 'method';\n    }\n  },\n  steedos_form: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return form_version;\n    }\n  },\n  innersubformContext: function(obj) {\n    var doc_values;\n    doc_values = WorkflowManager_format.getAutoformSchemaValues();\n    obj[\"tableValues\"] = doc_values ? doc_values[obj.code] : [];\n    obj[\"formId\"] = \"instanceform\";\n    return obj;\n  },\n  instance: function() {\n    var steedos_instance;\n    Session.get(\"change_date\");\n    if (Session.get(\"instanceId\")) {\n      steedos_instance = WorkflowManager.getInstance();\n      return steedos_instance;\n    }\n  },\n  empty: function(val) {\n    if (val) {\n      return false;\n    } else {\n      return true;\n    }\n  },\n  unempty: function(val) {\n    if (val) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  equals: function(a, b) {\n    return a === b;\n  },\n  unequals: function(a, b) {\n    return !(a === b);\n  },\n  includes: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  include: function(a, b) {\n    return b.split(',').includes(a);\n  },\n  fields: function() {\n    var form_version;\n    form_version = WorkflowManager.getInstanceFormVersion();\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  },\n  formatDate: function(date, options) {\n    if (!date) {\n      return \"\";\n    }\n    if (options && typeof options === 'string') {\n      options = JSON.parse(options);\n    }\n    if (!options.format) {\n      options = {\n        format: \"YYYY-MM-DD HH:mm\"\n      };\n    }\n    return moment(date).format(options.format);\n  },\n  traces: function() {\n    var flow, instance, locale, ref, ref1, ref2, ref3, steedosData, steps, traces;\n    if (Meteor.isServer) {\n      steedosData = (ref = Template.instance()) != null ? (ref1 = ref.view) != null ? (ref2 = ref1.template) != null ? ref2.steedosData : void 0 : void 0 : void 0;\n      instance = steedosData != null ? steedosData.instance : void 0;\n      flow = InstanceReadOnlyTemplate.getFlowVersion(instance);\n      locale = steedosData != null ? steedosData.locale : void 0;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      instance = WorkflowManager.getInstance();\n      flow = WorkflowManager.getInstanceFlowVersion();\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    if (!instance || !flow) {\n      return {};\n    }\n    steps = flow.steps;\n    traces = {};\n    if ((ref3 = instance.traces) != null) {\n      ref3.forEach(function(trace) {\n        var approves, ref4, step;\n        step = steps.findPropertyByPK(\"_id\", trace.step);\n        approves = [];\n        if ((ref4 = trace.approves) != null) {\n          ref4.forEach(function(approve) {\n            var judge_name;\n            if (trace.is_finished === true) {\n              if (approve.judge === 'approved') {\n                judge_name = TAPi18n.__(\"Instance State approved\", {}, locale);\n              } else if (approve.judge === 'rejected') {\n                judge_name = TAPi18n.__(\"Instance State rejected\", {}, locale);\n              } else if (approve.judge === 'terminated') {\n                judge_name = TAPi18n.__(\"Instance State terminated\", {}, locale);\n              } else if (approve.judge === 'reassigned') {\n                judge_name = TAPi18n.__(\"Instance State reassigned\", {}, locale);\n              } else if (approve.judge === 'relocated') {\n                judge_name = TAPi18n.__(\"Instance State relocated\", {}, locale);\n              } else if (approve.judge === '') {\n                judge_name = \"\";\n              } else {\n                judge_name = \"\";\n              }\n            } else {\n              judge_name = TAPi18n.__(\"Instance State pending\", {}, locale);\n            }\n            return approves.push({\n              _id: approve._id,\n              handler: approve.user,\n              handler_name: approve.handler_name,\n              handler_organization_name: approve.handler_organization_name,\n              handler_organization_fullname: approve.handler_organization_fullname,\n              finish_date: approve.finish_date,\n              judge: approve.judge,\n              judge_name: judge_name,\n              description: approve.description,\n              is_finished: approve.is_finished,\n              type: approve.type,\n              opinion_fields_code: approve.opinion_fields_code,\n              sign_field_code: approve.sign_field_code,\n              is_read: approve.is_read,\n              sign_show: approve.sign_show\n            });\n          });\n        }\n        if (step) {\n          if (step.name in traces) {\n            return traces[step.name] = traces[step.name].concat(approves);\n          } else {\n            return traces[step.name] = approves;\n          }\n        }\n      });\n    }\n    return traces;\n  },\n  doc_values: function() {\n    return WorkflowManager_format.getAutoformSchemaValues();\n  },\n  instance_box_style: function() {\n    var box, ins, judge;\n    box = Session.get(\"box\");\n    if (box === \"inbox\" || box === \"draft\") {\n      judge = Session.get(\"judge\");\n      if (judge) {\n        if (judge === \"approved\") {\n          return \"box-success\";\n        } else if (judge === \"rejected\") {\n          return \"box-danger\";\n        }\n      }\n    }\n    ins = WorkflowManager.getInstance();\n    if (ins && ins.final_decision) {\n      if (ins.final_decision === \"approved\") {\n        return \"box-success\";\n      } else if (ins.final_decision === \"rejected\") {\n        return \"box-danger\";\n      }\n    }\n  },\n  table_fields: function(instance) {\n    var fields, form_version;\n    if (Meteor.isClient) {\n      form_version = WorkflowManager.getInstanceFormVersion();\n    } else {\n      form_version = WorkflowManager.getFormVersion(instance.form, instance.form_version);\n    }\n    if (form_version) {\n      fields = _.clone(form_version.fields);\n      fields.forEach(function(field, index) {\n        var after_field, before_field, pre_fields, pre_wide_fields, td_colspan, tr_end, tr_start;\n        field.tr_start = \"\";\n        field.tr_end = \"\";\n        td_colspan = 1;\n        if ((typeof CoreForm !== \"undefined\" && CoreForm !== null ? CoreForm.pageTitleFieldName : void 0) === field.code) {\n          field.is_wide = true;\n        }\n        if (field.formula && field.type !== 'odata') {\n          field.permission = \"readonly\";\n        }\n        if (Steedos.isMobile()) {\n          if (field.type === 'section' || field.type === 'table') {\n            field.td_colspan = 4;\n          } else {\n            field.td_colspan = 3;\n          }\n          if (index !== 0) {\n            field.tr_start = \"<tr>\";\n            return field.tr_end = \"</tr>\";\n          }\n        } else {\n          pre_fields = fields.slice(0, index);\n          pre_wide_fields = pre_fields.filterProperty(\"is_wide\", true);\n          tr_start = \"\";\n          tr_end = \"\";\n          before_field = null;\n          after_field = null;\n          if (index > 0) {\n            before_field = fields[index - 1];\n          }\n          if (index < fields.length - 1) {\n            after_field = fields[index + 1];\n          }\n          if (field.type === 'section' || field.type === 'table') {\n            td_colspan = 4;\n          } else if (field.is_wide) {\n            td_colspan = 3;\n          } else {\n            if (before_field && after_field && before_field.is_wide && after_field.is_wide) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 && after_field && after_field.is_wide) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 && after_field === null) {\n              field.is_wide = true;\n              td_colspan = 3;\n            }\n          }\n          field.td_colspan = td_colspan;\n          if (index === 0) {\n            tr_start = \"<tr>\";\n          } else {\n            if ((pre_fields.length + pre_wide_fields.length) % 2 === 0 || field.is_wide) {\n              if (field.type === 'table') {\n                tr_start = \"<tr class = \\\"tr-child-table\\\">\";\n              } else {\n                tr_start = \"<tr>\";\n              }\n            }\n          }\n          field.tr_start = tr_start;\n          if (index + 1 === fields.length || field.type === 'section' || field.type === 'table' || field.is_wide) {\n            tr_end = \"</tr>\";\n          }\n          if ((pre_fields.length + pre_wide_fields.length) % 2 !== 0) {\n            tr_end = \"</tr>\";\n          }\n          return field.tr_end = tr_end;\n        }\n      });\n      return fields;\n    }\n  },\n  sort_approve: function(approves, order) {\n    if (!approves) {\n      return [];\n    }\n    if (!approves instanceof Array) {\n      return [];\n    } else {\n      if (order === 'desc') {\n        approves.sort(function(p1, p2) {\n          var _p1, _p2;\n          _p1 = 0;\n          _p2 = 0;\n          if (p1.finish_date) {\n            _p1 = p1.finish_date.getTime();\n          }\n          if (p2.finish_date) {\n            _p2 = p2.finish_date.getTime();\n          }\n          return _p2 - _p1;\n        });\n      } else {\n        approves.sort(function(p1, p2) {\n          var _p1, _p2;\n          _p1 = 0;\n          _p2 = 0;\n          if (p1.finish_date) {\n            _p1 = p1.finish_date.getTime();\n          }\n          if (p2.finish_date) {\n            _p2 = p2.finish_date.getTime();\n          }\n          return _p1 - _p2;\n        });\n      }\n    }\n    return approves;\n  },\n  _t: function(key) {\n    return TAPi18n.__(key);\n  },\n  getField: function(code) {\n    var form_version;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    if (form_version) {\n      return form_version.fields.findPropertyByPK(\"code\", code);\n    }\n  },\n  getValue: function(code) {\n    var form_version, instance, locale, utcOffset, values;\n    instance = Template.instance().view.template.steedosData.instance;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    locale = Template.instance().view.template.steedosData.locale;\n    utcOffset = Template.instance().view.template.steedosData.utcOffset;\n    values = instance.values || {};\n    if (Meteor.isClient) {\n      values = WorkflowManager_format.getAutoformSchemaValues();\n    }\n    return InstanceReadOnlyTemplate.getValue(values[code], form_version.fields.findPropertyByPK(\"code\", code), locale, utcOffset);\n  },\n  getLabel: function(code) {\n    var form_version;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    return InstanceReadOnlyTemplate.getLabel(form_version.fields, code);\n  },\n  getCfClass: function(field) {\n    if ((field != null ? field.type : void 0) === \"input\" && (field != null ? field.is_textarea : void 0)) {\n      return \"cfTextarea\";\n    }\n  },\n  getTableThead: function(field) {\n    return SteedosTable.getThead(field, false);\n  },\n  getTableBody: function(field) {\n    var instance, tableValue, values;\n    if (Meteor.isServer) {\n      instance = Template.instance().view.template.steedosData.instance;\n      values = instance.values || {};\n    } else {\n      values = WorkflowManager_format.getAutoformSchemaValues();\n    }\n    tableValue = values[field.code];\n    return SteedosTable.getTbody(field.sfields.getProperty(\"code\"), field, tableValue, false);\n  },\n  showLabel: function(field) {\n    var templateData;\n    templateData = Template.instance().data;\n    if (templateData.label === false) {\n      return false;\n    }\n    return true;\n  },\n  isOpinionField: function(field) {\n    return InstanceformTemplate.helpers.isOpinionField_from_string(field.formula);\n  },\n  isOpinionField_from_string: function(field_formula) {\n    return InstanceSignText.isOpinionField_from_string(field_formula);\n  },\n  includesOpinionField: function(form, form_version) {\n    var field_formulas, fields, ref;\n    field_formulas = new Array();\n    fields = ((ref = db.form_versions.findOne({\n      _id: form_version,\n      form: form\n    })) != null ? ref.fields : void 0) || [];\n    fields.forEach(function(f) {\n      var ref1;\n      if (f.type === 'table') {\n        return console.log('ignore opinion field in table');\n      } else if (f.type === 'section') {\n        return f != null ? (ref1 = f.fields) != null ? ref1.forEach(function(f1) {\n          return field_formulas.push(f1.formula);\n        }) : void 0 : void 0;\n      } else {\n        return field_formulas.push(f.formula);\n      }\n    });\n    return _.some(field_formulas, function(field_formula) {\n      return InstanceformTemplate.helpers.isOpinionField_from_string(field_formula);\n    });\n  },\n  getOpinionFieldStepsName: function(field_formula, top_keywords) {\n    var foo1, opinionFields;\n    opinionFields = new Array();\n    if (InstanceformTemplate.helpers.isOpinionField_from_string(field_formula)) {\n      if (field_formula) {\n        foo1 = field_formula.split(\";\");\n        foo1.forEach(function(foo) {\n          var json_formula, ref, ref1, s1, sf;\n          json_formula = {};\n          try {\n            json_formula = eval(\"(\" + foo + \")\");\n          } catch (error1) {\n            json_formula = {};\n          }\n          if (json_formula != null ? json_formula.yijianlan : void 0) {\n            sf = {};\n            sf.stepName = json_formula.yijianlan.step;\n            sf.image_sign = json_formula.yijianlan.image_sign || false;\n            sf.only_cc_opinion = json_formula.yijianlan.only_cc || false;\n            sf.default_description = json_formula.yijianlan[\"default\"];\n            sf.only_handler = json_formula.yijianlan.only_handler;\n            sf.top_keywords = json_formula.yijianlan.top_keywords || top_keywords;\n            return opinionFields.push(sf);\n          } else if ((field_formula != null ? field_formula.indexOf(\"{traces.\") : void 0) > -1 || (field_formula != null ? field_formula.indexOf(\"{signature.traces.\") : void 0) > -1) {\n            sf = {\n              only_cc_opinion: false,\n              image_sign: false,\n              top_keywords: top_keywords\n            };\n            if (foo.indexOf(\"{signature.\") > -1) {\n              sf.image_sign = true;\n              foo = foo.replace(\"{signature.\", \"\");\n            }\n            s1 = foo.replace(\"{\", \"\").replace(\"}\", \"\");\n            if (s1.split(\".\").length > 1) {\n              sf.stepName = s1.split(\".\")[1];\n              if (opinionFields.filterProperty(\"stepName\", sf.stepName).length > 0) {\n                if ((ref = opinionFields.findPropertyByPK(\"stepName\", sf.stepName)) != null) {\n                  ref.only_cc_opinion = true;\n                }\n              } else {\n                if (s1.split(\".\").length > 2) {\n                  if (((ref1 = s1.split(\".\")[2]) != null ? ref1.toLocaleLowerCase() : void 0) === 'cc') {\n                    sf.only_cc_opinion = true;\n                  }\n                }\n              }\n            }\n            return opinionFields.push(sf);\n          }\n        });\n      }\n    }\n    return opinionFields;\n  },\n  showCCOpinion: function(field) {\n    var ref, ref1, ref2, s1;\n    if (((ref = field.formula) != null ? ref.indexOf(\"{traces.\") : void 0) > -1 || ((ref1 = field.formula) != null ? ref1.indexOf(\"{signature.traces.\") : void 0) > -1) {\n      s1 = field.formula.replace(\"{signature.\", \"\").replace(\"{\", \"\").replace(\"}\", \"\");\n      if (s1.split(\".\").length > 2) {\n        if (((ref2 = s1.split(\".\")[2]) != null ? ref2.toLocaleLowerCase() : void 0) === 'cc') {\n          return true;\n        }\n      }\n    }\n    return false;\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  f_label: function(that) {\n    return that.name || that.code;\n  }\n};\n\nif (Meteor.isServer) {\n  InstanceformTemplate.helpers.steedos_form = function() {\n    return this.form_version;\n  };\n  InstanceformTemplate.helpers.isSection = function(code) {\n    var form_version;\n    form_version = this.form_version;\n    return form_version.fields.findPropertyByPK(\"code\", code).type === 'section';\n  };\n  InstanceformTemplate.helpers.doc_values = function() {\n    var instance;\n    instance = this.instance;\n    return instance.values;\n  };\n  InstanceformTemplate.helpers.applicantContext = function() {\n    var data, instance;\n    instance = this.instance;\n    return data = {\n      name: 'ins_applicant',\n      atts: {\n        name: 'ins_applicant',\n        id: 'ins_applicant',\n        \"class\": 'selectUser form-control ins_applicant'\n      },\n      value: instance.applicant_name\n    };\n  };\n  InstanceformTemplate.helpers.instance = function() {\n    return this.instance;\n  };\n  InstanceformTemplate.helpers.fields = function() {\n    var form_version;\n    form_version = this.form_version;\n    if (form_version) {\n      return new SimpleSchema(WorkflowManager_format.getAutoformSchema(form_version));\n    }\n  };\n  InstanceformTemplate.helpers.form_types = function() {\n    return \"disabled\";\n  };\n  Template.registerHelper(\"afFieldLabelText\", function(op) {\n    var form_version, ref;\n    form_version = Template.instance().view.template.steedosData.form_version;\n    return InstanceReadOnlyTemplate.getLabel(form_version.fields, op != null ? (ref = op.hash) != null ? ref.name : void 0 : void 0);\n  });\n  InstanceformTemplate.helpers._t = function(key) {\n    var locale;\n    locale = this.locale;\n    return TAPi18n.__(key, {}, locale);\n  };\n  InstanceformTemplate.helpers.ins_attach_download_url = function(_id, absolute) {\n    if (absolute) {\n      return Meteor.absoluteUrl(\"/api/files/instances/\" + _id + \"?download=true\");\n    } else {\n      return \"/api/files/instances/\" + _id + \"?download=true\";\n    }\n  };\n  InstanceformTemplate.helpers.options = function(field) {\n    var options, ref, rev;\n    options = field != null ? (ref = field.options) != null ? ref.split(\"\\n\") : void 0 : void 0;\n    rev = [];\n    if (options != null) {\n      options.forEach(function(item) {\n        return rev.push({\n          label: item,\n          value: item\n        });\n      });\n    }\n    return rev;\n  };\n  InstanceformTemplate.helpers.getPermissions = function(code) {\n    var ref;\n    if (!((ref = Template.instance().view.template.steedosData.startStepEditableFields) != null ? ref.includes(code) : void 0)) {\n      return \"readonly disabled\";\n    }\n    return \"\";\n  };\n}\n\nInstanceformTemplate.events = {\n  'change .form-control,.checkbox input,.af-radio-group input,.af-checkbox-group input': function(event) {\n    return InstanceManager.instanceformChangeEvent(event);\n  },\n  'typeahead:change .form-control': function(event) {\n    return InstanceManager.instanceformChangeEvent(event);\n  },\n  'click .cfTextarea a': function(event) {\n    event.preventDefault();\n    return Steedos.openWindow(event.target.href);\n  }\n};\n\nInstanceformTemplate.onCreated = function() {\n  var compiled, e, instance, instanceCustomTemplate, instanceView, renderFunction, template;\n  instance = WorkflowManager.getInstance();\n  if (!instance) {\n    return;\n  }\n  template = TemplateManager.getTemplate(instance);\n  try {\n    compiled = SpacebarsCompiler.compile(template, {\n      isBody: true\n    });\n  } catch (error1) {\n    e = error1;\n    console.log(\"Instance Template Error\", e);\n    compiled = SpacebarsCompiler.compile(\"\", {\n      isBody: true\n    });\n  }\n  renderFunction = eval(compiled);\n  instanceView = new Blaze.View(\"custom_instance_template\", renderFunction);\n  instanceCustomTemplate = new Blaze.Template(instanceView.name, renderFunction);\n  Template.instance_custom_template = instanceCustomTemplate;\n  return Template.instance_custom_template.helpers(InstanceformTemplate.helpers);\n};\n\nInstanceformTemplate.onRendered = function() {\n  var currentApprove, currentStep, form_version, formula_fields, instance, instanceNumberFields, judge, ref;\n  instance = WorkflowManager.getInstance();\n  if (!instance) {\n    return;\n  }\n  if ((ref = $(\"input[name='ins_applicant']\")[0]) != null) {\n    ref.dataset.values = instance.applicant;\n  }\n  $(\"input[name='ins_applicant']\").val(instance.applicant_name);\n  ApproveManager.error = {\n    nextSteps: '',\n    nextStepUsers: ''\n  };\n  if (Session.get(\"box\") === 'inbox' || Session.get(\"box\") === 'draft') {\n    InstanceEvent.initEvents(instance.flow);\n  }\n  if (!ApproveManager.isReadOnly()) {\n    currentApprove = InstanceManager.getCurrentApprove();\n    instanceNumberFields = $(\"[data-formula]\", $(\"#instanceform\"));\n    instanceNumberFields.each(function() {\n      var element, schemaKey;\n      schemaKey = this.dataset.schemaKey;\n      element = $(this);\n      if (!$(this).val() && schemaKey && Session.get(\"instanceId\")) {\n        return Meteor.call('getInstanceValues', Session.get(\"instanceId\"), function(error, result) {\n          var key, ref1;\n          if (error) {\n            toastr.error(error.reason);\n          }\n          if (!result[schemaKey]) {\n            key = (ref1 = element.data(\"formula\")) != null ? ref1.replace(\"auto_number(\", \"\").replace(\")\", \"\") : void 0;\n            key = key.replace(/\\\"/g, \"\").replace(/\\'/g, \"\");\n            if (key.indexOf(\"{\") > -1) {\n              key = key.replace(\"{\", \"\").replace(\"}\", \"\");\n              key = key.trim();\n              key = AutoForm.getFieldValue(key, 'instanceform');\n            }\n            return InstanceNumberRules.instanceNumberBuilder(element, key);\n          } else {\n            return element != null ? element.val(result[schemaKey]).trigger(\"change\") : void 0;\n          }\n        });\n      }\n    });\n    judge = currentApprove.judge;\n    currentStep = InstanceManager.getCurrentStep();\n    form_version = WorkflowManager.getInstanceFormVersion();\n    formula_fields = Form_formula.getFormulaFieldVariable(\"Form_formula.field_values\", form_version.fields);\n    Form_formula.run(\"\", \"\", formula_fields, AutoForm.getFormValues(\"instanceform\").insertDoc, form_version.fields);\n    return Session.set(\"instance_form_values\", {\n      instanceId: instance._id,\n      values: AutoForm.getFormValues(\"instanceform\").insertDoc\n    });\n  }\n};\n","InstanceAttachmentTemplate.helpers = {\n\n\tshowMainTitle: function() {\n\t\treturn Template.instance().workflowMainAttachTitle.get();\n\t},\n\tenabled_add_main_attachment: function() {\n\t\tvar ins = WorkflowManager.getInstance();\n\t\tif (!ins)\n\t\t\treturn false\n\n\t\tif (Session && Session.get(\"instancePrint\"))\n\t\t\treturn false\n\n\t\tif (Session.get(\"box\") != \"draft\" && Session.get(\"box\") != \"inbox\") {\n\t\t\treturn false\n\t\t}\n\n\t\t// 已经结束的单子不能改附件\n\t\tif (ins.state == \"completed\") {\n\t\t\treturn false\n\t\t}\n\n\t\tvar current_step = InstanceManager.getCurrentStep();\n\n\t\tif (!current_step)\n\t\t\treturn false;\n\n\t\t// 分发的正文或者附件不显示转为pdf按钮\n\t\t// 如果有正文权限则为正文，否则分发为附件\n\t\t// 分发的附件不允许修改 删除 新增版本\n\t\tvar main_attach_count = cfs.instances.find({\n\t\t\t'metadata.instance': ins._id,\n\t\t\t'metadata.current': true,\n\t\t\t'metadata.main': true\n\t\t}).count();\n\n\t\tvar distribute_main_attach_count = 0;\n\n\t\tif (ins.distribute_from_instance) {\n\t\t\tvar start_step = InstanceManager.getStartStep();\n\t\t\tif (start_step.can_edit_main_attach) {\n\t\t\t\tvar distribute_main_attach_count = cfs.instances.find({\n\t\t\t\t\t'metadata.instance': ins.distribute_from_instance,\n\t\t\t\t\t'metadata.current': true,\n\t\t\t\t\t'metadata.main': true\n\t\t\t\t}).count();\n\t\t\t}\n\t\t}\n\n\t\tif (current_step.can_edit_main_attach == true && main_attach_count < 1 && distribute_main_attach_count < 1) {\n\t\t\treturn true\n\t\t}\n\n\t\t// 正文最多只能有一个\n\t\tif (main_attach_count >= 1 || distribute_main_attach_count >= 1) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// 开始节点并且设置了可以上传正文才显示上传正文的按钮\n\t\tvar current_step = InstanceManager.getCurrentStep();\n\t\tif (current_step && current_step.step_type == \"start\" && current_step.can_edit_main_attach == true)\n\t\t\treturn true\n\n\t\treturn false\n\t},\n\n\tenabled_edit_normal_attachment: function() {\n\t\tvar ins = WorkflowManager.getInstance();\n\t\tif (!ins)\n\t\t\treturn false\n\n\t\tif (Session && Session.get(\"instancePrint\"))\n\t\t\treturn false\n\n\t\tvar flow = WorkflowManager.getFlow(ins.flow);\n\t\tif (!flow)\n\t\t\treturn false\n\n\n\t\t// 分发后的 附件，不可以编辑/删除，也不让上传新的附件, 流程列表：添加属性 ‘被分发后是否允许上传附件’ #1837\n\t\tif (ins.distribute_from_instance && !flow.upload_after_being_distributed)\n\t\t\treturn false\n\n\t\tif (Session.get(\"box\") != \"draft\" && Session.get(\"box\") != \"inbox\") {\n\t\t\treturn false\n\t\t}\n\n\t\t// 已经结束的单子不能改附件\n\t\tif (ins.state == \"completed\") {\n\t\t\treturn false\n\t\t}\n\n\t\tif (InstanceManager.isCC(ins)) {\n\t\t\tvar step = InstanceManager.getCCStep();\n\t\t\tif (step && (step.can_edit_normal_attach == true || step.can_edit_normal_attach == undefined))\n\t\t\t\treturn true\n\t\t} else {\n\t\t\tvar current_step = InstanceManager.getCurrentStep();\n\t\t\tif (current_step && (current_step.can_edit_normal_attach == true || current_step.can_edit_normal_attach == undefined))\n\t\t\t\treturn true\n\t\t}\n\n\t\treturn false\n\t},\n\n\tmain_attachment: function() {\n\t\tvar ins = WorkflowManager.getInstance();\n\t\tif (!ins)\n\t\t\treturn false\n\n\t\tvar start_step = InstanceManager.getStartStep();\n\n\t\t// 如果是被分发的申请单并且有修改正文的权限，则优先显示原申请单文件\n\t\tvar main_attach = null;\n\t\tif (ins.distribute_from_instance && start_step.can_edit_main_attach == true) {\n\t\t\tmain_attach = cfs.instances.findOne({\n\t\t\t\t'metadata.instance': ins.distribute_from_instance,\n\t\t\t\t'metadata.current': true,\n\t\t\t\t'metadata.main': true\n\t\t\t});\n\t\t}\n\n\t\tif (!main_attach) {\n\t\t\tmain_attach = cfs.instances.findOne({\n\t\t\t\t'metadata.instance': ins._id,\n\t\t\t\t'metadata.current': true,\n\t\t\t\t'metadata.main': true\n\t\t\t});\n\t\t}\n\n\t\treturn main_attach;\n\t},\n\n\tnormal_attachments: function() {\n\t\tvar ins = WorkflowManager.getInstance();\n\t\tif (!ins)\n\t\t\treturn false\n\n\t\tvar selector = {\n\t\t\t'metadata.current': true,\n\t\t\t'metadata.main': {\n\t\t\t\t$ne: true\n\t\t\t},\n\t\t};\n\n\t\tvar atts = new Array();\n\n\t\tif (ins.distribute_from_instance) {\n\t\t\t// 如果是被分发的申请单，则显示原申请单文件, 如果选择了将原表单存储为附件也要显示, 同时也要显示新上传的附件\n\t\t\tvar dfis = _.clone(ins.distribute_from_instances) || [];\n\t\t\tdfis.push(ins._id);\n\t\t\tselector['metadata.instance'] = {\n\t\t\t\t$in: dfis\n\t\t\t};\n\n\n\t\t\tselector[\"$or\"] = [{\n\t\t\t\t\"metadata.instance\": ins._id\n\t\t\t}, {\n\t\t\t\t\"metadata.instance\": {\n\t\t\t\t\t$in: ins.distribute_from_instances\n\t\t\t\t},\n\t\t\t\t\"metadata.is_private\": {\n\t\t\t\t\t$ne: true\n\t\t\t\t}\n\t\t\t}]\n\n\t\t\t// 如果原申请单有正文但是分发后没有正文权限，则原申请单正文显示在附件栏\n\t\t\tvar start_step = InstanceManager.getStartStep();\n\t\t\tif (start_step && start_step.can_edit_main_attach != true) {\n\t\t\t\tvar distribute_main = cfs.instances.findOne({\n\t\t\t\t\t'metadata.instance': {\n\t\t\t\t\t\t$in: ins.distribute_from_instances\n\t\t\t\t\t},\n\t\t\t\t\t'metadata.current': true,\n\t\t\t\t\t'metadata.main': true,\n\t\t\t\t});\n\t\t\t\tif (distribute_main) {\n\t\t\t\t\tvar firstVersionMain = cfs.instances.findOne(distribute_main.metadata.parent);\n\t\t\t\t\tdistribute_main.attachmentUploadedAt = firstVersionMain ? firstVersionMain.uploadedAt : distribute_main.uploadedAt;\n\t\t\t\t\tatts.push(distribute_main);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tselector['metadata.instance'] = ins._id;\n\t\t}\n\n\t\tcfs.instances.find(selector).forEach(function(c) {\n\t\t\tvar firstVersion = cfs.instances.findOne(c.metadata.parent);\n\t\t\tc.attachmentUploadedAt = firstVersion ? firstVersion.uploadedAt : c.uploadedAt;\n\t\t\tatts.push(c);\n\t\t})\n\n\t\treturn _.sortBy(atts, 'attachmentUploadedAt');\n\t},\n\n\tshowAttachments: function() {\n\t\tvar ins = WorkflowManager.getInstance();\n\t\tif (!ins)\n\t\t\treturn false;\n\n\t\t// 如果是被分发的申请单，则显示原申请单文件 和分发后申请单文件\n\t\tvar instanceIds = _.clone(ins.distribute_from_instances) || [];\n\t\tinstanceIds.push(ins._id);\n\t\tvar attachments_count = cfs.instances.find({\n\t\t\t'metadata.instance': {\n\t\t\t\t$in: instanceIds\n\t\t\t},\n\t\t\t'metadata.current': true\n\t\t}).count();\n\n\t\tif (Session && Session.get(\"instancePrint\") && attachments_count < 1)\n\t\t\treturn false\n\n\t\tif (Session.get(\"box\") == \"draft\" || Session.get(\"box\") == \"inbox\" || attachments_count > 0)\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\t},\n\n\t_t: function(key) {\n\t\treturn TAPi18n.__(key)\n\t},\n\n\t_: function(key) {\n\t\tvar locale;\n\t\tif (Meteor.isClient) {\n\t\t\treturn TAPi18n.__(key);\n\t\t} else {\n\t\t\tlocale = Template.instance().view.template.steedosData.locale;\n\t\t\treturn TAPi18n.__(key, {}, locale);\n\t\t}\n\t},\n\n}\n\nif (Meteor.isServer) {\n\tInstanceAttachmentTemplate.helpers._t = function(key) {\n\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\treturn TAPi18n.__(key, {}, locale)\n\t}\n\tInstanceAttachmentTemplate.helpers.enabled_add_main_attachment = function() {\n\t\treturn false\n\t};\n\tInstanceAttachmentTemplate.helpers.enabled_edit_normal_attachment = function() {\n\t\treturn false\n\t};\n\n\tInstanceAttachmentTemplate.helpers.main_attachment = function() {\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\n\t\tvar instanceIds = _.compact([instance.distribute_from_instance, instance._id]);\n\t\tvar attachment = cfs.instances.findOne({\n\t\t\t'metadata.instance': {\n\t\t\t\t$in: instanceIds\n\t\t\t},\n\t\t\t'metadata.current': true,\n\t\t\t'metadata.main': true\n\t\t});\n\n\t\treturn attachment;\n\t};\n\n\tInstanceAttachmentTemplate.helpers.normal_attachments = function() {\n\t\tvar steedosData = Template.instance().view.template.steedosData\n\t\tvar instance = steedosData.instance;\n\t\tvar instanceIds = _.clone(instance.distribute_from_instances) || [];\n\t\tinstanceIds.push(instance._id);\n\t\tvar attachments = cfs.instances.find({\n\t\t\t'metadata.instance': {\n\t\t\t\t$in: instanceIds\n\t\t\t},\n\t\t\t'metadata.current': true,\n\t\t\t'metadata.main': {\n\t\t\t\t$ne: true\n\t\t\t},\n\t\t\t$or: [{\n\t\t\t\t'metadata.is_private': {\n\t\t\t\t\t$ne: true\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\t'metadata.is_private': true,\n\t\t\t\t\"metadata.owner\": steedosData.userId\n\t\t\t}]\n\t\t}).fetch();\n\n\t\treturn attachments;\n\t};\n\n\tInstanceAttachmentTemplate.helpers.showAttachments = function() {\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\n\t\tvar instanceIds = _.clone(instance.distribute_from_instances) || [];\n\t\tinstanceIds.push(instance._id);\n\n\t\tvar attachments = cfs.instances.find({\n\t\t\t'metadata.instance': {\n\t\t\t\t$in: instanceIds\n\t\t\t},\n\t\t\t'metadata.current': true\n\t\t}).fetch();\n\n\t\tif (attachments && attachments.length > 0) {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tInstanceAttachmentTemplate.helpers.showMainTitle = function() {\n\t\tvar instance = Template.instance().view.template.steedosData.instance;\n\t\tvar instanceIds = _.compact([instance.distribute_from_instance, instance._id]);\n\t\tvar main_attach_count = cfs.instances.find({\n\t\t\t'metadata.instance': {\n\t\t\t\t$in: instanceIds\n\t\t\t},\n\t\t\t'metadata.current': true,\n\t\t\t'metadata.main': true\n\t\t}).count();\n\n\t\treturn main_attach_count > 0\n\t}\n}\n","InstanceSignText.helpers =\n\tshow: (stepName)->\n\t\tif Meteor.isClient\n\t\t\tif Session.get('instancePrint')\n\t\t\t\treturn false\n\t\t\tif InstanceManager.isInbox()\n\t\t\t\tmyApprove = InstanceManager.getCurrentApprove()\n\t\t\t\tif myApprove\n\t\t\t\t\tinstance = WorkflowManager.getInstance();\n\t\t\t\t\tmyTrace = instance?.traces?.findPropertyByPK(\"_id\", myApprove.trace)\n\t\t\t\t\treturn myTrace?.name == stepName\n\t\treturn false\n\n\tdefaultDescription: ()->\n#\t\treturn Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\")\n\t\treturn Template.instance().data.default_description\n\n\ttraces: ()->\n\t\tInstanceformTemplate.helpers.traces()\n\n\ttrace: (stepName, only_cc_opinion, image_sign, top_keywords)->\n\t\tinstance = InstanceformTemplate.helpers.instance()\n\n\t\tis_completed = instance?.state == \"completed\"\n\n\t\tcompleted_date = if is_completed then _.last(instance.traces)?.finish_date?.getTime() else 0\n\n\t\tif is_completed && instance.finish_date\n\t\t\tcompleted_date = instance.finish_date?.getTime()\n\n\t\ttraces = InstanceformTemplate.helpers.traces()\n\n\t\tapproves = _.clone(traces[stepName])\n\n\t\tapprove_sort = (approves, top_keywords)->\n\n#对Approves排序， 按照提交时间排倒序，如果没有提交则显示在最上边\n\t\t\tapproves_sorted = _.sortBy approves, (approve)->\n\t\t\t\treturn -(approve.finish_date || new Date()).getTime()\n\n\t\t\t#通过关键字排序\n\t\t\tif top_keywords\n\t\t\t\ttop_approves = new Array()\n\n\t\t\t\ttop_keywords.split(\",\").forEach (key) ->\n\t\t\t\t\ttop_approves = _.union top_approves, _.filter(approves_sorted, (approve)->\n\t\t\t\t\t\treturn approve?.handler_name?.indexOf(key) > -1\n\t\t\t\t\t)\n\t\t\t\t# 对置顶意见按照处理事件排倒序\n\t\t\t\ttop_approves = _.sortBy top_approves, (top_approve)->\n\t\t\t\t\treturn -(top_approve.finish_date || new Date()).getTime()\n\n\t\t\t\tapproves_sorted = _.union top_approves, approves_sorted\n\t\t\treturn approves_sorted || []\n\n\t\tapproves = _.filter approves, (a)->\n\t\t\treturn a.type isnt \"forward\" and a.type isnt \"distribute\" and a.type isnt \"terminated\"\n\n\t\tif only_cc_opinion\n\t\t\tapproves = approves?.filterProperty(\"type\", \"cc\")\n\n\t\tapproves_sorted = approve_sort(approves, top_keywords)\n\n\t\tapprovesGroup = _.groupBy(approves, \"handler\");\n\n\t\thasNext = (approve, approvesGroup) ->\n\t\t\thandlerApproves = approvesGroup[approve.handler]\n\t\t\treturn _.indexOf(handlerApproves, approve) + 1 < handlerApproves.length\n\n\t\thaveDescriptionApprove = (approve, approvesGroup) ->\n\t\t\thandlerApproves = approvesGroup[approve.handler]\n\n\t\t\tdescriptionApproves = _.filter handlerApproves, (a)->\n\t\t\t\tif a.description\n\t\t\t\t\treturn true\n\t\t\t\treturn false\n\n\t\t\tif descriptionApproves.length == 0\n\t\t\t\treturn false\n\n\t\t\treturn true\n\n\n\t\tapproves_sorted.forEach (approve) ->\n#\t\t\t有输入意见 或 最新一条并且用户没有输入过意见\n#\t\t\tif !approve.is_finished || approve.description || (!hasNext(approve, approvesGroup) && !haveDescriptionApprove(approve, approvesGroup))\n#\t\t\tif !hasNext(approve, approvesGroup)\n\t\t\tif approve.sign_show != false && (approve.description || (!approve.description && !hasNext(approve, approvesGroup)) )\n\t\t\t\tif approve.judge isnt 'terminated'\n\t\t\t\t\tapprove._display = true\n\n\t\tapproves_sorted = _.filter approves_sorted, (a) ->\n\t\t\tif is_completed\n\t\t\t\treturn a._display == true && a.is_finished && a.finish_date?.getTime() <= completed_date\n\t\t\telse\n\t\t\t\treturn a._display == true\n\n\t\treturn approves_sorted\n\n\tinclude: (a, b) ->\n\t\treturn InstanceformTemplate.helpers.include(a, b)\n\n\tunempty: (val)->\n\t\treturn InstanceformTemplate.helpers.unempty(val)\n\n\tformatDate: (date, options)->\n\t\tif !options\n\t\t\toptions = {\"format\": \"YYYY-MM-DD\"}\n\n\t\treturn InstanceformTemplate.helpers.formatDate(date, options)\n\n\tisMyApprove: (approve, only_cc_opinion) ->\n\t\tif Meteor.isClient\n\t\t\tins = WorkflowManager.getInstance();\n\n\t\t\tcurrentApprove = InstanceManager.getCurrentApprove()\n\n\t\t\tif !approve?._id\n\t\t\t\tapprove = currentApprove\n\n\t\t\tif approve._id == currentApprove?._id && currentApprove?.type == 'cc' && Template.instance().data.name\n\t\t\t\tif _.indexOf(currentApprove?.opinion_fields_code, Template.instance().data.name) > -1\n\t\t\t\t\treturn true\n\t\t\t\telse\n\t\t\t\t\treturn false\n\n\t\t\tif !(currentApprove?.type == 'cc') && only_cc_opinion\n\t\t\t\treturn false\n\n\t\t\tif currentApprove && approve._id == currentApprove._id\n\t\t\t\treturn true\n\t\treturn false\n\n\tmyApproveDescription: (approveId)->\n\t\tif Meteor.isClient\n\t\t\tif Session.get(\"box\") == 'inbox'\n\t\t\t\tmyApprove = Template.instance()?.myApprove?.get()\n\t\t\t\tif myApprove && myApprove.id == approveId\n\t\t\t\t\tif !myApprove.sign_field_code || myApprove.sign_field_code == Template.instance()?.data?.name\n\t\t\t\t\t\tif !Session.get(\"instance_my_approve_description\")\n\t\t\t\t\t\t\treturn myApprove?.description || \"\"\n\t\t\t\t\t\treturn Session.get(\"instance_my_approve_description\")\n\n\tnow: ()->\n\t\treturn new Date();\n\n\tisReadOnly: ()->\n\t\tif Meteor.isClient\n\t\t\treturn ApproveManager.isReadOnly()\n\t\treturn false\n\n\tisOpinionOfField: (approve)->\n\t\tif approve.type == \"cc\" && Template.instance().data.name\n\t\t\tif Template.instance().data.name == approve.sign_field_code\n\t\t\t\treturn true\n\t\t\telse\n\t\t\t\treturn false\n\t\telse\n\t\t\treturn true;\n\n\tmarkDownToHtml: (markDownString)->\n\t\tif markDownString\n\t\t\trenderer = new Markdown.Renderer();\n\t\t\trenderer.link = (href, title, text) ->\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer: renderer}))\n\n\tsteps: (field_formula, step, only_cc_opinion, image_sign)->\n\t\tsteps = []\n\t\tif !step\n\t\t\tif !field_formula\n\t\t\t\tfield_formula = WorkflowManager.getInstanceFormVersion()?.fields?.findPropertyByPK(\"code\", this.name).formula\n\t\t\tsteps = InstanceformTemplate.helpers.getOpinionFieldStepsName(field_formula, Template.instance()?.data.top_keywords)\n\t\telse\n\t\t\tsteps = [{stepName: step, only_cc_opinion: only_cc_opinion, image_sign: image_sign}]\n\t\treturn steps\n\n\timageSignData: (handler) ->\n\t\treturn {user: handler}\n\n\tshowSignImage: (handler, image_sign) ->\n\t\tspaceUserSign = ImageSign.helpers.spaceUserSign(handler);\n\n\t\tif spaceUserSign?.sign && image_sign\n\t\t\treturn true\n\t\telse\n\t\t\treturn false\n\n\tgetLastSignApprove: ()->\n\t\tins = WorkflowManager.getInstance();\n\n\t\treturn _.last(TracesManager.getHandlerSignShowApproves ins, Meteor.userId())\n\n\n\tlastMyApproveDescription: ()->\n\t\ttraces = InstanceformTemplate.helpers.traces()\n\t\tcurrentStep = InstanceManager.getCurrentStep();\n\t\tapproves = _.clone(traces[currentStep.name])\n\n\t\tapproves = approves.filterProperty(\"handler\", Meteor.userId())\n\n\t\tif approves.length > 1\n\t\t\treturn approves[approves.length - 2]?.description\n\n\t\treturn \"\";\n\n\tshowApprove: (approve)->\n\t\tif !approve.sign_field_code || approve.sign_field_code == Template.instance()?.data?.name\n\t\t\tif approve?.is_read\n\t\t\t\tif approve.is_finished\n\t\t\t\t\treturn [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(approve.judge)\n\t\t\t\telse\n\t\t\t\t\treturn true;\n\t\treturn false;\n\n\tjudge_description: (judge)->\n\t\treturn t(judge + \"_description\")\n\n\tis_approved: (judge)->\n\t\treturn \"approved\" == judge\n\n\tis_rejected: (judge)->\n\t\treturn \"rejected\" == judge\n\n\tis_readed: (judge)->\n\t\treturn [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(judge)\n\n\taddClass: ()->\n\t\tname = Template.instance()?.data?.name\n\t\tsetTimeout () ->\n\t\t\ttry\n\t\t\t\telement = $(\".automatic.opinion-field-\" + name)\n\t\t\t\tif element.length > 0\n\t\t\t\t\tif element?.is(\"td\")\n\t\t\t\t\t\telement.addClass('field-editable')\n\t\t\t\t\telse\n\t\t\t\t\t\t$(\".instance-sign\", element).addClass('field-editable')\n\t\t\tcatch e\n\t\t\t\tconsole.log e\n\t\t, 1\n\t\treturn ''\n\nif Meteor.isServer\n\tInstanceSignText.helpers.defaultDescription = ->\n\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\treturn Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\", {}, locale)","InstanceSignText.helpers = {\n  show: function(stepName) {\n    var instance, myApprove, myTrace, ref;\n    if (Meteor.isClient) {\n      if (Session.get('instancePrint')) {\n        return false;\n      }\n      if (InstanceManager.isInbox()) {\n        myApprove = InstanceManager.getCurrentApprove();\n        if (myApprove) {\n          instance = WorkflowManager.getInstance();\n          myTrace = instance != null ? (ref = instance.traces) != null ? ref.findPropertyByPK(\"_id\", myApprove.trace) : void 0 : void 0;\n          return (myTrace != null ? myTrace.name : void 0) === stepName;\n        }\n      }\n    }\n    return false;\n  },\n  defaultDescription: function() {\n    return Template.instance().data.default_description;\n  },\n  traces: function() {\n    return InstanceformTemplate.helpers.traces();\n  },\n  trace: function(stepName, only_cc_opinion, image_sign, top_keywords) {\n    var approve_sort, approves, approvesGroup, approves_sorted, completed_date, hasNext, haveDescriptionApprove, instance, is_completed, ref, ref1, ref2, traces;\n    instance = InstanceformTemplate.helpers.instance();\n    is_completed = (instance != null ? instance.state : void 0) === \"completed\";\n    completed_date = is_completed ? (ref = _.last(instance.traces)) != null ? (ref1 = ref.finish_date) != null ? ref1.getTime() : void 0 : void 0 : 0;\n    if (is_completed && instance.finish_date) {\n      completed_date = (ref2 = instance.finish_date) != null ? ref2.getTime() : void 0;\n    }\n    traces = InstanceformTemplate.helpers.traces();\n    approves = _.clone(traces[stepName]);\n    approve_sort = function(approves, top_keywords) {\n      var approves_sorted, top_approves;\n      approves_sorted = _.sortBy(approves, function(approve) {\n        return -(approve.finish_date || new Date()).getTime();\n      });\n      if (top_keywords) {\n        top_approves = new Array();\n        top_keywords.split(\",\").forEach(function(key) {\n          return top_approves = _.union(top_approves, _.filter(approves_sorted, function(approve) {\n            var ref3;\n            return (approve != null ? (ref3 = approve.handler_name) != null ? ref3.indexOf(key) : void 0 : void 0) > -1;\n          }));\n        });\n        top_approves = _.sortBy(top_approves, function(top_approve) {\n          return -(top_approve.finish_date || new Date()).getTime();\n        });\n        approves_sorted = _.union(top_approves, approves_sorted);\n      }\n      return approves_sorted || [];\n    };\n    approves = _.filter(approves, function(a) {\n      return a.type !== \"forward\" && a.type !== \"distribute\" && a.type !== \"terminated\";\n    });\n    if (only_cc_opinion) {\n      approves = approves != null ? approves.filterProperty(\"type\", \"cc\") : void 0;\n    }\n    approves_sorted = approve_sort(approves, top_keywords);\n    approvesGroup = _.groupBy(approves, \"handler\");\n    hasNext = function(approve, approvesGroup) {\n      var handlerApproves;\n      handlerApproves = approvesGroup[approve.handler];\n      return _.indexOf(handlerApproves, approve) + 1 < handlerApproves.length;\n    };\n    haveDescriptionApprove = function(approve, approvesGroup) {\n      var descriptionApproves, handlerApproves;\n      handlerApproves = approvesGroup[approve.handler];\n      descriptionApproves = _.filter(handlerApproves, function(a) {\n        if (a.description) {\n          return true;\n        }\n        return false;\n      });\n      if (descriptionApproves.length === 0) {\n        return false;\n      }\n      return true;\n    };\n    approves_sorted.forEach(function(approve) {\n      if (approve.sign_show !== false && (approve.description || (!approve.description && !hasNext(approve, approvesGroup)))) {\n        if (approve.judge !== 'terminated') {\n          return approve._display = true;\n        }\n      }\n    });\n    approves_sorted = _.filter(approves_sorted, function(a) {\n      var ref3;\n      if (is_completed) {\n        return a._display === true && a.is_finished && ((ref3 = a.finish_date) != null ? ref3.getTime() : void 0) <= completed_date;\n      } else {\n        return a._display === true;\n      }\n    });\n    return approves_sorted;\n  },\n  include: function(a, b) {\n    return InstanceformTemplate.helpers.include(a, b);\n  },\n  unempty: function(val) {\n    return InstanceformTemplate.helpers.unempty(val);\n  },\n  formatDate: function(date, options) {\n    if (!options) {\n      options = {\n        \"format\": \"YYYY-MM-DD\"\n      };\n    }\n    return InstanceformTemplate.helpers.formatDate(date, options);\n  },\n  isMyApprove: function(approve, only_cc_opinion) {\n    var currentApprove, ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n      currentApprove = InstanceManager.getCurrentApprove();\n      if (!(approve != null ? approve._id : void 0)) {\n        approve = currentApprove;\n      }\n      if (approve._id === (currentApprove != null ? currentApprove._id : void 0) && (currentApprove != null ? currentApprove.type : void 0) === 'cc' && Template.instance().data.name) {\n        if (_.indexOf(currentApprove != null ? currentApprove.opinion_fields_code : void 0, Template.instance().data.name) > -1) {\n          return true;\n        } else {\n          return false;\n        }\n      }\n      if (!((currentApprove != null ? currentApprove.type : void 0) === 'cc') && only_cc_opinion) {\n        return false;\n      }\n      if (currentApprove && approve._id === currentApprove._id) {\n        return true;\n      }\n    }\n    return false;\n  },\n  myApproveDescription: function(approveId) {\n    var myApprove, ref, ref1, ref2, ref3;\n    if (Meteor.isClient) {\n      if (Session.get(\"box\") === 'inbox') {\n        myApprove = (ref = Template.instance()) != null ? (ref1 = ref.myApprove) != null ? ref1.get() : void 0 : void 0;\n        if (myApprove && myApprove.id === approveId) {\n          if (!myApprove.sign_field_code || myApprove.sign_field_code === ((ref2 = Template.instance()) != null ? (ref3 = ref2.data) != null ? ref3.name : void 0 : void 0)) {\n            if (!Session.get(\"instance_my_approve_description\")) {\n              return (myApprove != null ? myApprove.description : void 0) || \"\";\n            }\n            return Session.get(\"instance_my_approve_description\");\n          }\n        }\n      }\n    }\n  },\n  now: function() {\n    return new Date();\n  },\n  isReadOnly: function() {\n    if (Meteor.isClient) {\n      return ApproveManager.isReadOnly();\n    }\n    return false;\n  },\n  isOpinionOfField: function(approve) {\n    if (approve.type === \"cc\" && Template.instance().data.name) {\n      if (Template.instance().data.name === approve.sign_field_code) {\n        return true;\n      } else {\n        return false;\n      }\n    } else {\n      return true;\n    }\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  steps: function(field_formula, step, only_cc_opinion, image_sign) {\n    var ref, ref1, ref2, steps;\n    steps = [];\n    if (!step) {\n      if (!field_formula) {\n        field_formula = (ref = WorkflowManager.getInstanceFormVersion()) != null ? (ref1 = ref.fields) != null ? ref1.findPropertyByPK(\"code\", this.name).formula : void 0 : void 0;\n      }\n      steps = InstanceformTemplate.helpers.getOpinionFieldStepsName(field_formula, (ref2 = Template.instance()) != null ? ref2.data.top_keywords : void 0);\n    } else {\n      steps = [\n        {\n          stepName: step,\n          only_cc_opinion: only_cc_opinion,\n          image_sign: image_sign\n        }\n      ];\n    }\n    return steps;\n  },\n  imageSignData: function(handler) {\n    return {\n      user: handler\n    };\n  },\n  showSignImage: function(handler, image_sign) {\n    var spaceUserSign;\n    spaceUserSign = ImageSign.helpers.spaceUserSign(handler);\n    if ((spaceUserSign != null ? spaceUserSign.sign : void 0) && image_sign) {\n      return true;\n    } else {\n      return false;\n    }\n  },\n  getLastSignApprove: function() {\n    var ins;\n    ins = WorkflowManager.getInstance();\n    return _.last(TracesManager.getHandlerSignShowApproves(ins, Meteor.userId()));\n  },\n  lastMyApproveDescription: function() {\n    var approves, currentStep, ref, traces;\n    traces = InstanceformTemplate.helpers.traces();\n    currentStep = InstanceManager.getCurrentStep();\n    approves = _.clone(traces[currentStep.name]);\n    approves = approves.filterProperty(\"handler\", Meteor.userId());\n    if (approves.length > 1) {\n      return (ref = approves[approves.length - 2]) != null ? ref.description : void 0;\n    }\n    return \"\";\n  },\n  showApprove: function(approve) {\n    var ref, ref1;\n    if (!approve.sign_field_code || approve.sign_field_code === ((ref = Template.instance()) != null ? (ref1 = ref.data) != null ? ref1.name : void 0 : void 0)) {\n      if (approve != null ? approve.is_read : void 0) {\n        if (approve.is_finished) {\n          return [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(approve.judge);\n        } else {\n          return true;\n        }\n      }\n    }\n    return false;\n  },\n  judge_description: function(judge) {\n    return t(judge + \"_description\");\n  },\n  is_approved: function(judge) {\n    return \"approved\" === judge;\n  },\n  is_rejected: function(judge) {\n    return \"rejected\" === judge;\n  },\n  is_readed: function(judge) {\n    return [\"approved\", \"rejected\", \"submitted\", \"readed\"].includes(judge);\n  },\n  addClass: function() {\n    var name, ref, ref1;\n    name = (ref = Template.instance()) != null ? (ref1 = ref.data) != null ? ref1.name : void 0 : void 0;\n    setTimeout(function() {\n      var e, element;\n      try {\n        element = $(\".automatic.opinion-field-\" + name);\n        if (element.length > 0) {\n          if (element != null ? element.is(\"td\") : void 0) {\n            return element.addClass('field-editable');\n          } else {\n            return $(\".instance-sign\", element).addClass('field-editable');\n          }\n        }\n      } catch (error) {\n        e = error;\n        return console.log(e);\n      }\n    }, 1);\n    return '';\n  }\n};\n\nif (Meteor.isServer) {\n  InstanceSignText.helpers.defaultDescription = function() {\n    var locale;\n    locale = Template.instance().view.template.steedosData.locale;\n    return Template.instance().data.default_description || TAPi18n.__(\"instance_default_opinion\", {}, locale);\n  };\n}\n","TracesTemplate.helpers =\n\tequals: (a, b) ->\n\t\ta == b\n\tempty: (a) ->\n\t\tif a\n\t\t\ta.toString().trim().length < 1\n\t\telse\n\t\t\ttrue\n\tunempty: (a) ->\n\t\tif a\n\t\t\ta.toString().trim().length > 0\n\t\telse\n\t\t\tfalse\n\n\tappend: (a, b) ->\n\t\ta + b\n\n\tdateFormat: (date) ->\n\t\t\tif Steedos.isMobile() && date?.getFullYear() == (new Date).getFullYear()\n\t\t\t\treturn $.format.date new Date(date), \"MM-dd HH:mm\"\n\t\t\telse\n\t\t\t\treturn $.format.date new Date(date), \"yyyy-MM-dd HH:mm\"\n\n\tgetStepName: (stepId) ->\n\t\tstep = WorkflowManager.getInstanceStep(stepId)\n\t\tif step\n\t\t\treturn step.name\n\t\tnull\n\tshowDeleteButton: (approved) ->\n\t\tif approved and approved.type == 'cc' and approved.from_user == Meteor.userId() and approved.is_finished != true and !Session.get(\"instancePrint\")\n\t\t\treturn true\n\t\tfalse\n\tisShowModificationButton: (approved) ->\n\t\tapprove_admins = Meteor.settings?.public?.workflow?.approve_admins\n\t\tif approve_admins?.length\n\t\t\tisShow = approve_admins?.contains Meteor.userId()\n\t\tunless isShow\n\t\t\treturn false\n\t\treturn approved.handler == Meteor.userId()\n\tisEditing: () ->\n\t\t return Template.instance().is_editing?.get()\n\tisShowDescription: (approved)->\n\t\t# debugger\n\t\tif TracesTemplate.helpers.isShowModificationButton approved\n\t\t\treturn true\n\t\treturn approved.description?.toString().trim().length > 0\n\tisCC: (approved) ->\n\t\tif approved and approved.type == 'cc'\n\t\t\treturn true\n\t\tfalse\n\tgetApproveStatusIcon: (approveJudge) ->\n\t\t#已结束的显示为核准/驳回/取消申请，并显示处理状态图标\n\t\tapproveStatusIcon = undefined\n\t\tswitch approveJudge\n\t\t\twhen 'approved'\n\t\t\t\t# 已核准\n\t\t\t\tapproveStatusIcon = 'ion ion-checkmark-round'\n\t\t\twhen 'rejected'\n\t\t\t\t# 已驳回\n\t\t\t\tapproveStatusIcon = 'ion ion-close-round'\n\t\t\twhen 'terminated'\n\t\t\t\t# 已取消\n\t\t\t\tapproveStatusIcon = 'fa fa-ban'\n\t\t\twhen 'reassigned'\n\t\t\t\t# 转签核\n\t\t\t\tapproveStatusIcon = 'ion ion-android-contact'\n\t\t\twhen 'relocated'\n\t\t\t\t# 重定位\n\t\t\t\tapproveStatusIcon = 'ion ion-arrow-shrink'\n\t\t\twhen 'retrieved'\n\t\t\t\t# 已取回\n\t\t\t\tapproveStatusIcon = 'fa fa-undo'\n\t\t\telse\n\t\t\t\tapproveStatusIcon = ''\n\t\t\t\tbreak\n\t\tapproveStatusIcon\n\tgetApproveStatusText: (approveJudge) ->\n\t\tif Meteor.isServer\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\n\t\t\t\tlocale = \"zh-CN\"\n\t\telse\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\n\t\t#已结束的显示为核准/驳回/取消申请，并显示处理状态图标\n\t\tapproveStatusText = undefined\n\t\tswitch approveJudge\n\t\t\twhen 'approved'\n\t\t\t\t# 已核准\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State approved', {}, locale)\n\t\t\twhen 'rejected'\n\t\t\t\t# 已驳回\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State rejected', {}, locale)\n\t\t\twhen 'terminated'\n\t\t\t\t# 已取消\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State terminated', {}, locale)\n\t\t\twhen 'reassigned'\n\t\t\t\t# 转签核\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State reassigned', {}, locale)\n\t\t\twhen 'relocated'\n\t\t\t\t# 重定位\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State relocated', {}, locale)\n\t\t\twhen 'retrieved'\n\t\t\t\t# 已取回\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State retrieved', {}, locale)\n\t\t\twhen 'returned'\n\t\t\t\t# 已退回\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State returned', {}, locale)\n\t\t\twhen 'readed'\n\t\t\t\t# 已阅\n\t\t\t\tapproveStatusText = TAPi18n.__('Instance State readed', {}, locale)\n\t\t\telse\n\t\t\t\tapproveStatusText = ''\n\t\t\t\tbreak\n\t\tapproveStatusText\n\t_t: (key)->\n\t\treturn TAPi18n.__(key)\n\n\tmyApproveDescription: (approveId)->\n\t\tif Meteor.isClient\n\t\t\tif Session.get(\"box\") == 'inbox'\n\t\t\t\tmyApprove = Template.instance()?.myApprove?.get()\n\t\t\t\tif myApprove && myApprove.id == approveId\n\t\t\t\t\tif !Session.get(\"instance_my_approve_description\")\n\t\t\t\t\t\treturn myApprove?.description || \"\"\n\t\t\t\t\treturn Session.get(\"instance_my_approve_description\")\n\tisForward: (approved) ->\n\t\tif approved and approved.type == 'forward'\n\t\t\treturn true\n\t\tfalse\n\tshowForwardDeleteButton: (approve) ->\n\t\tif db.instances.find(approve.forward_instance).count() is 0\n\t\t\treturn false\n\t\tif approve and approve.type == 'forward' and approve.from_user == Meteor.userId() and !Session.get(\"instancePrint\") and approve.judge isnt 'terminated'\n\t\t\treturn true\n\t\tfalse\n\tmarkDownToHtml: (markDownString)->\n\t\tif markDownString\n\t\t\trenderer = new Markdown.Renderer();\n\t\t\trenderer.link = ( href, title, text ) ->\n\t\t\t\treturn \"<a target='_blank' href='#{href}' title='#{title}'>#{text}</a>\"\n\t\t\treturn Spacebars.SafeString(Markdown(markDownString, {renderer:renderer}))\n\tisDistribute: (approve) ->\n\t\tif approve and approve.type == 'distribute'\n\t\t\treturn true\n\t\tfalse\n\tshowDistributeDeleteButton: (approve) ->\n\t\tif db.instances.find(approve.forward_instance).count() is 0\n\t\t\treturn false\n\n\t\tif approve and approve.type == 'distribute' and !Session.get(\"instancePrint\") and approve.judge isnt 'terminated' and Steedos.isLegalVersion('',\"workflow.enterprise\")\n\t\t\t# 流程管理员和系统管理员，可以执行任何情况下的文件取消分发\n\t\t\tins = db.instances.findOne({_id: approve.instance}, {fields: {flow: 1, space: 1}})\n\t\t\tif ins and ins.flow and ins.space\n\t\t\t\tif WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, Meteor.userId())\n\t\t\t\t\treturn true\n\n\t\t\tif approve.from_user == Meteor.userId()\n\t\t\t\treturn true\n\n\t\tfalse\n\n\tfinishDateSchema: () ->\n\t\tif Steedos.isAndroidOrIOS()\n\t\t\treturn new SimpleSchema({\n\t\t\t\tfinish_date: {\n\t\t\t\t\tautoform: {\n\t\t\t\t\t\ttype: \"datetime-local\"\n\t\t\t\t\t},\n\t\t\t\t\toptional: false,\n\t\t\t\t\ttype: Date\n\t\t\t\t}\n\t\t\t})\n\t\telse\n\t\t\treturn new SimpleSchema({\n\t\t\t\tfinish_date: {\n\t\t\t\t\tautoform: {\n\t\t\t\t\t\ttype: \"bootstrap-datetimepicker\"\n\t\t\t\t\t\treadonly: true\n\t\t\t\t\t\tdateTimePickerOptions:{\n\t\t\t\t\t\t\tformat: \"YYYY-MM-DD HH:mm\",\n\t\t\t\t\t\t\tignoreReadonly:true,\n\t\t\t\t\t\t\tlocale: Session.get(\"TAPi18n::loaded_lang\"),\n\t\t\t\t\t\t\twidgetPositioning:{\n\t\t\t\t\t\t\t\thorizontal: 'right'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\toptional: false,\n\t\t\t\t\ttype: Date\n\t\t\t\t}\n\t\t\t})\n\n\tfinishDateValues: () ->\n\t\treturn {\n\t\t\tfinish_date:this.finish_date\n\t\t};\n\n\t###\n    \t此函数用于控制是否显示traces view\n    \ttrue: 显示traces view,签核历程按钮点击后是直接定位到traces view\n    \tfalse: 不显示traces view，签核历程按钮点击后,以Modal 方式显示traces view\n\t###\n\tshowTracesView: (form, form_version)->\n#\t\treturn !(InstanceManager.isTableStyle(form) && InstanceformTemplate.helpers.includesOpinionField(form, form_version))\n\n\t\tshow_modal_traces_list = db.space_settings.findOne({space: Session.get(\"spaceId\"), key: \"show_modal_traces_list\"})?.values || false\n\n\t\treturn !show_modal_traces_list\n\n\tgetInstanceStateText: (instance_id)->\n\t\tif Meteor.isServer\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\n\t\t\t\tlocale = \"zh-CN\"\n\t\telse\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\n\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {state: 1, is_read: 1}})\n\t\tif not ins\n\t\t\treturn TAPi18n.__('instance_deleted', {}, locale)\n\n\t\ttext = ''\n\t\tif ins.state is 'completed'\n\t\t\ttext = TAPi18n.__('completed', {}, locale)\n\t\telse if ins.state is 'pending'\n\t\t\ttext = TAPi18n.__('pending', {}, locale)\n\t\telse if ins.state is 'draft'\n\t\t\tif ins.is_read\n\t\t\t\ttext = TAPi18n.__('instance_approve_read', {}, locale)\n\t\t\telse\n\t\t\t\ttext = TAPi18n.__('instance_approve_not_yet_handled', {}, locale)\n\n\t\treturn text\n\n\tgetInstanceStateColor: (instance_id)->\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {state: 1, is_read: 1}})\n\t\tif not ins\n\t\t\treturn \"\"\n\n\t\tcla = ''\n\t\tif ins.state is 'draft'\n\t\t\tif ins.is_read\n\t\t\t\tcla = 'blue'\n\t\t\telse\n\t\t\t\tcla = 'red'\n\t\treturn cla\n\n\tfirstTrace: (index)->\n\t\treturn index is 0\n\n\tlast_distribute_from: (instance_id)->\n\t\tins = db.instances.findOne({_id: instance_id, distribute_from_instance: {$exists: true}},{fields:{created: 1, created_by: 1}})\n\t\tif ins\n\t\t\tdis_info = {}\n\t\t\tuser = {}\n\t\t\tif Meteor.isClient\n\t\t\t\tuser = UUflow_api.getNameForUser(ins.created_by)\n\t\t\telse if Meteor.isServer\n\t\t\t\tuser = db.users.findOne({_id: ins.created_by}, {fields: {name: 1}})\n\n\t\t\tif user.name\n\t\t\t\tdis_info.from_user_name = user.name\n\t\t\t\tdis_info.created = ins.created\n\n\t\t\tif not _.isEmpty(dis_info)\n\t\t\t\treturn dis_info\n\t\treturn\n\n\tisCCOrDistributeOrForwardTerminated: (approve)->\n\t\tif (approve.type is 'cc' or approve.type is 'distribute' or approve.type is 'forward') and approve.judge is 'terminated'\n\t\t\treturn true\n\t\treturn false\n\n\tjudgeTerminated: (judge)->\n\t\treturn judge is 'terminated'\n\n\tinstanceExists: (instance_id)->\n\t\treturn !!db.instances.find(instance_id).count()\n\n\tagentDescription: (userName)->\n\t\tif Meteor.isServer\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\t\tif locale.toLocaleLowerCase() == 'zh-cn'\n\t\t\t\tlocale = \"zh-CN\"\n\t\telse\n\t\t\tlocale = Session.get(\"TAPi18n::loaded_lang\")\n\n\t\treturn TAPi18n.__('process_delegation_rules_description', {userName: userName}, locale)\n\ttraceName: (instance_id, traceId)->\n\t\treturn _.find(db.instances.findOne(instance_id, {fields: {traces: 1}})?.traces, (trace)->\n\t\t\t\t\treturn trace._id ==  traceId\n\t\t)?.name\nif Meteor.isServer\n\tTracesTemplate.helpers.dateFormat = (date)->\n\t\tif date\n\t\t\tutcOffset = Template.instance().view.template.steedosData.utcOffset\n\t\t\treturn InstanceReadOnlyTemplate.formatDate(date, utcOffset);\n\n\tTracesTemplate.helpers._t = (key)->\n\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\treturn TAPi18n.__(key, {}, locale)\n\n\tTracesTemplate.helpers.showDeleteButton = (approved) ->\n\t\treturn false;\n\nTracesTemplate.events =\n\t'click .cc-approve-remove': (event, template) ->\n\t\tevent.stopPropagation()\n\t\tif event.currentTarget.dataset.calling * 1 != 1\n\t\t\tevent.currentTarget.dataset.calling = 1\n\t\t\t$(\"i\",event.currentTarget).addClass(\"fa-spin\")\n\t\t\tinstanceId = Session.get('instanceId')\n\t\t\tapproveId = event.target.dataset.approve\n\t\t\t# CALL 删除approve函数。\n\t\t\t$(\"body\").addClass(\"loading\")\n\t\t\tMeteor.call 'cc_remove', instanceId, approveId, (err, result) ->\n\t\t\t\t$(\"body\").removeClass(\"loading\")\n\t\t\t\tif err\n\t\t\t\t\ttoastr.error err\n\t\t\t\t\tevent.currentTarget.dataset.calling = 0\n\t\t\t\t\t$(\"i\",event.currentTarget).removeClass(\"fa-spin\")\n\t\t\t\tif result == true\n\t\t\t\t\ttoastr.success(TAPi18n.__(\"remove_cc_approve\"));\n\t\t\t\t\tif $(\".instance-trace-detail-modal\").length\n\t\t\t\t\t\tModal.hide \"instance_trace_detail_modal\"\n\t\t\t\treturn\n\t\t\treturn\n\n\t'click .instance-trace-detail-modal .btn-cc-approve-remove': (event, template) ->\n\t\tinstanceId = Session.get('instanceId')\n\t\tapproveId = event.target.dataset.approve\n\t\t# CALL 删除approve函数。\n\t\t$(\"body\").addClass(\"loading\")\n\t\tMeteor.call 'cc_remove', instanceId, approveId, (err, result) ->\n\t\t\t$(\"body\").removeClass(\"loading\")\n\t\t\tif err\n\t\t\t\ttoastr.error err\n\t\t\tif result == true\n\t\t\t\ttoastr.success(TAPi18n.__(\"remove_cc_approve\"));\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\n\t\t\treturn\n\t\treturn\n\n\t'click .approve-item,.approve-description': (event, template) ->\n\t\tModal.show \"instance_trace_detail_modal\", this\n\n\t'taphold .approve-item,.approve-description': (event, template) ->\n\t\tModal.show \"instance_trace_detail_modal\", this\n\n\t'tapend .approve-item,.approve-description': (event, template) ->\n\t\t# 上述长按打开approve详细窗口的事件taphold会触发打开窗口后的touchend事件，造成长按打开窗口后一放手窗口就又关掉了\n\t\t# 这里只能通过阻止tapend事件(不可以用touchend事件，因为会影响taphold功能，造成没有长按效果时也会触发taphold事件)冒泡来避免问题。\n\t\tevent.stopPropagation()\n\t\tevent.preventDefault()\n\t\treturn false\n\n\t'click .instance-trace-detail-modal .btn-forward-approve-remove': (event, template) ->\n\t\tinstanceId = Session.get('instanceId')\n\t\tapproveId = event.target.dataset.approve\n\t\ttraceId = event.target.dataset.trace\n\t\t# CALL 删除approve函数。\n\t\t$(\"body\").addClass(\"loading\")\n\t\tMeteor.call 'forward_remove', instanceId, traceId, approveId, (err, result) ->\n\t\t\t$(\"body\").removeClass(\"loading\")\n\t\t\tif err\n\t\t\t\ttoastr.error TAPi18n.__(err.reason)\n\t\t\tif result == true\n\t\t\t\ttoastr.success(TAPi18n.__(\"instance_approve_forward_remove_success\"));\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\n\t\t\treturn\n\t\treturn\n\n\t'click .instance-trace-detail-modal .btn-forward-instance-look': (event, template) ->\n\t\tforward_space = event.target.dataset.forwardspace\n\t\tforward_instance = event.target.dataset.forwardinstance\n\t\tSteedos.openWindow(Steedos.absoluteUrl(\"workflow/space/\" + forward_space + \"/view/readonly/\" + forward_instance))\n\n\t'click .btn-modification'\t: (event, template) ->\n\t\ttemplate.is_editing.set(!template.is_editing.get());\n\t\tunless Steedos.isAndroidOrIOS()\n\t\t\tTracker.afterFlush ->\n\t\t\t\t# 显示日志的时候把滚动条往下移点，让日期控件显示出一部分，以避免用户看不到日期控件\n\t\t\t\t$(\"#instance_trace_detail_modal #finish_input\").on \"dp.show\", () ->\n\t\t\t\t\t$(\".modal-body\").scrollTop(100)\n\n\t'click .btn-cancelBut' : (event, template) ->\n\n\t\ttemplate.is_editing.set(!template.is_editing.get());\n\n\t'click .btn-saveBut' : (event, template) ->\n\t\t# template.is_editing.set(!template.is_editing.get())\n\n\t\tinstanceId = Session.get('instanceId')\n\t\tapproveId = event.target.dataset.approve\n\t\ttraceId = event.target.dataset.trace\n\t\topinion_input = $('#opinion_input').val()\n\t\tfinish_input = AutoForm.getFieldValue(\"finish_date\", \"finishDateAutoForm\")\n\n\t\t$(\"body\").addClass(\"loading\")\n\t\tMeteor.call 'change_approve_info', instanceId, traceId, approveId, opinion_input, finish_input, (err, result)->\n\t\t\t$(\"body\").removeClass(\"loading\")\n\t\t\tif err\n\t\t\t\ttoastr.error TAPi18n.__(err.reason)\n\t\t\tif result == true\n\t\t\t\ttoastr.success(t(\"instance_approve_modal_modificationsave\"))\n\t\t\t\tModal.hide \"instance_trace_detail_modal\"\n\t\t\treturn\n\n\t'click .instance-trace-detail-modal .btn-distribute-approve-remove': (event, template) ->\n\t\tModal.allowMultiple = true\n\t\tModal.show 'cancel_distribute_modal'\n","TracesTemplate.helpers = {\n  equals: function(a, b) {\n    return a === b;\n  },\n  empty: function(a) {\n    if (a) {\n      return a.toString().trim().length < 1;\n    } else {\n      return true;\n    }\n  },\n  unempty: function(a) {\n    if (a) {\n      return a.toString().trim().length > 0;\n    } else {\n      return false;\n    }\n  },\n  append: function(a, b) {\n    return a + b;\n  },\n  dateFormat: function(date) {\n    if (Steedos.isMobile() && (date != null ? date.getFullYear() : void 0) === (new Date).getFullYear()) {\n      return $.format.date(new Date(date), \"MM-dd HH:mm\");\n    } else {\n      return $.format.date(new Date(date), \"yyyy-MM-dd HH:mm\");\n    }\n  },\n  getStepName: function(stepId) {\n    var step;\n    step = WorkflowManager.getInstanceStep(stepId);\n    if (step) {\n      return step.name;\n    }\n    return null;\n  },\n  showDeleteButton: function(approved) {\n    if (approved && approved.type === 'cc' && approved.from_user === Meteor.userId() && approved.is_finished !== true && !Session.get(\"instancePrint\")) {\n      return true;\n    }\n    return false;\n  },\n  isShowModificationButton: function(approved) {\n    var approve_admins, isShow, ref, ref1, ref2;\n    approve_admins = (ref = Meteor.settings) != null ? (ref1 = ref[\"public\"]) != null ? (ref2 = ref1.workflow) != null ? ref2.approve_admins : void 0 : void 0 : void 0;\n    if (approve_admins != null ? approve_admins.length : void 0) {\n      isShow = approve_admins != null ? approve_admins.contains(Meteor.userId()) : void 0;\n    }\n    if (!isShow) {\n      return false;\n    }\n    return approved.handler === Meteor.userId();\n  },\n  isEditing: function() {\n    var ref;\n    return (ref = Template.instance().is_editing) != null ? ref.get() : void 0;\n  },\n  isShowDescription: function(approved) {\n    var ref;\n    if (TracesTemplate.helpers.isShowModificationButton(approved)) {\n      return true;\n    }\n    return ((ref = approved.description) != null ? ref.toString().trim().length : void 0) > 0;\n  },\n  isCC: function(approved) {\n    if (approved && approved.type === 'cc') {\n      return true;\n    }\n    return false;\n  },\n  getApproveStatusIcon: function(approveJudge) {\n    var approveStatusIcon;\n    approveStatusIcon = void 0;\n    switch (approveJudge) {\n      case 'approved':\n        approveStatusIcon = 'ion ion-checkmark-round';\n        break;\n      case 'rejected':\n        approveStatusIcon = 'ion ion-close-round';\n        break;\n      case 'terminated':\n        approveStatusIcon = 'fa fa-ban';\n        break;\n      case 'reassigned':\n        approveStatusIcon = 'ion ion-android-contact';\n        break;\n      case 'relocated':\n        approveStatusIcon = 'ion ion-arrow-shrink';\n        break;\n      case 'retrieved':\n        approveStatusIcon = 'fa fa-undo';\n        break;\n      default:\n        approveStatusIcon = '';\n        break;\n    }\n    return approveStatusIcon;\n  },\n  getApproveStatusText: function(approveJudge) {\n    var approveStatusText, locale;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    approveStatusText = void 0;\n    switch (approveJudge) {\n      case 'approved':\n        approveStatusText = TAPi18n.__('Instance State approved', {}, locale);\n        break;\n      case 'rejected':\n        approveStatusText = TAPi18n.__('Instance State rejected', {}, locale);\n        break;\n      case 'terminated':\n        approveStatusText = TAPi18n.__('Instance State terminated', {}, locale);\n        break;\n      case 'reassigned':\n        approveStatusText = TAPi18n.__('Instance State reassigned', {}, locale);\n        break;\n      case 'relocated':\n        approveStatusText = TAPi18n.__('Instance State relocated', {}, locale);\n        break;\n      case 'retrieved':\n        approveStatusText = TAPi18n.__('Instance State retrieved', {}, locale);\n        break;\n      case 'returned':\n        approveStatusText = TAPi18n.__('Instance State returned', {}, locale);\n        break;\n      case 'readed':\n        approveStatusText = TAPi18n.__('Instance State readed', {}, locale);\n        break;\n      default:\n        approveStatusText = '';\n        break;\n    }\n    return approveStatusText;\n  },\n  _t: function(key) {\n    return TAPi18n.__(key);\n  },\n  myApproveDescription: function(approveId) {\n    var myApprove, ref, ref1;\n    if (Meteor.isClient) {\n      if (Session.get(\"box\") === 'inbox') {\n        myApprove = (ref = Template.instance()) != null ? (ref1 = ref.myApprove) != null ? ref1.get() : void 0 : void 0;\n        if (myApprove && myApprove.id === approveId) {\n          if (!Session.get(\"instance_my_approve_description\")) {\n            return (myApprove != null ? myApprove.description : void 0) || \"\";\n          }\n          return Session.get(\"instance_my_approve_description\");\n        }\n      }\n    }\n  },\n  isForward: function(approved) {\n    if (approved && approved.type === 'forward') {\n      return true;\n    }\n    return false;\n  },\n  showForwardDeleteButton: function(approve) {\n    if (db.instances.find(approve.forward_instance).count() === 0) {\n      return false;\n    }\n    if (approve && approve.type === 'forward' && approve.from_user === Meteor.userId() && !Session.get(\"instancePrint\") && approve.judge !== 'terminated') {\n      return true;\n    }\n    return false;\n  },\n  markDownToHtml: function(markDownString) {\n    var renderer;\n    if (markDownString) {\n      renderer = new Markdown.Renderer();\n      renderer.link = function(href, title, text) {\n        return \"<a target='_blank' href='\" + href + \"' title='\" + title + \"'>\" + text + \"</a>\";\n      };\n      return Spacebars.SafeString(Markdown(markDownString, {\n        renderer: renderer\n      }));\n    }\n  },\n  isDistribute: function(approve) {\n    if (approve && approve.type === 'distribute') {\n      return true;\n    }\n    return false;\n  },\n  showDistributeDeleteButton: function(approve) {\n    var ins;\n    if (db.instances.find(approve.forward_instance).count() === 0) {\n      return false;\n    }\n    if (approve && approve.type === 'distribute' && !Session.get(\"instancePrint\") && approve.judge !== 'terminated' && Steedos.isLegalVersion('', \"workflow.enterprise\")) {\n      ins = db.instances.findOne({\n        _id: approve.instance\n      }, {\n        fields: {\n          flow: 1,\n          space: 1\n        }\n      });\n      if (ins && ins.flow && ins.space) {\n        if (WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, Meteor.userId())) {\n          return true;\n        }\n      }\n      if (approve.from_user === Meteor.userId()) {\n        return true;\n      }\n    }\n    return false;\n  },\n  finishDateSchema: function() {\n    if (Steedos.isAndroidOrIOS()) {\n      return new SimpleSchema({\n        finish_date: {\n          autoform: {\n            type: \"datetime-local\"\n          },\n          optional: false,\n          type: Date\n        }\n      });\n    } else {\n      return new SimpleSchema({\n        finish_date: {\n          autoform: {\n            type: \"bootstrap-datetimepicker\",\n            readonly: true,\n            dateTimePickerOptions: {\n              format: \"YYYY-MM-DD HH:mm\",\n              ignoreReadonly: true,\n              locale: Session.get(\"TAPi18n::loaded_lang\"),\n              widgetPositioning: {\n                horizontal: 'right'\n              }\n            }\n          },\n          optional: false,\n          type: Date\n        }\n      });\n    }\n  },\n  finishDateValues: function() {\n    return {\n      finish_date: this.finish_date\n    };\n  },\n\n  /*\n     \t此函数用于控制是否显示traces view\n     \ttrue: 显示traces view,签核历程按钮点击后是直接定位到traces view\n     \tfalse: 不显示traces view，签核历程按钮点击后,以Modal 方式显示traces view\n   */\n  showTracesView: function(form, form_version) {\n    var ref, show_modal_traces_list;\n    show_modal_traces_list = ((ref = db.space_settings.findOne({\n      space: Session.get(\"spaceId\"),\n      key: \"show_modal_traces_list\"\n    })) != null ? ref.values : void 0) || false;\n    return !show_modal_traces_list;\n  },\n  getInstanceStateText: function(instance_id) {\n    var ins, locale, text;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        state: 1,\n        is_read: 1\n      }\n    });\n    if (!ins) {\n      return TAPi18n.__('instance_deleted', {}, locale);\n    }\n    text = '';\n    if (ins.state === 'completed') {\n      text = TAPi18n.__('completed', {}, locale);\n    } else if (ins.state === 'pending') {\n      text = TAPi18n.__('pending', {}, locale);\n    } else if (ins.state === 'draft') {\n      if (ins.is_read) {\n        text = TAPi18n.__('instance_approve_read', {}, locale);\n      } else {\n        text = TAPi18n.__('instance_approve_not_yet_handled', {}, locale);\n      }\n    }\n    return text;\n  },\n  getInstanceStateColor: function(instance_id) {\n    var cla, ins;\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        state: 1,\n        is_read: 1\n      }\n    });\n    if (!ins) {\n      return \"\";\n    }\n    cla = '';\n    if (ins.state === 'draft') {\n      if (ins.is_read) {\n        cla = 'blue';\n      } else {\n        cla = 'red';\n      }\n    }\n    return cla;\n  },\n  firstTrace: function(index) {\n    return index === 0;\n  },\n  last_distribute_from: function(instance_id) {\n    var dis_info, ins, user;\n    ins = db.instances.findOne({\n      _id: instance_id,\n      distribute_from_instance: {\n        $exists: true\n      }\n    }, {\n      fields: {\n        created: 1,\n        created_by: 1\n      }\n    });\n    if (ins) {\n      dis_info = {};\n      user = {};\n      if (Meteor.isClient) {\n        user = UUflow_api.getNameForUser(ins.created_by);\n      } else if (Meteor.isServer) {\n        user = db.users.findOne({\n          _id: ins.created_by\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n      }\n      if (user.name) {\n        dis_info.from_user_name = user.name;\n        dis_info.created = ins.created;\n      }\n      if (!_.isEmpty(dis_info)) {\n        return dis_info;\n      }\n    }\n  },\n  isCCOrDistributeOrForwardTerminated: function(approve) {\n    if ((approve.type === 'cc' || approve.type === 'distribute' || approve.type === 'forward') && approve.judge === 'terminated') {\n      return true;\n    }\n    return false;\n  },\n  judgeTerminated: function(judge) {\n    return judge === 'terminated';\n  },\n  instanceExists: function(instance_id) {\n    return !!db.instances.find(instance_id).count();\n  },\n  agentDescription: function(userName) {\n    var locale;\n    if (Meteor.isServer) {\n      locale = Template.instance().view.template.steedosData.locale;\n      if (locale.toLocaleLowerCase() === 'zh-cn') {\n        locale = \"zh-CN\";\n      }\n    } else {\n      locale = Session.get(\"TAPi18n::loaded_lang\");\n    }\n    return TAPi18n.__('process_delegation_rules_description', {\n      userName: userName\n    }, locale);\n  },\n  traceName: function(instance_id, traceId) {\n    var ref, ref1;\n    return (ref = _.find((ref1 = db.instances.findOne(instance_id, {\n      fields: {\n        traces: 1\n      }\n    })) != null ? ref1.traces : void 0, function(trace) {\n      return trace._id === traceId;\n    })) != null ? ref.name : void 0;\n  }\n};\n\nif (Meteor.isServer) {\n  TracesTemplate.helpers.dateFormat = function(date) {\n    var utcOffset;\n    if (date) {\n      utcOffset = Template.instance().view.template.steedosData.utcOffset;\n      return InstanceReadOnlyTemplate.formatDate(date, utcOffset);\n    }\n  };\n  TracesTemplate.helpers._t = function(key) {\n    var locale;\n    locale = Template.instance().view.template.steedosData.locale;\n    return TAPi18n.__(key, {}, locale);\n  };\n  TracesTemplate.helpers.showDeleteButton = function(approved) {\n    return false;\n  };\n}\n\nTracesTemplate.events = {\n  'click .cc-approve-remove': function(event, template) {\n    var approveId, instanceId;\n    event.stopPropagation();\n    if (event.currentTarget.dataset.calling * 1 !== 1) {\n      event.currentTarget.dataset.calling = 1;\n      $(\"i\", event.currentTarget).addClass(\"fa-spin\");\n      instanceId = Session.get('instanceId');\n      approveId = event.target.dataset.approve;\n      $(\"body\").addClass(\"loading\");\n      Meteor.call('cc_remove', instanceId, approveId, function(err, result) {\n        $(\"body\").removeClass(\"loading\");\n        if (err) {\n          toastr.error(err);\n          event.currentTarget.dataset.calling = 0;\n          $(\"i\", event.currentTarget).removeClass(\"fa-spin\");\n        }\n        if (result === true) {\n          toastr.success(TAPi18n.__(\"remove_cc_approve\"));\n          if ($(\".instance-trace-detail-modal\").length) {\n            Modal.hide(\"instance_trace_detail_modal\");\n          }\n        }\n      });\n    }\n  },\n  'click .instance-trace-detail-modal .btn-cc-approve-remove': function(event, template) {\n    var approveId, instanceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    $(\"body\").addClass(\"loading\");\n    Meteor.call('cc_remove', instanceId, approveId, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(err);\n      }\n      if (result === true) {\n        toastr.success(TAPi18n.__(\"remove_cc_approve\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .approve-item,.approve-description': function(event, template) {\n    return Modal.show(\"instance_trace_detail_modal\", this);\n  },\n  'taphold .approve-item,.approve-description': function(event, template) {\n    return Modal.show(\"instance_trace_detail_modal\", this);\n  },\n  'tapend .approve-item,.approve-description': function(event, template) {\n    event.stopPropagation();\n    event.preventDefault();\n    return false;\n  },\n  'click .instance-trace-detail-modal .btn-forward-approve-remove': function(event, template) {\n    var approveId, instanceId, traceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    traceId = event.target.dataset.trace;\n    $(\"body\").addClass(\"loading\");\n    Meteor.call('forward_remove', instanceId, traceId, approveId, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(TAPi18n.__(err.reason));\n      }\n      if (result === true) {\n        toastr.success(TAPi18n.__(\"instance_approve_forward_remove_success\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .instance-trace-detail-modal .btn-forward-instance-look': function(event, template) {\n    var forward_instance, forward_space;\n    forward_space = event.target.dataset.forwardspace;\n    forward_instance = event.target.dataset.forwardinstance;\n    return Steedos.openWindow(Steedos.absoluteUrl(\"workflow/space/\" + forward_space + \"/view/readonly/\" + forward_instance));\n  },\n  'click .btn-modification': function(event, template) {\n    template.is_editing.set(!template.is_editing.get());\n    if (!Steedos.isAndroidOrIOS()) {\n      return Tracker.afterFlush(function() {\n        return $(\"#instance_trace_detail_modal #finish_input\").on(\"dp.show\", function() {\n          return $(\".modal-body\").scrollTop(100);\n        });\n      });\n    }\n  },\n  'click .btn-cancelBut': function(event, template) {\n    return template.is_editing.set(!template.is_editing.get());\n  },\n  'click .btn-saveBut': function(event, template) {\n    var approveId, finish_input, instanceId, opinion_input, traceId;\n    instanceId = Session.get('instanceId');\n    approveId = event.target.dataset.approve;\n    traceId = event.target.dataset.trace;\n    opinion_input = $('#opinion_input').val();\n    finish_input = AutoForm.getFieldValue(\"finish_date\", \"finishDateAutoForm\");\n    $(\"body\").addClass(\"loading\");\n    return Meteor.call('change_approve_info', instanceId, traceId, approveId, opinion_input, finish_input, function(err, result) {\n      $(\"body\").removeClass(\"loading\");\n      if (err) {\n        toastr.error(TAPi18n.__(err.reason));\n      }\n      if (result === true) {\n        toastr.success(t(\"instance_approve_modal_modificationsave\"));\n        Modal.hide(\"instance_trace_detail_modal\");\n      }\n    });\n  },\n  'click .instance-trace-detail-modal .btn-distribute-approve-remove': function(event, template) {\n    Modal.allowMultiple = true;\n    return Modal.show('cancel_distribute_modal');\n  }\n};\n","RelatedInstances.helpers =\n\tshowRelatedInstaces: ->\n\t\tif Meteor.isClient\n\t\t\tins = WorkflowManager.getInstance();\n\t\telse\n\t\t\tins = this.instance\n\t\tif ins?.related_instances && _.isArray(ins?.related_instances)\n\t\t\tif db.instances.find({_id: {$in: ins.related_instances}}, {fields: {space: 1, name: 1}}).count() > 0\n\t\t\t\treturn true\n\t\t\treturn false\n\t\telse\n\t\t\treturn false\n\n\trelated_instaces: ->\n\t\tif Meteor.isClient\n\t\t\tins = WorkflowManager.getInstance();\n\t\telse\n\t\t\tins = this.instance\n\t\tif ins?.related_instances && _.isArray(ins?.related_instances)\n\t\t\treturn db.instances.find({_id: {$in: ins.related_instances}}, {fields: {space: 1, name: 1}}).fetch()\n\n\trelated_instace_url: (ins) ->\n\n\t\tif Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())\n\t\t\treturn ''\n\n\t\tabsolute = false\n\n\t\tif Meteor.isServer\n\t\t\tabsolute = this.absolute\n\t\tif absolute\n\t\t\treturn Meteor.absoluteUrl(\"workflow/space/\"+ins.space+\"/view/readonly/\" + ins._id + '?hide_traces=0')\n\t\telse\n\t\t\treturn Steedos.absoluteUrl(\"workflow/space/\"+ins.space+\"/view/readonly/\" + ins._id + '?hide_traces=0')\n\n\t_t: (key)->\n\t\tif Meteor.isClient\n\t\t\treturn TAPi18n.__(key)\n\t\telse\n\t\t\tlocale = Template.instance().view.template.steedosData.locale\n\t\t\treturn TAPi18n.__(key, {}, locale)\n\n\tshow_delete: ()->\n\t\tif !Meteor.isClient\n\t\t\treturn false\n\t\telse\n\t\t\tif Session.get(\"box\") == \"draft\" || Session.get(\"box\") == 'inbox'\n\t\t\t\tcurrent_step = InstanceManager.getCurrentStep()\n\t\t\t\tif current_step\n\t\t\t\t\tif (current_step.can_edit_main_attach || current_step.can_edit_normal_attach == true || current_step.can_edit_normal_attach == undefined)\n\t\t\t\t\t\treturn true","RelatedInstances.helpers = {\n  showRelatedInstaces: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if ((ins != null ? ins.related_instances : void 0) && _.isArray(ins != null ? ins.related_instances : void 0)) {\n      if (db.instances.find({\n        _id: {\n          $in: ins.related_instances\n        }\n      }, {\n        fields: {\n          space: 1,\n          name: 1\n        }\n      }).count() > 0) {\n        return true;\n      }\n      return false;\n    } else {\n      return false;\n    }\n  },\n  related_instaces: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if ((ins != null ? ins.related_instances : void 0) && _.isArray(ins != null ? ins.related_instances : void 0)) {\n      return db.instances.find({\n        _id: {\n          $in: ins.related_instances\n        }\n      }, {\n        fields: {\n          space: 1,\n          name: 1\n        }\n      }).fetch();\n    }\n  },\n  related_instace_url: function(ins) {\n    var absolute;\n    if (Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())) {\n      return '';\n    }\n    absolute = false;\n    if (Meteor.isServer) {\n      absolute = this.absolute;\n    }\n    if (absolute) {\n      return Meteor.absoluteUrl(\"workflow/space/\" + ins.space + \"/view/readonly/\" + ins._id + '?hide_traces=0');\n    } else {\n      return Steedos.absoluteUrl(\"workflow/space/\" + ins.space + \"/view/readonly/\" + ins._id + '?hide_traces=0');\n    }\n  },\n  _t: function(key) {\n    var locale;\n    if (Meteor.isClient) {\n      return TAPi18n.__(key);\n    } else {\n      locale = Template.instance().view.template.steedosData.locale;\n      return TAPi18n.__(key, {}, locale);\n    }\n  },\n  show_delete: function() {\n    var current_step;\n    if (!Meteor.isClient) {\n      return false;\n    } else {\n      if (Session.get(\"box\") === \"draft\" || Session.get(\"box\") === 'inbox') {\n        current_step = InstanceManager.getCurrentStep();\n        if (current_step) {\n          if (current_step.can_edit_main_attach || current_step.can_edit_normal_attach === true || current_step.can_edit_normal_attach === void 0) {\n            return true;\n          }\n        }\n      }\n    }\n  }\n};\n","RelatedRecords.helpers =\n\tshowRelatedRecords: ()->\n\t\tif Meteor.isClient\n\t\t\tins = WorkflowManager.getInstance();\n\t\telse\n\t\t\tins = this.instance\n\t\tif !ins\n\t\t\treturn false\n\t\treturn !_.isEmpty(ins.record_ids)","RelatedRecords.helpers = {\n  showRelatedRecords: function() {\n    var ins;\n    if (Meteor.isClient) {\n      ins = WorkflowManager.getInstance();\n    } else {\n      ins = this.instance;\n    }\n    if (!ins) {\n      return false;\n    }\n    return !_.isEmpty(ins.record_ids);\n  }\n};\n","Meteor.methods\n\tset_instance_step_approve: (ins_id, step_approve)->\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tins = db.instances.findOne({_id: ins_id}, {fields: {state: 1}})\n\n\t\tif ins.state != 'draft'\n\t\t\treturn ;\n\n\t\tdb.instances.update {_id: ins_id}, {$set: {step_approve: step_approve}}","Meteor.methods({\n  set_instance_step_approve: function(ins_id, step_approve) {\n    var ins;\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        state: 1\n      }\n    });\n    if (ins.state !== 'draft') {\n      return;\n    }\n    return db.instances.update({\n      _id: ins_id\n    }, {\n      $set: {\n        step_approve: step_approve\n      }\n    });\n  }\n});\n","Meteor.methods({\n\n\tget_instance_data: function (instance_id, formCached, flowCached) {\n\n\t\tcheck(instance_id, String);\n\t\tcheck(formCached, Boolean);\n\t\tcheck(flowCached, Boolean);\n\n\t\tvar instance = db.instances.findOne(instance_id);\n\n\t\tif (!instance)\n\t\t\treturn {\n\t\t\t\tinstance: null\n\t\t\t};\n\n\t\tif (formCached && flowCached)\n\t\t\treturn {\n\t\t\t\tinstance: instance\n\t\t\t};\n\n\t\tif (!formCached) {\n\t\t\tvar form = db.forms.findOne(instance.form);\n\t\t\tvar form_version = {};\n\t\t\tif (form.current._id == instance.form_version) {\n\t\t\t\tform_version = form.current;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tform_version = _.where(form.historys, {_id: instance.form_version})[0];\n\t\t\t}\n\t\t}\n\n\n\t\tif (!flowCached) {\n\t\t\tvar flow = db.flows.findOne(instance.flow);\n\t\t\tvar flow_version = {};\n\t\t\tif (flow.current._id == instance.flow_version) {\n\t\t\t\tflow_version = flow.current;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tflow_version = _.where(flow.historys, {_id: instance.flow_version})[0];\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tinstance: instance,\n\t\t\tform_version: form_version,\n\t\t\tflow_version: flow_version\n\t\t}\n\n\t}\n\n});\n","Meteor.methods({\n\n\tdraft_save_instance: function (ins) {\n\t\tif (!this.userId)\n\t\t\treturn;\n\t\tvar result = true;\n\t\tvar setObj = {};\n\t\tvar index = 0;\n\t\tvar ins_id = ins._id;\n\t\tvar trace_id = ins.traces[0]._id;\n\t\tvar approve_id = ins.traces[0].approves[0]._id;\n\t\tvar description = ins.traces[0].approves[0].description;\n\t\tvar next_steps = ins.traces[0].approves[0].next_steps;\n\t\tvar values = ins.traces[0].approves[0].values || {};\n\t\tvar applicant_id = ins.applicant;\n\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\tapplicant: 1,\n\t\t\t\tstate: 1,\n\t\t\t\tsubmitter: 1,\n\t\t\t\ttraces: 1,\n\t\t\t\tform: 1,\n\t\t\t\tflow_version: 1,\n\t\t\t\tspace: 1,\n\t\t\t\tflow: 1\n\t\t\t}\n\t\t});\n\n\t\tvar space_id = instance.space;\n\t\tvar flow_id = instance.flow;\n\t\tvar form_id = instance.form;\n\t\tvar traces = instance.traces;\n\t\tvar current_trace = _.find(traces, function (t) {\n\t\t\treturn t._id == trace_id;\n\t\t});\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\n\t\t\tif (a._id == approve_id) {\n\t\t\t\tindex = idx;\n\t\t\t}\n\t\t})\n\t\tvar key_str = 'traces.$.approves.' + index + '.';\n\n\t\t// 判断一个instance是否为拟稿状态\n\t\tvar current_user = db.users.findOne({\n\t\t\t_id: this.userId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tlocale: 1\n\t\t\t}\n\t\t});\n\t\tvar lang = current_user.locale == 'zh-cn' ? 'zh-CN' : 'en';\n\t\tuuflowManager.isInstanceDraft(instance, lang);\n\t\t// 判断一个用户是否是一个instance的提交者\n\t\tuuflowManager.isInstanceSubmitter(instance, this.userId);\n\n\t\tvar flow = db.flows.findOne(flow_id, {\n\t\t\tfields: {\n\t\t\t\t\"current._id\": 1,\n\t\t\t\t\"current.form_version\": 1,\n\t\t\t\t\"name\": 1,\n\t\t\t\t\"current.steps\": 1\n\t\t\t}\n\t\t});\n\n\t\tsetObj.modified = new Date();\n\t\tsetObj.modified_by = this.userId;\n\n\t\tif (flow.current._id != instance.flow_version) {\n\t\t\tresult = \"upgraded\";\n\t\t\tvar start_step = _.find(flow.current.steps, function (s) {\n\t\t\t\treturn s.step_type == \"start\";\n\t\t\t});\n\t\t\t// 流程已升级\n\t\t\tsetObj.flow_version = flow.current._id;\n\t\t\tsetObj.form_version = flow.current.form_version;\n\t\t\t// 存入当前最新版flow中开始节点的step_id\n\t\t\tsetObj[\"traces.$.step\"] = start_step._id;\n\t\t\tsetObj[\"traces.$.name\"] = start_step.name;\n\t\t}\n\n\t\tif (instance.applicant != applicant_id) {\n\t\t\t// 申请人已变换\n\t\t\tvar user = db.users.findOne(applicant_id, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar applicant = db.space_users.find({\n\t\t\t\tspace: space_id,\n\t\t\t\tuser: applicant_id\n\t\t\t}, {\n\t\t\t\tfields: {\n\t\t\t\t\torganization: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar org_id = applicant.fetch()[0].organization;\n\t\t\tvar organization = db.organizations.findOne(org_id, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1,\n\t\t\t\t\tfullname: 1\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tsetObj.applicant = applicant_id;\n\t\t\tsetObj.applicant_name = user.name;\n\t\t\tsetObj.applicant_organization = org_id;\n\t\t\tsetObj.applicant_organization_name = organization.name;\n\t\t\tsetObj.applicant_organization_fullname = organization.fullname;\n\n\t\t\tsetObj[key_str + 'user'] = applicant_id;\n\t\t\tsetObj[key_str + 'user_name'] = user.name;\n\t\t}\n\n\t\tsetObj[key_str + 'values'] = values;\n\t\tsetObj[key_str + 'description'] = description;\n\t\tsetObj[key_str + 'judge'] = 'submitted';\n\t\tsetObj[key_str + 'read_date'] = new Date();\n\t\tif (result != \"upgraded\" && next_steps) {\n\t\t\tsetObj[key_str + 'next_steps'] = next_steps;\n\t\t}\n\n\t\t// 计算申请单标题\n\t\tvar form = db.forms.findOne({\n\t\t\t_id: form_id\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\t\"current.name_forumla\": 1\n\t\t\t}\n\t\t});\n\t\tvar name_forumla = form.current.name_forumla;\n\t\tif (name_forumla) {\n\t\t\t// var iscript = name_forumla.replace(/\\{/g, \"(values['\").replace(/\\}/g, \"'] || '')\");\n\t\t\t// var rev = eval(iscript);\n\t\t\tsetObj.name = uuflowManager.getInstanceName(ins, values);\n\t\t}\n\n\t\tdb.instances.update({\n\t\t\t_id: ins_id,\n\t\t\t\"traces._id\": trace_id\n\t\t}, {\n\t\t\t$set: setObj\n\t\t});\n\t\treturn result;\n\t},\n\n\tinbox_save_instance: function (approve) {\n\t\tif (!this.userId)\n\t\t\treturn;\n\n\t\tvar setObj = {};\n\t\tvar index = 0;\n\t\tvar ins_id = approve.instance;\n\t\tvar trace_id = approve.trace;\n\t\tvar approve_id = approve.id;\n\t\tvar values = approve.values;\n\t\tvar next_steps = approve.next_steps;\n\t\tvar description = approve.description;\n\t\tvar judge = approve.judge;\n\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\ttraces: 1,\n\t\t\t\tflow_version: 1,\n\t\t\t\tflow: 1,\n\t\t\t\tstate: 1,\n\t\t\t\tform: 1,\n\t\t\t\tform_version: 1,\n\t\t\t\tvalues: 1,\n\t\t\t\tcode: 1\n\t\t\t}\n\t\t});\n\n\t\tvar traces = instance.traces;\n\n\t\tvar current_trace = _.find(traces, function (t) {\n\t\t\treturn t._id == trace_id;\n\t\t});\n\t\tvar current_approve = _.find(current_trace.approves, function (a) {\n\t\t\treturn a._id == approve_id;\n\t\t});\n\n\t\t// 判断一个instance是否为审核中状态\n\t\tvar current_user = db.users.findOne({\n\t\t\t_id: this.userId\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tlocale: 1\n\t\t\t}\n\t\t});\n\t\tvar lang = current_user.locale == 'zh-cn' ? 'zh-CN' : 'en';\n\t\ttry {\n\t\t\tuuflowManager.isInstancePending(instance, lang);\n\t\t\t// 判断一个trace是否为未完成状态\n\t\t\tuuflowManager.isTraceNotFinished(current_trace);\n\t\t\t// 判断一个approve是否为未完成状态\n\t\t\tuuflowManager.isApproveNotFinished(current_approve);\n\t\t\t// 判断当前用户是否approve 对应的处理人或代理人\n\t\t\tuuflowManager.isHandlerOrAgent(current_approve, this.userId);\n\t\t} catch (e) {\n\t\t\tconsole.log(e.stack)\n\t\t\treturn true\n\t\t}\n\n\n\t\tvar flow_version = instance.flow_version;\n\t\tvar flow_id = instance.flow;\n\t\tvar step_id = \"\";\n\t\tstep_id = current_trace.step;\n\t\tvar flow = db.flows.findOne(flow_id, {\n\t\t\tfields: {\n\t\t\t\tcurrent: 1,\n\t\t\t\thistorys: 1\n\t\t\t}\n\t\t});\n\t\tvar step = null;\n\t\tif (flow.current._id == flow_version) {\n\t\t\tflow.current.steps.forEach(function (s) {\n\t\t\t\tif (s._id == step_id)\n\t\t\t\t\tstep = s;\n\t\t\t})\n\t\t} else {\n\t\t\tflow.historys.forEach(function (h) {\n\t\t\t\th.steps.forEach(function (s) {\n\t\t\t\t\tif (s._id == step_id)\n\t\t\t\t\t\tstep = s;\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\n\t\tif (!step)\n\t\t\treturn false;\n\t\tvar step_type = step.step_type;\n\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\n\t\t\tif (a._id == approve_id) {\n\t\t\t\tindex = idx;\n\t\t\t}\n\t\t})\n\n\t\tvar key_str = 'traces.$.approves.' + index + '.';\n\n\t\tvar permissions_values = uuflowManager.getApproveValues(approve.values, step.permissions, instance.form, instance.form_version);\n\n\t\tvar change_values = approveManager.getChangeValues(instance.values, permissions_values);\n\n\t\tsetObj.values = _.extend((instance.values || {}), permissions_values);\n\n\t\tif (!_.isEmpty(change_values)) {\n\n\t\t\tvalues_history = current_approve.values_history || []\n\n\t\t\tvalues_history.push({\n\t\t\t\tvalues: change_values,\n\t\t\t\tcreate: new Date()\n\t\t\t})\n\n\t\t\tsetObj[key_str + 'values_history'] = values_history\n\t\t}\n\n\t\tsetObj[key_str + 'is_read'] = true;\n\t\tsetObj[key_str + 'read_date'] = new Date();\n\t\tsetObj[key_str + 'values'] = setObj.values;\n\t\tsetObj[key_str + 'description'] = description;\n\t\tsetObj[key_str + 'next_steps'] = next_steps;\n\t\tif (step_type == \"submit\" || step_type == \"start\") {\n\t\t\tsetObj[key_str + 'judge'] = \"submitted\";\n\t\t} else {\n\t\t\tsetObj[key_str + 'judge'] = judge;\n\t\t}\n\n\t\tsetObj.modified = new Date();\n\t\tsetObj.modified_by = this.userId;\n\n\t\t// 计算申请单标题\n\t\tvar form = db.forms.findOne(instance.form);\n\t\tvar form_v = uuflowManager.getFormVersion(form, instance.form_version);\n\t\tvar name_forumla = form_v.name_forumla;\n\t\tif (name_forumla) {\n\t\t\tsetObj.name = uuflowManager.getInstanceName(instance, setObj.values);\n\t\t}\n\n\t\tdb.instances.update({\n\t\t\t_id: ins_id,\n\t\t\t\"traces._id\": trace_id\n\t\t}, {\n\t\t\t$set: setObj\n\t\t});\n\t\treturn true;\n\t}\n\n})","Meteor.methods({\n\t// ??? 能否传阅给当前步骤处理人 如果当前步骤是会签。\n\tcc_do: function (approve, cc_user_ids, description) {\n\n\t\tvar setObj = {};\n\t\tvar ins_id = approve.instance;\n\t\tvar trace_id = approve.trace;\n\t\tvar approve_id = approve._id;\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\tspace: 1,\n\t\t\t\ttraces: 1,\n\t\t\t\tcc_users: 1,\n\t\t\t\tvalues: 1\n\t\t\t}\n\t\t});\n\t\tvar current_user_id = this.userId;\n\t\tvar space_id = instance.space;\n\t\tvar new_approves = [];\n\n\t\tvar from_user_name = db.users.findOne(current_user_id, {\n\t\t\tfields: {\n\t\t\t\tname: 1\n\t\t\t}\n\t\t}).name\n\n\t\tcc_user_ids.forEach(function (userId, idx) {\n\t\t\tvar user = db.users.findOne(userId, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar space_user = db.space_users.findOne({\n\t\t\t\tspace: space_id,\n\t\t\t\tuser: userId\n\t\t\t}, {\n\t\t\t\tfields: {\n\t\t\t\t\torganization: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar org_id = space_user.organization;\n\t\t\tvar organization = db.organizations.findOne(org_id, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1,\n\t\t\t\t\tfullname: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar agent = uuflowManager.getAgent(space_id, userId);\n\t\t\tvar handler_id = userId;\n\t\t\tvar handler_info = user;\n\t\t\tvar handler_space_user = space_user;\n\t\t\tvar handler_org_info = organization;\n\t\t\tif (agent) {\n\t\t\t\thandler_id = agent;\n\t\t\t\thandler_info = db.users.findOne(agent, {\n\t\t\t\t\tfileds: {\n\t\t\t\t\t\tname: 1\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\thandler_space_user = uuflowManager.getSpaceUser(space_id, agent);\n\t\t\t\thandler_org_info = uuflowManager.getSpaceUserOrgInfo(handler_space_user);\n\t\t\t\tcc_user_ids[idx] = agent;\n\t\t\t}\n\t\t\tvar appr = {\n\t\t\t\t'_id': new Mongo.ObjectID()._str,\n\t\t\t\t'instance': ins_id,\n\t\t\t\t'trace': trace_id,\n\t\t\t\t'is_finished': false,\n\t\t\t\t'user': userId,\n\t\t\t\t'user_name': user.name,\n\t\t\t\t'handler': handler_id,\n\t\t\t\t'handler_name': handler_info.name,\n\t\t\t\t'handler_organization': handler_space_user.organization,\n\t\t\t\t'handler_organization_name': handler_org_info.name,\n\t\t\t\t'handler_organization_fullname': handler_org_info.fullname,\n\t\t\t\t'type': 'cc',\n\t\t\t\t'start_date': new Date(),\n\t\t\t\t'is_read': false,\n\t\t\t\t'from_user': current_user_id,\n\t\t\t\t'from_user_name': from_user_name,\n\t\t\t\t'opinion_fields_code': approve.opinion_fields_code,\n\t\t\t\t'sign_field_code': (approve.opinion_fields_code && approve.opinion_fields_code.length == 1) ? approve.opinion_fields_code[0] : \"\",\n\t\t\t\t'from_approve_id': approve_id,\n\t\t\t\t'cc_description': description\n\t\t\t};\n\t\t\tif (agent) {\n\t\t\t\tappr.agent = agent;\n\t\t\t}\n\t\t\tuuflowManager.setRemindInfo(instance.values, appr)\n\t\t\tnew_approves.push(appr);\n\t\t})\n\n\n\t\tsetObj.modified = new Date();\n\t\tsetObj.modified_by = this.userId;\n\n\t\tdb.instances.update({\n\t\t\t_id: ins_id,\n\t\t\t'traces._id': trace_id\n\t\t}, {\n\t\t\t$set: setObj,\n\t\t\t$addToSet: {\n\t\t\t\t'traces.$.approves': {\n\t\t\t\t\t$each: new_approves\n\t\t\t\t}\n\t\t\t},\n\t\t\t$push: {\n\t\t\t\tcc_users: {\n\t\t\t\t\t$each: cc_user_ids\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tinstance = db.instances.findOne(ins_id);\n\t\tcurrent_user_info = db.users.findOne(current_user_id);\n\t\tpushManager.send_instance_notification(\"trace_approve_cc\", instance, \"\", current_user_info, cc_user_ids);\n\n\t\tflow_id = instance.flow;\n\t\tapprove.cc_user_ids = cc_user_ids; // 记录下本次传阅的人员ID作为hook接口中的参数\n\t\t// 如果已经配置webhook并已激活则触发\n\t\tpushManager.triggerWebhook(flow_id, instance, approve, 'cc_do', current_user_id, cc_user_ids)\n\t\treturn true;\n\t},\n\n\tcc_read: function (approve) {\n\t\tvar setObj = {};\n\t\tvar ins_id = approve.instance;\n\t\tvar trace_id = approve.trace;\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\ttraces: 1\n\t\t\t}\n\t\t});\n\t\tvar current_user_id = this.userId;\n\t\tvar current_trace = _.find(instance.traces, function (t) {\n\t\t\treturn t._id == trace_id;\n\t\t})\n\n\t\tvar index = 0;\n\n\t\tcurrent_trace.approves.forEach(function (a, idx) {\n\t\t\tif (a.type == 'cc' && a.handler == current_user_id && !a.is_read) {\n\t\t\t\tindex = idx;\n\t\t\t}\n\t\t});\n\n\t\tsetObj['traces.$.approves.' + index + '.is_read'] = true;\n\t\tsetObj['traces.$.approves.' + index + '.read_date'] = new Date();\n\n\t\tsetObj.traces = traces;\n\n\t\tdb.instances.update({\n\t\t\t_id: ins_id,\n\t\t\t'traces._id': trace_id\n\t\t}, {\n\t\t\t$set: setObj\n\t\t});\n\t\treturn true;\n\t},\n\n\tcc_submit: function (ins_id, description) {\n\t\tvar setObj = {};\n\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\ttraces: 1,\n\t\t\t\tcc_users: 1,\n\t\t\t\toutbox_users: 1\n\t\t\t}\n\t\t});\n\t\tvar traces = instance.traces;\n\t\tvar current_user_id = this.userId;\n\t\tvar current_approve;\n\n\t\ttraces.forEach(function (t) {\n\t\t\tif (t.approves) {\n\t\t\t\tt.approves.forEach(function (a, idx) {\n\t\t\t\t\tif (a.type == 'cc' && a.handler == current_user_id && a.is_finished == false) {\n\t\t\t\t\t\tcurrent_approve = a;\n\t\t\t\t\t\tvar upobj = {};\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.is_finished'] = true;\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.is_read'] = true;\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.finish_date'] = new Date();\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.judge'] = \"submitted\";\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.cost_time'] = new Date() - a.start_date;\n\t\t\t\t\t\tdb.instances.update({\n\t\t\t\t\t\t\t_id: ins_id,\n\t\t\t\t\t\t\t'traces._id': t._id\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t$set: upobj\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tif (current_approve) {\n\t\t\tvar index = 0;\n\n\t\t\t//设置意见，意见只添加到最后一条approve中\n\t\t\ttraces.forEach(function (t) {\n\t\t\t\tif (current_approve && t._id === current_approve.trace) {\n\t\t\t\t\tif (t.approves) {\n\t\t\t\t\t\tt.approves.forEach(function (a, idx) {\n\t\t\t\t\t\t\tif (a._id === current_approve._id) {\n\t\t\t\t\t\t\t\ta.description = description;\n\t\t\t\t\t\t\t\tindex = idx;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tsetObj.modified = new Date();\n\t\t\tsetObj.modified_by = this.userId;\n\t\t\tsetObj['traces.$.approves.' + index + '.description'] = description;\n\n\t\t\tdb.instances.update({\n\t\t\t\t_id: ins_id,\n\t\t\t\t'traces._id': current_approve.trace\n\t\t\t}, {\n\t\t\t\t$set: setObj,\n\t\t\t\t$pull: {\n\t\t\t\t\tcc_users: current_user_id\n\t\t\t\t},\n\t\t\t\t$addToSet: {\n\t\t\t\t\toutbox_users: {\n\t\t\t\t\t\t$each: [current_user_id, current_approve.user]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tinstance = db.instances.findOne(ins_id);\n\n\t\t\tcurrent_user_info = db.users.findOne(current_user_id);\n\t\t\t//传阅提交不通知传阅者\n\t\t\tif (false && description && current_approve && current_approve.from_user) {\n\t\t\t\tpushManager.send_instance_notification(\"trace_approve_cc_submit\", instance, \"\", current_user_info, [current_approve.from_user]);\n\t\t\t}\n\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user_id);\n\n\t\t\tflow_id = instance.flow;\n\t\t\t// 如果已经配置webhook并已激活则触发\n\t\t\tpushManager.triggerWebhook(flow_id, instance, current_approve, 'cc_submit', current_user_id, []);\n\t\t}\n\n\t\treturn true;\n\t},\n\n\tcc_remove: function (instanceId, approveId) {\n\t\tvar setObj = {};\n\n\t\tvar instance = db.instances.findOne(instanceId, {\n\t\t\tfields: {\n\t\t\t\ttraces: 1,\n\t\t\t\tcc_users: 1\n\t\t\t}\n\t\t});\n\t\tvar traces = instance.traces;\n\t\tvar trace_id, remove_user_id, multi = false;\n\n\t\ttraces.forEach(function (t) {\n\t\t\tif (t.approves) {\n\t\t\t\tt.approves.forEach(function (a, idx) {\n\t\t\t\t\tif (a._id == approveId) {\n\t\t\t\t\t\ttrace_id = a.trace;\n\t\t\t\t\t\tremove_user_id = a.handler;\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.judge'] = 'terminated';\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_finished'] = true;\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.finish_date'] = new Date();\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_read'] = true;\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.read_date'] = new Date();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t})\n\n\t\tif (!trace_id || !remove_user_id)\n\t\t\treturn;\n\n\t\tvar multi = 0;\n\t\ttraces.forEach(function (t) {\n\t\t\tif (t.approves) {\n\t\t\t\tt.approves.forEach(function (a) {\n\t\t\t\t\tif (a.handler == remove_user_id && a.type == 'cc' && a.is_finished == false) {\n\t\t\t\t\t\tmulti++;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t})\n\n\t\tsetObj.modified = new Date();\n\t\tsetObj.modified_by = this.userId;\n\n\t\tif (multi > 1) {\n\t\t\tdb.instances.update({\n\t\t\t\t_id: instanceId,\n\t\t\t\t'traces._id': trace_id\n\t\t\t}, {\n\t\t\t\t$set: setObj\n\t\t\t});\n\t\t} else {\n\t\t\tdb.instances.update({\n\t\t\t\t_id: instanceId,\n\t\t\t\t'traces._id': trace_id\n\t\t\t}, {\n\t\t\t\t$set: setObj,\n\t\t\t\t$pull: {\n\t\t\t\t\tcc_users: remove_user_id\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\n\t\tpushManager.send_message_to_specifyUser(\"current_user\", remove_user_id);\n\t\treturn true;\n\t},\n\n\tcc_save: function (ins_id, description) {\n\t\tvar setObj = {};\n\n\t\tvar instance = db.instances.findOne(ins_id, {\n\t\t\tfields: {\n\t\t\t\ttraces: 1\n\t\t\t}\n\t\t});\n\t\tvar traces = instance.traces;\n\t\tvar current_user_id = this.userId;\n\n\t\tvar current_approve;\n\n\t\ttraces.forEach(function (t) {\n\t\t\tif (t.approves) {\n\t\t\t\tt.approves.forEach(function (a, idx) {\n\t\t\t\t\tif (a.handler == current_user_id && a.type == 'cc' && a.is_finished == false) {\n\t\t\t\t\t\tcurrent_approve = a;\n\t\t\t\t\t\tvar upobj = {};\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.judge'] = \"submitted\";\n\t\t\t\t\t\tupobj['traces.$.approves.' + idx + '.read_date'] = new Date();\n\t\t\t\t\t\tdb.instances.update({\n\t\t\t\t\t\t\t_id: ins_id,\n\t\t\t\t\t\t\t'traces._id': t._id\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t$set: upobj\n\t\t\t\t\t\t})\n\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t})\n\n\t\tvar index = 0;\n\n\t\t//设置意见，意见只添加到最后一条approve中\n\t\ttraces.forEach(function (t) {\n\t\t\tif (current_approve && t._id === current_approve.trace) {\n\t\t\t\tif (t.approves) {\n\t\t\t\t\tt.approves.forEach(function (a, idx) {\n\t\t\t\t\t\tif (a._id === current_approve._id) {\n\t\t\t\t\t\t\tindex = idx;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsetObj['traces.$.approves.' + index + '.description'] = description;\n\n\t\tdb.instances.update({\n\t\t\t_id: ins_id,\n\t\t\t'traces._id': current_approve.trace\n\t\t}, {\n\t\t\t$set: setObj\n\t\t});\n\n\t\treturn true;\n\t}\n})","Meteor.methods({\n\t// 改为通过api调用\n\tforward_instance: function (instance_id, space_id, flow_id, hasSaveInstanceToAttachment, description, isForwardAttachments, selectedUsers, action_type, related, from_approve_id) {\n\t\tif (!this.userId)\n\t\t\tthrow new Meteor.Error('not-authorized');\n\n\t\treturn;\n\t},\n\n\n\tforward_remove: function (instance_id, trace_id, approve_id) {\n\t\tcheck(instance_id, String);\n\t\tcheck(trace_id, String);\n\t\tcheck(approve_id, String);\n\n\t\tvar ins = db.instances.findOne(instance_id);\n\n\t\tif (!ins) {\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!');\n\t\t}\n\n\t\tvar trace = _.find(ins.traces, function (t) {\n\t\t\treturn t._id == trace_id;\n\t\t});\n\n\t\tvar approve = _.find(trace.approves, function (appr) {\n\t\t\treturn appr._id == approve_id;\n\t\t})\n\n\t\tvar hasAdminPermission = WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, this.userId)\n\n\t\tif (!approve || !['forward', 'distribute'].includes(approve.type) || !approve.forward_instance) {\n\t\t\tif (!hasAdminPermission) {\n\t\t\t\tif (approve.from_user != this.userId)\n\t\t\t\t\tthrow new Meteor.Error('error!', 'instance_forward_cannot_cancel');\n\t\t\t}\n\t\t}\n\n\t\tvar forward_instance_id = approve.forward_instance;\n\t\tvar forward_instance = db.instances.findOne(forward_instance_id);\n\t\tif (forward_instance) {\n\t\t\tif (forward_instance.state != \"draft\") {\n\t\t\t\tif (!hasAdminPermission)\n\t\t\t\t\tthrow new Meteor.Error('error!', 'instance_forward_instance_state_changed');\n\t\t\t}\n\t\t\tvar inbox_users = forward_instance.inbox_users || [];\n\n\t\t\tforward_instance.deleted = new Date();\n\t\t\tforward_instance.deleted_by = this.userId;\n\t\t\tvar deleted_forward_instance_id = db.deleted_instances.insert(forward_instance);\n\t\t\tif (deleted_forward_instance_id) {\n\t\t\t\tdb.instances.remove({\n\t\t\t\t\t_id: forward_instance_id\n\t\t\t\t});\n\n\t\t\t\t// 删除申请单后重新计算inbox_users的badge\n\t\t\t\t_.each(inbox_users, function (u_id) {\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", u_id);\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\t\tvar set_obj = new Object;\n\t\tset_obj.modified = new Date();\n\t\tset_obj.modified_by = this.userId;\n\n\t\t_.each(trace.approves, function (appr, idx) {\n\t\t\tif (appr._id == approve_id) {\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.judge'] = 'terminated';\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_finished'] = true;\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.finish_date'] = new Date();\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_read'] = true;\n\t\t\t\tset_obj['traces.$.approves.' + idx + '.read_date'] = new Date();\n\t\t\t}\n\t\t})\n\n\t\tdb.instances.update({\n\t\t\t_id: instance_id,\n\t\t\t\"traces._id\": trace_id\n\t\t}, {\n\t\t\t$set: set_obj\n\t\t})\n\n\t\treturn true;\n\t},\n\n\tcancelDistribute: function (instance_id, approve_ids) {\n\t\tcheck(instance_id, String)\n\t\tcheck(approve_ids, Array)\n\n\t\tvar ins = db.instances.findOne(instance_id)\n\n\t\tif (!ins) {\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!')\n\t\t}\n\n\t\tuserId = this.userId\n\n\t\tvar hasAdminPermission = WorkflowManager.hasFlowAdminPermission(ins.flow, ins.space, userId)\n\n\t\t_.each(ins.traces, function (t) {\n\t\t\tif (t.approves) {\n\t\t\t\tvar exists = false\n\t\t\t\tvar set_obj = new Object\n\t\t\t\t_.each(t.approves, function (a, idx) {\n\t\t\t\t\tif (approve_ids.includes(a._id) && (a.from_user == userId || hasAdminPermission) && 'distribute' == a.type && a.forward_instance) {\n\t\t\t\t\t\tvar forward_instance_id = a.forward_instance\n\t\t\t\t\t\tvar forward_instance = db.instances.findOne(forward_instance_id)\n\t\t\t\t\t\tif (forward_instance) {\n\t\t\t\t\t\t\tif (forward_instance.state != \"draft\") {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvar inbox_users = forward_instance.inbox_users || []\n\n\t\t\t\t\t\t\tforward_instance.deleted = new Date()\n\t\t\t\t\t\t\tforward_instance.deleted_by = userId\n\t\t\t\t\t\t\tvar deleted_forward_instance_id = db.deleted_instances.insert(forward_instance)\n\t\t\t\t\t\t\tif (deleted_forward_instance_id) {\n\t\t\t\t\t\t\t\tdb.instances.remove({\n\t\t\t\t\t\t\t\t\t_id: forward_instance_id\n\t\t\t\t\t\t\t\t})\n\n\t\t\t\t\t\t\t\t// 删除申请单后重新计算inbox_users的badge\n\t\t\t\t\t\t\t\t_.each(inbox_users, function (u_id) {\n\t\t\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", u_id)\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.judge'] = 'terminated'\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_finished'] = true\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.finish_date'] = new Date()\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.is_read'] = true\n\t\t\t\t\t\t\tset_obj['traces.$.approves.' + idx + '.read_date'] = new Date()\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\texists = true\n\t\t\t\t\t}\n\t\t\t\t})\n\n\t\t\t\tif (!exists)\n\t\t\t\t\treturn\n\n\t\t\t\tset_obj.modified = new Date()\n\t\t\t\tset_obj.modified_by = userId\n\n\t\t\t\tdb.instances.update({\n\t\t\t\t\t_id: instance_id,\n\t\t\t\t\t\"traces._id\": t._id\n\t\t\t\t}, {\n\t\t\t\t\t$set: set_obj\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\n\t\treturn true\n\t}\n\n\n})","Meteor.methods({\n    cfs_instances_remove: function (file_id) {\n        check(file_id, String);\n        cfs.instances.remove(file_id);\n        return true;\n    },\n\n    cfs_instances_set_current: function (file_id) {\n        check(file_id, String);\n        cfs.instances.update({\n            _id: file_id\n        }, {\n            $set: {\n                'metadata.current': true\n            }\n        });\n        return true;\n    },\n\n    cfs_instances_lock: function (file_id, user_id, user_name) {\n        cfs.instances.update({\n            _id: file_id\n        }, {\n            $set: {\n                'metadata.locked_by': user_id,\n                'metadata.locked_by_name': user_name,\n                'metadata.locked_time': new Date()\n            }\n        });\n        return true;\n    },\n\n    cfs_instances_unlock: function (file_id) {\n        cfs.instances.update({\n            _id: file_id\n        }, {\n            $unset: {\n                'metadata.locked_by': '',\n                'metadata.locked_by_name': '',\n                'metadata.locked_time': ''\n            }\n        });\n        return true;\n    },\n\n    download_space_instance_attachments_to_disk: function (spaceId, cfsRecordIds) {\n        if (!this.userId)\n            return \"不符合执行条件\"\n\n        if (Meteor.users.find({\n                _id: this.userId,\n                is_cloudadmin: true\n            }).count() < 1)\n            return \"不符合执行条件\"\n\n        check(spaceId, String);\n\n        var store = \"instances\";\n        var fs = require('fs');\n        var path = require('path');\n        var mkdirp = require('mkdirp');\n        var pathname = path.join(__meteor_bootstrap__.serverDir, '../../../cfs/spaceInstanceAttachments');\n        // Set absolute path\n        var absolutePath = path.resolve(pathname);\n        // Ensure the path exists\n        mkdirp.sync(absolutePath);\n        console.log('absolutePath: ', absolutePath);\n        console.time('download_space_instance_attachments_to_disk');\n        var query = {\n            'metadata.space': spaceId\n        }\n        if (cfsRecordIds) {\n            query._id = {\n                $in: cfsRecordIds\n            };\n        }\n        var downloadFailedRecordIds = [];\n        cfs.instances.find(query).forEach(function (c) {\n            try {\n                var fileName = store + '-' + c._id + '-' + c.name();\n                var filePath = path.join(absolutePath, fileName);\n                Meteor.wrapAsync(function (callback) {\n                    try {\n                        var writer = fs.createWriteStream(filePath);\n                        writer.on('finish', function () {\n                            if (callback && _.isFunction(callback))\n                                callback()\n                            return\n                        });\n                        var reader = c.createReadStream(store);\n                        reader.on('error', function (error) {\n                            downloadFailedRecordIds.push(c._id);\n                            console.error('download_space_instance_attachments_to_disk: ', c._id);\n                            console.error(error.stack);\n                            if (callback && _.isFunction(callback))\n                                callback()\n                            return\n                        });\n                        reader.pipe(writer);\n                    } catch (error) {\n                        console.error('download_space_instance_attachments_to_disk: ', c._id);\n                        console.error(error.stack);\n                        if (callback && _.isFunction(callback))\n                            callback()\n                        return\n                    }\n                })()\n\n            } catch (error) {\n                console.error('download_space_instance_attachments_to_disk: ', c._id);\n                console.error(error.stack);\n            }\n\n        })\n\n        if (downloadFailedRecordIds.length > 0) {\n            console.error('downloadFailedRecordIds: ');\n            console.error(downloadFailedRecordIds);\n        }\n\n        console.timeEnd('download_space_instance_attachments_to_disk');\n\n        return downloadFailedRecordIds;\n    }\n})","Meteor.methods\n\tset_approve_have_read: (instanceId, traceId, approveId) ->\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tself = this\n\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\n\n\t\tif instance?.traces?.length > 0\n\t\t\ttrace = instance.traces[0]\n\t\t\tsetObj = {\n\t\t\t\tmodified: new Date,\n\t\t\t\tmodified_by: self.userId\n\t\t\t}\n\t\t\ttrace.approves.forEach (approve, idx) ->\n\t\t\t\tif approve._id == approveId && !approve.is_read\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.is_read\"] = true\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\n\n\t\t\tif not _.isEmpty(setObj)\n\t\t\t\tdb.instances.update({\n\t\t\t\t\t_id: instanceId,\n\t\t\t\t\t\"traces._id\": traceId\n\t\t\t\t}, {\n\t\t\t\t\t$set: setObj\n\t\t\t\t})\n\t\t\treturn true\n\n\tchange_approve_info: (instanceId, traceId, approveId, description, finish_date) ->\n\t\tif !this.userId\n\t\t\treturn\n\t\tcheck(instanceId, String)\n\t\tcheck(traceId, String)\n\t\tcheck(approveId, String)\n\t\tcheck(description, String)\n\t\tcheck(finish_date, Date)\n\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\n\n\t\tif instance?.traces?.length > 0\n\t\t\ttrace = instance.traces[0]\n\t\t\tsetObj = {}\n\t\t\ttrace.approves.forEach (approve, idx) ->\n\t\t\t\tif approve._id == approveId\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.description\"] = description\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.finish_date\"] = finish_date\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.cost_time\"] = new Date() - approve.start_date\n\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\n\n\t\t\tif not _.isEmpty(setObj)\n\t\t\t\tdb.instances.update({\n\t\t\t\t\t_id: instanceId,\n\t\t\t\t\t\"traces._id\": traceId\n\t\t\t\t}, {\n\t\t\t\t\t$set: setObj\n\t\t\t\t})\n\t\t\treturn true\n\n\tupdate_approve_sign: (instanceId, traceId, approveId, sign_field_code, description, sign_type, lastSignApprove)->\n\t\tcheck(instanceId, String)\n\t\tcheck(traceId, String)\n\t\tcheck(approveId, String)\n\t\tcheck(sign_field_code, String)\n\t\tcheck(description, String)\n\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tsession_userId = this.userId\n\n\t\tif lastSignApprove\n\n\t\t\tif lastSignApprove.custom_sign_show\n\t\t\t\treturn\n\n\t\t\tinstance = db.instances.findOne({\n\t\t\t\t_id: instanceId,\n\t\t\t\t\"traces._id\": lastSignApprove.trace\n\t\t\t}, { fields: { \"traces.$\": 1 } })\n\n\t\t\tlastTrace = _.find instance?.traces, (t) ->\n\t\t\t\treturn t._id = lastSignApprove.trace\n\n\t\t\tif lastTrace\n\t\t\t\tsetObj = {}\n\t\t\t\tlastTrace?.approves.forEach (a, idx) ->\n\t\t\t\t\tif a._id == lastSignApprove._id\n\t\t\t\t\t\tif sign_type == \"update\"\n\t\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.sign_show\"] = false\n\t\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.modified\"] = new Date()\n\t\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.modified_by\"] = session_userId\n\n\t\t\t\tif not _.isEmpty(setObj)\n\t\t\t\t\tdb.instances.update({\n\t\t\t\t\t\t_id: instanceId,\n\t\t\t\t\t\t\"traces._id\": lastTrace._id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: setObj\n\t\t\t\t\t})\n\n\t\tinstance = db.instances.findOne({ _id: instanceId, \"traces._id\": traceId }, { fields: { \"traces.$\": 1 } })\n\n\t\tif instance?.traces?.length > 0\n\n\t\t\ttrace = instance.traces[0]\n\t\t\tupObj = {}\n\t\t\ttrace.approves.forEach (approve, idx) ->\n\t\t\t\tif approve._id == approveId\n\t\t\t\t\tif sign_field_code\n\t\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.sign_field_code\"] = sign_field_code\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.description\"] = description\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.sign_show\"] = true\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.modified\"] = new Date()\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.modified_by\"] = session_userId\n\t\t\t\t\tupObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\n\n\t\t\tif not _.isEmpty(upObj)\n\t\t\t\tdb.instances.update({\n\t\t\t\t\t_id: instanceId,\n\t\t\t\t\t\"traces._id\": traceId\n\t\t\t\t}, {\n\t\t\t\t\t$set: upObj\n\t\t\t\t})\n\t\t\treturn true\n\n\n\tupdate_sign_show: (objs, myApprove_id) ->\n\t\tobjs.forEach (obj, index) ->\n\t\t\tinstance = db.instances.findOne({ _id: obj.instance, \"traces._id\": obj.trace }, { fields: { \"traces.$\": 1 } })\n\t\t\tif instance?.traces?.length > 0\n\t\t\t\ttrace = instance.traces[0]\n\t\t\t\tsetObj = {}\n\t\t\t\ttrace.approves.forEach (approve, idx) ->\n\t\t\t\t\tif approve._id == obj._id\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.sign_show\"] = obj.sign_show\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.custom_sign_show\"] = obj.sign_show\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\n\n\t\t\t\t\tif approve._id == myApprove_id\n\t\t\t\t\t\tsetObj[\"traces.$.approves.#{idx}.read_date\"] = new Date()\n\n\t\t\t\tif not _.isEmpty(setObj)\n\t\t\t\t\tdb.instances.update({\n\t\t\t\t\t\t_id: obj.instance,\n\t\t\t\t\t\t\"traces._id\": obj.trace\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: setObj\n\t\t\t\t\t})\n\n\t\treturn true\n","Meteor.methods({\n  set_approve_have_read: function(instanceId, traceId, approveId) {\n    var instance, ref, self, setObj, trace;\n    if (!this.userId) {\n      return;\n    }\n    self = this;\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      setObj = {\n        modified: new Date,\n        modified_by: self.userId\n      };\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId && !approve.is_read) {\n          setObj[\"traces.$.approves.\" + idx + \".is_read\"] = true;\n          return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (!_.isEmpty(setObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: setObj\n        });\n      }\n      return true;\n    }\n  },\n  change_approve_info: function(instanceId, traceId, approveId, description, finish_date) {\n    var instance, ref, setObj, trace;\n    if (!this.userId) {\n      return;\n    }\n    check(instanceId, String);\n    check(traceId, String);\n    check(approveId, String);\n    check(description, String);\n    check(finish_date, Date);\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      setObj = {};\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId) {\n          setObj[\"traces.$.approves.\" + idx + \".description\"] = description;\n          setObj[\"traces.$.approves.\" + idx + \".finish_date\"] = finish_date;\n          setObj[\"traces.$.approves.\" + idx + \".cost_time\"] = new Date() - approve.start_date;\n          return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (!_.isEmpty(setObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: setObj\n        });\n      }\n      return true;\n    }\n  },\n  update_approve_sign: function(instanceId, traceId, approveId, sign_field_code, description, sign_type, lastSignApprove) {\n    var instance, lastTrace, ref, session_userId, setObj, trace, upObj;\n    check(instanceId, String);\n    check(traceId, String);\n    check(approveId, String);\n    check(sign_field_code, String);\n    check(description, String);\n    if (!this.userId) {\n      return;\n    }\n    session_userId = this.userId;\n    if (lastSignApprove) {\n      if (lastSignApprove.custom_sign_show) {\n        return;\n      }\n      instance = db.instances.findOne({\n        _id: instanceId,\n        \"traces._id\": lastSignApprove.trace\n      }, {\n        fields: {\n          \"traces.$\": 1\n        }\n      });\n      lastTrace = _.find(instance != null ? instance.traces : void 0, function(t) {\n        return t._id = lastSignApprove.trace;\n      });\n      if (lastTrace) {\n        setObj = {};\n        if (lastTrace != null) {\n          lastTrace.approves.forEach(function(a, idx) {\n            if (a._id === lastSignApprove._id) {\n              if (sign_type === \"update\") {\n                setObj[\"traces.$.approves.\" + idx + \".sign_show\"] = false;\n                setObj[\"traces.$.approves.\" + idx + \".modified\"] = new Date();\n                return setObj[\"traces.$.approves.\" + idx + \".modified_by\"] = session_userId;\n              }\n            }\n          });\n        }\n        if (!_.isEmpty(setObj)) {\n          db.instances.update({\n            _id: instanceId,\n            \"traces._id\": lastTrace._id\n          }, {\n            $set: setObj\n          });\n        }\n      }\n    }\n    instance = db.instances.findOne({\n      _id: instanceId,\n      \"traces._id\": traceId\n    }, {\n      fields: {\n        \"traces.$\": 1\n      }\n    });\n    if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n      trace = instance.traces[0];\n      upObj = {};\n      trace.approves.forEach(function(approve, idx) {\n        if (approve._id === approveId) {\n          if (sign_field_code) {\n            upObj[\"traces.$.approves.\" + idx + \".sign_field_code\"] = sign_field_code;\n          }\n          upObj[\"traces.$.approves.\" + idx + \".description\"] = description;\n          upObj[\"traces.$.approves.\" + idx + \".sign_show\"] = true;\n          upObj[\"traces.$.approves.\" + idx + \".modified\"] = new Date();\n          upObj[\"traces.$.approves.\" + idx + \".modified_by\"] = session_userId;\n          return upObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n        }\n      });\n      if (!_.isEmpty(upObj)) {\n        db.instances.update({\n          _id: instanceId,\n          \"traces._id\": traceId\n        }, {\n          $set: upObj\n        });\n      }\n      return true;\n    }\n  },\n  update_sign_show: function(objs, myApprove_id) {\n    objs.forEach(function(obj, index) {\n      var instance, ref, setObj, trace;\n      instance = db.instances.findOne({\n        _id: obj.instance,\n        \"traces._id\": obj.trace\n      }, {\n        fields: {\n          \"traces.$\": 1\n        }\n      });\n      if ((instance != null ? (ref = instance.traces) != null ? ref.length : void 0 : void 0) > 0) {\n        trace = instance.traces[0];\n        setObj = {};\n        trace.approves.forEach(function(approve, idx) {\n          if (approve._id === obj._id) {\n            setObj[\"traces.$.approves.\" + idx + \".sign_show\"] = obj.sign_show;\n            setObj[\"traces.$.approves.\" + idx + \".custom_sign_show\"] = obj.sign_show;\n            setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n          }\n          if (approve._id === myApprove_id) {\n            return setObj[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n          }\n        });\n        if (!_.isEmpty(setObj)) {\n          return db.instances.update({\n            _id: obj.instance,\n            \"traces._id\": obj.trace\n          }, {\n            $set: setObj\n          });\n        }\n      }\n    });\n    return true;\n  }\n});\n","Meteor.methods\n\tinstance_return: (approve, reason)->\n\t\tcheck(approve, Object)\n\n\t\tcurrent_user = this.userId\n\t\tinstance_id = approve.instance\n\n\t\tins = uuflowManager.getInstance(instance_id)\n\t\tspace_id = ins.space\n\n\t\t# - 待审核箱\n\t\tif ins.state isnt \"pending\" or !ins.inbox_users.includes(current_user)\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\n\t\t# - 文件不是传阅\n\t\tif approve.type is \"cc\" and ins.cc_users.includes(current_user)\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\n\t\t# - 签核历程中当前步骤上一步骤不是会签\n\t\tif ins.traces.length < 2\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\t\tflow = uuflowManager.getFlow(ins.flow)\n\t\tpre_trace = ins.traces[ins.traces.length - 2]\n\t\tpre_step = uuflowManager.getStep(ins, flow, pre_trace.step)\n\t\tif pre_step.step_type is \"counterSign\"\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\n\t\t# - 当前步骤为填写或者审批\n\t\tlast_trace = _.last(ins.traces)\n\t\tcurrent_step = uuflowManager.getStep(ins, flow, last_trace.step)\n\t\tif current_step.step_type isnt \"submit\" and current_step.step_type isnt \"sign\" and current_step.step_type isnt \"counterSign\"\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\n\t\t# - 参数approve中trace与当前获取的trace是否匹配\n\t\tif approve.trace isnt last_trace._id\n\t\t\tthrow new Meteor.Error('error!', \"不符合退回条件\")\n\n\t\tnew_inbox_users = new Array\n\t\t_.each pre_trace.approves, (a)->\n\t\t\tif (!a.type or a.type is \"draft\" or a.type is \"reassign\") and (!a.judge or a.judge is \"submitted\" or a.judge is \"approved\" or a.judge is \"rejected\")\n\t\t\t\tnew_inbox_users.push(a.user)\n\n\t\tif _.isEmpty(new_inbox_users)\n\t\t\tthrow new Meteor.Error('error!', \"未找到下一步处理人，退回失败\")\n\n\t\ttraces = ins.traces\n\n\t\tapprove_values = uuflowManager.getApproveValues(approve.values || {}, current_step.permissions, ins.form, ins.form_version)\n\n\t\tsetObj = new Object\n\t\tnow = new Date\n\t\trest_counter_users = new Array\n\t\t_.each traces, (t)->\n\t\t\tif t._id is last_trace._id\n\t\t\t\tif not t.approves\n\t\t\t\t\tt.approves = new Array\n\t\t\t\t_.each t.approves, (a, idx)->\n\t\t\t\t\tif (!a.type or a.type is \"reassign\") and (!a.judge or a.judge is \"submitted\" or a.judge is \"approved\" or a.judge is \"rejected\" or a.judge is \"readed\") and a.is_finished isnt true\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.finish_date'] = now\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.read_date'] = now\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_error'] = false\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_read'] = true\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.is_finished'] = true\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.cost_time'] = now - a.start_date\n\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.values'] = approve_values\n\t\t\t\t\t\tif a.handler is current_user\n\t\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.judge'] = \"returned\"\n\t\t\t\t\t\t\tsetObj['traces.$.approves.' + idx + '.description'] = reason\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\trest_counter_users.push a.handler\n\n\t\t\t\t# 更新当前trace记录\n\t\t\t\tsetObj['traces.$.is_finished'] = true\n\t\t\t\tsetObj['traces.$.finish_date'] = true\n\t\t\t\tsetObj['traces.$.judge'] = \"returned\"\n\n\t\tins.values = _.extend((ins.values || {}), approve_values)\n\n\t\t# 插入下一步trace记录\n\t\tnewTrace = new Object\n\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\tnewTrace.instance = instance_id\n\t\tnewTrace.previous_trace_ids = [last_trace._id]\n\t\tnewTrace.is_finished = false\n\t\tnewTrace.step = pre_trace.step\n\t\tnewTrace.name = pre_trace.name\n\t\tnewTrace.start_date = now\n\t\tnewTrace.due_date = uuflowManager.getDueDate(pre_step.timeout_hours)\n\t\tnewTrace.approves = []\n\t\t_.each new_inbox_users, (next_step_user_id, idx)->\n\t\t\t# 插入下一步trace.approve记录\n\t\t\tnewApprove = new Object\n\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\tnewApprove.instance = instance_id\n\t\t\tnewApprove.trace = newTrace._id\n\t\t\tnewApprove.is_finished = false\n\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\tuser_info = db.users.findOne(next_step_user_id, {fields: {name: 1}})\n\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\thandler_id = next_step_user_id\n\t\t\thandler_info = user_info\n\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\tif agent\n\t\t\t\tnew_inbox_users[idx] = agent\n\t\t\t\thandler_id = agent\n\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\tnewApprove.agent = agent\n\n\t\t\tnewApprove.handler = handler_id\n\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\n\t\t\t# 获取next_step_user所在的部门信息\n\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\n\t\t\tnewApprove.start_date = now\n\t\t\tnewApprove.is_read = false\n\t\t\tnewApprove.is_error = false\n\t\t\tnewApprove.values = new Object\n\t\t\tuuflowManager.setRemindInfo(ins.values, newApprove)\n\t\t\tnewTrace.approves.push(newApprove)\n\n\t\tsetObj.inbox_users = new_inbox_users\n\t\tsetObj.state = \"pending\"\n\n\t\tins.outbox_users.push(current_user)\n\t\tsetObj.outbox_users = _.uniq(ins.outbox_users)\n\t\tsetObj.modified = now\n\t\tsetObj.modified_by = current_user\n\t\tsetObj.values = ins.values\n\n\t\tsetObj.current_step_name = pre_trace.name\n\n\t\tr = db.instances.update({_id: instance_id, 'traces._id': last_trace._id}, {$set: setObj})\n\t\tb = db.instances.update({_id: instance_id}, {$push: {traces: newTrace}})\n\t\tif r && b\n\t\t\t# 新inbox_users 和 当前用户 发送push\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user)\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\n\t\t\tcurrent_user_info = db.users.findOne(current_user)\n\t\t\tpushManager.send_instance_notification(\"return_pending_inbox\", instance, reason, current_user_info)\n\t\t\t# 如果是会签则给会签未提交的人发送push\n\t\t\t_.each rest_counter_users, (user_id)->\n\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\treturn true","Meteor.methods({\n  instance_return: function(approve, reason) {\n    var approve_values, b, current_step, current_user, current_user_info, flow, ins, instance, instance_id, last_trace, newTrace, new_inbox_users, now, pre_step, pre_trace, r, rest_counter_users, setObj, space_id, traces;\n    check(approve, Object);\n    current_user = this.userId;\n    instance_id = approve.instance;\n    ins = uuflowManager.getInstance(instance_id);\n    space_id = ins.space;\n    if (ins.state !== \"pending\" || !ins.inbox_users.includes(current_user)) {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    if (approve.type === \"cc\" && ins.cc_users.includes(current_user)) {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    if (ins.traces.length < 2) {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    flow = uuflowManager.getFlow(ins.flow);\n    pre_trace = ins.traces[ins.traces.length - 2];\n    pre_step = uuflowManager.getStep(ins, flow, pre_trace.step);\n    if (pre_step.step_type === \"counterSign\") {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    last_trace = _.last(ins.traces);\n    current_step = uuflowManager.getStep(ins, flow, last_trace.step);\n    if (current_step.step_type !== \"submit\" && current_step.step_type !== \"sign\" && current_step.step_type !== \"counterSign\") {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    if (approve.trace !== last_trace._id) {\n      throw new Meteor.Error('error!', \"不符合退回条件\");\n    }\n    new_inbox_users = new Array;\n    _.each(pre_trace.approves, function(a) {\n      if ((!a.type || a.type === \"draft\" || a.type === \"reassign\") && (!a.judge || a.judge === \"submitted\" || a.judge === \"approved\" || a.judge === \"rejected\")) {\n        return new_inbox_users.push(a.user);\n      }\n    });\n    if (_.isEmpty(new_inbox_users)) {\n      throw new Meteor.Error('error!', \"未找到下一步处理人，退回失败\");\n    }\n    traces = ins.traces;\n    approve_values = uuflowManager.getApproveValues(approve.values || {}, current_step.permissions, ins.form, ins.form_version);\n    setObj = new Object;\n    now = new Date;\n    rest_counter_users = new Array;\n    _.each(traces, function(t) {\n      if (t._id === last_trace._id) {\n        if (!t.approves) {\n          t.approves = new Array;\n        }\n        _.each(t.approves, function(a, idx) {\n          if ((!a.type || a.type === \"reassign\") && (!a.judge || a.judge === \"submitted\" || a.judge === \"approved\" || a.judge === \"rejected\" || a.judge === \"readed\") && a.is_finished !== true) {\n            setObj['traces.$.approves.' + idx + '.finish_date'] = now;\n            setObj['traces.$.approves.' + idx + '.read_date'] = now;\n            setObj['traces.$.approves.' + idx + '.is_error'] = false;\n            setObj['traces.$.approves.' + idx + '.is_read'] = true;\n            setObj['traces.$.approves.' + idx + '.is_finished'] = true;\n            setObj['traces.$.approves.' + idx + '.cost_time'] = now - a.start_date;\n            setObj['traces.$.approves.' + idx + '.values'] = approve_values;\n            if (a.handler === current_user) {\n              setObj['traces.$.approves.' + idx + '.judge'] = \"returned\";\n              return setObj['traces.$.approves.' + idx + '.description'] = reason;\n            } else {\n              return rest_counter_users.push(a.handler);\n            }\n          }\n        });\n        setObj['traces.$.is_finished'] = true;\n        setObj['traces.$.finish_date'] = true;\n        return setObj['traces.$.judge'] = \"returned\";\n      }\n    });\n    ins.values = _.extend(ins.values || {}, approve_values);\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [last_trace._id];\n    newTrace.is_finished = false;\n    newTrace.step = pre_trace.step;\n    newTrace.name = pre_trace.name;\n    newTrace.start_date = now;\n    newTrace.due_date = uuflowManager.getDueDate(pre_step.timeout_hours);\n    newTrace.approves = [];\n    _.each(new_inbox_users, function(next_step_user_id, idx) {\n      var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n      newApprove = new Object;\n      newApprove._id = new Mongo.ObjectID()._str;\n      newApprove.instance = instance_id;\n      newApprove.trace = newTrace._id;\n      newApprove.is_finished = false;\n      newApprove.user = next_step_user_id;\n      user_info = db.users.findOne(next_step_user_id, {\n        fields: {\n          name: 1\n        }\n      });\n      newApprove.user_name = user_info.name;\n      handler_id = next_step_user_id;\n      handler_info = user_info;\n      agent = uuflowManager.getAgent(space_id, next_step_user_id);\n      if (agent) {\n        new_inbox_users[idx] = agent;\n        handler_id = agent;\n        handler_info = db.users.findOne({\n          _id: agent\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        newApprove.agent = agent;\n      }\n      newApprove.handler = handler_id;\n      newApprove.handler_name = handler_info.name;\n      next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n      next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n      newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n      newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n      newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n      newApprove.start_date = now;\n      newApprove.is_read = false;\n      newApprove.is_error = false;\n      newApprove.values = new Object;\n      uuflowManager.setRemindInfo(ins.values, newApprove);\n      return newTrace.approves.push(newApprove);\n    });\n    setObj.inbox_users = new_inbox_users;\n    setObj.state = \"pending\";\n    ins.outbox_users.push(current_user);\n    setObj.outbox_users = _.uniq(ins.outbox_users);\n    setObj.modified = now;\n    setObj.modified_by = current_user;\n    setObj.values = ins.values;\n    setObj.current_step_name = pre_trace.name;\n    r = db.instances.update({\n      _id: instance_id,\n      'traces._id': last_trace._id\n    }, {\n      $set: setObj\n    });\n    b = db.instances.update({\n      _id: instance_id\n    }, {\n      $push: {\n        traces: newTrace\n      }\n    });\n    if (r && b) {\n      pushManager.send_message_to_specifyUser(\"current_user\", current_user);\n      instance = uuflowManager.getInstance(instance_id);\n      current_user_info = db.users.findOne(current_user);\n      pushManager.send_instance_notification(\"return_pending_inbox\", instance, reason, current_user_info);\n      _.each(rest_counter_users, function(user_id) {\n        return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n      });\n    }\n    return true;\n  }\n});\n","Meteor.methods\n\tinstance_remind: (remind_users, remind_count, remind_deadline, instance_id, action_types, trace_id)->\n\t\tcheck remind_users, Array\n\t\tcheck remind_count, Match.OneOf('single', 'multi')\n\t\tcheck remind_deadline, Date\n\t\tcheck instance_id, String\n\t\tcheck action_types, Array\n\t\tcheck trace_id, String\n\n\t\tcurrent_user_id = this.userId\n\t\tlast_remind_users = new Array\n\t\tins = db.instances.findOne({_id: instance_id}, {fields: {name: 1, traces: 1, values: 1, space: 1}})\n\t\tif action_types.includes('admin')\n\t\t\tif remind_count is 'single'\n\t\t\t\t_.each ins.traces, (t)->\n\t\t\t\t\t_.each t.approves, (ap)->\n\t\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\n\t\t\t\t\t\t\tlast_remind_users.push ap.user\n\t\t\telse if remind_count is 'multi'\n\t\t\t\tnow = new Date\n\t\t\t\tpriority = ins.values.priority\n\t\t\t\t_.each ins.traces, (t)->\n\t\t\t\t\t_.each t.approves, (ap)->\n\t\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\n\t\t\t\t\t\t\tlast_remind_users.push ap.user\n\t\t\t\t\t\t\tap.manual_deadline = remind_deadline\n\t\t\t\t\t\t\t# （1）“普通”：如三个工作日内未处理，系统自动发短信提醒：办结时限为二日内；\n\t\t\t\t\t\t\t#  如二日后仍未处理，系统每天自动发短信提醒，办结时限为一日内。\n\t\t\t\t\t\t\tif priority is \"普通\" or not priority\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t# （2）“办文”：如一个工作日内未处理，系统自动发短信提醒：办结时限为表单上的“办结时限”（文书录入的时间）；\n\t\t\t\t\t\t\t#  如一日后仍未处理，系统每天自动发短信提醒：办结时限不变；\n\t\t\t\t\t\t\t#  距离办结时限为半日时，则每半个工作日提醒四次；超过办结时限后仍然按照每半日四次提醒。\n\t\t\t\t\t\t\telse if priority is \"办文\"\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # 超过了办结时限或者距离办结时限半日内\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\n\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\n\n\t\t\t\t\t\t\t# （3）“紧急”：在发送的同时，系统自动发短信提醒：办结时限为表单上的“办结时限”（文书录入的时间）；\n\t\t\t\t\t\t\t#  如半日内仍未处理，系统每半天自动发短信提醒：办结时限不变；距离办结时限为半日时，每半个工作日提醒四次；超过办结时限后仍然按照每半日四次提醒。\n\t\t\t\t\t\t\telse if priority is \"紧急\"\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # 超过了办结时限或者距离办结时限半日内\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\n\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\n\n\t\t\t\t\t\t\t# （4）“特急”：在发送的同时，系统自动发短信提醒：办结时限为表单上的“办结时限”（文书录入的时间）；\n\t\t\t\t\t\t\t#  如半日内仍未处理，系统每半个工作日提醒四次：办结时限不变；超过办结时限后仍然按照每半日四次提醒。\n\t\t\t\t\t\t\telse if priority is \"特急\"\n\t\t\t\t\t\t\t\tif Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline # 超过了办结时限或者距离办结时限半日内\n\t\t\t\t\t\t\t\t\tap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true)\n\t\t\t\t\t\t\t\telse if Steedos.caculateWorkingTime(now, 1) > remind_deadline\n\t\t\t\t\t\t\t\t\tcaculate_date = (base_date)->\n\t\t\t\t\t\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\n\t\t\t\t\t\t\t\t\t\tif plus_halfday_date > remind_deadline\n\t\t\t\t\t\t\t\t\t\t\tap.remind_date = base_date\n\t\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\n\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\tcaculate_date(now)\n\n\t\t\t\tif not _.isEmpty(last_remind_users)\n\t\t\t\t\tdb.instances.update({_id: instance_id}, {$set: {'traces': ins.traces}})\n\n\t\telse if action_types.includes('applicant')\n\t\t\ttrace = _.find ins.traces, (t)->\n\t\t\t\treturn t._id is trace_id\n\t\t\t_.each trace.approves, (ap)->\n\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true\n\t\t\t\t\tlast_remind_users.push ap.user\n\n\t\telse if action_types.includes('cc')\n\t\t\t_.each ins.traces, (t)->\n\t\t\t\t_.each t.approves, (ap)->\n\t\t\t\t\tif remind_users.includes(ap.user) and ap.is_finished isnt true and ap.type is 'cc' and ap.from_user is current_user_id\n\t\t\t\t\t\tlast_remind_users.push ap.user\n\n\t\tuuflowManager.sendRemindSMS ins.name, remind_deadline, last_remind_users, ins.space, ins._id\n\n\t\treturn true\n","Meteor.methods({\n  instance_remind: function(remind_users, remind_count, remind_deadline, instance_id, action_types, trace_id) {\n    var current_user_id, ins, last_remind_users, now, priority, trace;\n    check(remind_users, Array);\n    check(remind_count, Match.OneOf('single', 'multi'));\n    check(remind_deadline, Date);\n    check(instance_id, String);\n    check(action_types, Array);\n    check(trace_id, String);\n    current_user_id = this.userId;\n    last_remind_users = new Array;\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        name: 1,\n        traces: 1,\n        values: 1,\n        space: 1\n      }\n    });\n    if (action_types.includes('admin')) {\n      if (remind_count === 'single') {\n        _.each(ins.traces, function(t) {\n          return _.each(t.approves, function(ap) {\n            if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n              return last_remind_users.push(ap.user);\n            }\n          });\n        });\n      } else if (remind_count === 'multi') {\n        now = new Date;\n        priority = ins.values.priority;\n        _.each(ins.traces, function(t) {\n          return _.each(t.approves, function(ap) {\n            var caculate_date;\n            if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n              last_remind_users.push(ap.user);\n              ap.manual_deadline = remind_deadline;\n              if (priority === \"普通\" || !priority) {\n\n              } else if (priority === \"办文\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              } else if (priority === \"紧急\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              } else if (priority === \"特急\") {\n                if (Steedos.caculatePlusHalfWorkingDay(now) > remind_deadline) {\n                  return ap.remind_date = Steedos.caculatePlusHalfWorkingDay(now, true);\n                } else if (Steedos.caculateWorkingTime(now, 1) > remind_deadline) {\n                  caculate_date = function(base_date) {\n                    var plus_halfday_date;\n                    plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n                    if (plus_halfday_date > remind_deadline) {\n                      ap.remind_date = base_date;\n                    } else {\n                      caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n                    }\n                  };\n                  return caculate_date(now);\n                }\n              }\n            }\n          });\n        });\n        if (!_.isEmpty(last_remind_users)) {\n          db.instances.update({\n            _id: instance_id\n          }, {\n            $set: {\n              'traces': ins.traces\n            }\n          });\n        }\n      }\n    } else if (action_types.includes('applicant')) {\n      trace = _.find(ins.traces, function(t) {\n        return t._id === trace_id;\n      });\n      _.each(trace.approves, function(ap) {\n        if (remind_users.includes(ap.user) && ap.is_finished !== true) {\n          return last_remind_users.push(ap.user);\n        }\n      });\n    } else if (action_types.includes('cc')) {\n      _.each(ins.traces, function(t) {\n        return _.each(t.approves, function(ap) {\n          if (remind_users.includes(ap.user) && ap.is_finished !== true && ap.type === 'cc' && ap.from_user === current_user_id) {\n            return last_remind_users.push(ap.user);\n          }\n        });\n      });\n    }\n    uuflowManager.sendRemindSMS(ins.name, remind_deadline, last_remind_users, ins.space, ins._id);\n    return true;\n  }\n});\n","Meteor.methods\n\tnext_step_users_not_found: (deal_type, step_name, params) ->\n\t\tcheck deal_type, String\n\t\tcheck step_name, String\n\t\tcheck params, Object\n\n\t\tstr = \"\"\n\t\tuser = db.users.findOne({ _id: this.userId }, { fields: { locale: 1 } })\n\t\t#设置当前语言环境\n\t\tlang = 'en'\n\t\tif user.locale is 'zh-cn'\n\t\t\tlang = 'zh-CN'\n\n\t\t# 指定审批岗位\n\t\tif deal_type is 'applicantRole'\n\t\t\tapprover_roles = params.approver_roles\n\t\t\troles = db.flow_roles.find({ _id: { $in: approver_roles } }, { fields: { name: 1 } }).fetch()\n\t\t\troles_name = _.pluck(roles, 'name').toString()\n\t\t\tstr = TAPi18n.__ 'next_step_users_not_found.applicant_role', { step_name: step_name, role_name: roles_name }, lang\n\n\n\t\treturn str\n","Meteor.methods({\n  next_step_users_not_found: function(deal_type, step_name, params) {\n    var approver_roles, lang, roles, roles_name, str, user;\n    check(deal_type, String);\n    check(step_name, String);\n    check(params, Object);\n    str = \"\";\n    user = db.users.findOne({\n      _id: this.userId\n    }, {\n      fields: {\n        locale: 1\n      }\n    });\n    lang = 'en';\n    if (user.locale === 'zh-cn') {\n      lang = 'zh-CN';\n    }\n    if (deal_type === 'applicantRole') {\n      approver_roles = params.approver_roles;\n      roles = db.flow_roles.find({\n        _id: {\n          $in: approver_roles\n        }\n      }, {\n        fields: {\n          name: 1\n        }\n      }).fetch();\n      roles_name = _.pluck(roles, 'name').toString();\n      str = TAPi18n.__('next_step_users_not_found.applicant_role', {\n        step_name: step_name,\n        role_name: roles_name\n      }, lang);\n    }\n    return str;\n  }\n});\n","_eval = require('eval')\n\nMeteor.methods\n\tinstanceNumberBuilder: (spaceId, name)->\n\n\t\tnumberRules = db.instance_number_rules.findOne({space: spaceId, name: name})\n\n\t\tif !numberRules\n\t\t\tthrow new  Meteor.Error('error!', \"#{name}\")\n\n\t\tdate = new Date()\n\n\t\tcontext = {}\n\n\t\tcontext._ = _\n\n\t\t_YYYY = date.getFullYear()\n\n\t\t_NUMBER = (numberRules.number || 0) + 1\n\n\t\tcontext.YYYY = _.clone(_YYYY)\n\n\t\tcontext.MM = date.getMonth() + 1\n\n\t\tcontext.mm = date.getMonth() + 1\n\n\t\tif context.MM < 10\n\t\t\tcontext.MM = \"0\" + context.MM\n\n\t\tcontext.DD = date.getDate()\n\n\t\tcontext.dd = date.getDate()\n\n\t\tif context.DD < 10\n\t\t\tcontext.DD = \"0\" + context.DD\n\n\t\tif context.YYYY != numberRules.year\n\t\t\t_NUMBER = numberRules.first_number || 1\n\n\t\tcontext.NUMBER = _.clone(_NUMBER)\n\n\t\trules = numberRules.rules.replace(\"{YYYY}\", \"' + YYYY + '\").replace(\"{MM}\", \"' + MM + '\").replace(\"{NUMBER}\", \"' + NUMBER + '\")\n\n\t\tscript = \"var newNo = '#{rules}'; exports.newNo = newNo\";\n\n\t\ttry\n\t\t\tres = _eval(script, \"newNo\", context, false).newNo\n\n\t\t\tdb.instance_number_rules.update({_id: numberRules._id}, {$set: {year: _YYYY, number: _NUMBER}})\n\n\t\t\tconsole.log this.userId, res\n\n\t\tcatch e\n\t\t\tres = {_error: e}\n\n\t\treturn res;\n","var _eval;\n\n_eval = require('eval');\n\nMeteor.methods({\n  instanceNumberBuilder: function(spaceId, name) {\n    var _NUMBER, _YYYY, context, date, e, numberRules, res, rules, script;\n    numberRules = db.instance_number_rules.findOne({\n      space: spaceId,\n      name: name\n    });\n    if (!numberRules) {\n      throw new Meteor.Error('error!', \"\" + name);\n    }\n    date = new Date();\n    context = {};\n    context._ = _;\n    _YYYY = date.getFullYear();\n    _NUMBER = (numberRules.number || 0) + 1;\n    context.YYYY = _.clone(_YYYY);\n    context.MM = date.getMonth() + 1;\n    context.mm = date.getMonth() + 1;\n    if (context.MM < 10) {\n      context.MM = \"0\" + context.MM;\n    }\n    context.DD = date.getDate();\n    context.dd = date.getDate();\n    if (context.DD < 10) {\n      context.DD = \"0\" + context.DD;\n    }\n    if (context.YYYY !== numberRules.year) {\n      _NUMBER = numberRules.first_number || 1;\n    }\n    context.NUMBER = _.clone(_NUMBER);\n    rules = numberRules.rules.replace(\"{YYYY}\", \"' + YYYY + '\").replace(\"{MM}\", \"' + MM + '\").replace(\"{NUMBER}\", \"' + NUMBER + '\");\n    script = \"var newNo = '\" + rules + \"'; exports.newNo = newNo\";\n    try {\n      res = _eval(script, \"newNo\", context, false).newNo;\n      db.instance_number_rules.update({\n        _id: numberRules._id\n      }, {\n        $set: {\n          year: _YYYY,\n          number: _NUMBER\n        }\n      });\n      console.log(this.userId, res);\n    } catch (error) {\n      e = error;\n      res = {\n        _error: e\n      };\n    }\n    return res;\n  }\n});\n","Meteor.methods\n\tcheck_main_attach: (ins_id, name)->\n\t\tcheck ins_id, String\n\t\tuuflowManager.checkMainAttach(ins_id, name)\n\t\treturn 'success'\n\n","Meteor.methods\n\tremove_related: (ins_id, re_ins_id)->\n\t\tcheck(ins_id, String)\n\t\tcheck(re_ins_id, String)\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tins = db.instances.findOne({_id: ins_id}, {fields: {related_instances: 1}})\n\n\t\tif ins\n\t\t\tres = ins.related_instances || []\n\n\t\t\tindex = res.indexOf(re_ins_id)\n\n\t\t\tif index > -1\n\t\t\t\tres.remove(index)\n\n\t\t\tset_obj = new Object;\n\t\t\tset_obj.modified = new Date();\n\t\t\tset_obj.modified_by = this.userId;\n\t\t\tset_obj.related_instances = res\n\n\t\t\tdb.instances.update({_id: ins_id}, {$set: set_obj})\n\n\tupdate_instance_related: (ins_id, related_instances)->\n\t\tcheck(ins_id, String)\n\t\tcheck(related_instances, Array)\n\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tins = db.instances.findOne({_id: ins_id, $or: [{submitter: this.userId}, {applicant: this.userId}, {inbox_users: this.userId}, {cc_users: this.userId}]}, {fields: {state: 1}})\n\n\t\tif ins\n\t\t\tset_obj = new Object;\n\t\t\tset_obj.modified = new Date();\n\t\t\tset_obj.modified_by = this.userId;\n\t\t\tset_obj.related_instances = related_instances\n\t\t\tdb.instances.update({_id: ins_id}, {$set: set_obj})\n\n\t\treturn db.instances.find({_id: {$in:  related_instances}}, {fields: {_id: 1, values: 1}}).fetch()\n","Meteor.methods({\n  remove_related: function(ins_id, re_ins_id) {\n    var index, ins, res, set_obj;\n    check(ins_id, String);\n    check(re_ins_id, String);\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        related_instances: 1\n      }\n    });\n    if (ins) {\n      res = ins.related_instances || [];\n      index = res.indexOf(re_ins_id);\n      if (index > -1) {\n        res.remove(index);\n      }\n      set_obj = new Object;\n      set_obj.modified = new Date();\n      set_obj.modified_by = this.userId;\n      set_obj.related_instances = res;\n      return db.instances.update({\n        _id: ins_id\n      }, {\n        $set: set_obj\n      });\n    }\n  },\n  update_instance_related: function(ins_id, related_instances) {\n    var ins, set_obj;\n    check(ins_id, String);\n    check(related_instances, Array);\n    if (!this.userId) {\n      return;\n    }\n    ins = db.instances.findOne({\n      _id: ins_id,\n      $or: [\n        {\n          submitter: this.userId\n        }, {\n          applicant: this.userId\n        }, {\n          inbox_users: this.userId\n        }, {\n          cc_users: this.userId\n        }\n      ]\n    }, {\n      fields: {\n        state: 1\n      }\n    });\n    if (ins) {\n      set_obj = new Object;\n      set_obj.modified = new Date();\n      set_obj.modified_by = this.userId;\n      set_obj.related_instances = related_instances;\n      db.instances.update({\n        _id: ins_id\n      }, {\n        $set: set_obj\n      });\n    }\n    return db.instances.find({\n      _id: {\n        $in: related_instances\n      }\n    }, {\n      fields: {\n        _id: 1,\n        values: 1\n      }\n    }).fetch();\n  }\n});\n","Meteor.methods\n\tupdateFlowPosition: (data) ->\n\t\tdb.flow_positions.update { _id: data._id }, $set:\n\t\t\trole: data.role\n\t\t\tusers: data.users\n\t\t\torg: data.org\n\n\tupdateFlowRole: (data) ->\n\t\tconsole.log data._id\n\t\tconsole.log data.name\n\t\tdb.flow_roles.update { _id: data._id }, $set:\n\t\t\tname: data.name","Meteor.methods({\n  updateFlowPosition: function(data) {\n    return db.flow_positions.update({\n      _id: data._id\n    }, {\n      $set: {\n        role: data.role,\n        users: data.users,\n        org: data.org\n      }\n    });\n  },\n  updateFlowRole: function(data) {\n    console.log(data._id);\n    console.log(data.name);\n    return db.flow_roles.update({\n      _id: data._id\n    }, {\n      $set: {\n        name: data.name\n      }\n    });\n  }\n});\n","Meteor.methods\n\tstart_flow: (space, flowId, start) ->\n\n\t\tkeyValue = db.steedos_keyvalues.findOne({ space: space, user: this.userId, key: 'start_flows' }, { fields: { value: 1 } })\n\n\t\tstart_flows = keyValue?.value || []\n\n\t\tif start\n\t\t\tstart_flows.push(flowId)\n\n\t\t\tstart_flows = _.uniq(start_flows)\n\t\telse\n\t\t\tstart_flows.remove(start_flows.indexOf(flowId))\n\n\t\tif keyValue\n\t\t\tdb.steedos_keyvalues.update({ _id: keyValue._id }, { space: space, user: this.userId, key: 'start_flows', value: start_flows })\n\t\telse\n\t\t\tdb.steedos_keyvalues.insert({ space: space, user: this.userId, key: 'start_flows', value: start_flows })\n\n","Meteor.methods({\n  start_flow: function(space, flowId, start) {\n    var keyValue, start_flows;\n    keyValue = db.steedos_keyvalues.findOne({\n      space: space,\n      user: this.userId,\n      key: 'start_flows'\n    }, {\n      fields: {\n        value: 1\n      }\n    });\n    start_flows = (keyValue != null ? keyValue.value : void 0) || [];\n    if (start) {\n      start_flows.push(flowId);\n      start_flows = _.uniq(start_flows);\n    } else {\n      start_flows.remove(start_flows.indexOf(flowId));\n    }\n    if (keyValue) {\n      return db.steedos_keyvalues.update({\n        _id: keyValue._id\n      }, {\n        space: space,\n        user: this.userId,\n        key: 'start_flows',\n        value: start_flows\n      });\n    } else {\n      return db.steedos_keyvalues.insert({\n        space: space,\n        user: this.userId,\n        key: 'start_flows',\n        value: start_flows\n      });\n    }\n  }\n});\n","Meteor.methods\n\tget_instance_traces: (ins_id)->\n\t\tif (!this.userId)\n\t\t\treturn;\n\t\tminiApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description',\n\t\t\t'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description']\n\n\t\tins = db.instances.findOne {_id: ins_id}, {\n\t\t\tfields: {\n\t\t\t\t\"traces._id\": 1,\n\t\t\t\t\"traces.is_finished\": 1,\n\t\t\t\t\"traces.step\": 1,\n\t\t\t\t\"traces.start_date\": 1,\n\t\t\t\t\"traces.name\": 1,\n\t\t\t\t\"traces.finish_date\": 1,\n\t\t\t\t\"traces.judge\": 1,\n\t\t\t\t\"traces.approves._id\": 1,\n\t\t\t\t\"traces.approves.is_finished\": 1,\n\t\t\t\t\"traces.approves.user\": 1,\n\t\t\t\t\"traces.approves.handler\": 1,\n\t\t\t\t\"traces.approves.handler_name\": 1,\n\t\t\t\t\"traces.approves.handler_organization_fullname\": 1,\n\t\t\t\t\"traces.approves.type\": 1,\n\t\t\t\t\"traces.approves.start_date\": 1,\n\t\t\t\t\"traces.approves.description\": 1,\n\t\t\t\t\"traces.approves.is_read\": 1,\n\t\t\t\t\"traces.approves.judge\": 1,\n\t\t\t\t\"traces.approves.finish_date\": 1,\n\t\t\t\t\"traces.approves.from_user_name\": 1,\n\t\t\t\t\"traces.approves.from_user\": 1,\n\t\t\t\t\"traces.approves.cc_description\": 1,\n\t\t\t\t\"traces.approves.trace\": 1,\n\t\t\t\t\"traces.approves.forward_space\": 1,\n\t\t\t\t\"traces.approves.forward_instance\": 1\n\t\t\t}\n\t\t}\n\n\t\tif !ins\n\t\t\treturn\n\n\t\treturn ins?.traces\n\n","Meteor.methods({\n  get_instance_traces: function(ins_id) {\n    var ins, miniApproveFields;\n    if (!this.userId) {\n      return;\n    }\n    miniApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description', 'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description'];\n    ins = db.instances.findOne({\n      _id: ins_id\n    }, {\n      fields: {\n        \"traces._id\": 1,\n        \"traces.is_finished\": 1,\n        \"traces.step\": 1,\n        \"traces.start_date\": 1,\n        \"traces.name\": 1,\n        \"traces.finish_date\": 1,\n        \"traces.judge\": 1,\n        \"traces.approves._id\": 1,\n        \"traces.approves.is_finished\": 1,\n        \"traces.approves.user\": 1,\n        \"traces.approves.handler\": 1,\n        \"traces.approves.handler_name\": 1,\n        \"traces.approves.handler_organization_fullname\": 1,\n        \"traces.approves.type\": 1,\n        \"traces.approves.start_date\": 1,\n        \"traces.approves.description\": 1,\n        \"traces.approves.is_read\": 1,\n        \"traces.approves.judge\": 1,\n        \"traces.approves.finish_date\": 1,\n        \"traces.approves.from_user_name\": 1,\n        \"traces.approves.from_user\": 1,\n        \"traces.approves.cc_description\": 1,\n        \"traces.approves.trace\": 1,\n        \"traces.approves.forward_space\": 1,\n        \"traces.approves.forward_instance\": 1\n      }\n    });\n    if (!ins) {\n      return;\n    }\n    return ins != null ? ins.traces : void 0;\n  }\n});\n","Meteor.methods\n\t'get_batch_instances': (space, categoryId, flowIds)->\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tif !space\n\t\t\treturn\n\n\t\t_batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId)\n\n\t\treturn _batch_instances\n\n\t'get_batch_instances_count': (space, categoryId, flowIds)->\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tif !space\n\t\t\treturn\n\n\t\t_batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId)\n\n\t\treturn _batch_instances?.length || 0\n\n\t'get_my_approves': (instanceIds)->\n\n\t\tthat = this\n\n\t\tif !that.userId\n\t\t\treturn\n\n\t\tmyApproves = new Array()\n\n\t\tinstanceIds.forEach (insId)->\n\t\t\tmy_approve = InstanceManager.getMyApprove(insId, that.userId)\n\t\t\tif my_approve\n\t\t\t\tmyApproves.push(my_approve)\n\n\t\treturn myApproves\n\n\n\n\n\n\n\n\n\n\n\n","Meteor.methods({\n  'get_batch_instances': function(space, categoryId, flowIds) {\n    var _batch_instances;\n    if (!this.userId) {\n      return;\n    }\n    if (!space) {\n      return;\n    }\n    _batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId);\n    return _batch_instances;\n  },\n  'get_batch_instances_count': function(space, categoryId, flowIds) {\n    var _batch_instances;\n    if (!this.userId) {\n      return;\n    }\n    if (!space) {\n      return;\n    }\n    _batch_instances = InstanceManager.getBatchInstances(space, categoryId, flowIds, this.userId);\n    return (_batch_instances != null ? _batch_instances.length : void 0) || 0;\n  },\n  'get_my_approves': function(instanceIds) {\n    var myApproves, that;\n    that = this;\n    if (!that.userId) {\n      return;\n    }\n    myApproves = new Array();\n    instanceIds.forEach(function(insId) {\n      var my_approve;\n      my_approve = InstanceManager.getMyApprove(insId, that.userId);\n      if (my_approve) {\n        return myApproves.push(my_approve);\n      }\n    });\n    return myApproves;\n  }\n});\n","Meteor.methods\n\tchange_flow_state: (flows) ->\n\t\tcheck flows, Array\n\n\t\t_userId = this.userId\n\n\t\tif !_userId\n\t\t\treturn\n\n\t\tflows.forEach (flow) ->\n\t\t\tspaceId = flow.space\n\t\t\tformId = flow.form\n\t\t\tflowId = flow.id\n\t\t\tstate = flow.state\n\n\t\t\tif !Steedos.isSpaceAdmin(spaceId, _userId)\n\t\t\t\tthrow  Meteor.Error(401, \"No permission\")\n\n\t\t\tform = db.forms.findOne({ _id: formId }, { fields: { historys: 0 } })\n\n\t\t\tflow = db.flows.findOne({ _id: flowId }, { fields: { historys: 0 } })\n\n\t\t\tif state != 'enabled' && state != 'disabled'\n\t\t\t\tthrow new Meteor.Error(500, \"state无效\")\n\n\t\t\tif !form\n\t\t\t\tthrow new Meteor.Error(500, \"form无效\")\n\n\t\t\tif !flow\n\t\t\t\tthrow new Meteor.Error(500, \"flow无效\")\n\n\t\t\tif !form.is_valid\n\t\t\t\tthrow new Meteor.Error(500, \"流程引用的表单[#{form.name}]验证未通过，请打开流程设计器检查表单设置\")\n\n\t\t\tif !flow.is_valid\n\t\t\t\tthrow new Meteor.Error(500, \"流程验证未通过，请打开流程设计器检查流程设置\")\n\n\t\t\tif !['new', 'modify', 'delete'].includes(flow.flowtype)\n\t\t\t\tthrow new Meteor.Error(500, \"流程验证未通过，flowtype值必须是new、modify、delete其中之一\")\n\n\t\t\tif !_.isArray(flow.current.steps)\n\t\t\t\tthrow new Meteor.Error(500, \"流程验证未通过，流程的步骤不能为空\")\n\n\t\t\tif _.uniq(flow.current.steps, 'name').length != flow.current.steps.length\n\t\t\t\tthrow new Meteor.Error(500, \"流程验证未通过，同一个流程下的步骤的名称不能重复\")\n\n\t\t\tnow = new Date\n\n\t\t\tif state == 'enabled'\n\t\t\t\t#流程启用前，校验其“指定历史步骤”属性中被引用的步骤是否存在且能被找到（仅限于流程的最新版）\n\t\t\t\tflow.current.steps.forEach (step) ->\n\t\t\t\t\tif ['specifyStepUser', 'specifyStepRole'].includes(step.deal_type)\n\t\t\t\t\t\tif !step.approver_step\n\t\t\t\t\t\t\tthrow new Meteor.Error(500, \"步骤[#{step.name}]中的指定历史步骤不存在。\")\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tspecifyStep = _.find flow.current.steps, (_step) ->\n\t\t\t\t\t\t\t\treturn step.approver_step == _step._id\n\n\t\t\t\t\t\t\tif !specifyStep\n\t\t\t\t\t\t\t\tthrow new Meteor.Error(500, \"步骤[#{step.name}]中的指定历史步骤不存在。\")\n\n\t\t\t\tform_current_fields_code = form.current.fields.getProperty(\"code\")\n\n\t\t\t\tflow.current.steps.forEach (step) ->\n\t\t\t\t\tstep.fields_modifiable = _.intersection(step.fields_modifiable, form_current_fields_code)\n\n\t\t\t\t#如果 流程对应表单 是停用的 则启用\n\t\t\t\tif form.state == 'disabled'\n\t\t\t\t\tdb.forms.update({_id: form._id}, {$set: {\"state\": \"enabled\", \"current.start_date\": now, \"current.modified\": now, \"current.modified_by\": _userId}})\n\n\t\t\t\tflow.current.modified = now\n\t\t\t\tflow.current.start_date = now\n\t\t\t\tflow.current.modified_by = _userId\n\n\t\t\t\tdb.flows.update({ _id: flow._id }, { $set: { \"state\": \"enabled\", \"current\": flow.current } })\n\n\t\t\telse\n\t\t\t\t#禁用流程\n\t\t\t\tdb.flows.update({_id: flow._id}, {$set: {\"state\": \"disabled\", \"current.modified\": now, \"current.start_date\": now, \"current.modified_by\": _userId}})\n\n\t\t\t\t# 判断表单所有流程是否已经全部停用 如果已全部停用 则修改表单状态为停用\n\t\t\t\t_flows = db.flows.find({ form: form._id }, { fields: { _id: 1, state: 1 } }).fetch()\n\n\t\t\t\t_flows_state = _flows.getProperty(\"state\")\n\n\t\t\t\tif !_flows_state.includes('enabled')\n\t\t\t\t\tdb.forms.update({_id: form._id}, {$set: {\"state\": \"disabled\", \"current.modified\": now, \"current.start_date\": now, \"current.modified_by\": _userId}})\n\n\n\n\n","Meteor.methods({\n  change_flow_state: function(flows) {\n    var _userId;\n    check(flows, Array);\n    _userId = this.userId;\n    if (!_userId) {\n      return;\n    }\n    return flows.forEach(function(flow) {\n      var _flows, _flows_state, flowId, form, formId, form_current_fields_code, now, spaceId, state;\n      spaceId = flow.space;\n      formId = flow.form;\n      flowId = flow.id;\n      state = flow.state;\n      if (!Steedos.isSpaceAdmin(spaceId, _userId)) {\n        throw Meteor.Error(401, \"No permission\");\n      }\n      form = db.forms.findOne({\n        _id: formId\n      }, {\n        fields: {\n          historys: 0\n        }\n      });\n      flow = db.flows.findOne({\n        _id: flowId\n      }, {\n        fields: {\n          historys: 0\n        }\n      });\n      if (state !== 'enabled' && state !== 'disabled') {\n        throw new Meteor.Error(500, \"state无效\");\n      }\n      if (!form) {\n        throw new Meteor.Error(500, \"form无效\");\n      }\n      if (!flow) {\n        throw new Meteor.Error(500, \"flow无效\");\n      }\n      if (!form.is_valid) {\n        throw new Meteor.Error(500, \"流程引用的表单[\" + form.name + \"]验证未通过，请打开流程设计器检查表单设置\");\n      }\n      if (!flow.is_valid) {\n        throw new Meteor.Error(500, \"流程验证未通过，请打开流程设计器检查流程设置\");\n      }\n      if (!['new', 'modify', 'delete'].includes(flow.flowtype)) {\n        throw new Meteor.Error(500, \"流程验证未通过，flowtype值必须是new、modify、delete其中之一\");\n      }\n      if (!_.isArray(flow.current.steps)) {\n        throw new Meteor.Error(500, \"流程验证未通过，流程的步骤不能为空\");\n      }\n      if (_.uniq(flow.current.steps, 'name').length !== flow.current.steps.length) {\n        throw new Meteor.Error(500, \"流程验证未通过，同一个流程下的步骤的名称不能重复\");\n      }\n      now = new Date;\n      if (state === 'enabled') {\n        flow.current.steps.forEach(function(step) {\n          var specifyStep;\n          if (['specifyStepUser', 'specifyStepRole'].includes(step.deal_type)) {\n            if (!step.approver_step) {\n              throw new Meteor.Error(500, \"步骤[\" + step.name + \"]中的指定历史步骤不存在。\");\n            } else {\n              specifyStep = _.find(flow.current.steps, function(_step) {\n                return step.approver_step === _step._id;\n              });\n              if (!specifyStep) {\n                throw new Meteor.Error(500, \"步骤[\" + step.name + \"]中的指定历史步骤不存在。\");\n              }\n            }\n          }\n        });\n        form_current_fields_code = form.current.fields.getProperty(\"code\");\n        flow.current.steps.forEach(function(step) {\n          return step.fields_modifiable = _.intersection(step.fields_modifiable, form_current_fields_code);\n        });\n        if (form.state === 'disabled') {\n          db.forms.update({\n            _id: form._id\n          }, {\n            $set: {\n              \"state\": \"enabled\",\n              \"current.start_date\": now,\n              \"current.modified\": now,\n              \"current.modified_by\": _userId\n            }\n          });\n        }\n        flow.current.modified = now;\n        flow.current.start_date = now;\n        flow.current.modified_by = _userId;\n        return db.flows.update({\n          _id: flow._id\n        }, {\n          $set: {\n            \"state\": \"enabled\",\n            \"current\": flow.current\n          }\n        });\n      } else {\n        db.flows.update({\n          _id: flow._id\n        }, {\n          $set: {\n            \"state\": \"disabled\",\n            \"current.modified\": now,\n            \"current.start_date\": now,\n            \"current.modified_by\": _userId\n          }\n        });\n        _flows = db.flows.find({\n          form: form._id\n        }, {\n          fields: {\n            _id: 1,\n            state: 1\n          }\n        }).fetch();\n        _flows_state = _flows.getProperty(\"state\");\n        if (!_flows_state.includes('enabled')) {\n          return db.forms.update({\n            _id: form._id\n          }, {\n            $set: {\n              \"state\": \"disabled\",\n              \"current.modified\": now,\n              \"current.start_date\": now,\n              \"current.modified_by\": _userId\n            }\n          });\n        }\n      }\n    });\n  }\n});\n","Meteor.methods\n\n\thide_instance: (insId, is_hidden) ->\n\t\tif !this.userId\n\t\t\treturn\n\n\t\tcheck(insId, String)\n\t\tcheck(is_hidden, Boolean)\n\n\t\tuserId = this.userId\n\n\t\tinstance = db.instances.findOne(insId, { fields: { state: 1, flow: 1, space: 1 } })\n\n\t\tif not instance\n\t\t\tthrow new Meteor.Error('error!', \"未找到申请单\")\n\n\t\tif instance.state isnt 'completed'\n\t\t\tthrow new Meteor.Error('error!', \"申请单状态不是已结束\")\n\n\t\t# 验证login user_id对该流程有管理申请单的权限\n\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, userId)\n\t\tspace = db.spaces.findOne(instance.space, { fields: { admins: 1 } })\n\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(userId))\n\t\t\tthrow new Meteor.Error('error!', \"用户没有对当前流程的管理权限\")\n\n\t\tdb.instances.update(insId, { $set: { is_hidden: is_hidden } })\n\n\t\treturn true;\n","Meteor.methods({\n  hide_instance: function(insId, is_hidden) {\n    var instance, permissions, space, userId;\n    if (!this.userId) {\n      return;\n    }\n    check(insId, String);\n    check(is_hidden, Boolean);\n    userId = this.userId;\n    instance = db.instances.findOne(insId, {\n      fields: {\n        state: 1,\n        flow: 1,\n        space: 1\n      }\n    });\n    if (!instance) {\n      throw new Meteor.Error('error!', \"未找到申请单\");\n    }\n    if (instance.state !== 'completed') {\n      throw new Meteor.Error('error!', \"申请单状态不是已结束\");\n    }\n    permissions = permissionManager.getFlowPermissions(instance.flow, userId);\n    space = db.spaces.findOne(instance.space, {\n      fields: {\n        admins: 1\n      }\n    });\n    if ((!permissions.includes(\"admin\")) && (!space.admins.includes(userId))) {\n      throw new Meteor.Error('error!', \"用户没有对当前流程的管理权限\");\n    }\n    db.instances.update(insId, {\n      $set: {\n        is_hidden: is_hidden\n      }\n    });\n    return true;\n  }\n});\n","Meteor.methods\n\tgetInstanceValues: (insId)->\n\t\tif (!this.userId)\n\t\t\treturn;\n\t\treturn db.instances.findOne({_id: insId}, {fields: {values: 1}})?.values","Meteor.methods({\n  getInstanceValues: function(insId) {\n    var ref;\n    if (!this.userId) {\n      return;\n    }\n    return (ref = db.instances.findOne({\n      _id: insId\n    }, {\n      fields: {\n        values: 1\n      }\n    })) != null ? ref.values : void 0;\n  }\n});\n","Cookies = require(\"cookies\")\n\ngetInstanceReadOnly = (req, res, next, options) ->\n\n\tuser = Steedos.getAPILoginUser(req, res)\n\n\tif req?.query?.access_token\n\t\tuserId = Steedos.getUserIdFromAccessToken(req.query.access_token)\n\t\tif userId\n\t\t\tuser = Meteor.users.findOne({_id: userId})\n\n\tspaceId = req.params.space\n\n\tinstanceId = req.params.instance_id\n\n\tinstance = db.instances.findOne({_id: instanceId});\n\n\tspace = db.spaces.findOne({_id: spaceId});\n\n\thide_traces = req.query?.hide_traces\n\n\tif !options\n\t\toptions = {showTrace: true}\n\telse\n\t\toptions.showTrace = true\n\n\tif hide_traces is \"1\"\n\t\tif options\n\t\t\toptions.showTrace = false\n\t\telse\n\t\t\toptions = {showTrace: false}\n\n\tif !options.showAttachments\n\t\toptions.showAttachments = true\n\n\tif !space\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing space\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tif  !instance\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing instance\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tif !user\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tif instance.space != spaceId\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing space or instance\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\n\n\tspaceUserCount = db.space_users.find({ user: user._id, space: spaceId }).count()\n\n\tif spaceUserCount is 0\n\t\tif !space\n\t\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 401,\n\t\t\t\tdata:\n\t\t\t\t\t\"error\": \"Validate Request -- Missing sapceUser\",\n\t\t\t\t\t\"success\": false\n\t\t\treturn;\n\n\t#校验user是否对instance有查看权限\n\t_hasPermission = WorkflowManager.hasInstancePermissions(user, instance)\n\n\tif !_hasPermission  && instance.distribute_from_instance\n\t\t_parent_instances = _.union([instance.distribute_from_instance], instance.distribute_from_instances || [])\n\n\t\t_hasPermission = _.find _parent_instances, (_parent_id)->\n\t\t\t_parent_ins = db.instances.findOne({_id:_parent_id}, {fields: {traces: 0}})\n\n\t\t\treturn WorkflowManager.hasInstancePermissions(user, _parent_ins)\n\n\tif !_hasPermission\n\t\t_locale = Steedos.locale(user._id, true)\n\t\terror = TAPi18n.__(\"instance_permissions_error\", {}, _locale)\n\t\tres.charset = \"utf-8\"\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": error,\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\thtml = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options)\n\tdataBuf = new Buffer(html);\n\tres.setHeader('content-length', dataBuf.length)\n\tres.setHeader('content-range', \"bytes 0-#{dataBuf.length - 1}/#{dataBuf.length}\")\n\tres.statusCode = 200\n\tres.end(html)\n\nJsonRoutes.add \"get\", \"/workflow/space/:space/view/readonly/:instance_id\", getInstanceReadOnly\n\nJsonRoutes.add \"get\", \"/workflow/space/:space/view/readonly/:instance_id/:instance_name\", (req, res, next)->\n\tres.setHeader('Content-type', 'application/x-msdownload');\n\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(req.params.instance_name));\n\tres.setHeader('Transfer-Encoding', '')\n\n\toptions = {absolute: true}\n\n\treturn getInstanceReadOnly(req, res, next, options)\n###\n\t获取申请单列表：\n    final_decision：审批结果\n    state: 申请单状态\n###\nJsonRoutes.add \"get\", \"/api/workflow/instances\", (req, res, next) ->\n\n\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\treturn ;\n\n\tuser_id = req.userId\n\n\tspaceId = req.headers[\"x-space-id\"]\n\n\tif not spaceId\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 401,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Space-Id\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tflowId = req.query?.flowId\n\n\tif !flowId\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 400,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- Missing flowId\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tquery = {}\n\n\tret_sync_token = new Date().getTime()\n\n\tflowIds = flowId.split(\",\")\n\n\n\tflows = db.flows.find({_id: {$in: flowIds}}).fetch()\n\n\ti = 0\n\twhile i < flows.length\n\t\tf = flows[i]\n\t\tspaceUser = db.space_users.findOne({space: f.space, user: user_id})\n\t\tif !spaceUser\n\t\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 401,\n\t\t\t\tdata:\n\t\t\t\t\t\"error\": \"Validate Request -- No permission, flow is #{f._id}\",\n\t\t\t\t\t\"success\": false\n\t\t\treturn;\n\t\telse\n\n\t#\t是否工作区管理员\n\t\tif !Steedos.isSpaceAdmin(spaceId, user_id)\n\t\t\tspaceUserOrganizations = db.organizations.find({\n\t\t\t\t_id: {\n\t\t\t\t\t$in: spaceUser.organizations\n\t\t\t\t}\n\t\t\t}).fetch();\n\n\t\t\tif !WorkflowManager.canMonitor(f, spaceUser, spaceUserOrganizations) && !WorkflowManager.canAdmin(f, spaceUser, spaceUserOrganizations)\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tcode: 401,\n\t\t\t\t\tdata:\n\t\t\t\t\t\t\"error\": \"Validate Request -- No permission, flow is #{f._id}\",\n\t\t\t\t\t\t\"success\": false\n\t\t\t\treturn;\n\t\ti++\n\n\n\tquery.flow = {$in: flowIds}\n\n\tquery.space = spaceId\n\n\tif req.query?.sync_token\n\t\tsync_token = new Date(Number(req.query.sync_token))\n\t\tquery.modified = {$gt: sync_token}\n\n\tif req.query?.final_decision\n\t\tquery.final_decision = {$in : req.query.final_decision.split(\",\")}\n\telse\n\t\tquery.final_decision = {$nin: [\"terminated\", \"rejected\"]}\n\n\tif req.query?.state\n\t\tquery.state = {$in: req.query.state.split(\",\")}\n\telse\n\t\tquery.state = \"completed\"\n\n#\t最多返回500条数据\n\tinstances = db.instances.find(query, {fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, traces: 0, attachments: 0}, skip: 0, limit: 500}).fetch()\n\tinstances.forEach (instance)->\n\n\t\tattachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\n\n\t\tinstance.attachments = attachments\n\n\n\tJsonRoutes.sendResult res,\n\t\t\tcode: 200,\n\t\t\tdata:\n\t\t\t\t\"status\": \"success\",\n\t\t\t\t\"sync_token\": ret_sync_token\n\t\t\t\t\"data\": instances\n\treturn;\n","var Cookies, getInstanceReadOnly;\n\nCookies = require(\"cookies\");\n\ngetInstanceReadOnly = function(req, res, next, options) {\n  var _hasPermission, _locale, _parent_instances, dataBuf, error, hide_traces, html, instance, instanceId, ref, ref1, space, spaceId, spaceUserCount, user, userId;\n  user = Steedos.getAPILoginUser(req, res);\n  if (req != null ? (ref = req.query) != null ? ref.access_token : void 0 : void 0) {\n    userId = Steedos.getUserIdFromAccessToken(req.query.access_token);\n    if (userId) {\n      user = Meteor.users.findOne({\n        _id: userId\n      });\n    }\n  }\n  spaceId = req.params.space;\n  instanceId = req.params.instance_id;\n  instance = db.instances.findOne({\n    _id: instanceId\n  });\n  space = db.spaces.findOne({\n    _id: spaceId\n  });\n  hide_traces = (ref1 = req.query) != null ? ref1.hide_traces : void 0;\n  if (!options) {\n    options = {\n      showTrace: true\n    };\n  } else {\n    options.showTrace = true;\n  }\n  if (hide_traces === \"1\") {\n    if (options) {\n      options.showTrace = false;\n    } else {\n      options = {\n        showTrace: false\n      };\n    }\n  }\n  if (!options.showAttachments) {\n    options.showAttachments = true;\n  }\n  if (!space) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing space\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!instance) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing instance\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!user) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing X-Auth-Token,X-User-Id\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (instance.space !== spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing space or instance\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  spaceUserCount = db.space_users.find({\n    user: user._id,\n    space: spaceId\n  }).count();\n  if (spaceUserCount === 0) {\n    if (!space) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- Missing sapceUser\",\n          \"success\": false\n        }\n      });\n      return;\n    }\n  }\n  _hasPermission = WorkflowManager.hasInstancePermissions(user, instance);\n  if (!_hasPermission && instance.distribute_from_instance) {\n    _parent_instances = _.union([instance.distribute_from_instance], instance.distribute_from_instances || []);\n    _hasPermission = _.find(_parent_instances, function(_parent_id) {\n      var _parent_ins;\n      _parent_ins = db.instances.findOne({\n        _id: _parent_id\n      }, {\n        fields: {\n          traces: 0\n        }\n      });\n      return WorkflowManager.hasInstancePermissions(user, _parent_ins);\n    });\n  }\n  if (!_hasPermission) {\n    _locale = Steedos.locale(user._id, true);\n    error = TAPi18n.__(\"instance_permissions_error\", {}, _locale);\n    res.charset = \"utf-8\";\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": error,\n        \"success\": false\n      }\n    });\n    return;\n  }\n  html = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options);\n  dataBuf = new Buffer(html);\n  res.setHeader('content-length', dataBuf.length);\n  res.setHeader('content-range', \"bytes 0-\" + (dataBuf.length - 1) + \"/\" + dataBuf.length);\n  res.statusCode = 200;\n  return res.end(html);\n};\n\nJsonRoutes.add(\"get\", \"/workflow/space/:space/view/readonly/:instance_id\", getInstanceReadOnly);\n\nJsonRoutes.add(\"get\", \"/workflow/space/:space/view/readonly/:instance_id/:instance_name\", function(req, res, next) {\n  var options;\n  res.setHeader('Content-type', 'application/x-msdownload');\n  res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(req.params.instance_name));\n  res.setHeader('Transfer-Encoding', '');\n  options = {\n    absolute: true\n  };\n  return getInstanceReadOnly(req, res, next, options);\n});\n\n\n/*\n\t获取申请单列表：\n    final_decision：审批结果\n    state: 申请单状态\n */\n\nJsonRoutes.add(\"get\", \"/api/workflow/instances\", function(req, res, next) {\n  var f, flowId, flowIds, flows, i, instances, query, ref, ref1, ref2, ref3, ret_sync_token, spaceId, spaceUser, spaceUserOrganizations, sync_token, user_id;\n  if (!Steedos.APIAuthenticationCheck(req, res)) {\n    return;\n  }\n  user_id = req.userId;\n  spaceId = req.headers[\"x-space-id\"];\n  if (!spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 401,\n      data: {\n        \"error\": \"Validate Request -- Missing X-Space-Id\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  flowId = (ref = req.query) != null ? ref.flowId : void 0;\n  if (!flowId) {\n    JsonRoutes.sendResult(res, {\n      code: 400,\n      data: {\n        \"error\": \"Validate Request -- Missing flowId\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  query = {};\n  ret_sync_token = new Date().getTime();\n  flowIds = flowId.split(\",\");\n  flows = db.flows.find({\n    _id: {\n      $in: flowIds\n    }\n  }).fetch();\n  i = 0;\n  while (i < flows.length) {\n    f = flows[i];\n    spaceUser = db.space_users.findOne({\n      space: f.space,\n      user: user_id\n    });\n    if (!spaceUser) {\n      JsonRoutes.sendResult(res, {\n        code: 401,\n        data: {\n          \"error\": \"Validate Request -- No permission, flow is \" + f._id,\n          \"success\": false\n        }\n      });\n      return;\n    } else {\n\n    }\n    if (!Steedos.isSpaceAdmin(spaceId, user_id)) {\n      spaceUserOrganizations = db.organizations.find({\n        _id: {\n          $in: spaceUser.organizations\n        }\n      }).fetch();\n      if (!WorkflowManager.canMonitor(f, spaceUser, spaceUserOrganizations) && !WorkflowManager.canAdmin(f, spaceUser, spaceUserOrganizations)) {\n        JsonRoutes.sendResult(res, {\n          code: 401,\n          data: {\n            \"error\": \"Validate Request -- No permission, flow is \" + f._id,\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    i++;\n  }\n  query.flow = {\n    $in: flowIds\n  };\n  query.space = spaceId;\n  if ((ref1 = req.query) != null ? ref1.sync_token : void 0) {\n    sync_token = new Date(Number(req.query.sync_token));\n    query.modified = {\n      $gt: sync_token\n    };\n  }\n  if ((ref2 = req.query) != null ? ref2.final_decision : void 0) {\n    query.final_decision = {\n      $in: req.query.final_decision.split(\",\")\n    };\n  } else {\n    query.final_decision = {\n      $nin: [\"terminated\", \"rejected\"]\n    };\n  }\n  if ((ref3 = req.query) != null ? ref3.state : void 0) {\n    query.state = {\n      $in: req.query.state.split(\",\")\n    };\n  } else {\n    query.state = \"completed\";\n  }\n  instances = db.instances.find(query, {\n    fields: {\n      inbox_uers: 0,\n      cc_users: 0,\n      outbox_users: 0,\n      traces: 0,\n      attachments: 0\n    },\n    skip: 0,\n    limit: 500\n  }).fetch();\n  instances.forEach(function(instance) {\n    var attachments;\n    attachments = cfs.instances.find({\n      'metadata.instance': instance._id,\n      'metadata.current': true,\n      \"metadata.is_private\": {\n        $ne: true\n      }\n    }, {\n      fields: {\n        copies: 0\n      }\n    }).fetch();\n    return instance.attachments = attachments;\n  });\n  JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      \"status\": \"success\",\n      \"sync_token\": ret_sync_token,\n      \"data\": instances\n    }\n  });\n});\n","\nJsonRoutes.add \"get\", \"/steedos-css\", (req, res, next)->\n\n\tallCss = WebApp.getRefreshableAssets()\n\n\tallCssLink = \"\"\n\n\tallCss.forEach (css) ->\n\t\tif __meteor_runtime_config__.ROOT_URL_PATH_PREFIX\n\t\t\trootUrl = __meteor_runtime_config__.ROOT_URL\n\t\t\tif rootUrl.endsWith(\"/\")\n\t\t\t\tcssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX + \"/\", \"\") + css.url\n\t\t\telse\n\t\t\t\tcssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX, \"\") + css.url\n\t\telse\n\t\t\tcssHref = Meteor.absoluteUrl(css.url)\n\t\tallCssLink += \"@import url(#{cssHref});\"\n\n\tres.statusCode = 200\n\tres.end(allCssLink)","JsonRoutes.add(\"get\", \"/steedos-css\", function(req, res, next) {\n  var allCss, allCssLink;\n  allCss = WebApp.getRefreshableAssets();\n  allCssLink = \"\";\n  allCss.forEach(function(css) {\n    var cssHref, rootUrl;\n    if (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX) {\n      rootUrl = __meteor_runtime_config__.ROOT_URL;\n      if (rootUrl.endsWith(\"/\")) {\n        cssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX + \"/\", \"\") + css.url;\n      } else {\n        cssHref = rootUrl.replace(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX, \"\") + css.url;\n      }\n    } else {\n      cssHref = Meteor.absoluteUrl(css.url);\n    }\n    return allCssLink += \"@import url(\" + cssHref + \");\";\n  });\n  res.statusCode = 200;\n  return res.end(allCssLink);\n});\n","JsonRoutes.add \"get\", \"/api/workflow/space/:space/view/draft/:flow\", (req, res, next) ->\n\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\treturn\n\n\tuser_id = req.userId\n\n\tuser = db.users.findOne({ _id: user_id })\n\n\tspaceId = req.params.space\n\n\tflowId = req.params.flow\n\n\tspace = db.spaces.findOne({ _id: spaceId })\n\n\tflow = db.flows.findOne({ _id: flowId }, { fields: { name: 1, 'current._id': 1, form: 1 } })\n\n\tform = db.forms.findOne({ _id: flow.form }, { fields: { 'current._id': 1 } })\n\n\toptions = {\n\t\tshowTrace: false,\n\t\tshowAttachments: false,\n\t\ttemplateName: \"default\",\n\t\teditable: true,\n\t\twidth: \"100%\",\n\t\tinstance_style: \"instance-default\",\n\t\tplugins: \"\"\"\n\n\t\t\t<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\" />\n\t\t\t<meta name=\"format-detection\" content=\"telephone=no\">\n\t\t\t<meta http-equiv=\"x-rim-auto-match\" content=\"none\">\n\t\t\t<title>#{flow.name}</title>\n\t\t\t<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />\n\t\t\t<meta name=\"viewport\" content=\"width=device-width\" />\n\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css\">\n\n\t\t\t<script src=\"/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js\" type=\"text/javascript\"></script>\n\n\t\t\t<script src=\"/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js\" type=\"text/javascript\" charset=\"UTF-8\"></script>\n\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/plugins/toastr/toastr.min.css\">\n\t\t\t<script src=\"/plugins/toastr/toastr.min.js\" type=\"text/javascript\"></script>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" href=\"/js/workflow_client.css\">\n\t\t\t<script src=\"/js/workflow_client.js\" type=\"text/javascript\"></script>\n\t\t\"\"\"\n\t}\n\n\tinstance = {\n\t\tflow: flow._id,\n\t\tflow_version: flow.current._id,\n\t\tform: form._id,\n\t\tform_version: form.current._id,\n\t\tvalues: {},\n\t\tname: flow.name,\n\t\tspace: spaceId\n\t}\n\n\thtml = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options)\n\n\tdataBuf = new Buffer(html)\n\n\tres.setHeader('content-length', dataBuf.length)\n\n\tres.setHeader('content-range', \"bytes 0-#{dataBuf.length - 1}/#{dataBuf.length}\")\n\n\tres.statusCode = 200\n\n\tres.end(html)\n","JsonRoutes.add(\"get\", \"/api/workflow/space/:space/view/draft/:flow\", function(req, res, next) {\n  var dataBuf, flow, flowId, form, html, instance, options, space, spaceId, user, user_id;\n  if (!Steedos.APIAuthenticationCheck(req, res)) {\n    return;\n  }\n  user_id = req.userId;\n  user = db.users.findOne({\n    _id: user_id\n  });\n  spaceId = req.params.space;\n  flowId = req.params.flow;\n  space = db.spaces.findOne({\n    _id: spaceId\n  });\n  flow = db.flows.findOne({\n    _id: flowId\n  }, {\n    fields: {\n      name: 1,\n      'current._id': 1,\n      form: 1\n    }\n  });\n  form = db.forms.findOne({\n    _id: flow.form\n  }, {\n    fields: {\n      'current._id': 1\n    }\n  });\n  options = {\n    showTrace: false,\n    showAttachments: false,\n    templateName: \"default\",\n    editable: true,\n    width: \"100%\",\n    instance_style: \"instance-default\",\n    plugins: \"\\n<meta http-equiv=\\\"X-UA-Compatible\\\" content=\\\"IE=edge,chrome=1\\\" />\\n<meta name=\\\"format-detection\\\" content=\\\"telephone=no\\\">\\n<meta http-equiv=\\\"x-rim-auto-match\\\" content=\\\"none\\\">\\n<title>\" + flow.name + \"</title>\\n<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />\\n<meta name=\\\"viewport\\\" content=\\\"width=device-width\\\" />\\n\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css\\\">\\n\\n<script src=\\\"/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js\\\" type=\\\"text/javascript\\\"></script>\\n\\n<script src=\\\"/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js\\\" type=\\\"text/javascript\\\" charset=\\\"UTF-8\\\"></script>\\n\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/plugins/toastr/toastr.min.css\\\">\\n<script src=\\\"/plugins/toastr/toastr.min.js\\\" type=\\\"text/javascript\\\"></script>\\n<link rel=\\\"stylesheet\\\" type=\\\"text/css\\\" href=\\\"/js/workflow_client.css\\\">\\n<script src=\\\"/js/workflow_client.js\\\" type=\\\"text/javascript\\\"></script>\"\n  };\n  instance = {\n    flow: flow._id,\n    flow_version: flow.current._id,\n    form: form._id,\n    form_version: form.current._id,\n    values: {},\n    name: flow.name,\n    space: spaceId\n  };\n  html = InstanceReadOnlyTemplate.getInstanceHtml(user, space, instance, options);\n  dataBuf = new Buffer(html);\n  res.setHeader('content-length', dataBuf.length);\n  res.setHeader('content-range', \"bytes 0-\" + (dataBuf.length - 1) + \"/\" + dataBuf.length);\n  res.statusCode = 200;\n  return res.end(html);\n});\n","Array.prototype.filterProperty = function(h, l){\n    var g = [];\n    this.forEach(function(t){\n        var m = t? t[h]:null;\n        var d = false;\n        if(m instanceof Array){\n            d = m.includes(l);\n        }else{\n            d = (l === undefined)? false:m==l;\n        }\n        if(d){\n            g.push(t);\n        }\n    });\n    return g;\n};\n\nArray.prototype.getProperty = function(k){\n    var v = new Array();\n    this.forEach(function(t){\n        var m = t? t[k]:null;\n        v.push(m);\n    });\n    return v;\n}\n\nArray.prototype.getEach = function(code){\n    var rev = [];\n    for(var i = 0 ; i < this.length ; i++){\n        rev.push(this[i][code]);\n    }\n    return rev;\n};\n\nArray.prototype.uniq = function(){\n    var a = [];\n    this.forEach(function(b){ \n        if(a.indexOf(b) < 0)\n            {a[a.length] = b}\n    });\n    return a;\n};\n\nForm_formula = {};\n\n\nForm_formula.mixin = function(dest, src){\n    for(var key in src){\n        dest[key] = src[key];\n    }\n    return dest;\n};\n\n\nForm_formula.handerUserObject = function(u){\n\n    if(u instanceof Array){\n        var user = {};\n\n        user.name = u.getProperty(\"name\")\n        user.organization = {};\n        user.organization.name = u.getProperty(\"organization\").getProperty(\"name\");\n        user.organization.fullname = u.getProperty(\"organization\").getProperty(\"fullname\");\n\n        user.hr = u.getProperty(\"hr\")\n\n        user.sort_no = u.getProperty(\"sort_no\")\n\n\t\tuser.mobile = u.getProperty(\"mobile\")\n\n\t\tuser.work_phone = u.getProperty(\"work_phone\")\n\n\t\tuser.position = u.getProperty(\"position\")\n\n        var userRoles = u.getProperty(\"roles\");\n        var roles = new Array();\n        userRoles.forEach(function(i){\n            roles = roles.concat(i);\n        }); \n        roles.uniq();\n        user.roles = roles;\n        return user;\n    }else{\n        return u;\n    }\n}\n\nForm_formula.handerOrgObject = function(o){\n\n    if(o instanceof Array){\n        var org = {};\n\t\torg.id = o.getProperty(\"_id\");\n        org.name = o.getProperty(\"name\");\n        org.fullname = o.getProperty(\"fullname\");\n\n        return org;\n    }else{\n        return o;\n    }\n}\n\n\n\n/**\n    * 获得公式需要用到的初始值\n    * 输入：fields, values, applicant\n    * 输出：__values\n**/\nForm_formula.init_formula_values = function(fields, autoFormDoc, approver, applicant, spaceId){\n    var __values = {};\n    //申请单中填的值处理\n    if(fields && fields.length && autoFormDoc) {\n        //debugger;\n        fields.forEach(function(field){\n            var type = field.type;\n            if(type) {\n                if(type === 'table') {\n                    /*\n                    * 将表格字段的值进行转换后传入__values中\n                    * values中表格的值格式为\n                    * [{\"a\":1,\"b\":4},{\"a\":2,\"b\":5},{\"a\":3,\"b\":6}]\n                    * __values需要转化为下面格式且和主表的值一样放到第一层\n                    * {\"a\":[1,2,3],\"b\":[4,5,6]}\n                    **/\n                    var tableFields = field.sfields,\n                        tableValues = autoFormDoc[field.code],\n                        formulaTableValues = [],\n                        __tableValues = {};\n                    //按公式的格式转换值为__tableValues\n                    if(tableFields && tableFields.length && tableValues && tableValues instanceof Array) {\n                        tableValues.forEach(function(tableValue){\n                            formulaTableValues.push(Form_formula.init_formula_values(tableFields, tableValue));\n                        }, this);\n                        //按主表的格式转换__tableValues加到\n                        tableFields.forEach(function(tablefield){\n                            __tableValues[tablefield.code] = formulaTableValues.getEach(tablefield.code);\n                        });\n                        __values = Form_formula.mixin(__values, __tableValues);\n                    }\n                } else if (type == 'user'){\n                    __values[field.code] = Form_formula.handerUserObject(WorkflowManager.getFormulaUserObjects(spaceId, autoFormDoc[field.code]));\n\n                } else if (type == 'group'){\n                    __values[field.code] = Form_formula.handerOrgObject(WorkflowManager.getFormulaOrgObjects(autoFormDoc[field.code]));\n\n                } else if (type == 'odata'){\n\t\t\t\t\t__values[field.code] = autoFormDoc[field.code] || {}\n\n\t\t\t\t} else {\n                    //此处传spaceId给选人控件的旧数据计算roles和organization\n                    __values[field.code] = autoFormDoc[field.code];\n                }\n            }\n        }, this);\n    }\n    //当前处理人\n    __values[\"approver\"] = WorkflowManager.getFormulaUserObject(spaceId, approver);\n    //申请人\n    __values[\"applicant\"] = WorkflowManager.getFormulaUserObject(spaceId, applicant);\n\n    return __values;\n};\n\n","getHandlersManager = {}\n\ngetHandlersManager.getHandlersByUsersAndRoles = (user_ids, role_ids, space_id)->\n\tapprove_users = new Array\n\t_.each(user_ids, (user_id)->\n\t\tif db.users.find({_id: user_id}).count() > 0\n\t\t\tusers = getHandlersManager.getHandlersByUserAndRoles(user_id, role_ids, space_id)\n\t\t\tif users.length > 0\n\t\t\t\tapprove_users = approve_users.concat(users)\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"user_id不合法不合法\")\n\t)\n\tapprove_users = _.uniq(approve_users)\n\treturn approve_users\n\ngetHandlersManager.getHandlersByUserAndRoles = (user_id, role_ids, space_id)->\n\tuser_ids = new Array\n\t_.each(role_ids, (role_id)->\n\t\tif db.flow_roles.find({_id: role_id}).count() > 0\n\t\t\tusers = getHandlersManager.getHandlersByUserAndRole(user_id, role_id, space_id)\n\t\t\tif users.length > 0\n\t\t\t\tuser_ids = user_ids.concat(users)\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"role_id已经被删除\")\n\t)\n\tif user_ids.length > 0\n\t\tuser_ids = _.uniq(user_ids)\n\t\treturn user_ids\n\telse\n\t\tthrow new Meteor.Error('error!', \"根据user_id和role_ids没查到对应的处理人\")\n\ngetHandlersManager.getHandlersByUserAndRole = (user_id, role_id, space_id) ->\n\torgs = db.organizations.find({ space: space_id, users: user_id }, { fields: { _id: 1 } }).fetch()\n\tuser_ids = new Array\n\t_.each(orgs, (org) ->\n\t\tusers = getHandlersManager.getHandlersByOrgAndRole(org._id, role_id, space_id)\n\t\tif users.length > 0\n\t\t\tuser_ids = user_ids.concat(users)\n\t)\n\tuser_ids = _.uniq(user_ids)\n\treturn user_ids\n\ngetHandlersManager.getHandlersByOrgsAndRoles = (org_ids, role_ids, space_id)->\n\tuser_ids = new Array\n\t_.each(org_ids, (org_id)->\n\t\tusers = getHandlersManager.getHandlersByOrgAndRoles(org_id, role_ids, space_id)\n\t\tif users.length > 0\n\t\t\tuser_ids = user_ids.concat(users)\n\t)\n\tuser_ids = _.uniq(user_ids)\n\treturn user_ids\n\ngetHandlersManager.getHandlersByOrgAndRoles = (org_id, role_ids, space_id)->\n\tuser_ids = new Array\n\t_.each(role_ids, (role_id)->\n\t\tusers = getHandlersManager.getHandlersByOrgAndRole(org_id, role_id, space_id)\n\t\tif users.length > 0\n\t\t\tuser_ids = user_ids.concat(users)\n\t)\n\tif user_ids.length > 0\n\t\tuser_ids = _.uniq(user_ids)\n\t\treturn user_ids\n\telse\n\t\tthrow new Meteor.Error('error!', \"根据org_id和role_ids没查到对应的处理人\")\n\ngetHandlersManager.getHandlersByOrgAndRole = (org_id, role_id, space_id) ->\n\torg = db.organizations.findOne({ _id: org_id }, { fields: { parents: 1 } })\n\tuser_ids = new Array\n\tpositions = db.flow_positions.find({ space: space_id, org: org_id, role: role_id }, { fields: { users: 1 } }).fetch()\n\t_.each(positions, (position) ->\n\t\tuser_ids = user_ids.concat(position.users)\n\t)\n\tif user_ids.length is 0\n\t\tparents = org.parents\n\t\t_.each(parents, (parent_id) ->\n\t\t\tpositions = db.flow_positions.find({ space: space_id, org: parent_id, role: role_id }, { fields: { users: 1 } }).fetch()\n\t\t\tif positions.length > 0\n\t\t\t\t_.each(positions, (position) ->\n\t\t\t\t\tuser_ids = user_ids.concat(position.users)\n\t\t\t\t)\n\t\t)\n\n\tuser_ids = _.uniq(user_ids)\n\treturn user_ids\n\ngetHandlersManager.getHandlers = (instance_id, step_id) ->\n\tinstance = db.instances.findOne(instance_id)\n\n\t# 拟稿时, 可以设定后续每个步骤的处理人 #1926\n\tif instance.step_approve && instance.step_approve[step_id]\n\t\treturn instance.step_approve[step_id]\n\n\tapprove_users = new Array\n\tspace_id = instance.space\n\tflow_id = instance.flow\n\tflow_rev = instance.flow_version\n\tcurrent_flow = db.flows.findOne(flow_id)\n\tcurrent_step = null\n\tcurrent_steps = new Array\n\n\tif current_flow.current._id is flow_rev\n\t\tcurrent_steps = current_flow.current.steps\n\telse\n\t\tcurrent = _.find(current_flow.historys, (history) ->\n\t\t\treturn history._id is flow_rev\n\t\t)\n\t\tcurrent_steps = current.steps\n\n\t# 从获取的steps中根据:step_id提取对应的step对象\n\tcurrent_step = _.find(current_steps, (step) ->\n\t\treturn step._id is step_id\n\t)\n\t# 判断step_type\n\tif current_step.step_type is \"condition\"\n\t\tunfinished_trace = _.find(instance.traces, (trace) ->\n\t\t\treturn trace.is_finished is false\n\t\t)\n\n\t\treturn new Array(unfinished_trace.approves[0].user)\n\n\tif current_step.step_type is \"start\"\n\t\thandlers = new Array\n\t\thandlers.push(instance.applicant)\n\t\thandlers.push(instance.submitter)\n\t\thandlers = _.uniq(handlers)\n\t\treturn handlers\n\t# 得到step的\"deal_type\"，并进行逻辑判断找到对应的处理人\n\tdeal_type = current_step.deal_type\n\tusers = new Array\n\tif deal_type is \"applicantRole\"\n\t\t# 1.***********申请人所属组织中的审批岗位***********\n\t\tapplicant = instance.applicant\n\t\tif applicant\n\t\t\tspace_user_count = db.space_users.find({ space: space_id, user: applicant }).count()\n\t\t\tif space_user_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"提交人已经被删除或不属于当前space\")\n\n\t\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\n\t\t\t\t_.each(current_step.approver_roles, (approver_role) ->\n\t\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\n\t\t\t\t\tif role_count is 0\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"角色已经被删除\")\n\t\t\t\t)\n\n\t\t\t\treturn getHandlersManager.getHandlersByUserAndRoles(applicant, current_step.approver_roles, space_id)\n\t\t\telse\n\t\t\t\tthrow new Meteor.Error('error!', \"审批岗位未指定\")\n\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"Instance的提交人为空\")\n\telse if deal_type is \"applicant\"\n\t\t# 2.***********申请人***********\n\t\tapplicant = instance.applicant\n\t\tspace_user_count = db.space_users.find({ space: space_id, user: applicant }).count()\n\t\tif space_user_count is 0\n\t\t\tthrow new Meteor.Error('error!', \"提交人已经被删除或不属于当前space\")\n\t\telse\n\t\t\treturn new Array(applicant)\n\telse if deal_type is \"orgFieldRole\"\n\t\t# 3.***********部门字段所属组织中的审批岗位***********\n\t\tform_id = current_flow.form\n\t\tform_rev = null\n\t\tif flow_rev is current_flow.current._id\n\t\t\tform_rev = current_flow.current.form_version\n\t\telse\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\n\t\t\t\treturn current_flow_history._id is flow_rev\n\t\t\t)\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\n\n\t\tform = db.forms.findOne(form_id)\n\t\tcurrent_form = null\n\t\tif form_rev is form.current._id\n\t\t\tcurrent_form = form.current\n\t\telse\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\n\t\t\t\treturn form_history._id is form_rev\n\t\t\t)\n\n\t\tapprover_org_field = current_step.approver_org_field\n\t\tform_fields = current_form.fields\n\t\tfield_code = null\n\t\t_.each(form_fields, (form_field) ->\n\t\t\tif form_field._id is approver_org_field\n\t\t\t\tfield_code = form_field.code\n\t\t)\n\n\t\t# 取得最新的values\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\n\t\torg_ids = new Array\n\t\torg_ids_names = new Array\n\t\tif newest_values[field_code]\n\t\t\tif newest_values[field_code] instanceof Array\n\t\t\t\torg_ids_names = newest_values[field_code]\n\t\t\telse\n\t\t\t\torg_ids_names.push(newest_values[field_code])\n\n\t\t# 校验org_id数组中org_id是否合法\n\t\t_.each(org_ids_names, (org) ->\n\t\t\tcheck_org_count = db.organizations.find({ _id: org[\"id\"] }).count()\n\t\t\tif check_org_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"组织ID不合法\")\n\t\t\torg_ids.push(org[\"id\"])\n\t\t)\n\n\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\n\t\t\t# 检查approver_roles中role是否不存在或已经被删除\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\n\t\t\t\tif role_count is 0\n\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"已经被删除\")\n\t\t\t)\n\t\t\treturn getHandlersManager.getHandlersByOrgsAndRoles(org_ids, current_step.approver_roles, instance.space)\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\")\n\telse if deal_type is \"orgField\"\n\t\t# 4.***********部门字段所属组织中的人员***********\n\t\tform_id = current_flow.form\n\t\tform_rev = null\n\t\tif flow_rev is current_flow.current._id\n\t\t\tform_rev = current_flow.current.form_version\n\t\telse\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\n\t\t\t\treturn current_flow_history._id is flow_rev\n\t\t\t)\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\n\n\t\tform = db.forms.findOne(form_id)\n\t\tcurrent_form = null\n\t\tif form_rev is form.current._id\n\t\t\tcurrent_form = form.current\n\t\telse\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\n\t\t\t\treturn form_history._id is form_rev\n\t\t\t)\n\n\t\tapprover_org_field = current_step.approver_org_field\n\t\tform_fields = current_form.fields\n\t\tfield_code = null\n\t\t_.each(form_fields, (form_field)->\n\t\t\tif form_field._id is approver_org_field\n\t\t\t\tfield_code = form_field.code\n\t\t)\n\n\t\t# 取得最新的values\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\n\n\t\torg_ids = new Array\n\t\torg_ids_names = new Array\n\t\tif newest_values[field_code]\n\t\t\tif newest_values[field_code] instanceof Array\n\t\t\t\torg_ids_names = newest_values[field_code]\n\t\t\telse\n\t\t\t\torg_ids_names.push(newest_values[field_code])\n\n\t\t# 校验org_id数组中org_id是否合法\n\t\t_.each(org_ids_names, (org) ->\n\t\t\tcheck_org_count = db.organizations.find({ _id: org[\"id\"] }).count()\n\t\t\tif check_org_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"组织ID不合法\")\n\t\t\torg_ids.push(org[\"id\"])\n\t\t)\n\n\t\t# 校验org下存在处理人\n\t\tuser_ids = new Array\n\t\t_.each(org_ids, (org_id) ->\n\t\t\torg = db.organizations.findOne({ _id: org_id }, { fields: { users: 1 } })\n\t\t\torg_children = db.organizations.find({ space: space_id, parents: org_id }, { fields: { users: 1 } }).fetch()\n\t\t\torg_children.unshift(org)\n\t\t\tcheck_orgs = org_children\n\t\t\torg_users = new Array\n\t\t\t_.each(check_orgs, (check_org_user) ->\n\t\t\t\tif check_org_user.users\n\t\t\t\t\t_.each(check_org_user.users, (org_user) ->\n\t\t\t\t\t\tif db.space_users.find({ space: space_id, user: org_user }).count() is 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"space下不存在此user\")\n\t\t\t\t\t)\n\t\t\t\tuser_ids = user_ids.concat(check_org_user.users)\n\t\t\t\torg_users = org_users.concat(check_org_user.users)\n\t\t\t)\n\n\t\t\tif org_users.length is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"组织\" + org_id + \"不存在处理人\")\n\n\t\t)\n\n\t\tuser_ids = _.uniq(user_ids)\n\t\treturn user_ids\n\telse if deal_type is \"userFieldRole\"\n\t\t# 5.***********人员字段所属组织中的审批岗位***********\n\t\tform_id = current_flow.form\n\t\tform_rev = null\n\t\tif flow_rev is current_flow.current._id\n\t\t\tform_rev = current_flow.current.form_version\n\t\telse\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\n\t\t\t\treturn current_flow_history._id is flow_rev\n\t\t\t)\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\n\n\t\tform = db.forms.findOne(form_id)\n\t\tcurrent_form = null\n\t\tif form_rev is form.current._id\n\t\t\tcurrent_form = form.current\n\t\telse\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\n\t\t\t\treturn form_history._id is form_rev\n\t\t\t)\n\n\t\tapprover_user_field = current_step.approver_user_field\n\t\tform_fields = current_form.fields\n\t\tfield_code = null\n\t\t_.each(form_fields, (form_field) ->\n\t\t\tif form_field._id is approver_user_field\n\t\t\t\tfield_code = form_field.code\n\t\t)\n\n\t\t# 取得最新的values\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\n\t\t# 获取user_id数组\n\t\tuser_ids_names = new Array\n\t\tif newest_values[field_code]\n\t\t\tif newest_values[field_code] instanceof Array\n\t\t\t\tuser_ids_names = newest_values[field_code]\n\t\t\telse\n\t\t\t\tuser_ids_names.push(newest_values[field_code])\n\n\t\t# 校验user_id数组中user_id是否合法\n\t\tuser_ids = new Array\n\t\t_.each(user_ids_names, (user) ->\n\t\t\tcheck_user_count = db.space_users.find({ space: space_id, user: user[\"id\"] }).count()\n\t\t\tif check_user_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"人员ID不合法\")\n\t\t\tuser_ids.push(user[\"id\"])\n\t\t)\n\n\t\tuser_ids = _.uniq(user_ids)\n\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\n\t\t\t# 检查approver_roles中role是否不存在或已经被删除\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\n\t\t\t\tif role_count is 0\n\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"已经被删除\")\n\t\t\t)\n\t\t\treturn getHandlersManager.getHandlersByUsersAndRoles(user_ids, current_step.approver_roles, instance.space)\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\")\n\telse if deal_type is \"userField\"\n\t\t# 6.***********表单人员字段***********\n\t\tform_id = current_flow.form\n\t\tform_rev = null\n\t\tif flow_rev is current_flow.current._id\n\t\t\tform_rev = current_flow.current.form_version\n\t\telse\n\t\t\tcurrent_flow_version = _.find(current_flow.historys, (current_flow_history) ->\n\t\t\t\treturn current_flow_history._id is flow_rev\n\t\t\t)\n\t\t\tform_rev = current_flow_version.form_version if current_flow_version\n\n\t\tform = db.forms.findOne(form_id)\n\t\tcurrent_form = null\n\t\tif form_rev is form.current._id\n\t\t\tcurrent_form = form.current\n\t\telse\n\t\t\tcurrent_form = _.find(form.historys, (form_history) ->\n\t\t\t\treturn form_history._id is form_rev\n\t\t\t)\n\n\t\tapprover_user_field = current_step.approver_user_field\n\t\tform_fields = current_form.fields\n\t\tfield_code = null\n\t\t_.each(form_fields, (form_field)->\n\t\t\tif form_field._id is approver_user_field\n\t\t\t\tfield_code = form_field.code\n\t\t)\n\n\t\t# 取得最新的values\n\t\tnewest_values = uuflowManager.getUpdatedValues(instance)\n\n\t\t# 获取user_id数组\n\t\tuser_ids_names = new Array\n\t\tif newest_values[field_code]\n\t\t\tif newest_values[field_code] instanceof Array\n\t\t\t\tuser_ids_names = newest_values[field_code]\n\t\t\telse\n\t\t\t\tuser_ids_names.push(newest_values[field_code])\n\n\t\t# 校验user_id数组中user_id是否合法\n\t\tuser_ids = new Array\n\t\t_.each(user_ids_names, (user) ->\n\t\t\tcheck_user_count = db.space_users.find({ space: space_id, user: user[\"id\"] }).count()\n\t\t\tif check_user_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"人员ID不合法\")\n\t\t\tuser_ids.push(user[\"id\"])\n\t\t)\n\n\t\tuser_ids = _.uniq(user_ids)\n\t\treturn user_ids\n\telse if deal_type is \"specifyStepRole\"\n\t\t# 7.***********指定步骤处理审批岗位***********\n\t\tapprover_step = current_step.approver_step\n\t\tfinished_traces = new Array\n\t\t_.each(instance.traces, (trace) ->\n\t\t\tif trace.step is approver_step\n\t\t\t\tfinished_traces.push(trace)\n\t\t)\n\t\t# 根据start_date取最新的trace\n\t\tmax_startDate_trace = _.max(finished_traces, (t) ->\n\t\t\treturn t.start_date\n\t\t)\n\n\t\tapprove_users = _.pluck(max_startDate_trace.approves, \"user\")\n\n\t\tif current_step.approver_roles\n\t\t\t_.each(current_step.approver_roles, (approver_role) ->\n\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\n\t\t\t\tif role_count is 0\n\t\t\t\t\tthrow new Meteor.Error('error!', \"角色已经被删除\")\n\t\t\t)\n\n\t\t# 验证查到的user是否都合法\n\t\t_.each(approve_users, (approve_user) ->\n\t\t\tif db.space_users.find({ space: space_id, user: approve_user }).count() is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"指定步骤的处理人已经变更\")\n\t\t)\n\n\t\treturn getHandlersManager.getHandlersByUsersAndRoles(approve_users, current_step.approver_roles, space_id)\n\telse if deal_type is \"specifyStepUser\"\n\t\t# 8.***********指定步骤处理人***********\n\t\tapprover_step = current_step.approver_step\n\t\tfinished_traces = new Array\n\t\t_.each(instance.traces, (trace) ->\n\t\t\tif trace.step is approver_step\n\t\t\t\tfinished_traces.push(trace)\n\t\t)\n\t\t# 根据start_date取最新的trace\n\t\tmax_startDate_trace = _.max(finished_traces, (t) ->\n\t\t\treturn t.start_date\n\t\t)\n\n\t\tapprove_users = _.pluck(max_startDate_trace.approves, \"user\")\n\n\t\t# 验证查到的user是否都合法\n\t\t_.each(approve_users, (approve_user)->\n\t\t\tcheck_approve_user_count = db.space_users.find({ space: space_id, user: approve_user }).count()\n\t\t\tif check_approve_user_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"指定步骤的处理人已经变更\")\n\t\t)\n\n\t\tapprove_users = _.uniq(approve_users)\n\t\treturn approve_users\n\telse if deal_type is \"submitterRole\"\n\t\t# 9.***********填单人所属组织中的审批岗位***********\n\t\tsubmitter = instance.submitter\n\t\tif not submitter\n\t\t\t# 判断提交人是否已经被删除\n\t\t\tsubmitter_user_count = db.space_users.find({ space: space_id, user: submitter }).count()\n\t\t\tif submitter_user_count is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"提交人已经被删除或不属于当前工作区\")\n\t\t\telse\n\t\t\t\tif current_step.approver_roles and current_step.approver_roles.length > 0\n\t\t\t\t\t# 检查approver_roles中role是否不存在或已经被删除\n\t\t\t\t\t_.each(current_step.approver_roles, (approver_role) ->\n\t\t\t\t\t\trole_count = db.flow_roles.find({ _id: approver_role }).count()\n\t\t\t\t\t\tif role_count is 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', approver_role + \"已经被删除\")\n\t\t\t\t\t)\n\t\t\t\t\treturn getHandlersManager.getHandlersByUserAndRoles(submitter, current_step.approver_roles, space_id)\n\t\t\t\telse\n\t\t\t\t\tthrow new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\")\n\t\telse\n\t\t\tthrow new Meteor.Error('error!', \"申请单的提交人为空\")\n\telse if deal_type is \"submitter\"\n\t\t# 10.***********提交人***********\n\t\tsubmitter = instance.submitter\n\t\t# 判断提交人是否已经被删除\n\t\tsubmitter_user_count = db.space_users.find({ space: space_id, user: submitter }).count()\n\t\tif submitter_user_count is 0\n\t\t\tthrow new Meteor.Error('error!', \"提交人已经被删除或不属于当前工作区\")\n\t\telse\n\t\t\treturn new Array(submitter)\n\telse if deal_type is \"specifyOrg\"\n\t\t# 11.***********某部门内的所有人***********\n\t\tapprover_org_ids = current_step.approver_orgs\n\t\tif not approver_org_ids or approver_org_ids.length is 0\n\t\t\tthrow new Meteor.Error('error!', \"未定义用于查找下一步处理人的部门，请联系管理员调查流程图的配置是否正确\")\n\n\t\t# 验证所指定的organization_id都存在\n\t\tvalid_approver_org_ids = new Array\n\t\t_.each(approver_org_ids, (approver_org_id) ->\n\t\t\tif db.organizations.find({ _id: approver_org_id }).count() > 0\n\t\t\t\tvalid_approver_org_ids.unshift(approver_org_id)\n\t\t)\n\n\t\torg_user_ids = new Array\n\t\t_.each(valid_approver_org_ids, (valid_approver_org_id) ->\n\t\t\tvalid_approver_org = db.organizations.findOne({ _id: valid_approver_org_id }, { fields: { users: 1 } })\n\t\t\tif valid_approver_org.users\n\t\t\t\torg_user_ids = org_user_ids.concat(valid_approver_org.users)\n\n\t\t\tchild_orgs = db.organizations.find({ space: space_id, parents: valid_approver_org_id }, { fields: { users: 1 } }).fetch()\n\t\t\t_.each(child_orgs, (child_org) ->\n\t\t\t\tif child_org.users\n\t\t\t\t\torg_user_ids = org_user_ids.concat(child_org.users)\n\t\t\t)\n\t\t)\n\n\t\torg_user_ids = _.uniq(org_user_ids)\n\t\tnew_org_user_ids = new Array\n\t\t_.each(org_user_ids, (org_user_id) ->\n\t\t\tspace_user_info_count = db.space_users.find({ space: space_id, user: org_user_id }).count()\n\t\t\tif space_user_info_count > 0\n\t\t\t\tnew_org_user_ids.push(org_user_id)\n\t\t)\n\n\t\treturn new_org_user_ids\n\telse if deal_type is \"specifyUser\"\n\t\t# 12.***********指定的人员***********\n\t\tapprover_user_ids = current_step.approver_users\n\t\tapprover_user_ids = _.uniq(approver_user_ids)\n\t\tnew_approver_user_ids = new Array\n\t\t_.each(approver_user_ids, (approver_user_id) ->\n\t\t\tspace_user_info_count = db.space_users.find({ space: space_id, user: approver_user_id }).count()\n\t\t\tif space_user_info_count > 0\n\t\t\t\tnew_approver_user_ids.push(approver_user_id)\n\t\t)\n\n\t\treturn new_approver_user_ids\n\telse if deal_type is \"pickupAtRuntime\"\n\t\t# 13.***********审批时指定***********\n\t\tnext_step_users = new Array\n\t\t_trace = _.find(instance.traces, (_tr) ->\n\t\t\treturn _tr.is_finished is false\n\t\t)\n\t\t_approve = _.find(_trace.approves, (_app) ->\n\t\t\treturn _app.is_finished is false and _app.type isnt 'cc'\n\t\t)\n\n\t\tif _approve.next_steps\n\t\t\tif _approve.next_steps[0][\"users\"]\n\t\t\t\tnext_step_users = _approve.next_steps[0][\"users\"]\n\n\t\treturn next_step_users\n\telse if deal_type is \"applicantSuperior\"\n\t\t# 14.***********申请人上级主管***********\n\t\tapplicantSuperiors = new Array\n\t\t_space_user = db.space_users.findOne({ space: space_id, user: instance.applicant }, { fields: { manager: 1 } })\n\t\tif _space_user.manager\n\t\t\tapplicantSuperiors.push(_space_user.manager)\n\n\t\treturn applicantSuperiors","                       \n\ngetHandlersManager = {};\n\ngetHandlersManager.getHandlersByUsersAndRoles = function(user_ids, role_ids, space_id) {\n  var approve_users;\n  approve_users = new Array;\n  _.each(user_ids, function(user_id) {\n    var users;\n    if (db.users.find({\n      _id: user_id\n    }).count() > 0) {\n      users = getHandlersManager.getHandlersByUserAndRoles(user_id, role_ids, space_id);\n      if (users.length > 0) {\n        return approve_users = approve_users.concat(users);\n      }\n    } else {\n      throw new Meteor.Error('error!', \"user_id不合法不合法\");\n    }\n  });\n  approve_users = _.uniq(approve_users);\n  return approve_users;\n};\n\ngetHandlersManager.getHandlersByUserAndRoles = function(user_id, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(role_ids, function(role_id) {\n    var users;\n    if (db.flow_roles.find({\n      _id: role_id\n    }).count() > 0) {\n      users = getHandlersManager.getHandlersByUserAndRole(user_id, role_id, space_id);\n      if (users.length > 0) {\n        return user_ids = user_ids.concat(users);\n      }\n    } else {\n      throw new Meteor.Error('error!', \"role_id已经被删除\");\n    }\n  });\n  if (user_ids.length > 0) {\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else {\n    throw new Meteor.Error('error!', \"根据user_id和role_ids没查到对应的处理人\");\n  }\n};\n\ngetHandlersManager.getHandlersByUserAndRole = function(user_id, role_id, space_id) {\n  var orgs, user_ids;\n  orgs = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      _id: 1\n    }\n  }).fetch();\n  user_ids = new Array;\n  _.each(orgs, function(org) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRole(org._id, role_id, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlersByOrgsAndRoles = function(org_ids, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(org_ids, function(org_id) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRoles(org_id, role_ids, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlersByOrgAndRoles = function(org_id, role_ids, space_id) {\n  var user_ids;\n  user_ids = new Array;\n  _.each(role_ids, function(role_id) {\n    var users;\n    users = getHandlersManager.getHandlersByOrgAndRole(org_id, role_id, space_id);\n    if (users.length > 0) {\n      return user_ids = user_ids.concat(users);\n    }\n  });\n  if (user_ids.length > 0) {\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else {\n    throw new Meteor.Error('error!', \"根据org_id和role_ids没查到对应的处理人\");\n  }\n};\n\ngetHandlersManager.getHandlersByOrgAndRole = function(org_id, role_id, space_id) {\n  var org, parents, positions, user_ids;\n  org = db.organizations.findOne({\n    _id: org_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  });\n  user_ids = new Array;\n  positions = db.flow_positions.find({\n    space: space_id,\n    org: org_id,\n    role: role_id\n  }, {\n    fields: {\n      users: 1\n    }\n  }).fetch();\n  _.each(positions, function(position) {\n    return user_ids = user_ids.concat(position.users);\n  });\n  if (user_ids.length === 0) {\n    parents = org.parents;\n    _.each(parents, function(parent_id) {\n      positions = db.flow_positions.find({\n        space: space_id,\n        org: parent_id,\n        role: role_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      if (positions.length > 0) {\n        return _.each(positions, function(position) {\n          return user_ids = user_ids.concat(position.users);\n        });\n      }\n    });\n  }\n  user_ids = _.uniq(user_ids);\n  return user_ids;\n};\n\ngetHandlersManager.getHandlers = function(instance_id, step_id) {\n  var _approve, _space_user, _trace, applicant, applicantSuperiors, approve_users, approver_org_field, approver_org_ids, approver_step, approver_user_field, approver_user_ids, current, current_flow, current_flow_version, current_form, current_step, current_steps, deal_type, field_code, finished_traces, flow_id, flow_rev, form, form_fields, form_id, form_rev, handlers, instance, max_startDate_trace, new_approver_user_ids, new_org_user_ids, newest_values, next_step_users, org_ids, org_ids_names, org_user_ids, space_id, space_user_count, submitter, submitter_user_count, unfinished_trace, user_ids, user_ids_names, users, valid_approver_org_ids;\n  instance = db.instances.findOne(instance_id);\n  if (instance.step_approve && instance.step_approve[step_id]) {\n    return instance.step_approve[step_id];\n  }\n  approve_users = new Array;\n  space_id = instance.space;\n  flow_id = instance.flow;\n  flow_rev = instance.flow_version;\n  current_flow = db.flows.findOne(flow_id);\n  current_step = null;\n  current_steps = new Array;\n  if (current_flow.current._id === flow_rev) {\n    current_steps = current_flow.current.steps;\n  } else {\n    current = _.find(current_flow.historys, function(history) {\n      return history._id === flow_rev;\n    });\n    current_steps = current.steps;\n  }\n  current_step = _.find(current_steps, function(step) {\n    return step._id === step_id;\n  });\n  if (current_step.step_type === \"condition\") {\n    unfinished_trace = _.find(instance.traces, function(trace) {\n      return trace.is_finished === false;\n    });\n    return new Array(unfinished_trace.approves[0].user);\n  }\n  if (current_step.step_type === \"start\") {\n    handlers = new Array;\n    handlers.push(instance.applicant);\n    handlers.push(instance.submitter);\n    handlers = _.uniq(handlers);\n    return handlers;\n  }\n  deal_type = current_step.deal_type;\n  users = new Array;\n  if (deal_type === \"applicantRole\") {\n    applicant = instance.applicant;\n    if (applicant) {\n      space_user_count = db.space_users.find({\n        space: space_id,\n        user: applicant\n      }).count();\n      if (space_user_count === 0) {\n        throw new Meteor.Error('error!', \"提交人已经被删除或不属于当前space\");\n      }\n      if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n        _.each(current_step.approver_roles, function(approver_role) {\n          var role_count;\n          role_count = db.flow_roles.find({\n            _id: approver_role\n          }).count();\n          if (role_count === 0) {\n            throw new Meteor.Error('error!', \"角色已经被删除\");\n          }\n        });\n        return getHandlersManager.getHandlersByUserAndRoles(applicant, current_step.approver_roles, space_id);\n      } else {\n        throw new Meteor.Error('error!', \"审批岗位未指定\");\n      }\n    } else {\n      throw new Meteor.Error('error!', \"Instance的提交人为空\");\n    }\n  } else if (deal_type === \"applicant\") {\n    applicant = instance.applicant;\n    space_user_count = db.space_users.find({\n      space: space_id,\n      user: applicant\n    }).count();\n    if (space_user_count === 0) {\n      throw new Meteor.Error('error!', \"提交人已经被删除或不属于当前space\");\n    } else {\n      return new Array(applicant);\n    }\n  } else if (deal_type === \"orgFieldRole\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_org_field = current_step.approver_org_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_org_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    org_ids = new Array;\n    org_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        org_ids_names = newest_values[field_code];\n      } else {\n        org_ids_names.push(newest_values[field_code]);\n      }\n    }\n    _.each(org_ids_names, function(org) {\n      var check_org_count;\n      check_org_count = db.organizations.find({\n        _id: org[\"id\"]\n      }).count();\n      if (check_org_count === 0) {\n        throw new Meteor.Error('error!', \"组织ID不合法\");\n      }\n      return org_ids.push(org[\"id\"]);\n    });\n    if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', approver_role + \"已经被删除\");\n        }\n      });\n      return getHandlersManager.getHandlersByOrgsAndRoles(org_ids, current_step.approver_roles, instance.space);\n    } else {\n      throw new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\");\n    }\n  } else if (deal_type === \"orgField\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_org_field = current_step.approver_org_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_org_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    org_ids = new Array;\n    org_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        org_ids_names = newest_values[field_code];\n      } else {\n        org_ids_names.push(newest_values[field_code]);\n      }\n    }\n    _.each(org_ids_names, function(org) {\n      var check_org_count;\n      check_org_count = db.organizations.find({\n        _id: org[\"id\"]\n      }).count();\n      if (check_org_count === 0) {\n        throw new Meteor.Error('error!', \"组织ID不合法\");\n      }\n      return org_ids.push(org[\"id\"]);\n    });\n    user_ids = new Array;\n    _.each(org_ids, function(org_id) {\n      var check_orgs, org, org_children, org_users;\n      org = db.organizations.findOne({\n        _id: org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      });\n      org_children = db.organizations.find({\n        space: space_id,\n        parents: org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      org_children.unshift(org);\n      check_orgs = org_children;\n      org_users = new Array;\n      _.each(check_orgs, function(check_org_user) {\n        if (check_org_user.users) {\n          _.each(check_org_user.users, function(org_user) {\n            if (db.space_users.find({\n              space: space_id,\n              user: org_user\n            }).count() === 0) {\n              throw new Meteor.Error('error!', \"space下不存在此user\");\n            }\n          });\n        }\n        user_ids = user_ids.concat(check_org_user.users);\n        return org_users = org_users.concat(check_org_user.users);\n      });\n      if (org_users.length === 0) {\n        throw new Meteor.Error('error!', \"组织\" + org_id + \"不存在处理人\");\n      }\n    });\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else if (deal_type === \"userFieldRole\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_user_field = current_step.approver_user_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_user_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    user_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        user_ids_names = newest_values[field_code];\n      } else {\n        user_ids_names.push(newest_values[field_code]);\n      }\n    }\n    user_ids = new Array;\n    _.each(user_ids_names, function(user) {\n      var check_user_count;\n      check_user_count = db.space_users.find({\n        space: space_id,\n        user: user[\"id\"]\n      }).count();\n      if (check_user_count === 0) {\n        throw new Meteor.Error('error!', \"人员ID不合法\");\n      }\n      return user_ids.push(user[\"id\"]);\n    });\n    user_ids = _.uniq(user_ids);\n    if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', approver_role + \"已经被删除\");\n        }\n      });\n      return getHandlersManager.getHandlersByUsersAndRoles(user_ids, current_step.approver_roles, instance.space);\n    } else {\n      throw new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\");\n    }\n  } else if (deal_type === \"userField\") {\n    form_id = current_flow.form;\n    form_rev = null;\n    if (flow_rev === current_flow.current._id) {\n      form_rev = current_flow.current.form_version;\n    } else {\n      current_flow_version = _.find(current_flow.historys, function(current_flow_history) {\n        return current_flow_history._id === flow_rev;\n      });\n      if (current_flow_version) {\n        form_rev = current_flow_version.form_version;\n      }\n    }\n    form = db.forms.findOne(form_id);\n    current_form = null;\n    if (form_rev === form.current._id) {\n      current_form = form.current;\n    } else {\n      current_form = _.find(form.historys, function(form_history) {\n        return form_history._id === form_rev;\n      });\n    }\n    approver_user_field = current_step.approver_user_field;\n    form_fields = current_form.fields;\n    field_code = null;\n    _.each(form_fields, function(form_field) {\n      if (form_field._id === approver_user_field) {\n        return field_code = form_field.code;\n      }\n    });\n    newest_values = uuflowManager.getUpdatedValues(instance);\n    user_ids_names = new Array;\n    if (newest_values[field_code]) {\n      if (newest_values[field_code] instanceof Array) {\n        user_ids_names = newest_values[field_code];\n      } else {\n        user_ids_names.push(newest_values[field_code]);\n      }\n    }\n    user_ids = new Array;\n    _.each(user_ids_names, function(user) {\n      var check_user_count;\n      check_user_count = db.space_users.find({\n        space: space_id,\n        user: user[\"id\"]\n      }).count();\n      if (check_user_count === 0) {\n        throw new Meteor.Error('error!', \"人员ID不合法\");\n      }\n      return user_ids.push(user[\"id\"]);\n    });\n    user_ids = _.uniq(user_ids);\n    return user_ids;\n  } else if (deal_type === \"specifyStepRole\") {\n    approver_step = current_step.approver_step;\n    finished_traces = new Array;\n    _.each(instance.traces, function(trace) {\n      if (trace.step === approver_step) {\n        return finished_traces.push(trace);\n      }\n    });\n    max_startDate_trace = _.max(finished_traces, function(t) {\n      return t.start_date;\n    });\n    approve_users = _.pluck(max_startDate_trace.approves, \"user\");\n    if (current_step.approver_roles) {\n      _.each(current_step.approver_roles, function(approver_role) {\n        var role_count;\n        role_count = db.flow_roles.find({\n          _id: approver_role\n        }).count();\n        if (role_count === 0) {\n          throw new Meteor.Error('error!', \"角色已经被删除\");\n        }\n      });\n    }\n    _.each(approve_users, function(approve_user) {\n      if (db.space_users.find({\n        space: space_id,\n        user: approve_user\n      }).count() === 0) {\n        throw new Meteor.Error('error!', \"指定步骤的处理人已经变更\");\n      }\n    });\n    return getHandlersManager.getHandlersByUsersAndRoles(approve_users, current_step.approver_roles, space_id);\n  } else if (deal_type === \"specifyStepUser\") {\n    approver_step = current_step.approver_step;\n    finished_traces = new Array;\n    _.each(instance.traces, function(trace) {\n      if (trace.step === approver_step) {\n        return finished_traces.push(trace);\n      }\n    });\n    max_startDate_trace = _.max(finished_traces, function(t) {\n      return t.start_date;\n    });\n    approve_users = _.pluck(max_startDate_trace.approves, \"user\");\n    _.each(approve_users, function(approve_user) {\n      var check_approve_user_count;\n      check_approve_user_count = db.space_users.find({\n        space: space_id,\n        user: approve_user\n      }).count();\n      if (check_approve_user_count === 0) {\n        throw new Meteor.Error('error!', \"指定步骤的处理人已经变更\");\n      }\n    });\n    approve_users = _.uniq(approve_users);\n    return approve_users;\n  } else if (deal_type === \"submitterRole\") {\n    submitter = instance.submitter;\n    if (!submitter) {\n      submitter_user_count = db.space_users.find({\n        space: space_id,\n        user: submitter\n      }).count();\n      if (submitter_user_count === 0) {\n        throw new Meteor.Error('error!', \"提交人已经被删除或不属于当前工作区\");\n      } else {\n        if (current_step.approver_roles && current_step.approver_roles.length > 0) {\n          _.each(current_step.approver_roles, function(approver_role) {\n            var role_count;\n            role_count = db.flow_roles.find({\n              _id: approver_role\n            }).count();\n            if (role_count === 0) {\n              throw new Meteor.Error('error!', approver_role + \"已经被删除\");\n            }\n          });\n          return getHandlersManager.getHandlersByUserAndRoles(submitter, current_step.approver_roles, space_id);\n        } else {\n          throw new Meteor.Error('error!', \"流程步骤\" + current_step.name + \"审批岗位未指定\");\n        }\n      }\n    } else {\n      throw new Meteor.Error('error!', \"申请单的提交人为空\");\n    }\n  } else if (deal_type === \"submitter\") {\n    submitter = instance.submitter;\n    submitter_user_count = db.space_users.find({\n      space: space_id,\n      user: submitter\n    }).count();\n    if (submitter_user_count === 0) {\n      throw new Meteor.Error('error!', \"提交人已经被删除或不属于当前工作区\");\n    } else {\n      return new Array(submitter);\n    }\n  } else if (deal_type === \"specifyOrg\") {\n    approver_org_ids = current_step.approver_orgs;\n    if (!approver_org_ids || approver_org_ids.length === 0) {\n      throw new Meteor.Error('error!', \"未定义用于查找下一步处理人的部门，请联系管理员调查流程图的配置是否正确\");\n    }\n    valid_approver_org_ids = new Array;\n    _.each(approver_org_ids, function(approver_org_id) {\n      if (db.organizations.find({\n        _id: approver_org_id\n      }).count() > 0) {\n        return valid_approver_org_ids.unshift(approver_org_id);\n      }\n    });\n    org_user_ids = new Array;\n    _.each(valid_approver_org_ids, function(valid_approver_org_id) {\n      var child_orgs, valid_approver_org;\n      valid_approver_org = db.organizations.findOne({\n        _id: valid_approver_org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      });\n      if (valid_approver_org.users) {\n        org_user_ids = org_user_ids.concat(valid_approver_org.users);\n      }\n      child_orgs = db.organizations.find({\n        space: space_id,\n        parents: valid_approver_org_id\n      }, {\n        fields: {\n          users: 1\n        }\n      }).fetch();\n      return _.each(child_orgs, function(child_org) {\n        if (child_org.users) {\n          return org_user_ids = org_user_ids.concat(child_org.users);\n        }\n      });\n    });\n    org_user_ids = _.uniq(org_user_ids);\n    new_org_user_ids = new Array;\n    _.each(org_user_ids, function(org_user_id) {\n      var space_user_info_count;\n      space_user_info_count = db.space_users.find({\n        space: space_id,\n        user: org_user_id\n      }).count();\n      if (space_user_info_count > 0) {\n        return new_org_user_ids.push(org_user_id);\n      }\n    });\n    return new_org_user_ids;\n  } else if (deal_type === \"specifyUser\") {\n    approver_user_ids = current_step.approver_users;\n    approver_user_ids = _.uniq(approver_user_ids);\n    new_approver_user_ids = new Array;\n    _.each(approver_user_ids, function(approver_user_id) {\n      var space_user_info_count;\n      space_user_info_count = db.space_users.find({\n        space: space_id,\n        user: approver_user_id\n      }).count();\n      if (space_user_info_count > 0) {\n        return new_approver_user_ids.push(approver_user_id);\n      }\n    });\n    return new_approver_user_ids;\n  } else if (deal_type === \"pickupAtRuntime\") {\n    next_step_users = new Array;\n    _trace = _.find(instance.traces, function(_tr) {\n      return _tr.is_finished === false;\n    });\n    _approve = _.find(_trace.approves, function(_app) {\n      return _app.is_finished === false && _app.type !== 'cc';\n    });\n    if (_approve.next_steps) {\n      if (_approve.next_steps[0][\"users\"]) {\n        next_step_users = _approve.next_steps[0][\"users\"];\n      }\n    }\n    return next_step_users;\n  } else if (deal_type === \"applicantSuperior\") {\n    applicantSuperiors = new Array;\n    _space_user = db.space_users.findOne({\n      space: space_id,\n      user: instance.applicant\n    }, {\n      fields: {\n        manager: 1\n      }\n    });\n    if (_space_user.manager) {\n      applicantSuperiors.push(_space_user.manager);\n    }\n    return applicantSuperiors;\n  }\n};\n","permissionManager = {}\n\npermissionManager.getFlowPermissions = (flow_id, user_id) ->\n\t# 根据:flow_id查到对应的flow\n\tflow = uuflowManager.getFlow(flow_id)\n\tspace_id = flow.space\n\t# 根据space_id和:user_id到organizations表中查到用户所属所有的org_id（包括上级组ID）\n\torg_ids = new Array\n\torganizations = db.organizations.find({\n\t\tspace: space_id, users: user_id }, { fields: { parents: 1 } }).fetch()\n\t_.each(organizations, (org) ->\n\t\torg_ids.push(org._id)\n\t\tif org.parents\n\t\t\t_.each(org.parents, (parent_id) ->\n\t\t\t\torg_ids.push(parent_id)\n\t\t\t)\n\t)\n\torg_ids = _.uniq(org_ids)\n\tmy_permissions = new Array\n\tif flow.perms\n\t\t# 判断flow.perms.users_can_admin中是否包含当前用户，\n\t\t# 或者flow.perms.orgs_can_add是否包含4步得到的org_id数组中的任何一个，\n\t\t# 若是，则在返回的数组中加上add\n\t\tif flow.perms.users_can_add\n\t\t\tusers_can_add = flow.perms.users_can_add\n\t\t\tif users_can_add.includes(user_id)\n\t\t\t\tmy_permissions.push(\"add\")\n\n\t\tif flow.perms.orgs_can_add\n\t\t\torgs_can_add = flow.perms.orgs_can_add\n\t\t\t_.each(org_ids, (org_id) ->\n\t\t\t\tif orgs_can_add.includes(org_id)\n\t\t\t\t\tmy_permissions.push(\"add\")\n\t\t\t)\n\t\t# 判断flow.perms.users_can_monitor中是否包含当前用户，\n\t\t# 或者flow.perms.orgs_can_monitor是否包含4步得到的org_id数组中的任何一个，\n\t\t# 若是，则在返回的数组中加上monitor\n\t\tif flow.perms.users_can_monitor\n\t\t\tusers_can_monitor = flow.perms.users_can_monitor\n\t\t\tif users_can_monitor.includes(user_id)\n\t\t\t\tmy_permissions.push(\"monitor\")\n\n\t\tif flow.perms.orgs_can_monitor\n\t\t\torgs_can_monitor = flow.perms.orgs_can_monitor\n\t\t\t_.each(org_ids, (org_id) ->\n\t\t\t\tif orgs_can_monitor.includes(org_id)\n\t\t\t\t\tmy_permissions.push(\"monitor\")\n\t\t\t)\n\t\t# 判断flow.perms.users_can_admin中是否包含当前用户，\n\t\t# 或者flow.perms.orgs_can_admin是否包含4步得到的org_id数组中的任何一个，\n\t\t# 若是，则在返回的数组中加上admin\n\t\tif flow.perms.users_can_admin\n\t\t\tusers_can_admin = flow.perms.users_can_admin\n\t\t\tif users_can_admin.includes(user_id)\n\t\t\t\tmy_permissions.push(\"admin\")\n\n\t\tif flow.perms.orgs_can_admin\n\t\t\torgs_can_admin = flow.perms.orgs_can_admin\n\t\t\t_.each(org_ids, (org_id) ->\n\t\t\t\tif orgs_can_admin.includes(org_id)\n\t\t\t\t\tmy_permissions.push(\"admin\")\n\t\t\t)\n\n\tmy_permissions = _.uniq(my_permissions)\n\treturn my_permissions","                      \n\npermissionManager = {};\n\npermissionManager.getFlowPermissions = function(flow_id, user_id) {\n  var flow, my_permissions, org_ids, organizations, orgs_can_add, orgs_can_admin, orgs_can_monitor, space_id, users_can_add, users_can_admin, users_can_monitor;\n  flow = uuflowManager.getFlow(flow_id);\n  space_id = flow.space;\n  org_ids = new Array;\n  organizations = db.organizations.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      parents: 1\n    }\n  }).fetch();\n  _.each(organizations, function(org) {\n    org_ids.push(org._id);\n    if (org.parents) {\n      return _.each(org.parents, function(parent_id) {\n        return org_ids.push(parent_id);\n      });\n    }\n  });\n  org_ids = _.uniq(org_ids);\n  my_permissions = new Array;\n  if (flow.perms) {\n    if (flow.perms.users_can_add) {\n      users_can_add = flow.perms.users_can_add;\n      if (users_can_add.includes(user_id)) {\n        my_permissions.push(\"add\");\n      }\n    }\n    if (flow.perms.orgs_can_add) {\n      orgs_can_add = flow.perms.orgs_can_add;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_add.includes(org_id)) {\n          return my_permissions.push(\"add\");\n        }\n      });\n    }\n    if (flow.perms.users_can_monitor) {\n      users_can_monitor = flow.perms.users_can_monitor;\n      if (users_can_monitor.includes(user_id)) {\n        my_permissions.push(\"monitor\");\n      }\n    }\n    if (flow.perms.orgs_can_monitor) {\n      orgs_can_monitor = flow.perms.orgs_can_monitor;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_monitor.includes(org_id)) {\n          return my_permissions.push(\"monitor\");\n        }\n      });\n    }\n    if (flow.perms.users_can_admin) {\n      users_can_admin = flow.perms.users_can_admin;\n      if (users_can_admin.includes(user_id)) {\n        my_permissions.push(\"admin\");\n      }\n    }\n    if (flow.perms.orgs_can_admin) {\n      orgs_can_admin = flow.perms.orgs_can_admin;\n      _.each(org_ids, function(org_id) {\n        if (orgs_can_admin.includes(org_id)) {\n          return my_permissions.push(\"admin\");\n        }\n      });\n    }\n  }\n  my_permissions = _.uniq(my_permissions);\n  return my_permissions;\n};\n","approveManager = {}\n\n\n###\n    对比approve_values与last_values 对象， 返回approve_values比last_values多出的或者改变的部分\n###\napproveManager.getChangeValues = (last_values,approve_values) ->\n\n\tchangeValues = {}\n\n\tlast_values_keys = _.keys(last_values)\n\n\tapprove_values_keys = _.keys(approve_values)\n\n#\tconsole.log(\"last_values_keys\", last_values_keys)\n#\n#\tconsole.log(\"approve_values_keys\", approve_values_keys)\n\n\tapprove_values_keys.forEach (key)->\n\t\tif _.contains(last_values_keys, key)\n\t\t\tif !_.isEqual(last_values[key], approve_values[key])\n\t\t\t\tchangeValues[key] = approve_values[key]\n\t\telse\n\t\t\tif approve_values[key] != ''\n#\t\t\t\tconsole.log(key,approve_values[key])\n\t\t\t\tchangeValues[key] = approve_values[key]\n\n\treturn changeValues\n","                   \n\napproveManager = {};\n\n\n/*\n    对比approve_values与last_values 对象， 返回approve_values比last_values多出的或者改变的部分\n */\n\napproveManager.getChangeValues = function(last_values, approve_values) {\n  var approve_values_keys, changeValues, last_values_keys;\n  changeValues = {};\n  last_values_keys = _.keys(last_values);\n  approve_values_keys = _.keys(approve_values);\n  approve_values_keys.forEach(function(key) {\n    if (_.contains(last_values_keys, key)) {\n      if (!_.isEqual(last_values[key], approve_values[key])) {\n        return changeValues[key] = approve_values[key];\n      }\n    } else {\n      if (approve_values[key] !== '') {\n        return changeValues[key] = approve_values[key];\n      }\n    }\n  });\n  return changeValues;\n};\n","flowManager = {}\n\nflowManager.getCategoriesFlows = (spaceId, categorieId, fields)->\n\n\tcategoriesForms = formManager.getCategoriesForms(spaceId, categorieId, {_id: 1}).fetch()\n\n\treturn db.flows.find({form: {$in : categoriesForms.getProperty(\"_id\")}})\n\nflowManager.getUnCategoriesFlows = (spaceId, fields)->\n\n\tunCategoriesForms = formManager.getUnCategoriesForms(spaceId, {_id: 1}).fetch()\n\n\treturn db.flows.find({form: {$in : unCategoriesForms.getProperty(\"_id\")}})\n\n\n\n\n\n\n\n","formManager = {}\n\nformManager.getCategoriesForms = (spaceId, categorieId, fields)->\n\tif fields\n\t\t_fields = {fields: fields}\n\n\treturn db.forms.find({space: spaceId, category: categorieId, state: \"enabled\"}, _fields)\n\nformManager.getUnCategoriesForms = (spaceId, fields) ->\n\tif fields\n\t\t_fields = {fields: fields}\n\treturn db.forms.find({space: spaceId, category: {$in: [null, \"\"]}, state: \"enabled\"}, _fields)\n","                \n\nformManager = {};\n\nformManager.getCategoriesForms = function(spaceId, categorieId, fields) {\n  var _fields;\n  if (fields) {\n    _fields = {\n      fields: fields\n    };\n  }\n  return db.forms.find({\n    space: spaceId,\n    category: categorieId,\n    state: \"enabled\"\n  }, _fields);\n};\n\nformManager.getUnCategoriesForms = function(spaceId, fields) {\n  var _fields;\n  if (fields) {\n    _fields = {\n      fields: fields\n    };\n  }\n  return db.forms.find({\n    space: spaceId,\n    category: {\n      $in: [null, \"\"]\n    },\n    state: \"enabled\"\n  }, _fields);\n};\n","stepManager = {}\n\nstepManager.allowBatch = (step)->\n\treturn step.step_type == 'counterSign' && step.allowBatch\n\nstepManager.getStep = (instance, flow, step_id)->\n\tflow_rev = instance.flow_version\n\tisExistStep = null\n\tif flow.current._id is flow_rev\n\t\tisExistStep = _.find(flow.current.steps, (step)->\n\t\t\treturn step._id is step_id\n\t\t)\n\telse\n\t\t_.each(flow.historys, (history)->\n\t\t\tif history._id is flow_rev\n\t\t\t\tisExistStep = _.find(history.steps, (step)->\n\t\t\t\t\treturn step._id is step_id\n\t\t\t\t)\n\t\t)\n\n\tif not isExistStep\n\t\tthrow new Meteor.Error('error!', \"不能获取step\")\n\n\treturn isExistStep","                \n\nstepManager = {};\n\nstepManager.allowBatch = function(step) {\n  return step.step_type === 'counterSign' && step.allowBatch;\n};\n\nstepManager.getStep = function(instance, flow, step_id) {\n  var flow_rev, isExistStep;\n  flow_rev = instance.flow_version;\n  isExistStep = null;\n  if (flow.current._id === flow_rev) {\n    isExistStep = _.find(flow.current.steps, function(step) {\n      return step._id === step_id;\n    });\n  } else {\n    _.each(flow.historys, function(history) {\n      if (history._id === flow_rev) {\n        return isExistStep = _.find(history.steps, function(step) {\n          return step._id === step_id;\n        });\n      }\n    });\n  }\n  if (!isExistStep) {\n    throw new Meteor.Error('error!', \"不能获取step\");\n  }\n  return isExistStep;\n};\n","_eval = require('eval')\n\nInstanceManager = {}\n\nlogger = new Logger 'Workflow -> InstanceManager'\n\nInstanceManager.handlerInstanceByFieldMap = (ins, field_map) ->\n\tres = ins\n\tif ins\n\t\tif !field_map\n\n\t\t\tflow = db.flows.findOne({ _id: ins.flow }, { fields: { field_map: 1 } })\n\n\t\t\tif flow?.field_map\n\t\t\t\tfield_map = flow.field_map\n\n\t\tif field_map\n\t\t\tcontext = _.clone(ins)\n\n\t\t\tcontext._ = _\n\n\t\t\tscript = \"var instances = #{field_map}; exports.instances = instances\"\n\t\t\ttry\n\t\t\t\tres = _eval(script, \"handlerInstanceByFieldMap\", context, false).instances\n\t\t\tcatch e\n\t\t\t\tres = { _error: e }\n\t\t\t\tlogger.error e\n\treturn res\n\nInstanceManager.getCurrentApprove = (instance, handler)->\n\n\tif !instance or !instance.traces or instance.traces.length < 1\n\t\treturn\n\n\tcurrentTraces = instance.traces.filterProperty('is_finished', false)\n\n\tif currentTraces.length\n\t\tcurrentApproves = currentTraces[0].approves.filterProperty('is_finished', false).filterProperty('handler', handler)\n\t\tcurrentApprove = if currentApproves.length > 0 then currentApproves[0] else null\n\n\t#传阅的approve返回最新一条\n\tif !currentApprove or currentApprove.type == 'cc'\n\t\t# 当前是传阅\n\t\t_.each instance.traces, (t) ->\n\t\t\t_.each t.approves, (a) ->\n\t\t\t\tif a.type == 'cc' and a.user == handler and a.is_finished == false\n\t\t\t\t\tcurrentApprove = a\n\t\t\t\treturn\n\t\t\treturn\n\n\tif !currentApprove\n\t\treturn\n\n\treturn currentApprove\n\nInstanceManager.getCurrentTrace = (instance, traceId)->\n\treturn instance.traces.findPropertyByPK(\"_id\", traceId)\n\nInstanceManager.getMyApprove = (instanceId, userId)->\n\tinstance = db.instances.findOne({_id: instanceId})\n\n\tflow = uuflowManager.getFlow(instance.flow)\n\n\tmy_approve = InstanceManager.getCurrentApprove(instance, userId)\n\n\tif my_approve\n\n#\t\tlang = Steedos.locale(that.userId, true)\n\n\t\ttrace = InstanceManager.getCurrentTrace(instance, my_approve.trace)\n\n\t\tstep = uuflowManager.getStep(instance, flow, trace.step)\n\n\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\")\n\n\t\tif nextSteps.length == 1\n\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance._id , nextSteps[0])\n\t\t\tif next_user_ids.length == 1\n\t\t\t\tmy_approve.next_steps = [{step: nextSteps[0], users: next_user_ids}]\n\t\t\t\treturn my_approve\n#\t\t\telse\n#\t\t\t\tthrow new Meteor.Error('error!', TAPi18n.__('workflow_error_multiple_next_step_users', {insname: instance.name}, lang))\n#\t\telse\n#\t\t\tthrow new Meteor.Error('error!', TAPi18n.__('workflow_error_multiple_next_step', {insname: instance.name}, lang))\n\n\treturn\n\n\nInstanceManager.getBatchInstances = (space, categoryId, flowIds, inbox_user)->\n\t_batch_instances = new Array()\n\n\tquery = {space: space, inbox_users: inbox_user}\n\n\tFIELDS = {name: 1, applicant_name: 1, submit_date: 1, flow_version: 1, \"traces.step\": 1, flow: 1}\n\n\tif categoryId\n\n\t\tif categoryId == '-1'\n\t\t\tunCategoryFlows = flowManager.getUnCategoriesFlows(space, {_id: 1}).fetch().getProperty(\"_id\")\n\t\t\tquery.flow = {$in: unCategoryFlows}\n\t\telse\n\t\t\tcategoryFlows = flowManager.getCategoriesFlows(space, categoryId, {_id: 1}).fetch().getProperty(\"_id\")\n\t\t\tquery.flow = {$in: categoryFlows}\n\n\tif flowIds\n\t\tquery.flow = {$in: flowIds}\n\n#\tconsole.log(\"query\", JSON.stringify(query))\n\n\tinbox_instances = db.instances.find(query, {fields: FIELDS, skip: 0, limit: 100})\n\n\tinbox_instances.forEach (ins)->\n\t\tcurrentStepId = _.last(ins.traces).step #TODO 此代码不适用传阅批处理\n\n\t\tflow = db.flows.findOne({_id: ins.flow})\n\n\t\tcurrentStep = stepManager.getStep(ins, flow, currentStepId)\n\n\t\tif stepManager.allowBatch(currentStep) && InstanceManager.getMyApprove(ins._id, inbox_user)\n\n\t\t\tdelete ins.flow_version\n\n\t\t\tdelete ins.traces\n\n\t\t\tdelete ins.flow\n\n\t\t\t_batch_instances.push(ins)\n#\t\telse\n#\t\t\tconsole.log(\"批量审批-异常数据\", ins._id)\n\n\treturn _batch_instances\n","var _eval, logger;                 \n\n_eval = require('eval');\n\nInstanceManager = {};\n\nlogger = new Logger('Workflow -> InstanceManager');\n\nInstanceManager.handlerInstanceByFieldMap = function(ins, field_map) {\n  var context, e, flow, res, script;\n  res = ins;\n  if (ins) {\n    if (!field_map) {\n      flow = db.flows.findOne({\n        _id: ins.flow\n      }, {\n        fields: {\n          field_map: 1\n        }\n      });\n      if (flow != null ? flow.field_map : void 0) {\n        field_map = flow.field_map;\n      }\n    }\n    if (field_map) {\n      context = _.clone(ins);\n      context._ = _;\n      script = \"var instances = \" + field_map + \"; exports.instances = instances\";\n      try {\n        res = _eval(script, \"handlerInstanceByFieldMap\", context, false).instances;\n      } catch (error) {\n        e = error;\n        res = {\n          _error: e\n        };\n        logger.error(e);\n      }\n    }\n  }\n  return res;\n};\n\nInstanceManager.getCurrentApprove = function(instance, handler) {\n  var currentApprove, currentApproves, currentTraces;\n  if (!instance || !instance.traces || instance.traces.length < 1) {\n    return;\n  }\n  currentTraces = instance.traces.filterProperty('is_finished', false);\n  if (currentTraces.length) {\n    currentApproves = currentTraces[0].approves.filterProperty('is_finished', false).filterProperty('handler', handler);\n    currentApprove = currentApproves.length > 0 ? currentApproves[0] : null;\n  }\n  if (!currentApprove || currentApprove.type === 'cc') {\n    _.each(instance.traces, function(t) {\n      _.each(t.approves, function(a) {\n        if (a.type === 'cc' && a.user === handler && a.is_finished === false) {\n          currentApprove = a;\n        }\n      });\n    });\n  }\n  if (!currentApprove) {\n    return;\n  }\n  return currentApprove;\n};\n\nInstanceManager.getCurrentTrace = function(instance, traceId) {\n  return instance.traces.findPropertyByPK(\"_id\", traceId);\n};\n\nInstanceManager.getMyApprove = function(instanceId, userId) {\n  var flow, instance, my_approve, nextSteps, next_user_ids, step, trace;\n  instance = db.instances.findOne({\n    _id: instanceId\n  });\n  flow = uuflowManager.getFlow(instance.flow);\n  my_approve = InstanceManager.getCurrentApprove(instance, userId);\n  if (my_approve) {\n    trace = InstanceManager.getCurrentTrace(instance, my_approve.trace);\n    step = uuflowManager.getStep(instance, flow, trace.step);\n    nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\");\n    if (nextSteps.length === 1) {\n      next_user_ids = getHandlersManager.getHandlers(instance._id, nextSteps[0]);\n      if (next_user_ids.length === 1) {\n        my_approve.next_steps = [\n          {\n            step: nextSteps[0],\n            users: next_user_ids\n          }\n        ];\n        return my_approve;\n      }\n    }\n  }\n};\n\nInstanceManager.getBatchInstances = function(space, categoryId, flowIds, inbox_user) {\n  var FIELDS, _batch_instances, categoryFlows, inbox_instances, query, unCategoryFlows;\n  _batch_instances = new Array();\n  query = {\n    space: space,\n    inbox_users: inbox_user\n  };\n  FIELDS = {\n    name: 1,\n    applicant_name: 1,\n    submit_date: 1,\n    flow_version: 1,\n    \"traces.step\": 1,\n    flow: 1\n  };\n  if (categoryId) {\n    if (categoryId === '-1') {\n      unCategoryFlows = flowManager.getUnCategoriesFlows(space, {\n        _id: 1\n      }).fetch().getProperty(\"_id\");\n      query.flow = {\n        $in: unCategoryFlows\n      };\n    } else {\n      categoryFlows = flowManager.getCategoriesFlows(space, categoryId, {\n        _id: 1\n      }).fetch().getProperty(\"_id\");\n      query.flow = {\n        $in: categoryFlows\n      };\n    }\n  }\n  if (flowIds) {\n    query.flow = {\n      $in: flowIds\n    };\n  }\n  inbox_instances = db.instances.find(query, {\n    fields: FIELDS,\n    skip: 0,\n    limit: 100\n  });\n  inbox_instances.forEach(function(ins) {\n    var currentStep, currentStepId, flow;\n    currentStepId = _.last(ins.traces).step;\n    flow = db.flows.findOne({\n      _id: ins.flow\n    });\n    currentStep = stepManager.getStep(ins, flow, currentStepId);\n    if (stepManager.allowBatch(currentStep) && InstanceManager.getMyApprove(ins._id, inbox_user)) {\n      delete ins.flow_version;\n      delete ins.traces;\n      delete ins.flow;\n      return _batch_instances.push(ins);\n    }\n  });\n  return _batch_instances;\n};\n","Meteor.publish 'categories', (spaceId) ->\n\tcheck spaceId, String\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\n\treturn db.categories.find({ space: spaceId }, { fields: { name: 1, space: 1, sort_no: 1, app: 1 } })","Meteor.publish('categories', function(spaceId) {\n  check(spaceId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.categories.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      space: 1,\n      sort_no: 1,\n      app: 1\n    }\n  });\n});\n","\nMeteor.publish 'cfs_instances', (instanceIds)->\n\tcheck(instanceIds, Array)\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless instanceIds\n\t\t\treturn this.ready()\n\n\treturn cfs.instances.find({'metadata.instance': {$in: instanceIds} , $or: [{'metadata.is_private': {$ne: true}},{'metadata.is_private': true, \"metadata.owner\": this.userId}]})\n","Meteor.publish('cfs_instances', function(instanceIds) {\n  check(instanceIds, Array);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceIds) {\n    return this.ready();\n  }\n  return cfs.instances.find({\n    'metadata.instance': {\n      $in: instanceIds\n    },\n    $or: [\n      {\n        'metadata.is_private': {\n          $ne: true\n        }\n      }, {\n        'metadata.is_private': true,\n        \"metadata.owner\": this.userId\n      }\n    ]\n  });\n});\n","\n\nMeteor.publish 'flow_positions', (spaceId)->\n\t\n\tunless this.userId\n\t\treturn this.ready()\n\t\n\tunless spaceId\n\t\treturn this.ready()\n\n\treturn db.flow_positions.find({space: spaceId}, {fields: {role:1, users: 1, org: 1}});\n","Meteor.publish('flow_positions', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.flow_positions.find({\n    space: spaceId\n  }, {\n    fields: {\n      role: 1,\n      users: 1,\n      org: 1\n    }\n  });\n});\n","Meteor.publishComposite 'flow_positions_tabular', (tableName, ids, fields)->\n\tcheck(tableName, String);\n\tcheck(ids, Array);\n\tcheck(fields, Match.Optional(Object));\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tthis.unblock()\n\n\tfind: ->\n\t\tthis.unblock()\n\t\tdb.flow_positions.find {_id: {$in: ids}}, fields: fields\n\n\tchildren: [\n\t\t{\n\t\t\tfind: (position) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related flow_roles\n\t\t\t\tdb.flow_roles.find { _id: position.role }, fields: name: 1\n\t\t}\n\t\t{\n\t\t\tfind: (position) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related organizations\n\t\t\t\tdb.organizations.find { _id: position.org }, fields: fullname: 1\n\t\t}\n\t\t{\n\t\t\tfind: (position) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related user\n\t\t\t\tdb.space_users.find {\n\t\t\t\t\tspace: position.space\n\t\t\t\t\tuser: $in: position.users\n\t\t\t\t}, fields:\n\t\t\t\t\tspace: 1\n\t\t\t\t\tuser: 1\n\t\t\t\t\tname: 1\n\t\t}\n\t]","Meteor.publishComposite('flow_positions_tabular', function(tableName, ids, fields) {\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  if (!this.userId) {\n    return this.ready();\n  }\n  this.unblock();\n  return {\n    find: function() {\n      this.unblock();\n      return db.flow_positions.find({\n        _id: {\n          $in: ids\n        }\n      }, {\n        fields: fields\n      });\n    },\n    children: [\n      {\n        find: function(position) {\n          this.unblock();\n          return db.flow_roles.find({\n            _id: position.role\n          }, {\n            fields: {\n              name: 1\n            }\n          });\n        }\n      }, {\n        find: function(position) {\n          this.unblock();\n          return db.organizations.find({\n            _id: position.org\n          }, {\n            fields: {\n              fullname: 1\n            }\n          });\n        }\n      }, {\n        find: function(position) {\n          this.unblock();\n          return db.space_users.find({\n            space: position.space,\n            user: {\n              $in: position.users\n            }\n          }, {\n            fields: {\n              space: 1,\n              user: 1,\n              name: 1\n            }\n          });\n        }\n      }\n    ]\n  };\n});\n","\n\n\tMeteor.publish 'flow_roles', (spaceId)->\n\t\t\n\t\tunless this.userId\n\t\t\treturn this.ready()\n\t\t\n\t\tunless spaceId\n\t\t\treturn this.ready()\n\n\n\t\treturn db.flow_roles.find({space: spaceId}, {fields: {name:1}});\n","Meteor.publish('flow_roles', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.flow_roles.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1\n    }\n  });\n});\n","Meteor.publish 'flows', (spaceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\t# 第一次订阅时初始化工作区\n\tif db.flows.find({space: spaceId}).count() == 0\n\t\tdb.spaces.createTemplateFormAndFlow(spaceId)\n\n\treturn db.flows.find({space: spaceId}, {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tform: 1,\n\t\t\tstate: 1,\n\t\t\tperms: 1,\n\t\t\tspace: 1,\n\t\t\tcompany_id: 1,\n\t\t\tsort_no: 1\n\t\t}\n\t})\n\n\nMeteor.publish 'flow_version', (spaceId, flowId, versionId) ->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\tunless flowId\n\t\treturn this.ready()\n\n\tunless versionId\n\t\treturn this.ready()\n\n\n\tself = this;\n\n\tgetFlowVersion = (id , versionId)->\n\t\tflow = db.flows.findOne({_id : id});\n\t\tif flow\n\t\t\tflow_version = flow.current\n\t\t\tflow_version.latest = true\n\n\t\t\tif flow_version._id != versionId\n\t\t\t\tflow_version = flow.historys.findPropertyByPK(\"_id\", versionId)\n\t\t\t\tflow_version.latest = false\n\n\t\t\treturn flow_version\n\thandle = db.flows.find({_id: flowId}, {fields: {_id: 1, \"current.modified\": 1}}).observeChanges {\n\t\tchanged: (id)->\n\t\t\tself.changed(\"flow_versions\", versionId, getFlowVersion(id, versionId));\n\t}\n\n\n\tself.added(\"flow_versions\", versionId, getFlowVersion(flowId, versionId));\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()\n\nMeteor.publish 'distribute_optional_flows', (flow_ids)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless flow_ids\n\t\treturn this.ready()\n\n\treturn db.flows.find({_id: {$in: flow_ids}}, {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tform: 1,\n\t\t\tstate: 1,\n\t\t\tperms: 1,\n\t\t\tspace: 1,\n\t\t\tdistribute_optional_users: 1,\n\t\t\tdistribute_to_self: 1,\n\t\t\tdistribute_end_notification: 1,\n\t\t\tcompany_id: 1\n\t\t}\n\t})\n\nMeteor.publish 'flow', (spaceId, flowId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\tunless flowId\n\t\treturn this.ready()\n\n\n\treturn db.flows.find({_id: flowId, space: spaceId}, {\n\t\tfields: {\n\t\t\tprint_template: 1,\n\t\t\tinstance_template: 1,\n\t\t\tevents: 1,\n\t\t\tdistribute_optional_users: 1,\n\t\t\tdistribute_to_self: 1,\n\t\t\tupload_after_being_distributed: 1,\n\t\t\tdistribute_end_notification: 1,\n\t\t\tcompany_id: 1\n\t\t}\n\t})\n\nMeteor.publishComposite 'flows_tabular', (tableName, ids, fields)->\n\tcheck(tableName, String);\n\tcheck(ids, Array);\n\tcheck(fields, Match.Optional(Object));\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tthis.unblock()\n\n\tfind: ->\n\t\tthis.unblock()\n\t\tdb.flows.find {_id: {$in: ids}}, fields: fields\n\n\tchildren: [\n\t\t{\n\t\t\tfind: (flow) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related user\n\t\t\t\tdb.space_users.find {\n\t\t\t\t\tspace: flow.space,\n\t\t\t\t\tuser: flow.current.modified_by\n\t\t\t\t}, fields:\n\t\t\t\t\tspace: 1\n\t\t\t\t\tuser: 1\n\t\t\t\t\tname: 1\n\t\t},\n\t\t{\n\t\t\tfind: (flow) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related user\n\t\t\t\tdb.forms.find {\n\t\t\t\t\tspace: flow.space,\n\t\t\t\t\t_id: flow.form\n\t\t\t\t}, fields:\n\t\t\t\t\tspace: 1\n\t\t\t\t\t_id: 1\n\t\t\t\t\tname: 1,\n\t\t\t\t\tcategory: 1\n\t\t},\n\t\t{\n\t\t\tfind: (flow) ->\n\t\t\t\t@unblock()\n\t\t\t\t# Publish the related user\n\t\t\t\tdb.categories.find {\n\t\t\t\t\tspace: flow.space\n\t\t\t\t}, fields:\n\t\t\t\t\tspace: 1\n\t\t\t\t\t_id: 1\n\t\t\t\t\tname: 1\n\t\t}\n\t]","Meteor.publish('flows', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (db.flows.find({\n    space: spaceId\n  }).count() === 0) {\n    db.spaces.createTemplateFormAndFlow(spaceId);\n  }\n  return db.flows.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      form: 1,\n      state: 1,\n      perms: 1,\n      space: 1,\n      company_id: 1,\n      sort_no: 1\n    }\n  });\n});\n\nMeteor.publish('flow_version', function(spaceId, flowId, versionId) {\n  var getFlowVersion, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!flowId) {\n    return this.ready();\n  }\n  if (!versionId) {\n    return this.ready();\n  }\n  self = this;\n  getFlowVersion = function(id, versionId) {\n    var flow, flow_version;\n    flow = db.flows.findOne({\n      _id: id\n    });\n    if (flow) {\n      flow_version = flow.current;\n      flow_version.latest = true;\n      if (flow_version._id !== versionId) {\n        flow_version = flow.historys.findPropertyByPK(\"_id\", versionId);\n        flow_version.latest = false;\n      }\n      return flow_version;\n    }\n  };\n  handle = db.flows.find({\n    _id: flowId\n  }, {\n    fields: {\n      _id: 1,\n      \"current.modified\": 1\n    }\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"flow_versions\", versionId, getFlowVersion(id, versionId));\n    }\n  });\n  self.added(\"flow_versions\", versionId, getFlowVersion(flowId, versionId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n\nMeteor.publish('distribute_optional_flows', function(flow_ids) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!flow_ids) {\n    return this.ready();\n  }\n  return db.flows.find({\n    _id: {\n      $in: flow_ids\n    }\n  }, {\n    fields: {\n      name: 1,\n      form: 1,\n      state: 1,\n      perms: 1,\n      space: 1,\n      distribute_optional_users: 1,\n      distribute_to_self: 1,\n      distribute_end_notification: 1,\n      company_id: 1\n    }\n  });\n});\n\nMeteor.publish('flow', function(spaceId, flowId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!flowId) {\n    return this.ready();\n  }\n  return db.flows.find({\n    _id: flowId,\n    space: spaceId\n  }, {\n    fields: {\n      print_template: 1,\n      instance_template: 1,\n      events: 1,\n      distribute_optional_users: 1,\n      distribute_to_self: 1,\n      upload_after_being_distributed: 1,\n      distribute_end_notification: 1,\n      company_id: 1\n    }\n  });\n});\n\nMeteor.publishComposite('flows_tabular', function(tableName, ids, fields) {\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  if (!this.userId) {\n    return this.ready();\n  }\n  this.unblock();\n  return {\n    find: function() {\n      this.unblock();\n      return db.flows.find({\n        _id: {\n          $in: ids\n        }\n      }, {\n        fields: fields\n      });\n    },\n    children: [\n      {\n        find: function(flow) {\n          this.unblock();\n          return db.space_users.find({\n            space: flow.space,\n            user: flow.current.modified_by\n          }, {\n            fields: {\n              space: 1,\n              user: 1,\n              name: 1\n            }\n          });\n        }\n      }, {\n        find: function(flow) {\n          this.unblock();\n          return db.forms.find({\n            space: flow.space,\n            _id: flow.form\n          }, {\n            fields: {\n              space: 1,\n              _id: 1,\n              name: 1,\n              category: 1\n            }\n          });\n        }\n      }, {\n        find: function(flow) {\n          this.unblock();\n          return db.categories.find({\n            space: flow.space\n          }, {\n            fields: {\n              space: 1,\n              _id: 1,\n              name: 1\n            }\n          });\n        }\n      }\n    ]\n  };\n});\n","Meteor.publish 'forms', (spaceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\n\treturn db.forms.find({space: spaceId}, {fields: {name: 1, category: 1, state: 1, description: 1, instance_style: 1}})\n\n\nMeteor.publish 'form_version', (spaceId, formId, versionId) ->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId\n\t\treturn this.ready()\n\n\tunless formId\n\t\treturn this.ready()\n\n\tunless versionId\n\t\treturn this.ready()\n\n\n\tself = this;\n\n\tgetFormVersion = (id , versionId)->\n\t\tform = db.forms.findOne({_id : id});\n\t\tif !form\n\t\t\treturn {}\n\t\tform_version = form.current\n\t\tform_version.latest = true\n\t\tif form_version._id != versionId\n\t\t\tform_version = form.historys.findPropertyByPK(\"_id\", versionId)\n\t\t\tform_version.latest = false\n\t\treturn form_version\n\n\thandle = db.forms.find({_id: formId}, {fields: {_id: 1, \"current.modified\": 1}}).observeChanges {\n\t\tchanged: (id)->\n\t\t\tself.changed(\"form_versions\", versionId, getFormVersion(id, versionId));\n\t}\n\n\tself.added(\"form_versions\", versionId, getFormVersion(formId, versionId));\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()","Meteor.publish('forms', function(spaceId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  return db.forms.find({\n    space: spaceId\n  }, {\n    fields: {\n      name: 1,\n      category: 1,\n      state: 1,\n      description: 1,\n      instance_style: 1\n    }\n  });\n});\n\nMeteor.publish('form_version', function(spaceId, formId, versionId) {\n  var getFormVersion, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  if (!formId) {\n    return this.ready();\n  }\n  if (!versionId) {\n    return this.ready();\n  }\n  self = this;\n  getFormVersion = function(id, versionId) {\n    var form, form_version;\n    form = db.forms.findOne({\n      _id: id\n    });\n    if (!form) {\n      return {};\n    }\n    form_version = form.current;\n    form_version.latest = true;\n    if (form_version._id !== versionId) {\n      form_version = form.historys.findPropertyByPK(\"_id\", versionId);\n      form_version.latest = false;\n    }\n    return form_version;\n  };\n  handle = db.forms.find({\n    _id: formId\n  }, {\n    fields: {\n      _id: 1,\n      \"current.modified\": 1\n    }\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"form_versions\", versionId, getFormVersion(id, versionId));\n    }\n  });\n  self.added(\"form_versions\", versionId, getFormVersion(formId, versionId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'instance_data', (instanceId, box)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless instanceId\n\t\treturn this.ready()\n\n\tself = this;\n\n\tminiApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description',\n\t\t'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description', 'auto_submitted']\n\n\ttriggerChangeFields = ['form_version', 'flow_version', 'related_instances', '_my_approve_read_dates']\n\n\ttriggerChangeFieldsValues = {}\n\n\tinstance_fields_0 = {\n\t\t\"record_synced\": 0,\n\n#\t\t\"traces.approves.handler_organization_fullname\": 0,\n\t\t\"traces.approves.handler_organization_name\": 0,\n\t\t\"traces.approves.handler_organization\": 0,\n\t\t\"traces.approves.cost_time\": 0,\n#\t\t\"traces.approves.read_date\": 0,\n\t\t\"traces.approves.is_error\": 0,\n\t\t# \"traces.approves.user_name\": 0,\n\t\t\"traces.approves.deadline\": 0,\n\t\t\"traces.approves.remind_date\": 0,\n\t\t\"traces.approves.reminded_count\": 0,\n\t\t\"traces.approves.modified_by\": 0,\n\t\t\"traces.approves.modified\": 0,\n\t\t\"traces.approves.geolocation\": 0,\n\t\t\"traces.approves.cc_users\": 0,\n\t\t\"traces.approves.from_approve_id\": 0,\n\t\t\"traces.approves.values_history\": 0\n\t}\n\n\tgetMyapproveModified = (traces)->\n\t\tmyApproveModifieds = new Array()\n\n\t\ttraces?.forEach (trace)->\n\t\t\ttrace?.approves?.forEach (approve)->\n\t\t\t\tif (approve.user == self.userId || approve.handler == self.userId)\n\t\t\t\t# && !approve.is_finished\n#\t\t\t\t\tconsole.log(\"approve\", approve._id, approve.read_date)\n\n\t\t\t\t\tmyApproveModifieds.push(approve.read_date)\n\n\t\treturn myApproveModifieds\n\n\n\tgetMiniInstance = (_instanceId)->\n\t\tinstance = db.instances.findOne({_id: _instanceId}, {fields: instance_fields_0})\n\n\t\tif instance\n\n\t\t\ttriggerChangeFields.forEach (key)->\n\t\t\t\tif key == '_my_approve_read_dates'\n\t\t\t\t\ttriggerChangeFieldsValues[key] = getMyapproveModified(instance.traces)\n\t\t\t\telse\n\t\t\t\t\ttriggerChangeFieldsValues[key] = instance[key]\n\n#\t\t\thasOpinionField = InstanceSignText.includesOpinionField(instance.form, instance.form_version)\n\n\t\t\tshow_modal_traces_list = db.space_settings.findOne({ space: instance.space, key: \"show_modal_traces_list\" }, { fields: { values: 1 } })?.values || false\n\n\t\t\tif show_modal_traces_list\n\n\t\t\t\ttraces = new Array();\n\n\t\t\t\tinstance?.traces?.forEach (trace)->\n\t\t\t\t\t_trace = _.clone(trace)\n\n\t\t\t\t\tapproves = new Array()\n\n\t\t\t\t\ttrace?.approves?.forEach (approve)->\n\t\t\t\t\t\tif approve.type != 'cc' || approve.user == self.userId || approve.handler == self.userId || (!_.isEmpty(approve.sign_field_code))\n\t\t\t\t\t\t\tapproves.push(approve)\n\n\t\t\t\t\t_trace.approves = approves\n\n\t\t\t\t\ttraces.push(_trace)\n\n\t\t\t\tinstance.traces = traces;\n\n\t\treturn instance\n\n\n\tneedChange = (changeFields)->\n\t\tif changeFields\n\n\t\t\t_change = false\n\n\t\t\t_rev = _.find triggerChangeFields, (key)->\n\t\t\t\t_key = key\n\n\t\t\t\tif key == '_my_approve_read_dates'\n\t\t\t\t\t_key = 'traces'\n\n\t\t\t\tif _.has(changeFields, _key)\n\n\t\t\t\t\tif key == '_my_approve_read_dates'\n\n\t\t\t\t\t\t_my_approve_modifieds = getMyapproveModified(changeFields.traces)\n\n#\t\t\t\t\t\tconsole.log(triggerChangeFieldsValues[key], _my_approve_modifieds)\n\n\t\t\t\t\t\treturn !_.isEqual(triggerChangeFieldsValues[key], _my_approve_modifieds)\n\t\t\t\t\telse\n\t\t\t\t\t\treturn !_.isEqual(triggerChangeFieldsValues[key], changeFields[key])\n\n\t\t\tif _rev\n\t\t\t\t_change = true\n\n#\t\t\tconsole.log(_rev, _change)\n\n\t\t\treturn _change\n\n\t\treturn true\n\t#此处不能添加fields限制，否则会导致数据不实时\n\thandle = db.instances.find({_id: instanceId}).observeChanges {\n\t\tchanged: (id, fields)->\n\t\t\tif(box != 'inbox' || needChange(fields))\n\t\t\t\tself.changed(\"instances\", id, getMiniInstance(id));\n\t\tremoved: (id)->\n\t\t\tself.removed(\"instances\", id);\n\t}\n\n\tinstance = getMiniInstance(instanceId)\n\n\tself.added(\"instances\", instance?._id, instance);\n\n\tself.ready();\n\n\tself.onStop ()->\n\t\thandle.stop()\n\n\nMeteor.publish 'instance_traces', (instanceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless instanceId\n\t\treturn this.ready()\n\n\tself = this\n\n\tgetInstanceTraces = (_insId)->\n\t\treturn db.instances.findOne({_id: _insId}, {fields: {_id: 1, traces: 1}})\n\n\n\thandle =  db.instances.find({_id: instanceId}).observeChanges {\n\t\tchanged: (id)->\n\t\t\tself.changed(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n\t}\n\n\tself.added(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()","Meteor.publish('instance_data', function(instanceId, box) {\n  var getMiniInstance, getMyapproveModified, handle, instance, instance_fields_0, miniApproveFields, needChange, self, triggerChangeFields, triggerChangeFieldsValues;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  self = this;\n  miniApproveFields = ['_id', 'is_finished', 'user', 'handler', 'handler_name', 'type', 'start_date', 'description', 'is_read', 'judge', 'finish_date', 'from_user_name', 'from_user', 'cc_description', 'auto_submitted'];\n  triggerChangeFields = ['form_version', 'flow_version', 'related_instances', '_my_approve_read_dates'];\n  triggerChangeFieldsValues = {};\n  instance_fields_0 = {\n    \"record_synced\": 0,\n    \"traces.approves.handler_organization_name\": 0,\n    \"traces.approves.handler_organization\": 0,\n    \"traces.approves.cost_time\": 0,\n    \"traces.approves.is_error\": 0,\n    \"traces.approves.deadline\": 0,\n    \"traces.approves.remind_date\": 0,\n    \"traces.approves.reminded_count\": 0,\n    \"traces.approves.modified_by\": 0,\n    \"traces.approves.modified\": 0,\n    \"traces.approves.geolocation\": 0,\n    \"traces.approves.cc_users\": 0,\n    \"traces.approves.from_approve_id\": 0,\n    \"traces.approves.values_history\": 0\n  };\n  getMyapproveModified = function(traces) {\n    var myApproveModifieds;\n    myApproveModifieds = new Array();\n    if (traces != null) {\n      traces.forEach(function(trace) {\n        var ref;\n        return trace != null ? (ref = trace.approves) != null ? ref.forEach(function(approve) {\n          if (approve.user === self.userId || approve.handler === self.userId) {\n            return myApproveModifieds.push(approve.read_date);\n          }\n        }) : void 0 : void 0;\n      });\n    }\n    return myApproveModifieds;\n  };\n  getMiniInstance = function(_instanceId) {\n    var instance, ref, ref1, show_modal_traces_list, traces;\n    instance = db.instances.findOne({\n      _id: _instanceId\n    }, {\n      fields: instance_fields_0\n    });\n    if (instance) {\n      triggerChangeFields.forEach(function(key) {\n        if (key === '_my_approve_read_dates') {\n          return triggerChangeFieldsValues[key] = getMyapproveModified(instance.traces);\n        } else {\n          return triggerChangeFieldsValues[key] = instance[key];\n        }\n      });\n      show_modal_traces_list = ((ref = db.space_settings.findOne({\n        space: instance.space,\n        key: \"show_modal_traces_list\"\n      }, {\n        fields: {\n          values: 1\n        }\n      })) != null ? ref.values : void 0) || false;\n      if (show_modal_traces_list) {\n        traces = new Array();\n        if (instance != null) {\n          if ((ref1 = instance.traces) != null) {\n            ref1.forEach(function(trace) {\n              var _trace, approves, ref2;\n              _trace = _.clone(trace);\n              approves = new Array();\n              if (trace != null) {\n                if ((ref2 = trace.approves) != null) {\n                  ref2.forEach(function(approve) {\n                    if (approve.type !== 'cc' || approve.user === self.userId || approve.handler === self.userId || (!_.isEmpty(approve.sign_field_code))) {\n                      return approves.push(approve);\n                    }\n                  });\n                }\n              }\n              _trace.approves = approves;\n              return traces.push(_trace);\n            });\n          }\n        }\n        instance.traces = traces;\n      }\n    }\n    return instance;\n  };\n  needChange = function(changeFields) {\n    var _change, _rev;\n    if (changeFields) {\n      _change = false;\n      _rev = _.find(triggerChangeFields, function(key) {\n        var _key, _my_approve_modifieds;\n        _key = key;\n        if (key === '_my_approve_read_dates') {\n          _key = 'traces';\n        }\n        if (_.has(changeFields, _key)) {\n          if (key === '_my_approve_read_dates') {\n            _my_approve_modifieds = getMyapproveModified(changeFields.traces);\n            return !_.isEqual(triggerChangeFieldsValues[key], _my_approve_modifieds);\n          } else {\n            return !_.isEqual(triggerChangeFieldsValues[key], changeFields[key]);\n          }\n        }\n      });\n      if (_rev) {\n        _change = true;\n      }\n      return _change;\n    }\n    return true;\n  };\n  handle = db.instances.find({\n    _id: instanceId\n  }).observeChanges({\n    changed: function(id, fields) {\n      if (box !== 'inbox' || needChange(fields)) {\n        return self.changed(\"instances\", id, getMiniInstance(id));\n      }\n    },\n    removed: function(id) {\n      return self.removed(\"instances\", id);\n    }\n  });\n  instance = getMiniInstance(instanceId);\n  self.added(\"instances\", instance != null ? instance._id : void 0, instance);\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n\nMeteor.publish('instance_traces', function(instanceId) {\n  var getInstanceTraces, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  self = this;\n  getInstanceTraces = function(_insId) {\n    return db.instances.findOne({\n      _id: _insId\n    }, {\n      fields: {\n        _id: 1,\n        traces: 1\n      }\n    });\n  };\n  handle = db.instances.find({\n    _id: instanceId\n  }).observeChanges({\n    changed: function(id) {\n      return self.changed(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n    }\n  });\n  self.added(\"instance_traces\", instanceId, getInstanceTraces(instanceId));\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","\n\tMeteor.publish 'instances_list', (spaceId, box, flowId)->\n\n\t\tunless this.userId\n\t\t\treturn this.ready()\n\t\t\n\t\tunless spaceId\n\t\t\treturn this.ready()\n\n\t\tquery = {space: spaceId}\n\t\tif box == \"inbox\"\n\t\t\tquery.inbox_users = this.userId;\n\t\telse if box == \"outbox\"\n\t\t\tquery.outbox_users = this.userId;\n\t\telse if box == \"draft\"\n\t\t\tquery.submitter = this.userId;\n\t\t\tquery.state = \"draft\"\n\t\telse if box == \"pending\"\n\t\t\tquery.submitter = this.userId;\n\t\t\tquery.state = \"pending\"\n\t\telse if box == \"completed\"\n\t\t\tquery.submitter = this.userId;\n\t\t\tquery.state = \"completed\"\n\t\telse if box == \"monitor\"\n\t\t\tquery.flow = flowId;\n\t\t\tquery.state = {$in: [\"pending\",\"completed\"]};\n\t\telse\n\t\t\tquery.state = \"none\"\n\n\t\treturn db.instances.find(query, {fields: {name:1, created:1, form:1, flow: 1, space:1, modified:1, applicant: 1, is_archived:1, form_version: 1, flow_version: 1}})\n\n","Meteor.publish('instances_list', function(spaceId, box, flowId) {\n  var query;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!spaceId) {\n    return this.ready();\n  }\n  query = {\n    space: spaceId\n  };\n  if (box === \"inbox\") {\n    query.inbox_users = this.userId;\n  } else if (box === \"outbox\") {\n    query.outbox_users = this.userId;\n  } else if (box === \"draft\") {\n    query.submitter = this.userId;\n    query.state = \"draft\";\n  } else if (box === \"pending\") {\n    query.submitter = this.userId;\n    query.state = \"pending\";\n  } else if (box === \"completed\") {\n    query.submitter = this.userId;\n    query.state = \"completed\";\n  } else if (box === \"monitor\") {\n    query.flow = flowId;\n    query.state = {\n      $in: [\"pending\", \"completed\"]\n    };\n  } else {\n    query.state = \"none\";\n  }\n  return db.instances.find(query, {\n    fields: {\n      name: 1,\n      created: 1,\n      form: 1,\n      flow: 1,\n      space: 1,\n      modified: 1,\n      applicant: 1,\n      is_archived: 1,\n      form_version: 1,\n      flow_version: 1\n    }\n  });\n});\n","lastFinishedApproveAggregate = (instanceid, userId, dataMap, callback)->\n\toperation = [{\n\t\t\"$match\": {\n\t\t\t\"_id\": instanceid\n\t\t}\n\t}, {\"$project\": {\"name\": 1, \"_approve\": \"$traces.approves\"}}, {\"$unwind\": \"$_approve\"}, {\"$unwind\": \"$_approve\"},\n\t\t{\"$match\": {\"_approve.is_finished\": true, $or:[{\"_approve.handler\": userId},{\"_approve.user\": userId}]}},\n\t\t{\"$group\": {\"_id\": \"$_id\", \"finish_date\": {\"$last\": \"$_approve.finish_date\"}}}\n\t]\n\n\tdb.instances.rawCollection().aggregate(operation).toArray (err, data)->\n\t\tif err\n\t\t\tthrow new Error(err)\n\n\t\tdata.forEach (doc) ->\n\t\t\tdataMap.push doc\n\n\t\tif callback && _.isFunction(callback)\n\t\t\tcallback()\n\t\treturn\n\nasyncLastFinishedApprove = Meteor.wrapAsync(lastFinishedApproveAggregate)\n\nMeteor.publish \"instance_tabular\", (tableName, ids, fields)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tcheck(tableName, String);\n\n\tcheck(ids, Array);\n\n\tcheck(fields, Match.Optional(Object))\n\n\tfields.cc_users = 1\n\n\tself = this;\n\n\tgetMyLastFinishedApprove = (userId, instanceId)->\n\t\tdata = []\n\t\tasyncLastFinishedApprove(instanceId, userId, data)\n\t\tif data.length > 0\n\t\t\treturn data[0]\n\n\n\tgetMyApprove = (userId, instanceId)->\n\t\tinstance = db.instances.findOne({_id: instanceId}, {fields: {traces: 1}})\n\t\tmyApprove = null\n\n\t\tif !instance\n\t\t\treturn\n\n\t\tif !instance.traces || instance.traces.length < 1\n\t\t\treturn\n\n\t\tnotFinishedTraces = instance.traces.filterProperty(\"is_finished\", false)\n\n\t\tif notFinishedTraces.length > 0\n\t\t\tapproves = notFinishedTraces[0].approves.filterProperty(\"is_finished\", false).filterProperty(\"handler\", userId);\n\n\t\t\tif approves.length > 0\n\t\t\t\tapprove = approves[0]\n\t\t\t\tmyApprove = {\n\t\t\t\t\tid: approve._id,\n\t\t\t\t\tinstance: approve.instance,\n\t\t\t\t\ttrace: approve.trace,\n\t\t\t\t\tis_read: approve.is_read,\n\t\t\t\t\tstart_date: approve.start_date\n\t\t\t\t\tagent: approve.agent\n\t\t\t\t\tuser_name: approve.user_name\n\t\t\t\t}\n\n\t\tif !myApprove\n\t\t\tis_read = false\n\t\t\tinstance.traces.forEach (trace) ->\n\t\t\t\ttrace?.approves?.forEach (approve) ->\n\t\t\t\t\tif approve.type == 'cc' and approve.user == userId and approve.is_finished == false\n\t\t\t\t\t\tif approve.is_read\n\t\t\t\t\t\t\tis_read = true\n\t\t\t\t\t\tmyApprove = {id: approve._id, is_read: is_read, start_date: approve.start_date, agent: approve.agent, user_name: approve.user_name}\n\n\t\treturn myApprove\n\n\tgetStepCurrentName = (instanceId) ->\n\t\tinstance = db.instances.findOne({_id: instanceId}, {fields: {\"traces.name\": 1, \"traces\": {$slice: -1}}})\n\t\tif instance\n\t\t\tstepCurrentName = instance.traces?[0]?.name\n\n\t\treturn stepCurrentName\n\n\thandle = db.instances.find({_id: {$in: ids}}, {fields: {traces: 0}}).observeChanges {\n\t\tchanged: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tmyApprove = getMyApprove(self.userId, id)\n\t\t\tmyLastFinishedApprove = getMyLastFinishedApprove(self.userId, id)\n\t\t\tif myApprove\n\t\t\t\tinstance.is_read = myApprove.is_read\n\t\t\t\tinstance.start_date = myApprove.start_date\n\t\t\t\tif myApprove.agent\n\t\t\t\t\tinstance.agent_user_name = myApprove.user_name\n\t\t\telse\n\t\t\t\tinstance.is_read = true\n\n\t\t\tif myLastFinishedApprove\n\t\t\t\tinstance.my_finish_date = myLastFinishedApprove.finish_date\n\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tinstance.cc_count = instance.cc_users?.length || 0\n\t\t\tdelete instance.cc_users\n\t\t\tself.changed(\"instances\", id, instance);\n\t\tremoved: (id)->\n\t\t\tself.removed(\"instances\", id);\n\t}\n\n\tids.forEach (id)->\n\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\treturn if not instance\n\t\tmyApprove = getMyApprove(self.userId, id)\n\t\tmyLastFinishedApprove = getMyLastFinishedApprove(self.userId, id)\n\t\tif myApprove\n\t\t\tinstance.is_read = myApprove.is_read\n\t\t\tinstance.start_date = myApprove.start_date\n\t\t\tif myApprove.agent\n\t\t\t\t\tinstance.agent_user_name = myApprove.user_name\n\t\telse\n\t\t\tinstance.is_read = true\n\n\t\tif myLastFinishedApprove\n\t\t\tinstance.my_finish_date = myLastFinishedApprove.finish_date\n\n\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\tinstance.cc_count = instance.cc_users?.length || 0\n\t\tdelete instance.cc_users\n\t\tself.added(\"instances\", id, instance);\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()","var asyncLastFinishedApprove, lastFinishedApproveAggregate;\n\nlastFinishedApproveAggregate = function(instanceid, userId, dataMap, callback) {\n  var operation;\n  operation = [\n    {\n      \"$match\": {\n        \"_id\": instanceid\n      }\n    }, {\n      \"$project\": {\n        \"name\": 1,\n        \"_approve\": \"$traces.approves\"\n      }\n    }, {\n      \"$unwind\": \"$_approve\"\n    }, {\n      \"$unwind\": \"$_approve\"\n    }, {\n      \"$match\": {\n        \"_approve.is_finished\": true,\n        $or: [\n          {\n            \"_approve.handler\": userId\n          }, {\n            \"_approve.user\": userId\n          }\n        ]\n      }\n    }, {\n      \"$group\": {\n        \"_id\": \"$_id\",\n        \"finish_date\": {\n          \"$last\": \"$_approve.finish_date\"\n        }\n      }\n    }\n  ];\n  return db.instances.rawCollection().aggregate(operation).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return dataMap.push(doc);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\nasyncLastFinishedApprove = Meteor.wrapAsync(lastFinishedApproveAggregate);\n\nMeteor.publish(\"instance_tabular\", function(tableName, ids, fields) {\n  var getMyApprove, getMyLastFinishedApprove, getStepCurrentName, handle, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  check(tableName, String);\n  check(ids, Array);\n  check(fields, Match.Optional(Object));\n  fields.cc_users = 1;\n  self = this;\n  getMyLastFinishedApprove = function(userId, instanceId) {\n    var data;\n    data = [];\n    asyncLastFinishedApprove(instanceId, userId, data);\n    if (data.length > 0) {\n      return data[0];\n    }\n  };\n  getMyApprove = function(userId, instanceId) {\n    var approve, approves, instance, is_read, myApprove, notFinishedTraces;\n    instance = db.instances.findOne({\n      _id: instanceId\n    }, {\n      fields: {\n        traces: 1\n      }\n    });\n    myApprove = null;\n    if (!instance) {\n      return;\n    }\n    if (!instance.traces || instance.traces.length < 1) {\n      return;\n    }\n    notFinishedTraces = instance.traces.filterProperty(\"is_finished\", false);\n    if (notFinishedTraces.length > 0) {\n      approves = notFinishedTraces[0].approves.filterProperty(\"is_finished\", false).filterProperty(\"handler\", userId);\n      if (approves.length > 0) {\n        approve = approves[0];\n        myApprove = {\n          id: approve._id,\n          instance: approve.instance,\n          trace: approve.trace,\n          is_read: approve.is_read,\n          start_date: approve.start_date,\n          agent: approve.agent,\n          user_name: approve.user_name\n        };\n      }\n    }\n    if (!myApprove) {\n      is_read = false;\n      instance.traces.forEach(function(trace) {\n        var ref;\n        return trace != null ? (ref = trace.approves) != null ? ref.forEach(function(approve) {\n          if (approve.type === 'cc' && approve.user === userId && approve.is_finished === false) {\n            if (approve.is_read) {\n              is_read = true;\n            }\n            return myApprove = {\n              id: approve._id,\n              is_read: is_read,\n              start_date: approve.start_date,\n              agent: approve.agent,\n              user_name: approve.user_name\n            };\n          }\n        }) : void 0 : void 0;\n      });\n    }\n    return myApprove;\n  };\n  getStepCurrentName = function(instanceId) {\n    var instance, ref, ref1, stepCurrentName;\n    instance = db.instances.findOne({\n      _id: instanceId\n    }, {\n      fields: {\n        \"traces.name\": 1,\n        \"traces\": {\n          $slice: -1\n        }\n      }\n    });\n    if (instance) {\n      stepCurrentName = (ref = instance.traces) != null ? (ref1 = ref[0]) != null ? ref1.name : void 0 : void 0;\n    }\n    return stepCurrentName;\n  };\n  handle = db.instances.find({\n    _id: {\n      $in: ids\n    }\n  }, {\n    fields: {\n      traces: 0\n    }\n  }).observeChanges({\n    changed: function(id) {\n      var instance, myApprove, myLastFinishedApprove, ref, ref1;\n      instance = db.instances.findOne({\n        _id: id\n      }, {\n        fields: fields\n      });\n      if (!instance) {\n        return;\n      }\n      myApprove = getMyApprove(self.userId, id);\n      myLastFinishedApprove = getMyLastFinishedApprove(self.userId, id);\n      if (myApprove) {\n        instance.is_read = myApprove.is_read;\n        instance.start_date = myApprove.start_date;\n        if (myApprove.agent) {\n          instance.agent_user_name = myApprove.user_name;\n        }\n      } else {\n        instance.is_read = true;\n      }\n      if (myLastFinishedApprove) {\n        instance.my_finish_date = myLastFinishedApprove.finish_date;\n      }\n      instance.is_cc = ((ref = instance.cc_users) != null ? ref.includes(self.userId) : void 0) || false;\n      instance.cc_count = ((ref1 = instance.cc_users) != null ? ref1.length : void 0) || 0;\n      delete instance.cc_users;\n      return self.changed(\"instances\", id, instance);\n    },\n    removed: function(id) {\n      return self.removed(\"instances\", id);\n    }\n  });\n  ids.forEach(function(id) {\n    var instance, myApprove, myLastFinishedApprove, ref, ref1;\n    instance = db.instances.findOne({\n      _id: id\n    }, {\n      fields: fields\n    });\n    if (!instance) {\n      return;\n    }\n    myApprove = getMyApprove(self.userId, id);\n    myLastFinishedApprove = getMyLastFinishedApprove(self.userId, id);\n    if (myApprove) {\n      instance.is_read = myApprove.is_read;\n      instance.start_date = myApprove.start_date;\n      if (myApprove.agent) {\n        instance.agent_user_name = myApprove.user_name;\n      }\n    } else {\n      instance.is_read = true;\n    }\n    if (myLastFinishedApprove) {\n      instance.my_finish_date = myLastFinishedApprove.finish_date;\n    }\n    instance.is_cc = ((ref = instance.cc_users) != null ? ref.includes(self.userId) : void 0) || false;\n    instance.cc_count = ((ref1 = instance.cc_users) != null ? ref1.length : void 0) || 0;\n    delete instance.cc_users;\n    return self.added(\"instances\", id, instance);\n  });\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'instances_draft', (spaceId) ->\n\tcheck spaceId, String\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tuserId = this.userId\n\treturn db.instances.find({state:\"draft\",space:spaceId,submitter:userId,$or:[{inbox_users: {$exists:false}}, {inbox_users: []}]}, {fields: {_id: 1, state: 1, space: 1, submitter: 1, inbox_users: 1, modified: 1, name: 1}, sort:{modified: -1}})","Meteor.publish('instances_draft', function(spaceId) {\n  var userId;\n  check(spaceId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  userId = this.userId;\n  return db.instances.find({\n    state: \"draft\",\n    space: spaceId,\n    submitter: userId,\n    $or: [\n      {\n        inbox_users: {\n          $exists: false\n        }\n      }, {\n        inbox_users: []\n      }\n    ]\n  }, {\n    fields: {\n      _id: 1,\n      state: 1,\n      space: 1,\n      submitter: 1,\n      inbox_users: 1,\n      modified: 1,\n      name: 1\n    },\n    sort: {\n      modified: -1\n    }\n  });\n});\n","Meteor.publish 'distributed_instances_state_by_ids', (instance_ids)->\n\tcheck(instance_ids, Array)\n\n\tunless this.userId\n\t\treturn this.ready()\n\t\n\tunless instance_ids\n\t\treturn this.ready()\n\n\tif _.isEmpty(instance_ids)\n\t\treturn this.ready()\n\n\tself = this\n\n\thandle = db.instances.find({_id: {$in: instance_ids}}, {fields: {state: 1, traces:{$slice: 1} } }).observeChanges {\n\t\tadded: (id, fields)->\n\t\t\tself.added('instances', id, {state: fields.state, is_read: fields.traces[0].approves[0].is_read})\n\n\t\tchanged: (id, fields)->\n\t\t\tif fields.state\n\t\t\t\tself.changed('instances', id, {state: fields.state})\n\t\t\tif fields.traces\n\t\t\t\tself.changed('instances', id, {is_read: fields.traces[0].approves[0].is_read})\n\t}\n\n\tthis.ready()\n\tthis.onStop ()->\n\t\thandle.stop()\n","Meteor.publish('distributed_instances_state_by_ids', function(instance_ids) {\n  var handle, self;\n  check(instance_ids, Array);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instance_ids) {\n    return this.ready();\n  }\n  if (_.isEmpty(instance_ids)) {\n    return this.ready();\n  }\n  self = this;\n  handle = db.instances.find({\n    _id: {\n      $in: instance_ids\n    }\n  }, {\n    fields: {\n      state: 1,\n      traces: {\n        $slice: 1\n      }\n    }\n  }).observeChanges({\n    added: function(id, fields) {\n      return self.added('instances', id, {\n        state: fields.state,\n        is_read: fields.traces[0].approves[0].is_read\n      });\n    },\n    changed: function(id, fields) {\n      if (fields.state) {\n        self.changed('instances', id, {\n          state: fields.state\n        });\n      }\n      if (fields.traces) {\n        return self.changed('instances', id, {\n          is_read: fields.traces[0].approves[0].is_read\n        });\n      }\n    }\n  });\n  this.ready();\n  return this.onStop(function() {\n    return handle.stop();\n  });\n});\n","Meteor.publish 'related_instaces', (instanceId, related_instances)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless instanceId\n\t\treturn this.ready()\n\n\trelated_instance_ids = db.instances.findOne(instanceId,{fields: {related_instances: 1}})?.related_instances\n\n\tif related_instance_ids && _.isArray(related_instance_ids)\n\t\treturn db.instances.find({_id: {$in : related_instance_ids}}, {fields: {_id: 1, name: 1, space: 1}})\n\telse\n\t\treturn this.ready()","Meteor.publish('related_instaces', function(instanceId, related_instances) {\n  var ref, related_instance_ids;\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!instanceId) {\n    return this.ready();\n  }\n  related_instance_ids = (ref = db.instances.findOne(instanceId, {\n    fields: {\n      related_instances: 1\n    }\n  })) != null ? ref.related_instances : void 0;\n  if (related_instance_ids && _.isArray(related_instance_ids)) {\n    return db.instances.find({\n      _id: {\n        $in: related_instance_ids\n      }\n    }, {\n      fields: {\n        _id: 1,\n        name: 1,\n        space: 1\n      }\n    });\n  } else {\n    return this.ready();\n  }\n});\n","if Meteor.isServer\n    Meteor.publish 'space_user_signs', (spaceId) ->\n        check spaceId, String\n\n        unless this.userId\n            return this.ready()\n\n        return db.space_user_signs.find({ space: spaceId }, {fields: {created_by: 0, created: 0, modified_by: 0}})\n","if (Meteor.isServer) {\n  Meteor.publish('space_user_signs', function(spaceId) {\n    check(spaceId, String);\n    if (!this.userId) {\n      return this.ready();\n    }\n    return db.space_user_signs.find({\n      space: spaceId\n    }, {\n      fields: {\n        created_by: 0,\n        created: 0,\n        modified_by: 0\n      }\n    });\n  });\n}\n","###\nMeteor.publishComposite \"user_inbox_instance\", ()->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tuserSpaceIds = db.space_users.find({\n\t\tuser: this.userId,\n\t\tuser_accepted: true\n\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\tquery = {space: {$in: userSpaceIds}}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfind: ->\n\t\tdb.instances.find(query, {\n\t\t\tfields: {\n\t\t\t\tspace: 1,\n\t\t\t\tapplicant_name: 1,\n\t\t\t\tflow: 1,\n\t\t\t\tinbox_users: 1,\n\t\t\t\tcc_users: 1,\n\t\t\t\tstate: 1,\n\t\t\t\tname: 1,\n\t\t\t\tmodified: 1,\n\t\t\t\tform: 1\n\t\t\t}, sort: {modified: -1}, skip: 0, limit: 200\n\t\t});\n\tchildren: [\n\t\t{\n\t\t\tfind: (instance, post)->\n\t\t\t\tdb.flows.find({_id: instance.flow}, {fields: {name: 1, space: 1}});\n\t\t}\n\t]\n###\n\n###\nMeteor.publish 'my_inbox_instances', (spaceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tself = this;\n\n\t#\tuserSpaceIds = db.space_users.find({\n\t#\t\tuser: this.userId,\n\t#\t\tuser_accepted: true\n\t#\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\n\tquery = {space: spaceId}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfields = {\n\t\tspace: 1,\n#\t\tapplicant_name: 1,\n\t\tflow: 1,\n\t\tinbox_users: 1,\n\t\tcc_users: 1,\n\t\tstate: 1,\n#\t\tname: 1,\n#\t\tmodified: 1,\n\t\tform: 1\n\t}\n\n\thandle = db.instances.find(query, {sort: {modified: -1}, skip: 0, limit: 500}).observeChanges {\n\t\tadded: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.added(\"instances\", id, instance)\n\t\tchanged: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.changed(\"instances\", id, instance);\n\t\tremoved: (id)->\n\t\t\tself.removed(\"instances\", id);\n\t}\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()\n###\n\n_get_flow_instances_aggregate = (spaceId, userId, _items, callback)->\n\tdb.instances.rawCollection().aggregate([\n\t\t{\n\t\t\t$match: {\n\t\t\t\tspace: spaceId,\n\t\t\t\t$or: [{inbox_users: userId}, {cc_users: userId}]\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t$group: {\n\t\t\t\t_id: {flow: \"$flow\", category: \"$category\"}, count: {$sum: 1}\n\t\t\t}\n\t\t}\n\t]).toArray (err, data)->\n\t\tif err\n\t\t\tthrow new Error(err)\n\n\t\tdata.forEach (doc) ->\n\t\t\t_items.push doc\n\n\t\tif callback && _.isFunction(callback)\n\t\t\tcallback()\n\t\treturn\n\n_async_get_flow_instances_aggregate = Meteor.wrapAsync(_get_flow_instances_aggregate)\n\nMeteor.publish 'my_inbox_flow_instances_count', (spaceId)->\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tself = this;\n\n\tquery = {space: spaceId}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tdata = []  #数据格式：[{_id:flowId, count: 待办数量}, {_id:flowId2, count: 待办数量2}]\n\t_async_get_flow_instances_aggregate(spaceId, self.userId, data)\n\n\t_flowsData = []\n\n\t_.each data, (dataItem)->\n\t\t_flowsData.push({_id: dataItem._id.flow, category: dataItem._id.category, count: dataItem.count})\n\n\tself.added(\"flow_instances\", spaceId, {flows: _flowsData});\n\n\t_changeData = (doc, action)->\n\t\tflow_instance = _.find _flowsData, (f)->\n\t\t\treturn f._id == doc.flow\n\t\tif flow_instance\n\t\t\tif action == \"added\"\n\t\t\t\tflow_instance.count++\n\t\t\telse if action == \"removed\"\n\t\t\t\tflow_instance.count--\n\t\telse if action == \"added\"\n\t\t\t_flowsData.push {_id: doc.flow, category: doc.category, count: 1}\n\n\t\tself.changed(\"flow_instances\", spaceId, {flows: _flowsData});\n\n\t_init = true\n\thandle = db.instances.find(query, {fields: {_id: 1, inbox_users: 1, cc_users: 1, flow: 1, category: 1}}).observe {\n\t\tadded: (doc)->\n\t\t\tif !_init\n\t\t\t\t_changeData(doc, \"added\")\n\t\tremoved: (doc)->\n\t\t\tif !_init\n\t\t\t\t_changeData(doc, \"removed\")\n\t}\n\t_init = false\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()","\n/*\nMeteor.publishComposite \"user_inbox_instance\", ()->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tuserSpaceIds = db.space_users.find({\n\t\tuser: this.userId,\n\t\tuser_accepted: true\n\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\tquery = {space: {$in: userSpaceIds}}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfind: ->\n\t\tdb.instances.find(query, {\n\t\t\tfields: {\n\t\t\t\tspace: 1,\n\t\t\t\tapplicant_name: 1,\n\t\t\t\tflow: 1,\n\t\t\t\tinbox_users: 1,\n\t\t\t\tcc_users: 1,\n\t\t\t\tstate: 1,\n\t\t\t\tname: 1,\n\t\t\t\tmodified: 1,\n\t\t\t\tform: 1\n\t\t\t}, sort: {modified: -1}, skip: 0, limit: 200\n\t\t});\n\tchildren: [\n\t\t{\n\t\t\tfind: (instance, post)->\n\t\t\t\tdb.flows.find({_id: instance.flow}, {fields: {name: 1, space: 1}});\n\t\t}\n\t]\n */\n\n/*\nMeteor.publish 'my_inbox_instances', (spaceId)->\n\tunless this.userId\n\t\treturn this.ready()\n\n\tself = this;\n\n\t *\tuserSpaceIds = db.space_users.find({\n\t *\t\tuser: this.userId,\n\t *\t\tuser_accepted: true\n\t *\t}, {fields: {space: 1}}).fetch().getEach(\"space\");\n\n\tquery = {space: spaceId}\n\n\tquery.$or = [{inbox_users: this.userId}, {cc_users: this.userId}]\n\n\tfields = {\n\t\tspace: 1,\n *\t\tapplicant_name: 1,\n\t\tflow: 1,\n\t\tinbox_users: 1,\n\t\tcc_users: 1,\n\t\tstate: 1,\n *\t\tname: 1,\n *\t\tmodified: 1,\n\t\tform: 1\n\t}\n\n\thandle = db.instances.find(query, {sort: {modified: -1}, skip: 0, limit: 500}).observeChanges {\n\t\tadded: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.added(\"instances\", id, instance)\n\t\tchanged: (id)->\n\t\t\tinstance = db.instances.findOne({_id: id}, {fields: fields})\n\t\t\treturn if not instance\n\t\t\tinstance.is_cc = instance.cc_users?.includes(self.userId) || false\n\t\t\tdelete instance.cc_users\n\t\t\tself.changed(\"instances\", id, instance);\n\t\tremoved: (id)->\n\t\t\tself.removed(\"instances\", id);\n\t}\n\n\tself.ready();\n\tself.onStop ()->\n\t\thandle.stop()\n */\nvar _async_get_flow_instances_aggregate, _get_flow_instances_aggregate;\n\n_get_flow_instances_aggregate = function(spaceId, userId, _items, callback) {\n  return db.instances.rawCollection().aggregate([\n    {\n      $match: {\n        space: spaceId,\n        $or: [\n          {\n            inbox_users: userId\n          }, {\n            cc_users: userId\n          }\n        ]\n      }\n    }, {\n      $group: {\n        _id: {\n          flow: \"$flow\",\n          category: \"$category\"\n        },\n        count: {\n          $sum: 1\n        }\n      }\n    }\n  ]).toArray(function(err, data) {\n    if (err) {\n      throw new Error(err);\n    }\n    data.forEach(function(doc) {\n      return _items.push(doc);\n    });\n    if (callback && _.isFunction(callback)) {\n      callback();\n    }\n  });\n};\n\n_async_get_flow_instances_aggregate = Meteor.wrapAsync(_get_flow_instances_aggregate);\n\nMeteor.publish('my_inbox_flow_instances_count', function(spaceId) {\n  var _changeData, _flowsData, _init, data, handle, query, self;\n  if (!this.userId) {\n    return this.ready();\n  }\n  self = this;\n  query = {\n    space: spaceId\n  };\n  query.$or = [\n    {\n      inbox_users: this.userId\n    }, {\n      cc_users: this.userId\n    }\n  ];\n  data = [];\n  _async_get_flow_instances_aggregate(spaceId, self.userId, data);\n  _flowsData = [];\n  _.each(data, function(dataItem) {\n    return _flowsData.push({\n      _id: dataItem._id.flow,\n      category: dataItem._id.category,\n      count: dataItem.count\n    });\n  });\n  self.added(\"flow_instances\", spaceId, {\n    flows: _flowsData\n  });\n  _changeData = function(doc, action) {\n    var flow_instance;\n    flow_instance = _.find(_flowsData, function(f) {\n      return f._id === doc.flow;\n    });\n    if (flow_instance) {\n      if (action === \"added\") {\n        flow_instance.count++;\n      } else if (action === \"removed\") {\n        flow_instance.count--;\n      }\n    } else if (action === \"added\") {\n      _flowsData.push({\n        _id: doc.flow,\n        category: doc.category,\n        count: 1\n      });\n    }\n    return self.changed(\"flow_instances\", spaceId, {\n      flows: _flowsData\n    });\n  };\n  _init = true;\n  handle = db.instances.find(query, {\n    fields: {\n      _id: 1,\n      inbox_users: 1,\n      cc_users: 1,\n      flow: 1,\n      category: 1\n    }\n  }).observe({\n    added: function(doc) {\n      if (!_init) {\n        return _changeData(doc, \"added\");\n      }\n    },\n    removed: function(doc) {\n      if (!_init) {\n        return _changeData(doc, \"removed\");\n      }\n    }\n  });\n  _init = false;\n  self.ready();\n  return self.onStop(function() {\n    return handle.stop();\n  });\n});\n","\nMeteor.publish 'flow_main_attach_template', (spaceId, flowId)->\n\tcheck(spaceId, String)\n\tcheck(flowId, String)\n\n\tunless this.userId\n\t\treturn this.ready()\n\n\tunless spaceId && flowId\n\t\treturn this.ready()\n\n\treturn Creator.getCollection('cms_files').find({ space: spaceId, 'parent.o': 'flows', 'parent.ids': flowId,  name: '正文.docx' })\n","Meteor.publish('flow_main_attach_template', function(spaceId, flowId) {\n  check(spaceId, String);\n  check(flowId, String);\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!(spaceId && flowId)) {\n    return this.ready();\n  }\n  return Creator.getCollection('cms_files').find({\n    space: spaceId,\n    'parent.o': 'flows',\n    'parent.ids': flowId,\n    name: '正文.docx'\n  });\n});\n","workflowTemplate = {}\n\n#可用此脚本从模板工作区做批量导出：\n#使用管理员账户登录后，进入FlowModules，在控制台执行以下脚本即可\n#db.forms.find({state:\"enabled\"}).forEach(function(form){window.open(Meteor.absoluteUrl(\"api/workflow/export/form?form=\"+form._id))})\nworkflowTemplate[\"en\"] =[]\n\n#可用此脚本从模板工作区做批量导出：\n#使用管理员账户登录后，进入模板专区，在控制台执行以下脚本即可\n#db.forms.find({state:\"enabled\"}).forEach(function(form){window.open(Meteor.absoluteUrl(\"api/workflow/export/form?form=\"+form._id))})\nworkflowTemplate[\"zh-CN\"] =[]\n\nMeteor.startup ()->\n\tfs = require('fs')\n\tpath = require('path')\n\tmime = require('mime')\n\treadFileList = (pathDir, filesList)->\n\t\tfiles = fs.readdirSync(pathDir)\n\t\tfiles.forEach (name, index)->\n\t\t\tstat = fs.statSync(path.join(pathDir, name))\n\t\t\tif stat.isDirectory()\n\t\t\t\t# 递归读取文件\n\t\t\t\treadFileList(path.join(pathDir, name), filesList)\n\t\t\telse\n\t\t\t\tobj = {}\n\t\t\t\tobj.path = pathDir\n\t\t\t\tobj.name = name\n\t\t\t\tfilesList.push(obj)\n\n\t#获取zh-cn文件夹下的所有文件\n\tfilesList_cn = []\n\tpath_cn = Meteor.settings.workflowTemplates?.path_cn\n\tif path_cn\n\t\tabsolute_path_cn = path.resolve(path_cn)\n\t\tconsole.log \"absolute_path_cn\", absolute_path_cn\n\t\tif fs.existsSync(absolute_path_cn)\n\t\t\treadFileList(absolute_path_cn, filesList_cn)\n\t\t\tfilesList_cn.forEach (file)->\n\t\t\t\ttry\n\t\t\t\t\tif mime.getType(file.name) is \"application/json\"\n\t\t\t\t\t\tdata = fs.readFileSync(path.join(file.path, file.name), 'utf8')\n\t\t\t\t\t\tworkflowTemplate[\"zh-CN\"].push(JSON.parse(data))\n\t\t\t\tcatch e\n\t\t\t\t\tconsole.error \"获取zh-cn文件夹下的所有文件\", path.join(file.path, file.name)\n\t\t\t\t\tconsole.error e.stack\n\n\t#获取en-us文件夹下的所有文件\n\tfilesList_us = []\n\tpath_us = Meteor.settings.workflowTemplates?.path_us\n\tif path_us\n\t\tabsolute_path_us = path.resolve(path_us)\n\t\tconsole.log \"absolute_path_us\", absolute_path_us\n\t\tif fs.existsSync(absolute_path_us)\n\t\t\treadFileList(absolute_path_us, filesList_us)\n\t\t\tfilesList_us.forEach (file)->\n\t\t\t\ttry\n\t\t\t\t\tif mime.getType(file.name) is \"application/json\"\n\t\t\t\t\t\tdata = fs.readFileSync(path.join(file.path, file.name), 'utf8')\n\t\t\t\t\t\tworkflowTemplate[\"en\"].push(JSON.parse(data))\n\t\t\t\tcatch e\n\t\t\t\t\tconsole.error \"获取en-us文件夹下的所有文件\", path.join(file.path, file.name)\n\t\t\t\t\tconsole.error e.stack\n\t\t\t\t\n\t\t\t\t\t\n\n\n","                     \n\nworkflowTemplate = {};\n\nworkflowTemplate[\"en\"] = [];\n\nworkflowTemplate[\"zh-CN\"] = [];\n\nMeteor.startup(function() {\n  var absolute_path_cn, absolute_path_us, filesList_cn, filesList_us, fs, mime, path, path_cn, path_us, readFileList, ref, ref1;\n  fs = require('fs');\n  path = require('path');\n  mime = require('mime');\n  readFileList = function(pathDir, filesList) {\n    var files;\n    files = fs.readdirSync(pathDir);\n    return files.forEach(function(name, index) {\n      var obj, stat;\n      stat = fs.statSync(path.join(pathDir, name));\n      if (stat.isDirectory()) {\n        return readFileList(path.join(pathDir, name), filesList);\n      } else {\n        obj = {};\n        obj.path = pathDir;\n        obj.name = name;\n        return filesList.push(obj);\n      }\n    });\n  };\n  filesList_cn = [];\n  path_cn = (ref = Meteor.settings.workflowTemplates) != null ? ref.path_cn : void 0;\n  if (path_cn) {\n    absolute_path_cn = path.resolve(path_cn);\n    console.log(\"absolute_path_cn\", absolute_path_cn);\n    if (fs.existsSync(absolute_path_cn)) {\n      readFileList(absolute_path_cn, filesList_cn);\n      filesList_cn.forEach(function(file) {\n        var data, e;\n        try {\n          if (mime.getType(file.name) === \"application/json\") {\n            data = fs.readFileSync(path.join(file.path, file.name), 'utf8');\n            return workflowTemplate[\"zh-CN\"].push(JSON.parse(data));\n          }\n        } catch (error) {\n          e = error;\n          console.error(\"获取zh-cn文件夹下的所有文件\", path.join(file.path, file.name));\n          return console.error(e.stack);\n        }\n      });\n    }\n  }\n  filesList_us = [];\n  path_us = (ref1 = Meteor.settings.workflowTemplates) != null ? ref1.path_us : void 0;\n  if (path_us) {\n    absolute_path_us = path.resolve(path_us);\n    console.log(\"absolute_path_us\", absolute_path_us);\n    if (fs.existsSync(absolute_path_us)) {\n      readFileList(absolute_path_us, filesList_us);\n      return filesList_us.forEach(function(file) {\n        var data, e;\n        try {\n          if (mime.getType(file.name) === \"application/json\") {\n            data = fs.readFileSync(path.join(file.path, file.name), 'utf8');\n            return workflowTemplate[\"en\"].push(JSON.parse(data));\n          }\n        } catch (error) {\n          e = error;\n          console.error(\"获取en-us文件夹下的所有文件\", path.join(file.path, file.name));\n          return console.error(e.stack);\n        }\n      });\n    }\n  }\n});\n","###\n*    *    *    *    *    *\n┬    ┬    ┬    ┬    ┬    ┬\n│    │    │    │    │    |\n│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)\n│    │    │    │    └───── month (1 - 12)\n│    │    │    └────────── day of month (1 - 31)\n│    │    └─────────────── hour (0 - 23)\n│    └──────────────────── minute (0 - 59)\n└───────────────────────── second (0 - 59, OPTIONAL)\n###\nMeteor.startup ->\n\tif Meteor.settings.cron?.auto_finish_process_delegation\n\t\tschedule = require('node-schedule')\n\t\t# 定时执行同步\n\t\trule = Meteor.settings.cron.auto_finish_process_delegation\n\t\tgo_next = true\n\t\tschedule.scheduleJob rule, Meteor.bindEnvironment ()->\n\t\t\ttry\n\t\t\t\tif !go_next\n\t\t\t\t\treturn\n\t\t\t\tgo_next = false\n\t\t\t\tconsole.time 'auto_finish_process_delegation'\n\n\t\t\t\tnow = new Date\n\n\t\t\t\t# 将委托规则设置为不可用\n\t\t\t\tdb.process_delegation_rules.update({ enabled: true, end_time: { $lte: now } }, { $set: { enabled: false } }, { multi :true })\n\n\t\t\t\tconsole.timeEnd 'auto_finish_process_delegation'\n\t\t\t\tgo_next = true\n\n\t\t\tcatch e\n\t\t\t\tconsole.error \"AUTO AUTO_FINISH_PROCESS_DELEGATION ERROR: \"\n\t\t\t\tconsole.error e.stack\n\t\t\t\tgo_next = true\n\n\t\t, ()->\n\t\t\tconsole.log 'Failed to bind environment'\n","\n/*\n*    *    *    *    *    *\n┬    ┬    ┬    ┬    ┬    ┬\n│    │    │    │    │    |\n│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)\n│    │    │    │    └───── month (1 - 12)\n│    │    │    └────────── day of month (1 - 31)\n│    │    └─────────────── hour (0 - 23)\n│    └──────────────────── minute (0 - 59)\n└───────────────────────── second (0 - 59, OPTIONAL)\n */\nMeteor.startup(function() {\n  var go_next, ref, rule, schedule;\n  if ((ref = Meteor.settings.cron) != null ? ref.auto_finish_process_delegation : void 0) {\n    schedule = require('node-schedule');\n    rule = Meteor.settings.cron.auto_finish_process_delegation;\n    go_next = true;\n    return schedule.scheduleJob(rule, Meteor.bindEnvironment(function() {\n      var e, now;\n      try {\n        if (!go_next) {\n          return;\n        }\n        go_next = false;\n        console.time('auto_finish_process_delegation');\n        now = new Date;\n        db.process_delegation_rules.update({\n          enabled: true,\n          end_time: {\n            $lte: now\n          }\n        }, {\n          $set: {\n            enabled: false\n          }\n        }, {\n          multi: true\n        });\n        console.timeEnd('auto_finish_process_delegation');\n        return go_next = true;\n      } catch (error) {\n        e = error;\n        console.error(\"AUTO AUTO_FINISH_PROCESS_DELEGATION ERROR: \");\n        console.error(e.stack);\n        return go_next = true;\n      }\n    }, function() {\n      return console.log('Failed to bind environment');\n    }));\n  }\n});\n","###\n*    *    *    *    *    *\n┬    ┬    ┬    ┬    ┬    ┬\n│    │    │    │    │    |\n│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)\n│    │    │    │    └───── month (1 - 12)\n│    │    │    └────────── day of month (1 - 31)\n│    │    └─────────────── hour (0 - 23)\n│    └──────────────────── minute (0 - 59)\n└───────────────────────── second (0 - 59, OPTIONAL)\n###\nMeteor.startup ->\n\tif Meteor.settings.cron?.timeout_auto_submit\n\t\tschedule = require('node-schedule')\n\t\t# 定时执行同步\n\t\trule = Meteor.settings.cron.timeout_auto_submit\n\t\tgo_next = true\n\t\tschedule.scheduleJob rule, Meteor.bindEnvironment ()->\n\t\t\ttry\n\t\t\t\tif !go_next\n\t\t\t\t\treturn\n\t\t\t\tgo_next = false\n\t\t\t\tconsole.time 'timeout_auto_submit'\n\n\t\t\t\tuuflowManager.timeoutAutoSubmit()\n\n\t\t\t\tconsole.timeEnd 'timeout_auto_submit'\n\t\t\t\tgo_next = true\n\n\t\t\tcatch e\n\t\t\t\tconsole.error \"AUTO TIMEOUT_AUTO_SUBMIT ERROR: \"\n\t\t\t\tconsole.error e.stack\n\t\t\t\tgo_next = true\n\n\t\t, ()->\n\t\t\tconsole.log 'Failed to bind environment'\n\nMeteor.methods\n\ttimeout_auto_submit: (ins_id)->\n\t\tuuflowManager.timeoutAutoSubmit(ins_id)\n\t\treturn true\n\n\n","\n/*\n*    *    *    *    *    *\n┬    ┬    ┬    ┬    ┬    ┬\n│    │    │    │    │    |\n│    │    │    │    │    └ day of week (0 - 7) (0 or 7 is Sun)\n│    │    │    │    └───── month (1 - 12)\n│    │    │    └────────── day of month (1 - 31)\n│    │    └─────────────── hour (0 - 23)\n│    └──────────────────── minute (0 - 59)\n└───────────────────────── second (0 - 59, OPTIONAL)\n */\nMeteor.startup(function() {\n  var go_next, ref, rule, schedule;\n  if ((ref = Meteor.settings.cron) != null ? ref.timeout_auto_submit : void 0) {\n    schedule = require('node-schedule');\n    rule = Meteor.settings.cron.timeout_auto_submit;\n    go_next = true;\n    return schedule.scheduleJob(rule, Meteor.bindEnvironment(function() {\n      var e;\n      try {\n        if (!go_next) {\n          return;\n        }\n        go_next = false;\n        console.time('timeout_auto_submit');\n        uuflowManager.timeoutAutoSubmit();\n        console.timeEnd('timeout_auto_submit');\n        return go_next = true;\n      } catch (error) {\n        e = error;\n        console.error(\"AUTO TIMEOUT_AUTO_SUBMIT ERROR: \");\n        console.error(e.stack);\n        return go_next = true;\n      }\n    }, function() {\n      return console.log('Failed to bind environment');\n    }));\n  }\n});\n\nMeteor.methods({\n  timeout_auto_submit: function(ins_id) {\n    uuflowManager.timeoutAutoSubmit(ins_id);\n    return true;\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/nextStepUsers\", function(req, res, next) {\n\tvar\n\t\tdeal_type = req.query.deal_type,\n\t\tspaceId = req.query.spaceId,\n\t\terror = \"\";\n\n\tif (!deal_type || !spaceId) {\n\t\tJsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '缺少参数'\n\t\t\t}\n\t\t});\n\t}\n\n\tvar\n\t\tbody = req.body,\n\t\tnextStepUsers = [];\n\n\n\tswitch (deal_type) {\n\t\tcase 'specifyUser':\n\t\t\tvar specifyUserIds = body.specifyUserIds;\n\n\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, specifyUserIds);\n\t\t\tbreak;\n\t\tcase 'applicantRole':\n\t\t\tvar\n\t\t\t\tapplicantId = body.applicantId,\n\t\t\t\tapproveRoleIds = body.approveRoleIds;\n\t\t\tvar applicant = WorkflowManager.getUser(spaceId, applicantId);\n\n\t\t\tif (applicant)\n\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, applicant.organizations, approveRoleIds);\n\t\t\tbreak;\n\t\tcase 'applicantSuperior':\n\t\t\tvar applicantId = body.applicantId;\n\t\t\tvar applicant = WorkflowManager.getUser(spaceId, applicantId);\n\t\t\tif (applicant.manager) {\n\t\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, applicant.manager);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'applicant':\n\t\t\tvar applicantId = body.applicantId;\n\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, applicantId);\n\t\t\tbreak;\n\t\tcase 'userField':\n\t\t\tvar\n\t\t\t\tuserField = body.userField,\n\t\t\t\tuserFieldValue = body.userFieldValue;\n\t\t\tif (userField.is_multiselect) { //如果多选，以userFieldValue值为Array\n\t\t\t\tnextStepUsers = WorkflowManager.getUsers(spaceId, userFieldValue);\n\t\t\t} else {\n\t\t\t\tnextStepUsers.push(WorkflowManager.getUser(spaceId, userFieldValue));\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'orgField':\n\t\t\tvar\n\t\t\t\torgs,\n\t\t\t\torgChildrens,\n\t\t\t\torgField = body.orgField,\n\t\t\t\torgFieldValue = body.orgFieldValue;\n\t\t\tif (orgFieldValue) {\n\t\t\t\tif (orgField.is_multiselect) { //如果多选，以orgFieldValue值为Array\n\t\t\t\t\torgs = WorkflowManager.getOrganizations(orgFieldValue);\n\t\t\t\t\torgChildrens = WorkflowManager.getOrganizationsChildrens(spaceId, orgFieldValue);\n\t\t\t\t} else {\n\t\t\t\t\torgs = [WorkflowManager.getOrganization(orgFieldValue)];\n\t\t\t\t\torgChildrens = WorkflowManager.getOrganizationChildrens(spaceId, orgFieldValue);\n\t\t\t\t}\n\t\t\t\tnextStepUsers = WorkflowManager.getOrganizationsUsers(spaceId, orgChildrens);\n\n\t\t\t\torgFieldUsers = WorkflowManager.getOrganizationsUsers(spaceId, orgs);\n\n\t\t\t\tnextStepUsers = nextStepUsers.concat(orgFieldUsers);\n\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\n\t\t\t\t\terror = \"ORG_NO_MEMBERS\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\n\t\t\t}\n\n\t\t\tbreak;\n\t\tcase 'specifyOrg':\n\t\t\tvar specifyOrgIds = body.specifyOrgIds;\n\t\t\tvar specifyOrgs = WorkflowManager.getOrganizations(specifyOrgIds);\n\t\t\tvar specifyOrgChildrens = WorkflowManager.getOrganizationsChildrens(spaceId, specifyOrgIds);\n\n\t\t\tnextStepUsers = WorkflowManager.getOrganizationsUsers(spaceId, specifyOrgs);\n\t\t\tnextStepUsers = nextStepUsers.concat(WorkflowManager.getOrganizationsUsers(spaceId, specifyOrgChildrens));\n\t\t\tbreak;\n\t\tcase 'userFieldRole':\n\t\t\tvar\n\t\t\t\tuserField = body.userField,\n\t\t\t\tuserFieldValue = body.userFieldValue,\n\t\t\t\tapproverRoleIds = body.approverRoleIds;\n\t\t\tif (userFieldValue) {\n\t\t\t\tif (userField.is_multiselect) { //如果多选，以userFieldValue值为Array\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByUsersAndRoles(spaceId, userFieldValue, approverRoleIds);\n\t\t\t\t} else {\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByUsersAndRoles(spaceId, [userFieldValue], approverRoleIds);\n\t\t\t\t}\n\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\n\t\t\t\t\terror = \"ROLE_NO_MEMBERS\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\n\t\t\t}\n\n\n\t\t\tbreak;\n\t\tcase 'orgFieldRole':\n\t\t\tvar\n\t\t\t\torgField = body.orgField,\n\t\t\t\torgFieldValue = body.orgFieldValue,\n\t\t\t\tapproverRoleIds = body.approverRoleIds;\n\n\t\t\tif (orgFieldValue) {\n\t\t\t\tif (orgField.is_multiselect) { //如果多选，以orgFieldValue值为Array\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, orgFieldValue, approverRoleIds);\n\t\t\t\t} else {\n\t\t\t\t\tnextStepUsers = WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, [orgFieldValue], approverRoleIds);\n\t\t\t\t}\n\n\t\t\t\tif (!nextStepUsers || nextStepUsers.length < 1) {\n\t\t\t\t\terror = \"ROLE_NO_MEMBERS\";\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terror = \"FIELD_VALUE_EMPTY\";\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t}\n\n\tvar result = [];\n\n\tnextStepUsers.forEach(function(su) {\n\t\tvar o = {\n\t\t\tid: su.id,\n\t\t\tname: su.name\n\t\t};\n\t\tresult.push(o);\n\t})\n\n\tJsonRoutes.sendResult(res, {\n\t\tcode: 200,\n\t\tdata: {\n\t\t\t'nextStepUsers': WorkflowManager.uniqUsers(result),\n\t\t\t'error': error\n\t\t}\n\t});\n})","JsonRoutes.add(\"post\", \"/api/workflow/getSpaceUsers\", function (req, res, next) {\n  var\n    userIds = req.body.userIds,\n    spaceId = req.query.spaceId,\n    spaceUsers = []\n  ;\n\n  if (!userIds || !spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '缺少参数'\n      }\n    });\n  }\n\n  spaceUsers = WorkflowManager.getUsers(spaceId, userIds);\n\n  JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'spaceUsers': spaceUsers\n    }\n  });\n})\n\n\n  \n  ","JsonRoutes.add(\"post\", \"/api/workflow/getFormulaUserObjects\", function (req, res, next) {\n  var\n    userIds = req.body.userIds,\n    spaceId = req.query.spaceId,\n    spaceUsers = []\n  ;\n\n  if (!userIds || !spaceId) {\n    JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '缺少参数'\n      }\n    });\n  }\n\n  var users = WorkflowManager.getFormulaUserObject(spaceId, userIds);\n\n  JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'spaceUsers': users\n    }\n  });\n})\n\n\n  \n  ","JsonRoutes.add(\"post\", \"/api/workflow/init_formula_values\", function(req, res, next) {\n\tvar\n\t\tfields = req.body.fields,\n\t\tautoFormDoc = req.body.autoFormDoc,\n\t\tapprover = req.body.approver,\n\t\tapplicant = req.body.applicant,\n\n\t\tspaceId = req.query.spaceId,\n\n\t\tspaceUsers = [];\n\n\tif (!fields || !spaceId || !autoFormDoc || !approver || !applicant) {\n\t\tJsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '缺少参数'\n\t\t\t}\n\t\t});\n\t\treturn;\n\t}\n\n\tformula_values = Form_formula.init_formula_values(fields, autoFormDoc, approver, applicant, spaceId);\n\n\tJsonRoutes.sendResult(res, {\n\t\tcode: 200,\n\t\tdata: {\n\t\t\t'formula_values': formula_values\n\t\t}\n\t});\n})\n","JsonRoutes.add \"post\", \"/api/workflow/getNameForUser\",  (req, res, next) ->\n\ttry\n\t\tuserId = req.body.userId\n\n\t\tif not userId \n\t\t\tJsonRoutes.sendResult res, \n\t\t\t\tcode: 200,\n\t\t\t\tdata: {\n\t\t\t\t\t'errors': '缺少参数'\n\t\t\t\t}\n\n\t\tuser = WorkflowManager.getNameForUser(userId)\n\n\t\tJsonRoutes.sendResult res, \n\t\t\tcode: 200,\n\t\t\tdata: {user: user}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n\t\n\t\t\n","JsonRoutes.add(\"post\", \"/api/workflow/getNameForUser\", function(req, res, next) {\n  var e, user, userId;\n  try {\n    userId = req.body.userId;\n    if (!userId) {\n      JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'errors': '缺少参数'\n        }\n      });\n    }\n    user = WorkflowManager.getNameForUser(userId);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        user: user\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'get', '/api/designer/startup', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\tcompanyId = req.query?.companyId || ''\n\n\t\tspacesQuery = { admins: current_user }\n\n\t\tif companyId\n\t\t\torg = db.organizations.findOne(companyId, { fields: { space:1 } })\n\t\t\tif not org\n\t\t\t\tthrow new Meteor.Error('error', 'companyId is invalid')\n\n\t\t\tspacesQuery = { _id: org.space }\n\n\t\tspaces = db.spaces.find(spacesQuery).fetch()\n\n\t\tspaceIds = _.pluck spaces, '_id'\n\n\t\tquery = { space: { $in: spaceIds } }\n\t\tif companyId\n\t\t\tquery.company_id = companyId\n\n\t\tspaceUsers = db.space_users.find(query).fetch()\n\n\t\tforms = db.forms.find(query, { fields: { name:1, state:1, is_deleted:1, is_valid:1, space:1, description:1, help_text:1,\n\t\tcreated:1, created_by:1, current:1, category:1, instance_style:1, company_id:1 } }).fetch()\n\n\t\tflows = db.flows.find(query, { fields: { name:1, name_formula:1, code_formula:1, space:1, description:1, is_valid:1, form:1,\n\t\tflowtype:1, state:1, is_deleted:1, created:1, created_by:1, help_text:1, current_no:1, current:1, perms:1, error_message:1, distribute_optional_users:1, company_id:1 } }).fetch()\n\n\t\troles = db.flow_roles.find(query).fetch()\n\n\t\torganizations = db.organizations.find(query).fetch()\n\n\t\tpositions = db.flow_positions.find(query).fetch()\n\n\t\tcategories = db.categories.find({ space: { $in: spaceIds } }).fetch()\n\n\t\tuserIds = _.pluck spaceUsers, 'user'\n\t\tusers = db.users.find({ _id: { $in: userIds } }, { fields: { name: 1 } }).fetch()\n\n\t\tresult = {}\n\t\tresult.SpaceUsers = spaceUsers\n\t\tresult.Users = users\n\t\tresult.Forms = forms\n\t\tresult.Flows = flows\n\t\tresult.Organizations = organizations\n\t\tresult.Positions = positions\n\t\tresult.Roles = roles\n\t\tresult.Categories = categories\n\t\tresult.Spaces = spaces\n\n\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 200\n\t\t\t\tdata: result\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n\n","JsonRoutes.add('get', '/api/designer/startup', function(req, res, next) {\n  var categories, companyId, current_user, current_user_info, e, flows, forms, org, organizations, positions, query, ref, result, roles, spaceIds, spaceUsers, spaces, spacesQuery, userIds, users;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    companyId = ((ref = req.query) != null ? ref.companyId : void 0) || '';\n    spacesQuery = {\n      admins: current_user\n    };\n    if (companyId) {\n      org = db.organizations.findOne(companyId, {\n        fields: {\n          space: 1\n        }\n      });\n      if (!org) {\n        throw new Meteor.Error('error', 'companyId is invalid');\n      }\n      spacesQuery = {\n        _id: org.space\n      };\n    }\n    spaces = db.spaces.find(spacesQuery).fetch();\n    spaceIds = _.pluck(spaces, '_id');\n    query = {\n      space: {\n        $in: spaceIds\n      }\n    };\n    if (companyId) {\n      query.company_id = companyId;\n    }\n    spaceUsers = db.space_users.find(query).fetch();\n    forms = db.forms.find(query, {\n      fields: {\n        name: 1,\n        state: 1,\n        is_deleted: 1,\n        is_valid: 1,\n        space: 1,\n        description: 1,\n        help_text: 1,\n        created: 1,\n        created_by: 1,\n        current: 1,\n        category: 1,\n        instance_style: 1,\n        company_id: 1\n      }\n    }).fetch();\n    flows = db.flows.find(query, {\n      fields: {\n        name: 1,\n        name_formula: 1,\n        code_formula: 1,\n        space: 1,\n        description: 1,\n        is_valid: 1,\n        form: 1,\n        flowtype: 1,\n        state: 1,\n        is_deleted: 1,\n        created: 1,\n        created_by: 1,\n        help_text: 1,\n        current_no: 1,\n        current: 1,\n        perms: 1,\n        error_message: 1,\n        distribute_optional_users: 1,\n        company_id: 1\n      }\n    }).fetch();\n    roles = db.flow_roles.find(query).fetch();\n    organizations = db.organizations.find(query).fetch();\n    positions = db.flow_positions.find(query).fetch();\n    categories = db.categories.find({\n      space: {\n        $in: spaceIds\n      }\n    }).fetch();\n    userIds = _.pluck(spaceUsers, 'user');\n    users = db.users.find({\n      _id: {\n        $in: userIds\n      }\n    }, {\n      fields: {\n        name: 1\n      }\n    }).fetch();\n    result = {};\n    result.SpaceUsers = spaceUsers;\n    result.Users = users;\n    result.Forms = forms;\n    result.Flows = flows;\n    result.Organizations = organizations;\n    result.Positions = positions;\n    result.Roles = roles;\n    result.Categories = categories;\n    result.Spaces = spaces;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: result\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/engine', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\n\t\t_.each hashData['Approvals'], (approve_from_client) ->\n\t\t\tuuflowManager.workflow_engine(approve_from_client, current_user_info, current_user)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: {}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n","JsonRoutes.add('post', '/api/workflow/engine', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Approvals'], function(approve_from_client) {\n      return uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/drafts', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\n\t\tinserted_instances = new Array\n\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tnew_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info)\n\n\t\t\tnew_ins = db.instances.findOne({ _id: new_ins_id }, { fields: { space: 1, flow: 1, flow_version: 1, form: 1, form_version: 1 } })\n\n\t\t\tinserted_instances.push(new_ins)\n\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { inserts: inserted_instances }\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\n\t\t}\n\n","JsonRoutes.add('post', '/api/workflow/drafts', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var new_ins, new_ins_id;\n      new_ins_id = uuflowManager.create_instance(instance_from_client, current_user_info);\n      new_ins = db.instances.findOne({\n        _id: new_ins_id\n      }, {\n        fields: {\n          space: 1,\n          flow: 1,\n          flow_version: 1,\n          form: 1,\n          form_version: 1\n        }\n      });\n      return inserted_instances.push(new_ins);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/remove', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\n\t\tinserted_instances = new Array\n\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\t# 获取一个instance\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\n\t\t\tspace_id = instance.space\n\t\t\t# 获取一个space\n\t\t\tspace = uuflowManager.getSpace(space_id)\n\t\t\t# 获取一个space下的一个user\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\n\t\t\tflow = db.flows.findOne({_id: instance.flow})\n\n\t\t\tspaceUserOrganizations = db.organizations.find({\n\t\t\t\t_id: {\n\t\t\t\t\t$in: space_user.organizations\n\t\t\t\t}\n\t\t\t}).fetch();\n\n\t\t\t# 判断一个用户是否是一个instance的提交者或者申请人 或SpaceAdmin\n\t\t\tif (instance.submitter isnt current_user) and (not space.admins.includes current_user) and !WorkflowManager.canAdmin(flow, space_user, spaceUserOrganizations)\n\t\t\t\tthrow new  Meteor.Error('error!', \"您不能删除此申请单。\")\n\n\t\t\tdelete_obj = db.instances.findOne(instance_from_client[\"_id\"])\n\t\t\tdelete_obj.deleted = new Date\n\t\t\tdelete_obj.deleted_by = current_user\n\n\t\t\tdb.deleted_instances.insert(delete_obj)\n\n\t\t\t# 删除instance\n\t\t\tdb.instances.remove(instance_from_client[\"_id\"])\n\n\t\t\tif delete_obj.state isnt \"draft\"\n\t\t\t\t#发送给待处理人, #发送给被传阅人\n\t\t\t\tinbox_users = if delete_obj.inbox_users then delete_obj.inbox_users else []\n\t\t\t\tcc_users = if delete_obj.cc_users then delete_obj.cc_users else []\n\t\t\t\tuser_ids = _.uniq(inbox_users.concat(cc_users))\n\t\t\t\t_.each user_ids, (u_id)->\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"terminate_approval\", u_id)\n\n\t\t\t\t# 发送删除通知邮件给通过校验的申请人/填单人，对申请人/填单人各生成一条smtp message\n\t\t\t\tpushManager.send_instance_notification(\"monitor_delete_applicant\", delete_obj, \"\", current_user_info)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { inserts: inserted_instances}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n\t\n\t\t","JsonRoutes.add('post', '/api/workflow/remove', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, inserted_instances;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    inserted_instances = new Array;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var cc_users, delete_obj, flow, inbox_users, instance, space, spaceUserOrganizations, space_id, space_user, user_ids;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      space_id = instance.space;\n      space = uuflowManager.getSpace(space_id);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      flow = db.flows.findOne({\n        _id: instance.flow\n      });\n      spaceUserOrganizations = db.organizations.find({\n        _id: {\n          $in: space_user.organizations\n        }\n      }).fetch();\n      if ((instance.submitter !== current_user) && (!space.admins.includes(current_user)) && !WorkflowManager.canAdmin(flow, space_user, spaceUserOrganizations)) {\n        throw new Meteor.Error('error!', \"您不能删除此申请单。\");\n      }\n      delete_obj = db.instances.findOne(instance_from_client[\"_id\"]);\n      delete_obj.deleted = new Date;\n      delete_obj.deleted_by = current_user;\n      db.deleted_instances.insert(delete_obj);\n      db.instances.remove(instance_from_client[\"_id\"]);\n      if (delete_obj.state !== \"draft\") {\n        inbox_users = delete_obj.inbox_users ? delete_obj.inbox_users : [];\n        cc_users = delete_obj.cc_users ? delete_obj.cc_users : [];\n        user_ids = _.uniq(inbox_users.concat(cc_users));\n        _.each(user_ids, function(u_id) {\n          return pushManager.send_message_to_specifyUser(\"terminate_approval\", u_id);\n        });\n        return pushManager.send_instance_notification(\"monitor_delete_applicant\", delete_obj, \"\", current_user_info);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        inserts: inserted_instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/submit', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\tresult = []\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tr = uuflowManager.submit_instance(instance_from_client, current_user_info)\n\t\t\tif r.alerts\n\t\t\t\tresult.push(r)\n\t\t\tif not _.isEmpty(instance_from_client['inbox_users'])\n\t\t\t\t# 如果是转发就需要给当前用户发送push 重新计算badge\n\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", current_user);\n\n\t\t\tif _.isEmpty(r.alerts)\n\t\t\t\tinstance = db.instances.findOne(instance_from_client._id)\n\t\t\t\tflow_id = instance.flow\n\t\t\t\tcurrent_approve = instance_from_client.traces[0].approves[0]\n\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\tpushManager.triggerWebhook(flow_id, instance, current_approve, 'draft_submit', current_user, instance.inbox_users)\n\n\t\t\t# 判断申请单是否分发，分发文件结束提醒发起人\n\t\t\tuuflowManager.distributedInstancesRemind(instance_from_client)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 200\n\t\t\t\tdata: { result: result }\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n","JsonRoutes.add('post', '/api/workflow/submit', function(req, res, next) {\n  var current_user, current_user_info, e, hashData, result;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    result = [];\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var current_approve, flow_id, instance, r;\n      r = uuflowManager.submit_instance(instance_from_client, current_user_info);\n      if (r.alerts) {\n        result.push(r);\n      }\n      if (!_.isEmpty(instance_from_client['inbox_users'])) {\n        pushManager.send_message_to_specifyUser(\"current_user\", current_user);\n      }\n      if (_.isEmpty(r.alerts)) {\n        instance = db.instances.findOne(instance_from_client._id);\n        flow_id = instance.flow;\n        current_approve = instance_from_client.traces[0].approves[0];\n        pushManager.triggerWebhook(flow_id, instance, current_approve, 'draft_submit', current_user, instance.inbox_users);\n      }\n      return uuflowManager.distributedInstancesRemind(instance_from_client);\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        result: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/terminate', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tterminate_reason = instance_from_client[\"terminate_reason\"]\n\t\t\tinstance_id = instance_from_client[\"_id\"]\n\t\t\t# 获取一个instance\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\n\t\t\tspace_id = instance.space\n\t\t\tflow_id = instance.flow\n\t\t\t# 获取一个space\n\t\t\tspace = uuflowManager.getSpace(space_id)\n\t\t\t# 获取一个flow\n\t\t\tflow = uuflowManager.getFlow(flow_id)\n\t\t\t# 判断一个instance是否为审核中状态\n\t\t\tuuflowManager.isInstancePending(instance)\n\t\t\t# 获取一个space下的一个user\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\t# 获取space_user所在的部门信息\n\t\t\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t\t\t# 获取结束节点\n\t\t\tinstance_flow_ver = null\n\t\t\tflow_ver_end_step = null\n\t\t\tflow_vers = new Array\n\t\t\tflow_vers.push(flow.current)\n\t\t\tflow_vers = flow_vers.concat(flow.historys)\n\t\t\tinstance_flow_ver = _.find(flow_vers, (f_ver)->\n\t\t\t\treturn f_ver._id is instance.flow_version\n\t\t\t)\n\t\t\tif not instance_flow_ver\n\t\t\t\tthrow new Meteor.Error('error!', \"未找到申请单对应流程版本\")\n\t\t\tflow_ver_end_step = _.find(instance_flow_ver.steps, (f_step)->\n\t\t\t\treturn f_step.step_type is \"end\"\n\t\t\t)\n\t\t\t# 调用getFlowPermissions方法，看返回的结果中是否有admin\n\t\t\tpermissions = permissionManager.getFlowPermissions(flow_id, current_user)\n\t\t\tnow = new Date\n\t\t\tsetObj = new Object\n\t\t\t# space的admin, 填单人 申请人 有权限 取消申请\n\t\t\tif permissions.includes(\"admin\") or space.admins.includes(current_user) or instance.submitter is current_user or instance.applicant is current_user\n\t\t\t\tif not terminate_reason\n\t\t\t\t\tthrow new Meteor.Error('error!',\"还未填写强制结束申请单的理由，操作失败\")\n\n\t\t\t\tinstance_trace = _.find(instance.traces, (trace)->\n\t\t\t\t\treturn trace.is_finished is false\n\t\t\t\t)\n\n\t\t\t\ttraces = instance.traces\n\t\t\t\ti = 0\n\t\t\t\twhile i < traces.length\n\t\t\t\t\tif traces[i].is_finished is false\n\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\ttraces[i].is_finished = true\n\t\t\t\t\t\ttraces[i].finish_date = now\n\t\t\t\t\t\th = 0\n\t\t\t\t\t\twhile h < traces[i].approves.length\n\t\t\t\t\t\t\tif traces[i].approves[h].is_finished is false\n\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\ttraces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\ttraces[i].approves[h].finish_date = now\n\t\t\t\t\t\t\t\ttraces[i].approves[h].judge = null\n\t\t\t\t\t\t\t\ttraces[i].approves[h].description = null\n\t\t\t\t\t\t\th++\n\t\t\t\t\t\t# 插入当前Trace trace.approve记录：当trace.type为取回、强制结束时，is_read=true且read_date为当前时间。\n\t\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\t\tnewApprove.trace = instance_trace._id\n\t\t\t\t\t\tnewApprove.is_finished = true\n\t\t\t\t\t\tnewApprove.user = current_user\n\t\t\t\t\t\tnewApprove.user_name = current_user_info.name\n\t\t\t\t\t\tnewApprove.handler = current_user\n\t\t\t\t\t\tnewApprove.handler_name = current_user_info.name\n\t\t\t\t\t\tnewApprove.handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\tnewApprove.handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\tnewApprove.handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\tnewApprove.start_date = now\n\t\t\t\t\t\tnewApprove.finish_date = now\n\t\t\t\t\t\tnewApprove.due_date = instance_trace.due_date\n\t\t\t\t\t\tnewApprove.read_date = now\n\t\t\t\t\t\tnewApprove.judge = \"terminated\"\n\t\t\t\t\t\tnewApprove.is_read = true\n\t\t\t\t\t\tnewApprove.description = terminate_reason\n\t\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\t\tnewApprove.cost_time = newApprove.finish_date - newApprove.start_date\n\t\t\t\t\t\ttraces[i].approves.push(newApprove)\n\t\t\t\t\ti++\n\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [instance_trace._id]\n\t\t\t\t# type---停用\n\t\t\t\t# newTrace.type = \"terminated\"\n\t\t\t\tnewTrace.is_finished = true\n\t\t\t\tnewTrace.step = flow_ver_end_step._id\n\t\t\t\tnewTrace.name = flow_ver_end_step.name\n\t\t\t\tnewTrace.start_date = now\n\t\t\t\tnewTrace.finish_date = now\n\t\t\t\tnewTrace.judge = \"terminated\"\n\n\t\t\t\tsetObj.state = \"completed\"\n\t\t\t\tsetObj.final_decision = \"terminated\"\n\t\t\t\told_inbox_users = instance.inbox_users\n\t\t\t\told_cc_users = instance.cc_users\n\t\t\t\told_outbox_users = instance.outbox_users\n\t\t\t\ttempUsers = new Array\n\t\t\t\t_.each(instance_trace.approves, (nft_approve)->\n\t\t\t\t\ttempUsers.push(nft_approve.user)\n\t\t\t\t\ttempUsers.push(nft_approve.handler)\n\t\t\t\t)\n\t\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users.concat(tempUsers))\n\t\t\t\tsetObj.inbox_users = new Array\n\t\t\t\tsetObj.cc_users = new Array\n\t\t\t\tsetObj.modified = now\n\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\ttraces.push(newTrace)\n\t\t\t\tsetObj.traces = traces\n\n\t\t\t\tsetObj.current_step_name = flow_ver_end_step.name\n\t\t\t\tsetObj.current_step_auto_submit = false\n\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\n\t\t\t\tif r\n\t\t\t\t\tins = uuflowManager.getInstance(instance_id)\n\t\t\t\t\t#通知填单人、申请人\n\t\t\t\t\tpushManager.send_instance_notification(\"submit_terminate_applicant\", ins, terminate_reason, current_user_info)\n\n\t\t\t\t\t#发送给待处理人 被传阅人\n\t\t\t\t\tif old_inbox_users\n\t\t\t\t\t\t_.each(_.uniq(old_inbox_users.concat(old_cc_users)), (user_id)->\n\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"terminate_approval\", user_id)\n\t\t\t\t\t\t)\n\n\t\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'terminate', current_user, [])\n\n\t\t#发送消息给当前用户\n\t\tpushManager.send_message_current_user(current_user_info)\n\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 200\n\t\t\t\tdata: {}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n","JsonRoutes.add('post', '/api/workflow/terminate', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var flow, flow_id, flow_ver_end_step, flow_vers, h, i, ins, instance, instance_flow_ver, instance_id, instance_trace, newApprove, newTrace, now, old_cc_users, old_inbox_users, old_outbox_users, permissions, r, setObj, space, space_id, space_user, space_user_org_info, tempUsers, terminate_reason, traces;\n      terminate_reason = instance_from_client[\"terminate_reason\"];\n      instance_id = instance_from_client[\"_id\"];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      flow_id = instance.flow;\n      space = uuflowManager.getSpace(space_id);\n      flow = uuflowManager.getFlow(flow_id);\n      uuflowManager.isInstancePending(instance);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n      instance_flow_ver = null;\n      flow_ver_end_step = null;\n      flow_vers = new Array;\n      flow_vers.push(flow.current);\n      flow_vers = flow_vers.concat(flow.historys);\n      instance_flow_ver = _.find(flow_vers, function(f_ver) {\n        return f_ver._id === instance.flow_version;\n      });\n      if (!instance_flow_ver) {\n        throw new Meteor.Error('error!', \"未找到申请单对应流程版本\");\n      }\n      flow_ver_end_step = _.find(instance_flow_ver.steps, function(f_step) {\n        return f_step.step_type === \"end\";\n      });\n      permissions = permissionManager.getFlowPermissions(flow_id, current_user);\n      now = new Date;\n      setObj = new Object;\n      if (permissions.includes(\"admin\") || space.admins.includes(current_user) || instance.submitter === current_user || instance.applicant === current_user) {\n        if (!terminate_reason) {\n          throw new Meteor.Error('error!', \"还未填写强制结束申请单的理由，操作失败\");\n        }\n        instance_trace = _.find(instance.traces, function(trace) {\n          return trace.is_finished === false;\n        });\n        traces = instance.traces;\n        i = 0;\n        while (i < traces.length) {\n          if (traces[i].is_finished === false) {\n            traces[i].is_finished = true;\n            traces[i].finish_date = now;\n            h = 0;\n            while (h < traces[i].approves.length) {\n              if (traces[i].approves[h].is_finished === false) {\n                traces[i].approves[h].is_finished = true;\n                traces[i].approves[h].finish_date = now;\n                traces[i].approves[h].judge = null;\n                traces[i].approves[h].description = null;\n              }\n              h++;\n            }\n            newApprove = new Object;\n            newApprove._id = new Mongo.ObjectID()._str;\n            newApprove.instance = instance_id;\n            newApprove.trace = instance_trace._id;\n            newApprove.is_finished = true;\n            newApprove.user = current_user;\n            newApprove.user_name = current_user_info.name;\n            newApprove.handler = current_user;\n            newApprove.handler_name = current_user_info.name;\n            newApprove.handler_organization = space_user_org_info[\"organization\"];\n            newApprove.handler_organization_name = space_user_org_info[\"organization_name\"];\n            newApprove.handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n            newApprove.start_date = now;\n            newApprove.finish_date = now;\n            newApprove.due_date = instance_trace.due_date;\n            newApprove.read_date = now;\n            newApprove.judge = \"terminated\";\n            newApprove.is_read = true;\n            newApprove.description = terminate_reason;\n            newApprove.is_error = false;\n            newApprove.values = new Object;\n            newApprove.cost_time = newApprove.finish_date - newApprove.start_date;\n            traces[i].approves.push(newApprove);\n          }\n          i++;\n        }\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [instance_trace._id];\n        newTrace.is_finished = true;\n        newTrace.step = flow_ver_end_step._id;\n        newTrace.name = flow_ver_end_step.name;\n        newTrace.start_date = now;\n        newTrace.finish_date = now;\n        newTrace.judge = \"terminated\";\n        setObj.state = \"completed\";\n        setObj.final_decision = \"terminated\";\n        old_inbox_users = instance.inbox_users;\n        old_cc_users = instance.cc_users;\n        old_outbox_users = instance.outbox_users;\n        tempUsers = new Array;\n        _.each(instance_trace.approves, function(nft_approve) {\n          tempUsers.push(nft_approve.user);\n          return tempUsers.push(nft_approve.handler);\n        });\n        setObj.outbox_users = _.uniq(instance.outbox_users.concat(tempUsers));\n        setObj.inbox_users = new Array;\n        setObj.cc_users = new Array;\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        traces.push(newTrace);\n        setObj.traces = traces;\n        setObj.current_step_name = flow_ver_end_step.name;\n        setObj.current_step_auto_submit = false;\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          ins = uuflowManager.getInstance(instance_id);\n          pushManager.send_instance_notification(\"submit_terminate_applicant\", ins, terminate_reason, current_user_info);\n          if (old_inbox_users) {\n            _.each(_.uniq(old_inbox_users.concat(old_cc_users)), function(user_id) {\n              return pushManager.send_message_to_specifyUser(\"terminate_approval\", user_id);\n            });\n          }\n          return pushManager.triggerWebhook(ins.flow, ins, {}, 'terminate', current_user, []);\n        }\n      }\n    });\n    pushManager.send_message_current_user(current_user_info);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/reassign', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tinstance_id = instance_from_client['_id']\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\n\t\t\tspace_id = instance.space\n\t\t\t# 验证instance为审核中状态\n\t\t\tuuflowManager.isInstancePending(instance)\n\t\t\t# 验证当前执行转签核的trace未结束\n\t\t\tlast_trace_from_client = _.last(instance_from_client[\"traces\"])\n\t\t\tlast_trace = _.find(instance.traces, (t) ->\n\t\t\t\treturn t._id is last_trace_from_client[\"_id\"]\n\t\t\t)\n\t\t\tif last_trace.is_finished is true\n\t\t\t\treturn\n\n\t\t\t# 验证login user_id对该流程有管理申请单的权限\n\t\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\n\t\t\tspace = db.spaces.findOne({ _id: space_id }, { fields: { admins: 1 } })\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user))\n\t\t\t\tthrow new Meteor.Error('error!', \"用户没有对当前流程的管理权限\")\n\n\t\t\tinbox_users = instance.inbox_users\n\t\t\tinbox_users_from_client = instance_from_client[\"inbox_users\"]\n\t\t\treassign_reason = instance_from_client[\"reassign_reason\"]\n\t\t\tnot_in_inbox_users = _.difference(inbox_users, inbox_users_from_client)\n\t\t\tnew_inbox_users = _.difference(inbox_users_from_client, inbox_users)\n\t\t\t# 若assignee=原inbox_users，说明不需要执行转签核，系统什么都不做\n\t\t\treturn if not_in_inbox_users.length is 0 and new_inbox_users.length is 0\n\t\t\tsetObj = new Object\n\t\t\tnow = new Date\n\t\t\ti = 0\n\t\t\tapprove_users_handlers = []\n\t\t\twhile i < last_trace.approves.length\n\t\t\t\tif not_in_inbox_users.includes(last_trace.approves[i].handler)\n\t\t\t\t\tif last_trace.approves[i].is_finished is false and last_trace.approves[i].type isnt \"cc\" and last_trace.approves[i].type isnt \"distribute\"\n\t\t\t\t\t\tlast_trace.approves[i].is_finished = true\n\t\t\t\t\t\tlast_trace.approves[i].finish_date = now\n\t\t\t\t\t\tlast_trace.approves[i].judge = \"terminated\"\n\t\t\t\t\t\tlast_trace.approves[i].description = \"\"\n\t\t\t\t\t\tlast_trace.approves[i].cost_time = last_trace.approves[i].finish_date - last_trace.approves[i].start_date\n\t\t\t\t\t\tapprove_users_handlers.push(last_trace.approves[i].user)\n\t\t\t\t\t\tapprove_users_handlers.push(last_trace.approves[i].handler)\n\t\t\t\ti++\n\t\t\t# 在同一trace下插入转签核操作者的approve记录\n\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\tcurrent_user_organization = db.organizations.findOne({ _id: current_space_user.organization }, { fields: { name: 1, fullname: 1 } })\n\t\t\tassignee_appr = new Object\n\t\t\tassignee_appr._id = new Mongo.ObjectID()._str\n\t\t\tassignee_appr.instance = last_trace.instance\n\t\t\tassignee_appr.trace = last_trace._id\n\t\t\tassignee_appr.is_finished = true\n\t\t\tassignee_appr.user = current_user\n\t\t\tassignee_appr.user_name = current_user_info.name\n\t\t\tassignee_appr.handler = current_user\n\t\t\tassignee_appr.handler_name = current_user_info.name\n\t\t\tassignee_appr.handler_organization = current_space_user.organization\n\t\t\tassignee_appr.handler_organization_name = current_user_organization.name\n\t\t\tassignee_appr.handler_organization_fullname = current_user_organization.fullname\n\t\t\tassignee_appr.start_date = now\n\t\t\tassignee_appr.finish_date = now\n\t\t\tassignee_appr.due_date = last_trace.due_date\n\t\t\tassignee_appr.read_date = now\n\t\t\tassignee_appr.judge = \"reassigned\"\n\t\t\tassignee_appr.is_read = true\n\t\t\tassignee_appr.description = reassign_reason\n\t\t\tassignee_appr.is_error = false\n\t\t\tassignee_appr.values = new Object\n\t\t\tassignee_appr.cost_time = assignee_appr.finish_date - assignee_appr.start_date\n\t\t\tlast_trace.approves.push(assignee_appr)\n\t\t\t# 对新增的每位待审核人，各增加一条新的approve\n\t\t\t_.each(new_inbox_users, (user_id) ->\n\t\t\t\tnew_user = db.users.findOne(user_id, { fields: { name: 1 } })\n\t\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, user_id)\n\t\t\t\tuser_organization = db.organizations.findOne(space_user.organization, { fields: { name: 1, fullname: 1 } })\n\t\t\t\tnew_appr = new Object\n\t\t\t\tnew_appr._id = new Mongo.ObjectID()._str\n\t\t\t\tnew_appr.instance = last_trace.instance\n\t\t\t\tnew_appr.trace = last_trace._id\n\t\t\t\tnew_appr.is_finished = false\n\t\t\t\tnew_appr.user = user_id\n\t\t\t\tnew_appr.user_name = new_user.name\n\n\t\t\t\thandler_id = user_id\n\t\t\t\thandler_info = new_user\n\t\t\t\tagent = uuflowManager.getAgent(space_id, user_id)\n\t\t\t\tif agent\n\t\t\t\t\tinbox_users_from_client[inbox_users_from_client.indexOf(user_id)] = agent\n\t\t\t\t\thandler_id = agent\n\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\tnew_appr.agent = agent\n\n\t\t\t\tnew_appr.handler = handler_id\n\t\t\t\tnew_appr.handler_name = handler_info.name\n\t\t\t\tnew_appr.handler_organization = space_user.organization\n\t\t\t\tnew_appr.handler_organization_name = user_organization.name\n\t\t\t\tnew_appr.handler_organization_fullname = user_organization.fullname\n\t\t\t\tnew_appr.from_user = current_user\n\t\t\t\tnew_appr.from_user_name = current_user_info.name\n\t\t\t\tnew_appr.type = \"reassign\"\n\t\t\t\tnew_appr.start_date = now\n\t\t\t\tnew_appr.due_date = last_trace.due_date\n\t\t\t\tnew_appr.is_read = false\n\t\t\t\tnew_appr.is_error = false\n\t\t\t\tnew_appr.values = new Object\n\t\t\t\tuuflowManager.setRemindInfo(instance.values, new_appr)\n\t\t\t\tlast_trace.approves.push(new_appr)\n\t\t\t)\n\n\t\t\tinstance.outbox_users.push(current_user)\n\t\t\tinstance.outbox_users = instance.outbox_users.concat(approve_users_handlers)\n\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users)\n\t\t\tsetObj.inbox_users = inbox_users_from_client\n\t\t\tsetObj.modified = now\n\t\t\tsetObj.modified_by = current_user\n\t\t\tsetObj[\"traces.$.approves\"] = last_trace.approves\n\t\t\tr = db.instances.update({ _id: instance_id, \"traces._id\": last_trace._id }, { $set: setObj })\n\t\t\tif r\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\n\t\t\t\t# 给被删除的inbox_users 和 当前用户 发送push\n\t\t\t\tpushManager.send_message_current_user(current_user_info)\n\t\t\t\t_.each(not_in_inbox_users, (user_id) ->\n\t\t\t\t\tif user_id isnt current_user\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t\t\t)\n\t\t\t\t# 提取instances.outbox_users数组和填单人、申请人\n\t\t\t\t_users = new Array\n\t\t\t\t_users.push(ins.applicant)\n\t\t\t\t_users.push(ins.submitter)\n\t\t\t\t_users = _.uniq(_users.concat(ins.outbox_users))\n\t\t\t\t_.each(_users, (user_id) ->\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t\t\t)\n\n\t\t\t\t# 给新加入的inbox_users发送push message\n\t\t\t\tpushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, reassign_reason, current_user_info)\n\n\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'reassign', current_user, ins.inbox_users)\n\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: {}\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\n\t\t}\n","JsonRoutes.add('post', '/api/workflow/reassign', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var _users, approve_users_handlers, assignee_appr, current_space_user, current_user_organization, i, inbox_users, inbox_users_from_client, ins, instance, instance_id, last_trace, last_trace_from_client, new_inbox_users, not_in_inbox_users, now, permissions, r, reassign_reason, setObj, space, space_id;\n      instance_id = instance_from_client['_id'];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      uuflowManager.isInstancePending(instance);\n      last_trace_from_client = _.last(instance_from_client[\"traces\"]);\n      last_trace = _.find(instance.traces, function(t) {\n        return t._id === last_trace_from_client[\"_id\"];\n      });\n      if (last_trace.is_finished === true) {\n        return;\n      }\n      permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n      space = db.spaces.findOne({\n        _id: space_id\n      }, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user))) {\n        throw new Meteor.Error('error!', \"用户没有对当前流程的管理权限\");\n      }\n      inbox_users = instance.inbox_users;\n      inbox_users_from_client = instance_from_client[\"inbox_users\"];\n      reassign_reason = instance_from_client[\"reassign_reason\"];\n      not_in_inbox_users = _.difference(inbox_users, inbox_users_from_client);\n      new_inbox_users = _.difference(inbox_users_from_client, inbox_users);\n      if (not_in_inbox_users.length === 0 && new_inbox_users.length === 0) {\n        return;\n      }\n      setObj = new Object;\n      now = new Date;\n      i = 0;\n      approve_users_handlers = [];\n      while (i < last_trace.approves.length) {\n        if (not_in_inbox_users.includes(last_trace.approves[i].handler)) {\n          if (last_trace.approves[i].is_finished === false && last_trace.approves[i].type !== \"cc\" && last_trace.approves[i].type !== \"distribute\") {\n            last_trace.approves[i].is_finished = true;\n            last_trace.approves[i].finish_date = now;\n            last_trace.approves[i].judge = \"terminated\";\n            last_trace.approves[i].description = \"\";\n            last_trace.approves[i].cost_time = last_trace.approves[i].finish_date - last_trace.approves[i].start_date;\n            approve_users_handlers.push(last_trace.approves[i].user);\n            approve_users_handlers.push(last_trace.approves[i].handler);\n          }\n        }\n        i++;\n      }\n      current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      current_user_organization = db.organizations.findOne({\n        _id: current_space_user.organization\n      }, {\n        fields: {\n          name: 1,\n          fullname: 1\n        }\n      });\n      assignee_appr = new Object;\n      assignee_appr._id = new Mongo.ObjectID()._str;\n      assignee_appr.instance = last_trace.instance;\n      assignee_appr.trace = last_trace._id;\n      assignee_appr.is_finished = true;\n      assignee_appr.user = current_user;\n      assignee_appr.user_name = current_user_info.name;\n      assignee_appr.handler = current_user;\n      assignee_appr.handler_name = current_user_info.name;\n      assignee_appr.handler_organization = current_space_user.organization;\n      assignee_appr.handler_organization_name = current_user_organization.name;\n      assignee_appr.handler_organization_fullname = current_user_organization.fullname;\n      assignee_appr.start_date = now;\n      assignee_appr.finish_date = now;\n      assignee_appr.due_date = last_trace.due_date;\n      assignee_appr.read_date = now;\n      assignee_appr.judge = \"reassigned\";\n      assignee_appr.is_read = true;\n      assignee_appr.description = reassign_reason;\n      assignee_appr.is_error = false;\n      assignee_appr.values = new Object;\n      assignee_appr.cost_time = assignee_appr.finish_date - assignee_appr.start_date;\n      last_trace.approves.push(assignee_appr);\n      _.each(new_inbox_users, function(user_id) {\n        var agent, handler_id, handler_info, new_appr, new_user, space_user, user_organization;\n        new_user = db.users.findOne(user_id, {\n          fields: {\n            name: 1\n          }\n        });\n        space_user = uuflowManager.getSpaceUser(space_id, user_id);\n        user_organization = db.organizations.findOne(space_user.organization, {\n          fields: {\n            name: 1,\n            fullname: 1\n          }\n        });\n        new_appr = new Object;\n        new_appr._id = new Mongo.ObjectID()._str;\n        new_appr.instance = last_trace.instance;\n        new_appr.trace = last_trace._id;\n        new_appr.is_finished = false;\n        new_appr.user = user_id;\n        new_appr.user_name = new_user.name;\n        handler_id = user_id;\n        handler_info = new_user;\n        agent = uuflowManager.getAgent(space_id, user_id);\n        if (agent) {\n          inbox_users_from_client[inbox_users_from_client.indexOf(user_id)] = agent;\n          handler_id = agent;\n          handler_info = db.users.findOne({\n            _id: agent\n          }, {\n            fields: {\n              name: 1\n            }\n          });\n          new_appr.agent = agent;\n        }\n        new_appr.handler = handler_id;\n        new_appr.handler_name = handler_info.name;\n        new_appr.handler_organization = space_user.organization;\n        new_appr.handler_organization_name = user_organization.name;\n        new_appr.handler_organization_fullname = user_organization.fullname;\n        new_appr.from_user = current_user;\n        new_appr.from_user_name = current_user_info.name;\n        new_appr.type = \"reassign\";\n        new_appr.start_date = now;\n        new_appr.due_date = last_trace.due_date;\n        new_appr.is_read = false;\n        new_appr.is_error = false;\n        new_appr.values = new Object;\n        uuflowManager.setRemindInfo(instance.values, new_appr);\n        return last_trace.approves.push(new_appr);\n      });\n      instance.outbox_users.push(current_user);\n      instance.outbox_users = instance.outbox_users.concat(approve_users_handlers);\n      setObj.outbox_users = _.uniq(instance.outbox_users);\n      setObj.inbox_users = inbox_users_from_client;\n      setObj.modified = now;\n      setObj.modified_by = current_user;\n      setObj[\"traces.$.approves\"] = last_trace.approves;\n      r = db.instances.update({\n        _id: instance_id,\n        \"traces._id\": last_trace._id\n      }, {\n        $set: setObj\n      });\n      if (r) {\n        ins = uuflowManager.getInstance(instance_id);\n        pushManager.send_message_current_user(current_user_info);\n        _.each(not_in_inbox_users, function(user_id) {\n          if (user_id !== current_user) {\n            return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n          }\n        });\n        _users = new Array;\n        _users.push(ins.applicant);\n        _users.push(ins.submitter);\n        _users = _.uniq(_users.concat(ins.outbox_users));\n        _.each(_users, function(user_id) {\n          return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n        });\n        pushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, reassign_reason, current_user_info);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'reassign', current_user, ins.inbox_users);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/relocate', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\n\n\t\t\tlast_trace = _.last(instance.traces)\n\n\t\t\t# 验证login user_id对该流程有管理申请单的权限\n\t\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\n\t\t\tspace = db.spaces.findOne(instance.space, { fields: { admins: 1 } })\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user))\n\t\t\t\tthrow new Meteor.Error('error!', \"用户没有对当前流程的管理权限\")\n\n\t\t\tspace_id = instance.space\n\t\t\tinstance_id = last_trace.instance\n\t\t\tinbox_users = instance.inbox_users\n\t\t\trelocate_inbox_users = instance_from_client[\"relocate_inbox_users\"]\n\t\t\trelocate_comment = instance_from_client[\"relocate_comment\"]\n\t\t\trelocate_next_step = instance_from_client[\"relocate_next_step\"]\n\t\t\tnot_in_inbox_users = _.difference(inbox_users, relocate_inbox_users)\n\t\t\tnew_inbox_users = _.difference(relocate_inbox_users, inbox_users)\n\n\t\t\tapprove_users = []\n\n\t\t\t# 获取一个flow\n\t\t\tflow = uuflowManager.getFlow(instance.flow)\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, relocate_next_step)\n\t\t\tnext_step_type = next_step.step_type\n\t\t\tnext_step_name = next_step.name\n\t\t\tcurrent_setp = uuflowManager.getStep(instance, flow, last_trace.step)\n\t\t\tcurrent_setp_type = current_setp.step_type\n\n\t\t\ttraces = instance.traces\n\t\t\tsetObj = new Object\n\t\t\t# 重定位的时候使用approve.values合并 instance.values生成新的instance.values #1328\n\t\t\tsetObj.values = uuflowManager.getUpdatedValues(instance)\n\t\t\tnow = new Date\n\t\t\ti = 0\n\t\t\twhile i < traces.length\n\t\t\t\tif traces[i]._id is last_trace._id\n\t\t\t\t\tif not traces[i].approves\n\t\t\t\t\t\ttraces[i].approves = new Array\n\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\th = 0\n\t\t\t\t\twhile h < traces[i].approves.length\n\t\t\t\t\t\tif traces[i].approves[h].is_finished is false and traces[i].approves[h].type isnt \"cc\" and traces[i].approves[h].type isnt \"distribute\"\n\t\t\t\t\t\t\ttraces[i].approves[h].start_date = now\n\t\t\t\t\t\t\ttraces[i].approves[h].finish_date = now\n\t\t\t\t\t\t\ttraces[i].approves[h].read_date = now\n\t\t\t\t\t\t\ttraces[i].approves[h].is_error = false\n\t\t\t\t\t\t\ttraces[i].approves[h].is_read = true\n\t\t\t\t\t\t\ttraces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\ttraces[i].approves[h].judge = \"terminated\"\n\t\t\t\t\t\t\ttraces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date\n\t\t\t\t\t\t\tapprove_users.push(traces[i].approves[h].user)\n\n\t\t\t\t\t\t\t# begin 被重定位给A，再被重定位走，之前A的意见在意见栏中显示不出来了。 #1921\n\t\t\t\t\t\t\tif traces[i].approves[h].sign_show == true\n\t\t\t\t\t\t\t\tta = traces[i].approves[h]\n\t\t\t\t\t\t\t\tsameTraces = _.filter traces, (t)->\n\t\t\t\t\t\t\t\t\treturn t.step == traces[i].step\n\n\t\t\t\t\t\t\t\tl = sameTraces.length - 1\n\t\t\t\t\t\t\t\tsignShowApproveId = null\n\n\t\t\t\t\t\t\t\twhile l > -1\n\t\t\t\t\t\t\t\t\t_.each sameTraces[l].approves, (a)->\n\t\t\t\t\t\t\t\t\t\tif a.user == ta.user && a.judge != \"terminated\" && a.description && !signShowApproveId\n\t\t\t\t\t\t\t\t\t\t\tsignShowApproveId = a._id\n\t\t\t\t\t\t\t\t\tl--\n\n\t\t\t\t\t\t\t\tif signShowApproveId\n\t\t\t\t\t\t\t\t\tti = 0\n\t\t\t\t\t\t\t\t\twhile ti < traces.length\n\t\t\t\t\t\t\t\t\t\tah = 0\n\t\t\t\t\t\t\t\t\t\twhile ah < traces[ti].approves.length\n\t\t\t\t\t\t\t\t\t\t\tif traces[ti].approves[ah]._id == signShowApproveId\n\t\t\t\t\t\t\t\t\t\t\t\ttraces[ti].approves[ah].sign_show = true\n\t\t\t\t\t\t\t\t\t\t\t\ttraces[i].approves[h].sign_show = false\n\t\t\t\t\t\t\t\t\t\t\tah++\n\t\t\t\t\t\t\t\t\t\tti++\n\t\t\t\t\t\t\t# end 被重定位给A，再被重定位走，之前A的意见在意见栏中显示不出来了。 #1921\n\n\t\t\t\t\t\th++\n\n\t\t\t\t\t# 在同一trace下插入重定位操作者的approve记录\n\t\t\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\t\t\tcurrent_user_organization = db.organizations.findOne(current_space_user.organization, { fields: { name: 1 , fullname: 1 } })\n\t\t\t\t\trelocate_appr = new Object\n\t\t\t\t\trelocate_appr._id = new Mongo.ObjectID()._str\n\t\t\t\t\trelocate_appr.instance = instance_id\n\t\t\t\t\trelocate_appr.trace = traces[i]._id\n\t\t\t\t\trelocate_appr.is_finished = true\n\t\t\t\t\trelocate_appr.user = current_user\n\t\t\t\t\trelocate_appr.user_name = current_user_info.name\n\t\t\t\t\trelocate_appr.handler = current_user\n\t\t\t\t\trelocate_appr.handler_name = current_user_info.name\n\t\t\t\t\trelocate_appr.handler_organization = current_space_user.organization\n\t\t\t\t\trelocate_appr.handler_organization_name = current_user_organization.name\n\t\t\t\t\trelocate_appr.handler_organization_fullname = current_user_organization.fullname\n\t\t\t\t\trelocate_appr.start_date = now\n\t\t\t\t\trelocate_appr.finish_date = now\n\t\t\t\t\trelocate_appr.due_date = traces[i].due_date\n\t\t\t\t\trelocate_appr.read_date = now\n\t\t\t\t\trelocate_appr.judge = \"relocated\"\n\t\t\t\t\trelocate_appr.is_read = true\n\t\t\t\t\trelocate_appr.description = relocate_comment\n\t\t\t\t\trelocate_appr.is_error = false\n\t\t\t\t\trelocate_appr.values = new Object\n\t\t\t\t\trelocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date\n\t\t\t\t\ttraces[i].approves.push(relocate_appr)\n\n\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\ttraces[i].is_finished = true\n\t\t\t\t\ttraces[i].finish_date = now\n\t\t\t\t\ttraces[i].judge = \"relocated\"\n\n\t\t\t\ti++\n\n\t\t\tif next_step_type is \"end\"\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace._id]\n\t\t\t\tnewTrace.is_finished = true\n\t\t\t\tnewTrace.step = relocate_next_step\n\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\tnewTrace.start_date = now\n\t\t\t\tnewTrace.finish_date = now\n\t\t\t\tnewTrace.approves = []\n\t\t\t\t# 更新instance记录\n\t\t\t\tsetObj.state = \"completed\"\n\t\t\t\tsetObj.inbox_users = []\n\t\t\t\tsetObj.final_decision = \"terminated\"\n\t\t\t\tsetObj.finish_date = new Date\n\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\tsetObj.current_step_auto_submit = false\n\t\t\telse\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace._id]\n\t\t\t\tnewTrace.is_finished = false\n\t\t\t\tnewTrace.step = relocate_next_step\n\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\tnewTrace.start_date = now\n\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours)\n\t\t\t\tnewTrace.approves = []\n\t\t\t\t_.each(relocate_inbox_users, (next_step_user_id, idx)->\n\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\t\tnewApprove.is_finished = false\n\t\t\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\t\t\tuser_info = db.users.findOne(next_step_user_id, { fields: { name: 1 } })\n\t\t\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\thandler_info = user_info\n\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\tif agent\n\t\t\t\t\t\trelocate_inbox_users[idx] = agent\n\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\t\tnewApprove.agent = agent\n\n\t\t\t\t\tnewApprove.handler = handler_id\n\t\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\n\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\n\t\t\t\t\tnewApprove.start_date = now\n\t\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\t\tnewApprove.is_read = false\n\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\n\t\t\t\t\tnewTrace.approves.push(newApprove)\n\t\t\t\t)\n\t\t\t\tsetObj.inbox_users = relocate_inbox_users\n\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\n\t\t\tinstance.outbox_users.push(current_user)\n\t\t\tinstance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users)\n\t\t\tsetObj.outbox_users = _.uniq(instance.outbox_users)\n\t\t\tsetObj.modified = now\n\t\t\tsetObj.modified_by = current_user\n\t\t\tsetObj.is_archived = false\n\t\t\ttraces.push(newTrace)\n\t\t\tsetObj.traces = traces\n\n\t\t\tif setObj.state == 'completed'\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\n\t\t\telse\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj, $unset: {finish_date: 1}})\n\n\t\t\tif r\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\n\t\t\t\t# 给被删除的inbox_users 和 当前用户 发送push\n\t\t\t\tpushManager.send_message_current_user(current_user_info)\n\t\t\t\t_.each(not_in_inbox_users, (user_id)->\n\t\t\t\t\tif user_id isnt current_user\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t\t\t)\n\t\t\t\t# 提取instances.outbox_users数组和填单人、申请人\n\t\t\t\t_users = new Array\n\t\t\t\t_users.push(ins.applicant)\n\t\t\t\t_users.push(ins.submitter)\n\t\t\t\t_users = _.uniq(_users.concat(ins.outbox_users))\n\t\t\t\t_.each(_users, (user_id)->\n\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t\t\t)\n\n\t\t\t\t# 给新加入的inbox_users发送push message\n\t\t\t\tpushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info)\n\n\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: {}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: {errors: [{errorMessage: e.message}]}\n","JsonRoutes.add('post', '/api/workflow/relocate', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var _users, ah, approve_users, current_setp, current_setp_type, current_space_user, current_user_organization, flow, h, i, inbox_users, ins, instance, instance_id, l, last_trace, newTrace, new_inbox_users, next_step, next_step_name, next_step_type, not_in_inbox_users, now, permissions, r, relocate_appr, relocate_comment, relocate_inbox_users, relocate_next_step, sameTraces, setObj, signShowApproveId, space, space_id, ta, ti, traces;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      last_trace = _.last(instance.traces);\n      permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n      space = db.spaces.findOne(instance.space, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user))) {\n        throw new Meteor.Error('error!', \"用户没有对当前流程的管理权限\");\n      }\n      space_id = instance.space;\n      instance_id = last_trace.instance;\n      inbox_users = instance.inbox_users;\n      relocate_inbox_users = instance_from_client[\"relocate_inbox_users\"];\n      relocate_comment = instance_from_client[\"relocate_comment\"];\n      relocate_next_step = instance_from_client[\"relocate_next_step\"];\n      not_in_inbox_users = _.difference(inbox_users, relocate_inbox_users);\n      new_inbox_users = _.difference(relocate_inbox_users, inbox_users);\n      approve_users = [];\n      flow = uuflowManager.getFlow(instance.flow);\n      next_step = uuflowManager.getStep(instance, flow, relocate_next_step);\n      next_step_type = next_step.step_type;\n      next_step_name = next_step.name;\n      current_setp = uuflowManager.getStep(instance, flow, last_trace.step);\n      current_setp_type = current_setp.step_type;\n      traces = instance.traces;\n      setObj = new Object;\n      setObj.values = uuflowManager.getUpdatedValues(instance);\n      now = new Date;\n      i = 0;\n      while (i < traces.length) {\n        if (traces[i]._id === last_trace._id) {\n          if (!traces[i].approves) {\n            traces[i].approves = new Array;\n          }\n          h = 0;\n          while (h < traces[i].approves.length) {\n            if (traces[i].approves[h].is_finished === false && traces[i].approves[h].type !== \"cc\" && traces[i].approves[h].type !== \"distribute\") {\n              traces[i].approves[h].start_date = now;\n              traces[i].approves[h].finish_date = now;\n              traces[i].approves[h].read_date = now;\n              traces[i].approves[h].is_error = false;\n              traces[i].approves[h].is_read = true;\n              traces[i].approves[h].is_finished = true;\n              traces[i].approves[h].judge = \"terminated\";\n              traces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date;\n              approve_users.push(traces[i].approves[h].user);\n              if (traces[i].approves[h].sign_show === true) {\n                ta = traces[i].approves[h];\n                sameTraces = _.filter(traces, function(t) {\n                  return t.step === traces[i].step;\n                });\n                l = sameTraces.length - 1;\n                signShowApproveId = null;\n                while (l > -1) {\n                  _.each(sameTraces[l].approves, function(a) {\n                    if (a.user === ta.user && a.judge !== \"terminated\" && a.description && !signShowApproveId) {\n                      return signShowApproveId = a._id;\n                    }\n                  });\n                  l--;\n                }\n                if (signShowApproveId) {\n                  ti = 0;\n                  while (ti < traces.length) {\n                    ah = 0;\n                    while (ah < traces[ti].approves.length) {\n                      if (traces[ti].approves[ah]._id === signShowApproveId) {\n                        traces[ti].approves[ah].sign_show = true;\n                        traces[i].approves[h].sign_show = false;\n                      }\n                      ah++;\n                    }\n                    ti++;\n                  }\n                }\n              }\n            }\n            h++;\n          }\n          current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n          current_user_organization = db.organizations.findOne(current_space_user.organization, {\n            fields: {\n              name: 1,\n              fullname: 1\n            }\n          });\n          relocate_appr = new Object;\n          relocate_appr._id = new Mongo.ObjectID()._str;\n          relocate_appr.instance = instance_id;\n          relocate_appr.trace = traces[i]._id;\n          relocate_appr.is_finished = true;\n          relocate_appr.user = current_user;\n          relocate_appr.user_name = current_user_info.name;\n          relocate_appr.handler = current_user;\n          relocate_appr.handler_name = current_user_info.name;\n          relocate_appr.handler_organization = current_space_user.organization;\n          relocate_appr.handler_organization_name = current_user_organization.name;\n          relocate_appr.handler_organization_fullname = current_user_organization.fullname;\n          relocate_appr.start_date = now;\n          relocate_appr.finish_date = now;\n          relocate_appr.due_date = traces[i].due_date;\n          relocate_appr.read_date = now;\n          relocate_appr.judge = \"relocated\";\n          relocate_appr.is_read = true;\n          relocate_appr.description = relocate_comment;\n          relocate_appr.is_error = false;\n          relocate_appr.values = new Object;\n          relocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date;\n          traces[i].approves.push(relocate_appr);\n          traces[i].is_finished = true;\n          traces[i].finish_date = now;\n          traces[i].judge = \"relocated\";\n        }\n        i++;\n      }\n      if (next_step_type === \"end\") {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace._id];\n        newTrace.is_finished = true;\n        newTrace.step = relocate_next_step;\n        newTrace.name = next_step_name;\n        newTrace.start_date = now;\n        newTrace.finish_date = now;\n        newTrace.approves = [];\n        setObj.state = \"completed\";\n        setObj.inbox_users = [];\n        setObj.final_decision = \"terminated\";\n        setObj.finish_date = new Date;\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = false;\n      } else {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace._id];\n        newTrace.is_finished = false;\n        newTrace.step = relocate_next_step;\n        newTrace.name = next_step_name;\n        newTrace.start_date = now;\n        newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours);\n        newTrace.approves = [];\n        _.each(relocate_inbox_users, function(next_step_user_id, idx) {\n          var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n          newApprove = new Object;\n          newApprove._id = new Mongo.ObjectID()._str;\n          newApprove.instance = instance_id;\n          newApprove.trace = newTrace._id;\n          newApprove.is_finished = false;\n          newApprove.user = next_step_user_id;\n          user_info = db.users.findOne(next_step_user_id, {\n            fields: {\n              name: 1\n            }\n          });\n          newApprove.user_name = user_info.name;\n          handler_id = next_step_user_id;\n          handler_info = user_info;\n          agent = uuflowManager.getAgent(space_id, next_step_user_id);\n          if (agent) {\n            relocate_inbox_users[idx] = agent;\n            handler_id = agent;\n            handler_info = db.users.findOne({\n              _id: agent\n            }, {\n              fields: {\n                name: 1\n              }\n            });\n            newApprove.agent = agent;\n          }\n          newApprove.handler = handler_id;\n          newApprove.handler_name = handler_info.name;\n          next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n          next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n          newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n          newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n          newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n          newApprove.start_date = now;\n          newApprove.due_date = newTrace.due_date;\n          newApprove.is_read = false;\n          newApprove.is_error = false;\n          newApprove.values = new Object;\n          uuflowManager.setRemindInfo(instance.values, newApprove);\n          return newTrace.approves.push(newApprove);\n        });\n        setObj.inbox_users = relocate_inbox_users;\n        setObj.state = \"pending\";\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n      }\n      instance.outbox_users.push(current_user);\n      instance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users);\n      setObj.outbox_users = _.uniq(instance.outbox_users);\n      setObj.modified = now;\n      setObj.modified_by = current_user;\n      setObj.is_archived = false;\n      traces.push(newTrace);\n      setObj.traces = traces;\n      if (setObj.state === 'completed') {\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n      } else {\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj,\n          $unset: {\n            finish_date: 1\n          }\n        });\n      }\n      if (r) {\n        ins = uuflowManager.getInstance(instance_id);\n        pushManager.send_message_current_user(current_user_info);\n        _.each(not_in_inbox_users, function(user_id) {\n          if (user_id !== current_user) {\n            return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n          }\n        });\n        _users = new Array;\n        _users.push(ins.applicant);\n        _users.push(ins.submitter);\n        _users = _.uniq(_users.concat(ins.outbox_users));\n        _.each(_users, function(user_id) {\n          return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n        });\n        pushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/archive', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tinstance_id = instance_from_client[\"_id\"]\n\t\t\t# 获取一个instance\n\t\t\tinstance = uuflowManager.getInstance(instance_id)\n\t\t\tspace_id = instance.space\n\t\t\t# 获取一个space\n\t\t\tspace = uuflowManager.getSpace(space_id)\n\t\t\t# 判断一个instance是否为完成并且未归档状态\n\t\t\tuuflowManager.isInstanceFinishedAndNotArchieved(instance)\n\t\t\t# 获取一个space下的一个user\n\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\t# 判断一个用户是否是一个instance的提交者 或者space的管理员\n\t\t\tuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin(instance, current_user, space)\n\t\t\t\n\t\t\tsetObj = new Object\n\t\t\tsetObj.is_archived = true\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\n\t\t\tdb.instances.update({_id: instance_id}, {$set: setObj})\n\n\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 200\n\t\t\t\tdata: {}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n\t\n\t\t","JsonRoutes.add('post', '/api/workflow/archive', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var instance, instance_id, setObj, space, space_id, space_user;\n      instance_id = instance_from_client[\"_id\"];\n      instance = uuflowManager.getInstance(instance_id);\n      space_id = instance.space;\n      space = uuflowManager.getSpace(space_id);\n      uuflowManager.isInstanceFinishedAndNotArchieved(instance);\n      space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      uuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin(instance, current_user, space);\n      setObj = new Object;\n      setObj.is_archived = true;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      return db.instances.update({\n        _id: instance_id\n      }, {\n        $set: setObj\n      });\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","Meteor.startup ->\n\tWebApp.connectHandlers.use \"/api/workflow/export/instances\", (req, res, next) ->\n\t\ttry\n\t\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\n\t\t\tquery = req.query\n\t\t\tspace_id = query.space_id\n\t\t\tflow_id = query.flow_id\n\t\t\ttype = parseInt(query.type)\n\t\t\ttimezoneoffset = parseInt(query.timezoneoffset)\n\n\t\t\tflow = db.flows.findOne({ _id: flow_id }, { fields: { form: 1 } })\n\t\t\tform = db.forms.findOne({ _id: flow.form }, { fields: { name: 1, 'current.fields': 1 } })\n\n\t\t\tform_name = form.name\n\t\t\tfields = form.current.fields\n\t\t\ttable_fields = new Array\n\t\t\t_.each form.current.fields, (field) ->\n\t\t\t\tif field.type is \"table\"\n\t\t\t\t\ttable_fields.push(field)\n\n\t\t\tins_to_xls = new Array\n\t\t\tstart_date = null\n\t\t\tend_date = null\n\t\t\tnow = new Date\n\t\t\t# 0-本月\n\t\t\tif type is 0\n\t\t\t\tstart_date = new Date(now.getFullYear(), now.getMonth(), 1)\n\t\t\t\tins_to_xls = db.instances.find({\n\t\t\t\t\tspace: space_id,\n\t\t\t\t\tflow: flow_id,\n\t\t\t\t\tstate: { $ne: \"draft\" },\n\t\t\t\t\tsubmit_date: { $gte: start_date }\n\t\t\t\t}, {\n\t\t\t\t\tsort: { submit_date: 1 }\n\t\t\t\t}).fetch()\n\t\t\t# 1-上月\n\t\t\telse if type is 1\n\t\t\t\tlast_month_date = new Date(new Date(now.getFullYear(), now.getMonth(), 1) - 1000 * 60 * 60 * 24)\n\t\t\t\tstart_date = new Date(last_month_date.getFullYear(), last_month_date.getMonth(), 1)\n\t\t\t\tend_date = new Date(now.getFullYear(), now.getMonth(), 1)\n\t\t\t\tins_to_xls = db.instances.find({\n\t\t\t\t\tspace: space_id,\n\t\t\t\t\tflow: flow_id,\n\t\t\t\t\tstate: { $ne: \"draft\" },\n\t\t\t\t\t$and: [{ submit_date: { $gte: start_date } }, { submit_date: { $lte: end_date } }]\n\t\t\t\t}, {\n\t\t\t\t\tsort: { submit_date: 1 }\n\t\t\t\t}).fetch()\n\t\t\t# 2-整个年度\n\t\t\telse if type is 2\n\t\t\t\tstart_date = new Date(now.getFullYear(), 0, 1)\n\t\t\t\tins_to_xls = db.instances.find({\n\t\t\t\t\tspace: space_id,\n\t\t\t\t\tflow: flow_id,\n\t\t\t\t\tstate: { $ne: \"draft\" },\n\t\t\t\t\tsubmit_date: { $gte: start_date }\n\t\t\t\t}, {\n\t\t\t\t\tsort: { submit_date: 1 }\n\t\t\t\t}).fetch()\n\t\t\t# 3-所有\n\t\t\telse if type is 3\n\t\t\t\tins_to_xls = db.instances.find({\n\t\t\t\t\tspace: space_id,\n\t\t\t\t\tflow: flow_id,\n\t\t\t\t\tstate: { $ne: \"draft\" }\n\t\t\t\t}, {\n\t\t\t\t\tsort: { submit_date: 1 }\n\t\t\t\t}).fetch()\n\n\t\t\tejs = require('ejs')\n\t\t\tstr = Assets.getText('server/ejs/export_instances.ejs')\n\n\t\t\t# 检测是否有语法错误\n\t\t\tejsLint = require('ejs-lint')\n\t\t\terror_obj = ejsLint.lint(str, {})\n\t\t\tif error_obj\n\t\t\t\tconsole.error \"===/api/workflow/export:\"\n\t\t\t\tconsole.error error_obj\n\n\t\t\ttemplate = ejs.compile(str)\n\n\t\t\tlang = 'en'\n\t\t\tif current_user_info.locale is 'zh-cn'\n\t\t\t\tlang = 'zh-CN'\n\n\t\t\tret = template({\n\t\t\t\tlang: lang,\n\t\t\t\ttimezoneoffset: timezoneoffset,\n\t\t\t\tform_name: form_name,\n\t\t\t\tfields: fields,\n\t\t\t\ttable_fields: table_fields,\n\t\t\t\tins_to_xls: ins_to_xls\n\t\t\t})\n\n\t\t\tfileName = \"SteedOSWorkflow_\" + moment().format('YYYYMMDDHHmm') + \".xls\"\n\t\t\tres.setHeader(\"Content-type\", \"application/octet-stream\")\n\t\t\tres.setHeader(\"Content-Disposition\", \"attachment;filename=\" + encodeURI(fileName))\n\t\t\tres.end(ret)\n\t\tcatch e\n\t\t\tconsole.error e.stack\n\t\t\tres.end(e.message)","Meteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/instances\", function(req, res, next) {\n    var current_user_info, e, ejs, ejsLint, end_date, error_obj, fields, fileName, flow, flow_id, form, form_name, ins_to_xls, lang, last_month_date, now, query, ret, space_id, start_date, str, table_fields, template, timezoneoffset, type;\n    try {\n      current_user_info = uuflowManager.check_authorization(req);\n      query = req.query;\n      space_id = query.space_id;\n      flow_id = query.flow_id;\n      type = parseInt(query.type);\n      timezoneoffset = parseInt(query.timezoneoffset);\n      flow = db.flows.findOne({\n        _id: flow_id\n      }, {\n        fields: {\n          form: 1\n        }\n      });\n      form = db.forms.findOne({\n        _id: flow.form\n      }, {\n        fields: {\n          name: 1,\n          'current.fields': 1\n        }\n      });\n      form_name = form.name;\n      fields = form.current.fields;\n      table_fields = new Array;\n      _.each(form.current.fields, function(field) {\n        if (field.type === \"table\") {\n          return table_fields.push(field);\n        }\n      });\n      ins_to_xls = new Array;\n      start_date = null;\n      end_date = null;\n      now = new Date;\n      if (type === 0) {\n        start_date = new Date(now.getFullYear(), now.getMonth(), 1);\n        ins_to_xls = db.instances.find({\n          space: space_id,\n          flow: flow_id,\n          state: {\n            $ne: \"draft\"\n          },\n          submit_date: {\n            $gte: start_date\n          }\n        }, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 1) {\n        last_month_date = new Date(new Date(now.getFullYear(), now.getMonth(), 1) - 1000 * 60 * 60 * 24);\n        start_date = new Date(last_month_date.getFullYear(), last_month_date.getMonth(), 1);\n        end_date = new Date(now.getFullYear(), now.getMonth(), 1);\n        ins_to_xls = db.instances.find({\n          space: space_id,\n          flow: flow_id,\n          state: {\n            $ne: \"draft\"\n          },\n          $and: [\n            {\n              submit_date: {\n                $gte: start_date\n              }\n            }, {\n              submit_date: {\n                $lte: end_date\n              }\n            }\n          ]\n        }, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 2) {\n        start_date = new Date(now.getFullYear(), 0, 1);\n        ins_to_xls = db.instances.find({\n          space: space_id,\n          flow: flow_id,\n          state: {\n            $ne: \"draft\"\n          },\n          submit_date: {\n            $gte: start_date\n          }\n        }, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      } else if (type === 3) {\n        ins_to_xls = db.instances.find({\n          space: space_id,\n          flow: flow_id,\n          state: {\n            $ne: \"draft\"\n          }\n        }, {\n          sort: {\n            submit_date: 1\n          }\n        }).fetch();\n      }\n      ejs = require('ejs');\n      str = Assets.getText('server/ejs/export_instances.ejs');\n      ejsLint = require('ejs-lint');\n      error_obj = ejsLint.lint(str, {});\n      if (error_obj) {\n        console.error(\"===/api/workflow/export:\");\n        console.error(error_obj);\n      }\n      template = ejs.compile(str);\n      lang = 'en';\n      if (current_user_info.locale === 'zh-cn') {\n        lang = 'zh-CN';\n      }\n      ret = template({\n        lang: lang,\n        timezoneoffset: timezoneoffset,\n        form_name: form_name,\n        fields: fields,\n        table_fields: table_fields,\n        ins_to_xls: ins_to_xls\n      });\n      fileName = \"SteedOSWorkflow_\" + moment().format('YYYYMMDDHHmm') + \".xls\";\n      res.setHeader(\"Content-type\", \"application/octet-stream\");\n      res.setHeader(\"Content-Disposition\", \"attachment;filename=\" + encodeURI(fileName));\n      return res.end(ret);\n    } catch (error) {\n      e = error;\n      console.error(e.stack);\n      return res.end(e.message);\n    }\n  });\n});\n","JsonRoutes.add 'get', '/uf/space/changeset', (req, res, next) ->\n\ttry\n\t\tquery = req.query\n\t\tauth_token = db.auth_tokens.findOne({auth_token: query.auth_token})\n\n\t\tif (not auth_token) or (not auth_token.enabled)\n\t\t\tthrow new Meteor.Error 401, 'Unauthorized'\n\n\t\tsync_token = query[\"sync_token\"]\n\t\tformids = query[\"formids\"] # 逗号隔开字符串\n\t\tis_admin = query[\"is_admin\"]\n\n\t\tdata = uuflowManager.get_SpaceChangeSet(formids, is_admin, sync_token)\n\n\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 200\n\t\t\t\tdata: data\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }","JsonRoutes.add('get', '/uf/space/changeset', function(req, res, next) {\n  var auth_token, data, e, formids, is_admin, query, sync_token;\n  try {\n    query = req.query;\n    auth_token = db.auth_tokens.findOne({\n      auth_token: query.auth_token\n    });\n    if ((!auth_token) || (!auth_token.enabled)) {\n      throw new Meteor.Error(401, 'Unauthorized');\n    }\n    sync_token = query[\"sync_token\"];\n    formids = query[\"formids\"];\n    is_admin = query[\"is_admin\"];\n    data = uuflowManager.get_SpaceChangeSet(formids, is_admin, sync_token);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: data\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add 'post', '/api/workflow/retrieve', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req)\n\t\tcurrent_user = current_user_info._id\n\n\t\thashData = req.body\n\t\t_.each hashData['Instances'], (instance_from_client) ->\n\t\t\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\n\t\t\tretrieve_comment = instance_from_client['retrieve_comment']\n\n\t\t\t# 验证instance为审核中状态\n\t\t\t# uuflowManager.isInstancePending(instance)\n\t\t\t# 校验申请单是当前用户已审核过的单子或者当前用户是提交人或申请人\n\t\t\tif (not instance.outbox_users.includes(current_user)) and (instance.submitter isnt current_user and instance.applicant isnt current_user)\n\t\t\t\tthrow new Meteor.Error('error', '当前用户不符合取回条件')\n\n\t\t\tretrieve_type = \"\"\n\n\t\t\ttraces = instance.traces\n\n\t\t\t#获取最新的trace， 即取回步骤\n\t\t\tlast_trace = _.last(traces)\n\t\t\tlast_trace_id = last_trace._id\n\t\t\tprevious_trace_id = last_trace.previous_trace_ids[0];\n\t\t\tprevious_trace = _.find(traces, (t)->\n\t\t\t\treturn t._id is previous_trace_id\n\t\t\t)\n\t\t\tprevious_trace_step_id = previous_trace.step\n\t\t\tprevious_trace_name = previous_trace.name\n\t\t\tflow = uuflowManager.getFlow(instance.flow)\n\t\t\tprevious_step = uuflowManager.getStep(instance, flow, previous_trace_step_id)\n\t\t\tif previous_step.step_type is \"counterSign\"\n\t\t\t\tthrow new Meteor.Error('error', '会签不能取回')\n\n\t\t\t# 取回步骤的前一个步骤处理人唯一（即排除掉传阅和转发的approve后，剩余的approve只有一个）并且是当前用户\n\t\t\tprevious_trace_approves = _.filter previous_trace.approves, (a)->\n\t\t\t\treturn a.type isnt 'cc' and a.type isnt 'distribute' and a.type isnt 'forward' and ['approved','submitted','rejected'].includes(a.judge)\n\n\t\t\tif previous_trace_approves.length is 1 and (previous_trace_approves[0].user is current_user or previous_trace_approves[0].handler is current_user)\n\t\t\t\tretrieve_type = 'normal' # 申请单正常流转的取回，即非传阅取回\n\n\t\t\ti = traces.length\n\t\t\tretrieve_approve = {}\n\t\t\twhile i > 0\n\t\t\t\t_.each traces[i-1].approves, (a)->\n\t\t\t\t\tif a.type is 'cc' and a.is_finished is true and a.user is current_user\n\t\t\t\t\t\tretrieve_type = 'cc'\n\t\t\t\t\t\tretrieve_approve = a\n\n\t\t\t\tif retrieve_type is 'cc'\n\t\t\t\t\tbreak\n\n\t\t\t\ti--\n\n\n\t\t\tif retrieve_type is 'normal'\n\t\t\t\t# 获取一个flow\n\t\t\t\tflow = uuflowManager.getFlow(instance.flow)\n\t\t\t\tprevious_step = uuflowManager.getStep(instance, flow, previous_trace_step_id)\n\t\t\t\tspace_id = instance.space\n\t\t\t\tinstance_id = instance._id\n\t\t\t\told_inbox_users = instance.inbox_users\n\t\t\t\tsetObj = new Object\n\t\t\t\tnow = new Date\n\t\t\t\t_.each traces, (t)->\n\t\t\t\t\tif t._id is last_trace_id\n\t\t\t\t\t\tif not t.approves\n\t\t\t\t\t\t\tt.approves = new Array\n\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t_.each t.approves, (appr)->\n\t\t\t\t\t\t\tif appr.is_finished == false and appr.type isnt \"cc\"\n\t\t\t\t\t\t\t\tappr.start_date = now\n\t\t\t\t\t\t\t\tappr.finish_date = now\n\t\t\t\t\t\t\t\tappr.read_date = now\n\t\t\t\t\t\t\t\tappr.is_error = false\n\t\t\t\t\t\t\t\tappr.is_read = true\n\t\t\t\t\t\t\t\tappr.is_finished = true\n\t\t\t\t\t\t\t\tappr.judge = \"terminated\"\n\t\t\t\t\t\t\t\tappr.cost_time = appr.finish_date - appr.start_date\n\t\t\t\t\t\t# 在同一trace下插入取回操作者的approve记录\n\t\t\t\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\t\t\t\tcurrent_user_organization = db.organizations.findOne(current_space_user.organization, { fields: { name: 1, fullname: 1 } })\n\t\t\t\t\t\tretrieve_appr = new Object\n\t\t\t\t\t\tretrieve_appr._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\tretrieve_appr.instance = instance_id\n\t\t\t\t\t\tretrieve_appr.trace = t._id\n\t\t\t\t\t\tretrieve_appr.is_finished = true\n\t\t\t\t\t\tretrieve_appr.user = current_user\n\t\t\t\t\t\tretrieve_appr.user_name = current_user_info.name\n\t\t\t\t\t\tretrieve_appr.handler = current_user\n\t\t\t\t\t\tretrieve_appr.handler_name = current_user_info.name\n\t\t\t\t\t\tretrieve_appr.handler_organization = current_space_user.organization\n\t\t\t\t\t\tretrieve_appr.handler_organization_name = current_user_organization.name\n\t\t\t\t\t\tretrieve_appr.handler_organization_fullname = current_user_organization.fullname\n\t\t\t\t\t\tretrieve_appr.start_date = now\n\t\t\t\t\t\tretrieve_appr.finish_date = now\n\t\t\t\t\t\tretrieve_appr.due_date = t.due_date\n\t\t\t\t\t\tretrieve_appr.read_date = now\n\t\t\t\t\t\tretrieve_appr.judge = \"retrieved\"\n\t\t\t\t\t\tretrieve_appr.is_read = true\n\t\t\t\t\t\tretrieve_appr.description = retrieve_comment\n\t\t\t\t\t\tretrieve_appr.is_error = false\n\t\t\t\t\t\tretrieve_appr.values = new Object\n\t\t\t\t\t\tretrieve_appr.cost_time = retrieve_appr.finish_date - retrieve_appr.start_date\n\t\t\t\t\t\tt.approves.push(retrieve_appr)\n\n\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\tt.is_finished = true\n\t\t\t\t\t\tt.finish_date = now\n\t\t\t\t\t\tt.judge = \"retrieved\"\n\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [last_trace_id]\n\t\t\t\tnewTrace.is_finished = false\n\t\t\t\tnewTrace.step = previous_trace_step_id\n\t\t\t\tnewTrace.name = previous_trace_name\n\t\t\t\tnewTrace.start_date = now\n\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(previous_step.timeout_hours)\n\t\t\t\tnewTrace.approves = []\n\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\tnewApprove = new Object\n\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\tnewApprove.is_finished = false\n\t\t\t\tnewApprove.user = current_user\n\n\t\t\t\thandler_info = db.users.findOne(current_user, { fields: { name: 1 } })\n\t\t\t\tnewApprove.user_name = handler_info.name\n\t\t\t\tnewApprove.handler = current_user\n\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\torg_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t\t\t\tnewApprove.handler_organization = org_info[\"organization\"]\n\t\t\t\tnewApprove.handler_organization_name = org_info[\"organization_name\"]\n\t\t\t\tnewApprove.handler_organization_fullname = org_info[\"organization_fullname\"]\n\n\t\t\t\tnewApprove.start_date = now\n\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\tnewApprove.is_read = false\n\t\t\t\tnewApprove.is_error = false\n\t\t\t\tnewApprove.values = new Object\n\n\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\n\n\t\t\t\tnewTrace.approves.push(newApprove)\n\t\t\t\tsetObj.inbox_users = [current_user]\n\n\t\t\t\tsetObj.modified = now\n\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\ttraces.push(newTrace)\n\t\t\t\tsetObj.traces = traces\n\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\tsetObj.is_archived = false\n\n\t\t\t\tsetObj.current_step_name = previous_trace_name\n\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, previous_step.lines)\n\n\t\t\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\n\t\t\t\tif r\n\t\t\t\t\t# 给被删除的inbox_users 和 当前用户 发送push\n\t\t\t\t\tpushManager.send_message_current_user(current_user_info)\n\t\t\t\t\t_.each(old_inbox_users, (user_id)->\n\t\t\t\t\t\tif user_id isnt current_user\n\t\t\t\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t\t\t\t)\n\n\t\t\t\t\tins = uuflowManager.getInstance(instance_id)\n\t\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, ins.inbox_users)\n\n\t\t\telse if retrieve_type is 'cc'\n\t\t\t\tsetObj = new Object\n\t\t\t\tnow = new Date\n\t\t\t\tinstance_id = instance._id\n\t\t\t\tthe_trace = _.find traces, (t)->\n\t\t\t\t\treturn t._id is retrieve_approve.trace\n\n\t\t\t\t_.each the_trace.approves, (a)->\n\t\t\t\t\tif a._id is retrieve_approve._id\n\t\t\t\t\t\ta.is_finished = false\n\t\t\t\t\t\ta.finish_date = undefined\n\t\t\t\t\t\ta.judge = undefined\n\t\t\t\t\t\ta.cost_time = undefined\n\n\t\t\t\tcc_users = instance.cc_users\n\t\t\t\tcc_users.push(current_user)\n\n\t\t\t\tsetObj.modified = now\n\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\tsetObj.is_archived = false\n\t\t\t\tsetObj.cc_users = cc_users\n\t\t\t\tsetObj['traces.$.approves'] = the_trace.approves\n\n\t\t\t\tr = db.instances.update({_id: instance_id, 'traces._id': retrieve_approve.trace}, {$set: setObj})\n\t\t\t\tif r\n\t\t\t\t\tpushManager.send_message_current_user(current_user_info)\n\n\t\t\t\tins = uuflowManager.getInstance(instance_id)\n\t\t\t\t# 如果已经配置webhook并已激活则触发\n\t\t\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, [current_user])\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: {}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: {errors: [{errorMessage: e.message}]}\n","JsonRoutes.add('post', '/api/workflow/retrieve', function(req, res, next) {\n  var current_user, current_user_info, e, hashData;\n  try {\n    current_user_info = uuflowManager.check_authorization(req);\n    current_user = current_user_info._id;\n    hashData = req.body;\n    _.each(hashData['Instances'], function(instance_from_client) {\n      var cc_users, flow, handler_info, i, ins, instance, instance_id, last_trace, last_trace_id, newApprove, newTrace, now, old_inbox_users, org_info, previous_step, previous_trace, previous_trace_approves, previous_trace_id, previous_trace_name, previous_trace_step_id, r, retrieve_approve, retrieve_comment, retrieve_type, setObj, space_id, space_user, the_trace, traces;\n      instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n      retrieve_comment = instance_from_client['retrieve_comment'];\n      if ((!instance.outbox_users.includes(current_user)) && (instance.submitter !== current_user && instance.applicant !== current_user)) {\n        throw new Meteor.Error('error', '当前用户不符合取回条件');\n      }\n      retrieve_type = \"\";\n      traces = instance.traces;\n      last_trace = _.last(traces);\n      last_trace_id = last_trace._id;\n      previous_trace_id = last_trace.previous_trace_ids[0];\n      previous_trace = _.find(traces, function(t) {\n        return t._id === previous_trace_id;\n      });\n      previous_trace_step_id = previous_trace.step;\n      previous_trace_name = previous_trace.name;\n      flow = uuflowManager.getFlow(instance.flow);\n      previous_step = uuflowManager.getStep(instance, flow, previous_trace_step_id);\n      if (previous_step.step_type === \"counterSign\") {\n        throw new Meteor.Error('error', '会签不能取回');\n      }\n      previous_trace_approves = _.filter(previous_trace.approves, function(a) {\n        return a.type !== 'cc' && a.type !== 'distribute' && a.type !== 'forward' && ['approved', 'submitted', 'rejected'].includes(a.judge);\n      });\n      if (previous_trace_approves.length === 1 && (previous_trace_approves[0].user === current_user || previous_trace_approves[0].handler === current_user)) {\n        retrieve_type = 'normal';\n      }\n      i = traces.length;\n      retrieve_approve = {};\n      while (i > 0) {\n        _.each(traces[i - 1].approves, function(a) {\n          if (a.type === 'cc' && a.is_finished === true && a.user === current_user) {\n            retrieve_type = 'cc';\n            return retrieve_approve = a;\n          }\n        });\n        if (retrieve_type === 'cc') {\n          break;\n        }\n        i--;\n      }\n      if (retrieve_type === 'normal') {\n        flow = uuflowManager.getFlow(instance.flow);\n        previous_step = uuflowManager.getStep(instance, flow, previous_trace_step_id);\n        space_id = instance.space;\n        instance_id = instance._id;\n        old_inbox_users = instance.inbox_users;\n        setObj = new Object;\n        now = new Date;\n        _.each(traces, function(t) {\n          var current_space_user, current_user_organization, retrieve_appr;\n          if (t._id === last_trace_id) {\n            if (!t.approves) {\n              t.approves = new Array;\n            }\n            _.each(t.approves, function(appr) {\n              if (appr.is_finished === false && appr.type !== \"cc\") {\n                appr.start_date = now;\n                appr.finish_date = now;\n                appr.read_date = now;\n                appr.is_error = false;\n                appr.is_read = true;\n                appr.is_finished = true;\n                appr.judge = \"terminated\";\n                return appr.cost_time = appr.finish_date - appr.start_date;\n              }\n            });\n            current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n            current_user_organization = db.organizations.findOne(current_space_user.organization, {\n              fields: {\n                name: 1,\n                fullname: 1\n              }\n            });\n            retrieve_appr = new Object;\n            retrieve_appr._id = new Mongo.ObjectID()._str;\n            retrieve_appr.instance = instance_id;\n            retrieve_appr.trace = t._id;\n            retrieve_appr.is_finished = true;\n            retrieve_appr.user = current_user;\n            retrieve_appr.user_name = current_user_info.name;\n            retrieve_appr.handler = current_user;\n            retrieve_appr.handler_name = current_user_info.name;\n            retrieve_appr.handler_organization = current_space_user.organization;\n            retrieve_appr.handler_organization_name = current_user_organization.name;\n            retrieve_appr.handler_organization_fullname = current_user_organization.fullname;\n            retrieve_appr.start_date = now;\n            retrieve_appr.finish_date = now;\n            retrieve_appr.due_date = t.due_date;\n            retrieve_appr.read_date = now;\n            retrieve_appr.judge = \"retrieved\";\n            retrieve_appr.is_read = true;\n            retrieve_appr.description = retrieve_comment;\n            retrieve_appr.is_error = false;\n            retrieve_appr.values = new Object;\n            retrieve_appr.cost_time = retrieve_appr.finish_date - retrieve_appr.start_date;\n            t.approves.push(retrieve_appr);\n            t.is_finished = true;\n            t.finish_date = now;\n            return t.judge = \"retrieved\";\n          }\n        });\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [last_trace_id];\n        newTrace.is_finished = false;\n        newTrace.step = previous_trace_step_id;\n        newTrace.name = previous_trace_name;\n        newTrace.start_date = now;\n        newTrace.due_date = uuflowManager.getDueDate(previous_step.timeout_hours);\n        newTrace.approves = [];\n        newApprove = new Object;\n        newApprove._id = new Mongo.ObjectID()._str;\n        newApprove.instance = instance_id;\n        newApprove.trace = newTrace._id;\n        newApprove.is_finished = false;\n        newApprove.user = current_user;\n        handler_info = db.users.findOne(current_user, {\n          fields: {\n            name: 1\n          }\n        });\n        newApprove.user_name = handler_info.name;\n        newApprove.handler = current_user;\n        newApprove.handler_name = handler_info.name;\n        space_user = uuflowManager.getSpaceUser(space_id, current_user);\n        org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n        newApprove.handler_organization = org_info[\"organization\"];\n        newApprove.handler_organization_name = org_info[\"organization_name\"];\n        newApprove.handler_organization_fullname = org_info[\"organization_fullname\"];\n        newApprove.start_date = now;\n        newApprove.due_date = newTrace.due_date;\n        newApprove.is_read = false;\n        newApprove.is_error = false;\n        newApprove.values = new Object;\n        uuflowManager.setRemindInfo(instance.values, newApprove);\n        newTrace.approves.push(newApprove);\n        setObj.inbox_users = [current_user];\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        traces.push(newTrace);\n        setObj.traces = traces;\n        setObj.state = \"pending\";\n        setObj.is_archived = false;\n        setObj.current_step_name = previous_trace_name;\n        setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, previous_step.lines);\n        r = db.instances.update({\n          _id: instance_id\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          pushManager.send_message_current_user(current_user_info);\n          _.each(old_inbox_users, function(user_id) {\n            if (user_id !== current_user) {\n              return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n            }\n          });\n          ins = uuflowManager.getInstance(instance_id);\n          return pushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, ins.inbox_users);\n        }\n      } else if (retrieve_type === 'cc') {\n        setObj = new Object;\n        now = new Date;\n        instance_id = instance._id;\n        the_trace = _.find(traces, function(t) {\n          return t._id === retrieve_approve.trace;\n        });\n        _.each(the_trace.approves, function(a) {\n          if (a._id === retrieve_approve._id) {\n            a.is_finished = false;\n            a.finish_date = void 0;\n            a.judge = void 0;\n            return a.cost_time = void 0;\n          }\n        });\n        cc_users = instance.cc_users;\n        cc_users.push(current_user);\n        setObj.modified = now;\n        setObj.modified_by = current_user;\n        setObj.state = \"pending\";\n        setObj.is_archived = false;\n        setObj.cc_users = cc_users;\n        setObj['traces.$.approves'] = the_trace.approves;\n        r = db.instances.update({\n          _id: instance_id,\n          'traces._id': retrieve_approve.trace\n        }, {\n          $set: setObj\n        });\n        if (r) {\n          pushManager.send_message_current_user(current_user_info);\n        }\n        ins = uuflowManager.getInstance(instance_id);\n        return pushManager.triggerWebhook(ins.flow, ins, {}, 'retrieve', current_user, [current_user]);\n      }\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {}\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add('post', '/api/workflow/forward', function (req, res, next) {\n\ttry {\n\t\tvar current_user_info = uuflowManager.check_authorization(req);\n\t\tvar current_user_id = current_user_info._id;\n\n\t\tvar hashData = req.body;\n\t\tvar instance_id = hashData.instance_id;\n\t\tvar space_id = hashData.space_id;\n\t\tvar flow_id = hashData.flow_id;\n\t\tvar hasSaveInstanceToAttachment = hashData.hasSaveInstanceToAttachment;\n\t\tvar description = hashData.description;\n\t\tvar isForwardAttachments = hashData.isForwardAttachments;\n\t\tvar selectedUsers = hashData.selectedUsers;\n\t\tvar action_type = hashData.action_type;\n\t\tvar related = hashData.related;\n\t\tvar from_approve_id = hashData.from_approve_id;\n\n\t\tcheck(instance_id, String);\n\t\tcheck(space_id, String);\n\t\tcheck(flow_id, String);\n\t\tcheck(hasSaveInstanceToAttachment, Boolean);\n\t\tcheck(description, String);\n\t\tcheck(isForwardAttachments, Boolean);\n\t\tcheck(selectedUsers, Array);\n\t\tcheck(action_type, Match.OneOf('forward', 'distribute'));\n\n\t\tif (action_type == \"distribute\")\n\t\t\tcheck(from_approve_id, String);\n\n\t\tvar ins = db.instances.findOne(instance_id);\n\t\tvar old_space_id = ins.space;\n\n\t\tvar flow = db.flows.findOne(flow_id);\n\n\t\tvar space = db.spaces.findOne(space_id);\n\n\t\tif (!ins || !flow || !space) {\n\t\t\tthrow new Meteor.Error('params error!', 'record not exists!');\n\t\t}\n\n\t\tvar forward_users = new Array;\n\t\tif (_.isEmpty(selectedUsers)) {\n\t\t\tforward_users = [current_user_id];\n\t\t} else {\n\t\t\tforward_users = selectedUsers;\n\t\t}\n\n\t\t// 校验分发对象是否有分发流程的提交权限\n\t\tvar no_permission_user_ids = new Array();\n\t\t_.each(forward_users, function (uid) {\n\t\t\tvar permissions = permissionManager.getFlowPermissions(flow_id, uid);\n\t\t\tif (!permissions.includes(\"add\")) {\n\t\t\t\t// throw new Meteor.Error('error!', \"该申请人没有提交此申请单的权限。\")\n\t\t\t\tno_permission_user_ids.push(uid);\n\t\t\t}\n\t\t})\n\t\tif (!_.isEmpty(no_permission_user_ids)) {\n\t\t\tvar no_permission_users_name = new Array();\n\t\t\tdb.users.find({\n\t\t\t\t_id: {\n\t\t\t\t\t$in: no_permission_user_ids\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1\n\t\t\t\t}\n\t\t\t}).forEach(function (u) {\n\t\t\t\tno_permission_users_name.push(u.name);\n\t\t\t});\n\t\t\tthrow new Meteor.Error('no_permission', \"该提交人没有提交此申请单的权限。\", no_permission_users_name.join(','))\n\t\t}\n\n\t\tvar new_ins_ids = new Array;\n\n\t\tvar current_trace = null;\n\t\tif (action_type == \"distribute\") {\n\t\t\t_.each(ins.traces, function (t) {\n\t\t\t\tif (!current_trace) {\n\t\t\t\t\t_.each(t.approves, function (a) {\n\t\t\t\t\t\tif (!current_trace) {\n\t\t\t\t\t\t\tif (a._id == from_approve_id)\n\t\t\t\t\t\t\t\tcurrent_trace = t;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t} else {\n\t\t\tcurrent_trace = _.last(ins.traces);\n\t\t}\n\t\tvar current_trace_id = current_trace._id;\n\t\tvar forward_approves = [];\n\t\tvar from_user_name = db.users.findOne(current_user_id, {\n\t\t\tfields: {\n\t\t\t\tname: 1\n\t\t\t}\n\t\t}).name\n\t\tvar set_obj = new Object;\n\n\t\t// 计算values\n\t\tvar old_values = ins.values,\n\t\t\tnew_values = {};\n\t\tvar form = db.forms.findOne(flow.form);\n\t\tvar fields = form.current.fields || [];\n\n\t\tvar old_form = db.forms.findOne(ins.form);\n\t\tvar old_form_version = ins.form_version,\n\t\t\told_fields = [],\n\t\t\tcommon_fields = [];\n\n\t\tvar select_to_input_fields = [];\n\n\t\tif (old_form.current._id == old_form_version) {\n\t\t\told_fields = old_form.current.fields;\n\t\t} else {\n\t\t\tif (old_form.historys) {\n\t\t\t\told_form.historys.forEach(function (h) {\n\t\t\t\t\tif (h._id == old_form_version)\n\t\t\t\t\t\told_fields = h.fields;\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\t\tfields.forEach(function (field) {\n\t\t\tvar exists_field = _.find(old_fields, function (f) {\n\t\t\t\treturn f.type == field.type && f.code == field.code;\n\t\t\t})\n\t\t\tif (exists_field)\n\t\t\t\tcommon_fields.push(field);\n\t\t\tvar select_input_field = _.find(old_fields, function (f) {\n\t\t\t\treturn f.type == 'select' && field.type == 'input' && f.code == field.code;\n\t\t\t})\n\t\t\tif (select_input_field)\n\t\t\t\tselect_to_input_fields.push(select_input_field);\n\t\t})\n\n\t\tselect_to_input_fields.forEach(function (field) {\n\t\t\tif (old_values[field.code]) {\n\t\t\t\tnew_values[field.code] = old_values[field.code];\n\t\t\t}\n\t\t})\n\n\t\tcommon_fields.forEach(function (field) {\n\t\t\tif (field.type == 'section') {\n\t\t\t\tif (field.fields) {\n\t\t\t\t\tfield.fields.forEach(function (f) {\n\t\t\t\t\t\t// 跨工作区转发不复制选人选组\n\t\t\t\t\t\tif (['group', 'user'].includes(f.type) && old_space_id != space_id) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar key = f.code;\n\t\t\t\t\t\tvar old_v = old_values[key];\n\t\t\t\t\t\tif (old_v) {\n\t\t\t\t\t\t\t// 校验 单选，多选，下拉框 字段值是否在新表单对应字段的可选值范围内\n\t\t\t\t\t\t\tif (f.type == 'select' || f.type == 'radio') {\n\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\n\t\t\t\t\t\t\t\tif (!options.includes(old_v))\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (f.type == 'multiSelect') {\n\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\n\t\t\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\n\t\t\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\n\t\t\t\t\t\t\t\told_v = new_multiSelected.join(',');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tnew_values[key] = old_v;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t} else if (field.type == 'table') {\n\t\t\t\tif (!_.isEmpty(old_values[field.code])) {\n\t\t\t\t\tnew_values[field.code] = new Array;\n\t\t\t\t\told_values[field.code].forEach(function (old_table_row_values) {\n\t\t\t\t\t\tvar new_table_row_values = {};\n\n\t\t\t\t\t\tif (!_.isEmpty(field.fields)) {\n\t\t\t\t\t\t\tfield.fields.forEach(function (f) {\n\t\t\t\t\t\t\t\t// 跨工作区转发不复制选人选组\n\t\t\t\t\t\t\t\tif (['group', 'user'].includes(f.type) && old_space_id != space_id) {\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tvar key = f.code;\n\t\t\t\t\t\t\t\tvar old_v = old_table_row_values[key];\n\t\t\t\t\t\t\t\tif (old_v) {\n\t\t\t\t\t\t\t\t\t// 校验 单选，多选，下拉框 字段值是否在新表单对应字段的可选值范围内\n\t\t\t\t\t\t\t\t\tif (f.type == 'select' || f.type == 'radio') {\n\t\t\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\n\t\t\t\t\t\t\t\t\t\tif (!options.includes(old_v))\n\t\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif (f.type == 'multiSelect') {\n\t\t\t\t\t\t\t\t\t\tvar options = f.options.split('\\n');\n\t\t\t\t\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\n\t\t\t\t\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\n\t\t\t\t\t\t\t\t\t\told_v = new_multiSelected.join(',');\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tnew_table_row_values[key] = old_v;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!_.isEmpty(new_table_row_values)) {\n\t\t\t\t\t\t\tnew_values[field.code].push(new_table_row_values);\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// 跨工作区转发不复制选人选组\n\t\t\t\tif (['group', 'user'].includes(field.type) && old_space_id != space_id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar key = field.code;\n\t\t\t\tvar old_v = old_values[key];\n\t\t\t\tif (old_v) {\n\t\t\t\t\t// 校验 单选，多选，下拉框 字段值是否在新表单对应字段的可选值范围内\n\t\t\t\t\tif (field.type == 'select' || field.type == 'radio') {\n\t\t\t\t\t\tvar options = field.options.split('\\n');\n\t\t\t\t\t\tif (!options.includes(old_v))\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (field.type == 'multiSelect') {\n\t\t\t\t\t\tvar options = field.options.split('\\n');\n\t\t\t\t\t\tvar old_multiSelected = old_v.split(',');\n\t\t\t\t\t\tvar new_multiSelected = _.intersection(options, old_multiSelected);\n\t\t\t\t\t\told_v = new_multiSelected.join(',');\n\t\t\t\t\t}\n\n\t\t\t\t\tnew_values[key] = old_v;\n\t\t\t\t}\n\t\t\t}\n\n\t\t})\n\n\t\t//如果是分发，则value中的record_need、FONDSID不需要分发到新申请单中\n\t\tif (action_type === 'distribute') {\n\t\t\tdelete new_values.record_need;\n\t\t\tdelete new_values.FONDSID;\n\t\t}\n\n\t\t// 计算申请单标题\n\t\tvar instance_name = \"\";\n\t\tvar name_forumla = form.current.name_forumla;\n\t\tif (name_forumla) {\n\t\t\tvar iscript = name_forumla.replace(/\\{/g, \"(new_values['\").replace(/\\}/g, \"'] || '')\");\n\t\t\tvar rev = eval(iscript);\n\t\t\tinstance_name = rev || flow.name;\n\t\t} else {\n\t\t\tinstance_name = flow.name;\n\t\t}\n\n\t\t// instance中记录当前步骤名称 #1314\n\t\tvar start_step = _.find(flow.current.steps, function (step) {\n\t\t\treturn step.step_type == 'start';\n\t\t})\n\n\t\t// 新建申请单时，instances记录流程名称、流程分类名称 #1313\n\t\tvar category_name = \"\";\n\t\tif (form.category) {\n\t\t\tvar category = uuflowManager.getCategory(form.category);\n\t\t\tif (category)\n\t\t\t\tcategory_name = category.name;\n\t\t}\n\n\t\t_.each(forward_users, function (user_id) {\n\n\t\t\tvar user_info = db.users.findOne(user_id);\n\n\t\t\tvar space_user = db.space_users.findOne({\n\t\t\t\tspace: space_id,\n\t\t\t\tuser: user_id\n\t\t\t}, {\n\t\t\t\tfields: {\n\t\t\t\t\torganization: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar space_user_org_info = db.organizations.findOne({\n\t\t\t\t_id: space_user.organization\n\t\t\t}, {\n\t\t\t\tfields: {\n\t\t\t\t\tname: 1,\n\t\t\t\t\tfullname: 1\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar now = new Date();\n\t\t\tvar ins_obj = {};\n\n\t\t\tvar agent = uuflowManager.getAgent(space_id, user_id);\n\t\t\tvar handler_id = user_id;\n\t\t\tvar handler_info = user_info;\n\t\t\tvar handler_space_user = space_user;\n\t\t\tvar handler_org_info = space_user_org_info;\n\t\t\tif (agent) {\n\t\t\t\thandler_id = agent;\n\t\t\t\thandler_info = db.users.findOne(agent);\n\t\t\t\thandler_space_user = uuflowManager.getSpaceUser(space_id, agent);\n\t\t\t\thandler_org_info = uuflowManager.getSpaceUserOrgInfo(handler_space_user);\n\t\t\t}\n\t\t\tins_obj._id = db.instances._makeNewID();\n\t\t\tins_obj.space = space_id;\n\t\t\tins_obj.flow = flow_id;\n\t\t\tins_obj.flow_version = flow.current._id;\n\t\t\tins_obj.form = flow.form;\n\t\t\tins_obj.form_version = flow.current.form_version;\n\t\t\tins_obj.name = instance_name;\n\t\t\tins_obj.submitter = handler_id;\n\t\t\tins_obj.submitter_name = handler_info.name;\n\t\t\tins_obj.applicant = user_id;\n\t\t\tins_obj.applicant_name = user_info.name;\n\t\t\tins_obj.applicant_organization = space_user.organization;\n\t\t\tins_obj.applicant_organization_name = space_user_org_info.name;\n\t\t\tins_obj.applicant_organization_fullname = space_user_org_info.fullname;\n\t\t\tins_obj.state = \"draft\";\n\t\t\tins_obj.code = \"\";\n\t\t\tins_obj.is_archived = false;\n\t\t\tins_obj.is_deleted = false;\n\t\t\tins_obj.created = now;\n\t\t\tins_obj.created_by = current_user_id;\n\t\t\tins_obj.modified = now;\n\t\t\tins_obj.modified_by = current_user_id;\n\t\t\tins_obj.inbox_users = [handler_id];\n\t\t\tins_obj.values = new_values;\n\t\t\tif (action_type == 'distribute') {\n\t\t\t\t// 解决多次分发看不到正文、附件问题\n\t\t\t\tif (ins.distribute_from_instance) {\n\t\t\t\t\tins_obj.distribute_from_instance = ins.distribute_from_instance;\n\t\t\t\t} else {\n\t\t\t\t\tins_obj.distribute_from_instance = instance_id;\n\t\t\t\t}\n\t\t\t\tins_obj.distribute_from_instances = _.clone(ins.distribute_from_instances) || [];\n\t\t\t\tins_obj.distribute_from_instances.push(instance_id);\n\n\t\t\t\tif (related) {\n\t\t\t\t\tins_obj.related_instances = [instance_id]\n\t\t\t\t}\n\n\t\t\t} else if (action_type == 'forward') {\n\t\t\t\tins_obj.forward_from_instance = instance_id\n\t\t\t}\n\n\t\t\t// 新建Trace\n\t\t\tvar trace_obj = {};\n\t\t\ttrace_obj._id = new Mongo.ObjectID()._str;\n\t\t\ttrace_obj.instance = ins_obj._id;\n\t\t\ttrace_obj.is_finished = false;\n\n\t\t\t// 当前最新版flow中开始节点的step_id\n\t\t\tvar step_id, step_name, can_edit_main_attach, can_edit_normal_attach;\n\t\t\tflow.current.steps.forEach(function (step) {\n\t\t\t\tif (step.step_type == \"start\") {\n\t\t\t\t\tstep_id = step._id;\n\t\t\t\t\tstep_name = step.name;\n\t\t\t\t\tcan_edit_main_attach = step.can_edit_main_attach;\n\t\t\t\t\tcan_edit_normal_attach = step.can_edit_normal_attach;\n\t\t\t\t}\n\t\t\t})\n\t\t\ttrace_obj.step = step_id;\n\t\t\ttrace_obj.start_date = now;\n\t\t\ttrace_obj.name = step_name;\n\n\t\t\t// 新建Approve\n\t\t\tvar appr_obj = {};\n\t\t\tappr_obj._id = new Mongo.ObjectID()._str;\n\t\t\tappr_obj.instance = ins_obj._id;\n\t\t\tappr_obj.trace = trace_obj._id;\n\t\t\tappr_obj.is_finished = false;\n\t\t\tappr_obj.user = user_id;\n\t\t\tappr_obj.user_name = user_info.name;\n\t\t\tappr_obj.handler = handler_id;\n\t\t\tappr_obj.handler_name = handler_info.name;\n\t\t\tappr_obj.handler_organization = handler_space_user.organization;\n\t\t\tappr_obj.handler_organization_name = handler_org_info.name;\n\t\t\tappr_obj.handler_organization_fullname = handler_org_info.fullname;\n\t\t\tappr_obj.type = \"draft\";\n\t\t\tappr_obj.start_date = now;\n\t\t\tappr_obj.read_date = now;\n\t\t\tappr_obj.is_read = false;\n\t\t\tappr_obj.is_error = false;\n\n\t\t\tappr_obj.values = new_values;\n\n\t\t\tif (agent) {\n\t\t\t\tappr_obj.agent = agent;\n\t\t\t}\n\n\t\t\ttrace_obj.approves = [appr_obj];\n\t\t\tins_obj.traces = [trace_obj];\n\n\t\t\tif (flow.auto_remind == true)\n\t\t\t\tins_obj.auto_remind = true;\n\n\t\t\tins_obj.current_step_name = start_step.name;\n\n\t\t\tins_obj.flow_name = flow.name;\n\t\t\tif (category_name)\n\t\t\t\tins_obj.category_name = category.name;\n\t\t\t\tins_obj.category = category._id;\n\n\t\t\tnew_ins_id = db.instances.insert(ins_obj);\n\n\t\t\t// 复制附件\n\t\t\tvar collection = cfs.instances;\n\n\t\t\t//将原表单内容存储为第一个附件\n\t\t\tif (hasSaveInstanceToAttachment) {\n\t\t\t\t// try {\n\n\t\t\t\tinstanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(user_info, space_id, ins, {\n\t\t\t\t\tabsolute: true\n\t\t\t\t})\n\t\t\t\tvar instanceFile = new FS.File();\n\t\t\t\tinstanceFile.attachData(Buffer.from(instanceHtml, \"utf-8\"), {\n\t\t\t\t\ttype: \"text/html\"\n\t\t\t\t}, function (error) {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\tthrow new Meteor.Error(error.error, error.reason);\n\t\t\t\t\t}\n\n\t\t\t\t\tinstanceFile.name(ins.name + \".html\");\n\t\t\t\t\tinstanceFile.size(instanceHtml.length);\n\n\t\t\t\t\tvar metadata = {\n\t\t\t\t\t\towner: user_id,\n\t\t\t\t\t\towner_name: user_info.name,\n\t\t\t\t\t\tspace: space_id,\n\t\t\t\t\t\tinstance: new_ins_id,\n\t\t\t\t\t\tapprove: appr_obj._id,\n\t\t\t\t\t\tcurrent: true\n\t\t\t\t\t};\n\t\t\t\t\tinstanceFile.metadata = metadata;\n\t\t\t\t\tvar fileObj = collection.insert(instanceFile);\n\t\t\t\t\tfileObj.update({\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t'metadata.parent': fileObj._id\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\n\t\t\t\t// } catch (e) {\n\t\t\t\t//     console.error(e);\n\t\t\t\t// }\n\t\t\t}\n\n\t\t\tif (isForwardAttachments && action_type == 'forward') {\n\t\t\t\tvar files = collection.find({\n\t\t\t\t\t'metadata.instance': instance_id,\n\t\t\t\t\t'metadata.current': true\n\t\t\t\t});\n\t\t\t\tfiles.forEach(function (f) {\n\t\t\t\t\t// 判断新的流程开始节点是否有编辑正文和编辑附件权限\n\t\t\t\t\tif (f.metadata.main == true) {\n\t\t\t\t\t\tif (can_edit_main_attach != true && can_edit_normal_attach != true)\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (can_edit_normal_attach != true)\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar newFile = new FS.File();\n\t\t\t\t\tnewFile.attachData(f.createReadStream('instances'), {\n\t\t\t\t\t\ttype: f.original.type\n\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tthrow new Meteor.Error(err.error, err.reason);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnewFile.name(f.name());\n\t\t\t\t\t\tnewFile.size(f.size());\n\t\t\t\t\t\tvar metadata = {\n\t\t\t\t\t\t\towner: user_id,\n\t\t\t\t\t\t\towner_name: user_info.name,\n\t\t\t\t\t\t\tspace: space_id,\n\t\t\t\t\t\t\tinstance: new_ins_id,\n\t\t\t\t\t\t\tapprove: appr_obj._id,\n\t\t\t\t\t\t\tcurrent: true\n\t\t\t\t\t\t};\n\t\t\t\t\t\tif (f.metadata.main == true && can_edit_main_attach == true) {\n\t\t\t\t\t\t\tmetadata.main = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnewFile.metadata = metadata;\n\t\t\t\t\t\tvar fileObj = collection.insert(newFile);\n\t\t\t\t\t\tfileObj.update({\n\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t'metadata.parent': fileObj._id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\n\t\t\t\t})\n\t\t\t}\n\n\t\t\t// 给当前的申请单增加转发记录\n\t\t\tvar appr = {\n\t\t\t\t'_id': new Mongo.ObjectID()._str,\n\t\t\t\t'instance': instance_id,\n\t\t\t\t'trace': current_trace_id,\n\t\t\t\t'is_finished': true,\n\t\t\t\t'user': user_id,\n\t\t\t\t'user_name': user_info.name,\n\t\t\t\t'handler': user_id,\n\t\t\t\t'handler_name': user_info.name,\n\t\t\t\t'handler_organization': space_user.organization,\n\t\t\t\t'handler_organization_name': space_user_org_info.name,\n\t\t\t\t'handler_organization_fullname': space_user_org_info.fullname,\n\t\t\t\t'type': action_type,\n\t\t\t\t'start_date': new Date(),\n\t\t\t\t'finish_date': new Date(),\n\t\t\t\t'is_read': false,\n\t\t\t\t'judge': 'submitted',\n\t\t\t\t'from_user': current_user_id,\n\t\t\t\t'from_user_name': from_user_name,\n\t\t\t\t'forward_space': space_id,\n\t\t\t\t'forward_instance': new_ins_id,\n\t\t\t\t'description': description,\n\t\t\t\t'from_approve_id': from_approve_id\n\t\t\t};\n\n\t\t\tforward_approves.push(appr);\n\n\t\t\tnew_ins_ids.push(new_ins_id);\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id);\n\t\t})\n\n\t\tset_obj.modified = new Date();\n\t\tset_obj.modified_by = current_user_id;\n\t\tvar r = db.instances.update({\n\t\t\t_id: instance_id,\n\t\t\t\"traces._id\": current_trace_id\n\t\t}, {\n\t\t\t$set: set_obj,\n\t\t\t$addToSet: {\n\t\t\t\t'traces.$.approves': {\n\t\t\t\t\t$each: forward_approves\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (r) {\n\t\t\t_.each(current_trace.approves, function (a, idx) {\n\t\t\t\tif (a._id == from_approve_id) {\n\t\t\t\t\tvar update_read = {};\n\t\t\t\t\tupdate_read[\"traces.$.approves.\" + idx + \".read_date\"] = new Date();\n\t\t\t\t\tdb.instances.update({\n\t\t\t\t\t\t_id: instance_id,\n\t\t\t\t\t\t\"traces._id\": current_trace_id\n\t\t\t\t\t}, {\n\t\t\t\t\t\t$set: update_read\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\n\t\t}\n\n\t\tJsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {}\n\t\t})\n\t} catch (e) {\n\t\tconsole.error(e.stack)\n\t\tJsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\terrors: [e]\n\t\t\t}\n\t\t})\n\t}\n\n})","JsonRoutes.add 'get', '/api/workflow/instance/:instanceId', (req, res, next) ->\n\ttry\n\t\tcurrent_user_info = uuflowManager.check_authorization(req, res)\n\t\tcurrent_user_id = current_user_info._id\n\n\t\tinsId = req.params.instanceId\n\n\t\tins = db.instances.findOne(insId, { fields: { space: 1, flow: 1, state: 1, inbox_users: 1, cc_users: 1, outbox_users: 1, submitter: 1, applicant: 1 } })\n\n\t\tif not ins\n\t\t\tthrow new Meteor.Error('error', 'instanceId is wrong or instance not exists.')\n\n\t\tspaceId = ins.space\n\t\tflowId = ins.flow\n\n\t\tif db.space_users.find({ space: spaceId, user: current_user_id }).count() is 0\n\t\t\tthrow new Meteor.Error('error', 'user is not belong to this space.')\n\n\t\tbox = ''\n\n\t\tif (ins.inbox_users?.includes current_user_id) or (ins.cc_users?.includes current_user_id)\n\t\t\tbox = 'inbox'\n\t\telse if ins.outbox_users?.includes current_user_id\n\t\t\tbox = 'outbox'\n\t\telse if ins.state is 'draft' and ins.submitter is current_user_id\n\t\t\tbox = 'draft'\n\t\telse if ins.state is 'pending' and (ins.submitter is current_user_id or ins.applicant is current_user_id)\n\t\t\tbox = 'pending'\n\t\telse if ins.state is 'completed' and ins.submitter is current_user_id\n\t\t\tbox = 'completed'\n\t\telse\n\t\t\t# 验证login user_id对该流程有管理申请单的权限\n\t\t\tpermissions = permissionManager.getFlowPermissions(flowId, current_user_id)\n\t\t\tspace = db.spaces.findOne(spaceId, { fields: { admins: 1 } })\n\t\t\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user_id))\n\t\t\t\tthrow new Meteor.Error('error', \"no permission.\")\n\t\t\tbox = 'monitor'\n\n\t\tredirectTo = Meteor.absoluteUrl \"workflow/space/#{spaceId}/#{box}/#{insId}\"\n\n\t\tres.setHeader \"Location\", redirectTo\n\t\tres.writeHead 302\n\t\tres.end()\n\t\treturn\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}] }\n","JsonRoutes.add('get', '/api/workflow/instance/:instanceId', function(req, res, next) {\n  var box, current_user_id, current_user_info, e, flowId, ins, insId, permissions, redirectTo, ref, ref1, ref2, space, spaceId;\n  try {\n    current_user_info = uuflowManager.check_authorization(req, res);\n    current_user_id = current_user_info._id;\n    insId = req.params.instanceId;\n    ins = db.instances.findOne(insId, {\n      fields: {\n        space: 1,\n        flow: 1,\n        state: 1,\n        inbox_users: 1,\n        cc_users: 1,\n        outbox_users: 1,\n        submitter: 1,\n        applicant: 1\n      }\n    });\n    if (!ins) {\n      throw new Meteor.Error('error', 'instanceId is wrong or instance not exists.');\n    }\n    spaceId = ins.space;\n    flowId = ins.flow;\n    if (db.space_users.find({\n      space: spaceId,\n      user: current_user_id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'user is not belong to this space.');\n    }\n    box = '';\n    if (((ref = ins.inbox_users) != null ? ref.includes(current_user_id) : void 0) || ((ref1 = ins.cc_users) != null ? ref1.includes(current_user_id) : void 0)) {\n      box = 'inbox';\n    } else if ((ref2 = ins.outbox_users) != null ? ref2.includes(current_user_id) : void 0) {\n      box = 'outbox';\n    } else if (ins.state === 'draft' && ins.submitter === current_user_id) {\n      box = 'draft';\n    } else if (ins.state === 'pending' && (ins.submitter === current_user_id || ins.applicant === current_user_id)) {\n      box = 'pending';\n    } else if (ins.state === 'completed' && ins.submitter === current_user_id) {\n      box = 'completed';\n    } else {\n      permissions = permissionManager.getFlowPermissions(flowId, current_user_id);\n      space = db.spaces.findOne(spaceId, {\n        fields: {\n          admins: 1\n        }\n      });\n      if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user_id))) {\n        throw new Meteor.Error('error', \"no permission.\");\n      }\n      box = 'monitor';\n    }\n    redirectTo = Meteor.absoluteUrl(\"workflow/space/\" + spaceId + \"/\" + box + \"/\" + insId);\n    res.setHeader(\"Location\", redirectTo);\n    res.writeHead(302);\n    res.end();\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\n@api {get} /api/workflow/open/pending 获取待办文件\n\n@apiDescription 获取当前用户的待办事项列表\n\n@apiName getInbox\n\n@apiGroup Workflow\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n\t{\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n\t{\n\t\t\"status\": \"success\",\n\t\t\"data\": [\n\t\t\t{\n\t\t\t\t\"id\": \"g7wokXNkR9yxHvA4D\",\n\t\t\t\t\"start_date\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"flow_name\": \"正文流程\",\n\t\t\t\t\"space_name\": \"审批王\",\n\t\t\t\t\"name\": \"正文流程 1\",\n\t\t\t\t\"applicant_name\": null,\n\t\t\t\t\"applicant_organization_name\": \"审批王\",\n\t\t\t\t\"submit_date\": \"2017-07-25T06:36:48.492Z\",\n\t\t\t\t\"step_name\": \"开始\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"is_read\": false,\n\t\t\t\t\"values\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"id\": \"WqKSrWQoywgJaMp9k\",\n\t\t\t\t\"start_date\": \"2017-08-17T07:38:35.420Z\",\n\t\t\t\t\"flow_name\": \"正文\\n\",\n\t\t\t\t\"space_name\": \"审批王\",\n\t\t\t\t\"name\": \"正文\\n 1\",\n\t\t\t\t\"applicant_name\": \"殷亮辉\",\n\t\t\t\t\"applicant_organization_name\": \"审批王\",\n\t\t\t\t\"submit_date\": \"2017-06-27T10:26:19.468Z\",\n\t\t\t\t\"step_name\": \"开始\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-08-17T07:38:35.421Z\",\n\t\t\t\t\"is_read\": true,\n\t\t\t\t\"values\": {}\n\t\t\t}\n\t\t]\n\t}\n###\nJsonRoutes.add 'get', '/api/workflow/open/pending', (req, res, next) ->\n\ttry\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn\n\n\t\tspace_id = req.headers['x-space-id'] || req.query?.spaceId\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need space_id')\n\n\t\tuser_id = req.userId\n\n\t\tif !user_id\n\t\t\tthrow new Meteor.Error('error', 'Not logged in')\n\n\t\tif db.users.find({ _id: user_id }).count() is 0\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\tlimit = req.query?.limit || 500\n\n\t\tlimit = parseInt(limit)\n\n\t\tusername = req.query?.username\n\n\t\tuserid = req.query?.userid\n\n\t\tattach = req.query?.attach\n\n\t\tworkflow_categories = req.query?.workflow_categories\n\n\t\t# 校验space是否存在\n\t\tspace = uuflowManager.getSpace(space_id)\n\n\t\t# 如果当前用户是工作区管理员，则通过查看url上是否有username\\userid ，\n\t\t# 如果有，则返回username\\userid对应的用户，否则返回当前用户待办。\n\t\t# username\\userid都存在时，userid优先\n\t\tspecial_user_id\n\t\tif space.admins.includes(user_id)\n\t\t\tif userid\n\t\t\t\tif db.users.find({ _id: userid }).count() < 1\n\t\t\t\t\tthrow new Meteor.Error('error', \"can not find user by userid: #{userid}\")\n\n\t\t\t\tspecial_user_id = userid\n\t\t\telse if username\n\t\t\t\tu = db.users.findOne({ username: username }, { fields: { _id: 1 } })\n\t\t\t\tif _.isEmpty(u)\n\t\t\t\t\tthrow new Meteor.Error('error', \"can not find user by username: #{username}\")\n\n\t\t\t\tspecial_user_id = u._id\n\n\t\tresult_instances = new Array\n\n\t\tis_read = false\n\t\tstart_date = ''\n\t\tuid = user_id\n\t\tquery = {\n\t\t\t$or: [{ inbox_users: user_id }, { cc_users: user_id }]\n\t\t}\n\n\t\tif special_user_id\n\t\t\tuid = special_user_id\n\t\t\tquery = {\n\t\t\t\tspace: space_id,\n\t\t\t\t$or: [{ inbox_users: special_user_id }, { cc_users: special_user_id }]\n\t\t\t}\n\n\t\tif workflow_categories\n\t\t\tquery.category = { $in: workflow_categories.split(',') }\n\n\t\tspace_names = {}\n\t\tspace_names[space._id] = space.name\n\n\t\tif limit > 0\n\t\t\tdb.instances.find(query, { sort: { modified: -1 }, limit: limit }).forEach (i) ->\n\n\t\t\t\tif i.inbox_users?.includes(uid)\n\t\t\t\t\t_.each i.traces, (t) ->\n\t\t\t\t\t\tif t.is_finished is false\n\t\t\t\t\t\t\t_.each t.approves, (a) ->\n\t\t\t\t\t\t\t\tif a.user is uid and a.type isnt 'cc' and not a.is_finished\n\t\t\t\t\t\t\t\t\tis_read = a.is_read\n\t\t\t\t\t\t\t\t\tstart_date = a.start_date\n\t\t\t\telse\n\t\t\t\t\t_.each i.traces, (t) ->\n\t\t\t\t\t\tif not start_date and t.approves\n\t\t\t\t\t\t\t_.each t.approves, (a) ->\n\t\t\t\t\t\t\t\tif not start_date and a.user is uid and a.type is 'cc' and not a.is_finished\n\t\t\t\t\t\t\t\t\tis_read = a.is_read\n\t\t\t\t\t\t\t\t\tstart_date = a.start_date\n\n\t\t\t\tif not space_names[i.space]\n\t\t\t\t\tspace_names[i.space] = db.spaces.findOne(i.space, { fields: { name: 1 } })?.name\n\n\t\t\t\th = new Object\n\t\t\t\th[\"id\"] = i[\"_id\"]\n\t\t\t\th[\"start_date\"] = start_date\n\t\t\t\th[\"flow_name\"] = i.flow_name\n\t\t\t\th[\"space_name\"] = space_names[i.space]\n\t\t\t\th[\"name\"] = i[\"name\"]\n\t\t\t\th[\"applicant_name\"] = i[\"applicant_name\"]\n\t\t\t\th[\"applicant_organization_name\"] = i[\"applicant_organization_name\"]\n\t\t\t\th[\"submit_date\"] = i[\"submit_date\"]\n\t\t\t\th[\"step_name\"] = i.current_step_name\n\t\t\t\th[\"space_id\"] = i.space\n\t\t\t\th[\"modified\"] = i[\"modified\"]\n\t\t\t\th[\"is_read\"] = is_read\n\t\t\t\th[\"values\"] = i[\"values\"]\n\n\t\t\t\tif attach is 'true'\n\t\t\t\t\th.attachments = cfs.instances.find({ 'metadata.instance': i._id, 'metadata.current': true, \"metadata.is_private\": { $ne: true } }, { fields: { copies: 0 } }).fetch()\n\n\t\t\t\tresult_instances.push(h)\n\n\t\tno_limit_count = db.instances.find(query).count()\n\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: result_instances, count: no_limit_count }\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.reason }] }\n\t\t}\n\n","\n/*\n@api {get} /api/workflow/open/pending 获取待办文件\n\n@apiDescription 获取当前用户的待办事项列表\n\n@apiName getInbox\n\n@apiGroup Workflow\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n\t{\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n\t{\n\t\t\"status\": \"success\",\n\t\t\"data\": [\n\t\t\t{\n\t\t\t\t\"id\": \"g7wokXNkR9yxHvA4D\",\n\t\t\t\t\"start_date\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"flow_name\": \"正文流程\",\n\t\t\t\t\"space_name\": \"审批王\",\n\t\t\t\t\"name\": \"正文流程 1\",\n\t\t\t\t\"applicant_name\": null,\n\t\t\t\t\"applicant_organization_name\": \"审批王\",\n\t\t\t\t\"submit_date\": \"2017-07-25T06:36:48.492Z\",\n\t\t\t\t\"step_name\": \"开始\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-11-23T02:28:53.164Z\",\n\t\t\t\t\"is_read\": false,\n\t\t\t\t\"values\": {}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"id\": \"WqKSrWQoywgJaMp9k\",\n\t\t\t\t\"start_date\": \"2017-08-17T07:38:35.420Z\",\n\t\t\t\t\"flow_name\": \"正文\\n\",\n\t\t\t\t\"space_name\": \"审批王\",\n\t\t\t\t\"name\": \"正文\\n 1\",\n\t\t\t\t\"applicant_name\": \"殷亮辉\",\n\t\t\t\t\"applicant_organization_name\": \"审批王\",\n\t\t\t\t\"submit_date\": \"2017-06-27T10:26:19.468Z\",\n\t\t\t\t\"step_name\": \"开始\",\n\t\t\t\t\"space_id\": \"kfDsMv7gBewmGXGEL\",\n\t\t\t\t\"modified\": \"2017-08-17T07:38:35.421Z\",\n\t\t\t\t\"is_read\": true,\n\t\t\t\t\"values\": {}\n\t\t\t}\n\t\t]\n\t}\n */\nJsonRoutes.add('get', '/api/workflow/open/pending', function(req, res, next) {\n  var attach, e, is_read, limit, no_limit_count, query, ref, ref1, ref2, ref3, ref4, ref5, result_instances, space, space_id, space_names, special_user_id, start_date, u, uid, user_id, userid, username, workflow_categories;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    space_id = req.headers['x-space-id'] || ((ref = req.query) != null ? ref.spaceId : void 0);\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need space_id');\n    }\n    user_id = req.userId;\n    if (!user_id) {\n      throw new Meteor.Error('error', 'Not logged in');\n    }\n    if (db.users.find({\n      _id: user_id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    limit = ((ref1 = req.query) != null ? ref1.limit : void 0) || 500;\n    limit = parseInt(limit);\n    username = (ref2 = req.query) != null ? ref2.username : void 0;\n    userid = (ref3 = req.query) != null ? ref3.userid : void 0;\n    attach = (ref4 = req.query) != null ? ref4.attach : void 0;\n    workflow_categories = (ref5 = req.query) != null ? ref5.workflow_categories : void 0;\n    space = uuflowManager.getSpace(space_id);\n    special_user_id;\n    if (space.admins.includes(user_id)) {\n      if (userid) {\n        if (db.users.find({\n          _id: userid\n        }).count() < 1) {\n          throw new Meteor.Error('error', \"can not find user by userid: \" + userid);\n        }\n        special_user_id = userid;\n      } else if (username) {\n        u = db.users.findOne({\n          username: username\n        }, {\n          fields: {\n            _id: 1\n          }\n        });\n        if (_.isEmpty(u)) {\n          throw new Meteor.Error('error', \"can not find user by username: \" + username);\n        }\n        special_user_id = u._id;\n      }\n    }\n    result_instances = new Array;\n    is_read = false;\n    start_date = '';\n    uid = user_id;\n    query = {\n      $or: [\n        {\n          inbox_users: user_id\n        }, {\n          cc_users: user_id\n        }\n      ]\n    };\n    if (special_user_id) {\n      uid = special_user_id;\n      query = {\n        space: space_id,\n        $or: [\n          {\n            inbox_users: special_user_id\n          }, {\n            cc_users: special_user_id\n          }\n        ]\n      };\n    }\n    if (workflow_categories) {\n      query.category = {\n        $in: workflow_categories.split(',')\n      };\n    }\n    space_names = {};\n    space_names[space._id] = space.name;\n    if (limit > 0) {\n      db.instances.find(query, {\n        sort: {\n          modified: -1\n        },\n        limit: limit\n      }).forEach(function(i) {\n        var h, ref6, ref7;\n        if ((ref6 = i.inbox_users) != null ? ref6.includes(uid) : void 0) {\n          _.each(i.traces, function(t) {\n            if (t.is_finished === false) {\n              return _.each(t.approves, function(a) {\n                if (a.user === uid && a.type !== 'cc' && !a.is_finished) {\n                  is_read = a.is_read;\n                  return start_date = a.start_date;\n                }\n              });\n            }\n          });\n        } else {\n          _.each(i.traces, function(t) {\n            if (!start_date && t.approves) {\n              return _.each(t.approves, function(a) {\n                if (!start_date && a.user === uid && a.type === 'cc' && !a.is_finished) {\n                  is_read = a.is_read;\n                  return start_date = a.start_date;\n                }\n              });\n            }\n          });\n        }\n        if (!space_names[i.space]) {\n          space_names[i.space] = (ref7 = db.spaces.findOne(i.space, {\n            fields: {\n              name: 1\n            }\n          })) != null ? ref7.name : void 0;\n        }\n        h = new Object;\n        h[\"id\"] = i[\"_id\"];\n        h[\"start_date\"] = start_date;\n        h[\"flow_name\"] = i.flow_name;\n        h[\"space_name\"] = space_names[i.space];\n        h[\"name\"] = i[\"name\"];\n        h[\"applicant_name\"] = i[\"applicant_name\"];\n        h[\"applicant_organization_name\"] = i[\"applicant_organization_name\"];\n        h[\"submit_date\"] = i[\"submit_date\"];\n        h[\"step_name\"] = i.current_step_name;\n        h[\"space_id\"] = i.space;\n        h[\"modified\"] = i[\"modified\"];\n        h[\"is_read\"] = is_read;\n        h[\"values\"] = i[\"values\"];\n        if (attach === 'true') {\n          h.attachments = cfs.instances.find({\n            'metadata.instance': i._id,\n            'metadata.current': true,\n            \"metadata.is_private\": {\n              $ne: true\n            }\n          }, {\n            fields: {\n              copies: 0\n            }\n          }).fetch();\n        }\n        return result_instances.push(h);\n      });\n    }\n    no_limit_count = db.instances.find(query).count();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result_instances,\n        count: no_limit_count\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.reason\n          }\n        ]\n      }\n    });\n  }\n});\n","Cookies = require(\"cookies\")\n\nMeteor.startup ->\n\tWebApp.connectHandlers.use \"/api/workflow/export/talbe_template\", (req, res, next)->\n\t\tcookies = new Cookies( req, res );\n\t\t# first check request body\n\t\tif req.body\n\t\t\tuserId = req.body[\"X-User-Id\"]\n\t\t\tauthToken = req.body[\"X-Auth-Token\"]\n\n\t\t# then check cookie\n\t\tif !userId or !authToken\n\t\t\tuserId = cookies.get(\"X-User-Id\")\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\t\tif !(userId and authToken)\n\t\t\tres.writeHead(401);\n\t\t\tres.end JSON.stringify({\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\n\t\t\t\t\"success\": false\n\t\t\t})\n\t\t\treturn ;\n\n\t\tflowId = req.query?.flow;\n\n\t\tflow = db.flows.findOne({_id: flowId}, {fields: {space: 1, form: 1, name: 1}})\n\n\t\tform = db.forms.findOne({_id: flow.form}, {fields: {space: 1, \"current._id\": 1}})\n\n\t\tif _.isEmpty(flow)\n\t\t\tres.writeHead(401);\n\t\t\tres.end JSON.stringify({\n\t\t\t\t\"error\": \"Validate Request -- Invalid formId\",\n\t\t\t\t\"success\": false\n\t\t\t})\n\t\t\treturn ;\n\t\telse\n\t\t\tif !Steedos.isSpaceAdmin(flow.space, userId)\n\t\t\t\tres.writeHead(401);\n\t\t\t\tres.end JSON.stringify({\n\t\t\t\t\t\"error\": \"Validate Request -- No permission\",\n\t\t\t\t\t\"success\": false\n\t\t\t\t})\n\t\t\t\treturn;\n\n\t\t\tspace = db.spaces.findOne(flow.space, { fields: { is_paid: 1 } })\n\t\t\tif !space?.is_paid\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tcode: 404,\n\t\t\t\t\tdata:\n\t\t\t\t\t\t\"error\": \"Validate Request -- Non-paid space.\",\n\t\t\t\t\t\t\"success\": false\n\t\t\t\treturn;\n\n\t\tdata = TemplateManager.handleTableTemplate({form: flow.form, form_version: form?.current?._id}, true);\n\n\t\tfileName = flow.name\n\n\t\tres.setHeader('Content-type', 'application/x-msdownload');\n\t\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(fileName)+'.html');\n\t\tres.end(data)","var Cookies;\n\nCookies = require(\"cookies\");\n\nMeteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/talbe_template\", function(req, res, next) {\n    var authToken, cookies, data, fileName, flow, flowId, form, ref, ref1, space, userId;\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Missing X-Auth-Token\",\n        \"success\": false\n      }));\n      return;\n    }\n    flowId = (ref = req.query) != null ? ref.flow : void 0;\n    flow = db.flows.findOne({\n      _id: flowId\n    }, {\n      fields: {\n        space: 1,\n        form: 1,\n        name: 1\n      }\n    });\n    form = db.forms.findOne({\n      _id: flow.form\n    }, {\n      fields: {\n        space: 1,\n        \"current._id\": 1\n      }\n    });\n    if (_.isEmpty(flow)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Invalid formId\",\n        \"success\": false\n      }));\n      return;\n    } else {\n      if (!Steedos.isSpaceAdmin(flow.space, userId)) {\n        res.writeHead(401);\n        res.end(JSON.stringify({\n          \"error\": \"Validate Request -- No permission\",\n          \"success\": false\n        }));\n        return;\n      }\n      space = db.spaces.findOne(flow.space, {\n        fields: {\n          is_paid: 1\n        }\n      });\n      if (!(space != null ? space.is_paid : void 0)) {\n        JsonRoutes.sendResult(res, {\n          code: 404,\n          data: {\n            \"error\": \"Validate Request -- Non-paid space.\",\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    data = TemplateManager.handleTableTemplate({\n      form: flow.form,\n      form_version: form != null ? (ref1 = form.current) != null ? ref1._id : void 0 : void 0\n    }, true);\n    fileName = flow.name;\n    res.setHeader('Content-type', 'application/x-msdownload');\n    res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(fileName) + '.html');\n    return res.end(data);\n  });\n});\n","###\n@api {post} /api/workflow/open/drafts 新建申请单\n\n@apiName createInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": 流程Id,\n    \"applicant\": 申请人Id,\n    \"values\": {\n        \"fields1\" : 字段值,\n        \"fields2\" : 字段值,\n        ...\n    }\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n\n@apiErrorExample {json} error-Response:\n{\n    \"status\": \"error\",\n    \"data\": {...}\n}\n###\nJsonRoutes.add 'post', '/api/workflow/open/drafts', (req, res, next) ->\n\ttry\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn\n\n\t\tuser_id = req.userId\n\n\t\tcurrent_user_info = db.users.findOne({ _id: user_id })\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header x_space_id')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user_info._id)\n\n\t\thashData = req.body\n\n\t\tif not hashData[\"flow\"]\n\t\t\tthrow new Meteor.Error('error', 'flow is null')\n\n\t\tflow_id      = hashData[\"flow\"]\n\t\tapplicant_id = hashData[\"applicant\"]\n\t\tapplicant_username = hashData[\"applicant_username\"]\n\n\t\tinstance_from_client = new Object\n\n\t\tflow = db.flows.findOne({ _id: flow_id }, { fields: { space: 1, 'current._id': 1 } })\n\t\tif not flow\n\t\t\tthrow new Meteor.Error('error', 'flow is not exists')\n\n\t\tif space_id isnt flow.space\n\t\t\tthrow new Meteor.Error('error', 'flow is not belong to this space')\n\n\t\tif db.space_users.find({ space: space_id, user: current_user_info._id }).count() is 0\n\t\t\tthrow new Meteor.Error('error', 'auth_token is not a member of this space')\n\n\t\tinstance_from_client[\"space\"] = space_id\n\t\tinstance_from_client[\"flow\"] = flow_id\n\t\tinstance_from_client[\"flow_version\"] = flow.current._id\n\n\t\tapplicant = null\n\t\tif applicant_id or applicant_username\n\n\t\t\tif applicant_id\n\t\t\t\tapplicant = db.users.findOne({ _id: applicant_id }, { fields: { name: 1 } })\n\t\t\t\tif not applicant\n\t\t\t\t\tthrow new Meteor.Error('error', 'applicant is wrong')\n\n\t\t\telse if applicant_username\n\t\t\t\tapplicant = db.users.findOne({ username: applicant_username }, { fields: { name: 1 } })\n\t\t\t\tif not applicant\n\t\t\t\t\tthrow new Meteor.Error('error', 'applicant_username is wrong')\n\n\t\t\tspace_user = db.space_users.findOne({ space: space_id, user: applicant._id })\n\t\t\tif not space_user\n\t\t\t\tthrow new Meteor.Error('error', 'applicant is not a member of this space')\n\n\t\t\tif space_user.user_accepted isnt true\n\t\t\t\tthrow new Meteor.Error('error', 'applicant is disabled in this space')\n\n\t\t\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t\t\tinstance_from_client[\"applicant\"] = applicant._id\n\t\t\tinstance_from_client[\"applicant_name\"] = applicant.name\n\t\t\tinstance_from_client[\"applicant_organization\"] =  space_user_org_info[\"organization\"]\n\t\t\tinstance_from_client[\"applicant_organization_fullname\"] = space_user_org_info[\"organization_fullname\"]\n\t\t\tinstance_from_client[\"applicant_organization_name\"] = space_user_org_info[\"organization_name\"]\n\n\t\tapplicantInfo = applicant || current_user_info\n\n\t\ttraces = []\n\t\ttrace = new Object\n\t\tapproves = []\n\t\tapprove = new Object\n\t\tapprove[\"values\"] = hashData[\"values\"]\n\t\tapproves.push(approve)\n\t\ttrace[\"approves\"] = approves\n\t\ttraces.push(trace)\n\t\tinstance_from_client[\"traces\"] = traces\n\n\t\tinstance_from_client[\"inbox_users\"] = [applicantInfo._id]\n\n\t\tnew_ins_id = uuflowManager.create_instance(instance_from_client, applicantInfo)\n\n\t\tnew_ins = db.instances.findOne(new_ins_id)\n\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: new_ins }\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\n\t\t}\n","\n/*\n@api {post} /api/workflow/open/drafts 新建申请单\n\n@apiName createInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": 流程Id,\n    \"applicant\": 申请人Id,\n    \"values\": {\n        \"fields1\" : 字段值,\n        \"fields2\" : 字段值,\n        ...\n    }\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n\n@apiErrorExample {json} error-Response:\n{\n    \"status\": \"error\",\n    \"data\": {...}\n}\n */\nJsonRoutes.add('post', '/api/workflow/open/drafts', function(req, res, next) {\n  var applicant, applicantInfo, applicant_id, applicant_username, approve, approves, current_user_info, e, flow, flow_id, hashData, instance_from_client, new_ins, new_ins_id, space_id, space_user, space_user_org_info, trace, traces, user_id;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    user_id = req.userId;\n    current_user_info = db.users.findOne({\n      _id: user_id\n    });\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header x_space_id');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user_info._id);\n    hashData = req.body;\n    if (!hashData[\"flow\"]) {\n      throw new Meteor.Error('error', 'flow is null');\n    }\n    flow_id = hashData[\"flow\"];\n    applicant_id = hashData[\"applicant\"];\n    applicant_username = hashData[\"applicant_username\"];\n    instance_from_client = new Object;\n    flow = db.flows.findOne({\n      _id: flow_id\n    }, {\n      fields: {\n        space: 1,\n        'current._id': 1\n      }\n    });\n    if (!flow) {\n      throw new Meteor.Error('error', 'flow is not exists');\n    }\n    if (space_id !== flow.space) {\n      throw new Meteor.Error('error', 'flow is not belong to this space');\n    }\n    if (db.space_users.find({\n      space: space_id,\n      user: current_user_info._id\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'auth_token is not a member of this space');\n    }\n    instance_from_client[\"space\"] = space_id;\n    instance_from_client[\"flow\"] = flow_id;\n    instance_from_client[\"flow_version\"] = flow.current._id;\n    applicant = null;\n    if (applicant_id || applicant_username) {\n      if (applicant_id) {\n        applicant = db.users.findOne({\n          _id: applicant_id\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        if (!applicant) {\n          throw new Meteor.Error('error', 'applicant is wrong');\n        }\n      } else if (applicant_username) {\n        applicant = db.users.findOne({\n          username: applicant_username\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        if (!applicant) {\n          throw new Meteor.Error('error', 'applicant_username is wrong');\n        }\n      }\n      space_user = db.space_users.findOne({\n        space: space_id,\n        user: applicant._id\n      });\n      if (!space_user) {\n        throw new Meteor.Error('error', 'applicant is not a member of this space');\n      }\n      if (space_user.user_accepted !== true) {\n        throw new Meteor.Error('error', 'applicant is disabled in this space');\n      }\n      space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n      instance_from_client[\"applicant\"] = applicant._id;\n      instance_from_client[\"applicant_name\"] = applicant.name;\n      instance_from_client[\"applicant_organization\"] = space_user_org_info[\"organization\"];\n      instance_from_client[\"applicant_organization_fullname\"] = space_user_org_info[\"organization_fullname\"];\n      instance_from_client[\"applicant_organization_name\"] = space_user_org_info[\"organization_name\"];\n    }\n    applicantInfo = applicant || current_user_info;\n    traces = [];\n    trace = new Object;\n    approves = [];\n    approve = new Object;\n    approve[\"values\"] = hashData[\"values\"];\n    approves.push(approve);\n    trace[\"approves\"] = approves;\n    traces.push(trace);\n    instance_from_client[\"traces\"] = traces;\n    instance_from_client[\"inbox_users\"] = [applicantInfo._id];\n    new_ins_id = uuflowManager.create_instance(instance_from_client, applicantInfo);\n    new_ins = db.instances.findOne(new_ins_id);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: new_ins\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\n@api {get} /api/workflow/open/get/:ins_id 查看申请单详情\n\n@apiName getInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区的管理员\n\n@apiParam {String} ins_id 申请单Id\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n###\nJsonRoutes.add 'get', '/api/workflow/open/get/:ins_id', (req, res, next) ->\n\ttry\n\t\tins_id = req.params.ins_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\tinstance = db.instances.findOne(ins_id)\n\t\tif not instance\n\t\t\tthrow new Meteor.Error('error', 'can not find instance')\n\n\t\tif db.space_users.find({ space: instance.space, user: current_user }).count() is 0\n\t\t\tthrow new Meteor.Error('error', 'auth_token is wrong')\n\n\t\t# 权限：仅以下人员可以查看申请单详情：提交者、申请者、经手者、本流程的管理员、本流程的观察员、本工作区的管理员、本工作区的所有者。\n\t\tperm_users = new Array\n\t\tperm_users.push(instance.submitter)\n\t\tperm_users.push(instance.applicant)\n\t\tif instance.outbox_users\n\t\t\tperm_users = perm_users.concat(instance.outbox_users)\n\t\tif instance.inbox_users\n\t\t\tperm_users = perm_users.concat(instance.inbox_users)\n\t\tspace = db.spaces.findOne({ _id: instance.space }, { fields: { admins: 1 } })\n\t\tperm_users = perm_users.concat(space.admins)\n\n\t\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\n\n\t\tif (not perm_users.includes(current_user)) and (not permissions.includes(\"monitor\")) and (not permissions.includes(\"admin\"))\n\t\t\tthrow new Meteor.Error('error', 'no permission')\n\n\t\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\n\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: instance }\n\t\t}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{ errorMessage: e.message }] }\n\t\t}\n\n","\n/*\n@api {get} /api/workflow/open/get/:ins_id 查看申请单详情\n\n@apiName getInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区的管理员\n\n@apiParam {String} ins_id 申请单Id\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n    \"status\": \"success\",\n    \"data\": {instance}\n}\n */\nJsonRoutes.add('get', '/api/workflow/open/get/:ins_id', function(req, res, next) {\n  var current_user, e, ins_id, instance, perm_users, permissions, space, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    instance = db.instances.findOne(ins_id);\n    if (!instance) {\n      throw new Meteor.Error('error', 'can not find instance');\n    }\n    if (db.space_users.find({\n      space: instance.space,\n      user: current_user\n    }).count() === 0) {\n      throw new Meteor.Error('error', 'auth_token is wrong');\n    }\n    perm_users = new Array;\n    perm_users.push(instance.submitter);\n    perm_users.push(instance.applicant);\n    if (instance.outbox_users) {\n      perm_users = perm_users.concat(instance.outbox_users);\n    }\n    if (instance.inbox_users) {\n      perm_users = perm_users.concat(instance.inbox_users);\n    }\n    space = db.spaces.findOne({\n      _id: instance.space\n    }, {\n      fields: {\n        admins: 1\n      }\n    });\n    perm_users = perm_users.concat(space.admins);\n    permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n    if ((!perm_users.includes(current_user)) && (!permissions.includes(\"monitor\")) && (!permissions.includes(\"admin\"))) {\n      throw new Meteor.Error('error', 'no permission');\n    }\n    instance.attachments = cfs.instances.find({\n      'metadata.instance': instance._id,\n      'metadata.current': true,\n      \"metadata.is_private\": {\n        $ne: true\n      }\n    }, {\n      fields: {\n        copies: 0\n      }\n    }).fetch();\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: instance\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\n@api {put} /api/workflow/open/submit/:ins_id 提交申请单\n\n@apiDescription 暂不支持开始节点下一节点为条件的情况\n\n@apiName submitInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n###\n\nJsonRoutes.add 'put', '/api/workflow/open/submit/:ins_id', (req, res, next) ->\n\ttry\n\t\tins_id = req.params.ins_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\tinstance = uuflowManager.getInstance(ins_id)\n\n\t\t# 校验申请单状态为草稿\n\t\tuuflowManager.isInstanceDraft(instance)\n\n\t\tif space_id isnt instance[\"space\"]\n\t\t\tthrow new Meteor.Error('error', 'instance is not belong to this space')\n\n\t\t# 校验申请单必填字段是否有值\n\t\tvalues = instance[\"traces\"][0][\"approves\"][0].values\n\n\t\tform = uuflowManager.getForm(instance.form)\n\n\t\trequire_but_empty_fields = uuflowManager.checkValueFieldsRequire(values, form, instance.form_version)\n\n\t\tif require_but_empty_fields.length > 0\n\t\t\tif require_but_empty_fields.length > 1\n\t\t\t\tthrow new Meteor.Error('error', 'fields <' + require_but_empty_fields.join(\",\") + '> are required')\n\t\t\telse if require_but_empty_fields.length = 1\n\t\t\t\tthrow new Meteor.Error('error', 'field <' + require_but_empty_fields.join(\",\") + '> is required')\n\n\t\tflow = uuflowManager.getFlow(instance.flow)\n\n\t\tstep = uuflowManager.getStep(instance, flow, instance[\"traces\"][0].step)\n\n\t\t# 计算下一步骤选项\n\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"submitted\")\n\n\t\tif nextSteps.length < 1\n\t\t\tthrow new Meteor.Error('error', 'can not find next steps')\n\n\t\tif nextSteps.length > 1\n\t\t\tthrow new Meteor.Error('error', 'next step not uniq')\n\n\t\tnext_step_id = nextSteps[0]\n\n\t\t# 计算下一步处理人选项\n\t\tnext_user_ids = getHandlersManager.getHandlers(ins_id, next_step_id) || []\n\n\t\tif next_user_ids.length > 1\n\t\t\tthrow new Meteor.Error('error', 'next step handler not uniq')\n\n\t\tinstance[\"traces\"][0][\"approves\"][0][\"next_steps\"] = [{'step': next_step_id, 'users': next_user_ids}]\n\n\t\tresult = new Object\n\n\t\tsubmitter = db.users.findOne(instance.submitter)\n\n\t\tif not submitter\n\t\t\tthrow new Meteor.Error('error', 'can not find submitter')\n\n\t\tr = uuflowManager.submit_instance(instance, submitter)\n\n\t\tif r.alerts\n\t\t\tresult = r\n\t\telse\n\t\t\tresult = db.instances.findOne(ins_id)\n\t\t\tif result\n\t\t\t\tresult.attachments = cfs.instances.find({'metadata.instance': ins_id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: result}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n","\n/*\n@api {put} /api/workflow/open/submit/:ins_id 提交申请单\n\n@apiDescription 暂不支持开始节点下一节点为条件的情况\n\n@apiName submitInstance\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n */\nJsonRoutes.add('put', '/api/workflow/open/submit/:ins_id', function(req, res, next) {\n  var current_user, current_user_info, e, flow, form, ins_id, instance, nextSteps, next_step_id, next_user_ids, r, require_but_empty_fields, result, space_id, step, submitter, values;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    instance = uuflowManager.getInstance(ins_id);\n    uuflowManager.isInstanceDraft(instance);\n    if (space_id !== instance[\"space\"]) {\n      throw new Meteor.Error('error', 'instance is not belong to this space');\n    }\n    values = instance[\"traces\"][0][\"approves\"][0].values;\n    form = uuflowManager.getForm(instance.form);\n    require_but_empty_fields = uuflowManager.checkValueFieldsRequire(values, form, instance.form_version);\n    if (require_but_empty_fields.length > 0) {\n      if (require_but_empty_fields.length > 1) {\n        throw new Meteor.Error('error', 'fields <' + require_but_empty_fields.join(\",\") + '> are required');\n      } else if (require_but_empty_fields.length = 1) {\n        throw new Meteor.Error('error', 'field <' + require_but_empty_fields.join(\",\") + '> is required');\n      }\n    }\n    flow = uuflowManager.getFlow(instance.flow);\n    step = uuflowManager.getStep(instance, flow, instance[\"traces\"][0].step);\n    nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"submitted\");\n    if (nextSteps.length < 1) {\n      throw new Meteor.Error('error', 'can not find next steps');\n    }\n    if (nextSteps.length > 1) {\n      throw new Meteor.Error('error', 'next step not uniq');\n    }\n    next_step_id = nextSteps[0];\n    next_user_ids = getHandlersManager.getHandlers(ins_id, next_step_id) || [];\n    if (next_user_ids.length > 1) {\n      throw new Meteor.Error('error', 'next step handler not uniq');\n    }\n    instance[\"traces\"][0][\"approves\"][0][\"next_steps\"] = [\n      {\n        'step': next_step_id,\n        'users': next_user_ids\n      }\n    ];\n    result = new Object;\n    submitter = db.users.findOne(instance.submitter);\n    if (!submitter) {\n      throw new Meteor.Error('error', 'can not find submitter');\n    }\n    r = uuflowManager.submit_instance(instance, submitter);\n    if (r.alerts) {\n      result = r;\n    } else {\n      result = db.instances.findOne(ins_id);\n      if (result) {\n        result.attachments = cfs.instances.find({\n          'metadata.instance': ins_id,\n          'metadata.current': true,\n          \"metadata.is_private\": {\n            $ne: true\n          }\n        }, {\n          fields: {\n            copies: 0\n          }\n        }).fetch();\n      }\n    }\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\n@api {put} /api/workflow/open/save/:ins_id 暂存申请单\n\n@apiName saveInstances\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n###\nJsonRoutes.add 'put', '/api/workflow/open/save/:ins_id', (req, res, next) ->\n\ttry\n\t\tins_id = req.params.ins_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\tvalues = req.body\n\n\t\tif not values\n\t\t\tthrow new Meteor.Error('error', 'need values')\n\n\t\tcurrent_trace = null\n\t\tsetObj = new Object\n\t\tinstance = uuflowManager.getInstance(ins_id)\n\t\tflow = uuflowManager.getFlow(instance.flow)\n\n\t\t_.each instance.traces, (t)->\n\t\t\tif t.is_finished isnt true\n\t\t\t\tcurrent_trace = t\n\n\t\tcurrent_step = uuflowManager.getStep(instance, flow, current_trace.step)\n\n\t\tif current_step.step_type is \"counterSign\"\n\t\t\tthrow new Meteor.Error('error', '会签步骤不能修改表单值')\n\n\t\t_.each current_trace.approves, (a)->\n\t\t\tif a.is_finished isnt true and a.type isnt \"cc\"\n\t\t\t\ta.values = values\n\n\t\tsetObj.modified = new Date\n\t\tsetObj[\"traces.$.approves\"] = current_trace.approves\n\n\t\tdb.instances.update {\n\t\t\t_id: ins_id\n\t\t\t'traces._id': current_trace._id\n\t\t}, $set: setObj\n\n\t\tresult = new Object\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: result}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n","\n/*\n@api {put} /api/workflow/open/save/:ins_id 暂存申请单\n\n@apiName saveInstances\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n    {\n\t\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n\t}\n\n@apiSuccessExample {json} Success-Response:\n    {\n\t\t\"status\": \"success\",\n\t\t\"data\": {instance}\n\t}\n */\nJsonRoutes.add('put', '/api/workflow/open/save/:ins_id', function(req, res, next) {\n  var current_step, current_trace, current_user, current_user_info, e, flow, ins_id, instance, result, setObj, space_id, values;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    values = req.body;\n    if (!values) {\n      throw new Meteor.Error('error', 'need values');\n    }\n    current_trace = null;\n    setObj = new Object;\n    instance = uuflowManager.getInstance(ins_id);\n    flow = uuflowManager.getFlow(instance.flow);\n    _.each(instance.traces, function(t) {\n      if (t.is_finished !== true) {\n        return current_trace = t;\n      }\n    });\n    current_step = uuflowManager.getStep(instance, flow, current_trace.step);\n    if (current_step.step_type === \"counterSign\") {\n      throw new Meteor.Error('error', '会签步骤不能修改表单值');\n    }\n    _.each(current_trace.approves, function(a) {\n      if (a.is_finished !== true && a.type !== \"cc\") {\n        return a.values = values;\n      }\n    });\n    setObj.modified = new Date;\n    setObj[\"traces.$.approves\"] = current_trace.approves;\n    db.instances.update({\n      _id: ins_id,\n      'traces._id': current_trace._id\n    }, {\n      $set: setObj\n    });\n    result = new Object;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\n@api {post} /api/workflow/open/getbystepname 根据步骤名称获取申请单\n\n@apiName getInstanceByStepName\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": 流程Id,\n    \"stepname\": 步骤名称\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n\t\"status\": \"success\",\n\t\"data\": [\n\t\t{\n\t\t\tinstance\n\t\t},\n\t\t{\n\t\t\tinstance\n\t\t}\n\t]\n}\n###\nJsonRoutes.add 'post', '/api/workflow/open/getbystepname', (req, res, next) ->\n\ttry\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\thashData = req.body\n\t\tstepname = hashData[\"stepname\"]\n\t\tflow = hashData[\"flow\"]\n\n\t\tif not stepname\n\t\t\tthrow new Meteor.Error('error', 'need stepname')\n\n\t\tif not flow\n\t\t\tthrow new Meteor.Error('error', 'need flow')\n\n\t\t# 去掉{fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, traces: 0, attachments: 0}\n\t\tinstances = db.instances.find({space: space_id, flow: flow, state:'pending', traces:{$elemMatch: {is_finished: false, name: stepname}}}, {fields: {inbox_uers: 0, cc_users: 0, outbox_users: 0, attachments: 0, traces: 0}}).fetch()\n\n\t\tinstances.forEach (instance)->\n\t\t\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id,'metadata.current': true, \"metadata.is_private\": {$ne: true}}, {fields: {copies: 0}}).fetch()\n\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: instances}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n","\n/*\n@api {post} /api/workflow/open/getbystepname 根据步骤名称获取申请单\n\n@apiName getInstanceByStepName\n\n@apiGroup Workflow\n\n@apiPermission 工作区管理员\n\n@apiParam {String} access_token User API Token\n\n@apiHeader {String} X-Space-Id\t工作区Id\n\n@apiHeaderExample {json} Header-Example:\n{\n\t\"X-Space-Id\": \"wsw1re12TdeP223sC\"\n}\n\n@apiParamExample {json} Request Payload:\n{\n    \"flow\": 流程Id,\n    \"stepname\": 步骤名称\n}\n\n@apiSuccessExample {json} Success-Response:\n{\n\t\"status\": \"success\",\n\t\"data\": [\n\t\t{\n\t\t\tinstance\n\t\t},\n\t\t{\n\t\t\tinstance\n\t\t}\n\t]\n}\n */\nJsonRoutes.add('post', '/api/workflow/open/getbystepname', function(req, res, next) {\n  var current_user, current_user_info, e, flow, hashData, instances, space_id, stepname;\n  try {\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    hashData = req.body;\n    stepname = hashData[\"stepname\"];\n    flow = hashData[\"flow\"];\n    if (!stepname) {\n      throw new Meteor.Error('error', 'need stepname');\n    }\n    if (!flow) {\n      throw new Meteor.Error('error', 'need flow');\n    }\n    instances = db.instances.find({\n      space: space_id,\n      flow: flow,\n      state: 'pending',\n      traces: {\n        $elemMatch: {\n          is_finished: false,\n          name: stepname\n        }\n      }\n    }, {\n      fields: {\n        inbox_uers: 0,\n        cc_users: 0,\n        outbox_users: 0,\n        attachments: 0,\n        traces: 0\n      }\n    }).fetch();\n    instances.forEach(function(instance) {\n      return instance.attachments = cfs.instances.find({\n        'metadata.instance': instance._id,\n        'metadata.current': true,\n        \"metadata.is_private\": {\n          $ne: true\n        }\n      }, {\n        fields: {\n          copies: 0\n        }\n      }).fetch();\n    });\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: instances\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","###\nContent-Type：application/json\nform-data 格式:\nfd = new FormData;\nfd.append(\"file\", file);\n\nfd.append(\"is_private\", false);\n\nif (isAddVersion) {\n\tfd.append(\"isAddVersion\", isAddVersion);\n\tfd.append(\"parent\", attach_parent_id);\n}\n\nif (isMainAttach) {\n\tfd.append(\"main\", true);\n}\n###\n\nBusboy = require('busboy');\nFiber = require('fibers');\n\nJsonRoutes.parseFiles = (req, res, next) ->\n\tfiles = []; # Store files in an array and then pass them to request.\n\timage = {}; # crate an image object\n\n\tif (req.method == \"POST\")\n\t\tbusboy = new Busboy({ headers: req.headers });\n\t\tbusboy.on \"file\",  (fieldname, file, filename, encoding, mimetype) ->\n\t\t\timage.mimeType = mimetype;\n\t\t\timage.encoding = encoding;\n\t\t\timage.filename = filename;\n\n\t\t\t# buffer the read chunks\n\t\t\tbuffers = [];\n\n\t\t\tfile.on 'data', (data) ->\n\t\t\t\tbuffers.push(data);\n\n\t\t\tfile.on 'end', () ->\n\t\t\t\t# concat the chunks\n\t\t\t\timage.data = Buffer.concat(buffers);\n\t\t\t\t# push the image object to the file array\n\t\t\t\tfiles.push(image);\n\n\n\t\tbusboy.on \"field\", (fieldname, value) ->\n\t\t\treq.body[fieldname] = value;\n\n\t\tbusboy.on \"finish\",  () ->\n\t\t\t# Pass the file array together with the request\n\t\t\treq.files = files;\n\n\t\t\tFiber ()->\n\t\t\t\tnext();\n\t\t\t.run();\n\n\t\t# Pass request to busboy\n\t\treq.pipe(busboy);\n\n\telse\n\t\tnext();\n\nJsonRoutes.add 'post', '/api/workflow/open/cfs/:ins_id', (req, res, next) ->\n\ttry\n\t\tins_id = req.params.ins_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\tinstance = uuflowManager.getInstance(ins_id)\n\n\t\tif instance.state isnt \"draft\"\n\t\t\tthrow new Meteor.Error('error', '申请单草稿状态时才能上传')\n\n\t\tapprove_id = instance.traces[0].approves[0]._id\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\tJsonRoutes.parseFiles req, res, ()->\n\t\t\tcollection = cfs.instances\n\n\t\t\tif req.files and req.files[0]\n\t\t\t\t# 附件上传接口，限制附件大小，最大为100M\n\t\t\t\tif req.files[0].data.length > (100*1024*1024)\n\t\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\t\tcode: 200\n\t\t\t\t\t\tdata: { errors: [{errorMessage: \"超过上传附件大小限制(100M)\"}]}\n\t\t\t\t\treturn\n\n\t\t\t\tnewFile = new FS.File();\n\t\t\t\tnewFile.attachData req.files[0].data, {type: req.files[0].mimeType}, (err) ->\n\t\t\t\t\tfilename = req.files[0].filename\n\n\t\t\t\t\tif [\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())\n\t\t\t\t\t\tfilename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop()\n\n\t\t\t\t\tbody = req.body\n\n\t\t\t\t\tbody['owner'] = instance.submitter\n\t\t\t\t\tbody['owner_name'] = instance.submitter_name\n\t\t\t\t\tbody['space'] = space_id\n\t\t\t\t\tbody['instance'] = ins_id\n\t\t\t\t\tbody['approve'] = approve_id\n\n\t\t\t\t\ttry\n\t\t\t\t\t\tif body && (body['upload_from'] is \"IE\" or body['upload_from'] is \"node\")\n\t\t\t\t\t\t\tfilename = decodeURIComponent(filename)\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tconsole.error(filename)\n\t\t\t\t\t\tconsole.error e\n\t\t\t\t\t\tfilename = filename.replace(/%/g, \"-\")\n\n\t\t\t\t\tnewFile.name(filename)\n\t\t\t\t\t\n\t\t\t\t\tif body && body['owner'] && body['owner_name'] && body['space'] && body['instance']  && body['approve']\n\t\t\t\t\t\tparent = ''\n\t\t\t\t\t\tmetadata = {owner:body['owner'], owner_name:body['owner_name'], space:body['space'], instance:body['instance'], approve: body['approve'], current: true}\n\n\t\t\t\t\t\tif body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() == \"true\"\n\t\t\t\t\t\t\tmetadata.is_private = true\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tmetadata.is_private = false\n\n\t\t\t\t\t\tif body['main'] == \"true\"\n\t\t\t\t\t\t\tmetadata.main = true\n\n\t\t\t\t\t\tif body['isAddVersion'] && body['parent']\n\t\t\t\t\t\t\tparent = body['parent']\n\t\t\t\t\t\t# else\n\t\t\t\t\t\t#   collection.find({'metadata.instance': body['instance'], 'metadata.current' : true}).forEach (c) ->\n\t\t\t\t\t\t#     if c.name() == filename\n\t\t\t\t\t\t#       parent = c.metadata.parent\n\n\t\t\t\t\t\tif parent\n\t\t\t\t\t\t\tr = collection.update({'metadata.parent': parent, 'metadata.current' : true}, {$unset : {'metadata.current' : ''}})\n\t\t\t\t\t\t\tif r\n\t\t\t\t\t\t\t\tmetadata.parent = parent\n\t\t\t\t\t\t\t\tif body['locked_by'] && body['locked_by_name']\n\t\t\t\t\t\t\t\t\tmetadata.locked_by = body['locked_by']\n\t\t\t\t\t\t\t\t\tmetadata.locked_by_name = body['locked_by_name']\n\n\t\t\t\t\t\t\t\tnewFile.metadata = metadata\n\t\t\t\t\t\t\t\tfileObj = collection.insert newFile\n\n\t\t\t\t\t\t\t\t# 删除同一个申请单同一个步骤同一个人上传的重复的文件\n\t\t\t\t\t\t\t\tif body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() == \"true\"\n\t\t\t\t\t\t\t\t\tcollection.remove({'metadata.instance': body['instance'], 'metadata.parent': parent, 'metadata.owner': body['owner'], 'metadata.approve': body['approve'], 'metadata.current': {$ne: true}})\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tnewFile.metadata = metadata\n\t\t\t\t\t\t\tfileObj = collection.insert newFile\n\t\t\t\t\t\t\tfileObj.update({$set: {'metadata.parent' : fileObj._id}})\n\n\t\t\t\t\t# 兼容老版本\n\t\t\t\t\telse\n\t\t\t\t\t\tfileObj = collection.insert newFile\n\n\t\t\t\t\tsize = fileObj.original.size\n\t\t\t\t\tif !size\n\t\t\t\t\t\tsize = 1024\n\n\t\t\t\t\tresult = new Object\n\t\t\t\t\tresult =\n\t\t\t\t\t\tattach_id: fileObj._id,\n\t\t\t\t\t\tsize: size\n\n\t\t\t\t\tres.setHeader(\"x-amz-version-id\",fileObj._id);\n\n\t\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\t\tcode: 200\n\t\t\t\t\t\tdata: { status: \"success\", data: result}\n\t\t\telse\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tcode: 200\n\t\t\t\t\tdata: { errors: [{errorMessage: \"need file\"}]}\n\t\t\t\treturn\n\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n\nJsonRoutes.add \"delete\", \"/api/workflow/open/cfs/:ins_id\",  (req, res, next) ->\n\ttry\n\t\tins_id = req.params.ins_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\tinstance = uuflowManager.getInstance(ins_id)\n\n\t\tif instance.state isnt \"draft\"\n\t\t\tthrow new Meteor.Error('error', '申请单草稿状态时才能删除附件')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\thashData = req.body || {}\n\t\tattach_id = hashData[\"attach_id\"]\n\n\t\tif not attach_id\n\t\t\tthrow new Meteor.Error('error', 'can not find attach_id')\n\n\t\tcollection = cfs.instances\n\n\t\tfile = collection.findOne({ _id: attach_id, 'metadata.instance': ins_id})\n\t\tif file\n\t\t\tfile.remove()\n\t\telse\n\t\t\tthrow new Meteor.Error('error', '此附件不属于此申请单，或已被删除')\n\n\t\tresult = new Object\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { status: \"success\", data: result}\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n\nJsonRoutes.add \"get\", \"/api/workflow/open/cfs/:attach_id\",  (req, res, next) ->\n\ttry\n\t\tattach_id = req.params.attach_id\n\n\t\tif !Steedos.APIAuthenticationCheck(req, res)\n\t\t\treturn ;\n\n\t\tcurrent_user = req.userId\n\n\t\tspace_id = req.headers['x-space-id']\n\n\t\tif not space_id\n\t\t\tthrow new Meteor.Error('error', 'need header X_Space_Id')\n\n\t\tcurrent_user_info = db.users.findOne(current_user)\n\n\t\tif not current_user_info\n\t\t\tthrow new Meteor.Error('error', 'can not find user')\n\n\t\t# 校验space是否存在\n\t\tuuflowManager.getSpace(space_id)\n\t\t# 校验当前登录用户是否是space的管理员\n\t\tuuflowManager.isSpaceAdmin(space_id, current_user)\n\n\t\tres.statusCode = 302\n\t\tres.setHeader \"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + attach_id + \"?download=true\"\n\t\tres.end()\n\tcatch e\n\t\tconsole.error e.stack\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 200\n\t\t\tdata: { errors: [{errorMessage: e.message}]}\n","\n/*\nContent-Type：application/json\nform-data 格式:\nfd = new FormData;\nfd.append(\"file\", file);\n\nfd.append(\"is_private\", false);\n\nif (isAddVersion) {\n\tfd.append(\"isAddVersion\", isAddVersion);\n\tfd.append(\"parent\", attach_parent_id);\n}\n\nif (isMainAttach) {\n\tfd.append(\"main\", true);\n}\n */\nvar Busboy, Fiber;\n\nBusboy = require('busboy');\n\nFiber = require('fibers');\n\nJsonRoutes.parseFiles = function(req, res, next) {\n  var busboy, files, image;\n  files = [];\n  image = {};\n  if (req.method === \"POST\") {\n    busboy = new Busboy({\n      headers: req.headers\n    });\n    busboy.on(\"file\", function(fieldname, file, filename, encoding, mimetype) {\n      var buffers;\n      image.mimeType = mimetype;\n      image.encoding = encoding;\n      image.filename = filename;\n      buffers = [];\n      file.on('data', function(data) {\n        return buffers.push(data);\n      });\n      return file.on('end', function() {\n        image.data = Buffer.concat(buffers);\n        return files.push(image);\n      });\n    });\n    busboy.on(\"field\", function(fieldname, value) {\n      return req.body[fieldname] = value;\n    });\n    busboy.on(\"finish\", function() {\n      req.files = files;\n      return Fiber(function() {\n        return next();\n      }).run();\n    });\n    return req.pipe(busboy);\n  } else {\n    return next();\n  }\n};\n\nJsonRoutes.add('post', '/api/workflow/open/cfs/:ins_id', function(req, res, next) {\n  var approve_id, current_user, current_user_info, e, ins_id, instance, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    instance = uuflowManager.getInstance(ins_id);\n    if (instance.state !== \"draft\") {\n      throw new Meteor.Error('error', '申请单草稿状态时才能上传');\n    }\n    approve_id = instance.traces[0].approves[0]._id;\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    return JsonRoutes.parseFiles(req, res, function() {\n      var collection, newFile;\n      collection = cfs.instances;\n      if (req.files && req.files[0]) {\n        if (req.files[0].data.length > (100 * 1024 * 1024)) {\n          JsonRoutes.sendResult(res, {\n            code: 200,\n            data: {\n              errors: [\n                {\n                  errorMessage: \"超过上传附件大小限制(100M)\"\n                }\n              ]\n            }\n          });\n          return;\n        }\n        newFile = new FS.File();\n        return newFile.attachData(req.files[0].data, {\n          type: req.files[0].mimeType\n        }, function(err) {\n          var body, e, fileObj, filename, metadata, parent, r, result, size;\n          filename = req.files[0].filename;\n          if ([\"image.jpg\", \"image.gif\", \"image.jpeg\", \"image.png\"].includes(filename.toLowerCase())) {\n            filename = \"image-\" + moment(new Date()).format('YYYYMMDDHHmmss') + \".\" + filename.split('.').pop();\n          }\n          body = req.body;\n          body['owner'] = instance.submitter;\n          body['owner_name'] = instance.submitter_name;\n          body['space'] = space_id;\n          body['instance'] = ins_id;\n          body['approve'] = approve_id;\n          try {\n            if (body && (body['upload_from'] === \"IE\" || body['upload_from'] === \"node\")) {\n              filename = decodeURIComponent(filename);\n            }\n          } catch (error) {\n            e = error;\n            console.error(filename);\n            console.error(e);\n            filename = filename.replace(/%/g, \"-\");\n          }\n          newFile.name(filename);\n          if (body && body['owner'] && body['owner_name'] && body['space'] && body['instance'] && body['approve']) {\n            parent = '';\n            metadata = {\n              owner: body['owner'],\n              owner_name: body['owner_name'],\n              space: body['space'],\n              instance: body['instance'],\n              approve: body['approve'],\n              current: true\n            };\n            if (body[\"is_private\"] && body[\"is_private\"].toLocaleLowerCase() === \"true\") {\n              metadata.is_private = true;\n            } else {\n              metadata.is_private = false;\n            }\n            if (body['main'] === \"true\") {\n              metadata.main = true;\n            }\n            if (body['isAddVersion'] && body['parent']) {\n              parent = body['parent'];\n            }\n            if (parent) {\n              r = collection.update({\n                'metadata.parent': parent,\n                'metadata.current': true\n              }, {\n                $unset: {\n                  'metadata.current': ''\n                }\n              });\n              if (r) {\n                metadata.parent = parent;\n                if (body['locked_by'] && body['locked_by_name']) {\n                  metadata.locked_by = body['locked_by'];\n                  metadata.locked_by_name = body['locked_by_name'];\n                }\n                newFile.metadata = metadata;\n                fileObj = collection.insert(newFile);\n                if (body[\"overwrite\"] && body[\"overwrite\"].toLocaleLowerCase() === \"true\") {\n                  collection.remove({\n                    'metadata.instance': body['instance'],\n                    'metadata.parent': parent,\n                    'metadata.owner': body['owner'],\n                    'metadata.approve': body['approve'],\n                    'metadata.current': {\n                      $ne: true\n                    }\n                  });\n                }\n              }\n            } else {\n              newFile.metadata = metadata;\n              fileObj = collection.insert(newFile);\n              fileObj.update({\n                $set: {\n                  'metadata.parent': fileObj._id\n                }\n              });\n            }\n          } else {\n            fileObj = collection.insert(newFile);\n          }\n          size = fileObj.original.size;\n          if (!size) {\n            size = 1024;\n          }\n          result = new Object;\n          result = {\n            attach_id: fileObj._id,\n            size: size\n          };\n          res.setHeader(\"x-amz-version-id\", fileObj._id);\n          return JsonRoutes.sendResult(res, {\n            code: 200,\n            data: {\n              status: \"success\",\n              data: result\n            }\n          });\n        });\n      } else {\n        JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            errors: [\n              {\n                errorMessage: \"need file\"\n              }\n            ]\n          }\n        });\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n\nJsonRoutes.add(\"delete\", \"/api/workflow/open/cfs/:ins_id\", function(req, res, next) {\n  var attach_id, collection, current_user, current_user_info, e, file, hashData, ins_id, instance, result, space_id;\n  try {\n    ins_id = req.params.ins_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    instance = uuflowManager.getInstance(ins_id);\n    if (instance.state !== \"draft\") {\n      throw new Meteor.Error('error', '申请单草稿状态时才能删除附件');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    hashData = req.body || {};\n    attach_id = hashData[\"attach_id\"];\n    if (!attach_id) {\n      throw new Meteor.Error('error', 'can not find attach_id');\n    }\n    collection = cfs.instances;\n    file = collection.findOne({\n      _id: attach_id,\n      'metadata.instance': ins_id\n    });\n    if (file) {\n      file.remove();\n    } else {\n      throw new Meteor.Error('error', '此附件不属于此申请单，或已被删除');\n    }\n    result = new Object;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        status: \"success\",\n        data: result\n      }\n    });\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n\nJsonRoutes.add(\"get\", \"/api/workflow/open/cfs/:attach_id\", function(req, res, next) {\n  var attach_id, current_user, current_user_info, e, space_id;\n  try {\n    attach_id = req.params.attach_id;\n    if (!Steedos.APIAuthenticationCheck(req, res)) {\n      return;\n    }\n    current_user = req.userId;\n    space_id = req.headers['x-space-id'];\n    if (!space_id) {\n      throw new Meteor.Error('error', 'need header X_Space_Id');\n    }\n    current_user_info = db.users.findOne(current_user);\n    if (!current_user_info) {\n      throw new Meteor.Error('error', 'can not find user');\n    }\n    uuflowManager.getSpace(space_id);\n    uuflowManager.isSpaceAdmin(space_id, current_user);\n    res.statusCode = 302;\n    res.setHeader(\"Location\", Steedos.absoluteUrl(\"api/files/instances/\") + attach_id + \"?download=true\");\n    return res.end();\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [\n          {\n            errorMessage: e.message\n          }\n        ]\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/forward_refill\", (req, res, next) ->\n\tconsole.log \"=========回填子表==========\"\n\tconsole.log \"req?.query?.subTable\",req?.query?.subTable\n\tconsole.log \"=========分发回填的列==========\"\n\tconsole.log \"req?.query?.column\",req?.query?.column\n\n\tcolumns = req?.query?.column.split(';')\n\tconsole.log \"columns\",columns\n\n\n\t# 分发的申请单\n\tforward_ins = req?.body?.instance\n\n\tsubTable = req?.query?.subTable\n\n\tif forward_ins?.state == \"completed\" && forward_ins?.distribute_from_instances?.length>0 && subTable && columns\n\t\t\n\t\t# 分发回来的值\n\t\tforward_ins_values = forward_ins?.values\n\n\t\t# # 原申请单字段\n\t\toriginal_ins_id = _.last forward_ins?.distribute_from_instances\n\t\toriginal_ins = db.instances.findOne(original_ins_id)\n\t\toriginal_ins_form = db.forms.findOne(original_ins?.form)\n\n\t\toriginal_ins_fields = []\n\t\toriginal_subtable_fields = []\n\n\t\tconsole.log \"original_ins_form?.current?._id\",original_ins_form?.current?._id\n\t\tconsole.log \"original_ins?.form_version\",original_ins?.form_version\n\n\t\t# 查看原申请单是否有对应的子表\n\t\tif original_ins?.form_version == original_ins_form?.current?._id\n\t\t\toriginal_ins_fields = original_ins_form.current?.fields\n\t\t\toriginal_ins_fields.forEach (original_ins_field)->\n\t\t\t\tconsole.log \"original_ins_field\",original_ins_field?.code\n\t\t\t\tif original_ins_field?.code == subTable && original_ins_field?.type == 'table'\n\t\t\t\t\toriginal_subtable_fields = original_ins_field?.fields\n\t\telse\n\t\t\tif original_ins_form?.historys?.length > 0\n\t\t\t\toriginal_ins_form.historys.forEach (oh)->\n\t\t\t\t\tif original_ins?.form_version == oh._id\n\t\t\t\t\t\toriginal_ins_fields = oh?.fields\n\t\t\t\t\t\toriginal_ins_fields.forEach (original_ins_field)->\n\t\t\t\t\t\t\tif original_ins_field?.code == subTable && original_ins_field?.type == 'table'\n\t\t\t\t\t\t\t\toriginal_subtable_fields = original_ins_field?.fields\n\n\t\tconsole.log \"original_subtable_fields\",original_subtable_fields?.length\n\n\t\tif original_subtable_fields\n\t\t\t# # 更新步骤的值\n\t\t\t# 1.找到当前的步骤\n\t\t\t# 2.当前步骤中approves中的values\n\t\t\t# 3.在values中找到表格\n\t\t\t# 4.根据表格的fields属性，一个个的赋值\n\t\t\t# 5.把复制的push到表格数组的后面\n\t\t\ttraces = original_ins?.traces\n\n\t\t\ttrace = traces[traces.length-1]\n\n\t\t\tapprove = trace?.approves[0]\n\n\t\t\ttable_data = approve?.values[subTable] || []\n\n\t\t\trow_data = {}\n\n\t\t\tcolumns.forEach (column)->\n\t\t\t\trow_data[column] = forward_ins_values[column] || \"\"\n\t\t\t\n\t\t\t\n\t\t\tif row_data && row_data != {}\n\t\t\t\ttable_data.push row_data\n\t\t\t\ttraces[traces.length-1].approves[0].values[subTable] = table_data\n\n\t\t\t\tconsole.log traces[traces.length-1].approves[0].values[subTable]\n\n\t\t\t\tdb.instances.update(original_ins_id,{\n\t\t\t\t\t$set:{\n\t\t\t\t\t\t'traces':traces\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\t\tcode: 200,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\t'success': '回填成功'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\telse\n\t\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\t\tcode: 200,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\t'info': '回填数据为空'\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\telse\n\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\tcode: 200,\n\t\t\t\tdata: {\n\t\t\t\t\t'error': '原申请单无相关子表'\n\t\t\t\t}\n\t\t\t}\n\telse\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'success': '申请单未结束'\n\t\t\t}\n\t\t}\n)","JsonRoutes.add(\"post\", \"/api/workflow/forward_refill\", function(req, res, next) {\n  var approve, columns, forward_ins, forward_ins_values, original_ins, original_ins_fields, original_ins_form, original_ins_id, original_subtable_fields, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, row_data, subTable, table_data, trace, traces;\n  console.log(\"=========回填子表==========\");\n  console.log(\"req?.query?.subTable\", req != null ? (ref = req.query) != null ? ref.subTable : void 0 : void 0);\n  console.log(\"=========分发回填的列==========\");\n  console.log(\"req?.query?.column\", req != null ? (ref1 = req.query) != null ? ref1.column : void 0 : void 0);\n  columns = req != null ? (ref2 = req.query) != null ? ref2.column.split(';') : void 0 : void 0;\n  console.log(\"columns\", columns);\n  forward_ins = req != null ? (ref3 = req.body) != null ? ref3.instance : void 0 : void 0;\n  subTable = req != null ? (ref4 = req.query) != null ? ref4.subTable : void 0 : void 0;\n  if ((forward_ins != null ? forward_ins.state : void 0) === \"completed\" && (forward_ins != null ? (ref5 = forward_ins.distribute_from_instances) != null ? ref5.length : void 0 : void 0) > 0 && subTable && columns) {\n    forward_ins_values = forward_ins != null ? forward_ins.values : void 0;\n    original_ins_id = _.last(forward_ins != null ? forward_ins.distribute_from_instances : void 0);\n    original_ins = db.instances.findOne(original_ins_id);\n    original_ins_form = db.forms.findOne(original_ins != null ? original_ins.form : void 0);\n    original_ins_fields = [];\n    original_subtable_fields = [];\n    console.log(\"original_ins_form?.current?._id\", original_ins_form != null ? (ref6 = original_ins_form.current) != null ? ref6._id : void 0 : void 0);\n    console.log(\"original_ins?.form_version\", original_ins != null ? original_ins.form_version : void 0);\n    if ((original_ins != null ? original_ins.form_version : void 0) === (original_ins_form != null ? (ref7 = original_ins_form.current) != null ? ref7._id : void 0 : void 0)) {\n      original_ins_fields = (ref8 = original_ins_form.current) != null ? ref8.fields : void 0;\n      original_ins_fields.forEach(function(original_ins_field) {\n        console.log(\"original_ins_field\", original_ins_field != null ? original_ins_field.code : void 0);\n        if ((original_ins_field != null ? original_ins_field.code : void 0) === subTable && (original_ins_field != null ? original_ins_field.type : void 0) === 'table') {\n          return original_subtable_fields = original_ins_field != null ? original_ins_field.fields : void 0;\n        }\n      });\n    } else {\n      if ((original_ins_form != null ? (ref9 = original_ins_form.historys) != null ? ref9.length : void 0 : void 0) > 0) {\n        original_ins_form.historys.forEach(function(oh) {\n          if ((original_ins != null ? original_ins.form_version : void 0) === oh._id) {\n            original_ins_fields = oh != null ? oh.fields : void 0;\n            return original_ins_fields.forEach(function(original_ins_field) {\n              if ((original_ins_field != null ? original_ins_field.code : void 0) === subTable && (original_ins_field != null ? original_ins_field.type : void 0) === 'table') {\n                return original_subtable_fields = original_ins_field != null ? original_ins_field.fields : void 0;\n              }\n            });\n          }\n        });\n      }\n    }\n    console.log(\"original_subtable_fields\", original_subtable_fields != null ? original_subtable_fields.length : void 0);\n    if (original_subtable_fields) {\n      traces = original_ins != null ? original_ins.traces : void 0;\n      trace = traces[traces.length - 1];\n      approve = trace != null ? trace.approves[0] : void 0;\n      table_data = (approve != null ? approve.values[subTable] : void 0) || [];\n      row_data = {};\n      columns.forEach(function(column) {\n        return row_data[column] = forward_ins_values[column] || \"\";\n      });\n      if (row_data && row_data !== {}) {\n        table_data.push(row_data);\n        traces[traces.length - 1].approves[0].values[subTable] = table_data;\n        console.log(traces[traces.length - 1].approves[0].values[subTable]);\n        db.instances.update(original_ins_id, {\n          $set: {\n            'traces': traces\n          }\n        });\n        return JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            'success': '回填成功'\n          }\n        });\n      } else {\n        return JsonRoutes.sendResult(res, {\n          code: 200,\n          data: {\n            'info': '回填数据为空'\n          }\n        });\n      }\n    } else {\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'error': '原申请单无相关子表'\n        }\n      });\n    }\n  } else {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'success': '申请单未结束'\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/forward_table_refill\", (req, res, next) ->\n\ttry\n\t\tconsole.log \"=========原表子表==========\"\n\t\tconsole.log \"req?.query?.oTable\",req?.query?.oTable\n\t\tconsole.log \"=========现表子表==========\"\n\t\tconsole.log \"req?.query?.dTable\",req?.query?.dTable\n\t\tconsole.log \"=========原表单的子表匹配列==========\"\n\t\tconsole.log \"req?.query?.oMatchCol\",req?.query?.oMatchCol\n\t\tconsole.log \"=========现表单的子表匹配列==========\"\n\t\tconsole.log \"req?.query?.dMatchCol\",req?.query?.dMatchCol\n\t\tconsole.log \"=========需要回填的列==========\"\t\n\t\tconsole.log \"req?.query?.refillCol\",req?.query?.refillCol\n\n\t\t# 分发的申请单\n\t\td_ins = req?.body?.instance\n\n\t\t\n\t\tif d_ins?.state == \"completed\"\n\t\t\tif req?.query?.oTable\n\t\t\t\to_table = req?.query?.oTable\n\t\t\t\tif req?.query?.dTable\n\t\t\t\t\td_table = req?.query?.dTable\n\t\t\t\telse\n\t\t\t\t\td_table = o_table\n\t\t\t\tif req?.query?.aTable\n\t\t\t\t\ta_table = req?.query?.aTable\n\t\t\t\tif req?.query?.oMatchCol\n\t\t\t\t\to_match_col = req?.query?.oMatchCol\n\t\t\t\t\tif req?.query?.dMatchCol\n\t\t\t\t\t\td_match_col = req?.query?.dMatchCol\n\t\t\t\t\telse\n\t\t\t\t\t\td_match_col = o_match_col\n\t\t\t\t\tcolumns = req?.query?.refillCol.split(';') || []\n\t\t\t\t\tconsole.log \"columns\",columns\t\t\t\t\t\n\n\t\t\t\t\tif columns || columns.length<1\n\t\t\t\t\t\tconsole.log \"======================\"\n\t\t\t\t\t\tconsole.log d_table, o_match_col, columns\n\n\t\t\t\t\t\t# 分发回来的值\n\t\t\t\t\t\td_ins_values = d_ins?.values\n\n\t\t\t\t\t\t# 原申请单 form 表字段\n\t\t\t\t\t\to_ins_id = _.last d_ins?.distribute_from_instances\n\t\t\t\t\t\to_ins = db.instances.findOne(o_ins_id)\n\t\t\t\t\t\to_ins_form = db.forms.findOne(o_ins?.form)\n\n\t\t\t\t\t\td_ins_form = db.forms.findOne(d_ins?.form)\n\n\t\t\t\t\t\t# 原申请单的 fields\n\t\t\t\t\t\to_ins_fields = []\n\n\t\t\t\t\t\t# 原子表字段\n\t\t\t\t\t\to_subtable_fields = []\n\n\t\t\t\t\t\t# 分发申请单的 fields\n\t\t\t\t\t\td_ins_fields = []\n\t\t\t\t\t\t# 现申请单字表字段\n\t\t\t\t\t\td_subtable_fields = []\n\n\t\t\t\t\t\t# 赋值对应的字段\n\t\t\t\t\t\tcolumn_list = []\n\n\t\t\t\t\t\t\n\t\t\t\t\t\t# 分发后申请单的 子表值\n\t\t\t\t\t\td_table_values = []\n\n\t\t\t\t\t\t# 查看原申请单是否有对应的子表\n\t\t\t\t\t\tif o_ins?.form_version == o_ins_form?.current?._id\n\t\t\t\t\t\t\to_ins_fields = o_ins_form?.current?.fields\n\t\t\t\t\t\t\to_ins_fields.forEach (o_ins_field)->\n\t\t\t\t\t\t\t\tif o_ins_field?.type == 'table' && o_ins_field?.code == o_table\n\t\t\t\t\t\t\t\t\to_subtable_fields = o_ins_field?.fields\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tif o_ins_form?.historys?.length > 0\n\t\t\t\t\t\t\t\to_ins_form.historys.forEach (oh)->\n\t\t\t\t\t\t\t\t\tif o_ins?.form_version == oh._id\n\t\t\t\t\t\t\t\t\t\to_ins_fields = oh?.fields\n\t\t\t\t\t\t\t\t\t\to_ins_fields.forEach (o_ins_field)->\n\t\t\t\t\t\t\t\t\t\t\tif o_ins_field?.type == 'table' && o_ins_field?.code == o_table\n\t\t\t\t\t\t\t\t\t\t\t\to_subtable_fields = o_ins_field?.fields\n\t\t\t\t\t\t\n\t\t\t\t\t\t# 查看分发的申请单是否有对应的字表\n\t\t\t\t\t\tif d_ins?.form_version == d_ins_form?.current?._id\n\t\t\t\t\t\t\td_ins_fields = d_ins_form?.current?.fields\n\t\t\t\t\t\t\td_ins_fields.forEach (d_ins_field)->\n\t\t\t\t\t\t\t\tif((d_ins_field?.type == 'table' && d_ins_field?.code == d_table)||(a_table && d_ins_field?.type == 'table' && d_ins_field?.code == a_table))\n\t\t\t\t\t\t\t\t\td_subtable_fields = d_subtable_fields.concat d_ins_field?.fields\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tif d_ins_form?.historys?.length > 0\n\t\t\t\t\t\t\t\td_ins_form.historys.forEach (dh)->\n\t\t\t\t\t\t\t\t\tif d_ins?.form_version == dh._id\n\t\t\t\t\t\t\t\t\t\td_ins_fields = dh?.fields\n\t\t\t\t\t\t\t\t\t\td_ins_fields.forEach (d_ins_field)->\n\t\t\t\t\t\t\t\t\t\t\tif((d_ins_field?.type == 'table' && d_ins_field?.code == d_table)||(a_table && d_ins_field?.type == 'table' && d_ins_field?.code == a_table))\n\t\t\t\t\t\t\t\t\t\t\t\td_subtable_fields = d_subtable_fields.concat d_ins_field?.fields\n\t\t\t\t\t\t\n\n\t\t\t\t\t\t\n\n\t\t\t\t\t\tif o_subtable_fields.length == 0\n\t\t\t\t\t\t\tconsole.log \"o_subtable_fields\",o_subtable_fields\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '原申请单无对应子表');\n\t\t\t\t\t\t\n\t\t\t\t\t\tif d_subtable_fields.length == 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '分发的申请单无对应子表');\n\n\t\t\t\t\t\td_table_values = d_ins?.values[d_table] || []\n\n\t\t\t\t\t\t\n\t\t\t\t\t\tif a_table\n\t\t\t\t\t\t\ta_table_values =  d_ins?.values[a_table] || []\n\t\t\t\t\t\t\tif a_table_values && a_table_values?.length==d_table_values?.length\n\t\t\t\t\t\t\t\ta_table_values.forEach (a_row,index)->\n\t\t\t\t\t\t\t\t\td_table_values[index][key] = value for key,value of a_row\n\n\t\t\t\t\t\tif d_table_values.length == 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '分发的申请单子表数据为空');\n\t\t\t\t\t\t\n\t\t\t\t\t\to_match_col_fields = o_subtable_fields.filter((m)->return m.code==o_match_col)\n\t\t\t\t\t\td_match_col_fields = d_subtable_fields.filter((m)->return m.code==d_match_col)\n\n\t\t\t\t\t\t# 匹配列判断\n\t\t\t\t\t\tif o_match_col_fields.length == 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '原申请单子表无对应匹配列');\n\n\t\t\t\t\t\tif d_match_col_fields.length == 0\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '分发的申请单子表无对应匹配列');\n\n\t\t\t\t\t\t# 判断匹配列字段的值类型是否一致\n\t\t\t\t\t\to_match_col_field = o_match_col_fields[0]\n\t\t\t\t\t\td_match_col_field = d_match_col_fields[0]\n\n\t\t\t\t\t\tif o_match_col_field?.type != d_match_col_field?.type\n\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '分发的申请单和原申请单子表的匹配列字段不一致');\n\n\t\t\t\t\t\t# 回填列判断\n\t\t\t\t\t\tcolumns.forEach (column)->\n\t\t\t\t\t\t\tcols = column.split('-') || []\n\t\t\t\t\t\t\tif cols.length == 2\n\t\t\t\t\t\t\t\to_col = cols[0]\n\t\t\t\t\t\t\t\td_col = cols[1]\n\t\t\t\t\t\t\t\to_col_fields = o_subtable_fields.filter((m)->return m.code==o_col)\n\t\t\t\t\t\t\t\td_col_fields = d_subtable_fields.filter((m)->return m.code==d_col)\n\n\t\t\t\t\t\t\t\t# 判断是否有对应的回填列\n\t\t\t\t\t\t\t\tif o_col_fields.length == 0\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '原申请单子表无对应回填列');\n\n\t\t\t\t\t\t\t\tif d_col_fields.length == 0\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '分发的申请单子表无对应回填列');\n\n\t\t\t\t\t\t\t\t# 判断匹配列字段的值类型是否一致\n\t\t\t\t\t\t\t\tif o_col_fields?.type != d_col_fields?.type\n\t\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '回填列字段类型不一致');\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tcol = {\n\t\t\t\t\t\t\t\t\to_col: o_col,\n\t\t\t\t\t\t\t\t\td_col: d_col\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tcolumn_list.push col\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', '回填列不匹配');\n\t\t\t\t\t\t\n\t\t\t\t\t\t# 赋值\n\t\t\t\t\t\t# console.log  '======column_list=======',column_list\n\n\t\t\t\t\t\ttraces = o_ins?.traces\n\n\t\t\t\t\t\t# 原申请单的 step \n\t\t\t\t\t\ttrace = traces[traces.length-1]\n\n\t\t\t\t\t\t# 原申请单的当前步骤\n\t\t\t\t\t\tapprove = trace?.approves[0]\n\n\t\t\t\t\t\t# 元申请单的当前 value 的 子表\n\t\t\t\t\t\ttable_data = approve?.values[o_table] || []\n\n\n\t\t\t\t\t\t# 根据 column_list 赋值对应字段进行赋值\n\t\t\t\t\t\t# 循环分发申请单的每行\n\t\t\t\t\t\td_table_values.forEach (d_row)->\n\t\t\t\t\t\t\t# console.log \"d_row\",d_row\n\t\t\t\t\t\t\t# 查找匹配的列是否与当前的匹配列一致\n\t\t\t\t\t\t\thas_obj = false\n\t\t\t\t\t\t\tcount = -1\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t# 看原子表是否有该匹配列\n\t\t\t\t\t\t\ttable_data.forEach (o_row, index)->\n\t\t\t\t\t\t\t\t# console.log \"o_row\", o_row\n\t\t\t\t\t\t\t\t# console.log \"index\",index\n\t\t\t\t\t\t\t\t# console.log \"o_row[o_match_col]\",o_row[o_match_col]\n\t\t\t\t\t\t\t\t# console.log \"d_row[d_match_col]\",d_row[d_match_col]\n\t\t\t\t\t\t\t\t# console.log \"o_row[o_match_col] == d_row[d_match_col]\",o_row[o_match_col] == d_row[d_match_col]\n\n\t\t\t\t\t\t\t\tif o_row[o_match_col] == d_row[d_match_col]\n\t\t\t\t\t\t\t\t\thas_obj = true\n\t\t\t\t\t\t\t\t\tcount = index\n\n\t\t\t\t\t\t\t# 原申请单的匹配字段有值\n\t\t\t\t\t\t\t# console.log \"has_obj\",has_obj\n\t\t\t\t\t\t\tif has_obj==true\n\t\t\t\t\t\t\t\tcolumn_list.forEach (col)->\n\t\t\t\t\t\t\t\t\ttable_data[count][col?.o_col] = d_row[col?.d_col]\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\trow_data = {}\n\t\t\t\t\t\t\t\trow_data[o_match_col] = d_row[d_match_col]\n\t\t\t\t\t\t\t\tcolumn_list.forEach (col)->\n\t\t\t\t\t\t\t\t\trow_data[col?.o_col] = d_row[col?.d_col]\n\t\t\t\t\t\t\t\ttable_data.push row_data\n\n\t\t\t\t\t\t\n\t\t\t\t\t\ttraces[traces.length-1].approves[0].values = o_ins?.values\n\t\t\t\t\t\ttraces[traces.length-1].approves[0].values[o_table] = table_data\n\n\t\t\t\t\t\tdb.instances.update(o_ins_id,{\n\t\t\t\t\t\t\t$set:{\n\t\t\t\t\t\t\t\t'traces':traces\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\n\t\t\t\t\t\tJsonRoutes.sendResult res, {\n\t\t\t\t\t\t\tcode: 200,\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t'success': '回填成功'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn\n\t\t\t\t\telse\n\t\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhook未配置子表回填列字段 columns 值');\n\t\t\t\telse\n\t\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhook未配置匹配列字段 oMatchCol 值');\n\t\t\telse\n\t\t\t\tthrow new Meteor.Error('forward table refill error!', 'webhook未配置原表单子表 oTable 值');\n\t\telse\n\t\t\tthrow new Meteor.Error('forward table refill error!', '申请单未结束');\n\tcatch e\n\t\tJsonRoutes.sendResult res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\terrors: [e]\n\t\t\t}\n\t\t}\n)","JsonRoutes.add(\"post\", \"/api/workflow/forward_table_refill\", function(req, res, next) {\n  var a_table, a_table_values, approve, column_list, columns, d_ins, d_ins_fields, d_ins_form, d_ins_values, d_match_col, d_match_col_field, d_match_col_fields, d_subtable_fields, d_table, d_table_values, e, o_ins, o_ins_fields, o_ins_form, o_ins_id, o_match_col, o_match_col_field, o_match_col_fields, o_subtable_fields, o_table, ref, ref1, ref10, ref11, ref12, ref13, ref14, ref15, ref16, ref17, ref18, ref19, ref2, ref20, ref21, ref22, ref3, ref4, ref5, ref6, ref7, ref8, ref9, table_data, trace, traces;\n  try {\n    console.log(\"=========原表子表==========\");\n    console.log(\"req?.query?.oTable\", req != null ? (ref = req.query) != null ? ref.oTable : void 0 : void 0);\n    console.log(\"=========现表子表==========\");\n    console.log(\"req?.query?.dTable\", req != null ? (ref1 = req.query) != null ? ref1.dTable : void 0 : void 0);\n    console.log(\"=========原表单的子表匹配列==========\");\n    console.log(\"req?.query?.oMatchCol\", req != null ? (ref2 = req.query) != null ? ref2.oMatchCol : void 0 : void 0);\n    console.log(\"=========现表单的子表匹配列==========\");\n    console.log(\"req?.query?.dMatchCol\", req != null ? (ref3 = req.query) != null ? ref3.dMatchCol : void 0 : void 0);\n    console.log(\"=========需要回填的列==========\");\n    console.log(\"req?.query?.refillCol\", req != null ? (ref4 = req.query) != null ? ref4.refillCol : void 0 : void 0);\n    d_ins = req != null ? (ref5 = req.body) != null ? ref5.instance : void 0 : void 0;\n    if ((d_ins != null ? d_ins.state : void 0) === \"completed\") {\n      if (req != null ? (ref6 = req.query) != null ? ref6.oTable : void 0 : void 0) {\n        o_table = req != null ? (ref7 = req.query) != null ? ref7.oTable : void 0 : void 0;\n        if (req != null ? (ref8 = req.query) != null ? ref8.dTable : void 0 : void 0) {\n          d_table = req != null ? (ref9 = req.query) != null ? ref9.dTable : void 0 : void 0;\n        } else {\n          d_table = o_table;\n        }\n        if (req != null ? (ref10 = req.query) != null ? ref10.aTable : void 0 : void 0) {\n          a_table = req != null ? (ref11 = req.query) != null ? ref11.aTable : void 0 : void 0;\n        }\n        if (req != null ? (ref12 = req.query) != null ? ref12.oMatchCol : void 0 : void 0) {\n          o_match_col = req != null ? (ref13 = req.query) != null ? ref13.oMatchCol : void 0 : void 0;\n          if (req != null ? (ref14 = req.query) != null ? ref14.dMatchCol : void 0 : void 0) {\n            d_match_col = req != null ? (ref15 = req.query) != null ? ref15.dMatchCol : void 0 : void 0;\n          } else {\n            d_match_col = o_match_col;\n          }\n          columns = (req != null ? (ref16 = req.query) != null ? ref16.refillCol.split(';') : void 0 : void 0) || [];\n          console.log(\"columns\", columns);\n          if (columns || columns.length < 1) {\n            console.log(\"======================\");\n            console.log(d_table, o_match_col, columns);\n            d_ins_values = d_ins != null ? d_ins.values : void 0;\n            o_ins_id = _.last(d_ins != null ? d_ins.distribute_from_instances : void 0);\n            o_ins = db.instances.findOne(o_ins_id);\n            o_ins_form = db.forms.findOne(o_ins != null ? o_ins.form : void 0);\n            d_ins_form = db.forms.findOne(d_ins != null ? d_ins.form : void 0);\n            o_ins_fields = [];\n            o_subtable_fields = [];\n            d_ins_fields = [];\n            d_subtable_fields = [];\n            column_list = [];\n            d_table_values = [];\n            if ((o_ins != null ? o_ins.form_version : void 0) === (o_ins_form != null ? (ref17 = o_ins_form.current) != null ? ref17._id : void 0 : void 0)) {\n              o_ins_fields = o_ins_form != null ? (ref18 = o_ins_form.current) != null ? ref18.fields : void 0 : void 0;\n              o_ins_fields.forEach(function(o_ins_field) {\n                if ((o_ins_field != null ? o_ins_field.type : void 0) === 'table' && (o_ins_field != null ? o_ins_field.code : void 0) === o_table) {\n                  return o_subtable_fields = o_ins_field != null ? o_ins_field.fields : void 0;\n                }\n              });\n            } else {\n              if ((o_ins_form != null ? (ref19 = o_ins_form.historys) != null ? ref19.length : void 0 : void 0) > 0) {\n                o_ins_form.historys.forEach(function(oh) {\n                  if ((o_ins != null ? o_ins.form_version : void 0) === oh._id) {\n                    o_ins_fields = oh != null ? oh.fields : void 0;\n                    return o_ins_fields.forEach(function(o_ins_field) {\n                      if ((o_ins_field != null ? o_ins_field.type : void 0) === 'table' && (o_ins_field != null ? o_ins_field.code : void 0) === o_table) {\n                        return o_subtable_fields = o_ins_field != null ? o_ins_field.fields : void 0;\n                      }\n                    });\n                  }\n                });\n              }\n            }\n            if ((d_ins != null ? d_ins.form_version : void 0) === (d_ins_form != null ? (ref20 = d_ins_form.current) != null ? ref20._id : void 0 : void 0)) {\n              d_ins_fields = d_ins_form != null ? (ref21 = d_ins_form.current) != null ? ref21.fields : void 0 : void 0;\n              d_ins_fields.forEach(function(d_ins_field) {\n                if (((d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === d_table) || (a_table && (d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === a_table)) {\n                  return d_subtable_fields = d_subtable_fields.concat(d_ins_field != null ? d_ins_field.fields : void 0);\n                }\n              });\n            } else {\n              if ((d_ins_form != null ? (ref22 = d_ins_form.historys) != null ? ref22.length : void 0 : void 0) > 0) {\n                d_ins_form.historys.forEach(function(dh) {\n                  if ((d_ins != null ? d_ins.form_version : void 0) === dh._id) {\n                    d_ins_fields = dh != null ? dh.fields : void 0;\n                    return d_ins_fields.forEach(function(d_ins_field) {\n                      if (((d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === d_table) || (a_table && (d_ins_field != null ? d_ins_field.type : void 0) === 'table' && (d_ins_field != null ? d_ins_field.code : void 0) === a_table)) {\n                        return d_subtable_fields = d_subtable_fields.concat(d_ins_field != null ? d_ins_field.fields : void 0);\n                      }\n                    });\n                  }\n                });\n              }\n            }\n            if (o_subtable_fields.length === 0) {\n              console.log(\"o_subtable_fields\", o_subtable_fields);\n              throw new Meteor.Error('forward table refill error!', '原申请单无对应子表');\n            }\n            if (d_subtable_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', '分发的申请单无对应子表');\n            }\n            d_table_values = (d_ins != null ? d_ins.values[d_table] : void 0) || [];\n            if (a_table) {\n              a_table_values = (d_ins != null ? d_ins.values[a_table] : void 0) || [];\n              if (a_table_values && (a_table_values != null ? a_table_values.length : void 0) === (d_table_values != null ? d_table_values.length : void 0)) {\n                a_table_values.forEach(function(a_row, index) {\n                  var key, results, value;\n                  results = [];\n                  for (key in a_row) {\n                    value = a_row[key];\n                    results.push(d_table_values[index][key] = value);\n                  }\n                  return results;\n                });\n              }\n            }\n            if (d_table_values.length === 0) {\n              throw new Meteor.Error('forward table refill error!', '分发的申请单子表数据为空');\n            }\n            o_match_col_fields = o_subtable_fields.filter(function(m) {\n              return m.code === o_match_col;\n            });\n            d_match_col_fields = d_subtable_fields.filter(function(m) {\n              return m.code === d_match_col;\n            });\n            if (o_match_col_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', '原申请单子表无对应匹配列');\n            }\n            if (d_match_col_fields.length === 0) {\n              throw new Meteor.Error('forward table refill error!', '分发的申请单子表无对应匹配列');\n            }\n            o_match_col_field = o_match_col_fields[0];\n            d_match_col_field = d_match_col_fields[0];\n            if ((o_match_col_field != null ? o_match_col_field.type : void 0) !== (d_match_col_field != null ? d_match_col_field.type : void 0)) {\n              throw new Meteor.Error('forward table refill error!', '分发的申请单和原申请单子表的匹配列字段不一致');\n            }\n            columns.forEach(function(column) {\n              var col, cols, d_col, d_col_fields, o_col, o_col_fields;\n              cols = column.split('-') || [];\n              if (cols.length === 2) {\n                o_col = cols[0];\n                d_col = cols[1];\n                o_col_fields = o_subtable_fields.filter(function(m) {\n                  return m.code === o_col;\n                });\n                d_col_fields = d_subtable_fields.filter(function(m) {\n                  return m.code === d_col;\n                });\n                if (o_col_fields.length === 0) {\n                  throw new Meteor.Error('forward table refill error!', '原申请单子表无对应回填列');\n                }\n                if (d_col_fields.length === 0) {\n                  throw new Meteor.Error('forward table refill error!', '分发的申请单子表无对应回填列');\n                }\n                if ((o_col_fields != null ? o_col_fields.type : void 0) !== (d_col_fields != null ? d_col_fields.type : void 0)) {\n                  throw new Meteor.Error('forward table refill error!', '回填列字段类型不一致');\n                }\n                col = {\n                  o_col: o_col,\n                  d_col: d_col\n                };\n                return column_list.push(col);\n              } else {\n                throw new Meteor.Error('forward table refill error!', '回填列不匹配');\n              }\n            });\n            traces = o_ins != null ? o_ins.traces : void 0;\n            trace = traces[traces.length - 1];\n            approve = trace != null ? trace.approves[0] : void 0;\n            table_data = (approve != null ? approve.values[o_table] : void 0) || [];\n            d_table_values.forEach(function(d_row) {\n              var count, has_obj, row_data;\n              has_obj = false;\n              count = -1;\n              table_data.forEach(function(o_row, index) {\n                if (o_row[o_match_col] === d_row[d_match_col]) {\n                  has_obj = true;\n                  return count = index;\n                }\n              });\n              if (has_obj === true) {\n                return column_list.forEach(function(col) {\n                  return table_data[count][col != null ? col.o_col : void 0] = d_row[col != null ? col.d_col : void 0];\n                });\n              } else {\n                row_data = {};\n                row_data[o_match_col] = d_row[d_match_col];\n                column_list.forEach(function(col) {\n                  return row_data[col != null ? col.o_col : void 0] = d_row[col != null ? col.d_col : void 0];\n                });\n                return table_data.push(row_data);\n              }\n            });\n            traces[traces.length - 1].approves[0].values = o_ins != null ? o_ins.values : void 0;\n            traces[traces.length - 1].approves[0].values[o_table] = table_data;\n            db.instances.update(o_ins_id, {\n              $set: {\n                'traces': traces\n              }\n            });\n            JsonRoutes.sendResult(res, {\n              code: 200,\n              data: {\n                'success': '回填成功'\n              }\n            });\n          } else {\n            throw new Meteor.Error('forward table refill error!', 'webhook未配置子表回填列字段 columns 值');\n          }\n        } else {\n          throw new Meteor.Error('forward table refill error!', 'webhook未配置匹配列字段 oMatchCol 值');\n        }\n      } else {\n        throw new Meteor.Error('forward table refill error!', 'webhook未配置原表单子表 oTable 值');\n      }\n    } else {\n      throw new Meteor.Error('forward table refill error!', '申请单未结束');\n    }\n  } catch (error) {\n    e = error;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [e]\n      }\n    });\n  }\n});\n","JsonRoutes.add(\"post\", \"/api/workflow/sub_table_sort\", (req, res, next) ->\n\ttry\n        console.log \"=========子表==========\"\n        console.log \"req?.query?.subTable\",req?.query?.subTable\n        console.log \"=========子表总分列==========\"\n        console.log \"req?.query?.sumCol\",req?.query?.sumCol\n        console.log \"=========子表排序列==========\"\n        console.log \"req?.query?.sortCol\",req?.query?.sortCol\n        console.log \"=========子表单列需要计算的和==========\"\n        console.log \"req?.query?.singleCols\",req?.query?.singleCols\n        \n        \n        sub_table = req?.query?.subTable\n        if !sub_table\n            console.log \"=====sub_table======\"\n            throw new Meteor.Error('table sort error!', 'webhook 未配置 subTable 字段' );\n        \n        sum_col = req?.query?.sumCol\n        if !sum_col\n            console.log \"=====sum_col======\"\n            throw new Meteor.Error('table sort error!', 'webhook 未配置 sumCol 字段' );\n        \n        sort_col = req?.query?.sortCol\n        if !sort_col\n            console.log \"=====sort_col======\"\n            throw new Meteor.Error('table sort error!', 'webhook 未配置 sortCol 字段' );\n        \n        # single_cols = req?.query?.singleCols\n        # if !single_cols\n        #     console.log \"=====single_cols======\"\n\n        #     throw new Meteor.Error('table sort error!', 'webhook 未配置 singleCols 字段' );\n        \n        ins = req?.body?.instance\n        \n        sub_table_values = ins.values[sub_table]\n        \n        if sub_table_values?.length > 0 \n            # # 根据 sub_table_values 进行排序\n            # ======================\n            # 排序字段，关键字，正序(true)/倒序(false)\n            `function JsonSort(jsonArr, key, asc){\n                for(var j=1,jl=jsonArr.length;j < jl;j++){\n                    var temp = jsonArr[j],\n                        val  = Number(temp[key]),\n                        i    = j-1;\n                    if(asc==true){\n                        while(i >=0 && Number(jsonArr[i][key])>val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }else{\n                        while(i >=0 && Number(jsonArr[i][key])<val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }\n                    jsonArr[i+1] = temp;\n                }\n                return jsonArr;\n            }`\n            \n            new_table_values = JsonSort(sub_table_values,sum_col,false)\n\n            console.log \"new_table_values\",new_table_values\n\n            new_table_values.forEach (obj, index)->\n                if sort_col and obj[sum_col]\n                    obj[sort_col] = (index+1).toString()\n            \n            console.log \"new_table_values\",new_table_values\n\n            ins.values[sub_table] = new_table_values\n\n            db.instances.update(ins._id,{\n                $set:{\n                    'values':ins.values\n                    }\n                })\n\n            console.log \"success\"\n            JsonRoutes.sendResult res, {\n                code: 200,\n                data: {\n                    'success': '计算排序成功'\n                }\n            }\n        else\n            throw new Meteor.Error('table sort error!', '子表数据为空');\n    catch e\n        JsonRoutes.sendResult res, {\n            code: 200,\n            data: {\n                errors: [e]\n            }\n        }\n)","JsonRoutes.add(\"post\", \"/api/workflow/sub_table_sort\", function(req, res, next) {\n  var e, ins, new_table_values, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, sort_col, sub_table, sub_table_values, sum_col;\n  try {\n    console.log(\"=========子表==========\");\n    console.log(\"req?.query?.subTable\", req != null ? (ref = req.query) != null ? ref.subTable : void 0 : void 0);\n    console.log(\"=========子表总分列==========\");\n    console.log(\"req?.query?.sumCol\", req != null ? (ref1 = req.query) != null ? ref1.sumCol : void 0 : void 0);\n    console.log(\"=========子表排序列==========\");\n    console.log(\"req?.query?.sortCol\", req != null ? (ref2 = req.query) != null ? ref2.sortCol : void 0 : void 0);\n    console.log(\"=========子表单列需要计算的和==========\");\n    console.log(\"req?.query?.singleCols\", req != null ? (ref3 = req.query) != null ? ref3.singleCols : void 0 : void 0);\n    sub_table = req != null ? (ref4 = req.query) != null ? ref4.subTable : void 0 : void 0;\n    if (!sub_table) {\n      console.log(\"=====sub_table======\");\n      throw new Meteor.Error('table sort error!', 'webhook 未配置 subTable 字段');\n    }\n    sum_col = req != null ? (ref5 = req.query) != null ? ref5.sumCol : void 0 : void 0;\n    if (!sum_col) {\n      console.log(\"=====sum_col======\");\n      throw new Meteor.Error('table sort error!', 'webhook 未配置 sumCol 字段');\n    }\n    sort_col = req != null ? (ref6 = req.query) != null ? ref6.sortCol : void 0 : void 0;\n    if (!sort_col) {\n      console.log(\"=====sort_col======\");\n      throw new Meteor.Error('table sort error!', 'webhook 未配置 sortCol 字段');\n    }\n    ins = req != null ? (ref7 = req.body) != null ? ref7.instance : void 0 : void 0;\n    sub_table_values = ins.values[sub_table];\n    if ((sub_table_values != null ? sub_table_values.length : void 0) > 0) {\n      function JsonSort(jsonArr, key, asc){\n                for(var j=1,jl=jsonArr.length;j < jl;j++){\n                    var temp = jsonArr[j],\n                        val  = Number(temp[key]),\n                        i    = j-1;\n                    if(asc==true){\n                        while(i >=0 && Number(jsonArr[i][key])>val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }else{\n                        while(i >=0 && Number(jsonArr[i][key])<val){\n                            jsonArr[i+1] = jsonArr[i];\n                            i = i-1;    \n                        }\n                    }\n                    jsonArr[i+1] = temp;\n                }\n                return jsonArr;\n            };\n      new_table_values = JsonSort(sub_table_values, sum_col, false);\n      console.log(\"new_table_values\", new_table_values);\n      new_table_values.forEach(function(obj, index) {\n        if (sort_col && obj[sum_col]) {\n          return obj[sort_col] = (index + 1).toString();\n        }\n      });\n      console.log(\"new_table_values\", new_table_values);\n      ins.values[sub_table] = new_table_values;\n      db.instances.update(ins._id, {\n        $set: {\n          'values': ins.values\n        }\n      });\n      console.log(\"success\");\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          'success': '计算排序成功'\n        }\n      });\n    } else {\n      throw new Meteor.Error('table sort error!', '子表数据为空');\n    }\n  } catch (error) {\n    e = error;\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        errors: [e]\n      }\n    });\n  }\n});\n","if Meteor.isDevelopment\n    JsonRoutes.add 'post', '/test/webhook', (req, res, next) ->\n        try\n\n            hashData = req.body\n            console.log 'action: ', hashData.action\n            console.log 'from_user: ', hashData.from_user\n            console.log 'to_users: ', hashData.to_users\n\n\n            JsonRoutes.sendResult res,\n                    code: 200\n                    data: {}\n        catch e\n            console.error e.stack\n            JsonRoutes.sendResult res,\n                code: 200\n                data: { errors: [{errorMessage: e.message}] }","if (Meteor.isDevelopment) {\n  JsonRoutes.add('post', '/test/webhook', function(req, res, next) {\n    var e, hashData;\n    try {\n      hashData = req.body;\n      console.log('action: ', hashData.action);\n      console.log('from_user: ', hashData.from_user);\n      console.log('to_users: ', hashData.to_users);\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {}\n      });\n    } catch (error) {\n      e = error;\n      console.error(e.stack);\n      return JsonRoutes.sendResult(res, {\n        code: 200,\n        data: {\n          errors: [\n            {\n              errorMessage: e.message\n            }\n          ]\n        }\n      });\n    }\n  });\n}\n","JsonRoutes.add(\"post\", \"/api/formula/users\", (req, res, next) ->\n\n\tcurrent_user_info = uuflowManager.check_authorization(req)\n\tcurrent_user = current_user_info._id\n\n\tuserIds = req.body.userIds\n\tspaceId = req.body.spaceId\n\tspaceUsers = [];\n\n\tspace_user = db.space_users.findOne({user: current_user, space: spaceId}, {fields: {_id: 1}})\n\tif !space_user\n\t\treturn JsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '无权限'\n\t\t\t}\n\t\t});\n\n\tif (!userIds || !spaceId)\n\t\treturn JsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '缺少参数'\n\t\t\t}\n\t\t});\n\tspaceUsers = WorkflowManager.getFormulaUserObjects(spaceId, userIds)\n\n\tJsonRoutes.sendResult res, {\n\t\tcode: 200,\n\t\tdata: {\n\t\t\t'spaceUsers': spaceUsers\n\t\t}\n\t}\n)","JsonRoutes.add(\"post\", \"/api/formula/users\", function(req, res, next) {\n  var current_user, current_user_info, spaceId, spaceUsers, space_user, userIds;\n  current_user_info = uuflowManager.check_authorization(req);\n  current_user = current_user_info._id;\n  userIds = req.body.userIds;\n  spaceId = req.body.spaceId;\n  spaceUsers = [];\n  space_user = db.space_users.findOne({\n    user: current_user,\n    space: spaceId\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (!space_user) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '无权限'\n      }\n    });\n  }\n  if (!userIds || !spaceId) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '缺少参数'\n      }\n    });\n  }\n  spaceUsers = WorkflowManager.getFormulaUserObjects(spaceId, userIds);\n  return JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'spaceUsers': spaceUsers\n    }\n  });\n});\n","JsonRoutes.add(\"post\", \"/api/formula/orgs\", (req, res, next) ->\n\tcurrent_user_info = uuflowManager.check_authorization(req)\n\tcurrent_user = current_user_info._id\n\torgIds = req.body.orgIds\n\tspaceId = req.body.spaceId\n\n\tspace_user = db.space_users.findOne({user: current_user, space: spaceId}, {fields: {_id: 1}})\n\tif !space_user\n\t\treturn JsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '无权限'\n\t\t\t}\n\t\t});\n\n\tif (!orgIds || !spaceId)\n\t\treturn JsonRoutes.sendResult(res, {\n\t\t\tcode: 200,\n\t\t\tdata: {\n\t\t\t\t'errors': '缺少参数'\n\t\t\t}\n\t\t});\n\n\torgs = WorkflowManager.getFormulaOrgObjects(orgIds)\n\n\tJsonRoutes.sendResult(res, {\n\t\tcode: 200,\n\t\tdata: {\n\t\t\t'orgs': orgs\n\t\t}\n\t});\n)","JsonRoutes.add(\"post\", \"/api/formula/orgs\", function(req, res, next) {\n  var current_user, current_user_info, orgIds, orgs, spaceId, space_user;\n  current_user_info = uuflowManager.check_authorization(req);\n  current_user = current_user_info._id;\n  orgIds = req.body.orgIds;\n  spaceId = req.body.spaceId;\n  space_user = db.space_users.findOne({\n    user: current_user,\n    space: spaceId\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (!space_user) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '无权限'\n      }\n    });\n  }\n  if (!orgIds || !spaceId) {\n    return JsonRoutes.sendResult(res, {\n      code: 200,\n      data: {\n        'errors': '缺少参数'\n      }\n    });\n  }\n  orgs = WorkflowManager.getFormulaOrgObjects(orgIds);\n  return JsonRoutes.sendResult(res, {\n    code: 200,\n    data: {\n      'orgs': orgs\n    }\n  });\n});\n","Meteor.startup ()->\n\tTabularTables.related_instances_tabular = new Tabular.Table\n\t\tname: \"related_instances_tabular\"\n\t\tcollection: db.instances\n\t\tcolumns: [\n\t\t\t{\n\t\t\t\tdata: \"_id\",\n\t\t\t\ttitle: '<input type=\"checkbox\" name=\"reverse\" id=\"reverse\">',\n\t\t\t\torderable: false,\n\t\t\t\twidth: '1px',\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tinput = '<input type=\"checkbox\" class=\"related-instances-list-checkbox\" name=\"related_instances_ids\" id=\"related_instances_ids\" value=\"' + doc._id + '\"'\n\n\t\t\t\t\tif TabularTables.related_instances_tabular.related_instances?.includes(doc._id)\n\t\t\t\t\t\tinput += \" checked \"\n\n\t\t\t\t\tinput += \">\"\n\t\t\t\t\treturn input\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"name\",\n\t\t\t\torderable: false,\n\t\t\t\twidth: '45%',\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\thref = '';\n\t\t\t\t\tif Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())\n\t\t\t\t\t\thref = ''\n\n\t\t\t\t\tabsolute = false\n\n\t\t\t\t\tif Meteor.isServer\n\t\t\t\t\t\tabsolute = this.absolute\n\t\t\t\t\tif absolute\n\t\t\t\t\t\thref = Meteor.absoluteUrl(\"workflow/space/\"+doc.space+\"/view/readonly/\" + doc._id + '?hide_traces=0')\n\t\t\t\t\telse\n\t\t\t\t\t\thref = Steedos.absoluteUrl(\"workflow/space/\"+doc.space+\"/view/readonly/\" + doc._id + '?hide_traces=0')\n\t\t\t\t\treturn \"<a data-id='#{doc._id}' target='_blank' href='\"+href+\"'>\" + doc.name + \"</a>\"\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"applicant_name\",\n\t\t\t\ttitle: t(\"instances_applicant_name\"),\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"flow_name\",\n\t\t\t\ttitle: t(\"instances_flow\"),\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"current_step_name\",\n\t\t\t\ttitle: t(\"instances_flow\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc.state == \"completed\"\n\t\t\t\t\t\tjudge = doc.final_decision || \"approved\"\n\n\t\t\t\t\tstep_current_name = doc.current_step_name || ''\n\n\t\t\t\t\treturn \"\"\"\n\t\t\t\t\t\t\t<div class=\"step-current-state #{judge}\">#{step_current_name}</div>\n\t\t\t\t\t\t\"\"\"\n\t\t\t}\n\t\t]\n\n\t\tdom: \"tp\",\n\t\tlengthChange: false,\n\t\textraFields: [\"state\", \"final_decision\", \"space\", \"keywords\"],\n\t\tpageLength: 10,\n\t\tinfo: false,\n\t\tsearching: true,\n\t\tresponsive:\n\t\t\tdetails: false\n\t\tautoWidth: false,\n\t\tchangeSelector: (selector, userId) ->\n\t\t\tunless userId\n\t\t\t\treturn {_id: -1}\n\n\t\t\tspaceId = selector.space\n\t\t\tunless spaceId\n\t\t\t\tif selector?.$and?.length > 0\n\t\t\t\t\tspaceId = selector.$and.getProperty('space')[0]\n\t\t\tunless spaceId\n\t\t\t\treturn {_id: -1}\n\t\t\tspace = db.spaces.findOne(spaceId)\n\t\t\tif !space\n\t\t\t\tselector.state = \"none\"\n\t\t\tif !space.admins.includes(userId)\n\n\t\t\t\tflow_ids = []\n\t\t\t\tcurSpaceUser = db.space_users.findOne({\n\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t'user': userId\n\t\t\t\t})\n\t\t\t\tif curSpaceUser\n\t\t\t\t\torganizations = db.organizations.find({\n\t\t\t\t\t\t_id: {\n\t\t\t\t\t\t\t$in: curSpaceUser.organizations\n\t\t\t\t\t\t}\n\t\t\t\t\t}).fetch()\n\t\t\t\t\tflows = db.flows.find({ space: spaceId })\n\t\t\t\t\tflows.forEach (fl)->\n\t\t\t\t\t\tif WorkflowManager.canMonitor(fl, curSpaceUser, organizations) || WorkflowManager.canAdmin(fl, curSpaceUser, organizations)\n\t\t\t\t\t\t\tflow_ids.push(fl._id)\n\n\t\t\t\tif selector?.$and?.length > 0\n\t\t\t\t\tselector.$and[0].$or = [{submitter: userId}, {applicant: userId}, {inbox_users: userId}, {outbox_users: userId},\n\t\t\t\t\t\t\t{cc_users: userId}, { flow: { $in: flow_ids } }]\n\t\t\t\telse\n\t\t\t\t\t_.extend selector, {\n\t\t\t\t\t\t$or: [{submitter: userId}, {applicant: userId}, {inbox_users: userId}, {outbox_users: userId},\n\t\t\t\t\t\t\t{cc_users: userId}, { flow: { $in: flow_ids } }]\n\t\t\t\t\t}\n\n\t\t\treturn selector","Meteor.startup(function() {\n  return TabularTables.related_instances_tabular = new Tabular.Table({\n    name: \"related_instances_tabular\",\n    collection: db.instances,\n    columns: [\n      {\n        data: \"_id\",\n        title: '<input type=\"checkbox\" name=\"reverse\" id=\"reverse\">',\n        orderable: false,\n        width: '1px',\n        render: function(val, type, doc) {\n          var input, ref;\n          input = '<input type=\"checkbox\" class=\"related-instances-list-checkbox\" name=\"related_instances_ids\" id=\"related_instances_ids\" value=\"' + doc._id + '\"';\n          if ((ref = TabularTables.related_instances_tabular.related_instances) != null ? ref.includes(doc._id) : void 0) {\n            input += \" checked \";\n          }\n          input += \">\";\n          return input;\n        }\n      }, {\n        data: \"name\",\n        orderable: false,\n        width: '45%',\n        render: function(val, type, doc) {\n          var absolute, href;\n          href = '';\n          if (Meteor.isClient && (Steedos.isMobile() || Steedos.isCordova())) {\n            href = '';\n          }\n          absolute = false;\n          if (Meteor.isServer) {\n            absolute = this.absolute;\n          }\n          if (absolute) {\n            href = Meteor.absoluteUrl(\"workflow/space/\" + doc.space + \"/view/readonly/\" + doc._id + '?hide_traces=0');\n          } else {\n            href = Steedos.absoluteUrl(\"workflow/space/\" + doc.space + \"/view/readonly/\" + doc._id + '?hide_traces=0');\n          }\n          return (\"<a data-id='\" + doc._id + \"' target='_blank' href='\") + href + \"'>\" + doc.name + \"</a>\";\n        }\n      }, {\n        data: \"applicant_name\",\n        title: t(\"instances_applicant_name\"),\n        orderable: false\n      }, {\n        data: \"flow_name\",\n        title: t(\"instances_flow\"),\n        orderable: false\n      }, {\n        data: \"current_step_name\",\n        title: t(\"instances_flow\"),\n        render: function(val, type, doc) {\n          var judge, step_current_name;\n          if (doc.state === \"completed\") {\n            judge = doc.final_decision || \"approved\";\n          }\n          step_current_name = doc.current_step_name || '';\n          return \"<div class=\\\"step-current-state \" + judge + \"\\\">\" + step_current_name + \"</div>\";\n        }\n      }\n    ],\n    dom: \"tp\",\n    lengthChange: false,\n    extraFields: [\"state\", \"final_decision\", \"space\", \"keywords\"],\n    pageLength: 10,\n    info: false,\n    searching: true,\n    responsive: {\n      details: false\n    },\n    autoWidth: false,\n    changeSelector: function(selector, userId) {\n      var curSpaceUser, flow_ids, flows, organizations, ref, ref1, space, spaceId;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      spaceId = selector.space;\n      if (!spaceId) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          spaceId = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!spaceId) {\n        return {\n          _id: -1\n        };\n      }\n      space = db.spaces.findOne(spaceId);\n      if (!space) {\n        selector.state = \"none\";\n      }\n      if (!space.admins.includes(userId)) {\n        flow_ids = [];\n        curSpaceUser = db.space_users.findOne({\n          space: spaceId,\n          'user': userId\n        });\n        if (curSpaceUser) {\n          organizations = db.organizations.find({\n            _id: {\n              $in: curSpaceUser.organizations\n            }\n          }).fetch();\n          flows = db.flows.find({\n            space: spaceId\n          });\n          flows.forEach(function(fl) {\n            if (WorkflowManager.canMonitor(fl, curSpaceUser, organizations) || WorkflowManager.canAdmin(fl, curSpaceUser, organizations)) {\n              return flow_ids.push(fl._id);\n            }\n          });\n        }\n        if ((selector != null ? (ref1 = selector.$and) != null ? ref1.length : void 0 : void 0) > 0) {\n          selector.$and[0].$or = [\n            {\n              submitter: userId\n            }, {\n              applicant: userId\n            }, {\n              inbox_users: userId\n            }, {\n              outbox_users: userId\n            }, {\n              cc_users: userId\n            }, {\n              flow: {\n                $in: flow_ids\n              }\n            }\n          ];\n        } else {\n          _.extend(selector, {\n            $or: [\n              {\n                submitter: userId\n              }, {\n                applicant: userId\n              }, {\n                inbox_users: userId\n              }, {\n                outbox_users: userId\n              }, {\n                cc_users: userId\n              }, {\n                flow: {\n                  $in: flow_ids\n                }\n              }\n            ]\n          });\n        }\n      }\n      return selector;\n    }\n  });\n});\n","Steedos.subs[\"InstanceTabular\"] = new SubsManager()\n\n\n_handleListFields = (fields) ->\n\tins_fields = new Array();\n\n\tfields?.forEach (f)->\n\t\tif f.type == 'table'\n\t\t\tconsole.log 'ignore opinion field in table'\n\t\telse if f.type == 'section'\n\t\t\tf?.fields?.forEach (f1)->\n\t\t\t\tins_fields.push f1\n\t\telse\n\t\t\tins_fields.push f\n\n\treturn ins_fields\n\n\nupdateTabularTitle = ()->\n\n# 如果columns有加减，请修改Template.instance_list._tableColumns 函数\ninstancesListTableTabular = (flowId, fields)->\n\toptions = {\n\t\tname: \"instances\",\n\t\tcollection: db.instances,\n\t\tpub: \"instance_tabular\",\n\t\tonUnload: ()->\n\t\t\tMeteor.setTimeout(Template.instance_list._tableColumns, 150)\n\n\t\tdrawCallback: (settings)->\n\t\t\temptyTd = $(\".dataTables_empty\")\n\t\t\tif emptyTd.length\n\t\t\t\temptyTd[0].colSpan = \"6\"\n\t\t\tif !Steedos.isMobile() && !Steedos.isPad()\n\t\t\t\tMeteor.setTimeout(Template.instance_list._tableColumns, 150)\n\t\t\t\t$(\".instance-list\").scrollTop(0).ready ->\n\t\t\t\t\t$(\".instance-list\").perfectScrollbar(\"update\")\n\t\t\telse\n\t\t\t\t$(\".instance-list\").scrollTop(0)\n\n\t\t\ttitle = t \"pager_input_hint\"\n\t\t\tellipsisLink = settings.oInstance.parent().find('.paging_numbers .pagination .disabled a')\n\t\t\tellipsisLink.attr(\"title\", title).css(\"cursor\", \"pointer\").click ->\n\t\t\t\tif !$(this).find('input').length\n\t\t\t\t\tinput = $('<input class=\"paginate_input form-control input-sm\" type=\"text\" style=\"border: none; padding:0 2px;\"/>')\n\t\t\t\t\tif Steedos.isMobile()\n\t\t\t\t\t\tinput.css({\n\t\t\t\t\t\t\twidth:\"52px\"\n\t\t\t\t\t\t\theight: \"20px\"\n\t\t\t\t\t\t})\n\t\t\t\t\telse\n\t\t\t\t\t\tinput.css({\n\t\t\t\t\t\t\twidth:\"52px\"\n\t\t\t\t\t\t\theight: \"16px\"\n\t\t\t\t\t\t})\n\t\t\t\t\tinput.attr(\"title\", title).attr(\"placeholder\", title)\n\t\t\t\t\t$(this).empty().append input\n\t\t\t\t\tgoPage = (index)->\n\t\t\t\t\t\tif index > 0\n\t\t\t\t\t\t\tpages = Math.ceil(settings.fnRecordsDisplay() / settings._iDisplayLength)\n\t\t\t\t\t\t\tif index > pages\n\t\t\t\t\t\t\t\t# 页码超出索引时跳转到最后一页\n\t\t\t\t\t\t\t\tindex = pages\n\t\t\t\t\t\t\tindex--\n\t\t\t\t\t\t\tsettings.oInstance.DataTable().page(index).draw('page')\n\t\t\t\t\tinput.blur (e)->\n\t\t\t\t\t\tcurrentPage = $(this).val()\n\t\t\t\t\t\tgoPage currentPage\n\t\t\t\t\t\t$(this).parent().html '...'\n\t\t\t\t\tinput.keydown (e)->\n\t\t\t\t\t\tif(e.keyCode.toString() == \"13\")\n\t\t\t\t\t\t\tcurrentPage = $(this).val()\n\t\t\t\t\t\t\tgoPage currentPage\n\n\t\tcreatedRow: (row, data, dataIndex) ->\n\t\t\tif Meteor.isClient\n\t\t\t\tif data._id == FlowRouter.current().params.instanceId\n\t\t\t\t\trow.setAttribute(\"class\", \"selected\")\n\t\tcolumns: [\n\t\t\t{\n\t\t\t\tdata: \"_id\",\n\t\t\t\torderable: false\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tmodifiedString = moment(doc.modified).format('YYYY-MM-DD');\n\n\t\t\t\t\tmodified = doc.modified\n\t\t\t\t\tif Session.get(\"box\") == 'inbox' && doc.state != 'draft'\n\t\t\t\t\t\tmodified = doc.start_date || doc.modified\n\n\t\t\t\t\tif Session.get(\"box\") == 'outbox' || Session.get(\"box\") == 'monitor'\n\t\t\t\t\t\tmodified = doc.submit_date || doc.submit_date\n\n\t\t\t\t\tmodifiedFromNow = Steedos.momentReactiveFromNow(modified);\n\t\t\t\t\tflow_name = doc.flow_name\n\t\t\t\t\tcc_view = \"\";\n\t\t\t\t\tstep_current_name_view = \"\";\n\t\t\t\t\t# 当前用户在cc user中，但是不在inbox users时才显示'传阅'文字\n\t\t\t\t\tif doc.is_cc && !doc.inbox_users?.includes(Meteor.userId()) && Session.get(\"box\") == 'inbox'\n\t\t\t\t\t\tcc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \"\n\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}<span>(#{doc.current_step_name})</span></div>\"\n\t\t\t\t\telse\n\t\t\t\t\t\tif Session.get(\"box\") != 'draft' && doc.current_step_name\n\t\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}<span>(#{doc.current_step_name})</span></div>\"\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tstep_current_name_view = \"<div class='flow-name'>#{flow_name}</div>\"\n\n\t\t\t\t\tagent_view = \"\";\n\t\t\t\t\tif doc.agent_user_name && Session.get(\"box\") == 'inbox'\n\t\t\t\t\t\tagent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {userName: doc.agent_user_name}) + \")</label>\"\n\n\t\t\t\t\tunread = ''\n\n\t\t\t\t\tif Session.get(\"box\") == 'inbox' && doc.is_read == false\n\t\t\t\t\t\tunread = '<i class=\"ion ion-record unread\"></i>'\n\t\t\t\t\telse if Session.get(\"box\") == 'monitor' && doc.is_hidden == true\n\t\t\t\t\t\tunread = '<i class=\"fa fa-lock\"></i>'\n\n\t\t\t\t\tpriorityIcon = \"\"\n\t\t\t\t\tpriorityIconClass = \"\"\n\t\t\t\t\tpriorityValue = doc.values?.priority\n\t\t\t\t\tswitch priorityValue\n\t\t\t\t\t\twhen \"特急\"\n\t\t\t\t\t\t\tpriorityIconClass = \"danger\"\n\t\t\t\t\t\twhen \"紧急\"\n\t\t\t\t\t\t\tpriorityIconClass = \"warning\"\n\t\t\t\t\t\twhen \"办文\"\n\t\t\t\t\t\t\tpriorityIconClass = \"muted\"\n\t\t\t\t\tif priorityIconClass\n\t\t\t\t\t\tinstanceNamePriorityClass = \"color-priority color-priority-#{priorityIconClass}\"\n\n\t\t\t\t\treturn \"\"\"\n\t\t\t\t\t\t\t\t<div class='instance-read-bar'>#{unread}</div>\n\t\t\t\t\t\t\t\t<div class='instance-name #{instanceNamePriorityClass}'>#{doc.name}#{cc_view}#{agent_view}\n\t\t\t\t\t\t\t\t\t<span>#{doc.applicant_name}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class='instance-detail'>#{step_current_name_view}\n\t\t\t\t\t\t\t\t\t<span class='instance-modified' title='#{modifiedString}'>#{modifiedFromNow}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\"\"\"\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"applicant_organization_name\",\n\t\t\t\ttitle: t(\"instances_applicant_organization_name\"),\n\t\t\t\tvisible: false,\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"name\",\n\t\t\t\ttitle: t(\"instances_name\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tcc_view = \"\";\n\t\t\t\t\tstep_current_name_view = \"\";\n\t\t\t\t\t# 当前用户在cc user中，但是不在inbox users时才显示'传阅'文字\n\t\t\t\t\tif doc.is_cc && !doc.inbox_users?.includes(Meteor.userId()) && Session.get(\"box\") == 'inbox'\n\t\t\t\t\t\tcc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \"\n\n\t\t\t\t\tagent_view = \"\";\n\t\t\t\t\tif doc.agent_user_name\n\t\t\t\t\t\tagent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {userName: doc.agent_user_name}) + \")</label>\"\n\n\t\t\t\t\tunread = ''\n\n\t\t\t\t\tif Session.get(\"box\") == 'inbox' && doc.is_read == false\n\t\t\t\t\t\tunread = '<i class=\"ion ion-record unread\"></i>'\n\t\t\t\t\telse if Session.get(\"box\") == 'monitor' && doc.is_hidden == true\n\t\t\t\t\t\tunread = '<i class=\"fa fa-lock\"></i>'\n\n\t\t\t\t\tpriorityIconClass = \"\"\n\t\t\t\t\tpriorityValue = doc.values?.priority\n\t\t\t\t\tswitch priorityValue\n\t\t\t\t\t\twhen \"特急\"\n\t\t\t\t\t\t\tpriorityIconClass = \"danger\"\n\t\t\t\t\t\twhen \"紧急\"\n\t\t\t\t\t\t\tpriorityIconClass = \"warning\"\n\t\t\t\t\t\twhen \"办文\"\n\t\t\t\t\t\t\tpriorityIconClass = \"muted\"\n\t\t\t\t\tif priorityIconClass\n\t\t\t\t\t\tinstanceNamePriorityClass = \"color-priority color-priority-#{priorityIconClass}\"\n\t\t\t\t\treturn \"\"\"\n\t\t\t\t\t\t\t<div class='instance-read-bar'>#{unread}</div>\n\t\t\t\t\t\t\t<div class='instance-name #{instanceNamePriorityClass}'>#{doc.name}#{cc_view}#{agent_view}</div>\n\t\t\t\t\t\t\"\"\"\n\t\t\t\tvisible: false,\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"applicant_name\",\n\t\t\t\ttitle: t(\"instances_applicant_name\"),\n\t\t\t\tvisible: false,\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"submit_date\",\n\t\t\t\ttitle: t(\"instances_submit_date\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc.submit_date\n\t\t\t\t\t\treturn moment(doc.submit_date).format('YYYY-MM-DD HH:mm');\n\t\t\t\t,\n\t\t\t\tvisible: false,\n\t\t\t\torderable: true\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"flow_name\",\n\t\t\t\ttitle: t(\"instances_flow\"),\n\t\t\t\tvisible: false,\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"current_step_name\",\n\t\t\t\ttitle: t(\"instances_step_current_name\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc.state == \"completed\"\n\t\t\t\t\t\tjudge = doc.final_decision || \"approved\"\n\n\t\t\t\t\tstep_current_name = doc.current_step_name || ''\n\n\t\t\t\t\tcc_tag = ''\n\n\t\t\t\t\tif doc.cc_count > 0\n\t\t\t\t\t\tcc_tag = TAPi18n.__('cc_tag')\n\n\t\t\t\t\treturn \"\"\"\n\t\t\t\t\t\t<div class=\"step-current-state #{judge}\">#{step_current_name}#{cc_tag}</div>\n\t\t\t\t\t\"\"\"\n\t\t\t\tvisible: false,\n\t\t\t\torderable: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"modified\",\n\t\t\t\ttitle: t(\"instances_modified\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\treturn moment(doc.modified).format('YYYY-MM-DD HH:mm');\n\t\t\t\t,\n\t\t\t\tvisible: false,\n\t\t\t\torderable: true\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"start_date\",\n\t\t\t\ttitle: t(\"instances_start_date\"),\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc.start_date\n\t\t\t\t\t\treturn moment(doc.start_date).format('YYYY-MM-DD HH:mm');\n\t\t\t\t,\n\t\t\t\tvisible: false,\n\t\t\t\torderable: true\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"my_finish_date\",\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc.my_finish_date\n\t\t\t\t\t\treturn moment(doc.my_finish_date).format('YYYY-MM-DD HH:mm');\n\t\t\t\t,\n\t\t\t\tvisible: false,\n\t\t\t\torderable: true\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"modified\",\n\t\t\t\tvisible: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"keywords\",\n\t\t\t\tvisible: false\n\t\t\t},\n\t\t\t{\n\t\t\t\tdata: \"is_archived\",\n\t\t\t\trender: (val, type, doc) ->\n\t\t\t\t\tif doc?.values?.record_need && doc.values.record_need == \"true\"\n\t\t\t\t\t\tif doc?.is_archived\n\t\t\t\t\t\t\treturn t(\"YES\")\n\t\t\t\t\t\treturn t(\"NO\")\n\t\t\t\tvisible: false\n\t\t\t\torderable: false\n\t\t\t}\n\t\t],\n\t\tdom: do ->\n\t\t\t# 手机上不显示一页显示多少条记录选项\n\t\t\tif Steedos.isMobile()\n\t\t\t\t'tp'\n\t\t\telse\n\t\t\t\t'tpl'\n\t\torder: [[4, \"desc\"]],\n\t\textraFields: [\"form\", \"flow\", \"inbox_users\", \"state\", \"space\", \"applicant\", \"form_version\",\n\t\t\t\"flow_version\", \"is_cc\", \"cc_count\", \"is_read\", \"current_step_name\", \"values\", \"keywords\", \"final_decision\", \"flow_name\", \"is_hidden\", \"agent_user_name\"],\n\t\tlengthChange: true,\n\t\tlengthMenu: [10,15,20,25,50,100],\n\t\tpageLength: 10,\n\t\tinfo: false,\n\t\tsearching: true,\n\t\tresponsive:\n\t\t\tdetails: false\n\t\tautoWidth: false,\n\t\tchangeSelector: (selector, userId) ->\n\t\t\tunless userId\n\t\t\t\treturn {_id: -1}\n\t\t\tspace = selector.space\n\t\t\tunless space\n\t\t\t\tif selector?.$and?.length > 0\n\t\t\t\t\tspace = selector.$and.getProperty('space')[0]\n\t\t\tunless space\n\t\t\t\treturn {_id: -1}\n\t\t\tspace_user = db.space_users.findOne({user: userId, space: space}, {fields: {_id: 1}})\n\t\t\tunless space_user\n\t\t\t\treturn {_id: -1}\n\t\t\treturn selector\n\t\tpagingType: \"numbers\"\n\n\t}\n\n\tif flowId\n\t\tkey = \"instanceFlow\" + flowId\n\n\t\toptions.name = key\n\n\t\tTabularTables.instances.fields = fields\n\n\t\tins_fields = _handleListFields TabularTables.instances.fields\n\n\t\tins_fields.forEach (f)->\n\t\t\tif f.type != 'table' && f.is_list_display\n\t\t\t\toptions.columns.push\n\t\t\t\t\tdata: (f.name || f.code),\n\t\t\t\t\ttitle: t(f.name || f.code),\n\t\t\t\t\tvisible: false,\n\t\t\t\t\torderable: false\n\t\t\t\t\trender: (val, type, doc) ->\n\n\t\t\t\t\t\tvalues = doc.values || {}\n\n\t\t\t\t\t\tvalue = values[f.code]\n\n\t\t\t\t\t\tswitch f.type\n\t\t\t\t\t\t\twhen 'user'\n\t\t\t\t\t\t\t\tvalue = value?.name\n\t\t\t\t\t\t\twhen 'group'\n\t\t\t\t\t\t\t\tvalue = value?.fullname\n\t\t\t\t\t\t\twhen 'date'\n\t\t\t\t\t\t\t\tif value\n\t\t\t\t\t\t\t\t\tvalue = moment(value).format('YYYY-MM-DD')\n\t\t\t\t\t\t\twhen 'dateTime'\n\t\t\t\t\t\t\t\tif value\n\t\t\t\t\t\t\t\t\tvalue = moment(value).format('YYYY-MM-DD HH:mm')\n\t\t\t\t\t\t\twhen 'checkbox'\n\t\t\t\t\t\t\t\tif value == true || value == 'true'\n\t\t\t\t\t\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_yes\");\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tvalue = TAPi18n.__(\"form_field_checkbox_no\");\n\t\t\t\t\t\t\twhen 'odata'\n\t\t\t\t\t\t\t\tif value\n\t\t\t\t\t\t\t\t\tif _.isArray(value)\n\t\t\t\t\t\t\t\t\t\tvalue = _.pluck(value, '@label').toString()\n\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\tvalue = value['@label']\n\n\t\t\t\t\t\treturn value\n\n\n\treturn options;\n\nMeteor.startup ()->\n\tTabularTables.instances = new Tabular.Table instancesListTableTabular()\n\n\nGetBoxInstancesTabularOptions = (box, flowId, fields)->\n\tkey = \"instanceFlow\" + box + flowId\n\tif box == \"inbox\"\n\t\toptions = _get_inbox_instances_tabular_options(flowId, fields)\n\telse if box == \"outbox\"\n\t\toptions = _get_outbox_instances_tabular_options(flowId, fields)\n\telse\n\t\toptions = instancesListTableTabular(flowId, fields)\n\t\tif !flowId\n\t\t\toptions.name = \"inbox_instances\"\n\tif flowId\n\t\toptions.name = key\n\treturn options\n\n\n\n_get_inbox_instances_tabular_options = (flowId, fields)->\n\toptions = instancesListTableTabular(flowId, fields)\n\n\tif !flowId\n\t\toptions.name = \"inbox_instances\"\n\n\toptions.order = [[8, \"desc\"]]\n\toptions.filteredRecordIds = (table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions)->\n\t\taggregate_operation = [\n\t\t\t{\n\t\t\t\t$match: selector\n\t\t\t},\n\t\t\t{\n\t\t\t\t$project: {\n\t\t\t\t\tname: 1,\n\t\t\t\t\t\"_approve\": '$traces.approves'\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\t$unwind: \"$_approve\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t$unwind: \"$_approve\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t$match: {\n\t\t\t\t\t'_approve.is_finished': false\n\t\t\t\t\t'_approve.handler': userId,\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t\tif sort and sort.length > 0\n\t\t\ts1 = sort[0]\n\t\t\ts1_0 = s1[0]\n\t\t\ts1_1 = s1[1]\n\t\t\tif s1_0 == 'start_date'\n\n\t\t\t\tfindOptions.sort = [['modified', s1_1]]\n\n\t\t\t\taggregate_operation.push $group: {_id: \"$_id\", \"approve_start_date\": {$first: \"$_approve.start_date\"}}\n\n\t\t\t\tag_sort = 'approve_start_date': if s1_1 == 'asc' then 1 else -1\n\n\t\t\t\taggregate_operation.push $sort: ag_sort\n\t\t\t\taggregate_operation.push $skip: skip\n\t\t\t\taggregate_operation.push $limit: limit\n\t\t\t\tfilteredRecordIds = new Array()\n\n\t\t\t\taggregate = (table, aggregate_operation, filteredRecordIds, cb) ->\n\t\t\t\t\ttable.collection.rawCollection().aggregate(aggregate_operation).toArray (err, data) ->\n\t\t\t\t\t\tif err\n\t\t\t\t\t\t\tthrow new Error(err)\n\t\t\t\t\t\tdata.forEach (doc) ->\n\t\t\t\t\t\t\tfilteredRecordIds.push doc._id\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\tif cb\n\t\t\t\t\t\t\tcb()\n\t\t\t\t\t\treturn\n\t\t\t\t\treturn\n\n\t\t\t\tasync_aggregate = Meteor.wrapAsync(aggregate)\n\n\t\t\t\tasync_aggregate table, aggregate_operation, filteredRecordIds\n\n\t\t\t\treturn filteredRecordIds.uniq()\n\t\t\telse\n\t\t\t\treturn old_filteredRecordIds\n\n\treturn options\n\nMeteor.startup ()->\n\tTabularTables.inbox_instances = new Tabular.Table GetBoxInstancesTabularOptions(\"inbox\")\n\n\n_get_outbox_instances_tabular_options = (flowId, fields)->\n\toptions = instancesListTableTabular(flowId, fields)\n\n\tif !flowId\n\t\toptions.name = \"outbox_instances\"\n\n\toptions.order = [[9, \"desc\"]]\n\toptions.filteredRecordIds = (table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions)->\n\t\taggregate_operation = [\n\t\t\t{\n\t\t\t\t$match: selector\n\t\t\t},\n\t\t\t{\n\t\t\t\t$project: {\n\t\t\t\t\tname: 1,\n\t\t\t\t\t\"_approve\": '$traces.approves'\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\t$unwind: \"$_approve\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t$unwind: \"$_approve\"\n\t\t\t},\n\t\t\t{\n\t\t\t\t$match: {\n\t\t\t\t\t'_approve.is_finished': true\n\t\t\t\t\t$or: [{'_approve.handler': userId},{'_approve.user': userId}]\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t\tif sort and sort.length > 0\n\t\t\ts1 = sort[0]\n\t\t\ts1_0 = s1[0]\n\t\t\ts1_1 = s1[1]\n\t\t\tif s1_0 == 'my_finish_date'\n\n\t\t\t\tfindOptions.sort = [['modified', s1_1]]\n\n\t\t\t\taggregate_operation.push $group: {_id: \"$_id\", \"approve_finish_date\": {$last: \"$_approve.finish_date\"}}\n\n\t\t\t\tag_sort = 'approve_finish_date': if s1_1 == 'asc' then 1 else -1\n\n\t\t\t\taggregate_operation.push $sort: ag_sort\n\t\t\t\taggregate_operation.push $skip: skip\n\t\t\t\taggregate_operation.push $limit: limit\n\t\t\t\tfilteredRecordIds = new Array()\n\n\t\t\t\taggregate = (table, aggregate_operation, filteredRecordIds, cb) ->\n\t\t\t\t\ttable.collection.rawCollection().aggregate(aggregate_operation).toArray (err, data) ->\n\t\t\t\t\t\tif err\n\t\t\t\t\t\t\tthrow new Error(err)\n\t\t\t\t\t\tdata.forEach (doc) ->\n\t\t\t\t\t\t\tfilteredRecordIds.push doc._id\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\tif cb\n\t\t\t\t\t\t\tcb()\n\t\t\t\t\t\treturn\n\t\t\t\t\treturn\n\n\t\t\t\tasync_aggregate = Meteor.wrapAsync(aggregate)\n\n\t\t\t\tasync_aggregate table, aggregate_operation, filteredRecordIds\n\n\t\t\t\treturn filteredRecordIds.uniq()\n\t\t\telse\n\t\t\t\treturn old_filteredRecordIds\n\n\treturn options\n\nMeteor.startup ()->\n\tTabularTables.outbox_instances = new Tabular.Table GetBoxInstancesTabularOptions(\"outbox\")\n\nif Meteor.isClient\n\tTabularTables.flowInstances = new ReactiveVar()\n\nMeteor.startup ()->\n\tTracker.autorun (c) ->\n\t\tif Meteor.isClient && !Steedos.isMobile()\n\t\t\tif Session.get(\"flowId\") && Session.get(\"box\") != 'draft'\n\t\t\t\tMeteor.call \"newInstancesListTabular\", Session.get(\"box\"), Session.get(\"flowId\"), (error, result) ->\n\t\t\t\t\tnewInstancesListTabular Session.get(\"box\"), Session.get(\"flowId\"), result\n\t\t\t\t\tTemplate.instance_list._changeOrder()\n\n\nnewInstancesListTabular = (box, flowId, fields)->\n\tif !fields\n\t\tflow = db.flows.findOne({_id: flowId}, {fields: {form: 1}})\n\t\tfields = db.forms.findOne({ _id: flow?.form }, { fields: { 'current.fields': 1 } })?.current?.fields\n\n\tfields = _handleListFields fields\n\n\tif fields?.filterProperty(\"is_list_display\", true)?.length > 0\n\t\tkey = \"instanceFlow\" + box + flowId\n\t\tif Meteor.isClient\n\t\t\tTabularTables.flowInstances.set(new Tabular.Table GetBoxInstancesTabularOptions(box, flowId, fields))\n\t\telse\n\t\t\tnew Tabular.Table GetBoxInstancesTabularOptions(box, flowId, fields)\n\t\tconsole.log \"new TabularTables \", key\n\nif Meteor.isServer\n\tMeteor.methods\n\t\tnewInstancesListTabular: (box, flowId)->\n\t\t\tnewInstancesListTabular(box, flowId)\n\n\t\t\tflow = db.flows.findOne({_id: flowId}, {fields: {form: 1}})\n\t\t\tfields = db.forms.findOne({ _id: flow?.form }, { fields: { 'current.fields': 1 } })?.current?.fields\n\t\t\treturn fields\n\n\n","var GetBoxInstancesTabularOptions, _get_inbox_instances_tabular_options, _get_outbox_instances_tabular_options, _handleListFields, instancesListTableTabular, newInstancesListTabular, updateTabularTitle;\n\nSteedos.subs[\"InstanceTabular\"] = new SubsManager();\n\n_handleListFields = function(fields) {\n  var ins_fields;\n  ins_fields = new Array();\n  if (fields != null) {\n    fields.forEach(function(f) {\n      var ref;\n      if (f.type === 'table') {\n        return console.log('ignore opinion field in table');\n      } else if (f.type === 'section') {\n        return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n          return ins_fields.push(f1);\n        }) : void 0 : void 0;\n      } else {\n        return ins_fields.push(f);\n      }\n    });\n  }\n  return ins_fields;\n};\n\nupdateTabularTitle = function() {};\n\ninstancesListTableTabular = function(flowId, fields) {\n  var ins_fields, key, options;\n  options = {\n    name: \"instances\",\n    collection: db.instances,\n    pub: \"instance_tabular\",\n    onUnload: function() {\n      return Meteor.setTimeout(Template.instance_list._tableColumns, 150);\n    },\n    drawCallback: function(settings) {\n      var ellipsisLink, emptyTd, title;\n      emptyTd = $(\".dataTables_empty\");\n      if (emptyTd.length) {\n        emptyTd[0].colSpan = \"6\";\n      }\n      if (!Steedos.isMobile() && !Steedos.isPad()) {\n        Meteor.setTimeout(Template.instance_list._tableColumns, 150);\n        $(\".instance-list\").scrollTop(0).ready(function() {\n          return $(\".instance-list\").perfectScrollbar(\"update\");\n        });\n      } else {\n        $(\".instance-list\").scrollTop(0);\n      }\n      title = t(\"pager_input_hint\");\n      ellipsisLink = settings.oInstance.parent().find('.paging_numbers .pagination .disabled a');\n      return ellipsisLink.attr(\"title\", title).css(\"cursor\", \"pointer\").click(function() {\n        var goPage, input;\n        if (!$(this).find('input').length) {\n          input = $('<input class=\"paginate_input form-control input-sm\" type=\"text\" style=\"border: none; padding:0 2px;\"/>');\n          if (Steedos.isMobile()) {\n            input.css({\n              width: \"52px\",\n              height: \"20px\"\n            });\n          } else {\n            input.css({\n              width: \"52px\",\n              height: \"16px\"\n            });\n          }\n          input.attr(\"title\", title).attr(\"placeholder\", title);\n          $(this).empty().append(input);\n          goPage = function(index) {\n            var pages;\n            if (index > 0) {\n              pages = Math.ceil(settings.fnRecordsDisplay() / settings._iDisplayLength);\n              if (index > pages) {\n                index = pages;\n              }\n              index--;\n              return settings.oInstance.DataTable().page(index).draw('page');\n            }\n          };\n          input.blur(function(e) {\n            var currentPage;\n            currentPage = $(this).val();\n            goPage(currentPage);\n            return $(this).parent().html('...');\n          });\n          return input.keydown(function(e) {\n            var currentPage;\n            if (e.keyCode.toString() === \"13\") {\n              currentPage = $(this).val();\n              return goPage(currentPage);\n            }\n          });\n        }\n      });\n    },\n    createdRow: function(row, data, dataIndex) {\n      if (Meteor.isClient) {\n        if (data._id === FlowRouter.current().params.instanceId) {\n          return row.setAttribute(\"class\", \"selected\");\n        }\n      }\n    },\n    columns: [\n      {\n        data: \"_id\",\n        orderable: false,\n        render: function(val, type, doc) {\n          var agent_view, cc_view, flow_name, instanceNamePriorityClass, modified, modifiedFromNow, modifiedString, priorityIcon, priorityIconClass, priorityValue, ref, ref1, step_current_name_view, unread;\n          modifiedString = moment(doc.modified).format('YYYY-MM-DD');\n          modified = doc.modified;\n          if (Session.get(\"box\") === 'inbox' && doc.state !== 'draft') {\n            modified = doc.start_date || doc.modified;\n          }\n          if (Session.get(\"box\") === 'outbox' || Session.get(\"box\") === 'monitor') {\n            modified = doc.submit_date || doc.submit_date;\n          }\n          modifiedFromNow = Steedos.momentReactiveFromNow(modified);\n          flow_name = doc.flow_name;\n          cc_view = \"\";\n          step_current_name_view = \"\";\n          if (doc.is_cc && !((ref = doc.inbox_users) != null ? ref.includes(Meteor.userId()) : void 0) && Session.get(\"box\") === 'inbox') {\n            cc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \";\n            step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"<span>(\" + doc.current_step_name + \")</span></div>\";\n          } else {\n            if (Session.get(\"box\") !== 'draft' && doc.current_step_name) {\n              step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"<span>(\" + doc.current_step_name + \")</span></div>\";\n            } else {\n              step_current_name_view = \"<div class='flow-name'>\" + flow_name + \"</div>\";\n            }\n          }\n          agent_view = \"\";\n          if (doc.agent_user_name && Session.get(\"box\") === 'inbox') {\n            agent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {\n              userName: doc.agent_user_name\n            }) + \")</label>\";\n          }\n          unread = '';\n          if (Session.get(\"box\") === 'inbox' && doc.is_read === false) {\n            unread = '<i class=\"ion ion-record unread\"></i>';\n          } else if (Session.get(\"box\") === 'monitor' && doc.is_hidden === true) {\n            unread = '<i class=\"fa fa-lock\"></i>';\n          }\n          priorityIcon = \"\";\n          priorityIconClass = \"\";\n          priorityValue = (ref1 = doc.values) != null ? ref1.priority : void 0;\n          switch (priorityValue) {\n            case \"特急\":\n              priorityIconClass = \"danger\";\n              break;\n            case \"紧急\":\n              priorityIconClass = \"warning\";\n              break;\n            case \"办文\":\n              priorityIconClass = \"muted\";\n          }\n          if (priorityIconClass) {\n            instanceNamePriorityClass = \"color-priority color-priority-\" + priorityIconClass;\n          }\n          return \"<div class='instance-read-bar'>\" + unread + \"</div>\\n<div class='instance-name \" + instanceNamePriorityClass + \"'>\" + doc.name + cc_view + agent_view + \"\\n\t<span>\" + doc.applicant_name + \"</span>\\n</div>\\n<div class='instance-detail'>\" + step_current_name_view + \"\\n\t<span class='instance-modified' title='\" + modifiedString + \"'>\" + modifiedFromNow + \"</span>\\n</div>\";\n        }\n      }, {\n        data: \"applicant_organization_name\",\n        title: t(\"instances_applicant_organization_name\"),\n        visible: false\n      }, {\n        data: \"name\",\n        title: t(\"instances_name\"),\n        render: function(val, type, doc) {\n          var agent_view, cc_view, instanceNamePriorityClass, priorityIconClass, priorityValue, ref, ref1, step_current_name_view, unread;\n          cc_view = \"\";\n          step_current_name_view = \"\";\n          if (doc.is_cc && !((ref = doc.inbox_users) != null ? ref.includes(Meteor.userId()) : void 0) && Session.get(\"box\") === 'inbox') {\n            cc_view = \"<label class='cc-label'>(\" + TAPi18n.__(\"instance_cc_title\") + \")</label> \";\n          }\n          agent_view = \"\";\n          if (doc.agent_user_name) {\n            agent_view = \"<label class='cc-label'>(\" + TAPi18n.__('process_delegation_rules_description', {\n              userName: doc.agent_user_name\n            }) + \")</label>\";\n          }\n          unread = '';\n          if (Session.get(\"box\") === 'inbox' && doc.is_read === false) {\n            unread = '<i class=\"ion ion-record unread\"></i>';\n          } else if (Session.get(\"box\") === 'monitor' && doc.is_hidden === true) {\n            unread = '<i class=\"fa fa-lock\"></i>';\n          }\n          priorityIconClass = \"\";\n          priorityValue = (ref1 = doc.values) != null ? ref1.priority : void 0;\n          switch (priorityValue) {\n            case \"特急\":\n              priorityIconClass = \"danger\";\n              break;\n            case \"紧急\":\n              priorityIconClass = \"warning\";\n              break;\n            case \"办文\":\n              priorityIconClass = \"muted\";\n          }\n          if (priorityIconClass) {\n            instanceNamePriorityClass = \"color-priority color-priority-\" + priorityIconClass;\n          }\n          return \"<div class='instance-read-bar'>\" + unread + \"</div>\\n<div class='instance-name \" + instanceNamePriorityClass + \"'>\" + doc.name + cc_view + agent_view + \"</div>\";\n        },\n        visible: false,\n        orderable: false\n      }, {\n        data: \"applicant_name\",\n        title: t(\"instances_applicant_name\"),\n        visible: false,\n        orderable: false\n      }, {\n        data: \"submit_date\",\n        title: t(\"instances_submit_date\"),\n        render: function(val, type, doc) {\n          if (doc.submit_date) {\n            return moment(doc.submit_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"flow_name\",\n        title: t(\"instances_flow\"),\n        visible: false,\n        orderable: false\n      }, {\n        data: \"current_step_name\",\n        title: t(\"instances_step_current_name\"),\n        render: function(val, type, doc) {\n          var cc_tag, judge, step_current_name;\n          if (doc.state === \"completed\") {\n            judge = doc.final_decision || \"approved\";\n          }\n          step_current_name = doc.current_step_name || '';\n          cc_tag = '';\n          if (doc.cc_count > 0) {\n            cc_tag = TAPi18n.__('cc_tag');\n          }\n          return \"<div class=\\\"step-current-state \" + judge + \"\\\">\" + step_current_name + cc_tag + \"</div>\";\n        },\n        visible: false,\n        orderable: false\n      }, {\n        data: \"modified\",\n        title: t(\"instances_modified\"),\n        render: function(val, type, doc) {\n          return moment(doc.modified).format('YYYY-MM-DD HH:mm');\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"start_date\",\n        title: t(\"instances_start_date\"),\n        render: function(val, type, doc) {\n          if (doc.start_date) {\n            return moment(doc.start_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"my_finish_date\",\n        render: function(val, type, doc) {\n          if (doc.my_finish_date) {\n            return moment(doc.my_finish_date).format('YYYY-MM-DD HH:mm');\n          }\n        },\n        visible: false,\n        orderable: true\n      }, {\n        data: \"modified\",\n        visible: false\n      }, {\n        data: \"keywords\",\n        visible: false\n      }, {\n        data: \"is_archived\",\n        render: function(val, type, doc) {\n          var ref;\n          if ((doc != null ? (ref = doc.values) != null ? ref.record_need : void 0 : void 0) && doc.values.record_need === \"true\") {\n            if (doc != null ? doc.is_archived : void 0) {\n              return t(\"YES\");\n            }\n            return t(\"NO\");\n          }\n        },\n        visible: false,\n        orderable: false\n      }\n    ],\n    dom: (function() {\n      if (Steedos.isMobile()) {\n        return 'tp';\n      } else {\n        return 'tpl';\n      }\n    })(),\n    order: [[4, \"desc\"]],\n    extraFields: [\"form\", \"flow\", \"inbox_users\", \"state\", \"space\", \"applicant\", \"form_version\", \"flow_version\", \"is_cc\", \"cc_count\", \"is_read\", \"current_step_name\", \"values\", \"keywords\", \"final_decision\", \"flow_name\", \"is_hidden\", \"agent_user_name\"],\n    lengthChange: true,\n    lengthMenu: [10, 15, 20, 25, 50, 100],\n    pageLength: 10,\n    info: false,\n    searching: true,\n    responsive: {\n      details: false\n    },\n    autoWidth: false,\n    changeSelector: function(selector, userId) {\n      var ref, space, space_user;\n      if (!userId) {\n        return {\n          _id: -1\n        };\n      }\n      space = selector.space;\n      if (!space) {\n        if ((selector != null ? (ref = selector.$and) != null ? ref.length : void 0 : void 0) > 0) {\n          space = selector.$and.getProperty('space')[0];\n        }\n      }\n      if (!space) {\n        return {\n          _id: -1\n        };\n      }\n      space_user = db.space_users.findOne({\n        user: userId,\n        space: space\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (!space_user) {\n        return {\n          _id: -1\n        };\n      }\n      return selector;\n    },\n    pagingType: \"numbers\"\n  };\n  if (flowId) {\n    key = \"instanceFlow\" + flowId;\n    options.name = key;\n    TabularTables.instances.fields = fields;\n    ins_fields = _handleListFields(TabularTables.instances.fields);\n    ins_fields.forEach(function(f) {\n      if (f.type !== 'table' && f.is_list_display) {\n        return options.columns.push({\n          data: f.name || f.code,\n          title: t(f.name || f.code),\n          visible: false,\n          orderable: false,\n          render: function(val, type, doc) {\n            var value, values;\n            values = doc.values || {};\n            value = values[f.code];\n            switch (f.type) {\n              case 'user':\n                value = value != null ? value.name : void 0;\n                break;\n              case 'group':\n                value = value != null ? value.fullname : void 0;\n                break;\n              case 'date':\n                if (value) {\n                  value = moment(value).format('YYYY-MM-DD');\n                }\n                break;\n              case 'dateTime':\n                if (value) {\n                  value = moment(value).format('YYYY-MM-DD HH:mm');\n                }\n                break;\n              case 'checkbox':\n                if (value === true || value === 'true') {\n                  value = TAPi18n.__(\"form_field_checkbox_yes\");\n                } else {\n                  value = TAPi18n.__(\"form_field_checkbox_no\");\n                }\n                break;\n              case 'odata':\n                if (value) {\n                  if (_.isArray(value)) {\n                    value = _.pluck(value, '@label').toString();\n                  } else {\n                    value = value['@label'];\n                  }\n                }\n            }\n            return value;\n          }\n        });\n      }\n    });\n  }\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.instances = new Tabular.Table(instancesListTableTabular());\n});\n\nGetBoxInstancesTabularOptions = function(box, flowId, fields) {\n  var key, options;\n  key = \"instanceFlow\" + box + flowId;\n  if (box === \"inbox\") {\n    options = _get_inbox_instances_tabular_options(flowId, fields);\n  } else if (box === \"outbox\") {\n    options = _get_outbox_instances_tabular_options(flowId, fields);\n  } else {\n    options = instancesListTableTabular(flowId, fields);\n    if (!flowId) {\n      options.name = \"inbox_instances\";\n    }\n  }\n  if (flowId) {\n    options.name = key;\n  }\n  return options;\n};\n\n_get_inbox_instances_tabular_options = function(flowId, fields) {\n  var options;\n  options = instancesListTableTabular(flowId, fields);\n  if (!flowId) {\n    options.name = \"inbox_instances\";\n  }\n  options.order = [[8, \"desc\"]];\n  options.filteredRecordIds = function(table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions) {\n    var ag_sort, aggregate, aggregate_operation, async_aggregate, filteredRecordIds, s1, s1_0, s1_1;\n    aggregate_operation = [\n      {\n        $match: selector\n      }, {\n        $project: {\n          name: 1,\n          \"_approve\": '$traces.approves'\n        }\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $match: {\n          '_approve.is_finished': false,\n          '_approve.handler': userId\n        }\n      }\n    ];\n    if (sort && sort.length > 0) {\n      s1 = sort[0];\n      s1_0 = s1[0];\n      s1_1 = s1[1];\n      if (s1_0 === 'start_date') {\n        findOptions.sort = [['modified', s1_1]];\n        aggregate_operation.push({\n          $group: {\n            _id: \"$_id\",\n            \"approve_start_date\": {\n              $first: \"$_approve.start_date\"\n            }\n          }\n        });\n        ag_sort = {\n          'approve_start_date': s1_1 === 'asc' ? 1 : -1\n        };\n        aggregate_operation.push({\n          $sort: ag_sort\n        });\n        aggregate_operation.push({\n          $skip: skip\n        });\n        aggregate_operation.push({\n          $limit: limit\n        });\n        filteredRecordIds = new Array();\n        aggregate = function(table, aggregate_operation, filteredRecordIds, cb) {\n          table.collection.rawCollection().aggregate(aggregate_operation).toArray(function(err, data) {\n            if (err) {\n              throw new Error(err);\n            }\n            data.forEach(function(doc) {\n              filteredRecordIds.push(doc._id);\n            });\n            if (cb) {\n              cb();\n            }\n          });\n        };\n        async_aggregate = Meteor.wrapAsync(aggregate);\n        async_aggregate(table, aggregate_operation, filteredRecordIds);\n        return filteredRecordIds.uniq();\n      } else {\n        return old_filteredRecordIds;\n      }\n    }\n  };\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.inbox_instances = new Tabular.Table(GetBoxInstancesTabularOptions(\"inbox\"));\n});\n\n_get_outbox_instances_tabular_options = function(flowId, fields) {\n  var options;\n  options = instancesListTableTabular(flowId, fields);\n  if (!flowId) {\n    options.name = \"outbox_instances\";\n  }\n  options.order = [[9, \"desc\"]];\n  options.filteredRecordIds = function(table, selector, sort, skip, limit, old_filteredRecordIds, userId, findOptions) {\n    var ag_sort, aggregate, aggregate_operation, async_aggregate, filteredRecordIds, s1, s1_0, s1_1;\n    aggregate_operation = [\n      {\n        $match: selector\n      }, {\n        $project: {\n          name: 1,\n          \"_approve\": '$traces.approves'\n        }\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $unwind: \"$_approve\"\n      }, {\n        $match: {\n          '_approve.is_finished': true,\n          $or: [\n            {\n              '_approve.handler': userId\n            }, {\n              '_approve.user': userId\n            }\n          ]\n        }\n      }\n    ];\n    if (sort && sort.length > 0) {\n      s1 = sort[0];\n      s1_0 = s1[0];\n      s1_1 = s1[1];\n      if (s1_0 === 'my_finish_date') {\n        findOptions.sort = [['modified', s1_1]];\n        aggregate_operation.push({\n          $group: {\n            _id: \"$_id\",\n            \"approve_finish_date\": {\n              $last: \"$_approve.finish_date\"\n            }\n          }\n        });\n        ag_sort = {\n          'approve_finish_date': s1_1 === 'asc' ? 1 : -1\n        };\n        aggregate_operation.push({\n          $sort: ag_sort\n        });\n        aggregate_operation.push({\n          $skip: skip\n        });\n        aggregate_operation.push({\n          $limit: limit\n        });\n        filteredRecordIds = new Array();\n        aggregate = function(table, aggregate_operation, filteredRecordIds, cb) {\n          table.collection.rawCollection().aggregate(aggregate_operation).toArray(function(err, data) {\n            if (err) {\n              throw new Error(err);\n            }\n            data.forEach(function(doc) {\n              filteredRecordIds.push(doc._id);\n            });\n            if (cb) {\n              cb();\n            }\n          });\n        };\n        async_aggregate = Meteor.wrapAsync(aggregate);\n        async_aggregate(table, aggregate_operation, filteredRecordIds);\n        return filteredRecordIds.uniq();\n      } else {\n        return old_filteredRecordIds;\n      }\n    }\n  };\n  return options;\n};\n\nMeteor.startup(function() {\n  return TabularTables.outbox_instances = new Tabular.Table(GetBoxInstancesTabularOptions(\"outbox\"));\n});\n\nif (Meteor.isClient) {\n  TabularTables.flowInstances = new ReactiveVar();\n}\n\nMeteor.startup(function() {\n  return Tracker.autorun(function(c) {\n    if (Meteor.isClient && !Steedos.isMobile()) {\n      if (Session.get(\"flowId\") && Session.get(\"box\") !== 'draft') {\n        return Meteor.call(\"newInstancesListTabular\", Session.get(\"box\"), Session.get(\"flowId\"), function(error, result) {\n          newInstancesListTabular(Session.get(\"box\"), Session.get(\"flowId\"), result);\n          return Template.instance_list._changeOrder();\n        });\n      }\n    }\n  });\n});\n\nnewInstancesListTabular = function(box, flowId, fields) {\n  var flow, key, ref, ref1, ref2;\n  if (!fields) {\n    flow = db.flows.findOne({\n      _id: flowId\n    }, {\n      fields: {\n        form: 1\n      }\n    });\n    fields = (ref = db.forms.findOne({\n      _id: flow != null ? flow.form : void 0\n    }, {\n      fields: {\n        'current.fields': 1\n      }\n    })) != null ? (ref1 = ref.current) != null ? ref1.fields : void 0 : void 0;\n  }\n  fields = _handleListFields(fields);\n  if ((fields != null ? (ref2 = fields.filterProperty(\"is_list_display\", true)) != null ? ref2.length : void 0 : void 0) > 0) {\n    key = \"instanceFlow\" + box + flowId;\n    if (Meteor.isClient) {\n      TabularTables.flowInstances.set(new Tabular.Table(GetBoxInstancesTabularOptions(box, flowId, fields)));\n    } else {\n      new Tabular.Table(GetBoxInstancesTabularOptions(box, flowId, fields));\n    }\n    return console.log(\"new TabularTables \", key);\n  }\n};\n\nif (Meteor.isServer) {\n  Meteor.methods({\n    newInstancesListTabular: function(box, flowId) {\n      var fields, flow, ref, ref1;\n      newInstancesListTabular(box, flowId);\n      flow = db.flows.findOne({\n        _id: flowId\n      }, {\n        fields: {\n          form: 1\n        }\n      });\n      fields = (ref = db.forms.findOne({\n        _id: flow != null ? flow.form : void 0\n      }, {\n        fields: {\n          'current.fields': 1\n        }\n      })) != null ? (ref1 = ref.current) != null ? ref1.fields : void 0 : void 0;\n      return fields;\n    }\n  });\n}\n"]}